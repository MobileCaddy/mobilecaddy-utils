/*! mobilecaddy-utils - v1.8.2 - Bundle Time: 2018-06-29 10:20:40 */
/* git info: "2018-06-29 10:19:29 +0100": 0728c0ce1250a4a4cb91b1573b97c9778a869753 (develop) */
/* Copyright 2018 MobileCaddy Ltd */

String.prototype.includes||(String.prototype.includes=function(e,n){"use strict";return"number"!=typeof n&&(n=0),!(n+e.length>this.length)&&-1!==this.indexOf(e,n)}),Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(e){if(null==this)throw new TypeError('"this" is null or not defined');var n=Object(this),o=n.length>>>0;if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var t=arguments[1],r=0;r<o;){var s=n[r];if(e.call(t,s,r,n))return s;r++}},configurable:!0,writable:!0});var $j=jQuery.noConflict(),MC_TABLES=["Connection_Session__mc","Mobile_Log__mc","MC_Project__ap","MC_Time_Expense__ap","MC_Project_Location__ap"],_typeof=function(e){return typeof e};!function(){var r,s,a,i,c;a={},i=[],c={},r=function(e){if(a[e]){if(e in c){var n=i.slice(c[e]).join("->")+"->"+e;console.error("Cycle in require graph: "+n)}}else console.error("module "+e+" not found");if(a[e].factory)try{return c[e]=i.length,i.push(e),o=a[e],t=o.factory,o.exports={},delete o.factory,t(r,o.exports,o),o.exports}finally{delete c[e],i.pop()}var o,t;return a[e].exports},(s=function(e,n){a[e]&&console.error("module "+e+" already defined"),a[e]={id:e,factory:n}}).remove=function(e){delete a[e]},"object"==typeof module&&"function"==typeof r&&(module.exports.require=r,module.exports.define=s),s("mobileCaddy",function(e,n,o){var t={define:s,require:e,START_PAGE_CONTROLLER:"",QUERY_BUFFER_SIZE:1e3,QUERY_BUFFER_SIZE_SL:1e3,INITIAL_APPCACHE_INFO:[]};o.exports=t}),s("mobileCaddy/mobileLogger",function(e,n,o){function t(){try{throw Error("")}catch(e){return e}}function r(e,n){var o=n.stack.split("\n")[4],t="";if(void 0!==o){var r=o.indexOf("at ");t=o.slice(r+2,o.length)}console.log(e,t)}o.exports={logMessageAndThrow:function(e){!function(e,n){throw r(e,n),e}(e,t())},logMessage:function(e){r(e,t())},logObjectDetails:function(e){!function(e,n){for(var o in e)r("field:"+o+": has value :"+e[o]+":",n)}(e,t())}}}),s("mobileCaddy/geoLocation",function(e,n,o){o.exports={getLocation:function(e,n){var o,t;o=e,(t=[]).Error="Location information is unavailable.",t.ErrorNumber=2,o(t)}}}),s("mobileCaddy/startup",function(e,n,o){e("mobileCaddy/mobileLogger");var t=e("mobileCaddy/logger"),u=cordova.require("com.salesforce.plugin.smartstore"),l=e("mobileCaddy/systemData"),d=e("mobileCaddy/smartStoreUtils"),r=(e("mobileCaddy/appDataUtils"),e("mobileCaddy/geoLocation"),!!window.LOCAL_DEV),f=!!window.USE_FORCETK,s=[];console.log("LOCAL_DEV",r),console.log("USE_FORCETK",f);var p=["Initialising"];console.log("Startup error listener"),window.addEventListener("error",function(e){var n=e.error?e.error.stack:null,o=e.error?e.error.toString():e;n&&(o+="\n"+n),console.log("Error event listener fired",JSON.stringify(o))});var a=100900,i=100901;function c(n){console.log("checkCache entry"),p.unshift("Checking Cache"),s=[];var e=localStorage.getItem("tmpCacheItems");if(console.log("cacheLS",e),e){var o=JSON.parse(e);if(0<o.length&&("preBootstrap-noupdate"==o[o.length-1].Description||"preBootstrap-checking"==o[o.length-1].Description))return console.log("not 1st run up"),s=[],void n({status:a});if(console.log("Hi"),0<(s=o).length&&"preBootstrap-cached"==o[o.length-1].Description)return console.log("Returning success"),void n({status:a})}else s.push({Name:"AppCache: Initial Status",Description:window.applicationCache.status});window.applicationCache.addEventListener("checking",function(e){m(e)},!1),window.applicationCache.addEventListener("downloading",function(e){m(e)},!1),window.applicationCache.addEventListener("progress",function(e){m(e)},!1);var t={};switch(t.status=a,window.applicationCache.status){case window.applicationCache.CHECKING:case window.applicationCache.DOWNLOADING:return window.applicationCache.addEventListener("updateready",function(e){m(e,n)},!1),window.applicationCache.addEventListener("cached",function(e){m(e,n)},!1),window.applicationCache.addEventListener("error",function(e){m(e,n)},!1),window.applicationCache.addEventListener("noupdate",function(e){m(e,n)},!1),void console.log("checkCache - Cache Busy");case window.applicationCache.UPDATEREADY:n(t),console.log("cache in updateready");break;default:console.log("cache in default",window.applicationCache),n(t)}}function m(e,n){"progress"==e.type?(console.log("cache in progress"),s.push({Name:"Event ",Description:e.loaded+" of "+e.total})):s.push({Name:"Event ",Description:e.type});var o={};"udpateready"==e.type||"cached"==e.type?(console.log("cache in update ready or cached"),o.status=a):(console.log("cache in else",e.type),o.status=i),console.log("return object "),console.log(o),n&&"function"==typeof n&&n(o)}function S(s,a){console.log("prep platform cache status",a),p.unshift("Preparing platform");var e=b("appSoupJson");if(""!==e){console.log("app soup json = "+JSON.stringify(e));var n=JSON.parse(e);u.registerSoup("appSoup",[{path:"Name",type:"string"},{path:"CurrentValue",type:"string"},{path:"NewValue",type:"string"}],function(){u.upsertSoupEntries("appSoup",n,function(e){u.registerSoup("cacheSoup",[{path:"Name",type:"string"},{path:"Description",type:"string"}],function(){y(s,a)},function(e){console.log("Failed to create cache soup with error = "+e)})},function(e){console.log("Failed to update app soup with error = "+e)})},function(e){console.log("Failed to register app soup with error = "+e)})}else console.log("app soup json2 = "+e),void 0!==r&&r?new Promise(function(n,o){console.log("setupCodeFlow"),new Promise(function(e,n){if(console.log("maybeInitForceJS"),f){var o=window.SF_LOGIN_URL?window.SF_LOGIN_URL:"https://login.salesforce.com";console.log("window.SF_LOGIN_URL",window.SF_LOGIN_URL),force.init({appId:"3MVG9Rd3qC6oMalWEuQby1hkUef0N2L7kTPExDjRAs1GH35ueKyc3q_D5NY0LLoLHnfwIr_Y8PyeRotaClrtZ",apiVersion:"v30.0",loginUrl:o,tokenStore:localStorage,oauthRedirectURL:"http://localhost:3030/oauthcallback.html",proxyURL:"http://localhost:3000"}),force.isLoggedIn()?(console.info("forcejs - Already logged in"),e()):force.login(function(){console.log("Salesforce login succeeded"),e()},function(e){console.error(e),alert("Salesforce login failed"),n(e)})}else e()}).then(function(e){return new Promise(function(n,o){var e=!localStorage.getItem("initialSyncState");if(f&&e){var t=window.DEVICE_APP_NAME?window.DEVICE_APP_NAME:"BIZ001";force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/codeflowUtils001",contentType:"application/json",data:{buildVersion:"001",buildName:t,buildOS:"Android",deviceUuid:"c86d3e94574debug",overrideUserId:"",startPageControllerVersion:"001"}},function(e){console.info("response -> "+JSON.stringify(e)),n()},function(e){console.error(e),alert("Salesforce codeflowUtils001 failed"),o(e)})}else n()})}).then(function(e){p.unshift("Creating CodeFlow records"),u.soupExists("appSoup",function(e){e?u.soupExists("cacheSoup",function(e){e?n():u.registerSoup("cacheSoup",[{path:"Name",type:"string"},{path:"Description",type:"string"}],function(){n()},function(e){o(e)})},function(e){o(e)}):u.registerSoup("appSoup",[{path:"Name",type:"string"},{path:"teststring",type:"string"},{path:"testinteger",type:"string"},{path:"CurrentValue",type:"string"},{path:"NewValue",type:"string"},{path:"testno",type:"integer"}],function(){localStorage.setItem("appSoup",JSON.stringify([{Name:"applicationName",CurrentValue:"MAP-0012001",NewValue:"MAP-0012001",_soupEntryId:1},{Name:"userId",CurrentValue:"",NewValue:"",_soupEntryId:2},{Name:"buildStatus",CurrentValue:"Initial",NewValue:"Initial",_soupEntryId:3},{Name:"buildVersion",CurrentValue:"001",NewValue:"001",_soupEntryId:4},{Name:"buildName",CurrentValue:"BIZ001",NewValue:"BIZ001",_soupEntryId:5},{Name:"buildOS",CurrentValue:"Android",NewValue:"Android",_soupEntryId:6},{Name:"deviceUuid",CurrentValue:"c86d3e94574debug",NewValue:"c86d3e94574debug",_soupEntryId:7}])),u.registerSoup("cacheSoup",[{path:"Name",type:"string"},{path:"Description",type:"string"}],function(){n()},function(e){o(e)})},function(e){o(e)})})}).catch(function(e){t.error(e),o(e)})}).then(function(e){y(s,a)}).catch(function(e){throw console.error(e),t.error(e),e}):navigator.appVersion.includes("Electron")?u.soupExists("appSoup",function(e){if(e)y(s,a);else{var n=[],o=ipcRenderer.sendSync("request-creds","");console.log("creds",o);b("access_token","?"+o);if(n.push({Name:"accessToken",CurrentValue:b("access_token","?"+o),NewValue:null}),n.push({Name:"refreshToken",CurrentValue:b("refresh_token","?"+o),NewValue:null}),n.push({Name:"clientId",CurrentValue:b("client_id","?"+o),NewValue:null}),n.push({Name:"orgId",CurrentValue:b("org_id","?"+o),NewValue:null}),n.push({Name:"applicationName",CurrentValue:b("buildName","?"+o),NewValue:null}),n.push({Name:"buildName",CurrentValue:b("buildName","?"+o),NewValue:null}),window.location.pathname.startsWith("/apex/"))n.push({Name:"loginUrl",CurrentValue:window.location.protocol+"//"+window.location.host,NewValue:null});else{var t=window.location.pathname.split("/")[1];n.push({Name:"loginUrl",CurrentValue:window.location.protocol+"//"+window.location.host+"/"+t,NewValue:null})}var r=ipcRenderer.sendSync("request-device-info","");console.log("Device from Electron",JSON.stringify(r)),n.push({Name:"buildStatus",CurrentValue:"Initial"}),n.push({Name:"buildVersion",CurrentValue:r.buildVersion}),n.push({Name:"buildOS",CurrentValue:r.platform}),n.push({Name:"deviceUuid",CurrentValue:r.uuid});u.registerSoup("appSoup",[{path:"Name",type:"string"},{path:"CurrentValue",type:"string"},{path:"NewValue",type:"string"}],function(){u.upsertSoupEntries("appSoup",n,function(e){u.registerSoup("cacheSoup",[{path:"Name",type:"string"},{path:"Description",type:"string"}],function(){y(s,a)},function(e){console.log("Failed to create cache soup with error = "+e)})},function(e){console.log("Failed to update app soup with error = "+e)})},function(e){console.log("Failed to register app soup with error = "+e)})}}):y(s,a)}var h=100800,g=100801;function y(i,c){console.debug("cache status = "+JSON.stringify(c),s),u.upsertSoupEntries("cacheSoup",s,function(){d.querySoupRecsPromise("appSoup").then(function(e){var s={},a=[];if(e.forEach(function(e){if(void 0!==s[e.Name])throw"Should only be 1 "+e.Name+" entry in the app soup.  Found more";s[e.Name]=e}),s.userOverrideId||(s.userOverrideId=""),"Complete"==s.buildStatus.CurrentValue&&"Complete"==s.buildStatus.NewValue){if(null!==i){console.log("build already complete - calling 3rd party callback function");var n={};if(n.status=g,n.mc_add_status=c.status,n.curVsn=s.dynVersionNumber.CurrentValue,void 0!==s.dynVersionNumber.NewValue&&(n.newVsn=s.dynVersionNumber.NewValue),navigator.appVersion.includes("Electron")){var o=window.location.protocol+"//"+window.location.host+window.location.pathname;ipcRenderer.send("startPageUrl",o)}i(n)}}else{p.unshift("Preparing database");var t=function(e,n){if(n.status){console.log("Parse json aud"+e),a=JSON.parse(e);var o=_.find(a,{Name:"audId"}).CurrentValue,t=_.find(a,{Name:"sysDataPlatSupVersion"}).CurrentValue;if(navigator.appVersion.includes("Electron")){var r=window.location.protocol+"//"+window.location.host+window.location.pathname;ipcRenderer.send("startPageUrl",r)}new Promise(function(e,n){u.registerSoup("recsToSync",[{path:"Mobile_Table_Name",type:"string"},{path:"SOUP_Record_Id",type:"string"},{path:"Id",type:"string"},{path:"LastModifiedDateTime",type:"integer"},{path:"CRUD_Operation",type:"string"},{path:"Current_Connection_Session",type:"string"}],function(){e()},function(e){n(e)})}).then(function(){l.createSystemDataSoup(function(){p.unshift("Building tables"),d.buildMobileTables(function(){var e=s.buildStatus;e.CurrentValue="Complete",e.NewValue="Complete",a.map(function(e){return s[e.Name]&&(e._soupEntryId=s[e.Name]._soupEntryId),e}),a.push(e),p.unshift("Finalising build"),u.upsertSoupEntries("appSoup",a,function(){l.getRecordTypeDots(o,t).then(function(){if(null!==i){var e={};e.status=h,e.mc_add_status=c.status,console.log("Calling 3rd party callback"),console.log(e),i(e)}}).catch(function(e){console.log("From getRecordTypeDots "+e)})},function(e){console.log("From upsert soup records "+e)})},function(e){console.log("Error building mobile tables "+e)})},function(e){console.log("create system data soup returned error"+e)},o,t),console.log("Exiting startup")}).catch(function(e){console.log("Error building recs to sync soup "+e)})}else"exception"===n.type&&alert(n.message)};syncRefresh.heartBeat(function(e){console.log("getAudInfo heartbeat response",e),!0===f?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/getAUDInfo001",contentType:"application/json",data:{buildVersion:s.buildVersion.CurrentValue,buildName:s.buildName.CurrentValue,buildOS:s.buildOS.CurrentValue,deviceUuid:s.deviceUuid.CurrentValue,overrideUserId:force.getUserId(),startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN}},function(e){console.info("response -> "+JSON.stringify(e));var n={status:"200"};t(e,n)},function(e){console.error("err -> "+JSON.stringify(e)),error()}):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".getAudInfo",s.buildVersion.CurrentValue,s.buildName.CurrentValue,s.buildOS.CurrentValue,s.deviceUuid.CurrentValue,s.userOverrideId,t,{escape:!1,timeout:3e4})},function(e){console.error("getAudInfo heartbeat error",e),alert("Failed to refresh authentication. Please uninstall/re-install the application")})}}).catch(function(e){console.error(e)})},function(e){console.log("Failed to update app soup with initial app cache info = "+e)})}function b(e,n){n||(n=window.location.search),console.info("getUrlParamByName -> name = "+e),e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var o=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(n);return console.log("getUrlParamByName results -> "+o),null===o?"":decodeURIComponent(o[1].replace(/\+/g," "))}o.exports={startup:function(e){!function(n){if(!n)return console.log("returning Promise"),new Promise(function(n,e){c(function(e){S(function(e){n(e)},e)})});c(function(e){S(n,e)}),console.log("mobileCaddy.QUERY_BUFFER_SIZE",mobileCaddy.QUERY_BUFFER_SIZE)}(e)}}}),s("mobileCaddy/systemData",function(e,n,o){e("mobileCaddy/mobileLogger");var i=e("mobileCaddy"),c=e("mobileCaddy/logger"),u=cordova.require("com.salesforce.plugin.smartstore"),a=(i.require("mobileCaddy/smartStoreUtils"),e("mobileCaddy/appDataUtils"));function r(e,n,o,t){console.log("In createSystemDataSoup"),function(t,r,s,a){console.log("In getSystemDataSoupDefinition with audId = "+t+" and sysDataPlatSupVersion = "+r);var o=function(e,n){if(n.status){console.log("In getSystemDataSoupDefinition callback -> "+e),console.log("Parse json app defns"+e);var o=JSON.parse(e);console.log("Parse json app defns done"),o.forEach(function(e){console.log(e)}),u.registerSoup("syncLib_system_data",o,function(){!function(e,n,t,r){console.log("In populate system data row values");var o=function(e,n){if(n.status){console.log("In remoting callback for getSysDataSoupVariables with record count = "+e.length);var o=JSON.parse(e);console.log("Parse json soup field defns done"),u.upsertSoupEntries("syncLib_system_data",o,t,r)}else"exception"===n.type?(alert(n.message),c.error("Exception return from getSystemDataRowValues = "+n.message)):c.error("Unknown return from getSystemDataRowValues = "+n.message)};!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/getSysDataSoupVariables001",contentType:"application/json",data:{audId:e,startPageControllerVersion:i.START_PAGE_CONTROLLER_VSN,systemDataPlatformSupportVersion:n}},function(e){var n={status:"200"};o(e,n)},r):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+i.START_PAGE_CONTROLLER+".getSysDataSoupVariables",e,n,o,{escape:!1})}(t,r,function(){!function(e,n,t,r){console.log(i.START_PAGE_CONTROLLER+".getDefsForSObjectMobileTables");var o=function(e,n){if(n.status){var o=JSON.parse(e);console.log("Parse json table defns done"),u.upsertSoupEntries("syncLib_system_data",o,function(e){console.log("successful upsert with rec count = "+e.length),t(e)},function(e){c.error("Error returned from upsert, message =  "+e),r(e)})}else"exception"===n.type?(alert(n.message),c.error("Exception return from getDefsForSObjectMobileTables = "+n.message)):c.error("Unknown return from getDefsForSObjectMobileTables = "+n.message)};!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/getDefsForSObjectMobileTables001",contentType:"application/json",data:{audId:e,startPageControllerVersion:i.START_PAGE_CONTROLLER_VSN,systemDataPlatformSupportVersion:n}},function(e){var n={status:"200"};o(e,n)},r):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+i.START_PAGE_CONTROLLER+".getDefsForSObjectMobileTables",e,n,o,{escape:!1,timeout:12e4})}(t,r,s,a)},a)},a)}else"exception"===n.type?(alert(n.message),c.error("Exception return from getSystemDataSoupDefinition = "+n.message)):c.error("Unknown return from getSystemDataSoupDefinition = "+n.message)};!0===USE_FORCETK?(console.debug("USE_FORCETK == true"),force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/getSystemDataSoupDefinition001",contentType:"application/json",data:{audId:t,startPageControllerVersion:i.START_PAGE_CONTROLLER_VSN,systemDataPlatformSupportVersion:r}},function(e){var n={status:"200"};o(e,n)},a)):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+i.START_PAGE_CONTROLLER+".getSystemDataSoupDefinition",t,r,o,{escape:!1})}(o,t,e,n)}o.exports={createSystemDataSoup:function(e,n,o,t){r(e,n,o,t)},getRecordTypeDots:function(s){return new Promise(function(r,o){var n,t=function(t,e){console.log("getRecordTypeDots",n,t),e.status?u.registerSoup("dotsRecordTypes",[{path:"Table",type:"string"},{path:"Data",type:"string"}],function(e){var n=JSON.parse(t).map(function(e){return{Table:e.mobileTableName,Data:JSON.stringify(e.recTypeInfoList)}});console.log("upsertRecs",n),u.upsertSoupEntries("dotsRecordTypes",n,function(e){console.log("successful upsert with rec count = "+e.length);var o={};JSON.parse(t).forEach(function(e){var n={};e.recTypeInfoList.forEach(function(e){e.recTypeDevName?(n[e.recTypeId]={recTypeName:e.recTypeName,recTypeDevName:e.recTypeDevName},n[e.recTypeName]=e.recTypeId,n[e.recTypeDevName]=e.recTypeId):(n[e.recTypeId]=e.recTypeName,n[e.recTypeName]=e.recTypeId)}),o[e.mobileTableName]=n}),localStorage.setItem("lsDotsRecordTypes",JSON.stringify(o)),r()},function(e){c.error("Error returned from upsert, message =  "+e),o(e)})},function(e){o(e)}):("exception"===e.type?c.error("Exception return from p2mRefreshRecTypeDOTs = "+e.message):c.error("Unknown return from p2mRefreshRecTypeDOTs = "+e.message),o(e.message))};a.getCachedCurrentValueFromAppSoup("syncRefreshVersion").then(function(e){n=e,!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/p2mRefreshRecTypeDOTs001",contentType:"application/json",data:{audId:s,startPageControllerVersion:i.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:n,connSessJson:"{}"}},function(e){var n={status:"200"};t(e,n)},function(e){t("[]",{status:"OK"})}):Visualforce.remoting.Manager.getAction("mobilecaddy1."+i.START_PAGE_CONTROLLER+".p2mRefreshRecTypeDOTs")?Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+i.START_PAGE_CONTROLLER+".p2mRefreshRecTypeDOTs",s,n,"{}",t,{escape:!1,timeout:12e4}):t("[]",{status:"OK"})})})}}}),s("mobileCaddy/smartStoreUtils",function(e,n,o){e("mobileCaddy/mobileLogger");var p=cordova.require("com.salesforce.plugin.smartstore");function r(e,n,o){var t=[];function r(e){n(t)}function s(e){if(console.error("onCursorClosedError",e),console.error("onCursorClosedError",e.stack),!o)throw e;o(e)}!function e(n){n.currentPageOrderedEntries.forEach(function(e){t.push(e)}),n.currentPageIndex<n.totalPages-1?cordova.require("com.salesforce.plugin.smartstore").moveCursorToNextPage(n,e):cordova.require("com.salesforce.plugin.smartstore").closeCursor(n,r,s)}(e)}function t(e,n,o){var t=p.buildAllQuerySpec("_soupEntryId",null,mobileCaddy.QUERY_BUFFER_SIZE);p.querySoup(e,t,function(e){r(e,function(e){n(e)},o)})}function f(n,e,o,t){p.querySoup(n,e,function(e){r(e,function(e){console.log("Passing records back to callback for soup = "+n+" and rec count = "+e.length),o(e)},t)},t)}function c(e,n,o){console.debug("smartQuerySoupRecordsWithQuerySpec",e),p.runSmartQuery(e,function(e){r(e,function(e){console.log("Passing records back to callback for soup with rec count = "+e.length),n(e)},o)},o)}function m(t,r,s,n,e){if(void 0===n&&void 0===e)return new Promise(function(n,o){var e=p.buildExactQuerySpec(r,s,mobileCaddy.QUERY_BUFFER_SIZE_SL);f(t,e,function(e){n(e)},function(e){o(e)})});var o=p.buildExactQuerySpec(r,s,mobileCaddy.QUERY_BUFFER_SIZE_SL);f(t,o,function(e){n(e)},e)}function _(e,n,o,t,r,s,a){f(e,p.buildExactQuerySpec(n,o,mobileCaddy.QUERY_BUFFER_SIZE_SL),function(e){var n=[];e.forEach(function(e){e[t]==r&&n.push(e)}),s(n)},a)}function a(n,o,t){l("Row Mapping PT","Mobile Table Name",function(e){_("syncLib_system_data","MC_Var_String_001","Platform Table Definition",e,n,function(e){1!=e.length&&console.error("Should be exactly 1 table defn row for table: "+n+", but we got "+e.length),o(e[0])},t)},t)}function i(e,r){return new Promise(function(o,t){a(e,function(n){l("Row Mapping PT",r,function(e){o(n[e])},function(e){t(e)})},function(e){t(e)})})}function u(e,r,s){return new Promise(function(o,t){a(e,function(n){l("Row Mapping PT",r,function(e){n[e]=s,p.upsertSoupEntries("syncLib_system_data",[n],function(){o()},function(e){t(e)})},function(e){t(e)})},function(e){t(e)})})}function l(n,o,t,e){var r=n+"_"+o,s=localStorage.getItem(r);s?t(s):_("syncLib_system_data","MC_Var_String_001",n,"MC_Var_String_003",o,function(e){1!=e.length&&console.error("Must be exactly 1 Row Mapping Record for Sys Data Row Type = "+n+" and Sys Data Row Value = "+o+" found count = "+e.length),localStorage.setItem(r,e[0].MC_Var_String_004),t(e[0].MC_Var_String_004)},e)}function s(r,n,o,e){f("syncLib_system_data",p.buildExactQuerySpec("MC_Var_String_001",r,mobileCaddy.QUERY_BUFFER_SIZE_SL),function(e){var t=[];n.forEach(function(n){var o=!1;if(e.forEach(function(e){if(e.MC_Var_String_003==n)return t.push(e.MC_Var_String_004),void(o=!0)}),!o)throw"No mapping found for type = "+r+" and value = "+n}),o(t)},e)}var d=1,S=2;function h(){return new Promise(function(n,e){Promise.resolve();var t,r=["Connection_Session__mc","Mobile_Log__mc"],s=["SnapShot_Connection_Session__mc","SnapShot_Mobile_Log__mc"],a=["appSoup","cacheSoup","dotsRecordTypes","recsToSync","syncLib_system_data"];(t="Analytics",new Promise(function(n,o){p.soupExists("Analytics",function(e){n(e)},function(e){logger.error("soupExists",t,e),o(e)})})).then(function(e){e&&a.unshift("Analytics"),g(d,function(e){e.splice(e.indexOf("Connection_Session__mc"),1),e.splice(e.indexOf("Mobile_Log__mc"),1);var o=r.concat(e).concat(s);e.reduce(function(e,n){return e.then(function(){return i(n,"Snapshot Data Required")}).then(function(e){return console.log("snapShotExists ",n,e),"Yes"==e&&-1==r.indexOf(n)&&o.push("SnapShot_"+n),o}).catch(function(e){console.error(e)})},Promise.resolve()).then(function(e){n(e.concat(a))})},function(e){logger.error("Failed to listSoups",e)})})})}function g(t,r,n){s("Row Mapping PT",["Mobile Table Name","Build Order"],function(e){var o=e[0],s=e[1];m("syncLib_system_data","MC_Var_String_001","Platform Table Definition",function(e){var n=[];t==S?(e.sort(function(e,n){var o=0,t=parseInt(e[s]),r=parseInt(n[s]);return isNaN(t)||isNaN(r)||(o=t-r),o}),e.forEach(function(e){n.push(e[o])})):(e.forEach(function(e){n.push(e[o])}),t==d&&n.sort()),null!==r&&r(n)},n)},n)}var y=0,b=1,C=2;function R(u,l,d,e){s("Row Mapping TC",["Parent SOUP Name","Table Column Name","Mobile Column Type","Application Field CRUD","META isNillable","Platform Column Type","Device Value Type","Proxy Ref Field Name"],function(e){var n=e[0],o=e[1],t=e[2],r=e[3],s=e[4],a=e[5],i=e[6],c=e[7];_("syncLib_system_data","MC_Var_String_001","Platform Table Column",n,u,function(e){var n=[];e.forEach(function(e){l==y?n.push(e[o]):l==C?n.push({path:e[o],type:e[t],crud:e[r],nillable:e[s],platColType:e[a],appColType:e[i],proxyRefField:e[c]}):n.push({path:e[o],type:e[t]})}),d(n)},function(e){console.log("Error retrieving column names = "+e)})},e)}function E(e,n,o,t){if(console.log("In delete recs from soup with rec count = "+e.length),0!==e.length){var r=[];e.forEach(function(e){e&&e._soupEntryId&&r.push(e._soupEntryId)}),0!==r.length?p.removeFromSoup(n,r,function(e){console.log("Deleted rec(s) - calling callback"),o(e)},t):o()}else o()}function v(t){return new Promise(function(o,e){var n=localStorage.getItem("proxyField-"+t);n?o(n):(console.log("getProxyFieldName",t),R(t,y,function(e){var n=null;e.forEach(function(e){e.includes("MC_Proxy_ID")&&(n=e,localStorage.setItem("proxyField-"+t,e),console.log("GOT IT ",n))}),o(n)},function(e){console.error("listMobileTableColumns",JSON.stringify(e)),o(null)}))})}o.exports={ALPHA:d,BUILD:S,listSoups:function(){return h()},listMobileTables:g,FULL:C,listMobileTableColumns:R,queryMobileTable:m,buildMobileTables:function(r,s){console.debug("About to buildMobileTables"),console.time("buildMobileTables"),g(S,function(e){var n=e.length;e.forEach(function(t){R(t,b,function(o){console.debug("tableColumnObjectArray -> "+o),p.registerSoup(t,o,function(){console.log("success on register soup "+t),u(t,"SOUP Built Date/Time",(new Date).getTime()).then(function(){var n;return console.log("success on update of soup build date time"),n=t,o.forEach(function(e){e.path.includes("MC_Proxy_ID")&&localStorage.setItem("proxyField-"+n,e.path)}),i(t,"Snapshot Data Required")}).then(function(e){"Yes"==e?p.registerSoup("SnapShot_"+t,o,function(){console.log("Success from build of SnapShot_"+t),u(t,"Snapshot SOUP Built Date/Time",(new Date).getTime()),0==--n&&(console.timeEnd("buildMobileTables"),r())},function(e){console.error("Fail on create of SnapShot_"+t+" "+e),s(e)}):0==--n&&(console.timeEnd("buildMobileTables"),r())}).catch(function(e){s(e)})},s)},function(e){console.error("Fail on create of table"+t+" "+e),s(e)})})},s)},getProxyFieldName:v,getSysDataRowMapColHeading:l,getSysDataRowMapColHeadings:s,getTableDefnColumnValue:function(e,n){return i(e,n)},setTableDefnColumnValue:u,queryMobileTableWithAnd:_,smartQuerySoupRecordsWithQuerySpec:c,insertRecords:function(u,e,l,d){console.log("in insert records"),console.log("mobile table name = "+u),console.log("records = "+JSON.stringify(e)),console.log("records size = "+e.length),p.upsertSoupEntries(u,e,function(e){console.log("back from upsert soup with records = "+JSON.stringify(e));var t,n,r,s,a,i,c=(new Date).getTime();n=e,r=c,s=function(e){console.log("back with proxy ids = "+JSON.stringify(e));var o=[];e.forEach(function(e){var n={Mobile_Table_Name:u,CRUD_Operation:"Insert",SOUP_Record_Id:e._soupEntryId,Id:e.Id,LastModifiedDateTime:c};o.push(n)}),p.upsertSoupEntriesWithExternalId("recsToSync",o,"Id",l,d)},a=d,v(t=u).then(function(e){return i=e,o="audId",r=localStorage.getItem("appSoup-"+o),new Promise(function(n,e){var t;r?n(r):(t=o,new Promise(function(n,o){var e=p.buildExactQuerySpec("Name",t,mobileCaddy.QUERY_BUFFER_SIZE);f("appSoup",e,function(e){e[0]?n(e[0].CurrentValue):n(e[0])},function(e){o(e)})})).then(function(e){localStorage.setItem("appSoup-"+o,e),n(e)})});var o,r}).then(function(o){n.forEach(function(e){var n="PROXY%"+t+"%"+r+"%"+e._soupEntryId+"%"+o;e.Id=n,e[i]=n}),p.upsertSoupEntries(t,n,function(e){s(e)},a)}).catch(function(e){a(e)})},d)},updateRecordsWithExternalId:function(a,e,n,o,t){var c,u,l,d,f;(c=a,u=e,l=n,d=u.length,f=0,new Promise(function(a,i){v(c).then(function(s){u.forEach(function(t,r){m(c,l,t[l]).then(function(e){if(0<e.length){var n=e[0];for(var o in t)n[o]=t[o];u[r]=n,d<=++f&&a(u)}else"Id"==l&&18<t.Id.length?m(c,s,t.Id).then(function(e){if(0<e.length){var n=e[0];for(var o in t)"Id"!=o&&(n[o]=t[o]);u[r]=n,d<=++f&&a(u)}else i({status:101107})}):i({status:101107})}).catch(function(e){i(e)})})}).catch(function(e){i(e)})})).then(function(e){p.upsertSoupEntriesWithExternalId(a,e,n,function(e){m("recsToSync","Mobile_Table_Name",a,function(r){var s=[];e.forEach(function(n){var o,e;if(r.forEach(function(e){e.Id!=n.Id||(o=e)}),void 0!==o)if(console.log("existingRecToSync",o),o.Current_Connection_Session&&void 0!==o.Current_Connection_Session)switch(o.CRUD_Operation){case"Insert":case"InsertUpdate":e="InsertUpdate";break;default:e="UpdateUpdate"}else e=o.CRUD_Operation;else e="Update";var t={Mobile_Table_Name:a,SOUP_Record_Id:n._soupEntryId,Id:n.Id,CRUD_Operation:e,LastModifiedDateTime:n.SystemModstamp};"InsertUpdate"!=e&&"UpdateUpdate"!=e||(t.Current_Connection_Session=o.Current_Connection_Session),s.push(t)}),p.upsertSoupEntriesWithExternalId("recsToSync",s,"Id",o,t)},t)},t)}).catch(function(e){t(e)})},deleteSoup:function(o){return console.debug("deleteSoup",o),new Promise(function(e,n){p.removeSoup(o,function(){logger.log("deleteSoup",o),e()},function(e){logger.errorAndDispatch("deleteSoup",e),n(e)})})},querySoupRecords:t,querySoupRecsPromise:function(e){return new Promise(function(n,o){t(e,function(e){n(e.filter(function(e){return"object"==(void 0===e?"undefined":_typeof(e))}))},function(e){o(e)})})},querySoupRecordsWithQuerySpec:f,deleteRecordsForExternalId:function(s,n,a,o,t){if(!o&&!t)return new Promise(function(o,t){if(0===n.length)o();else{var r="";"object"==_typeof(n[0])?n.forEach(function(e,n){r+=0===n?"'"+e[a]+"'":",'"+e[a]+"'"}):n.forEach(function(e,n){r+=0===n?"'"+e+"'":", '"+e+"'"});var e="SELECT {"+s+":_soupEntryId} FROM {"+s+"} WHERE {"+s+":"+a+"} IN ("+r+")";console.log("deleteRecordsForExternalId soql",e),c(p.buildSmartQuerySpec(e,1e4),function(e){console.log("recs",e);var n=e.map(function(e){return e[0]});p.removeFromSoup(s,n,function(e){o(e)},function(e){t(e)})},function(e){t(e)})}});if(0===n.length)o();else{var r=[];n.forEach(function(e){r.push(e[a])});var i="";n.forEach(function(e,n){i+=0===n?"'"+e[a]+"'":",'"+e[a]+"'"});var e="SELECT {"+s+":_soupEntryId} FROM {"+s+"} WHERE {"+s+":"+a+"} IN ("+i+")";console.log("deleteRecordsForExternalId soql",e),c(p.buildSmartQuerySpec(e,1e4),function(e){console.log("recs",e);var n=e.map(function(e){return e[0]});p.removeFromSoup(s,n,function(e){o()},function(e){t(e)})},function(e){t(e)})}},deleteRecordsFromSoup:E}}),s("mobileCaddy/appDataUtils",function(e,n,o){e("mobileCaddy/mobileLogger");var a=cordova.require("com.salesforce.plugin.smartstore"),i=e("mobileCaddy/smartStoreUtils");function r(t){return new Promise(function(n,o){var e=a.buildExactQuerySpec("Name",t,mobileCaddy.QUERY_BUFFER_SIZE);i.querySoupRecordsWithQuerySpec("appSoup",e,function(e){e[0]?n(e[0].CurrentValue):n(e[0])},function(e){o(e)})})}function t(t,r,s){return new Promise(function(n,o){var e=a.buildExactQuerySpec("Name",t,mobileCaddy.QUERY_BUFFER_SIZE);i.querySoupRecordsWithQuerySpec("appSoup",e,function(e){0<e.length?(e[0][s]=r,a.upsertSoupEntries("appSoup",e,function(e){n(e)},function(e){o(e)})):n()},function(e){o(e)})})}o.exports={getCurrentValueFromAppSoup:function(e){return r(e)},getCachedCurrentValueFromAppSoup:function(e){return o=e,t=localStorage.getItem("appSoup-"+o),new Promise(function(n,e){t?n(t):r(o).then(function(e){localStorage.setItem("appSoup-"+o,e),n(e)})});var o,t},updateNewValueInAppSoup:function(e,n){return t(e,n,"NewValue")},updateCurrentValueInAppSoup:function(e,n){return t(e,n,"CurrentValue")}}}),s("mobileCaddy/syncRefresh",function(n,o,t){var h=n("mobileCaddy/appDataUtils"),U=n("mobileCaddy/smartStoreUtils"),A=(n("mobileCaddy/mobileLogger"),n("mobileCaddy/logger")),L=cordova.require("com.salesforce.plugin.smartstore"),r=n("mobileCaddy/geoLocation"),S=(window.LOCAL_DEV,!!window.USE_FORCETK),g=98,y=100400,b=100402,C="006";function a(u,l,a,i,c,d){console.time("syncMobileTable"),d&&d({status:0,table:u}),l=void 0===l||l;a||(a=0),i||(i=50),c||(c=!1);var f=function(e,n,o){var t={};T(e,a,!0,1,1,null,function(e){console.debug("refreshStatusObject",e),e.status==E?t.status=y:(t.status=e.status,t.mc_add_status=e.mc_add_status),n(t)},o)},p=function n(o,t,r){var s={};U.queryMobileTable("recsToSync","Mobile_Table_Name",o,function(e){if(0<e.length)try{x(o,i,function(e){console.log("m2pStatusObject",e),e.status==M&&void 0===e.mc_add_status?(a=0,s.status=0,t(s)):e.status==M&&"more-to-sync"===e.mc_add_status?(console.log("moreToSync - Going round again"),n(o,t,r)):(s.status=e.status,s.mc_add_status=e.mc_add_status,t(s))},r)}catch(e){console.error(e)}else s.status=2,s.mc_add_status="no-sync-no-updates",t(s)},r)},m=function(n,e,o,t,r){var s={};console.log("skipP2M",c),"Dynamic (Submit First/Retain)"==e||"Dynamic (Submit First/Clear)"==e?p(n,function(e){console.log("statusObject",e),!c&&(0===e.status||o&&2==e.status)?f(n,t,r):(c&&0===e.status||2==e.status?s.status=y:s.status=b,s.mc_add_status=e.mc_add_status,t(s))},r):"Submit Only"==e||"Submit & Clear"==e||"Submit & Destroy"==e?p(n,function(e){0===e.status?s.status=y:(s.status=b,s.mc_add_status=e.mc_add_status),t(s)},r):A.errorAndDispatch("Unknown sync type",e,c)};return new Promise(function(t,r){var s={},a=function(e){localStorage.removeItem("syncInProgressTime"),console.timeEnd("syncMobileTable"),d&&(e.table=u,d(e)),t(e)},i=function(e){localStorage.removeItem("syncInProgressTime"),console.timeEnd("syncMobileTable"),d&&d({table:u,status:-1}),r(e)},e="syncTime"+u,n=localStorage.getItem(e),o=(new Date).valueOf(),c=n?parseInt(n)+5e3:0;"Connection_Session__mc"!=u&&o<c?(s.status=y,s.mc_add_status="sync-too-soon",console.timeEnd("syncMobileTable"),t(s)):(localStorage.setItem(e,o),j(function(e){if(console.log("heartbeat call gave "+e.status),e.status==F||e.status==q||e.status==K){var n=localStorage.getItem("syncInProgressTime"),o=(new Date).valueOf();console.log("syncInProgressTime",n,o),"Connection_Session__mc"!=u&&n&&o-12e4<n?(console.log("SYNC_ALREADY_IN_PROGRESS"),s.status=y+g,i(s)):(localStorage.setItem("syncInProgressTime",o),U.getTableDefnColumnValue(u,"Sync Type").then(function(n){B(function(e){"Mobile_Log__mc"!=u?null!=e?H(e,function(e){e.status==W?"Refresh Only"==n||"Refresh & Clear"==n?f(u,a,i):m(u,n,l,a,i):(s.status=SYNC_OK,s.mc_add_status=e.status,console.timeEnd("syncMobileTable"),t(s))},function(e){A.errorAndDispatch(e),r(e)}):"Refresh Only"==n||"Refresh & Clear"==n?f(u,a,i):m(u,n,l,a,i):m(u,n,!1,a,i)},i)}).catch(function(e){i(e)}))}else s.status=b,s.mc_add_status=e.status,console.timeEnd("syncMobileTable"),t(s),100101==s.mc_add_status||100102==s.mc_add_status?A.error(s):A.log(s)},i))})}function R(d){return new Promise(function(s,n){var a=function(e){n(e)},i={};console.log("json object date time = "+d.lastRefreshDatetime);var c={},u={},l=d.mt;null===l&&console.error("Mobile Table (tag 'mt') empty in p2mRefresh response: ",d);var e=L.buildExactQuerySpec("Mobile_Table_Name",l,mobileCaddy.QUERY_BUFFER_SIZE);U.querySoupRecordsWithQuerySpec("recsToSync",e,function(r){r.forEach(function(e){if("Insert"==e.CRUD_Operation||"InsertUpdate"==e.CRUD_Operation)c[e.Id]=1;else{if("Update"!=e.CRUD_Operation&&"UpdateUpdate"!=e.CRUD_Operation)return void A.error("RTS contains record with non support CRUD Operation"+e);u[e.Id]=1}}),U.getProxyFieldName(l).then(function(o){var t=[],n=[];(d.records.forEach(function(e){var n=!0;null!==e.recordData.MC_Proxy_ID__c&&c.hasOwnProperty(e.recordData[o])&&(n=!1),n&&u.hasOwnProperty(e.recordData.Id)&&(n=!1),n&&t.push(e.recordData)}),d.ds)&&d.ds.oq.concat(d.ds.sd.concat(d.ds.hd.concat(d.ds.sh))).forEach(function(e){u.hasOwnProperty(e)?console.log("We have a dirty local version, not deleting"):n.push({Id:e})});var e=L.buildExactQuerySpec("Mobile_Table_Name",l,mobileCaddy.QUERY_BUFFER_SIZE);U.querySoupRecordsWithQuerySpec("recsToSync",e,function(e){e.length==r.length?U.deleteRecordsForExternalId(l,n,"Id",function(){L.upsertSoupEntriesWithExternalId(l,t,"Id",function(){L.soupExists("SnapShot_"+l,function(e){e?U.deleteRecordsForExternalId("SnapShot_"+l,n,"Id",function(){L.upsertSoupEntriesWithExternalId("SnapShot_"+l,t,"Id",function(){te(d),f(d.platAuthUrl),i.status=0,i.cs=d.cs,i.cp=d.cp,i.lastRefreshDatetime=d.lastRefreshDatetime,s(i)},a)},a):(te(d),f(d.platAuthUrl),i.status=0,i.lastRefreshDatetime=d.lastRefreshDatetime,i.cs=d.cs,i.cp=d.cp,s(i))},a)},a)},a):(i.status=0,i.mc_add_status=1,i.cs=d.cs,i.cp=d.cp,i.lastRefreshDatetime=d.lastRefreshDatetime,resolves(i))},a)})},a)})}function f(n){console.log("setPlatAuthUrl",n),n||(n=""),h.updateCurrentValueInAppSoup("platAuthUrl",n).catch(function(e){A.error("setPlatAuthUrl",n,e)})}var E=100500,v=100402;function T(s,a,i,o,n,t,c,u){console.log("Refreshing table",s);var r,l,d,f,p=function(e,n){if(console.debug("respJson",e),console.debug("event",n),n.status){var o,t,r=new RegExp("\n","g");e=e.replace(r,"\\n"),r=new RegExp("\r","g"),e=e.replace(r,""),t=JSON.parse(e),console.log("Parse json done"),R(t).then(function(e){return o=e,console.log("handle refresh res = "+o.status),U.setTableDefnColumnValue(s,"Last Refresh Date/Time",o.lastRefreshDatetime)}).then(function(){var e="P2M RE Records Processed";return"Connection_Session__mc"==s&&(e="P2M Conn_Sess Records Processed"),1==o.mc_add_status&&(e="P2M RE Abandoned"),f.connSessionRec.mobilecaddy1__Mobile_Process_Status__c=e,f.connSessionRec.Id=o.cs,ne(f.connSessionRec)}).then(function(){return oe(t.csM2P)}).then(function(){console.log("success return from post process"),i&&l<C?ee(f.connSessionRec,function(){console.log("success return from maybeSyncConnSess"),t["Session Number"]&&t["Session Number"]<t["Total Sessions"]?(console.info("Page "+t["Session Number"]+" of "+t["Total Sessions"]+", going again."),T(s,a,i,t["Session Number"]+1,t["Total Sessions"],t.CsPId,c,u)):t.moreBatches?(console.info("moreBatches"),T(s,a,i,"newBatch",1,null,c,u)):(m.status=E,c(m))},u):t["Session Number"]&&t["Session Number"]<t["Total Sessions"]?(console.info("Page "+t["Session Number"]+" of "+t["Total Sessions"]+", going again."),T(s,a,i,t["Session Number"]+1,t["Total Sessions"],t.CsPId,c,u)):t.moreBatches?(console.info("moreBatches"),T(s,a,i,"newBatch",1,null,c,u)):(console.log("No more pages or batches"),m.status=E,c(m))}).catch(function(e){u(e)})}else"exception"===n.type&&A.error("p2mRefresh",s,n.message,n.where),$(n,f,function(e){m.status=v,m.mc_add_status=e.mc_add_status,c(m)},u)},m={},_="newBatch"==o;_&&(o=1);try{U.getTableDefnColumnValue(s,"Last Refresh Date/Time").then(function(e){(d=e)&&"null"!=d||(d=0),console.log("Using lastRefreshDatetime = "+d),console.debug("maxTableAge",a);var n=new Date;return d<n-a||1<o||_?h.getCachedCurrentValueFromAppSoup("audId"):(console.log("Not refreshing table. it is too young"),m.status=100402,m.status=100497,c(m),Promise.reject(m))}).then(function(e){return r=e,h.getCachedCurrentValueFromAppSoup("syncRefreshVersion")}).then(function(e){return O(l=e,"Sync - Refresh","P2M RE Process Called",o,n,t)}).then(function(e){if(f=e,!i){var n=JSON.parse(f.connSessJson);n.initialSync=!0,f.connSessJson=JSON.stringify(n)}if(_){var o=JSON.parse(f.connSessJson);o.firstBatch=!1,f.connSessJson=JSON.stringify(o)}return P(l,i)}).then(function(e){console.log("csUpdates",e),e&&(f.connSessJson=JSON.parse(f.connSessJson),f.connSessJson.csM2P=e,f.connSessJson=JSON.stringify(f.connSessJson)),console.log("connSessObject -> ",f),!0===S?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/p2mRefreshTable001",contentType:"application/json",data:{audId:r,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:l,mobileTableName:s,deviceRefreshIds:[],lastRefreshDateTime:d,thirdPartyJson:"",connSessJson:f.connSessJson}},function(e,n){void 0===n&&((n={}).status="200"),p(e,n)},u):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".p2mRefreshTable",r,l,s,[],d,"",f.connSessJson,p,{buffer:!1,escape:!1,timeout:12e4})}).catch(function(e){100497==e.status?c(e):(A.error(e),u(e))})}catch(e){A.errorAndDispatch(e)}}function I(t,r,s){return new Promise(function(n,o){h.getCachedCurrentValueFromAppSoup("audId").then(function(e){n("PROXY%"+t+"%"+s+"%"+r+"%"+e)}).catch(function(e){o(e)})})}function N(e,n,o,t){var r;if("Throw Exception"==t)throw A.errorAndDispatch("nullHandler - NULL value found",e,n,o.Id),"NULL value found for field "+n+" in Mobile Table "+e+" with Id = "+o.Id;return"Return NULL"==t?r=null:"Return Empty String"==t&&(r=""),r}function P(t,s){return new Promise(function(n,e){if(console.log("syncRefreshVersion",t,C),t<C||!s)n();else{var o,r=[];U.queryMobileTable("recsToSync","Mobile_Table_Name","Connection_Session__mc").then(function(e){return o=e,console.log("rtsRecs",o),0<o.length?U.querySoupRecsPromise("Connection_Session__mc"):Promise.resolve([])}).then(function(t){console.log("csRecs",t),o.forEach(function(e){for(var n,o=0;o<t.length;++o)if(t[o].Id===e.Id){n=t[o];break}n&&r.push({Id:e.Id,t:function(e){switch(e){case"Sync - Refresh":return 1;case"Sync - Update":return 2;case"Status Check":return 3;default:return A.error("Unkown Session_Type__c",e),0}}(n.mobilecaddy1__Session_Type__c),s:function(e){switch(e){case"P2M RE Records Processed":return 1;case"P2M Conn_Sess Records Processed":return 2;case"P2M RE Abandoned":return 3;case"P2M RE Exception/Timeout":return 4;case"P2M RE Heartbeat Exception/Timeout":return 5;case"P2M RE Failure":return 6;case"P2M RE Hearbeat Failure":return 7;case"M2P Conn_Sess Records Processed":return 8;case"M2P Records Processed":return 9;case"M2P UP Failed - RTS Cleared":return 10;case"M2P SC - Status Check Processed":return 11;case"M2P SC Failure":return 12;case"M2P SC Exception/Timeout":return 13;case"M2P SC Heartbeat Exception/Timeout":return 14;case"M2P SC Heartbeat Failure":return 15;case"M2P UP Received - Records Processed":return 16;default:return A.error("Unkown CS status",e),0}}(n.mobilecaddy1__Mobile_Process_Status__c)})}),n(r)}).catch(function(e){A.error(e),n(null)})}})}function w(a,i,c,e,u,l,n,d,f,o,t){var p={MobileTable:a,connSessProxyId:o,records:[]};n.forEach(function(e){for(var n,o=0;o<d.length;++o)if(d[o].Id===e.Id){n=d[o];break}if(n){var t={RTSRowNum:e._soupEntryId,RecordCRUD:function(e){switch(e){case"Insert":return"I";case"InsertDelete":return"T";case"Update":return"U";case"UpdatetDelete":return"Q";case"Delete":return"D";default:return null}}(e.CRUD_Operation),fields:[]};switch(t.RecordCRUD){case"I":case"T":t=function(e,n,o,t,r,s,a,i){for(var c in i){var u={name:c};if("mobilecaddy1__Error_Text__c"==c)u.value=JSON.stringify(i[c]),e.fields.push(u);else if("_soupEntryId"!=c&&"_soupLastModifiedDate"!=c){var l,d={};d[t]=c;var f=_.findWhere(o,d);if(null===i[c])fieldNullHandler=f[s],l=N(n,c,i,fieldNullHandler);else if(l=i[c],f){var p=f[a];"M2P UP Unquoted"!=p||"true"!=l&&"false"!=l||(l="true"==l)}u.value=l,e.fields.push(u)}}return e}(t,a,i,c,0,u,l,n),p.records.push(t);break;case"D":case"U":case"Q":for(var r,s=0;s<f.length;++s)if(f[s].Id===e.Id){r=f[s];break}r?(t=function(e,n,o,t,r,s,a,i,c){var u=!1;for(var l in i)if("_soupEntryId"!=l&&"_soupLastModifiedDate"!=l){var d={name:l};if(i[l]!=c[l]||"SystemModstamp"==l){var f,p;u=!0;var m=null,S=null,h={};h[t]=l;var g=_.findWhere(o,h);null===i[l]?(m=g[s],f=N(n,l,i,m)):(f=i[l],g&&("M2P UP Unquoted"!=(S=g[a])||"true"!=f&&"false"!=f||(f="true"==f))),null===c[l]&&g?(m||(m=g[s]),p=N(n,l,c,m)):(p=c[l],g&&(S||(S=g[a]),"M2P UP Unquoted"!=S||"true"!=p&&"false"!=p||(p="true"==p))),d.previousValue=p,d.value=f,e.fields.push(d)}}return u?(e.fields.push({name:"Id",previousValue:c.Id,value:c.Id}),e):[]}(t,a,i,c,0,u,l,n,r),p.records.push(t)):A.errorAndDispatch("createUpdateJson Missing snapShot",a,n.Id);break;default:A.errorAndDispatch("createUpdateJson unknown CRUD",a,e.Id,e.CRUD_Operation)}}else A.errorAndDispatch("createUpdateJson Missing primary",a,e.Id)}),t(JSON.stringify(p))}function D(n,e,r,o,t){var s=[];e.forEach(function(o){var t={};r.forEach(function(e){if(o.Id==e.Id&&"Insert"==o.CRUD_Operation)for(var n in e)"_soupEntryId"!=n&&"_soupLastModifiedDate"!=n&&(t[n]=e[n])}),_.isEmpty(t)||s.push(t)}),0===s.length?o():U.getProxyFieldName(n).then(function(e){L.upsertSoupEntriesWithExternalId("SnapShot_"+n,s,e,o,t)})}function O(e,f,p,m,_,S){return new Promise(function(l,t){var d={};r.getLocation(function(r){var s,e,a,i,c,n,o={mobilecaddy1__Session_Type__c:f,mobilecaddy1__Mobile_Process_Status__c:p,SystemModstamp:(new Date).getTime()},u=r.ErrorNumber;0!==u?o.mobilecaddy1__Session_Created_Location_Error__c=r.Error:(o.Session_Created_Location__Longitude__s=r.Latitude,o.Session_Created_Location__Latitude__s=r.Longitude),s="Connection_Session__mc",e=o,a=function(e){var n=new Date,o={"Sync Session Proxy ID":null,"Total Sessions":_,"Session Number":m,"Device Call Date/Time":n.getTime(),"Connection Session Proxy ID":e.proxyId};S&&(o.CsPId=S),0!==u?o.ErrorNumber=u:(o["Location Long"]=r.Longitude,o["Location Lat"]=r.Latitude),d.status=0,d.connSessionRec=e.insertedRecord,d.connSessProxyId=e.proxyId;var t={version:"NULL"};window.device&&(t=window.device),h.getCurrentValueFromAppSoup("containerVersion").then(function(e){o.containerVsn=e,o.OSVsn=t.version,d.connSessJson=JSON.stringify(o),l(d)}).catch(function(e){A.error("buildConnectionSession - Could not get containerVsn",e),o.OSVsn=t.version,d.connSessJson=JSON.stringify(o),l(d)})},i=function(e){t(e)},c={},n=new Date,U.getProxyFieldName(s).then(function(t){L.upsertSoupEntries(s,[e],function(e){var o=e[0];I(s,o._soupEntryId,n.getTime()).then(function(n){o.Id=n,o[t]=n,L.upsertSoupEntries(s,[o],function(e){c.status=0,c.proxyId=n,c.insertedRecord=e[0],a(c)},i)}).catch(function(e){i(e)})},i)}).catch(function(e){i(e)})},function(e){t(e)})})}function s(p){return new Promise(function(n,o){var l={},d=function(e){n(e)},f=function(e){o(e)},e=L.buildExactQuerySpec("Mobile_Table_Name",p,mobileCaddy.QUERY_BUFFER_SIZE);U.querySoupRecordsWithQuerySpec("recsToSync",e,function(e){if(0!==e.length){console.debug("recsToSyncRecords",JSON.stringify(e));var c=!1;"Connection_Session__mc"!=p&&3e4<e.length&&(c=!0),console.log("moreToSync: "+c);var u=[];u=c?(u=_.sortBy(e,"_soupLastModifiedDate")).slice(0,3e4):e,console.debug("recsToSyncRecords2",JSON.stringify(u)),U.querySoupRecords(p,function(i){U.querySoupRecords("SnapShot_"+p,function(a){U.getSysDataRowMapColHeadings("Row Mapping TC",["Parent SOUP Name","Table Column Name","M2P Update Converter DEVICE","M2P Update NULL Handler DEVICE","M2P Update Formatter DEVICE"],function(e){var n=e[0],t=e[1],r=(e[2],e[3]),s=e[4];U.queryMobileTableWithAnd("syncLib_system_data","MC_Var_String_001","Platform Table Column",n,p,function(e){var o=[];if(_.each(u,function(e){var n;n=e.Id,_.find(i,function(e){return e.Id==n})&&o.push(e)}),_.isEmpty(o))return console.debug("Nothing in checkedRecsToSync."),void U.setTableDefnColumnValue(p,"Last Sync Date/Time",(new Date).getTime()).then(function(){l.status=M,l.mc_add_status=V,d(l)}).catch(function(e){A.error(e)});w(p,e,t,0,r,s,o,i,a,"",function(n){var t;h.getCachedCurrentValueFromAppSoup("audId").then(function(e){return t=e,h.getCachedCurrentValueFromAppSoup("syncRefreshVersion")}).then(function(e){D(p,u,i,function(){console.log("moreToSync: "+c);var o=function(e,n){console.debug("result: "+e),console.debug("event: "+n),l.result=e,l.event=n,d(l)};n=n.replace(/: undefined/g,': "undefined"'),console.debug("jsonString -> "+n),!0===S?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/m2pUpdateTable001",contentType:"application/json",data:{audId:t,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:e,mobileTableName:p,jsonRecords:n,connSessJson:"{}"}},function(e,n){void 0===n&&((n={}).status="200"),o(e,n)},f):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".m2pUpdateTable",t,e,p,n,JSON.stringify({"Session Number":1,"Location Long":10,"Location Lat":10,"Total Sessions":1,"Device Call Date/Time":(new Date).getTime(),"Connection Session Proxy ID":"1",ErrorNumber:2}),o,{buffer:!1,escape:!1,timeout:3e4})},f)}).catch(function(e){f(e)})})},f)},f)},f)},f)}else U.setTableDefnColumnValue(p,"Last Sync Date/Time",(new Date).getTime()).then(function(){l.status=M,l.mc_add_status=V,d(l)}).catch(function(e){A.log("No recs to sync")})},f)})}var M=100300,V=100310;function x(u,a,l,d){var f,p,m={};console.debug("In m2pUpdateMobileTable call",u,a);try{h.getCachedCurrentValueFromAppSoup("syncRefreshVersion").then(function(e){return p=e,O(0,"Sync - Update","M2P Process Called",1,1,null)}).then(function(e){return f=e,console.log("proxy id = "+f.connSessProxyId),P(p,!0)}).then(function(e){console.log("m2p csUpdates",e),e&&(f.connSessJson=JSON.parse(f.connSessJson),f.connSessJson.csM2P=e,f.connSessJson=JSON.stringify(f.connSessJson)),console.log("connSessObject -> ",f);var n=L.buildExactQuerySpec("Mobile_Table_Name",u,mobileCaddy.QUERY_BUFFER_SIZE);U.querySoupRecordsWithQuerySpec("recsToSync",n,function(e){if(0!==e.length){console.debug("recsToSyncRecords",JSON.stringify(e));var c=!1;"Connection_Session__mc"!=u&&e.length>a&&(c=!0),console.log("moreToSync",c);var n=[];n=c?(n=_.sortBy(e,"_soupLastModifiedDate")).slice(0,a):e,console.debug("recsToSyncRecords2",JSON.stringify(n)),o=n,t=f.connSessProxyId,r=function(i){U.querySoupRecords(u,function(a){U.querySoupRecords("SnapShot_"+u,function(s){U.getSysDataRowMapColHeadings("Row Mapping TC",["Parent SOUP Name","Table Column Name","M2P Update Converter DEVICE","M2P Update NULL Handler DEVICE","M2P Update Formatter DEVICE"],function(e){var n=e[0],o=e[1],t=(e[2],e[3]),r=e[4];U.queryMobileTableWithAnd("syncLib_system_data","MC_Var_String_001","Platform Table Column",n,u,function(e){w(u,e,o,0,t,r,i,a,s,f.connSessProxyId,function(t){var n;h.getCachedCurrentValueFromAppSoup("audId").then(function(e){n=e,D(u,i,a,function(){console.log("moreToSync",c);var o=function(e,n){var o;(console.debug("result",e),console.debug("event",n),n.status)?(e=e.replace(/,}/g,"}"),console.log("Parse json processM2PUpdateResponse"),o=JSON.parse(e),console.log("Parse json processM2PUpdateResponse done"),Y(o,t,function(e){console.debug("responseObject",JSON.stringify(e)),f.connSessionRec.mobilecaddy1__Mobile_Process_Status__c="Connection_Session__mc"==u?"M2P Conn_Sess Records Processed":"M2P Records Processed",f.connSessionRec.Id=e.csId,ne(f.connSessionRec).then(function(){return oe(o.csM2P)}).then(function(){console.log("success return from post process"),console.log("success return from post process"),console.log("moreToSync",c),c?(m.status=M,m.mc_add_status="more-to-sync",l(m)):p<C?ee(f.connSessionRec,function(){console.log("success return from maybeSyncConnSess"),m.status=M,l(m)},d):(m.status=M,l(m))}).catch(function(e){d(e)})},d)):("exception"===n.type?(m.status=M,m.mc_add_status=k):(m.status=M,m.mc_add_status=J),l(m),A.error("m2pUpdate",u,n.message,n.where))};t=t.replace(/: undefined/g,': "undefined"'),console.debug("jsonString -> "+t),!0===S?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/m2pUpdateTable001",contentType:"application/json",data:{audId:n,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:p,mobileTableName:u,jsonRecords:t,connSessJson:f.connSessJson}},function(e,n){void 0===n&&((n={}).status="200"),o(e,n)},d):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".m2pUpdateTable",n,p,u,t,f.connSessJson,o,{buffer:!1,escape:!1,timeout:3e4})},d)}).catch(function(e){d(e)})})},d)},d)},d)},d)},s=d,o.forEach(function(e){e.Current_Connection_Session=t}),L.upsertSoupEntriesWithExternalId("recsToSync",o,"Id",r,s)}else U.setTableDefnColumnValue(u,"Last Sync Date/Time",(new Date).getTime()).then(function(){m.status=M,m.mc_add_status=V,l(m)}).catch(function(e){d(e)});var o,t,r,s},d)},d)}catch(e){A.errorAndDispatch(e)}}var F=100100,k=100101,J=100102,i=100103,q=100104,K=100105;function j(n,o){var t={},e=navigator.appVersion.includes("Electron");e||navigator&&navigator.connection&&"undefined"!=typeof Connection?(console.log("Connection details"),e||navigator.connection.type!=Connection.NONE?"undefined"==typeof Visualforce?(A.log("Visualforce not currently defined"),new Promise(function(e,i){var c=window.location.pathname,u=new XMLHttpRequest;u.open("GET",c,!0),u.send(),u.onreadystatechange=function(){if(u.readyState==XMLHttpRequest.DONE&&200==u.status){console.log(u.response),A.log("Startpage re-fetched",c);var e=new RegExp('"(\\S+VFRemote.js)"'),n=e.exec(u.response);if(n&&n[0]){var o=n[1];console.log("vfRemoteSrc",o),t=o,r=function(){A.log("remote script fetched",o),A.log("set up Visualforce ref")},s=document.createElement("script"),a=document.getElementsByTagName("script")[0],s.async=1,s.onload=s.onreadystatechange=function(e,n){(n||!s.readyState||/loaded|complete/.test(s.readyState))&&(s.onload=s.onreadystatechange=null,s=void 0,n||r&&r())},s.src=t,a.parentNode.insertBefore(s,a)}else i("Could not find VFRemote.js mention in "+c)}else u.readyState==XMLHttpRequest.DONE&&i(u.status);var t,r,s,a}}).then(function(e){c(n,o)}).catch(function(e){A.errorAndDispatch("Startpage Load Error: "+window.location.pathname,e),t.status=J,n(t)})):c(n,o):(t.status=i,n(t))):(localStorage.connection?t.status=localStorage.connection:t.status=q,n(t))}function c(o,e){var t={};Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".heartBeat",function(e,n){n.status?(t.status=F,o(t)):"exception"===n.type?u(function(e){console.log("refresh token refreshed in heartbeat"),t.status=K,o(t)},function(e){t.status=k,o(t)}):(console.debug("other"),t.status=J,o(t))},{escape:!1,timeout:3e4})}function u(o,t){U.querySoupRecords("appSoup",function(e){var n={};e.forEach(function(e){n[e.Name]=e.CurrentValue}),function(e,n,o){var t="grant_type=refresh_token&identity_url="+e.identityUrl+"&client_id="+e.clientId+"&refresh_token="+e.refreshToken+"&orgId="+e.orgId+"&audId="+e.audId+"&userId="+e.userId;console.log("data: "+t);var r=new XMLHttpRequest;r.open("POST","https://mobilecaddy.secure.force.com/apex/ProxyToken",!0),r.setRequestHeader("Content-type","application/x-www-form-urlencoded"),r.send(t),r.onreadystatechange=function(){if(r.readyState==XMLHttpRequest.DONE&&200==r.status){var e=JSON.parse(r.response);console.log("Changing vf access token from "+Visualforce.remoting.oauthAccessToken+" to "+e.access_token),Visualforce.remoting.oauthAccessToken=e.access_token,Visualforce.remoting.last.refresh(function(){h.updateCurrentValueInAppSoup("accessToken",e.access_token).then(function(){console.log("Updated accessToken in appSoup"),n(e.access_token)}).catch(function(e){o(e)})},function(e){A.error("in VF last refresh error"),o(e)})}else r.readyState==XMLHttpRequest.DONE&&A.error("refreshTokenRequest error.",r.status)}}(n,o,t)},function(e){t(e)})}function B(i,c){U.querySoupRecords("recsToSync",function(e){console.debug("recsToSync -> "+JSON.stringify(e));for(var n=null,o=null,t=0;t<e.length;t++)if(console.debug("recsToSync["+t+"] -> "+JSON.stringify(e[t])),null!==e[t].Current_Connection_Session&&void 0!==e[t].Current_Connection_Session){n=e[t].Current_Connection_Session,o=e[t];break}if(null!=n){var r=(new Date).getTime(),s=o._soupLastModifiedDate+3e4;if(s<r)console.debug("timeNow > timeoutTs",r,s),console.debug("We have a timedout Conn_Sess",n),i(n);else{console.debug("We have a SYNC_ALREADY_IN_PROGRESS",n);var a={status:100498};c(a)}}else console.debug("getRTSPendingconnSess - All clear"),i(n)},c)}var W=100200,l=100201;function H(a,m,_){console.debug("csStatusCheck -> "+a);try{var i;h.getCachedCurrentValueFromAppSoup("syncRefreshVersion").then(function(e){return i=e,O(0,"Status Check","M2P SC Status Check Requested",1,1,null)}).then(function(p){j(function(n){var s;n.status==F||n.status==q||n.status==K?h.getCachedCurrentValueFromAppSoup("audId").then(function(n){s=n;var o=function(n,o){var f,t,r,s;o.status?((f=JSON.parse(n)).cs_fc_jr&&(f.cs_fc_jr=JSON.parse(f.cs_fc_jr)),console.debug("Parse json status check done"),"Received Processed"==f.cs_fc_sc?function(o,t,n,r){try{Y(t.cs_fc_jr,function(e){o.connSessionRec.mobilecaddy1__Mobile_Process_Status__c="M2P SC - Status Check Processed",o.connSessionRec.SystemModstamp=(new Date).getTime(),o.connSessionRec.mobilecaddy1__Status__c="Closed",o.connSessionRec.Id=t.cs_sc_sf,U.queryMobileTable("Connection_Session__mc","Id",t.cs_fc_jr.cp).then(function(e){if(e[0]){var n=e[0];return console.log("m2pCsObject",n),n.Id=t.cs_fc_jr.csId,n.SystemModstamp=(new Date).getTime(),n.mobilecaddy1__Mobile_Process_Status__c="M2P Records Processed",ne([o.connSessionRec,n])}return Promise.resolve()}).then(function(){n({status:W})}).catch(function(e){r(e)})},r)}catch(e){A.errorAndDispatch("processM2PUpdateResponse",e),r("processM2PUpdateResponse-error")}}(p,f,m,_):(t=a,r=function(){U.queryMobileTable("Connection_Session__mc","mobilecaddy1__MC_Proxy_ID__c",a,function(n){if(0<n.length){var o=n[0];"Received Not Processed"==f.cs_fc_sc?(u=p,l=f,d=_,(c=o).mobilecaddy1__Mobile_Process_Status__c="M2P UP Failed - RTS Cleared",c.mobilecaddy1__Session_Type__c="Sync Update",c.mobilecaddy1__Status__c="Closed",c.SystemModstamp=(new Date).getTime(),c.Id=l.cs_fc_sf,ne(c).then(function(){u.connSessionRec.mobilecaddy1__Mobile_Process_Status__c="M2P SC - Status Check Processed",u.connSessionRec.SystemModstamp=(new Date).getTime(),u.connSessionRec.mobilecaddy1__Status__c="Closed",u.connSessionRec.Id=l.cs_sc_sf,ne(u.connSessionRec)}).catch(function(e){d(e)})):(t=o,r=p,s=f,a=m,i=_,U.deleteRecordsFromSoup([t],"Connection_Session__mc",function(n){r.connSessionRec.mobilecaddy1__Mobile_Process_Status__c="M2P SC - Status Check Processed",r.connSessionRec.SystemModstamp=(new Date).getTime(),r.connSessionRec.mobilecaddy1__Status__c="Closed",r.connSessionRec.Id=s.cs_sc_sf,r.connSessionRec.mobilecaddy1__Session_Type__c="Status Check",ne(r.connSessionRec).then(function(){a({status:W})}).catch(function(){i(e)})},i))}else m({status:W});var t,r,s,a,i,c,u,l,d},_)},s=_,console.log("clearRTSRecs",t),U.queryMobileTable("recsToSync","Current_Connection_Session",t,function(e){if(0!==e.length){for(var n=0;n<e.length;n++)e[n].Current_Connection_Session=null,"InsertUpdate"==e[n].CRUD_Operation?e[n].CRUD_Operation="Insert":"UpdateUpdate"==e[n].CRUD_Operation&&(e[n].CRUD_Operation="Update");L.upsertSoupEntries("recsToSync",e,r,s)}else r()},s))):(A.error("csStatusCheck",o.message),m({status:l}))},t=p.connSessJson,r=localStorage.getItem("lastErrorLog");r&&(localStorage.removeItem("lastErrorLog"),(t=JSON.parse(t)).lastErrorLog=r,t=JSON.stringify(t)),!0===S?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/m2pCSStatusCheck001",contentType:"application/json",data:{audId:s,syncRefreshDataVersion:i,statusCheckCSProxyId:a,connSessJson:t,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN}},function(e,n){console.info("response -> "+JSON.stringify(e)),void 0===n&&((n={}).status="200"),o(e,n)},function(e){A.error("err -> "+JSON.stringify(e)),_(e)}):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".m2pCSStatusCheck",s,i,a,t,o,{buffer:!1,escape:!1,timeout:3e4})}).catch(function(e){_(e)}):z(n,p,function(e){m({status:W,mc_add_status:e.mc_add_status})},_)},_)}).catch(function(e){_(e)})}catch(e){A.errorAndDispatch(e)}}function Y(f,e,p,m){m||(m=p,p=e,e="{}");var S=1;console.debug("processM2PUpdateResponse",f,e);var a,i,c,o,h=f.mt,g=void 0!==f.is?f.is:[],n=void 0!==f.id?f.id:[],y=void 0!==f.us?f.us:[],b=void 0!==f.ifmf?f.ifmf:[],C=void 0!==f.ufmf?f.ufmf:[],R=[],E=[],v=[],T=[],I=[],N=[],P=[],w=[],D=[],O=[],M=[];if(g=g.concat(n),void 0===f.if)O=[];else if(void 0===f.if.if)O=f.if;else{S=2;var t=f.if.if.map(function(e){return{pd:e,fbe:void 0!==f.ifbe?f.ifbe:"K"}}),r=f.if.ifv.map(function(e){return{pd:e,fbe:void 0!==f.ifvbe?f.ifvbe:"K"}}),s=f.if.icv.map(function(e){return{pd:e,fbe:void 0!==f.icvbe?f.icvbe:"K"}});O=t.concat(r.concat(s))}(a=e,i=g,c=O,o=b,new Promise(function(e,n){a=JSON.parse(a);var t=c.concat(o),r=c;if(a.records&&a.records.length>i.length+t.length){var s=[];U.getProxyFieldName(a.MobileTable).then(function(o){a.records.forEach(function(e){if("I"==e.RecordCRUD){var n=e.fields.find(function(e){return e.name==o}).value;_.findWhere(i,{pd:n})||_.findWhere(t,{pd:n})||s.push({pd:n,fbe:"K"})}}),0<s.length&&(r=c.concat(s)),e(r)})}else e(r)})).then(function(e){if(O=e,void 0===f.uf)M=[];else if(void 0===f.uf.uf)M=f.uf;else{S=2;var n=f.uf.uf.map(function(e){return{Id:e,fbe:void 0!==f.ufbe?f.ufbe:"K"}}),o=f.uf.usv.map(function(e){return{Id:e,fbe:void 0!==f.usvbe?f.usvbe:"K"}}),t=f.uf.sdf.map(function(e){return{Id:e,fbe:void 0!==f.sdfbe?f.sdfbe:"K"}}),r=f.uf.hdf.map(function(e){return{Id:e,fbe:void 0!==f.hdfbe?f.hdfbe:"K"}}),s=f.uf.ufv.map(function(e){return{Id:e,fbe:void 0!==f.ufvbe?f.ufvbe:"K"}}),a=f.uf.ucv.map(function(e){return{Id:e,fbe:void 0!==f.ucvbe?f.ucvbe:"K"}});M=n.concat(o.concat(t.concat(r.concat(s.concat(a)))))}return d("SnapShot_"+h)}).then(function(e){return D=e,d(h)}).then(function(d){console.debug("priRecords -> "+JSON.stringify(d)),U.queryMobileTable("recsToSync","Mobile_Table_Name",h,function(e){for(var n in e)if(console.debug("recsToSyncRec[i] = "+JSON.stringify(e[n])),e[n].Current_Connection_Session==f.cp){var o=!1,t={},r={};switch(e[n].CRUD_Operation){case"Insert":case"InsertUpdate":for(var s in g)if(e[n].Id==g[s].pd){if(g[s].crud=e[n].CRUD_Operation,r=G(g[s],d),"Insert"==e[n].CRUD_Operation){switch(f.stbe){case"D":P.push(r),w.push(g[s]);break;default:if("U"==g[s].pc){if(r.Id=g[s].Id,void 0!==g[s].an&&(void 0!==g[s].nf?r[g[s].nf]=g[s].an:r.Name=g[s].an),void 0!==g[s].lu)for(var a in g[s].lu)g[s].lu.hasOwnProperty(a)&&console.debug("prop",a,g[s].lu[a]),r[a]=g[s].lu[a];T.push(r),N.push(r)}}E.push(e[n]._soupEntryId)}else{if(r.Id=g[s].Id,void 0!==g[s].an&&(void 0!==g[s].nf?r[g[s].nf]=g[s].an:r.Name=g[s].an),void 0!==g[s].lu)for(var i in g[s].lu)g[s].lu.hasOwnProperty(i)&&console.debug("iUProp",i,g[s].lu[i]),r[i]=g[s].lu[i];T.push(r);var c=G(g[s],D);c.Id=g[s].Id,N.push(c),(t=e[n]).Current_Connection_Session=null,t.CRUD_Operation="Update",t.Id=g[s].Id,R.push(t)}o=!0;break}if(!o)for(s in O)if(console.info("failure",e[n].Id,O[s].pd),e[n].Id==O[s].pd){if(O[s].crud=e[n].CRUD_Operation,"Insert"==e[n].CRUD_Operation)switch("K",1==S?Q(0,O[s].fl,f):O[s].fbe){case"K":(t=e[n]).Current_Connection_Session=null,R.push(t);break;case"R":break;default:r=G(O[s],d),P.push(r),E.push(e[n]._soupEntryId),w.push(O[s])}else"InsertUpdate"==e[n].CRUD_Operation&&((t=e[n]).Current_Connection_Session=null,t.CRUD_Operation="Insert",R.push(t));o=!0;break}if(!o)for(s in b)if(e[n].Id==b[s].pd){if(b[s].crud=e[n].CRUD_Operation,"Insert"==e[n].CRUD_Operation)switch(b[s].fbe){case"K":(t=e[n]).Current_Connection_Session=null,R.push(t);break;case"R":break;default:r=G(b[s],d),P.push(r),E.push(e[n]._soupEntryId),w.push(b[s])}else"InsertUpdate"==e[n].CRUD_Operation&&((t=e[n]).Current_Connection_Session=null,t.CRUD_Operation="Insert",R.push(t));o=!0;break}break;case"Update":case"UpdateUpdate":for(s in y)if(e[n].Id==y[s].Id){if(y[s].crud=e[n].CRUD_Operation,"Update"==e[n].CRUD_Operation){switch(r=G(y[s],d),f.stbe){case"D":P.push(r),w.push(y[s]);break;default:if("M"==y[s].pc&&(r.SystemModstamp=new Date(y[s].sm)),void 0!==y[s].lu)for(var u in console.debug("lu",y[s].lu),y[s].lu)y[s].lu.hasOwnProperty(u)&&(r[u]=y[s].lu[u]);v.push(r),I.push(r)}E.push(e[n]._soupEntryId)}else"UpdateUpdate"==e[n].CRUD_Operation&&((t=e[n]).Current_Connection_Session=null,t.CRUD_Operation="Update",R.push(t));o=!0;break}if(!o)for(s in M)if(e[n].Id==M[s].Id){if("Update"==e[n].CRUD_Operation)switch("K",1==S?Q(1,M[s].fl,f):M[s].fbe){case"K":(t=e[n]).Current_Connection_Session=null,R.push(t);break;case"R":break;default:r=G(M[s],d),P.push(r),E.push(e[n]._soupEntryId),w.push(M[s])}else"UpdateUpdate"==e[n].CRUD_Operation&&((t=e[n]).Current_Connection_Session=null,t.CRUD_Operation="Update",R.push(t));o=!0;break}if(!o)for(s in C)if(e[n].Id==C[s].Id){if(C[s].crud=e[n].CRUD_Operation,"Update"==e[n].CRUD_Operation)switch(C[s].fbe){case"K":(t=e[n]).Current_Connection_Session=null,R.push(t);break;case"R":break;default:r=G(C[s],d),P.push(r),E.push(e[n]._soupEntryId),w.push(C[s])}else"UpdateUpdate"==e[n].CRUD_Operation&&((t=e[n]).Current_Connection_Session=null,t.CRUD_Operation="Update",R.push(t));o=!0;break}}}var l;console.info("priToInsertRecs",T),console.info("rtsToUpdateRecs",R),U.getProxyFieldName(h).then(function(e){return l=e,Z(h,"Id",v)}).then(function(e){return console.debug("m2pRespUpRecs ("+h+") res -> "+JSON.stringify(e)),Z(h,l,T)}).then(function(e){return console.debug("m2pRespUpRecs"+h+") (PROXY KEY) res -> "+JSON.stringify(e)),Z("SnapShot_"+h,"Id",I)}).then(function(e){return console.debug("m2pRespUpRecs"+h+") (PROXY KEY) res -> "+JSON.stringify(e)),Z("SnapShot_"+h,l,N)}).then(function(e){return console.debug("m2pRespUpRecs (SnapShot_"+h+") res -> "+JSON.stringify(e)),X(h,P)}).then(function(e){return console.debug("m2pRespDelRecs res -> "+JSON.stringify(e)),X("SnapShot_"+h,w)}).then(function(e){return console.debug("m2pRespDelRecs (SnapShot_' + mobileTable + ') res -> "+JSON.stringify(e)),t=R,console.debug("m2pRespUpRTSRecs recsToUp -> "+JSON.stringify(t)),new Promise(function(n,o){0<t.length?L.upsertSoupEntries("recsToSync",t,function(e){n(e)},function(e){o(e)}):n("OK")});var t}).then(function(e){return console.debug("m2pRespUpRTSRecs res -> "+JSON.stringify(e)),t=E,console.debug("m2pRespDelRTSRecs recsToDel -> "+JSON.stringify(t)),new Promise(function(n,o){0<t.length?L.removeFromSoup("recsToSync",t,function(e){n(e)},function(e){o(e)}):n("OK")});var t}).then(function(e){return console.debug("m2pRespDelRTSRecs res -> "+JSON.stringify(e)),te(f)}).then(function(){var e={status:0};e.csId=f.csId,p(e)}).catch(function(e){A.errorAndDispatch("m2pResp error for "+h,e),m(e)})},m)}).catch(function(e){A.errorAndDispatch("Err reading table",h),m(e)})}function G(e,n){var o={};return"Insert"==e.crud||"InsertUpdate"==e.crud?o.Id=e.pd:o.Id=e.Id,_.findWhere(n,o)}function Q(e,n,o){switch(e){case 0:switch(n){case"DF":return o.ifbe;case"CV":return o.icvbe;case"FV":return o.ifvbe}break;case 1:switch(n){case"DF":return o.ufbe;case"SV":return o.usvbe;case"CV":return o.ucvbe;case"FV":return o.ufvbe;case"SD":return o.sdfbe;case"HD":return o.hdfbe}}}function d(e){return new Promise(function(n,o){U.querySoupRecords(e,function(e){n(e)},function(e){o(e)})})}function Z(e,t,r){return console.debug("m2pRespUpRecs ("+e+") updateRecs -> "+JSON.stringify(r)),new Promise(function(n,o){0<r.length?L.upsertSoupEntriesWithExternalId(e,r,t,function(e){n(e)},function(e){o(e)}):n("OK")})}function X(t,r){return console.debug("m2pRespDelRecs ("+t+") recsToDel -> "+JSON.stringify(r)),new Promise(function(n,o){if(0<r.length)if(-1==t.indexOf("SnapShot"))U.deleteRecordsFromSoup(r,t,function(e){n(e)},function(e){o(e)});else{console.debug("Deleting from SnapShot ",t);var e=r.filter(function(e){return e&&"Insert"==e.crud&&(e.Id=e.pd),null!=e});U.deleteRecordsForExternalId(t,e,"Id",function(e){n(e)},function(e){A.errorAndDispatch(e),o(e)})}else n("OK")})}var p=100600;function $(e,n,o,t){var r={bogus:!0};"exception"===e.type?r.status=k:r.status=J,z(r,n,o,t)}function z(e,n,o,t){console.log("in clean connection session heart beat");var r={},s=null;e.status==i?"Sync - Refresh"==n.connSessionRec.mobilecaddy1__Session_Type__c?s="P2M RE Heartbeat No Connection":"Status Check"==n.connSessionRec.mobilecaddy1__Session_Type__c&&(s="M2P SC Heartbeat No Connection"):e.status==k?"Sync - Refresh"==n.connSessionRec.mobilecaddy1__Session_Type__c?s=e.bogus?"P2M RE Exception/Timeout":"P2M RE Heartbeat Exception/Timeout":"Status Check"==n.connSessionRec.mobilecaddy1__Session_Type__c&&(s=e.bogus?"M2P SC Exception/Timeout":"M2P SC Heartbeat Exception/Timeout"):e.status==J&&("Sync - Refresh"==n.connSessionRec.mobilecaddy1__Session_Type__c?s=e.bogus?"P2M RE Failure":"P2M RE Hearbeat Failure":"Status Check"==n.connSessionRec.mobilecaddy1__Session_Type__c&&(s=e.bogus?"M2P SC Failure":"M2P SC Heartbeat Failure")),null!==s?(n.connSessionRec.mobilecaddy1__Mobile_Process_Status__c=s,n.connSessionRec.SystemModstamp=(new Date).getTime(),n.connSessionRec.mobilecaddy1__Status__c="Closed",console.log("Upserting connection session"),L.upsertSoupEntries("Connection_Session__mc",[n.connSessionRec],function(){r.status=p,r.mc_add_status=e.status,o(r)},t)):(A.error("Unknown heartBeatObject.status. ",e.status),t())}function ee(o,t,r){var s={};console.debug("maybeSyncConnSess"),U.querySoupRecsPromise("recsToSync").then(function(e){console.debug("Success from readRecords recsToSync -> "+JSON.stringify(e));var n=_.filter(e,function(e){return void 0!==e.currentConnectionSession});console.debug("connSessRTS -> "+JSON.stringify(n)),1<n.length||"M2P Conn_Sess Records Processed"!=o.mobilecaddy1__Mobile_Process_Status__c?a("Connection_Session__mc").then(function(e){console.debug("syncMobileTable -> ",JSON.stringify(e)),s.status=0,t(s)}).catch(function(e){A.warn("syncMobileTable ERROR -> ",e),r(e)}):(console.debug("maybeSyncConnSess - not syncing"),s.status=0,t(s))}).catch(function(e){A.error("querySoupRecsPromise ERROR -> ",e),r(e)})}function ne(a){return new Promise(function(o,n){var t=function(e){A.error("postProcessConnectionSession error",e),n(e)},r=Array.isArray(a)?a:[a],s={};L.upsertSoupEntries("Connection_Session__mc",r,function(e){var n=Array.isArray(a);n=r.map(function(e){return{Id:e.Id,SystemModstamp:e.SystemModstamp-1,mobilecaddy1__Session_Type__c:null,mobilecaddy1__Mobile_Process_Status__c:null,mobilecaddy1__Session_Created_Location_Error__c:null,mobilecaddy1__MC_Proxy_ID__c:null}}),L.upsertSoupEntries("SnapShot_Connection_Session__mc",n,function(e){var n=e.map(function(e){return{Mobile_Table_Name:"Connection_Session__mc",CRUD_Operation:"Update",SOUP_Record_Id:e._soupEntryId,Id:e.Id,LastModifiedDateTime:e.SystemModstamp}});L.upsertSoupEntries("recsToSync",n,function(){console.log("success from upsert of recs to sync"),s.status=0,o(s)},t)},t)},t)})}function oe(o){return new Promise(function(n,e){console.log("handleUpdatedCS",o);o&&o.us&&0!==o.us.length?U.deleteRecordsForExternalId("Connection_Session__mc",o.us,"Id").then(function(e){return U.deleteRecordsForExternalId("SnapShot_Connection_Session__mc",o.us,"Id")}).then(function(e){return U.deleteRecordsForExternalId("recsToSync",o.us,"Id")}).then(function(e){console.log("handleUpdatedCS -> deleted from CS and RTS OK"),n()}).catch(function(e){A.error("handleUpdatedCS",e),n()}):n(),o&&o.uf&&0!==o.uf.length&&A.error("handleUpdatedCS -> we have uf",o.uf)})}function te(o){return new Promise(function(e,n){null!==o.migrateTo&&void 0!==o.migrateTo?h.updateNewValueInAppSoup("dynVersionNumber",o.migrateTo).then(function(){e()}).catch(function(e){A.error(e),n(e)}):e()})}t.exports={CSINHEAD_SYNC_VSN:C,refreshToken:function(e,n){u(e,n)},genProxyId:function(e,n,o){return I(e,n,o)},addProxyIds:function(e,n,o,t,r){var s,a,i,c,u,l;s=e,a=n,i=o,c=t,u=r,U.getProxyFieldName(s).then(function(e){return l=e,h.getCachedCurrentValueFromAppSoup("audId")}).then(function(o){a.forEach(function(e){var n="PROXY%"+s+"%"+i+"%"+e._soupEntryId+"%"+o;e.Id=n,e[l]=n}),L.upsertSoupEntries(s,a,function(e){c(e)},u)}).catch(function(e){u(e)})},P2M_REFRESH_OK:E,p2mRefreshTable:function(e,n,o,t,r,s,a,i){T(e,n,o,t,r,s,a,i)},buildConnectionSession:function(e,n,o,t,r,s){return O(0,n,o,t,r,s)},M2P_UPDATE_OK:M,M2P_NO_RECS_TO_SYNC:V,m2pUpdateMobileTable:function(e,n,o,t){x(e,n,o,t)},m2pRecoveryUpdateMobileTable:function(e){return s(e)},HEARTBEAT_OK:F,HEARTBEAT_EXCEPTION:k,HEARTBEAT_FAILURE:J,HEARTBEAT_NO_CONNECTION:i,HEARTBEAT_NOT_DEVICE:q,HEARTBEAT_REFRESHED_OK:K,heartBeat:function(e,n){j(e,n)},handleRefreshResponse:R,createUpdateJson:w,syncMobileTable:a,getRTSPendingconnSess:B,CLEAN_CS_OK:p,cleanConnectionSessionHeartBeat:z,cleanConnectionSessionVFEvent:$,CONN_SESS_OK:W,csStatusCheck:H,maybeSyncConnSess:ee,processM2PUpdateResponse:Y,postProcessConnectionSession:ne,handleUpdatedCS:oe}}),s("mobileCaddy/vsnUtils",function(e,n,o){cordova.require("com.salesforce.plugin.smartstore");var p=mobileCaddy.require("mobileCaddy/smartStoreUtils"),m=e("mobileCaddy/appDataUtils"),S=e("mobileCaddy/logger"),r=e("mobileCaddy/syncRefresh"),t=["recsToSync"];function s(e,n){return new Promise(function(o,n){null===e?p.listMobileTables(p.ALPHA,function(e){var n=t;_.each(e,function(e){n.push(e),n.push("SnapShot_"+e),localStorage.removeItem("meta-tableDEF-"+e),localStorage.removeItem("meta-tableCRUD-"+e)}),console.debug("allTables",n),o(n)},function(e){n(e)}):o([])})}function a(o,e){return new Promise(function(e,n){s(o).then(function(e){return Promise.all(e.map(p.deleteSoup))}).then(function(){e()}).catch(function(e){S.error(e),n(e)})})}function i(e){return new Promise(function(c,u){var l={},d=e?"Version Upgrade":"HardReset",f="";new Promise(function(n,o){r.refreshToken(function(e){console.debug("Successfully refreshed access token. Continue reset."),n("ok")},function(e){console.error("Unable to refresh access token. Abort reset: "+JSON.stringify(e)),o(e)})}).then(function(){p.querySoupRecsPromise("appSoup").then(function(e){return e.forEach(function(e){l[e.Name]=e.CurrentValue}),console.info("appSoupRecs",JSON.stringify(l)),a(null)}).then(function(){f=h(l),console.log("resetURL",f);var n="";console.debug("deletedSoups OK");var e,o,t="localhost:3030"==window.location.host?"codeflow":"undefined"!=typeof mockStore?navigator.appVersion.includes("Electron")?"desktop":"platform":"device";if("codeflow"==t&&(e=localStorage.getItem("forceOAuth"),o=localStorage.getItem("appSoup")),localStorage.clear(),"codeflow"==t)localStorage.setItem("forceOAuth",e),localStorage.setItem("appSoup",o),n=window.location.protocol+"//"+window.location.host+"/www",c("ok");else if("platform"==t)n=window.location.href.substr(0,window.location.href.indexOf("#"));else{var r,s="";if(navigator&&navigator.connection&&(s=navigator.connection.type),window.device&&(r=window.device),navigator.appVersion.includes("Electron")){r=ipcRenderer.sendSync("request-device-info",""),s="wifi";var a="landscape"}var i=i||a;n=f+"?deviceUuid="+r.uuid+"&deviceName="+r.name+"&deviceCordova="+r.cordova+"&deviceVersion="+r.version+"&deviceModel="+r.model+"&buildName="+l.buildName+"&buildVersion="+l.buildVersion+"&buildOS="+l.buildOS+"&knownAud="+l.audId+"&currentDv="+l.dynVersionNumber+"&orientation="+i+"&viewportWidth="+window.innerWidth+"&viewportHeight="+window.innerHeight+"&sessionType="+d+"&connType="+s+"&loginUrl="+l.loginUrl+"&millsFromEpoch="+(new Date).getTime()}m.updateNewValueInAppSoup("buildStatus","Resetting").then(function(){console.info("AppSoup Updated for reset"),p.deleteSoup("syncLib_system_data").then(function(e){console.log("Redirecting to: "+n);try{window.location.href=n}catch(e){S.errorAndDispatch("error on redirect",e),u(e)}c()}).catch(function(e){S.errorAndDispatch(e)}),c()}).catch(function(e){S.errorAndDispatch(e),u(e)})}).catch(function(e){S.errorAndDispatch(e),u(e)})}).catch(function(e){S.error("Tokens are bad, testRefreshAccessToken rejected with: "+JSON.stringify(e)),window.history.go(-(history.length-1)),navigator.appVersion.includes("Electron")||cordova.require("com.salesforce.plugin.sfaccountmanager").logout(),u(e)})})}function h(e){var n,o="/apex/mobilecaddy1__MobileCaddyBootstrap001_mc";switch(e.platAuthUrl){case"i":case"I":n=e.instanceUrl+o;break;case"l":case"L":n=e.loginUrl+o;break;case"":n=void 0;break;default:n=e.platAuthUrl}return n||(e.authURLType||(e.authURLType="login"),n="login"==e.authURLType?e.loginUrl+o:e.instanceUrl+o),n}function c(){return new Promise(function(n,o){p.queryMobileTable("appSoup","Name","dynVersionNumber").then(function(e){void 0!==e[0].NewValue&&e[0].NewValue!=e[0].CurrentValue?n(!0):n(!1)}).catch(function(e){S.error(e),o(e)})})}o.exports={checkForMigrateToInfo:function(e){return checkForMigrateToInfo(e)},clearSoups:function(e,n){return a(e)},getSoupsToClear:function(e,n){return s(e)},hardReset:function(){return i()},upgradeAvailable:function(){return c()},upgradeIfAvailable:function(){return new Promise(function(n,o){c().then(function(e){if(e&&t)return i(!0);e?devUtils.dirtyTables().then(function(e){0<e.length?n(!1):r.getRTSPendingconnSess(function(e){if(null==e)return i(!0);n(!1)},function(e){n(!1)})}).catch(function(e){S.error(e),o(e)}):n(!1)}).catch(function(e){S.error(e),o(e)})});var t},_getBootstrapUrl:function(e){return h(e)}}}),s("mobileCaddy/logger",function(e,n,o){cordova.require("com.salesforce.plugin.smartstore");var a=e("mobileCaddy/smartStoreUtils"),u=0,l=1,d=2,t=3,r=4;function f(r,s){return new Promise(function(n,o){if(1==s.length&&(s=s[0]),"object"==(void 0===s?"undefined":_typeof(s))&&(s=JSON.stringify(s)),"number"!=typeof s&&"boolean"!=typeof s||(s=s.toString()),"string"==typeof s){r==u&&localStorage.setItem("lastErrorLog",s.substring(0,1024));var e={mobilecaddy1__Error_Text__c:s.substring(0,1024),SystemModstamp:(new Date).getTime()},t=localStorage.getItem("appSoup-audId");e.mobilecaddy1__Application_User_Device__c=t,e.mobilecaddy1__Log_Type__c="D"+r.toString(),a.insertRecords("Mobile_Log__mc",[e],function(e){n()},function(e){o(e)})}else logger.error("Trying to log unsupported type",void 0===s?"undefined":_typeof(s)),o("Trying to log unsupported type"+(void 0===s?"undefined":_typeof(s)))})}function s(e,n,o,t){var r=localStorage.getItem("logLevel");if(n<=(r=void 0===r?0:r)){var s="";if(0<n){var a=t.stack.split("\n")[4];if(void 0!==a){var i=a.indexOf("at ");s=a.slice(i+2,a.length)}}var c=o[0];switch(n){case u:o[0]&&o[0].stack?c=o[0].message+", STACK:"+o[0].stack:o[1]&&o[1].stack?c+="\n"+o[1].message+", STACK:"+o[1].stack:c=o,f(n,c),console.error.apply(console,o);break;case l:l<=r&&(f(n,o),console.log.apply(console,o),console.log(s));break;default:d<=r&&(f(n,o),console.log.apply(console,o),console.log(s))}e&&(console.info("Dispatching error"),"undefined"!=typeof LOCAL_DEV&&LOCAL_DEV&&alert(c+"\n\nSee dev console for more information"))}}function i(){try{throw Error("")}catch(e){return e}}o.exports={debug:function(e){return s(!1,r,arguments,i())},error:function(e){return s(!1,u,arguments)},errorAndDispatch:function(e){return s(!0,u,arguments)},info:function(e){return s(!1,t,arguments,i())},log:function(e){return s(!1,d,arguments,i())},warn:function(e){return s(!1,l,arguments,i())}}}),s("mobileCaddy/devUtils",function(e,n,o){var p=e("mobileCaddy/smartStoreUtils"),m=e("mobileCaddy/logger"),S=cordova.require("com.salesforce.plugin.smartstore"),t=e("mobileCaddy/appDataUtils"),h=e("mobileCaddy/vsnUtils"),l=e("mobileCaddy/syncRefresh"),r=!!window.USE_FORCETK,a=1,d=2,f=3,g=4,y=5,b=6,C=8,i=99,R=100400,E=100700,v=101e3,c=101100,u=101200,s=101300,T=["syncLib_system_data","appSoup","cacheSoup","recsToSync","SnapShot_Connection_Session__mc"],I=["autonumber","CreatedById","CreatedDate","IsDeleted","IsClosed","IsWon","LastModifiedById","LastModifiedDate","LastReferencedDate","mobilecaddy1__MC_Proxy_ID","MC_Proxy_ID","OwnerId","SystemModstamp","Id","dirtyFlag"];function N(a){var i="Analytics";return new Promise(function(r,n){var e=new Date,s=new Date(e.getFullYear(),e.getMonth(),e.getDate(),0,0,0,0).valueOf();new Promise(function(n,o){S.soupExists("Analytics",function(e){e?n():S.registerSoup("Analytics",[{path:"Name",type:"integer"},{path:"Data",type:"string"}],function(e){n()},function(e){o(e)})},function(e){m.error(e),o(e)})}).then(function(){return i=s,new Promise(function(n,s){var a="";t.getCurrentValueFromAppSoup("audId").then(function(e){return a=e,p.querySoupRecsPromise("Analytics")}).then(function(e){var o=[],t=[],r=[];e.forEach(function(e){if(e.Name==i)o.push(e);else{var n={Name:e.Name.toString(),SystemModstamp:e.Name,mobilecaddy1__Error_Text__c:JSON.parse(e.Data),mobilecaddy1__Application_User_Device__c:a,mobilecaddy1__Log_Type__c:"analytic"};t.push(n),r.push(e._soupEntryId)}}),0!==t.length&&p.insertRecords("Mobile_Log__mc",t,function(e){S.removeFromSoup("Analytics",r,function(e){n(o)},function(e){m.error("Unable to insert analytic recs",e),s(e)})},function(e){m.error("Unable to insert analytic recs",e),s(e)}),n(o)}).catch(function(e){m.error("Error housekeeping Analytics",e),s(e)})});var i}).then(function(e){var n={};if(0===e.length){n[a]=1;var o={Name:s,Data:JSON.stringify(n)};r(n[a]),S.upsertSoupEntries(i,[o],function(e){},function(e){m.error("Unable to insert analytic recs",e)})}else{var t=e[0];(n=JSON.parse(t.Data))[a]=void 0===n[a]?1:n[a]+1,r(n[a]),t.Data=JSON.stringify(n),S.upsertSoupEntriesWithExternalId(i,[t],"Name",function(e){},function(e){m.error(e)})}}).catch(function(e){m.error("Error in analInc",e),n(e)})})}function P(a,o,i){return console.time("MC-TIMING checkTableAccess "+a),new Promise(function(r,s){var n=function(e,n){var o=0;switch(e){case E:o=1;break;case v:o=4;break;case c:o=7;break;case u:o=10;break;default:o=0}if("Y"==n.charAt(o))console.timeEnd("MC-TIMING checkTableAccess "+a),r(i);else{var t={};t.status=e+f,t.mc_add_status=a,console.timeEnd("MC-TIMING checkTableAccess "+a),s(t)}};-1==T.indexOf(a)?localStorage["meta-tableCRUD-"+a]?n(o,localStorage["meta-tableCRUD-"+a]):p.getTableDefnColumnValue(a,"Application Record CRUD").then(function(e){localStorage["meta-tableCRUD-"+a]=e,n(o,e)}).catch(function(e){console.timeEnd("MC-TIMING checkTableAccess "+a),console.info("Opps -> "+a),s(e)}):(console.timeEnd("MC-TIMING checkTableAccess "+a),r(i))})}function w(){return new Promise(function(n,o){if(!0===r){var e=force.getUserId();n(e)}else D("userId").then(function(e){n(e)}).catch(function(e){m.error("getCurrentUserId",e),o(e)})})}function D(e){return new Promise(function(n,o){t.getCachedCurrentValueFromAppSoup(e).then(function(e){n(e)}).catch(function(e){m.error("getCachedAppSoupValue",e),o(e)})})}function O(n,o,e,t){if("_soupLastModifiedDate"==n)return t;var r=_.findWhere(e,{path:n}),s={};if(void 0===r)return s.status=o+d,s.mc_add_status=n,s;var a=0;switch(o){case E:a=1;break;case v:a=4;break;case c:a=7;break;default:a=0}if("Y"!=r.crud.charAt(a))return s.status=o+f,s;try{return s.value=A(t,r.appColType,r.platColType),s}catch(e){return s.status=o+y,s.mc_add_status=e+"->"+n,s}}function M(t){return console.time("MC-TIMING listMobileTableColumns "+t),new Promise(function(n,o){localStorage["meta-tableDEF-"+t]?(console.timeEnd("MC-TIMING listMobileTableColumns "+t),n(JSON.parse(localStorage["meta-tableDEF-"+t]))):p.listMobileTableColumns(t,p.FULL,function(e){localStorage["meta-tableDEF-"+t]=JSON.stringify(e),console.timeEnd("MC-TIMING listMobileTableColumns "+t),n(e)},function(e){console.timeEnd("MC-TIMING listMobileTableColumns "+t),o(e)})})}function U(e,n,o){switch(o){case"checkbox":case"Deleted":return"true"===String(e);case"CreatedDate":case"date":case"datetime":case"LastActivtyDate":case"LastModifiedDate":case"LastReferencedDate":case"LastViewedDate":case"SystemModstamp":return null!==e?new Date(e):e;default:return e}}function A(e,n,o){switch(o){case"autonumber":throw"invalid_autonumber";case"checkbox":case"Deleted":if("boolean"==typeof e||"true"===e||"false"===e)return String(e);throw"invalid_boolean";case"date":if(e instanceof Date)return e.setUTCHours(0),e.setUTCMinutes(0),e.setUTCSeconds(0),e.setUTCMilliseconds(0),e.valueOf();if(null===e)return null;throw"invalid_date";case"datetime":if(e instanceof Date)return e.valueOf();if(null===e)return null;throw"invalid_datetime";case"email":if(function(e){if(0===e.length)return!0;var n=e.indexOf("@"),o=e.lastIndexOf(".");return!(n<1||o<n+2||o+2>=e.length)}(e))return e;throw"invalid_email";default:switch(n){case"jsString":if("string"==typeof e)return e;if("number"==typeof e)return e.toString();throw"invalid_string";case"jsNumber":if("number"==typeof e||null===e)return e;throw"invalid_number";default:return e}}}function L(r,s){return console.time("MC-TIMING tableExists "+r),new Promise(function(n,o){var t={};localStorage["meta-tableCRUD-"+r]?(console.timeEnd("MC-TIMING tableExists "+r),n()):p.listMobileTables(p.ALPHA,function(e){0<=e.concat(T).indexOf(r)?(console.timeEnd("MC-TIMING tableExists "+r),n()):(t.status=s+a,t.mc_add_status=r,console.timeEnd("MC-TIMING tableExists "+r),o(t))},function(e){t.status=s+i,t.mc_add_status="Unkonwn error "+e,console.timeEnd("MC-TIMING tableExists "+r),o(t)})})}function V(n,c,u,o,l){return new Promise(function(s,e){var a={},i={};a.status=u,x().then(function(e){return e[n]&&(i=_.invert(e[n])),w()}).then(function(r){o.forEach(function(o){if(delete o._soupEntryId,delete o.$HashKey,o.RecordTypeName){if(o.RecordTypeId=i[o.RecordTypeName],_.isEmpty(i))return a.status=u+d,a.mc_add_status=o.RecordTypeName,s(a);if(!o.RecordTypeId)return a.status=u+C,a.mc_add_status=o.RecordTypeName,s(a);delete o.RecordTypeName}for(var e in o)if(o.hasOwnProperty(e)&&e!=c){var n=O(e,u,l,o[e]);if(n.status==u+d){a.status=n.status,a.mc_add_status=e;break}if(n.status==u+y){a.status=n.status,a.mc_add_status=e;break}if(n.status==u+f){a.status=n.status,a.mc_add_status=e;break}if(u==E&&0<=I.indexOf(e)){a.status=u+b,a.mc_add_status=e;break}o[e]=n.value}if(a.status!=u+d&&a.status!=u+y&&a.status!=u+b){var t=(new Date).getTime();u==E&&(o.CreatedById=r,o.CreatedDate=t),o.SystemModstamp=t,o.LastModifiedDate=t,o.LastModifiedById=r,o.IsDeleted="false",l.forEach(function(e){if(u==E){var n=e.crud.charAt(1);I.indexOf(e.path)<0&&"false"==e.nillable&&"Y"==n?_.has(o,e.path)||(a.status=u+g,a.mc_add_status=e.path):("IsClosed"==e.path&&(o.IsClosed="false"),"IsWon"==e.path&&(o.IsWon="false"))}""!==e.proxyRefField&&void 0!==o[e.path]&&18<o[e.path].length&&(o[e.proxyRefField]=o[e.path])})}}),a.records=o,s(a)},function(e){m.error("validateRecords",e)})})}function x(){return new Promise(function(n,o){localStorage.getItem("lsDotsRecordTypes")?n(JSON.parse(localStorage.getItem("lsDotsRecordTypes"))):p.querySoupRecords("dotsRecordTypes",function(e){console.log("querySoupRecords dotsRecordTypes",e);var o={};e.forEach(function(e){var n={};JSON.parse(e.Data).forEach(function(e){n[e.recTypeId]=e.recTypeName}),o[e.Table]=n}),localStorage.setItem("lsDotsRecordTypes",JSON.stringify(o)),n(o)},function(e){m.error("Error returned from upsert, message =  "+e),o(e)})})}function F(r,s,a){var i,c={};return new Promise(function(o,t){0<s.length?L(r,u).then(function(){return M(r)}).then(function(e){return P(r,u,e)}).then(function(t){return new Promise(function(n,o){var e=O(a,u,t);e.status!=u+d?V(r,a,u,s,t).then(function(e){e.status==u?n(e.records):(o(e),m.error(e))}):(o(e),m.error(e))})}).then(function(e){return p.queryMobileTable(r,a,s[0][a])}).then(function(e){if(0===e.length)c.status=u+g,m.warn("deleteRecord no record found",r),c.mc_add_status="no record found",t(c);else{if(!(e[0].Id.length<19))return i=e,p.querySoupRecsPromise("recsToSync");c.status=u+f,m.warn("deleteRecord Cannot delete synced records"),c.mc_add_status="Cannot delete synced records",t(c)}}).then(function(e){console.debug("tableName",r),console.debug("recsToDelete",i),console.debug("rts recs",e);var n=e.reduce(function(e,n){return n.Mobile_Table_Name==r&&_.findWhere(i,{_soupEntryId:n.SOUP_Record_Id})&&e.push({_soupEntryId:n._soupEntryId}),e},[]);console.debug("rtsRecSoupIds",n),p.deleteRecordsFromSoup(i,r,function(){p.deleteRecordsFromSoup(n,"recsToSync",function(){c.status=u,c.records=i,o(c)},function(e){t(e)})},function(e){t(e)})}).catch(function(e){t(e)}):(c.status=u,m.warn("deleteRecord No records supplied"),c.mc_add_status="No records supplied",c.records=[],o(c))})}function k(){return new Promise(function(t,n){K("recsToSync").then(function(e){var n=[],o=[];e.records.forEach(function(e){"Connection_Session__mc"!=e.Mobile_Table_Name&&void 0===n[e.Mobile_Table_Name]&&(n[e.Mobile_Table_Name]=!0,o.push(e.Mobile_Table_Name))}),t(o)}).catch(function(e){m.error(e),n(e)})})}function J(r,s){return new Promise(function(t,n){0<r.length&&-1==T.indexOf(s)?x().then(function(e){if(e[s]){var n=e[s],o=r.map(function(e){return e.RecordTypeName=n[e.RecordTypeId],e.RecordTypeName||m.warn("enrichWithRecordTypeNames",e.RecordTypeId),e});t(o)}else t(r)}).catch(function(e){n(e)}):t(r)})}function q(t,r){var s={};return new Promise(function(n,o){L(t,E).then(function(){return M(t)}).then(function(e){return P(t,E,e)}).then(function(e){return new Promise(function(n,o){V(t,null,E,r,e).then(function(e){e.status==E?n(e.records):o(e)})})}).then(function(e){p.insertRecords(t,e,function(e){s.status=E,s.records=e,h.upgradeAvailable().then(function(e){s.upgradeAvailable=e,n(s)}).catch(function(e){n(s),m.error(e)})},function(e){o(e),m.error(e)})}).catch(function(e){o(e),m.error(e)})})}function K(s,e){var a={},i="MC-TIMING readRecords "+s;return console.time(i),new Promise(function(t,r){L(s,v).then(function(){return P(s,v)}).then(function(){return M(s)}).then(function(o){p.querySoupRecords(s,function(n){a.status=v,0<n.length?-1==T.indexOf(s)?p.getTableDefnColumnValue(s,"Last Refresh Date/Time").then(function(e){return j(s,n,o,e,a)}).then(function(e){console.timeEnd(i),t(e)}).catch(function(e){r(e),m.error(e)}):j(s,n,o,null,a).then(function(e){console.timeEnd(i),t(e)}):(a.records=[],h.upgradeAvailable().then(function(e){a.upgradeAvailable=e,console.timeEnd(i),t(a)}).catch(function(e){console.timeEnd(i),t(a),m.error(e)}))},function(e){console.timeEnd(i),r(e),m.error(e)})},function(e){console.timeEnd(i),r(e),m.error(e)})})}function j(o,t,r,s,a){return new Promise(function(n,e){t.forEach(function(e){for(var n in e){var o=_.findWhere(r,{path:n});void 0!==o&&(e[n]=U(e[n],o.appColType,o.platColType),"LastModifiedDate"==n&&(e.dirtyFlag=H(e[n],s)))}}),a.records=t.filter(function(e){return"object"==(void 0===e?"undefined":_typeof(e))}),J(a.records,o).then(function(e){return a.records=e,h.upgradeAvailable()}).then(function(e){a.upgradeAvailable=e,n(a)}).catch(function(e){n(a),m.error(e)})})}function B(d,f){return new Promise(function(t,n){var r,s,a,u,l,i={},e=/FROM\s+\{(\S*)\}/gi.exec(d),o=f||1e3,c=e[1];(u=c,l=d,new Promise(function(n,e){var o=!0,t=l.match(/SELECT\s+(.*)\s+FROM/i);"*"!==t[1]&&(o=!1);var r=l.match(/\s+FROM\s+{(.*)}\s+WHERE (.* = .*)/i);if(console.debug("m",r),null!==r&&null!==r[1]){var s=l,a=r[2].split("AND"),i={},c="";a.forEach(function(e){var n=e.match(/{(.*):(.*)}\s+=\s+(.*)/i),o=n[2];c=n[3].split("'")[1],i[o]=c}),void 0!==i.Id&&18<i.Id.length?p.getProxyFieldName(u).then(function(e){console.log("proxyFieldName",e),s=s.replace("Id} =",e+"} ="),n([s,o])}):n([s,o])}else n([l,o])})).then(function(e){var n=e[0];return a=e[1],console.debug("smartSql2",n,a),r=S.buildSmartQuerySpec(n,o),console.debug("querySpec",r),s="MC-TIMING smartRead "+c,console.time(s),L(c,v)}).then(function(){return P(c,v)}).then(function(){return M(c)}).then(function(o){p.smartQuerySoupRecordsWithQuerySpec(r,function(n){i.status=v,0<n.length?-1==T.indexOf(c)&&a?p.getTableDefnColumnValue(c,"Last Refresh Date/Time").then(function(e){return W(c,n,o,e,i)}).then(function(e){console.timeEnd(s),t(e)}):W(c,n,o,null,i).then(function(e){console.timeEnd(s),t(e)}):(i.records=[],h.upgradeAvailable().then(function(e){i.upgradeAvailable=e,console.timeEnd(s),t(i)}).catch(function(e){console.timeEnd(s),t(i),m.error(e)}))},function(){n()})},function(e){console.timeEnd(s),n(e),m.error(e)})})}function W(o,t,a,i,c){return new Promise(function(n,e){var r=[],s=!0;t.forEach(function(e){var n;if("object"==_typeof(e[1]))for(var o in n=e[1]){var t=_.findWhere(a,{path:o});void 0!==t&&(n[o]=U(n[o],t.appColType,t.platColType),"LastModifiedDate"==o&&(e[1].dirtyFlag=H(e[1][o],i)))}else n=e,s=!1;r.push(n)}),c.records=r.filter(function(e){return"object"==(void 0===e?"undefined":_typeof(e))}),s?J(c.records,o).then(function(e){return c.records=e,h.upgradeAvailable()}).then(function(e){c.upgradeAvailable=e,n(c)}).catch(function(e){n(c),m.error(e)}):h.upgradeAvailable().then(function(e){c.upgradeAvailable=e,n(c)}).catch(function(e){n(c),m.error(e)})})}function H(e,n){return n&&"null"!=n||(n=0),e.valueOf()>n}function Y(o,a){return console.time("initialSync"),new Promise(function(r,s){if(0===o.length)r({status:R+g});else{var n={};l.heartBeat(function(e){if(console.log("heartbeat call gave "+e.status),e.status==l.HEARTBEAT_OK||e.status==l.HEARTBEAT_NOT_DEVICE||e.status==l.HEARTBEAT_REFRESHED_OK){var t=[];console.debug("tableNames",JSON.stringify(o)),k().then(function(e){return console.debug("dirtyTableNames",e),e.forEach(function(e){dirtyIndex=o.indexOf(e),-1<dirtyIndex&&(t.push({table:e,status:SYNC_NOK,mc_add_status:"Dirty records"}),o.splice(dirtyIndex,1))}),console.debug("tableNames",o),console.debug("resArr",t),function s(a,i,c,u){return new Promise(function(o,t){c||(c=[]),u||(u=1);var r;console.log("attemptDoInitialSync",a,c,u),function(e,o){Promise.resolve();var t=[];return e.reduce(function(e,n){return e.then(function(e){return e&&e[e.length-1].status!=SYNC_OK?Promise.resolve():(o&&o({status:0,table:n}),s=n,new Promise(function(n,o){var t=function(e){console.debug("innerProcessRefreshTablePromise res",e),n(e)},r={table:s};l.p2mRefreshTable(s,0,!1,1,1,null,function(e){console.debug("refreshStatusObject",e),e.status==l.P2M_REFRESH_OK?r.status=R:(r.status=e.status,r.mc_add_status=e.mc_add_status),t(r)},function(e){m.error("innerProcessRefreshTablePromise error",e),o(e)})}));var s}).then(function(e){return o&&o(e),t.push(e),t}).catch(function(e){m.errorAndDispatch(e)})},Promise.resolve())}(a,i).then(function(e){if(console.debug("doInitialSync res",e),e.forEach(function(e,n){e&&(c.push(e),e.status!=SYNC_OK&&void 0===r&&(r=n))}),console.debug("Promise.all successAccum",c),console.timeEnd("initialSync"),void 0!==r)if(u<3){var n=a.splice(r,a.length-r);s(n,i,c,u+1).then(function(e){o(e)}).catch(function(e){t(e)})}else t(c);else o(c)})})}(o,a)}).then(function(e){console.debug("doInitialSync res",e);var n=t.concat(e).filter(function(e){return e});console.debug("Promise.all resArrFinal",n),console.timeEnd("initialSync"),r(n);var o={mobilecaddy1__Mobile_Process_Status__c:""};G().then(function(e){l.maybeSyncConnSess(o,function(){console.log("success return from maybeSyncConnSess")},function(e){s(e),m.error(e)})})}).catch(function(e){if(Array.isArray(e)){var o=t.concat(e).filter(function(e){return e});console.debug("Promise.all resArrFinal",o),console.timeEnd("initialSync"),m.error("InitialSync Failed"),Q("Mobile_Log__mc").then(function(e){var n={mobilecaddy1__Mobile_Process_Status__c:""};G().then(function(e){l.maybeSyncConnSess(n,function(){console.log("success return from maybeSyncConnSess"),Q("Mobile_Log__mc"),s(o)},function(e){s(e),m.error(e)})})}).catch(function(e){m.error("Failed sending Mobile Logs"),s(e)}),s(o)}else s(e),m.error(e)})}else n.status=SYNC_NOK,n.mc_add_status=e.status,r(n),100101==n.mc_add_status||100102==n.mc_add_status?m.error(n):m.log(n)},function(e){m.error(e),n.status=SYNC_NOK,r(n)})}})}function G(){return new Promise(function(o,n){var e="SELECT * FROM {Connection_Session__mc} WHERE {Connection_Session__mc:mobilecaddy1__Mobile_Process_Status__c} = 'P2M RE Exception/Timeout'";console.log("setinitialSyncFailCSStatus soql",e);var t=S.buildSmartQuerySpec(e,100);p.smartQuerySoupRecordsWithQuerySpec(t,function(e){console.log("recs",JSON.stringify(e));var n=e.map(function(e){return e[1].mobilecaddy1__Mobile_Process_Status__c="P2M InitialSync Faliure",e[1]});S.upsertSoupEntries("Connection_Session__mc",n,function(e){console.log("setinitialSyncFailCSStatus update OK",e);var n=e.map(function(e){return{Id:e.Id,SystemModstamp:e.SystemModstamp-1,mobilecaddy1__Session_Type__c:null,mobilecaddy1__Mobile_Process_Status__c:null,mobilecaddy1__Session_Created_Location_Error__c:null,mobilecaddy1__MC_Proxy_ID__c:null}});S.upsertSoupEntries("SnapShot_Connection_Session__mc",n,function(e){console.log("setinitialSyncFailCSStatus update OK",e);var n=e.map(function(e){return{Mobile_Table_Name:"Connection_Session__mc",CRUD_Operation:"Insert",SOUP_Record_Id:e._soupEntryId,Id:e.Id,LastModifiedDateTime:e.SystemModstamp}});S.upsertSoupEntries("recsToSync",n,function(){o()},function(e){m.error(e)})},function(e){m.error(e)})},function(e){m.error(e)}),o()},function(e){m.error(e),n(e)})})}function Q(e,t,r,s,a,i){return new Promise(function(n,o){console.time("devUtils.syncMobileTable"),L(e,R).then(function(){return l.syncMobileTable(e,t,r,s,a,i)}).then(function(e){console.timeEnd("devUtils.syncMobileTable"),n(e)}).catch(function(e){console.timeEnd("devUtils.syncMobileTable"),o(e)})})}function Z(r,s,a){var t={};return new Promise(function(n,o){0<s.length?L(r,c).then(function(){return M(r)}).then(function(e){return P(r,c,e)}).then(function(t){return new Promise(function(n,o){var e=O(a,c,t);e.status!=c+d?V(r,a,c,s,t).then(function(e){e.status==c?n(e.records):o(e)}):o(e)})}).then(function(e){p.updateRecordsWithExternalId(r,e,a,function(e){t.status=c,t.records=e,h.upgradeAvailable().then(function(e){t.upgradeAvailable=e,n(t)}).catch(function(e){n(t)})},function(e){o(e),m.error(e)})},function(e){o(e),m.error(e)}):(t.status=c,t.mc_add_status="No records supplied",t.records=[],n(t),m.warn(t))})}o.exports={SYNC_OK:R,SYNC_NOK:100402,SYNC_ALREADY_IN_PROGRESS:R+98,SYNC_UNKONWN_TABLE:R+a,SYNC_MANDATORY_MISSING:R+g,DELETE_RECS_OK:u,DELETE_RECS_UNKONWN_TABLE:u+a,DELETE_RECS_UNKONWN_FIELD:u+d,DELETE_RECS_ACCESS_DENIED:u+f,DELETE_RECS_MANDATORY_MISSING:u+g,INSERT_RECS_OK:E,INSERT_RECS_UNKONWN_TABLE:E+a,INSERT_RECS_UNKONWN_FIELD:E+d,INSERT_RECS_ACCESS_DENIED:E+f,INSERT_RECS_MANDATORY_MISSING:E+g,INSERT_RECS_DATATYPE_MISMATCH:E+y,INSERT_RECS_PROTECTED_FIELD:E+b,INSERT_RECS_UNKNOWN_RECORD_TYPE:E+C,READ_RECS_OK:v,READ_RECS_UNKONWN_TABLE:v+a,READ_RECS_ACCESS_DENIED:v+f,UPDATE_RECS_OK:c,UPDATE_RECS_UNKONWN_TABLE:c+a,UPDATE_RECS_UNKONWN_FIELD:c+d,UPDATE_RECS_ACCESS_DENIED:c+f,UPDATE_RECS_DATATYPE_MISMATCH:c+y,UPDATE_RECS_UNKNOWN_ID:c+7,UPDATE_RECS_UNKNOWN_RECORD_TYPE:c+C,GET_REC_TYPES_UNKONWN_TABLE:s+a,analInc:function(e){return N(e)},deleteRecord:function(e,n,o){return F(e,[n],o)},dirtyTables:function(){return k()},syncMobileTable:function(e,n,o,t,r){return Q(e,n,o,t,r)},initialSync:function(e){return Y(e)},getCurrentUserId:function(){return w()},getCurrentUserName:function(){return t="",new Promise(function(n,o){D("userFirstName").then(function(e){return t=e,D("userLastName")}).then(function(e){n(t+" "+e)}).catch(function(e){m.error("getCurrentUserName",e),o(e)})});var t},getUserLocale:function(){return D("userLocale")},getCachedAppSoupValue:function(e){return D(e)},getRecordTypes:function(e){return t=e,new Promise(function(n,o){L(t,s).then(function(){return x()}).then(function(e){n(e[t])}).catch(function(e){o(e)})});var t},insertRecord:function(e,n){return q(e,[n])},insertRecords:function(e,n){return q(e,n)},logout:function(){return console.log("Logout requested"),localStorage.clear(),void(navigator.appVersion.includes("Electron")?ipcRenderer.sendSync("logout",""):cordova.require("com.salesforce.plugin.sfaccountmanager").logout())},readRecords:function(e,n){return console.debug("readRecords",e),K(e)},smartSql:function(e){return console.debug("smartSql",e),B(e)},updateRecord:function(e,n,o){return Z(e,[n],o)},updateRecords:function(e,n,o){return Z(e,n,o)},maybeReadTransformType:function(e,n,o){return U(e,0,o)},maybeWriteTransformType:function(e,n,o){return A(e,n,o)}}}),window.mobileCaddy=r("mobileCaddy")}();