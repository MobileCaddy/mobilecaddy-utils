/* mobilecaddy-utils - v2.0.0 - Bundle Time: 2018-04-06 13:52:50 */
/* git info: "2018-04-06 13:49:20 +0100": 7877a293eee62da2c63a04332bb68746c8312d48 (v2) */
/* Copyright 2018 MobileCaddy Ltd */

"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.smartQuerySoupRecordsWithQuerySpec=exports.querySoupRecordsWithQuerySpec=exports.querySoupRecsPromise=exports.querySoupRecords=exports.queryMobileTableWithAnd=exports.queryMobileTable=exports.setTableDefnColumnValue=exports.getTableDefnColumnValue=exports.getSysDataRowMapColHeadings=exports.getSysDataRowMapColHeading=exports.listMobileTableColumns=exports.listMobileTables=exports.getProxyFieldName=exports.updateRecordsWithExternalId=exports.insertRecords=exports.deleteRecordsFromSoup=exports.deleteRecordsForExternalId=exports.buildMobileTables=exports.FULL=exports.BUILD=exports.ALPHA=void 0;var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_constants=require("./constants"),mobileCaddy=_interopRequireWildcard(_constants),_appDataUtils=require("./appDataUtils"),appDataUtils=_interopRequireWildcard(_appDataUtils);function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var o={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(o[t]=e[t]);return o.default=e,o}var smartstore=cordova.require("com.salesforce.plugin.smartstore");function deleteRecordsForExternalId(e,o,t,n,r){if(!n&&!r)return new Promise(function(n,r){if(0===o.length)n();else{var i="";"object"==_typeof(o[0])?o.forEach(function(e,o){i+=0===o?"'"+e[t]+"'":",'"+e[t]+"'"}):o.forEach(function(e,o){i+=0===o?"'"+e+"'":", '"+e+"'"});var s="SELECT * FROM {"+e+"} WHERE {"+e+":"+t+"} IN ("+i+")";console.log("deleteRecordsForExternalId soql",s),querySpec=smartstore.buildSmartQuerySpec(s),smartQuerySoupRecordsWithQuerySpec(querySpec,function(o){console.log("recs",o);var t=o.map(function(e){return e[0]});smartstore.removeFromSoup(e,t,function(e){n(e)},function(e){r(e)})},function(e){r(e)})}});if(0===o.length)n();else{var i=[];o.forEach(function(e){i.push(e[t])}),querySoupRecords(e,function(o){var s=[];o.forEach(function(e){-1!=i.indexOf(e[t])&&s.push(e._soupEntryId)}),0===s.length?n():smartstore.removeFromSoup(e,s,n,r)},r)}}function collectRecsFromCursor(e,o,t){var n=[];function r(e){o(n)}function i(e){if(console.error("onCursorClosedError",e),console.error("onCursorClosedError",e.stack),!t)throw e;t(e)}!function e(o){o.currentPageOrderedEntries.forEach(function(e){n.push(e)}),o.currentPageIndex<o.totalPages-1?cordova.require("com.salesforce.plugin.smartstore").moveCursorToNextPage(o,e):cordova.require("com.salesforce.plugin.smartstore").closeCursor(o,r,i)}(e)}function getSoupDefinitionRows(e,o,t){querySoupRecordsWithQuerySpec("syncLib_system_data",smartstore.buildExactQuerySpec("Name",e,mobileCaddy.QUERY_BUFFER_SIZE),function(e){console.log("soup definition rows success callback with rec count = "+e.length);var t=[];e.forEach(function(e){console.log("processing record = "),e.Type!=mobileCaddy.STANDING_DATA_OBJECT&&e.Type!=mobileCaddy.DYNAMIC_DATA_OBJECT?(console.log("Record Match"),t.push(e)):console.log("Record does not match")}),o(t)},t)}function getSoupObjectDefinition(e,o,t){querySoupRecordsWithQuerySpec("syncLib_system_data",cordova.require("com.salesforce.plugin.smartstore").buildExactQuerySpec("Name",e,mobileCaddy.QUERY_BUFFER_SIZE),function(e){for(var t,n=0;n<e.length;n++)if(e[n].Type==mobileCaddy.STANDING_DATA_OBJECT||e[n].Type==mobileCaddy.DYNAMIC_DATA_OBJECT){t=e[n];break}o(t)},t)}function removeSoupDefinitions(e,o,t){querySoupRecordsWithQuerySpec("syncLib_system_data",cordova.require("com.salesforce.plugin.smartstore").buildExactQuerySpec("Name",e,mobileCaddy.QUERY_BUFFER_SIZE),function(e){deleteRecordsFromSoup(e,"syncLib_system_data",function(){console.log("Success delete records from soup, calling callback"),o()},t)},t)}function buildSoupQueryString(e,o,t){console.log("in buildSoupQueryString for soup = "+e),getSoupDefinitionRows(e,function(n){console.log("In getSoupDefinitionRows success callback"),0===n.length?(simpleMessageSL("No soup columns defined for soup "+e),t("No soup columns defined for soup "+e)):getSoupObjectDefinition(e,function(t){console.log("in getSoupObjectDefinition success callback");var r="Select ";n.forEach(function(e){r+=e.Column_Name+","}),r=r.substring(0,r.length-1),o(r+=" From "+e)},t)},t)}function getQueryAndSoupDefinition(e,o,t){console.log("in getQueryAndSoupDefinition");var n=[],r="Select ";e.forEach(function(e){console.log("soup column defn = "),n.push({path:e.Column_Name,type:e.Column_Type}),0!==e.Column_Name.indexOf("_")&&(r+=e.Column_Name+",")}),r=r.substring(0,r.length-1),o(r+=" From "+e[0].Name,n)}function querySoupRecords(e,o,t){var n=smartstore.buildAllQuerySpec("_soupEntryId",null,mobileCaddy.QUERY_BUFFER_SIZE);smartstore.querySoup(e,n,function(e){collectRecsFromCursor(e,function(e){o(e)},t)})}function querySoupRecsPromise(e){return new Promise(function(o,t){querySoupRecords(e,function(e){o(e.filter(function(e){return"object"==(void 0===e?"undefined":_typeof(e))}))},function(e){t(e)})})}function querySoupRecordsWithQuerySpec(e,o,t,n){smartstore.querySoup(e,o,function(o){collectRecsFromCursor(o,function(o){console.log("Passing records back to callback for soup = "+e+" and rec count = "+o.length),t(o)},n)},n)}function smartQuerySoupRecordsWithQuerySpec(e,o,t){console.debug("smartQuerySoupRecordsWithQuerySpec",e),smartstore.runSmartQuery(e,function(e){collectRecsFromCursor(e,function(e){console.log("Passing records back to callback for soup with rec count = "+e.length),o(e)},t)},t)}function queryMobileTable(e,o,t,n,r){if(void 0===n&&void 0===r)return new Promise(function(n,r){var i=smartstore.buildExactQuerySpec(o,t,mobileCaddy.QUERY_BUFFER_SIZE_SL);querySoupRecordsWithQuerySpec(e,i,function(e){n(e)},function(e){r(e)})});var i=smartstore.buildExactQuerySpec(o,t,mobileCaddy.QUERY_BUFFER_SIZE_SL);querySoupRecordsWithQuerySpec(e,i,function(e){n(e)},r)}function queryMobileTableWithAnd(e,o,t,n,r,i,s){querySoupRecordsWithQuerySpec(e,smartstore.buildExactQuerySpec(o,t,mobileCaddy.QUERY_BUFFER_SIZE_SL),function(e){var o=[];e.forEach(function(e){e[n]==r&&o.push(e)}),i(o)},s)}function getDefnRowForTableName(e,o,t){getSysDataRowMapColHeading("Row Mapping PT","Mobile Table Name",function(n){queryMobileTableWithAnd("syncLib_system_data","MC_Var_String_001","Platform Table Definition",n,e,function(t){1!=t.length&&console.error("Should be exactly 1 table defn row for table: "+e+", but we got "+t.length),o(t[0])},t)},t)}function getTableDefnColumnValue(e,o){return new Promise(function(t,n){getDefnRowForTableName(e,function(e){getSysDataRowMapColHeading("Row Mapping PT",o,function(o){t(e[o])},function(e){n(e)})},function(e){n(e)})})}function setTableDefnColumnValue(e,o,t){return new Promise(function(n,r){getDefnRowForTableName(e,function(e){getSysDataRowMapColHeading("Row Mapping PT",o,function(o){e[o]=t,smartstore.upsertSoupEntries("syncLib_system_data",[e],function(){n()},function(e){r(e)})},function(e){r(e)})},function(e){r(e)})})}function getSysDataRowMapColHeading(e,o,t,n){queryMobileTableWithAnd("syncLib_system_data","MC_Var_String_001",e,"MC_Var_String_003",o,function(n){1!=n.length&&(n.forEach(function(e){console.log(e)}),console.error("Must be exactly 1 Row Mapping Record for Sys Data Row Type = "+e+" and Sys Data Row Value = "+o+" found count = "+n.length)),t(n[0].MC_Var_String_004)},n)}function getSysDataRowMapColHeadings(e,o,t,n){querySoupRecordsWithQuerySpec("syncLib_system_data",smartstore.buildExactQuerySpec("MC_Var_String_001",e,mobileCaddy.QUERY_BUFFER_SIZE_SL),function(n){var r=[];o.forEach(function(o){var t=!1;if(n.forEach(function(e){if(e.MC_Var_String_003==o)return r.push(e.MC_Var_String_004),void(t=!0)}),!t)throw"No mapping found for type = "+e+" and value = "+o}),t(r)},n)}var NONE=0,ALPHA_ORDER=1,BUILD_ORDER=2;function listMobileTables(e,o,t){getSysDataRowMapColHeadings("Row Mapping PT",["Mobile Table Name","Build Order"],function(n){var r=n[0],i=n[1];queryMobileTable("syncLib_system_data","MC_Var_String_001","Platform Table Definition",function(t){var n=[];e==BUILD_ORDER?(t.sort(function(e,o){var t=0,n=parseInt(e[i]),r=parseInt(o[i]);return isNaN(n)||isNaN(r)||(t=n-r),t}),t.forEach(function(e){n.push(e[r])}),null!==o&&o(n)):(t.forEach(function(e){n.push(e[r])}),e==ALPHA_ORDER&&n.sort(),null!==o&&o(n))},t)},t)}var LIST=0,BUILD_OBJECT=1,FULL_LIST=2;function listMobileTableColumns(e,o,t,n){getSysDataRowMapColHeadings("Row Mapping TC",["Parent SOUP Name","Table Column Name","Mobile Column Type","Application Field CRUD","META isNillable","Platform Column Type","Device Value Type","Proxy Ref Field Name"],function(n){var r=n[0],i=n[1],s=n[2],a=n[3],u=n[4],l=n[5],c=n[6],p=n[7];queryMobileTableWithAnd("syncLib_system_data","MC_Var_String_001","Platform Table Column",r,e,function(e){var n=[];e.forEach(function(e){o==LIST?n.push(e[i]):o==FULL_LIST?n.push({path:e[i],type:e[s],crud:e[a],nillable:e[u],platColType:e[l],appColType:e[c],proxyRefField:e[p]}):n.push({path:e[i],type:e[s]})}),t(n)},function(e){console.log("Error retrieving column names = "+e)})},n)}function cacheProxyFieldNames(e,o){o.forEach(function(o){o.path.includes("MC_Proxy_ID")&&localStorage.setItem("proxyField-"+e,o.path)})}function buildMobileTables(e,o){console.debug("About to buildMobileTables"),listMobileTables(BUILD_ORDER,function(t){var n=t.length;t.forEach(function(t){listMobileTableColumns(t,BUILD_OBJECT,function(r){console.debug("tableColumnObjectArray -> "+r),smartstore.registerSoup(t,r,function(){console.log("success on register soup "+t),setTableDefnColumnValue(t,"SOUP Built Date/Time",(new Date).getTime()).then(function(){return console.log("success on update of soup build date time"),cacheProxyFieldNames(t,r),getTableDefnColumnValue(t,"Snapshot Data Required")}).then(function(i){"Yes"==i?smartstore.registerSoup("SnapShot_"+t,r,function(){console.log("Success from build of SnapShot_"+t),setTableDefnColumnValue(t,"Snapshot SOUP Built Date/Time",(new Date).getTime()),0===--n&&e()},function(e){console.error("Fail on create of SnapShot_"+t+" "+e),o(e)}):0===--n&&e()}).catch(function(e){o(e)})},o)},function(e){console.error("Fail on create of table"+t+" "+e),o(e)})})},o)}function deleteRecordsFromSoup(e,o,t,n){if(console.log("In delete recs from soup with rec count = "+e.length),0!==e.length){var r=[];e.forEach(function(e){e&&e._soupEntryId&&r.push(e._soupEntryId)}),0!==r.length?smartstore.removeFromSoup(o,r,function(e){console.log("Deleted rec(s) - calling callback"),t(e)},n):t()}else t()}function insertRecords(e,o,t,n){console.log("in insert records"),console.log("mobile table name = "+e),console.log("records = "+JSON.stringify(o)),console.log("records size = "+o.length),smartstore.upsertSoupEntries(e,o,function(o){console.log("back from upsert soup with records = "+JSON.stringify(o));var r=(new Date).getTime();addProxyIds(e,o,r,function(o){console.log("back with proxy ids = "+JSON.stringify(o));var i=[];o.forEach(function(o){var t={Mobile_Table_Name:e,CRUD_Operation:"Insert",SOUP_Record_Id:o._soupEntryId,Id:o.Id,LastModifiedDateTime:r};i.push(t)}),smartstore.upsertSoupEntriesWithExternalId("recsToSync",i,"Id",t,n)},n)},n)}function addProxyIds(e,o,t,n,r){var i;getProxyFieldName(e).then(function(e){return i=e,appDataUtils.getCachedCurrentValueFromAppSoup("audId")}).then(function(s){o.forEach(function(o){var n="PROXY%"+e+"%"+t+"%"+o._soupEntryId+"%"+s;o.Id=n,o[i]=n}),smartstore.upsertSoupEntries(e,o,function(e){n(e)},r)}).catch(function(e){r(e)})}function fillOutRecords(e,o,t){var n=o.length,r=0;return new Promise(function(s,a){getProxyFieldName(e).then(function(u){o.forEach(function(l){queryMobileTable(e,t,l[t]).then(function(c){if(c.length>0){var p=c[0];for(var d in l)p[d]=l[d];o[i]=p,++r>=n&&s(o)}else"Id"==t&&l.Id.length>18?queryMobileTable(e,u,l.Id).then(function(e){if(e.length>0){var t=e[0];for(var u in l)"Id"!=u&&(t[u]=l[u]);o[i]=t,++r>=n&&s(o)}else a({status:101107})}):a({status:101107})}).catch(function(e){a(e)})})}).catch(function(e){a(e)})})}function updateRecordsWithExternalId(e,o,t,n,r){fillOutRecords(e,o,t).then(function(o){smartstore.upsertSoupEntriesWithExternalId(e,o,t,function(o){queryMobileTable("recsToSync","Mobile_Table_Name",e,function(t){var i=[];o.forEach(function(o){var n,r;if(t.forEach(function(e){e.Id!=o.Id||(n=e)}),void 0!==n)if(console.log("existingRecToSync",n),n.Current_Connection_Session&&void 0!==n.Current_Connection_Session)switch(n.CRUD_Operation){case"Insert":case"InsertUpdate":r="InsertUpdate";break;default:r="UpdateUpdate"}else r=n.CRUD_Operation;else r="Update";var s={Mobile_Table_Name:e,SOUP_Record_Id:o._soupEntryId,Id:o.Id,CRUD_Operation:r,LastModifiedDateTime:o.SystemModstamp};"InsertUpdate"!=r&&"UpdateUpdate"!=r||(s.Current_Connection_Session=n.Current_Connection_Session),i.push(s)}),smartstore.upsertSoupEntriesWithExternalId("recsToSync",i,"Id",n,r)},r)},r)}).catch(function(e){r(e)})}function getProxyFieldName(e){return new Promise(function(o,t){var n=localStorage.getItem("proxyField-"+e);n?o(n):(console.log("getProxyFieldName",e),listMobileTableColumns(e,LIST,function(t){var n=null;t.forEach(function(o){o.includes("MC_Proxy_ID")&&(n=o,localStorage.setItem("proxyField-"+e,o),console.log("GOT IT ",n))}),o(n)},function(e){console.error("listMobileTableColumns",JSON.stringify(e)),o(null)}))})}var ALPHA=exports.ALPHA=ALPHA_ORDER,BUILD=exports.BUILD=BUILD_ORDER,FULL=exports.FULL=FULL_LIST;exports.buildMobileTables=buildMobileTables,exports.deleteRecordsForExternalId=deleteRecordsForExternalId,exports.deleteRecordsFromSoup=deleteRecordsFromSoup,exports.insertRecords=insertRecords,exports.updateRecordsWithExternalId=updateRecordsWithExternalId,exports.getProxyFieldName=getProxyFieldName,exports.listMobileTables=listMobileTables,exports.listMobileTableColumns=listMobileTableColumns,exports.getSysDataRowMapColHeading=getSysDataRowMapColHeading,exports.getSysDataRowMapColHeadings=getSysDataRowMapColHeadings,exports.getTableDefnColumnValue=getTableDefnColumnValue,exports.setTableDefnColumnValue=setTableDefnColumnValue,exports.queryMobileTable=queryMobileTable,exports.queryMobileTableWithAnd=queryMobileTableWithAnd,exports.querySoupRecords=querySoupRecords,exports.querySoupRecsPromise=querySoupRecsPromise,exports.querySoupRecordsWithQuerySpec=querySoupRecordsWithQuerySpec,exports.smartQuerySoupRecordsWithQuerySpec=smartQuerySoupRecordsWithQuerySpec;