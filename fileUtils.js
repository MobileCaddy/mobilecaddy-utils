/* mobilecaddy-utils - v2.0.1 - Bundle Time: 2018-12-10 09:08:57 */
/* git info: "2018-12-07 16:26:19 +0000": d8ff591bd903dccc772626a1bacc1be7a8af2829 (msd-628/p2m-fileUtils) */
/* Copyright 2018 MobileCaddy Ltd */

"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.downloadFiles=downloadFiles,exports.storeFilesInfo=storeFilesInfo,exports.getStorageDirectory=getStorageDirectory,exports.readAsDataURL=readAsDataURL;var appDataUtils=_interopRequireWildcard(require("./appDataUtils")),smartStoreUtils=_interopRequireWildcard(require("./smartStoreUtils")),logger=_interopRequireWildcard(require("./logger")),_=_interopRequireWildcard(require("underscore"));function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)if(Object.prototype.hasOwnProperty.call(e,t)){var o=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,t):{};o.get||o.set?Object.defineProperty(r,t,o):r[t]=e[t]}return r.default=e,r}var storageDirectory,cdvFileURI,smartstore=cordova.require("com.salesforce.plugin.smartstore"),logTag="fileUtils.js",RECORD_FILES_TABLE="File_Library__ap",QUERY_PAGE_SIZE=1e4,CONTENT_VSN_FIELD="SF_Content_Version_Id__c",SYNC_FIELD="Synchronised__c",FILE_TYPE_FIELD="File_Type__c",LOCAL_PATH_FIELD="Local_Path",FILE_PATH_SUFFIX="?asPdf=false&operationContext=CHATTER";function getStorageDirectory(){return(storageDirectory=localStorage.getItem("mcFileStorageDirectory"))||(storageDirectory=cordova.file?cordova.file.documentsDirectory?cordova.file.documentsDirectory:cordova.file.dataDirectory:"CodeFlow",localStorage.setItem("mcFileStorageDirectory",storageDirectory),storageDirectory)}function storeFilesInfo(e){return new Promise(function(r,t){storageDirectory||getStorageDirectory(),console.log(logTag,"storeFilesInfo",e);var o=e,n="",i=(o.map(function(e,r){return n+=0===r?"'"+e.Id+"'":",'"+e.Id+"'",e.Id}),"SELECT {"+RECORD_FILES_TABLE+":Id} FROM {"+RECORD_FILES_TABLE+"} WHERE {"+RECORD_FILES_TABLE+":Id} IN ("+n+")"),a=smartstore.buildSmartQuerySpec(i,QUERY_PAGE_SIZE);smartStoreUtils.smartQuerySoupRecordsWithQuerySpec(a).then(function(e){var r;return r=0!==e.length?o.filter(function(r){return!e[0].includes(r.Id)}):o,smartStoreUtils.upsertSoupEntries(RECORD_FILES_TABLE,r)}).then(function(e){r(e)}).catch(function(e){t(e)})})}function readAsDataURL(e){return new Promise(function(r,t){if(cordova.platformId)if("ios"==cordova.platformId)if(cdvFileURI)r(cdvFileURI+e);else{var o=localStorage.getItem("cdvFileURI");o?r((cdvFileURI=o)+e):window.resolveLocalFileSystemURL(getStorageDirectory(),function(t){cdvFileURI=t.toInternalURL(),localStorage.setItem("cdvFileURI",cdvFileURI),r(cdvFileURI+e)})}else window.resolveLocalFileSystemURL(getStorageDirectory(),function(o){o.getFile(e,{},function(e){var o=new FileReader;o.onloadend=function(){void 0!==o.result||null!==o.result?r(o.result):void 0!==o.error||null!==o.error?t(o.error):t({code:null,message:"READER_ONLOADEND_ERR"})},e.file(function(e){o.readAsDataURL(e)},function(e){console.error(e),t(e)})})});else r("data:image/jpeg;base64,"+localStorage.getItem("MCFILE_"+e))})}function downloadFiles(){return new Promise(function(e,r){var t,o,n;storageDirectory||getStorageDirectory(),getFilesToDownload().then(function(r){r.length>0?(n=r,appDataUtils.getCurrentValueFromAppSoup("accessToken").then(function(e){return t=e||JSON.parse(localStorage.getItem("forceOAuth")).access_token,appDataUtils.getCurrentValueFromAppSoup("instanceUrl")}).then(function(e){return o=e||JSON.parse(localStorage.getItem("forceOAuth")).instance_url+"/",Promise.all(n.map(function(e){return doDownloadFile(e,t,o).then(function(e){return logger.log("resp",e),e})})).then(function(e){return logger.log("accum",e),e})}).then(function(r){logger.log("res1",r),e(r)})):(logger.log("No files to download"),e())}).catch(function(e){r(e)})})}function doDownloadFile(e,r,t){return logger.log(logTag,"doDownloadFile",e),new Promise(function(o,n){getFileIdFromContentVersionId(e[1],r,t).then(function(i){var a=t+"/services/data/v39.0/connect/files/"+i+"/content";if(logger.log(logTag,"urlToDownload",a),i&&i.length>0){var l=new Headers;l.append("Authorization","Bearer "+r),l.append("Content-Type","image/jpeg");var s={method:"GET",headers:l,mode:"cors"},c=new Request(a);fetch(c,s).then(function(r){logger.log(logTag,r),200==r.status?saveFile(e,r):(logger.error("resp.status",r.status),logger.error("resp.statusText",r.statusText),logger.error("resp.type",r.type)),o(r)}).catch(function(e){logger.error("Something went wrong!",e),n(e)})}else o()}).catch(function(e){logger.error(e),n(e)})})}function getFileIdFromContentVersionId(e,r,t){console.log("getFileIdFromContentVersionId",e,r,t);var o=t+"/services/data/v39.0/sobjects/ContentVersion/"+e;return new Promise(function(t,n){if(e&&e.length>0){logger.log(logTag,"urlToDownload",o);var i=new Headers;i.append("Authorization","Bearer "+r),i.append("Content-Type","application/json");var a={method:"GET",headers:i,mode:"cors"},l=new Request(o);fetch(l,a).then(function(e){return logger.log(logTag,e),200==e.status?e.json():(logger.error("resp.status",e.status),logger.error("resp.statusText",e.statusText),logger.error("resp.type",e.type),Promise.reject("Failed to read ContentVersionId object"))}).then(function(e){console.log("json",e),t(e.ContentDocumentId)}).catch(function(e){logger.error("Something went wrong!",e),n(e)})}else t(null)})}function getFilesToDownload(){return new Promise(function(e,r){smartstore.soupExists(RECORD_FILES_TABLE,function(t){if(t){var o="SELECT {"+RECORD_FILES_TABLE+":Id},{"+RECORD_FILES_TABLE+":"+CONTENT_VSN_FIELD+"},{"+RECORD_FILES_TABLE+":"+FILE_TYPE_FIELD+"} FROM {"+RECORD_FILES_TABLE+"} WHERE {"+RECORD_FILES_TABLE+":"+SYNC_FIELD+"} = 0",n=smartstore.buildSmartQuerySpec(o,QUERY_PAGE_SIZE);smartStoreUtils.smartQuerySoupRecordsWithQuerySpec(n).then(function(r){logger.log("Query res",r),r&&r[0]?e(r):e([])}).catch(function(e){r(e)})}else e([])},function(e){logger.error("Failed to check soupExists for "+RECORD_FILES_TABLE),r(e)})})}function saveFile(e,r){"CodeFlow"!=storageDirectory?window.resolveLocalFileSystemURL(storageDirectory,function(t){logger.log("file system open: "+t.name),t.getFile(e[1]+"."+e[2],{create:!0,exclusive:!1},function(t){writeFile(t,r).then(function(r){updateFileRec(e)})})}):r.arrayBuffer().then(function(r){var t=btoa(new Uint8Array(r).reduce(function(e,r){return e+String.fromCharCode(r)},""));localStorage.setItem("MCFILE_"+e[1]+"."+e[2],t),updateFileRec(e)})}function writeFile(e,r){return new Promise(function(t,o){e.createWriter(function(e){e.onwriteend=function(){logger.log("Successful file write..."),t()},e.onerror=function(e){logger.error("Failed file write: "+e.toString()),o()},r.arrayBuffer().then(function(r){e.write(r)})})})}function updateFileRec(e){var r="SELECT * FROM {"+RECORD_FILES_TABLE+"} WHERE {"+RECORD_FILES_TABLE+":Id} = '"+e[0]+"'";logger.log("soql",r);var t=smartstore.buildSmartQuerySpec(r,1);smartStoreUtils.smartQuerySoupRecordsWithQuerySpec(t).then(function(r){var t=r[0][1];logger.log("myRec",t),t[SYNC_FIELD]=1,t[LOCAL_PATH_FIELD]=storageDirectory+e[1]+"."+e[2],smartstore.upsertSoupEntriesWithExternalId(RECORD_FILES_TABLE,[t],"Id",function(e){logger.log("File DB entry updated",e)})}).catch(function(e){logger.error("Error updating "+RECORD_FILES_TABLE+" following file save",e)})}