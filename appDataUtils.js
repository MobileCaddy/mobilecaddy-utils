/* mobilecaddy-utils - v3.0.3 - Bundle Time: 2022-10-04 11:03:58 */
/* git info: "2022-09-15 11:56:26 +0100": 42159b0c7048c699426150415d34fee28682c9ba (v3) */
/* Copyright 2022 MobileCaddy Ltd */

"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getCurrentValueFromAppSoup=getCurrentValueFromAppSoup,exports.getCachedCurrentValueFromAppSoup=getCachedCurrentValueFromAppSoup,exports.getPlatformAppConfig=getPlatformAppConfig,exports.updateNewValueInAppSoup=updateNewValueInAppSoup,exports.upsertNewValueInAppSoup=upsertNewValueInAppSoup,exports.updateCurrentValueInAppSoup=updateCurrentValueInAppSoup,exports.upsertCurrentValueInAppSoup=upsertCurrentValueInAppSoup;var smartstore,smartStoreUtils=_interopRequireWildcard(require("./smartStoreUtils")),mobileCaddy=_interopRequireWildcard(require("./constants"));function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var n in e)if(Object.prototype.hasOwnProperty.call(e,n)){var t=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,n):{};t.get||t.set?Object.defineProperty(r,n,t):r[n]=e[n]}return r.default=e,r}var LOCAL_DEV=!!window.LOCAL_DEV,USE_FORCETK=!!window.USE_FORCETK;function useSdkReq(){return!(!window[mobileCaddy.CONTAINER_VSN_KEY]||!window[mobileCaddy.CONTAINER_VSN_KEY].startsWith("3"))}function getCachedCurrentValueFromAppSoup(e){var r=localStorage.getItem("appSoup-"+e);return new Promise(function(n,t){r?n(r):getCurrentValueFromAppSoup(e).then(function(r){localStorage.setItem("appSoup-"+e,r),n(r)})})}function getCurrentValueFromAppSoup(e){return new Promise(function(r,n){var t=(window.smartstore?window.smartstore:cordova.require("com.salesforce.plugin.smartstore")).buildExactQuerySpec("Name",e,mobileCaddy.QUERY_BUFFER_SIZE);smartStoreUtils.querySoupRecordsWithQuerySpec("appSoup",t,function(e){e[0]?r(e[0].CurrentValue):r(e[0])},function(e){n(e)})})}function updateValueInAppSoup(e,r,n,t){return new Promise(function(u,o){var i=window.smartstore?window.smartstore:cordova.require("com.salesforce.plugin.smartstore"),p=i.buildExactQuerySpec("Name",e,mobileCaddy.QUERY_BUFFER_SIZE);smartStoreUtils.querySoupRecordsWithQuerySpec("appSoup",p,function(p){if(p.length>0)p[0][n]=r,i.upsertSoupEntries("appSoup",p,function(e){u(e)},function(e){o(e)});else if(t){var a={Name:e};a[n]=r,i.upsertSoupEntries("appSoup",[a],function(e){u(e)},function(e){o(e)})}else u()},function(e){o(e)})})}function updateNewValueInAppSoup(e,r){return updateValueInAppSoup(e,r,"NewValue",!1)}function upsertNewValueInAppSoup(e,r){return updateValueInAppSoup(e,r,"NewValue",!0)}function updateCurrentValueInAppSoup(e,r){return updateValueInAppSoup(e,r,"CurrentValue",!1)}function upsertCurrentValueInAppSoup(e,r){return updateValueInAppSoup(e,r,"CurrentValue",!0)}function getPlatformAppConfig(e){return new Promise(function(r,n){getRemoteAppNamespace().then(function(t){null===t||null===t.result?r():getAppSoup(e).then(function(e){var u=function(e,n){if(n.status){var t=[],u="string"==typeof e?JSON.parse(e):e;if(u.dvUpgradeReq)r(u);else{for(var o in u)if(null!==u[o])if("translations"==o){var i=JSON.parse(u[o].replace(/(\r\n|\n|\r|\t)/gm,""));for(var p in i)null!==i[p]&&t.push({Name:"translations-"+p,CurrentValue:i[p]})}else if("string"==typeof u[o]){var a="version"===o?"appConfigVersion":o;t.push({Name:a,CurrentValue:u[o].replace(/(\r\n|\n|\r|\t)/gm,"")})}else t.push({Name:o,CurrentValue:JSON.stringify(u[o])});t.reduce(function(e,r){return e.then(function(e){return upsertCurrentValueInAppSoup(r.Name,r.CurrentValue)})},Promise.resolve()).then(function(e){r(e)}).catch(function(e){})}}else"exception"===n.type&&r()};if(useSdkReq()){var o=e.appConfigVersion?e.appConfigVersion.CurrentValue:"";plugin.mcsdk.request({method:"POST",path:"/services/apexrest/"+t.result+"/getAppConfig001",contentType:"application/json",data:{params:JSON.stringify({currentAppConfigVersion:o,buildVersion:e.buildVersion.CurrentValue,buildName:e.buildName.CurrentValue,dynamicVersion:e.dynVersionNumber.CurrentValue,clientBundleVersion:window.clientBundleVersion,containerBaseBuildVersionw:window[mobileCaddy.CONTAINER_VSN_KEY]})}},function(e){u(e,{status:200})},function(e){r()})}else if(LOCAL_DEV&&!USE_FORCETK){Visualforce.remoting.Manager.invokeAction("GetAppConfiguration001.getAppConfig",e.buildVersion.CurrentValue,e.buildName.CurrentValue,u,{escape:!1,timeout:3e4})}else{var i=e.appConfigVersion?e.appConfigVersion.CurrentValue:"";if(!0!==USE_FORCETK)return fetch("/services/apexrest/"+t.result+"/getAppConfig001",{method:"POST",mode:"cors",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:"Bearer "+e.accessToken.CurrentValue},body:JSON.stringify({params:JSON.stringify({currentAppConfigVersion:i,buildVersion:e.buildVersion.CurrentValue,buildName:e.buildName.CurrentValue,dynamicVersion:e.dynVersionNumber.CurrentValue,clientBundleVersion:window.clientBundleVersion})})}).then(function(e){return 200===e.status?e.json():Promise.reject(e)}).then(function(e){u(e,{status:"200"})}).catch(function(e){n(e)});force.request({method:"POST",path:"/services/apexrest/"+t.result+"/getAppConfig001",contentType:"application/json",data:{params:JSON.stringify({currentAppConfigVersion:i,buildVersion:e.buildVersion.CurrentValue,buildName:e.buildName.CurrentValue,dynamicVersion:e.dynVersionNumber.CurrentValue,clientBundleVersion:window.clientBundleVersion})}},function(e){var r={status:"200"};u(e,r)},function(e){r()})}})})})}function getRemoteAppNamespace(){return new Promise(function(e,r){LOCAL_DEV?window.REMOTE_NAMESPACE?e({result:window.REMOTE_NAMESPACE}):e(null):"undefined"!=typeof plugin&&plugin.mcsdk||LOCAL_DEV?plugin.mcsdk.getAppConfigNamespace(function(r){e(r)}):e(null)})}function getAppSoup(e){return new Promise(function(r,n){if(e)r(e);else{var t={};smartStoreUtils.querySoupRecsPromise("appSoup").then(function(e){e.forEach(function(e){void 0===t[e.Name]&&(t[e.Name]=e)}),r(t)})}})}