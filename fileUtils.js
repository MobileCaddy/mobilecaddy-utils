/* mobilecaddy-utils - v2.0.1 - Bundle Time: 2018-11-29 10:57:03 */
/* git info: "2018-11-23 16:02:33 +0000": f458f3fe3659eef32ccde089f82b18d5376b87d6 (msd-628/p2m-fileUtils) */
/* Copyright 2018 MobileCaddy Ltd */

"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.downloadFiles=downloadFiles,exports.storeFilesInfo=storeFilesInfo,exports.getStorageDirectory=getStorageDirectory;var appDataUtils=_interopRequireWildcard(require("./appDataUtils")),smartStoreUtils=_interopRequireWildcard(require("./smartStoreUtils")),logger=_interopRequireWildcard(require("./logger")),_=_interopRequireWildcard(require("underscore"));function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)if(Object.prototype.hasOwnProperty.call(e,t)){var o=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,t):{};o.get||o.set?Object.defineProperty(r,t,o):r[t]=e[t]}return r.default=e,r}var storageDirectory,smartstore=cordova.require("com.salesforce.plugin.smartstore"),logTag="fileUtils.js",RECORD_FILES_TABLE="File_Library__ap",QUERY_PAGE_SIZE=1e4,CONTENT_VSN_FIELD="SF_Content_Version_Id__c",SYNC_FIELD="Synchronised__c",FILE_TYPE_FIELD="File_Type__c",LOCAL_PATH_FIELD="Local_Path",FILE_PATH_SUFFIX="?asPdf=false&operationContext=CHATTER";function getStorageDirectory(){return(storageDirectory=localStorage.getItem("mcFileStorageDirectory"))||(storageDirectory=cordova.file?cordova.file.documentsDirectory?cordova.file.documentsDirectory:cordova.file.dataDirectory:"CodeFlow",localStorage.setItem("mcFileStorageDirectory",storageDirectory),storageDirectory)}function storeFilesInfo(e){return new Promise(function(r,t){storageDirectory||getStorageDirectory(),console.log(logTag,"storeFilesInfo",e);var o=e,n="",i=(o.map(function(e,r){return n+=0===r?"'"+e.Id+"'":",'"+e.Id+"'",e.Id}),"SELECT {"+RECORD_FILES_TABLE+":Id} FROM {"+RECORD_FILES_TABLE+"} WHERE {"+RECORD_FILES_TABLE+":Id} IN ("+n+")"),a=smartstore.buildSmartQuerySpec(i,QUERY_PAGE_SIZE);smartStoreUtils.smartQuerySoupRecordsWithQuerySpec(a).then(function(e){var r;return r=0!==e.length?o.filter(function(r){return!e[0].includes(r.Id)}):o,smartStoreUtils.upsertSoupEntries(RECORD_FILES_TABLE,r)}).then(function(e){r(e)}).catch(function(e){t(e)})})}function downloadFiles(){return new Promise(function(e,r){storageDirectory||getStorageDirectory();var t,o;getFilesToDownload().then(function(r){r.length>0?(o=r,appDataUtils.getCurrentValueFromAppSoup("accessToken").then(function(e){return t=e,Promise.all(o.map(function(e){return doDownloadFile("/sfc/servlet.shepherd/version/download/",e,t).then(function(e){return logger.log("resp",e),e})})).then(function(e){return logger.log("accum",e),e})}).then(function(r){logger.log("res1",r),e(r)})):(logger.log("No files to download"),e())}).catch(function(e){r(e)})})}function doDownloadFile(e,r,t){var o=e+r[1]+FILE_PATH_SUFFIX;return new Promise(function(e,n){logger.log(logTag,"doDownloadFile",r,o);var i="no-cors";if("CodeFlow"==storageDirectory&&(o="https://cataas.com/c?wi=400",i="cors"),r[1]&&r[1].length>0){var a=new Headers;a.append("Authorization","Bearer "+t),a.append("Content-Type","image/jpeg");var c={method:"GET",headers:a,mode:i},l=new Request(o);fetch(l,c).then(function(t){logger.log(logTag,t),200==t.status?saveFile(r,t):(logger.error("resp.status",t.status),logger.error("resp.statusText",t.statusText),logger.error("resp.type",t.type)),e(t)}).catch(function(e){logger.error("Something went wrong!",e),n(e)})}else e()})}function getFilesToDownload(){return new Promise(function(e,r){smartstore.soupExists(RECORD_FILES_TABLE,function(t){if(t){var o="SELECT {"+RECORD_FILES_TABLE+":Id},{"+RECORD_FILES_TABLE+":"+CONTENT_VSN_FIELD+"},{"+RECORD_FILES_TABLE+":"+FILE_TYPE_FIELD+"} FROM {"+RECORD_FILES_TABLE+"} WHERE {"+RECORD_FILES_TABLE+":"+SYNC_FIELD+"} = 0",n=smartstore.buildSmartQuerySpec(o,QUERY_PAGE_SIZE);smartStoreUtils.smartQuerySoupRecordsWithQuerySpec(n).then(function(r){logger.log("Query res",r),r&&r[0]?e(r):e([])}).catch(function(e){r(e)})}else e([])},function(e){logger.error("Failed to check soupExists for "+RECORD_FILES_TABLE),r(e)})})}function saveFile(e,r){"CodeFlow"!=storageDirectory?window.resolveLocalFileSystemURL(storageDirectory,function(t){logger.log("file system open: "+t.name),t.getFile(e[1]+"."+e[2],{create:!0,exclusive:!1},function(t){writeFile(t,r).then(function(r){updateFileRec(e)})})}):r.arrayBuffer().then(function(r){var t=btoa(new Uint8Array(r).reduce(function(e,r){return e+String.fromCharCode(r)},""));localStorage.setItem("MCFILE_"+e[1]+"."+e[2],t),updateFileRec(e)})}function writeFile(e,r){return new Promise(function(t,o){e.createWriter(function(e){e.onwriteend=function(){logger.log("Successful file write..."),t()},e.onerror=function(e){logger.error("Failed file write: "+e.toString()),o()},r.arrayBuffer().then(function(r){e.write(r)})})})}function updateFileRec(e){var r="SELECT * FROM {"+RECORD_FILES_TABLE+"} WHERE {"+RECORD_FILES_TABLE+":Id} = '"+e[0]+"'";logger.log("soql",r);var t=smartstore.buildSmartQuerySpec(r,1);smartStoreUtils.smartQuerySoupRecordsWithQuerySpec(t).then(function(r){var t=r[0][1];logger.log("myRec",t),t[SYNC_FIELD]=1,t[LOCAL_PATH_FIELD]=storageDirectory+e[1]+"."+e[2],smartstore.upsertSoupEntriesWithExternalId(RECORD_FILES_TABLE,[t],"Id",function(e){logger.log("File DB entry updated",e)})}).catch(function(e){logger.error("Error updating "+RECORD_FILES_TABLE+" following file save",e)})}