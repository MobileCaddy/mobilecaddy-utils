/* mobilecaddy-utils - v2.0.0 - Bundle Time: 2018-08-28 14:07:42 */
/* git info: "2018-08-02 15:26:12 +0100": 215f3036c36884a4ede49961e39cd99fa994b892 (v2) */
/* Copyright 2018 MobileCaddy Ltd */

"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.handleUpdatedCS=exports.postProcessConnectionSession=exports.processM2PUpdateResponse=exports.maybeSyncConnSess=exports.csStatusCheck=exports.CONN_SESS_OK=exports.cleanConnectionSessionVFEvent=exports.cleanConnectionSessionHeartBeat=exports.CLEAN_CS_OK=exports.getRTSPendingconnSess=exports.syncMobileTable=exports.createUpdateJson=exports._handleRefreshResponse=exports.heartBeat=exports.HEARTBEAT_REFRESHED_OK=exports.HEARTBEAT_NOT_DEVICE=exports.HEARTBEAT_NO_CONNECTION=exports.HEARTBEAT_FAILURE=exports.HEARTBEAT_EXCEPTION=exports.HEARTBEAT_OK=exports.m2pRecoveryUpdateMobileTable=exports.m2pUpdateMobileTable=exports.M2P_NO_RECS_TO_SYNC=exports.M2P_UPDATE_OK=exports.buildConnectionSession=exports.p2mRefreshTable=exports.P2M_REFRESH_OK=exports.getSyncRecFailures=exports.addProxyIds=exports.genProxyId=exports.refreshToken=exports.SYNC_NOK_STATUS=exports.SYNC_ALREADY_IN_PROGRESS_INC=exports.SYNC=exports.CSINHEAD_SYNC_VSN=void 0;var _constants=require("./constants"),mobileCaddy=_interopRequireWildcard(_constants),_smartStoreUtils=require("./smartStoreUtils"),smartStoreUtils=_interopRequireWildcard(_smartStoreUtils),_appDataUtils=require("./appDataUtils"),appDataUtils=_interopRequireWildcard(_appDataUtils),_logger=require("./logger"),logger=_interopRequireWildcard(_logger),_geoLocation=require("./geoLocation"),geoLocation=_interopRequireWildcard(_geoLocation),_underscore=require("underscore"),_=_interopRequireWildcard(_underscore);function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t]);return n.default=e,n}var smartstore=cordova.require("com.salesforce.plugin.smartstore"),LOCAL_DEV=!!window.LOCAL_DEV,USE_FORCETK=!!window.USE_FORCETK,SYNC_ALREADY_IN_PROGRESS_INC=98,SYNC=100400,SYNC_OK=SYNC,SYNC_NOK_STATUS=100402,CSINHEAD_SYNC_VSN="006",MC_FAILURE_KEY_PREFIX="mc_failure_tab_";function syncMobileTable(e,n,t,o,s,r){console.time("syncMobileTable"),r&&r({status:0,table:e}),n=void 0===n||n;t||(t=0),o||(o=50),s||(s=!1);var a=function(e,n,o){var s={};p2mRefreshTable(e,t,!0,1,1,null,function(e){console.debug("refreshStatusObject",e),e.status==P2M_REFRESH_OK?(s.status=SYNC,n(s)):(s.status=e.status,s.mc_add_status=e.mc_add_status,n(s))},o)},c=function e(n,s,r){var a={};smartStoreUtils.queryMobileTable("recsToSync","Mobile_Table_Name",n,function(c){if(c.length>0)try{m2pUpdateMobileTable(n,o,function(o){console.log("m2pStatusObject",o),o.status==M2P_UPDATE_OK&&void 0===o.mc_add_status?(t=0,a.status=0,s(a)):o.status==M2P_UPDATE_OK&&"more-to-sync"===o.mc_add_status?(console.log("moreToSync - Going round again"),e(n,s,r)):(a.status=o.status,a.mc_add_status=o.mc_add_status,s(a))},r)}catch(e){console.error(e)}else a.status=2,a.mc_add_status="no-sync-no-updates",s(a)},r)},i=function(e,n,t,o,r){var i={};console.log("skipP2M",s),"Dynamic (Submit First/Retain)"==n||"Dynamic (Submit First/Clear)"==n?c(e,function(n){console.log("statusObject",n),!s&&(0===n.status||t&&2==n.status)?a(e,o,r):s&&0===n.status||2==n.status?(i.status=SYNC,i.mc_add_status=n.mc_add_status,o(i)):(i.status=SYNC_NOK_STATUS,i.mc_add_status=n.mc_add_status,o(i))},r):"Submit Only"==n||"Submit & Clear"==n||"Submit & Destroy"==n?c(e,function(e){0===e.status?(i.status=SYNC,o(i)):(i.status=SYNC_NOK_STATUS,i.mc_add_status=e.mc_add_status,o(i))},r):logger.errorAndDispatch("Unknown sync type",n,s)};return new Promise(function(t,o){var s={},c=function(n){localStorage.removeItem("syncInProgressTime"),console.timeEnd("syncMobileTable"),r&&(n.table=e,r(n)),t(n)},u=function(n){localStorage.removeItem("syncInProgressTime"),console.timeEnd("syncMobileTable"),r&&r({table:e,status:-1}),o(n)},l="syncTime"+e,d=localStorage.getItem(l),p=(new Date).valueOf(),_=d?parseInt(d)+5e3:0;"Connection_Session__mc"!=e&&p<_?(s.status=SYNC,s.mc_add_status="sync-too-soon",console.timeEnd("syncMobileTable"),t(s)):(localStorage.setItem(l,p),heartBeat(function(r){if(console.log("heartbeat call gave "+r.status),r.status==HEARTBEAT_OK||r.status==HEARTBEAT_NOT_DEVICE||r.status==HEARTBEAT_REFRESHED_OK){var l=localStorage.getItem("syncInProgressTime"),d=(new Date).valueOf();console.log("syncInProgressTime",l,d),"Connection_Session__mc"!=e&&l&&l>d-12e4?(console.log("SYNC_ALREADY_IN_PROGRESS"),s.status=SYNC+SYNC_ALREADY_IN_PROGRESS_INC,u(s)):(localStorage.setItem("syncInProgressTime",d),smartStoreUtils.getTableDefnColumnValue(e,"Sync Type").then(function(r){getRTSPendingconnSess(function(l){"Mobile_Log__mc"!=e?null!==l&&void 0!==l?csStatusCheck(l,function(o){o.status==CONN_SESS_OK?"Refresh Only"==r||"Refresh & Clear"==r?a(e,c,u):i(e,r,n,c,u):(s.status=SYNC_OK,s.mc_add_status=o.status,console.timeEnd("syncMobileTable"),t(s))},function(e){logger.errorAndDispatch(e),o(e)}):"Refresh Only"==r||"Refresh & Clear"==r?a(e,c,u):i(e,r,n,c,u):i(e,r,!1,c,u)},u)}).catch(function(e){u(e)}))}else s.status=SYNC_NOK_STATUS,s.mc_add_status=r.status,console.timeEnd("syncMobileTable"),t(s),100101==s.mc_add_status||100102==s.mc_add_status?logger.error(s):logger.log(s)},u))})}function handleRefreshResponse(e){return new Promise(function(n,t){var o=function(e){t(e)},s={};console.log("json object date time = "+e.lastRefreshDatetime);var r={},a={},c=e.mt;null===c&&console.error("Mobile Table (tag 'mt') empty in p2mRefresh response: ",e);var i=smartstore.buildExactQuerySpec("Mobile_Table_Name",c,mobileCaddy.QUERY_BUFFER_SIZE);smartStoreUtils.querySoupRecordsWithQuerySpec("recsToSync",i,function(t){t.forEach(function(e){if("Insert"==e.CRUD_Operation||"InsertUpdate"==e.CRUD_Operation)r[e.Id]=1;else{if("Update"!=e.CRUD_Operation&&"UpdateUpdate"!=e.CRUD_Operation)return void logger.error("RTS contains record with non support CRUD Operation"+e);a[e.Id]=1}}),smartStoreUtils.getProxyFieldName(c).then(function(i){var u=[],l=[];(e.records.forEach(function(e){var n=!0;null!==e.recordData.MC_Proxy_ID__c&&r.hasOwnProperty(e.recordData[i])&&(n=!1),n&&a.hasOwnProperty(e.recordData.Id)&&(n=!1),n&&u.push(e.recordData)}),e.ds)&&e.ds.oq.concat(e.ds.sd.concat(e.ds.hd.concat(e.ds.sh))).forEach(function(e){a.hasOwnProperty(e)?console.log("We have a dirty local version, not deleting"):l.push({Id:e})});var d=smartstore.buildExactQuerySpec("Mobile_Table_Name",c,mobileCaddy.QUERY_BUFFER_SIZE);smartStoreUtils.querySoupRecordsWithQuerySpec("recsToSync",d,function(r){r.length==t.length?smartStoreUtils.deleteRecordsForExternalId(c,l,"Id",function(){smartstore.upsertSoupEntriesWithExternalId(c,u,"Id",function(){smartstore.soupExists("SnapShot_"+c,function(t){t?smartStoreUtils.deleteRecordsForExternalId("SnapShot_"+c,l,"Id",function(){smartstore.upsertSoupEntriesWithExternalId("SnapShot_"+c,u,"Id",function(){checkForMigrateToInfo(e),setPlatAuthUrl(e.platAuthUrl),s.status=0,s.cs=e.cs,s.cp=e.cp,s.lastRefreshDatetime=e.lastRefreshDatetime,n(s)},o)},o):(checkForMigrateToInfo(e),setPlatAuthUrl(e.platAuthUrl),s.status=0,s.lastRefreshDatetime=e.lastRefreshDatetime,s.cs=e.cs,s.cp=e.cp,n(s))},o)},o)},o):(s.status=0,s.mc_add_status=1,s.cs=e.cs,s.cp=e.cp,s.lastRefreshDatetime=e.lastRefreshDatetime,resolves(s))},o)})},o)})}function setPlatAuthUrl(e){console.log("setPlatAuthUrl",e),e||(e=""),appDataUtils.updateCurrentValueInAppSoup("platAuthUrl",e).catch(function(n){logger.error("setPlatAuthUrl",e,n)})}var P2M_REFRESH_OK=100500,SYNC_NOK=100402;function p2mRefreshTable(e,n,t,o,s,r,a,c){console.log("Refreshing table",e);var i,u,l,d,p=function(o,s){if(console.debug("respJson",o),console.debug("event",s),s.status){var r,i,l=new RegExp("\n","g");o=o.replace(l,"\\n"),l=new RegExp("\r","g"),o=o.replace(l,""),i=JSON.parse(o),console.log("Parse json done"),handleRefreshResponse(i).then(function(n){return r=n,console.log("handle refresh res = "+r.status),smartStoreUtils.setTableDefnColumnValue(e,"Last Refresh Date/Time",r.lastRefreshDatetime)}).then(function(){var n="P2M RE Records Processed";return"Connection_Session__mc"==e&&(n="P2M Conn_Sess Records Processed"),1==r.mc_add_status&&(n="P2M RE Abandoned"),d.connSessionRec.mobilecaddy1__Mobile_Process_Status__c=n,d.connSessionRec.Id=r.cs,postProcessConnectionSession(d.connSessionRec)}).then(function(){return handleUpdatedCS(i.csM2P)}).then(function(){console.log("success return from post process"),t&&u<CSINHEAD_SYNC_VSN?maybeSyncConnSess(d.connSessionRec,function(){console.log("success return from maybeSyncConnSess"),i["Session Number"]&&i["Session Number"]<i["Total Sessions"]?(console.info("Page "+i["Session Number"]+" of "+i["Total Sessions"]+", going again."),p2mRefreshTable(e,n,t,i["Session Number"]+1,i["Total Sessions"],i.CsPId,a,c)):i.moreBatches?(console.info("moreBatches"),p2mRefreshTable(e,n,t,"newBatch",1,null,a,c)):(_.status=P2M_REFRESH_OK,a(_))},c):i["Session Number"]&&i["Session Number"]<i["Total Sessions"]?(console.info("Page "+i["Session Number"]+" of "+i["Total Sessions"]+", going again."),p2mRefreshTable(e,n,t,i["Session Number"]+1,i["Total Sessions"],i.CsPId,a,c)):i.moreBatches?(console.info("moreBatches"),p2mRefreshTable(e,n,t,"newBatch",1,null,a,c)):(console.log("No more pages or batches"),_.status=P2M_REFRESH_OK,a(_))}).catch(function(e){c(e)})}else"exception"===s.type&&logger.error("p2mRefresh",e,s.message,s.where),cleanConnectionSessionVFEvent(s,d,function(e){_.status=SYNC_NOK,_.mc_add_status=e.mc_add_status,a(_)},c)},_={},S="newBatch"==o;S&&(o=1);try{smartStoreUtils.getTableDefnColumnValue(e,"Last Refresh Date/Time").then(function(e){(l=e)&&"null"!=l||(l=0),console.log("Using lastRefreshDatetime = "+l),console.debug("maxTableAge",n);var s=new Date;return l<s-n||o>1||S||!t?appDataUtils.getCachedCurrentValueFromAppSoup("audId"):(console.log("Not refreshing table. it is too young"),_.status=100402,_.status=100497,a(_),Promise.reject(_))}).then(function(e){return i=e,appDataUtils.getCachedCurrentValueFromAppSoup("syncRefreshVersion")}).then(function(e){return buildConnectionSession(u=e,"Sync - Refresh","P2M RE Process Called",o,s,r)}).then(function(e){if(d=e,!t){var n=JSON.parse(d.connSessJson);n.initialSync=!0,d.connSessJson=JSON.stringify(n)}if(S){var o=JSON.parse(d.connSessJson);o.firstBatch=!1,d.connSessJson=JSON.stringify(o)}return getCsUpdates(u,t)}).then(function(n){console.log("csUpdates",n),n&&(d.connSessJson=JSON.parse(d.connSessJson),d.connSessJson.csM2P=n,d.connSessJson=JSON.stringify(d.connSessJson)),console.log("connSessObject -> ",d),!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/p2mRefreshTable001",contentType:"application/json",data:{audId:i,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:u,mobileTableName:e,deviceRefreshIds:[],lastRefreshDateTime:l,thirdPartyJson:"",connSessJson:d.connSessJson}},function(e,n){void 0===n&&((n={}).status="200"),p(e,n)},c):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".p2mRefreshTable",i,u,e,[],l,"",d.connSessJson,p,{buffer:!1,escape:!1,timeout:12e4})}).catch(function(e){100497==e.status?a(e):(logger.error(e),c(e))})}catch(e){logger.errorAndDispatch(e)}}function genProxyId(e,n,t){return new Promise(function(o,s){appDataUtils.getCachedCurrentValueFromAppSoup("audId").then(function(s){o("PROXY%"+e+"%"+t+"%"+n+"%"+s)}).catch(function(e){s(e)})})}function addProxyIds(e,n,t,o,s){var r;smartStoreUtils.getProxyFieldName(e).then(function(e){return r=e,appDataUtils.getCachedCurrentValueFromAppSoup("audId")}).then(function(a){n.forEach(function(n){var o="PROXY%"+e+"%"+t+"%"+n._soupEntryId+"%"+a;n.Id=o,n[r]=o}),smartstore.upsertSoupEntries(e,n,function(e){o(e)},s)}).catch(function(e){s(e)})}function nullHandler(e,n,t,o){var s;if("Throw Exception"==o)throw logger.errorAndDispatch("nullHandler - NULL value found",e,n,t.Id),"NULL value found for field "+n+" in Mobile Table "+e+" with Id = "+t.Id;return"Return NULL"==o?s=null:"Return Empty String"==o&&(s=""),s}function getCsUpdates(e,n){return new Promise(function(t,o){if(console.log("syncRefreshVersion",e,CSINHEAD_SYNC_VSN),e<CSINHEAD_SYNC_VSN||!n)t();else{var s,r=[];smartStoreUtils.queryMobileTable("recsToSync","Mobile_Table_Name","Connection_Session__mc").then(function(e){return s=e,console.log("rtsRecs",s),s.length>0?smartStoreUtils.querySoupRecsPromise("Connection_Session__mc"):Promise.resolve([])}).then(function(e){console.log("csRecs",e),s.forEach(function(n){for(var t,o=0;o<e.length;++o)if(e[o].Id===n.Id&&e[o].Id.length<20){t=e[o];break}t&&r.push({Id:n.Id,t:valFromCsSessionType(t.mobilecaddy1__Session_Type__c),s:valFromCsStatus(t.mobilecaddy1__Mobile_Process_Status__c)})}),t(r)}).catch(function(e){logger.error(e),t(null)})}})}function valFromCsStatus(e){switch(e){case"P2M RE Records Processed":return 1;case"P2M Conn_Sess Records Processed":return 2;case"P2M RE Abandoned":return 3;case"P2M RE Exception/Timeout":return 4;case"P2M RE Heartbeat Exception/Timeout":return 5;case"P2M RE Failure":return 6;case"P2M RE Hearbeat Failure":return 7;case"M2P Conn_Sess Records Processed":return 8;case"M2P Records Processed":return 9;case"M2P UP Failed - RTS Cleared":return 10;case"M2P SC - Status Check Processed":return 11;case"M2P SC Failure":return 12;case"M2P SC Exception/Timeout":return 13;case"M2P SC Heartbeat Exception/Timeout":return 14;case"M2P SC Heartbeat Failure":return 15;case"M2P UP Received - Records Processed":return 16;case"P2M InitialSync Faliure":return 17;default:return logger.error("Unknown CS status",e),0}}function valFromCsSessionType(e){switch(e){case"Sync - Refresh":return 1;case"Sync - Update":return 2;case"Status Check":return 3;default:return logger.error("Unkown Session_Type__c",e),0}}function createUpdateJson(e,n,t,o,s,r,a,c,i,u,l){var d={MobileTable:e,connSessProxyId:u,records:[]};a.forEach(function(a){for(var u,l=0;l<c.length;++l)if(c[l].Id===a.Id){u=c[l];break}if(u){var p={RTSRowNum:a._soupEntryId,RecordCRUD:mapCrudOpforM2P(a.CRUD_Operation),fields:[]};switch(p.RecordCRUD){case"I":case"T":p=createM2PInsertRecObj(p,e,n,t,o,s,r,u),d.records.push(p);break;case"D":case"U":case"Q":for(var _,S=0;S<i.length;++S)if(i[S].Id===a.Id){_=i[S];break}_?(p=createM2PUpdateRecObj(p,e,n,t,o,s,r,u,_),d.records.push(p)):logger.errorAndDispatch("createUpdateJson Missing snapShot",e,u.Id);break;default:logger.errorAndDispatch("createUpdateJson unknown CRUD",e,a.Id,a.CRUD_Operation)}}else logger.errorAndDispatch("createUpdateJson Missing primary",e,a.Id)}),l(JSON.stringify(d))}function mapCrudOpforM2P(e){switch(e){case"Insert":return"I";case"InsertDelete":return"T";case"Update":return"U";case"UpdatetDelete":return"Q";case"Delete":return"D";default:return null}}function createM2PInsertRecObj(e,n,t,o,s,r,a,c){for(var i in c){var u={name:i};if("mobilecaddy1__Error_Text__c"==i)u.value=JSON.stringify(c[i]),e.fields.push(u);else if("_soupEntryId"!=i&&"_soupLastModifiedDate"!=i){var l,d={};d[o]=i;var p=_.findWhere(t,d);if(null===c[i])fieldNullHandler=p[r],l=nullHandler(n,i,c,fieldNullHandler);else if(l=c[i],p)"M2P UP Unquoted"!=p[a]||"true"!=l&&"false"!=l||(l="true"==l);u.value=l,e.fields.push(u)}}return e}function createM2PUpdateRecObj(e,n,t,o,s,r,a,c,i){var u=!1;for(var l in c)if("_soupEntryId"!=l&&"_soupLastModifiedDate"!=l){var d={name:l};if(c[l]!=i[l]||"SystemModstamp"==l){var p,S;u=!0;var f=null,m=null,R={};R[o]=l;var g=_.findWhere(t,R);null===c[l]?p=nullHandler(n,l,c,f=g[r]):(p=c[l],g&&("M2P UP Unquoted"!=(m=g[a])||"true"!=p&&"false"!=p||(p="true"==p))),null===i[l]&&g?(f||(f=g[r]),S=nullHandler(n,l,i,f)):(S=i[l],g&&(m||(m=g[a]),"M2P UP Unquoted"!=m||"true"!=S&&"false"!=S||(S="true"==S))),d.previousValue=S,d.value=p,e.fields.push(d)}}return u?(e.fields.push({name:"Id",previousValue:i.Id,value:i.Id}),e):[]}function markRecsToSyncWithProxy(e,n,t,o){e.forEach(function(e){e.Current_Connection_Session=n}),smartstore.upsertSoupEntriesWithExternalId("recsToSync",e,"Id",t,o)}function createInsertSnapshotRecords(e,n,t,o,s){var r=[];n.forEach(function(e){var n={};t.forEach(function(t){if(e.Id==t.Id&&"Insert"==e.CRUD_Operation)for(var o in t)"_soupEntryId"!=o&&"_soupLastModifiedDate"!=o&&(n[o]=t[o])}),_.isEmpty(n)||r.push(n)}),0===r.length?o():smartStoreUtils.getProxyFieldName(e).then(function(n){smartstore.upsertSoupEntriesWithExternalId("SnapShot_"+e,r,n,o,s)})}function buildConnectionSession(e,n,t,o,s,r){return new Promise(function(e,a){var c={};geoLocation.getLocation(function(i){var u={mobilecaddy1__Session_Type__c:n,mobilecaddy1__Mobile_Process_Status__c:t,SystemModstamp:(new Date).getTime()},l=i.ErrorNumber;0!==l?u.mobilecaddy1__Session_Created_Location_Error__c=i.Error:(u.Session_Created_Location__Longitude__s=i.Latitude,u.Session_Created_Location__Latitude__s=i.Longitude),insertRecWithProxyId("Connection_Session__mc",u,function(n){var t=new Date,a={"Sync Session Proxy ID":null,"Total Sessions":s,"Session Number":o,"Device Call Date/Time":t.getTime(),"Connection Session Proxy ID":n.proxyId};r&&(a.CsPId=r),0!==l?a.ErrorNumber=l:(a["Location Long"]=i.Longitude,a["Location Lat"]=i.Latitude),c.status=0,c.connSessionRec=n.insertedRecord,c.connSessProxyId=n.proxyId;var u={version:"NULL"};window.device&&(u=window.device),appDataUtils.getCurrentValueFromAppSoup("containerVersion").then(function(n){a.containerVsn=n,a.OSVsn=u.version,c.connSessJson=JSON.stringify(a),e(c)}).catch(function(n){logger.error("buildConnectionSession - Could not get containerVsn",n),a.OSVsn=u.version,c.connSessJson=JSON.stringify(a),e(c)})},function(e){a(e)})},function(e){a(e)})})}function m2pRecoveryUpdateMobileTable(e){return new Promise(function(n,t){var o={},s=function(e){n(e)},r=function(e){t(e)},a=smartstore.buildExactQuerySpec("Mobile_Table_Name",e,mobileCaddy.QUERY_BUFFER_SIZE);smartStoreUtils.querySoupRecordsWithQuerySpec("recsToSync",a,function(n){if(0!==n.length){console.debug("recsToSyncRecords",JSON.stringify(n));var t=!1;"Connection_Session__mc"!=e&&n.length>3e4&&(t=!0),console.log("moreToSync: "+t);var a=[];a=t?(a=_.sortBy(n,"_soupLastModifiedDate")).slice(0,3e4):n,console.debug("recsToSyncRecords2",JSON.stringify(a)),smartStoreUtils.querySoupRecords(e,function(n){smartStoreUtils.querySoupRecords("SnapShot_"+e,function(c){smartStoreUtils.getSysDataRowMapColHeadings("Row Mapping TC",["Parent SOUP Name","Table Column Name","M2P Update Converter DEVICE","M2P Update NULL Handler DEVICE","M2P Update Formatter DEVICE"],function(i){var u=i[0],l=i[1],d=i[2],p=i[3],S=i[4];smartStoreUtils.queryMobileTableWithAnd("syncLib_system_data","MC_Var_String_001","Platform Table Column",u,e,function(i){var u=[];if(_.each(a,function(e){var t;t=e.Id,_.find(n,function(e){return e.Id==t})&&u.push(e)}),_.isEmpty(u))return console.debug("Nothing in checkedRecsToSync."),void smartStoreUtils.setTableDefnColumnValue(e,"Last Sync Date/Time",(new Date).getTime()).then(function(){o.status=M2P_UPDATE_OK,o.mc_add_status=M2P_NO_RECS_TO_SYNC,s(o)}).catch(function(e){logger.error(e)});createUpdateJson(e,i,l,d,p,S,u,n,c,"",function(c){var i;appDataUtils.getCachedCurrentValueFromAppSoup("audId").then(function(e){return i=e,appDataUtils.getCachedCurrentValueFromAppSoup("syncRefreshVersion")}).then(function(u){createInsertSnapshotRecords(e,a,n,function(){console.log("moreToSync: "+t);var n=function(e,n){console.debug("result: "+e),console.debug("event: "+n),o.result=e,o.event=n,s(o)};c=c.replace(/: undefined/g,': "undefined"'),console.debug("jsonString -> "+c),!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/m2pUpdateTable001",contentType:"application/json",data:{audId:i,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:u,mobileTableName:e,jsonRecords:c,connSessJson:"{}"}},function(e,t){void 0===t&&((t={}).status="200"),n(e,t)},r):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".m2pUpdateTable",i,u,e,c,JSON.stringify({"Session Number":1,"Location Long":10,"Location Lat":10,"Total Sessions":1,"Device Call Date/Time":(new Date).getTime(),"Connection Session Proxy ID":"1",ErrorNumber:2}),n,{buffer:!1,escape:!1,timeout:3e4})},r)}).catch(function(e){r(e)})},r)},r)},r)},r)},r)}else smartStoreUtils.setTableDefnColumnValue(e,"Last Sync Date/Time",(new Date).getTime()).then(function(){o.status=M2P_UPDATE_OK,o.mc_add_status=M2P_NO_RECS_TO_SYNC,s(o)}).catch(function(e){logger.log("No recs to sync")})},r)})}var M2P_UPDATE_OK=100300,M2P_NO_RECS_TO_SYNC=100310;function m2pUpdateMobileTable(e,n,t,o){var s,r,a={};console.debug("In m2pUpdateMobileTable call",e,n);try{appDataUtils.getCachedCurrentValueFromAppSoup("syncRefreshVersion").then(function(e){return buildConnectionSession(r=e,"Sync - Update","M2P Process Called",1,1,null)}).then(function(e){return s=e,console.log("proxy id = "+s.connSessProxyId),getCsUpdates(r,!0)}).then(function(c){console.log("m2p csUpdates",c),c&&(s.connSessJson=JSON.parse(s.connSessJson),s.connSessJson.csM2P=c,s.connSessJson=JSON.stringify(s.connSessJson)),console.log("connSessObject -> ",s);var i=smartstore.buildExactQuerySpec("Mobile_Table_Name",e,mobileCaddy.QUERY_BUFFER_SIZE);smartStoreUtils.querySoupRecordsWithQuerySpec("recsToSync",i,function(c){if(0!==c.length){console.debug("recsToSyncRecords",JSON.stringify(c));var i=!1;"Connection_Session__mc"!=e&&c.length>n&&(i=!0),console.log("moreToSync",i);var u=[];u=i?(u=_.sortBy(c,"_soupLastModifiedDate")).slice(0,n):c,console.debug("recsToSyncRecords2",JSON.stringify(u)),markRecsToSyncWithProxy(u,s.connSessProxyId,function(n){smartStoreUtils.querySoupRecords(e,function(c){smartStoreUtils.querySoupRecords("SnapShot_"+e,function(u){smartStoreUtils.getSysDataRowMapColHeadings("Row Mapping TC",["Parent SOUP Name","Table Column Name","M2P Update Converter DEVICE","M2P Update NULL Handler DEVICE","M2P Update Formatter DEVICE"],function(l){var d=l[0],p=l[1],_=l[2],S=l[3],f=l[4];smartStoreUtils.queryMobileTableWithAnd("syncLib_system_data","MC_Var_String_001","Platform Table Column",d,e,function(l){createUpdateJson(e,l,p,_,S,f,n,c,u,s.connSessProxyId,function(u){var l;appDataUtils.getCachedCurrentValueFromAppSoup("audId").then(function(d){l=d,createInsertSnapshotRecords(e,n,c,function(){console.log("moreToSync",i);var n=function(n,c){var l;(console.debug("result",n),console.debug("event",c),c.status)?(n=n.replace(/,}/g,"}"),console.log("Parse json processM2PUpdateResponse"),l=JSON.parse(n),console.log("Parse json processM2PUpdateResponse done"),processM2PUpdateResponse(l,u,function(n){console.debug("responseObject",JSON.stringify(n)),s.connSessionRec.mobilecaddy1__Mobile_Process_Status__c="Connection_Session__mc"==e?"M2P Conn_Sess Records Processed":"M2P Records Processed",s.connSessionRec.Id=n.csId,postProcessConnectionSession(s.connSessionRec).then(function(){return handleUpdatedCS(l.csM2P)}).then(function(){console.log("success return from post process"),console.log("success return from post process"),console.log("moreToSync",i),i?(a.status=M2P_UPDATE_OK,a.mc_add_status="more-to-sync",t(a)):r<CSINHEAD_SYNC_VSN?maybeSyncConnSess(s.connSessionRec,function(){console.log("success return from maybeSyncConnSess"),a.status=M2P_UPDATE_OK,t(a)},o):(a.status=M2P_UPDATE_OK,t(a))}).catch(function(e){o(e)})},o)):"exception"===c.type?(a.status=M2P_UPDATE_OK,a.mc_add_status=HEARTBEAT_EXCEPTION,t(a),logger.error("m2pUpdate",e,c.message,c.where)):(a.status=M2P_UPDATE_OK,a.mc_add_status=HEARTBEAT_FAILURE,t(a),logger.error("m2pUpdate",e,c.message,c.where))};u=u.replace(/: undefined/g,': "undefined"'),console.debug("jsonString -> "+u),!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/m2pUpdateTable001",contentType:"application/json",data:{audId:l,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:r,mobileTableName:e,jsonRecords:u,connSessJson:s.connSessJson}},function(e,t){void 0===t&&((t={}).status="200"),n(e,t)},o):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".m2pUpdateTable",l,r,e,u,s.connSessJson,n,{buffer:!1,escape:!1,timeout:3e4})},o)}).catch(function(e){o(e)})},o)},o)},o)},o)},o)},o)}else smartStoreUtils.setTableDefnColumnValue(e,"Last Sync Date/Time",(new Date).getTime()).then(function(){a.status=M2P_UPDATE_OK,a.mc_add_status=M2P_NO_RECS_TO_SYNC,t(a)}).catch(function(e){o(e)})},o)},o)}catch(e){logger.errorAndDispatch(e)}}function insertRecWithProxyId(e,n,t,o){var s={},r=new Date;smartStoreUtils.getProxyFieldName(e).then(function(a){smartstore.upsertSoupEntries(e,[n],function(n){var c=n[0];genProxyId(e,c._soupEntryId,r.getTime()).then(function(n){c.Id=n,c[a]=n,smartstore.upsertSoupEntries(e,[c],function(e){s.status=0,s.proxyId=n,s.insertedRecord=e[0],t(s)},o)}).catch(function(e){o(e)})},o)}).catch(function(e){o(e)})}var HEARTBEAT_OK=100100,HEARTBEAT_EXCEPTION=100101,HEARTBEAT_FAILURE=100102,HEARTBEAT_NO_CONNECTION=100103,HEARTBEAT_NOT_DEVICE=100104,HEARTBEAT_REFRESHED_OK=100105;function heartBeat(e,n){var t={},o=navigator.appVersion.includes("Electron");o||navigator&&navigator.connection&&"undefined"!=typeof Connection?(console.log("Connection details"),o||navigator.connection.type!=Connection.NONE?"undefined"==typeof Visualforce?(logger.log("Visualforce not currently defined"),resetStartPageAndScript().then(function(t){sendHeartBeat(e,n)}).catch(function(n){logger.errorAndDispatch("Startpage Load Error: "+window.location.pathname,n),t.status=HEARTBEAT_FAILURE,e(t)})):sendHeartBeat(e,n):(t.status=HEARTBEAT_NO_CONNECTION,e(t))):(localStorage.connection?t.status=localStorage.connection:t.status=HEARTBEAT_NOT_DEVICE,e(t))}function resetStartPageAndScript(){return new Promise(function(e,n){var t=window.location.pathname,o=new XMLHttpRequest;o.open("GET",t,!0),o.send(),o.onreadystatechange=function(){if(o.readyState==XMLHttpRequest.DONE&&200==o.status){console.log(o.response),logger.log("Startpage re-fetched",t);var e=new RegExp('"(\\S+VFRemote.js)"').exec(o.response);if(e&&e[0]){var s=e[1];console.log("vfRemoteSrc",s),getScript(s,function(){logger.log("remote script fetched",s),logger.log("set up Visualforce ref")})}else n("Could not find VFRemote.js mention in "+t)}else o.readyState==XMLHttpRequest.DONE&&n(o.status)}})}function getScript(e,n){var t=document.createElement("script"),o=document.getElementsByTagName("script")[0];t.async=1,t.onload=t.onreadystatechange=function(e,o){(o||!t.readyState||/loaded|complete/.test(t.readyState))&&(t.onload=t.onreadystatechange=null,t=void 0,o||n&&n())},t.src=e,o.parentNode.insertBefore(t,o)}function sendHeartBeat(e,n){var t={};Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".heartBeat",function(n,o){o.status?(t.status=HEARTBEAT_OK,e(t)):"exception"===o.type?refreshToken(function(n){console.log("refresh token refreshed in heartbeat"),t.status=HEARTBEAT_REFRESHED_OK,e(t)},function(n){t.status=HEARTBEAT_EXCEPTION,e(t)}):(console.debug("other"),t.status=HEARTBEAT_FAILURE,e(t))},{escape:!1,timeout:3e4})}function refreshToken(e,n){smartStoreUtils.querySoupRecords("appSoup",function(t){var o={};t.forEach(function(e){o[e.Name]=e.CurrentValue}),refreshTokenRequest(o,e,n)},function(e){n(e)})}function refreshTokenRequest(e,n,t){var o="grant_type=refresh_token&identity_url="+e.identityUrl+"&client_id="+e.clientId+"&refresh_token="+e.refreshToken+"&orgId="+e.orgId+"&audId="+e.audId+"&userId="+e.userId;console.log("data: "+o);var s=new XMLHttpRequest;s.open("POST","https://mobilecaddy.secure.force.com/apex/ProxyToken",!0),s.setRequestHeader("Content-type","application/x-www-form-urlencoded"),s.send(o),s.onreadystatechange=function(){if(s.readyState==XMLHttpRequest.DONE&&200==s.status){var e=JSON.parse(s.response);console.log("Changing vf access token from "+Visualforce.remoting.oauthAccessToken+" to "+e.access_token),Visualforce.remoting.oauthAccessToken=e.access_token,Visualforce.remoting.last.refresh(function(){appDataUtils.updateCurrentValueInAppSoup("accessToken",e.access_token).then(function(){console.log("Updated accessToken in appSoup"),n(e.access_token)}).catch(function(e){t(e)})},function(e){logger.error("in VF last refresh error"),t(e)})}else s.readyState==XMLHttpRequest.DONE&&logger.error("refreshTokenRequest error.",s.status)}}function getRTSPendingconnSess(e,n){smartStoreUtils.querySoupRecords("recsToSync",function(t){console.debug("recsToSync -> "+JSON.stringify(t));for(var o=null,s=null,r=0;r<t.length;r++)if(console.debug("recsToSync["+r+"] -> "+JSON.stringify(t[r])),null!==t[r].Current_Connection_Session&&void 0!==t[r].Current_Connection_Session){o=t[r].Current_Connection_Session,s=t[r];break}if(null!==o&&void 0!==o){var a=(new Date).getTime(),c=s._soupLastModifiedDate+3e4;if(a>c)console.debug("timeNow > timeoutTs",a,c),console.debug("We have a timedout Conn_Sess",o),e(o);else{console.debug("We have a SYNC_ALREADY_IN_PROGRESS",o);var i={status:100498};n(i)}}else console.debug("getRTSPendingconnSess - All clear"),e(o)},n)}var CONN_SESS_OK=100200,CONN_SESS_NOK=100201;function csStatusCheck(e,n,t){console.debug("csStatusCheck -> "+e);try{var o;appDataUtils.getCachedCurrentValueFromAppSoup("syncRefreshVersion").then(function(e){return buildConnectionSession(o=e,"Status Check","M2P SC Status Check Requested",1,1,null)}).then(function(s){heartBeat(function(r){var a;r.status==HEARTBEAT_OK||r.status==HEARTBEAT_NOT_DEVICE||r.status==HEARTBEAT_REFRESHED_OK?appDataUtils.getCachedCurrentValueFromAppSoup("audId").then(function(r){a=r;var c=function(o,r){var a;r.status?((a=JSON.parse(o)).cs_fc_jr&&(a.cs_fc_jr=JSON.parse(a.cs_fc_jr)),console.debug("Parse json status check done"),"Received Processed"==a.cs_fc_sc?handleCsStatusCheckRespReceivedProcessed(s,a,n,t):clearRTSRecs(e,function(){smartStoreUtils.queryMobileTable("Connection_Session__mc","mobilecaddy1__MC_Proxy_ID__c",e,function(e){if(e.length>0){var o=e[0];"Received Not Processed"==a.cs_fc_sc?handleCsStatusCheckRespReceivedNotProcessed(o,s,a,n,t):handleCsStatusCheckRespNotReceived(o,s,a,n,t)}else n({status:CONN_SESS_OK})},t)},t)):(logger.error("csStatusCheck",r.message),n({status:CONN_SESS_NOK}))},i=s.connSessJson,u=localStorage.getItem("lastErrorLog");u&&(localStorage.removeItem("lastErrorLog"),(i=JSON.parse(i)).lastErrorLog=u,i=JSON.stringify(i)),!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/m2pCSStatusCheck001",contentType:"application/json",data:{audId:a,syncRefreshDataVersion:o,statusCheckCSProxyId:e,connSessJson:i,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN}},function(e,n){console.info("response -> "+JSON.stringify(e)),void 0===n&&((n={}).status="200"),c(e,n)},function(e){logger.error("err -> "+JSON.stringify(e)),t(e)}):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".m2pCSStatusCheck",a,o,e,i,c,{buffer:!1,escape:!1,timeout:3e4})}).catch(function(e){t(e)}):cleanConnectionSessionHeartBeat(r,s,function(e){n({status:CONN_SESS_OK,mc_add_status:e.mc_add_status})},t)},t)}).catch(function(e){t(e)})}catch(e){logger.errorAndDispatch(e)}}function handleCsStatusCheckRespReceivedProcessed(e,n,t,o){try{processM2PUpdateResponse(n.cs_fc_jr,function(s){e.connSessionRec.mobilecaddy1__Mobile_Process_Status__c="M2P SC - Status Check Processed",e.connSessionRec.SystemModstamp=(new Date).getTime(),e.connSessionRec.mobilecaddy1__Status__c="Closed",e.connSessionRec.Id=n.cs_sc_sf,smartStoreUtils.queryMobileTable("Connection_Session__mc","Id",n.cs_fc_jr.cp).then(function(t){if(t[0]){var o=t[0];return console.log("m2pCsObject",o),o.Id=n.cs_fc_jr.csId,o.SystemModstamp=(new Date).getTime(),o.mobilecaddy1__Mobile_Process_Status__c="M2P Records Processed",postProcessConnectionSession([e.connSessionRec,o])}return Promise.resolve()}).then(function(){t({status:CONN_SESS_OK})}).catch(function(e){o(e)})},o)}catch(e){logger.errorAndDispatch("processM2PUpdateResponse",e),o("processM2PUpdateResponse-error")}}function handleCsStatusCheckRespReceivedNotProcessed(e,n,t,o,s){e.mobilecaddy1__Mobile_Process_Status__c="M2P UP Failed - RTS Cleared",e.mobilecaddy1__Session_Type__c="Sync Update",e.mobilecaddy1__Status__c="Closed",e.SystemModstamp=(new Date).getTime(),e.Id=t.cs_fc_sf,postProcessConnectionSession(e).then(function(){n.connSessionRec.mobilecaddy1__Mobile_Process_Status__c="M2P SC - Status Check Processed",n.connSessionRec.SystemModstamp=(new Date).getTime(),n.connSessionRec.mobilecaddy1__Status__c="Closed",n.connSessionRec.Id=t.cs_sc_sf,postProcessConnectionSession(n.connSessionRec,function(){o({status:CONN_SESS_OK})},s)}).catch(function(e){s(e)})}function handleCsStatusCheckRespNotReceived(n,t,o,s,r){smartStoreUtils.deleteRecordsFromSoup([n],"Connection_Session__mc",function(n){t.connSessionRec.mobilecaddy1__Mobile_Process_Status__c="M2P SC - Status Check Processed",t.connSessionRec.SystemModstamp=(new Date).getTime(),t.connSessionRec.mobilecaddy1__Status__c="Closed",t.connSessionRec.Id=o.cs_sc_sf,t.connSessionRec.mobilecaddy1__Session_Type__c="Status Check",postProcessConnectionSession(t.connSessionRec).then(function(){s({status:CONN_SESS_OK})}).catch(function(){r(e)})},r)}function processM2PUpdateResponse(e,n,t,o){o||(o=t,t=n,n="{}");var s=1;console.debug("processM2PUpdateResponse",e,n);var r=e.mt,a=void 0!==e.is?e.is:[],c=void 0!==e.id?e.id:[],i=void 0!==e.us?e.us:[],u=void 0!==e.ifmf?e.ifmf:[],l=void 0!==e.ufmf?e.ufmf:[],d=[],p=[],_=[],S=[],f=[],m=[],R=[],g=[],h=[],C=[],E=[];if(a=a.concat(c),storeSyncFailures(r,e.af),void 0===e.if)C=[];else if(void 0===e.if.if)C=e.if;else{s=2;var T=e.if.if.map(function(n){return{pd:n,fbe:void 0!==e.ifbe?e.ifbe:"K"}}),b=e.if.ifv.map(function(n){return{pd:n,fbe:void 0!==e.ifvbe?e.ifvbe:"K"}}),y=e.if.icv.map(function(n){return{pd:n,fbe:void 0!==e.icvbe?e.icvbe:"K"}});C=T.concat(b.concat(y))}addNonRespondedIds(n,a,C,u).then(function(n){if(C=n,void 0===e.uf)E=[];else if(void 0===e.uf.uf)E=e.uf;else{s=2;var t=e.uf.uf.map(function(n){return{Id:n,fbe:void 0!==e.ufbe?e.ufbe:"K"}}),o=e.uf.usv.map(function(n){return{Id:n,fbe:void 0!==e.usvbe?e.usvbe:"K"}}),a=e.uf.sdf.map(function(n){return{Id:n,fbe:void 0!==e.sdfbe?e.sdfbe:"K"}}),c=e.uf.hdf.map(function(n){return{Id:n,fbe:void 0!==e.hdfbe?e.hdfbe:"K"}}),i=e.uf.ufv.map(function(n){return{Id:n,fbe:void 0!==e.ufvbe?e.ufvbe:"K"}}),u=e.uf.ucv.map(function(n){return{Id:n,fbe:void 0!==e.ucvbe?e.ucvbe:"K"}});E=t.concat(o.concat(a.concat(c.concat(i.concat(u)))))}return querySoupRecsPromise("SnapShot_"+r)}).then(function(e){return h=e,querySoupRecsPromise(r)}).then(function(n){console.debug("priRecords -> "+JSON.stringify(n)),smartStoreUtils.queryMobileTable("recsToSync","Mobile_Table_Name",r,function(c){for(var T in c)if(console.debug("recsToSyncRec[i] = "+JSON.stringify(c[T])),c[T].Current_Connection_Session==e.cp){var b=!1,y={},P={};switch(c[T].CRUD_Operation){case"Insert":case"InsertUpdate":for(var U in a)if(c[T].Id==a[U].pd){if(a[U].crud=c[T].CRUD_Operation,P=priFromRespRec(a[U],n),"Insert"==c[T].CRUD_Operation){switch(e.stbe){case"D":R.push(P),g.push(a[U]);break;default:if("U"==a[U].pc){if(P.Id=a[U].Id,void 0!==a[U].an&&(void 0!==a[U].nf?P[a[U].nf]=a[U].an:P.Name=a[U].an),void 0!==a[U].lu)for(var O in a[U].lu)a[U].lu.hasOwnProperty(O)&&console.debug("prop",O,a[U].lu[O]),P[O]=a[U].lu[O];S.push(P),m.push(P)}}p.push(c[T]._soupEntryId)}else{if(P.Id=a[U].Id,void 0!==a[U].an&&(void 0!==a[U].nf?P[a[U].nf]=a[U].an:P.Name=a[U].an),void 0!==a[U].lu)for(var I in a[U].lu)a[U].lu.hasOwnProperty(I)&&console.debug("iUProp",I,a[U].lu[I]),P[I]=a[U].lu[I];S.push(P);var N=priFromRespRec(a[U],h);N.Id=a[U].Id,m.push(N),(y=c[T]).Current_Connection_Session=null,y.CRUD_Operation="Update",y.Id=a[U].Id,d.push(y)}b=!0;break}if(!b)for(U in C)if(console.info("failure",c[T].Id,C[U].pd),c[T].Id==C[U].pd){if(C[U].crud=c[T].CRUD_Operation,"Insert"==c[T].CRUD_Operation)switch("K",1==s?getFailBehaviour(0,C[U].fl,e):C[U].fbe){case"K":(y=c[T]).Current_Connection_Session=null,d.push(y);break;case"R":break;default:P=priFromRespRec(C[U],n),R.push(P),p.push(c[T]._soupEntryId),g.push(C[U])}else"InsertUpdate"==c[T].CRUD_Operation&&((y=c[T]).Current_Connection_Session=null,y.CRUD_Operation="Insert",d.push(y));b=!0;break}if(!b)for(U in u)if(c[T].Id==u[U].pd){if(u[U].crud=c[T].CRUD_Operation,"Insert"==c[T].CRUD_Operation)switch(u[U].fbe){case"K":(y=c[T]).Current_Connection_Session=null,d.push(y);break;case"R":break;default:P=priFromRespRec(u[U],n),R.push(P),p.push(c[T]._soupEntryId),g.push(u[U])}else"InsertUpdate"==c[T].CRUD_Operation&&((y=c[T]).Current_Connection_Session=null,y.CRUD_Operation="Insert",d.push(y));b=!0;break}break;case"Update":case"UpdateUpdate":for(U in i)if(c[T].Id==i[U].Id){if(i[U].crud=c[T].CRUD_Operation,"Update"==c[T].CRUD_Operation){switch(P=priFromRespRec(i[U],n),e.stbe){case"D":R.push(P),g.push(i[U]);break;default:if("M"==i[U].pc&&(P.SystemModstamp=new Date(i[U].sm)),void 0!==i[U].lu)for(var v in console.debug("lu",i[U].lu),i[U].lu)i[U].lu.hasOwnProperty(v)&&(P[v]=i[U].lu[v]);_.push(P),f.push(P)}p.push(c[T]._soupEntryId)}else"UpdateUpdate"==c[T].CRUD_Operation&&((y=c[T]).Current_Connection_Session=null,y.CRUD_Operation="Update",d.push(y));b=!0;break}if(!b)for(U in E)if(c[T].Id==E[U].Id){if("Update"==c[T].CRUD_Operation)switch("K",1==s?getFailBehaviour(1,E[U].fl,e):E[U].fbe){case"K":(y=c[T]).Current_Connection_Session=null,d.push(y);break;case"R":break;default:P=priFromRespRec(E[U],n),R.push(P),p.push(c[T]._soupEntryId),g.push(E[U])}else"UpdateUpdate"==c[T].CRUD_Operation&&((y=c[T]).Current_Connection_Session=null,y.CRUD_Operation="Update",d.push(y));b=!0;break}if(!b)for(U in l)if(c[T].Id==l[U].Id){if(l[U].crud=c[T].CRUD_Operation,"Update"==c[T].CRUD_Operation)switch(l[U].fbe){case"K":(y=c[T]).Current_Connection_Session=null,d.push(y);break;case"R":break;default:P=priFromRespRec(l[U],n),R.push(P),p.push(c[T]._soupEntryId),g.push(l[U])}else"UpdateUpdate"==c[T].CRUD_Operation&&((y=c[T]).Current_Connection_Session=null,y.CRUD_Operation="Update",d.push(y));b=!0;break}}}var A;console.info("priToInsertRecs",S),console.info("rtsToUpdateRecs",d),smartStoreUtils.getProxyFieldName(r).then(function(e){return A=e,m2pRespUpRecs(r,"Id",_)}).then(function(e){return console.debug("m2pRespUpRecs ("+r+") res -> "+JSON.stringify(e)),m2pRespUpRecs(r,A,S)}).then(function(e){return console.debug("m2pRespUpRecs"+r+") (PROXY KEY) res -> "+JSON.stringify(e)),m2pRespUpRecs("SnapShot_"+r,"Id",f)}).then(function(e){return console.debug("m2pRespUpRecs"+r+") (PROXY KEY) res -> "+JSON.stringify(e)),m2pRespUpRecs("SnapShot_"+r,A,m)}).then(function(e){return console.debug("m2pRespUpRecs (SnapShot_"+r+") res -> "+JSON.stringify(e)),m2pRespDelRecs(r,R)}).then(function(e){return console.debug("m2pRespDelRecs res -> "+JSON.stringify(e)),m2pRespDelRecs("SnapShot_"+r,g)}).then(function(e){return console.debug("m2pRespDelRecs (SnapShot_' + mobileTable + ') res -> "+JSON.stringify(e)),m2pRespUpRTSRecs(d)}).then(function(e){return console.debug("m2pRespUpRTSRecs res -> "+JSON.stringify(e)),m2pRespDelRTSRecs(p)}).then(function(n){return console.debug("m2pRespDelRTSRecs res -> "+JSON.stringify(n)),checkForMigrateToInfo(e)}).then(function(){var n={status:0};n.csId=e.csId,t(n)}).catch(function(e){logger.errorAndDispatch("m2pResp error for "+r,e),o(e)})},o)}).catch(function(e){logger.errorAndDispatch("Err reading table",r),o(e)})}function priFromRespRec(e,n){var t={};return"Insert"==e.crud||"InsertUpdate"==e.crud?t.Id=e.pd:t.Id=e.Id,_.findWhere(n,t)}function getFailBehaviour(e,n,t){switch(e){case 0:switch(n){case"DF":return t.ifbe;case"CV":return t.icvbe;case"FV":return t.ifvbe}break;case 1:switch(n){case"DF":return t.ufbe;case"SV":return t.usvbe;case"CV":return t.ucvbe;case"FV":return t.ufvbe;case"SD":return t.sdfbe;case"HD":return t.hdfbe}}}function addNonRespondedIds(e,n,t,o){return new Promise(function(s,r){e=JSON.parse(e);var a=t.concat(o),c=t;if(e.records&&e.records.length>n.length+a.length){var i=[];smartStoreUtils.getProxyFieldName(e.MobileTable).then(function(o){e.records.forEach(function(e){if("I"==e.RecordCRUD){var t=e.fields.find(function(e){return e.name==o}).value;_.findWhere(n,{pd:t})||_.findWhere(a,{pd:t})||i.push({pd:t,fbe:"K"})}}),i.length>0&&(c=t.concat(i)),s(c)})}else s(c)})}function querySoupRecsPromise(e){return new Promise(function(n,t){smartStoreUtils.querySoupRecords(e,function(e){n(e)},function(e){t(e)})})}function m2pRespUpRecs(e,n,t){return console.debug("m2pRespUpRecs ("+e+") updateRecs -> "+JSON.stringify(t)),new Promise(function(o,s){t.length>0?smartstore.upsertSoupEntriesWithExternalId(e,t,n,function(e){o(e)},function(e){s(e)}):o("OK")})}function m2pRespDelRTSRecs(e){return console.debug("m2pRespDelRTSRecs recsToDel -> "+JSON.stringify(e)),new Promise(function(n,t){e.length>0?smartstore.removeFromSoup("recsToSync",e,function(e){n(e)},function(e){t(e)}):n("OK")})}function m2pRespUpRTSRecs(e){return console.debug("m2pRespUpRTSRecs recsToUp -> "+JSON.stringify(e)),new Promise(function(n,t){e.length>0?smartstore.upsertSoupEntries("recsToSync",e,function(e){n(e)},function(e){t(e)}):n("OK")})}function m2pRespDelRecs(e,n){return console.debug("m2pRespDelRecs ("+e+") recsToDel -> "+JSON.stringify(n)),new Promise(function(t,o){if(n.length>0)if(-1==e.indexOf("SnapShot"))smartStoreUtils.deleteRecordsFromSoup(n,e,function(e){t(e)},function(e){o(e)});else{console.debug("Deleting from SnapShot ",e);var s=n.filter(function(e){return e&&"Insert"==e.crud&&(e.Id=e.pd),null!==e&&void 0!==e});smartStoreUtils.deleteRecordsForExternalId(e,s,"Id",function(e){t(e)},function(e){logger.errorAndDispatch(e),o(e)})}else t("OK")})}function clearRTSRecs(e,n,t){console.log("clearRTSRecs",e),smartStoreUtils.queryMobileTable("recsToSync","Current_Connection_Session",e,function(e){if(0!==e.length){for(var o=0;o<e.length;o++)e[o].Current_Connection_Session=null,"InsertUpdate"==e[o].CRUD_Operation?e[o].CRUD_Operation="Insert":"UpdateUpdate"==e[o].CRUD_Operation&&(e[o].CRUD_Operation="Update");smartstore.upsertSoupEntries("recsToSync",e,n,t)}else n()},t)}var CLEAN_CS_OK=100600;function cleanConnectionSessionVFEvent(e,n,t,o){var s={bogus:!0};"exception"===e.type?s.status=HEARTBEAT_EXCEPTION:s.status=HEARTBEAT_FAILURE,cleanConnectionSessionHeartBeat(s,n,t,o)}function cleanConnectionSessionHeartBeat(e,n,t,o){console.log("in clean connection session heart beat");var s={},r=null;e.status==HEARTBEAT_NO_CONNECTION?"Sync - Refresh"==n.connSessionRec.mobilecaddy1__Session_Type__c?r="P2M RE Heartbeat No Connection":"Status Check"==n.connSessionRec.mobilecaddy1__Session_Type__c&&(r="M2P SC Heartbeat No Connection"):e.status==HEARTBEAT_EXCEPTION?"Sync - Refresh"==n.connSessionRec.mobilecaddy1__Session_Type__c?r=e.bogus?"P2M RE Exception/Timeout":"P2M RE Heartbeat Exception/Timeout":"Status Check"==n.connSessionRec.mobilecaddy1__Session_Type__c&&(r=e.bogus?"M2P SC Exception/Timeout":"M2P SC Heartbeat Exception/Timeout"):e.status==HEARTBEAT_FAILURE&&("Sync - Refresh"==n.connSessionRec.mobilecaddy1__Session_Type__c?r=e.bogus?"P2M RE Failure":"P2M RE Hearbeat Failure":"Status Check"==n.connSessionRec.mobilecaddy1__Session_Type__c&&(r=e.bogus?"M2P SC Failure":"M2P SC Heartbeat Failure")),null!==r?(n.connSessionRec.mobilecaddy1__Mobile_Process_Status__c=r,n.connSessionRec.SystemModstamp=(new Date).getTime(),n.connSessionRec.mobilecaddy1__Status__c="Closed",console.log("Upserting connection session"),smartstore.upsertSoupEntries("Connection_Session__mc",[n.connSessionRec],function(){s.status=CLEAN_CS_OK,s.mc_add_status=e.status,t(s)},o)):(logger.error("Unknown heartBeatObject.status. ",e.status),o())}function maybeSyncConnSess(e,n,t){var o={};console.debug("maybeSyncConnSess"),smartStoreUtils.querySoupRecsPromise("recsToSync").then(function(s){console.debug("Success from readRecords recsToSync -> "+JSON.stringify(s));var r=_.filter(s,function(e){return void 0!==e.currentConnectionSession});console.debug("connSessRTS -> "+JSON.stringify(r)),r.length>1||"M2P Conn_Sess Records Processed"!=e.mobilecaddy1__Mobile_Process_Status__c?syncMobileTable("Connection_Session__mc").then(function(e){console.debug("syncMobileTable -> ",JSON.stringify(e)),o.status=0,n(o)}).catch(function(e){logger.warn("syncMobileTable ERROR -> ",e),t(e)}):(console.debug("maybeSyncConnSess - not syncing"),o.status=0,n(o))}).catch(function(e){logger.error("querySoupRecsPromise ERROR -> ",e),t(e)})}function postProcessConnectionSession(e){return new Promise(function(n,t){var o=function(e){logger.error("postProcessConnectionSession error",e),t(e)},s=Array.isArray(e)?e:[e],r={};smartstore.upsertSoupEntries("Connection_Session__mc",s,function(t){var a=Array.isArray(e);a=s.map(function(e){return{Id:e.Id,SystemModstamp:e.SystemModstamp-1,mobilecaddy1__Session_Type__c:null,mobilecaddy1__Mobile_Process_Status__c:null,mobilecaddy1__Session_Created_Location_Error__c:null,mobilecaddy1__MC_Proxy_ID__c:null}}),smartstore.upsertSoupEntries("SnapShot_Connection_Session__mc",a,function(e){var t=e.map(function(e){return{Mobile_Table_Name:"Connection_Session__mc",CRUD_Operation:"Update",SOUP_Record_Id:e._soupEntryId,Id:e.Id,LastModifiedDateTime:e.SystemModstamp}});smartstore.upsertSoupEntries("recsToSync",t,function(){console.log("success from upsert of recs to sync"),r.status=0,n(r)},o)},o)},o)})}function handleUpdatedCS(e){return new Promise(function(n,t){console.log("handleUpdatedCS",e);e&&e.us&&0!==e.us.length?smartStoreUtils.deleteRecordsForExternalId("Connection_Session__mc",e.us,"Id").then(function(n){return smartStoreUtils.deleteRecordsForExternalId("SnapShot_Connection_Session__mc",e.us,"Id")}).then(function(n){return smartStoreUtils.deleteRecordsForExternalId("recsToSync",e.us,"Id")}).then(function(e){console.log("handleUpdatedCS -> deleted from CS and RTS OK"),n()}).catch(function(e){logger.error("handleUpdatedCS",e),n()}):n(),e&&e.uf&&0!==e.uf.length&&logger.error("handleUpdatedCS -> we have uf",e.uf)})}function getSyncRecFailures(e){return e?localStorage.getItem(MC_FAILURE_KEY_PREFIX+e)?JSON.parse(localStorage.getItem(MC_FAILURE_KEY_PREFIX+e)):{}:getAllSyncRecFailures()}function getAllSyncRecFailures(){var e=[];return getSyncFailureTableKeys().forEach(function(n){var t=getSyncRecFailures(n.replace(MC_FAILURE_KEY_PREFIX,""));_.isEmpty(t)||e.push({table:n.replace(MC_FAILURE_KEY_PREFIX,""),failures:t})}),e}function getSyncFailureTableKeys(){for(var e=[],n=0,t=localStorage.length;n<t;++n)localStorage.key(n).startsWith(MC_FAILURE_KEY_PREFIX)&&e.push(localStorage.key(n));return e}function storeSyncFailures(e,n){if(n){var t={};n.forEach(function(e){t[e.Id]=e}),console.log("f",t),localStorage.setItem(MC_FAILURE_KEY_PREFIX+e,JSON.stringify(t))}else localStorage.removeItem(MC_FAILURE_KEY_PREFIX+e)}function checkForMigrateToInfo(e){return new Promise(function(n,t){null!==e.migrateTo&&void 0!==e.migrateTo?appDataUtils.updateNewValueInAppSoup("dynVersionNumber",e.migrateTo).then(function(){n()}).catch(function(e){logger.error(e),t(e)}):n()})}function _handleRefreshResponse(e){return new Promise(function(n,t){handleRefreshResponse(e,function(){n()},function(e){t(e)})})}exports.CSINHEAD_SYNC_VSN=CSINHEAD_SYNC_VSN,exports.SYNC=SYNC,exports.SYNC_ALREADY_IN_PROGRESS_INC=SYNC_ALREADY_IN_PROGRESS_INC,exports.SYNC_NOK_STATUS=SYNC_NOK_STATUS,exports.refreshToken=refreshToken,exports.genProxyId=genProxyId,exports.addProxyIds=addProxyIds,exports.getSyncRecFailures=getSyncRecFailures,exports.P2M_REFRESH_OK=P2M_REFRESH_OK,exports.p2mRefreshTable=p2mRefreshTable,exports.buildConnectionSession=buildConnectionSession,exports.M2P_UPDATE_OK=M2P_UPDATE_OK,exports.M2P_NO_RECS_TO_SYNC=M2P_NO_RECS_TO_SYNC,exports.m2pUpdateMobileTable=m2pUpdateMobileTable,exports.m2pRecoveryUpdateMobileTable=m2pRecoveryUpdateMobileTable,exports.HEARTBEAT_OK=HEARTBEAT_OK,exports.HEARTBEAT_EXCEPTION=HEARTBEAT_EXCEPTION,exports.HEARTBEAT_FAILURE=HEARTBEAT_FAILURE,exports.HEARTBEAT_NO_CONNECTION=HEARTBEAT_NO_CONNECTION,exports.HEARTBEAT_NOT_DEVICE=HEARTBEAT_NOT_DEVICE,exports.HEARTBEAT_REFRESHED_OK=HEARTBEAT_REFRESHED_OK,exports.heartBeat=heartBeat,exports._handleRefreshResponse=_handleRefreshResponse,exports.createUpdateJson=createUpdateJson,exports.syncMobileTable=syncMobileTable,exports.getRTSPendingconnSess=getRTSPendingconnSess,exports.CLEAN_CS_OK=CLEAN_CS_OK,exports.cleanConnectionSessionHeartBeat=cleanConnectionSessionHeartBeat,exports.cleanConnectionSessionVFEvent=cleanConnectionSessionVFEvent,exports.CONN_SESS_OK=CONN_SESS_OK,exports.csStatusCheck=csStatusCheck,exports.maybeSyncConnSess=maybeSyncConnSess,exports.processM2PUpdateResponse=processM2PUpdateResponse,exports.postProcessConnectionSession=postProcessConnectionSession,exports.handleUpdatedCS=handleUpdatedCS;