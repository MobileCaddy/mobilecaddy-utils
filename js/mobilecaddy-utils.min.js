/*! mobilecaddy-utils - v1.9.1 - Bundle Time: 2018-08-09 11:11:20 */
/* git info: "2018-08-02 13:44:57 +0100": 6fbcd0a96f33b8c1b7a444e5012fd6e80772cf7d (HEAD) */
/* Copyright 2018 MobileCaddy Ltd */
String.prototype.includes||(String.prototype.includes=function(a,b){"use strict";return"number"!=typeof b&&(b=0),!(b+a.length>this.length)&&-1!==this.indexOf(a,b)}),Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(a){if(null==this)throw new TypeError('"this" is null or not defined');var b=Object(this),c=b.length>>>0;if("function"!=typeof a)throw new TypeError("predicate must be a function");for(var d=arguments[1],e=0;e<c;){var f=b[e];if(a.call(d,f,e,b))return f;e++}},configurable:!0,writable:!0});var $j=jQuery.noConflict(),MC_TABLES=["Connection_Session__mc","Mobile_Log__mc","MC_Project__ap","MC_Time_Expense__ap","MC_Project_Location__ap"];!function(){var a,b;!function(){function c(b){var c=b.factory;return b.exports={},delete b.factory,c(a,b.exports,b),b.exports}var d={},e=[],f={};a=function(a){if(d[a]){if(a in f){var b=e.slice(f[a]).join("->")+"->"+a;console.error("Cycle in require graph: "+b)}}else console.error("module "+a+" not found");if(d[a].factory)try{return f[a]=e.length,e.push(a),c(d[a])}finally{delete f[a],e.pop()}return d[a].exports},b=function(a,b){d[a]&&console.error("module "+a+" already defined"),d[a]={id:a,factory:b}},b.remove=function(a){delete d[a]}}(),"object"==typeof module&&"function"==typeof a&&(module.exports.require=a,module.exports.define=b),b("mobileCaddy",function(a,c,d){var e={define:b,require:a,START_PAGE_CONTROLLER:"",QUERY_BUFFER_SIZE:1e3,QUERY_BUFFER_SIZE_SL:1e3,INITIAL_APPCACHE_INFO:[]};d.exports=e}),b("mobileCaddy/mobileLogger",function(a,b,c){function d(){try{throw Error("")}catch(a){return a}}function e(a,b){var c=b.stack.split("\n")[4],d="";if(void 0!==c){var e=c.indexOf("at ");d=c.slice(e+2,c.length)}console.log(a,d)}function f(a,b){throw e(a,b),a}function g(a,b){for(var c in a)e("field:"+c+": has value :"+a[c]+":",b)}c.exports={logMessageAndThrow:function(a){f(a,d())},logMessage:function(a){e(a,d())},logObjectDetails:function(a){g(a,d())}}}),b("mobileCaddy/geolocation",function(a,b,c){function d(a,b){var c=[];c.Error="Location information is unavailable.",c.ErrorNumber=2,a(c)}c.exports={getLocation:function(a,b){d(a,b)}}}),b("mobileCaddy/startup",function(a,b,c){function d(){return new Promise(function(a,b){var c=[{path:"Mobile_Table_Name",type:"string"},{path:"SOUP_Record_Id",type:"string"},{path:"Id",type:"string"},{path:"LastModifiedDateTime",type:"integer"},{path:"CRUD_Operation",type:"string"},{path:"Current_Connection_Session",type:"string"}];l.registerSoup("recsToSync",c,function(){a()},function(a){b(a)})})}function e(a){mobileCaddy.INITIAL_APPCACHE_INFO=[],console.log("checkCache entry"),window.applicationCache.addEventListener("checking",function(a){f(a)},!1),window.applicationCache.addEventListener("downloading",function(a){f(a)},!1),window.applicationCache.addEventListener("progress",function(a){f(a)},!1),mobileCaddy.INITIAL_APPCACHE_INFO.push({Name:"AppCache: Initial Status",Description:window.applicationCache.status});var b={};switch(b.status=o,window.applicationCache.status){case window.applicationCache.CHECKING:case window.applicationCache.DOWNLOADING:throw window.applicationCache.addEventListener("updateready",function(b){f(b,a)},!1),window.applicationCache.addEventListener("cached",function(b){f(b,a)},!1),window.applicationCache.addEventListener("error",function(b){f(b,a)},!1),window.applicationCache.addEventListener("noupdate",function(b){f(b,a)},!1),new Error("MobileCaddy - Cache busy.  Will continue when check/load is complete");case window.applicationCache.UPDATEREADY:window.applicationCache.swapCache(),a(b),console.log("cache in updateready");break;default:console.log("cache in default"),a(b)}}function f(a,b){"progress"==a.type?(console.log("cache in progress"),mobileCaddy.INITIAL_APPCACHE_INFO.push({Name:"Event ",Description:a.loaded+" of "+a.total})):mobileCaddy.INITIAL_APPCACHE_INFO.push({Name:"Event ",Description:a.type});var c={};"udpateready"==a.type||(a.type="cached")?(console.log("cache in update ready or cached"),c.status=o):(console.log("cache in else"),c.status=p),console.log("return object "),k.logObjectDetails(c),b&&"function"==typeof b&&b(c)}function g(a){$j(function(){e(function(b){h(a,b)})})}function h(a,b){console.log("prep platform cache status = "+b);var c=j("appSoupJson");if(""!==c){console.log("app soup json = "+JSON.stringify(c));var d=$j.parseJSON(c),e=[{path:"Name",type:"string"},{path:"CurrentValue",type:"string"},{path:"NewValue",type:"string"}];l.registerSoup("appSoup",e,function(){l.upsertSoupEntries("appSoup",d,function(c){var d=[{path:"Name",type:"string"},{path:"Description",type:"string"}];l.registerSoup("cacheSoup",d,function(){i(a,b)},function(a){k.logMessage("Failed to create cache soup with error = "+a)})},function(a){k.logMessage("Failed to update app soup with error = "+a)})},function(a){k.logMessage("Failed to register app soup with error = "+a)})}else console.log("app soup json2 = "+c),LOCAL_DEV?(cacheSoupStructure=[{path:"Name",type:"string"},{path:"Description",type:"string"}],l.registerSoup("cacheSoup",cacheSoupStructure,function(){i(a,b)})):navigator.appVersion.includes("Electron")?l.soupExists("appSoup",function(c){if(c)i(a,b);else{var d=[],e=ipcRenderer.sendSync("request-creds","");console.log("creds",e);j("access_token","?"+e);if(d.push({Name:"accessToken",CurrentValue:j("access_token","?"+e),NewValue:null}),d.push({Name:"refreshToken",CurrentValue:j("refresh_token","?"+e),NewValue:null}),d.push({Name:"clientId",CurrentValue:j("client_id","?"+e),NewValue:null}),d.push({Name:"orgId",CurrentValue:j("org_id","?"+e),NewValue:null}),d.push({Name:"applicationName",CurrentValue:j("buildName","?"+e),NewValue:null}),d.push({Name:"buildName",CurrentValue:j("buildName","?"+e),NewValue:null}),window.location.pathname.startsWith("/apex/"))d.push({Name:"loginUrl",CurrentValue:window.location.protocol+"//"+window.location.host,NewValue:null});else{var f=window.location.pathname.split("/"),g=f[1];d.push({Name:"loginUrl",CurrentValue:window.location.protocol+"//"+window.location.host+"/"+g,NewValue:null})}var h=ipcRenderer.sendSync("request-device-info","");console.log("Device from Electron",JSON.stringify(h)),d.push({Name:"buildStatus",CurrentValue:"Initial"}),d.push({Name:"buildVersion",CurrentValue:h.buildVersion}),d.push({Name:"buildOS",CurrentValue:h.platform}),d.push({Name:"deviceUuid",CurrentValue:h.uuid});var m=[{path:"Name",type:"string"},{path:"CurrentValue",type:"string"},{path:"NewValue",type:"string"}];l.registerSoup("appSoup",m,function(){l.upsertSoupEntries("appSoup",d,function(c){var d=[{path:"Name",type:"string"},{path:"Description",type:"string"}];l.registerSoup("cacheSoup",d,function(){i(a,b)},function(a){k.logMessage("Failed to create cache soup with error = "+a)})},function(a){k.logMessage("Failed to update app soup with error = "+a)})},function(a){k.logMessage("Failed to register app soup with error = "+a)})}}):(document.addEventListener("deviceready",function(){i(a,b)},!1),document.addEventListener("backbutton",function(){},!0))}function i(b,c){console.debug("cache status = "+JSON.stringify(c));a("mobileCaddy/logger");l.upsertSoupEntries("cacheSoup",mobileCaddy.INITIAL_APPCACHE_INFO,function(){n.querySoupRecsPromise("appSoup").then(function(e){var f={},g=[];if(e.forEach(function(a){if(void 0!==f[a.Name])throw"Should only be 1 "+a.Name+" entry in the app soup.  Found more";f[a.Name]=a}),f.userOverrideId||(f.userOverrideId=""),"Complete"==f.buildStatus.CurrentValue&&"Complete"==f.buildStatus.NewValue){if(null!==b){k.logMessage("build already complete - calling 3rd party callback function");var h={};if(h.status=r,h.mc_add_status=c.status,h.curVsn=f.dynVersionNumber.CurrentValue,void 0!==f.dynVersionNumber.NewValue&&(h.newVsn=f.dynVersionNumber.NewValue),navigator.appVersion.includes("Electron")){var i=window.location.protocol+"//"+window.location.host+window.location.pathname;ipcRenderer.send("startPageUrl",i)}b(h)}}else{var j=function(a,e){if(e.status){k.logMessage("Parse json aud"+a),g=$j.parseJSON(a);var h=_.find(g,{Name:"audId"}).CurrentValue,i=_.find(g,{Name:"sysDataPlatSupVersion"}).CurrentValue;if(navigator.appVersion.includes("Electron")){var j=window.location.protocol+"//"+window.location.host+window.location.pathname;ipcRenderer.send("startPageUrl",j)}d().then(function(){m.createSystemDataSoup(function(){n.buildMobileTables(function(){var a=f.buildStatus;a.CurrentValue="Complete",a.NewValue="Complete",g.map(function(a){return f[a.Name]&&(a._soupEntryId=f[a.Name]._soupEntryId),a}),g.push(a),l.upsertSoupEntries("appSoup",g,function(){m.getRecordTypeDots(h,i).then(function(){if(null!==b){var a={};a.status=q,a.mc_add_status=c.status,k.logMessage("Calling 3rd party callback"),k.logObjectDetails(a),b(a)}}).catch(function(a){k.logMessage("From getRecordTypeDots "+a)})},function(a){k.logMessage("From upsert soup records "+a)})},function(a){k.logMessage("Error building mobile tables "+a)})},function(a){k.logMessage("create system data soup returned error"+a)},h,i),k.logMessage("Exiting startup")}).catch(function(a){k.logMessage("Error building recs to sync soup "+a)})}else"exception"===e.type&&alert(e.message)};a("mobileCaddy/syncRefresh").heartBeat(function(a){console.log("getAudInfo heartbeat response",a),!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/getAUDInfo001",contentType:"application/json",data:{buildVersion:f.buildVersion.CurrentValue,buildName:f.buildName.CurrentValue,buildOS:f.buildOS.CurrentValue,deviceUuid:f.deviceUuid.CurrentValue,overrideUserId:force.getUserId(),startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN}},function(a){console.info("response -> "+JSON.stringify(a));var b={};b.status="200",j(a,b)},function(a){console.error("err -> "+JSON.stringify(a)),error()}):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".getAudInfo",f.buildVersion.CurrentValue,f.buildName.CurrentValue,f.buildOS.CurrentValue,f.deviceUuid.CurrentValue,f.userOverrideId,j,{escape:!1,timeout:3e4})},function(a){console.log("getAudInfo heartbeat error",a),error()})}}).catch(function(a){console.error(a)})},function(a){k.logMessage("Failed to update app soup with initial app cache info = "+a)})}function j(a,b){b||(b=window.location.search),console.info("getUrlParamByName -> name = "+a),a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var c="[\\?&]"+a+"=([^&#]*)",d=new RegExp(c),e=d.exec(b);return console.log("getUrlParamByName results -> "+e),null===e?"":decodeURIComponent(e[1].replace(/\+/g," "))}var k=a("mobileCaddy/mobileLogger"),l=(a("mobileCaddy/logger"),cordova.require("com.salesforce.plugin.smartstore")),m=a("mobileCaddy/systemData"),n=a("mobileCaddy/smartStoreUtils");a("mobileCaddy/appDataUtils");console.log("Startup error listener"),window.addEventListener("error",function(a){var b=a.error?a.error.stack:null,c=a.error.toString();b&&(c+="\n"+b),console.log("Error event listener fired",JSON.stringify(c))});var o=100900,p=100901,q=100800,r=100801;c.exports={startup:function(a){g(a)}}}),b("mobileCaddy/systemData",function(a,b,c){function d(a,b,c,d){console.log("In populate system data row values");var e=function(a,b){if(b.status){console.log("In remoting callback for getSysDataSoupVariables with record count = "+a.length);var e=$j.parseJSON(a);console.log("Parse json soup field defns done"),l.upsertSoupEntries("syncLib_system_data",e,c,d)}else"exception"===b.type?(alert(b.message),k.error("Exception return from getSystemDataRowValues = "+b.message)):k.error("Unknown return from getSystemDataRowValues = "+b.message)};!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/getSysDataSoupVariables001",contentType:"application/json",data:{audId:a,startPageControllerVersion:j.START_PAGE_CONTROLLER_VSN,systemDataPlatformSupportVersion:b}},function(a){var b={};b.status="200",e(a,b)},d):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+j.START_PAGE_CONTROLLER+".getSysDataSoupVariables",a,b,e,{escape:!1})}function e(a,b,c,d){console.log("In createSystemDataSoup"),void 0!==c&&void 0!==d?f(c,d,a,b):m.getCurrentValueFromAppSoup("audId").then(function(a){return c=a,m.getCurrentValueFromAppSoup("sysDataPlatSupVersion")}).then(function(d){console.log("In success callback with aud id = "+c),f(c,d,a,b)}).catch(function(a){b(a)})}function f(a,b,c,e){console.log("In getSystemDataSoupDefinition with audId = "+a+" and sysDataPlatSupVersion = "+b);var f=function(f,h){if(h.status){console.log("In getSystemDataSoupDefinition callback -> "+f),console.log("Parse json app defns"+f);var j=$j.parseJSON(f);console.log("Parse json app defns done"),$j.each(j,function(a,b){i.logObjectDetails(b)}),l.registerSoup("syncLib_system_data",j,function(){d(a,b,function(){g(a,b,c,e)},e)},e)}else"exception"===h.type?(alert(h.message),k.error("Exception return from getSystemDataSoupDefinition = "+h.message)):k.error("Unknown return from getSystemDataSoupDefinition = "+h.message)};!0===USE_FORCETK?(console.debug("USE_FORCETK == true"),force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/getSystemDataSoupDefinition001",contentType:"application/json",data:{audId:a,startPageControllerVersion:j.START_PAGE_CONTROLLER_VSN,systemDataPlatformSupportVersion:b}},function(a){var b={};b.status="200",f(a,b)},e)):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+j.START_PAGE_CONTROLLER+".getSystemDataSoupDefinition",a,b,f,{escape:!1})}function g(a,b,c,d){console.log(j.START_PAGE_CONTROLLER+".getDefsForSObjectMobileTables");var e=function(a,b){if(b.status){var e=$j.parseJSON(a);console.log("Parse json table defns done"),l.upsertSoupEntries("syncLib_system_data",e,function(a){console.log("successful upsert with rec count = "+a.length),c(a)},function(a){k.error("Error returned from upsert, message =  "+a),d(a)})}else"exception"===b.type?(alert(b.message),k.error("Exception return from getDefsForSObjectMobileTables = "+b.message)):k.error("Unknown return from getDefsForSObjectMobileTables = "+b.message)};!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/getDefsForSObjectMobileTables001",contentType:"application/json",data:{audId:a,startPageControllerVersion:j.START_PAGE_CONTROLLER_VSN,systemDataPlatformSupportVersion:b}},function(a){var b={};b.status="200",e(a,b)},d):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+j.START_PAGE_CONTROLLER+".getDefsForSObjectMobileTables",a,b,e,{escape:!1,timeout:12e4})}function h(a){return new Promise(function(b,c){var d,e=function(a,e){if(console.log("getRecordTypeDots",d,a),e.status){var f=[{path:"Table",type:"string"},{path:"Data",type:"string"}];l.registerSoup("dotsRecordTypes",f,function(d){var e=JSON.parse(a).map(function(a){return{Table:a.mobileTableName,Data:JSON.stringify(a.recTypeInfoList)}});console.log("upsertRecs",e),l.upsertSoupEntries("dotsRecordTypes",e,function(c){console.log("successful upsert with rec count = "+c.length);var d={};JSON.parse(a).forEach(function(a){var b={};a.recTypeInfoList.forEach(function(a){a.recTypeDevName?(b[a.recTypeId]={recTypeName:a.recTypeName,recTypeDevName:a.recTypeDevName},b[a.recTypeName]=a.recTypeId,b[a.recTypeDevName]=a.recTypeId):(b[a.recTypeId]=a.recTypeName,b[a.recTypeName]=a.recTypeId)}),d[a.mobileTableName]=b}),localStorage.setItem("lsDotsRecordTypes",JSON.stringify(d)),b()},function(a){k.error("Error returned from upsert, message =  "+a),c(a)})},function(a){c(a)})}else"exception"===e.type?(k.error("Exception return from p2mRefreshRecTypeDOTs = "+e.message),c(e.message)):(k.error("Unknown return from p2mRefreshRecTypeDOTs = "+e.message),c(e.message))};m.getCachedCurrentValueFromAppSoup("syncRefreshVersion").then(function(b){d=b,!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/p2mRefreshRecTypeDOTs001",contentType:"application/json",data:{audId:a,startPageControllerVersion:j.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:d,connSessJson:"{}"}},function(a){var b={};b.status="200",e(a,b)},function(a){e("[]",{status:"OK"})}):Visualforce.remoting.Manager.getAction("mobilecaddy1."+j.START_PAGE_CONTROLLER+".p2mRefreshRecTypeDOTs")?Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+j.START_PAGE_CONTROLLER+".p2mRefreshRecTypeDOTs",a,d,"{}",e,{escape:!1,timeout:12e4}):e("[]",{status:"OK"})})})}var i=a("mobileCaddy/mobileLogger"),j=a("mobileCaddy"),k=a("mobileCaddy/logger"),l=cordova.require("com.salesforce.plugin.smartstore"),m=(j.require("mobileCaddy/smartStoreUtils"),a("mobileCaddy/appDataUtils"));c.exports={createSystemDataSoup:function(a,b,c,d){e(a,b,c,d)},getRecordTypeDots:h}}),b("mobileCaddy/smartStoreUtils",function(a,b,c){function d(a,b,c){D.soupExists(a,function(d){d?D.soupExists("SnapShot_"+a,function(d){d?i("SnapShot_"+a,function(d){x(d,"SnapShot_"+a,function(){i(a,function(d){D.upsertSoupEntries("SnapShot_"+a,d,b,c)},c)},c)},c):C.logMessageAndThrow("SnapShot Table is missing: SnapShot_"+a)},c):C.logMessageAndThrow("Mobile Table is missing"+a)},c)}function e(a,b,c,d,e){if(!d&&!e)return new Promise(function(d,e){if(0===b.length)d();else{var f="";"object"==typeof b[0]?b.forEach(function(a,b){f+=0===b?"'"+a[c]+"'":",'"+a[c]+"'"}):b.forEach(function(a,b){f+=0===b?"'"+a+"'":", '"+a+"'"});var g="SELECT {"+a+":_soupEntryId} FROM {"+a+"} WHERE {"+a+":"+c+"} IN ("+f+")";console.log("deleteRecordsForExternalId soql",g),querySpec=D.buildSmartQuerySpec(g,1e4),l(querySpec,function(b){console.log("recs",b);var c=b.map(function(a){return a[0]});D.removeFromSoup(a,c,function(a){d(a)},function(a){e(a)})},function(a){e(a)})}});if(0===b.length)d();else{var f=[];$j.each(b,function(a,b){f.push(b[c])});var g="";b.forEach(function(a,b){g+=0===b?"'"+a[c]+"'":",'"+a[c]+"'"});var h="SELECT {"+a+":_soupEntryId} FROM {"+a+"} WHERE {"+a+":"+c+"} IN ("+g+")";console.log("deleteRecordsForExternalId soql",h),querySpec=D.buildSmartQuerySpec(h,1e4),l(querySpec,function(b){console.log("recs",b);var c=b.map(function(a){return a[0]});D.removeFromSoup(a,c,function(a){d()},function(a){e(a)})},function(a){e(a)})}}function f(a,b,c){function d(a){$j.each(a.currentPageOrderedEntries,function(a,b){g.push(b)}),a.currentPageIndex<a.totalPages-1?cordova.require("com.salesforce.plugin.smartstore").moveCursorToNextPage(a,d):cordova.require("com.salesforce.plugin.smartstore").closeCursor(a,e,f)}function e(a){b(g)}function f(a){if(console.error("onCursorClosedError",a),console.error("onCursorClosedError",a.stack),!c)throw a;c(a)}var g=[];d(a)}function g(a,b,c){k("syncLib_system_data",D.buildExactQuerySpec("Name",a,mobileCaddy.QUERY_BUFFER_SIZE),function(a){console.log("soup definition rows success callback with rec count = "+a.length);var c=[];$j.each(a,function(a,b){console.log("processing record = "),b.Type!=mobileCaddy.STANDING_DATA_OBJECT&&b.Type!=mobileCaddy.DYNAMIC_DATA_OBJECT?(console.log("Record Match"),c.push(b)):console.log("Record does not match")}),b(c)},c)}function h(a,b,c){console.log("in getQueryAndSoupDefinition");var d=[],e="Select ";$j.each(a,function(a,b){console.log("soup column defn = "),d.push({path:b.Column_Name,type:b.Column_Type}),0!==b.Column_Name.indexOf("_")&&(e+=b.Column_Name+",")}),e=e.substring(0,e.length-1),e+=" From "+a[0].Name,b(e,d)}function i(a,b,c){var d=D.buildAllQuerySpec("_soupEntryId",null,mobileCaddy.QUERY_BUFFER_SIZE);D.querySoup(a,d,function(a){f(a,function(a){b(a)},c)})}function j(a){return new Promise(function(b,c){i(a,function(a){b(a.filter(function(a){return"object"==typeof a}))},function(a){c(a)})})}function k(a,b,c,d){D.querySoup(a,b,function(b){f(b,function(b){console.log("Passing records back to callback for soup = "+a+" and rec count = "+b.length),c(b)},d)},d)}function l(a,b,c){console.debug("smartQuerySoupRecordsWithQuerySpec",a),D.runSmartQuery(a,function(a){f(a,function(a){console.log("Passing records back to callback for soup with rec count = "+a.length),b(a)},c)},c)}function m(a,b,c,d,e){if(void 0===d&&void 0===e)return new Promise(function(d,e){var f=D.buildExactQuerySpec(b,c,mobileCaddy.QUERY_BUFFER_SIZE_SL);k(a,f,function(a){d(a)},function(a){e(a)})});var f=D.buildExactQuerySpec(b,c,mobileCaddy.QUERY_BUFFER_SIZE_SL);k(a,f,function(a){d(a)},e)}function n(a,b,c,d,e,f,g){k(a,D.buildExactQuerySpec(b,c,mobileCaddy.QUERY_BUFFER_SIZE_SL),function(a){var b=[];$j.each(a,function(a,c){c[d]==e&&b.push(c)}),f(b)},g)}function o(a,b,c){r("Row Mapping PT","Mobile Table Name",function(d){n("syncLib_system_data","MC_Var_String_001","Platform Table Definition",d,a,function(c){1!=c.length&&C.logMessageAndThrow("Should be exactly 1 table defn row for table: "+a+", but we got "+c.length),b(c[0])},c)},c)}function p(a,b){return new Promise(function(c,d){o(a,function(a){r("Row Mapping PT",b,function(b){c(a[b])},function(a){d(a)})},function(a){d(a)})})}function q(a,b,c){return new Promise(function(d,e){o(a,function(a){r("Row Mapping PT",b,function(b){a[b]=c,D.upsertSoupEntries("syncLib_system_data",[a],function(){d()},function(a){e(a)})},function(a){e(a)})},function(a){e(a)})})}function r(a,b,c,d){var e=a+"_"+b,f=localStorage.getItem(e);f?c(f):n("syncLib_system_data","MC_Var_String_001",a,"MC_Var_String_003",b,function(d){1!=d.length&&($j.each(d,function(a,b){C.logObjectDetails(b)}),C.logMessageAndThrow("Must be exactly 1 Row Mapping Record for Sys Data Row Type = "+a+" and Sys Data Row Value = "+b+" found count = "+d.length)),localStorage.setItem(e,d[0].MC_Var_String_004),c(d[0].MC_Var_String_004)},d)}function s(a,b,c,d){k("syncLib_system_data",D.buildExactQuerySpec("MC_Var_String_001",a,mobileCaddy.QUERY_BUFFER_SIZE_SL),function(d){var e=[];$j.each(b,function(b,c){var f=!1;if($j.each(d,function(a,b){if(b.MC_Var_String_003==c)return e.push(b.MC_Var_String_004),void(f=!0)}),!f)throw"No mapping found for type = "+a+" and value = "+c}),c(e)},d)}function t(a,b,c){s("Row Mapping PT",["Mobile Table Name","Build Order"],function(d){var e=d[0],f=d[1];m("syncLib_system_data","MC_Var_String_001","Platform Table Definition",function(c){var d=[];a==F?(c.sort(function(a,b){var c=0,d=parseInt(a[f]),e=parseInt(b[f]);return isNaN(d)||isNaN(e)||(c=d-e),c}),$j.each(c,function(a,b){d.push(b[e])}),null!==b&&b(d)):($j.each(c,function(a,b){d.push(b[e])}),a==E&&d.sort(),null!==b&&b(d))},c)},c)}function u(a,b,c,d){s("Row Mapping TC",["Parent SOUP Name","Table Column Name","Mobile Column Type","Application Field CRUD","META isNillable","Platform Column Type","Device Value Type","Proxy Ref Field Name"],function(d){var e=d[0],f=d[1],g=d[2],h=d[3],i=d[4],j=d[5],k=d[6],l=d[7];n("syncLib_system_data","MC_Var_String_001","Platform Table Column",e,a,function(a){var d=[];$j.each(a,function(a,c){b==G?d.push(c[f]):b==I?d.push({path:c[f],type:c[g],crud:c[h],nillable:c[i],platColType:c[j],appColType:c[k],proxyRefField:c[l]}):(d.push({path:c[f],type:c[g]}),console.log("path = "+c[f]+" and type = "+c[g]))}),c(d)},function(a){C.logMessage("Error retrieving column names = "+a)})},d)}function v(a,b){b.forEach(function(b){b.path.includes("MC_Proxy_ID")&&localStorage.setItem("proxyField-"+a,b.path)})}function w(a,b){console.debug("About to buildMobileTables"),console.time("buildMobileTables"),t(F,function(c){var d=c.length;$j.each(c,function(c,e){u(e,H,function(c){console.debug("tableColumnObjectArray -> "+c),D.registerSoup(e,c,function(){console.log("success on register soup "+e),q(e,"SOUP Built Date/Time",(new Date).getTime()).then(function(){return console.log("success on update of soup build date time"),v(e,c),p(e,"Snapshot Data Required")}).then(function(f){"Yes"==f?D.registerSoup("SnapShot_"+e,c,function(){console.log("Success from build of SnapShot_"+e),q(e,"Snapshot SOUP Built Date/Time",(new Date).getTime()),0===--d&&(console.timeEnd("buildMobileTables"),a())},function(a){console.error("Fail on create of SnapShot_"+e+" "+a),b(a)}):0===--d&&(console.timeEnd("buildMobileTables"),a())}).catch(function(a){b(a)})},b)},function(a){console.error("Fail on create of table"+e+" "+a),b(a)})})},b)}function x(a,b,c,d){if(console.log("In delete recs from soup with rec count = "+a.length),0!==a.length){var e=[];$j.each(a,function(a,b){b&&b._soupEntryId&&e.push(b._soupEntryId)}),0!==e.length?D.removeFromSoup(b,e,function(a){console.log("Deleted rec(s) - calling callback"),c(a)},d):c()}else c()}function y(b,c,d,e){var f=a("mobileCaddy/syncRefresh");console.log("in insert records"),console.log("mobile table name = "+b),console.log("records = "+JSON.stringify(c)),console.log("records size = "+c.length),D.upsertSoupEntries(b,c,function(a){console.log("back from upsert soup with records = "+JSON.stringify(a));var c=(new Date).getTime();f.addProxyIds(b,a,c,function(a){console.log("back with proxy ids = "+JSON.stringify(a));var f=[];$j.each(a,function(a,d){var e={Mobile_Table_Name:b,CRUD_Operation:"Insert",SOUP_Record_Id:d._soupEntryId,Id:d.Id,LastModifiedDateTime:c};f.push(e)}),D.upsertSoupEntriesWithExternalId("recsToSync",f,"Id",d,e)},e)},e)}function z(a,b,c){var d=b.length,e=0;return new Promise(function(f,g){B(a).then(function(h){$j.each(b,function(i,j){m(a,c,j[c]).then(function(k){if(k.length>0){var l=k[0];for(var n in j)l[n]=j[n];b[i]=l,e++,e>=d&&f(b)}else"Id"==c&&j.Id.length>18?m(a,h,j.Id).then(function(a){if(a.length>0){var c=a[0];for(var h in j)"Id"!=h&&(c[h]=j[h]);b[i]=c,e++,e>=d&&f(b)}else g({status:101107})}):g({status:101107})}).catch(function(a){g(a)})})}).catch(function(a){g(a)})})}function A(b,c,d,e,f){a("mobileCaddy/syncRefresh");z(b,c,d).then(function(a){D.upsertSoupEntriesWithExternalId(b,a,d,function(a){m("recsToSync","Mobile_Table_Name",b,function(c){var d=[];$j.each(a,function(a,e){var f;$j.each(c,function(a,b){if(b.Id==e.Id)return void(f=b)});var g;if(void 0!==f)if(console.log("existingRecToSync",f),f.Current_Connection_Session&&void 0!==f.Current_Connection_Session)switch(f.CRUD_Operation){case"Insert":case"InsertUpdate":g="InsertUpdate";break;default:g="UpdateUpdate"}else g=f.CRUD_Operation;else g="Update";var h={Mobile_Table_Name:b,SOUP_Record_Id:e._soupEntryId,Id:e.Id,CRUD_Operation:g,LastModifiedDateTime:e.SystemModstamp};"InsertUpdate"!=g&&"UpdateUpdate"!=g||(h.Current_Connection_Session=f.Current_Connection_Session),d.push(h)}),D.upsertSoupEntriesWithExternalId("recsToSync",d,"Id",e,f)},f)},f)}).catch(function(a){f(a)})}function B(a){return new Promise(function(b,c){var d=localStorage.getItem("proxyField-"+a);d?b(d):(console.log("getProxyFieldName",a),u(a,G,function(c){var d=null;c.forEach(function(b){b.includes("MC_Proxy_ID")&&(d=b,localStorage.setItem("proxyField-"+a,b),console.log("GOT IT ",d))}),b(d)},function(a){console.error("listMobileTableColumns",JSON.stringify(a)),b(null)}))})}var C=a("mobileCaddy/mobileLogger"),D=cordova.require("com.salesforce.plugin.smartstore"),E=1,F=2,G=0,H=1,I=2;c.exports={NONE:0,ALPHA:E,BUILD:F,listMobileTables:function(a,b,c){t(a,b,c)},LIST:G,BUILD_OBJECT:H,FULL:I,listMobileTableColumns:function(a,b,c,d){u(a,b,c,d)},queryMobileTable:function(a,b,c,d,e){return m(a,b,c,d,e)},buildMobileTables:function(a,b){w(a,b)},getProxyFieldName:function(a){return B(a)},getSysDataRowMapColHeading:function(a,b,c,d){r(a,b,c,d)},getSysDataRowMapColHeadings:function(a,b,c,d){s(a,b,c,d)},getTableDefnColumnValue:function(a,b){return p(a,b)},setTableDefnColumnValue:function(a,b,c,d,e){return q(a,b,c,d,e)},queryMobileTableWithAnd:function(a,b,c,d,e,f,g){n(a,b,c,d,e,f,g)},smartQuerySoupRecordsWithQuerySpec:function(a,b,c){l(a,b,c)},insertRecords:function(a,b,c,d){y(a,b,c,d)},updateRecordsWithExternalId:function(a,b,c,d,e){A(a,b,c,d,e)},markSoupToSync:function(a,b,c){k("syncLib_system_data",D.buildExactQuerySpec("Type",mobileCaddy.DYNAMIC_DATA_OBJECT,mobileCaddy.QUERY_BUFFER_SIZE_SL),b,function(d){for(var e=0;e<d.length;e++)if(d[e].Name==a){d[e].Refresh_Indicator="Once",D.upsertSoupEntries("syncLib_system_data",[d[e]],b,c);break}},c)},emptySoup:function(a,b,c){var d=mobileCaddy.require("mobileCaddy/smartStoreUtils");D.removeSoup(a,function(){d.createSoup(a,b,c)},c)},emptySoupPromise:function(a){return new Promise(function(b,c){var d=mobileCaddy.require("mobileCaddy/smartStoreUtils");D.removeSoup(a,function(){d.createSoup(a,function(){console.debug("emptySoupPromise",a),b()},function(a){c(a)})},function(a){c(a)})})},deleteSoup:function(b){return console.debug("deleteSoup",b),new Promise(function(c,d){var e=(mobileCaddy.require("mobileCaddy/smartStoreUtils"),a("mobileCaddy/logger"));D.removeSoup(b,function(){e.log("deleteSoup",b),c()},function(a){e.errorAndDispatch("deleteSoup",a),d(a)})})},createSoup:function(a,b,c){g(a,function(d){h(d,function(d,e){D.registerSoup(a,e,function(a){b()},c)},c)},c)},querySoupRecords:function(a,b,c){i(a,b,c)},querySoupRecsPromise:function(a){return j(a)},querySoupRecordsWithQuerySpec:function(a,b,c,d){k(a,b,c,d)},compareVersions:function(a,b){k("syncLib_system_data",cordova.require("com.salesforce.plugin.smartstore").buildExactQuerySpec("Name",mobileCaddy.VERSION_ID,mobileCaddy.QUERY_BUFFER_SIZE),function(c){simpleMessageSL("Version in soup = "+c[0].Value),getVersion(function(b){simpleMessageSL("Version in Salesforce = "+b),a()},b)},b)},deleteRecordsForExternalId:function(a,b,c,d,f){return e(a,b,c,d,f)},deleteRecordsFromSoup:function(a,b,c,d){x(a,b,c,d)},refreshSnapshot:function(a,b,c){d(a,b,c)}}}),b("mobileCaddy/appDataUtils",function(a,b,c){function d(a){var b=localStorage.getItem("appSoup-"+a);return new Promise(function(c,d){b?c(b):e(a).then(function(b){localStorage.setItem("appSoup-"+a,b),c(b)})})}function e(a){return new Promise(function(b,c){var d=g.buildExactQuerySpec("Name",a,mobileCaddy.QUERY_BUFFER_SIZE);h.querySoupRecordsWithQuerySpec("appSoup",d,function(a){b(a[0]?a[0].CurrentValue:a[0])},function(a){c(a)})})}function f(a,b,c){return new Promise(function(d,e){var f=g.buildExactQuerySpec("Name",a,mobileCaddy.QUERY_BUFFER_SIZE);h.querySoupRecordsWithQuerySpec("appSoup",f,function(a){a.length>0?(a[0][c]=b,g.upsertSoupEntries("appSoup",a,function(a){d(a)},function(a){e(a)})):d()},function(a){e(a)})})}var g=(a("mobileCaddy/mobileLogger"),cordova.require("com.salesforce.plugin.smartstore")),h=a("mobileCaddy/smartStoreUtils");c.exports={getCurrentValueFromAppSoup:function(a){return e(a)},getCachedCurrentValueFromAppSoup:function(a){return d(a)},updateNewValueInAppSoup:function(a,b){return f(a,b,"NewValue")},updateCurrentValueInAppSoup:function(a,b){return f(a,b,"CurrentValue")}}}),b("mobileCaddy/syncRefresh",function(a,b,c){function d(a){return new Promise(function(b,c){var d=function(a){c(a)},f={};console.log("json object date time = "+a.lastRefreshDatetime);var g={},h={},i=a.mt;null===i&&console.error("Mobile Table (tag 'mt') empty in p2mRefresh response: ",a);var j=E.buildExactQuerySpec("Mobile_Table_Name",i,mobileCaddy.QUERY_BUFFER_SIZE);C.querySoupRecordsWithQuerySpec("recsToSync",j,function(c){$j.each(c,function(a,b){if("Insert"==b.CRUD_Operation||"InsertUpdate"==b.CRUD_Operation)g[b.Id]=1;else{if("Update"!=b.CRUD_Operation&&"UpdateUpdate"!=b.CRUD_Operation)return void D.error("RTS contains record with non support CRUD Operation"+b);h[b.Id]=1}}),C.getProxyFieldName(i).then(function(j){var k=[],l=[];if($j.each(a.records,function(a,b){var c=!0;null!==b.recordData.MC_Proxy_ID__c&&g.hasOwnProperty(b.recordData[j])&&(c=!1),c&&h.hasOwnProperty(b.recordData.Id)&&(c=!1),c&&k.push(b.recordData)}),a.ds){a.ds.oq.concat(a.ds.sd.concat(a.ds.hd.concat(a.ds.sh))).forEach(function(a){h.hasOwnProperty(a)?console.log("We have a dirty local version, not deleting"):l.push({Id:a})})}var m=E.buildExactQuerySpec("Mobile_Table_Name",i,mobileCaddy.QUERY_BUFFER_SIZE);C.querySoupRecordsWithQuerySpec("recsToSync",m,function(g){g.length==c.length?C.deleteRecordsForExternalId(i,l,"Id",function(){E.upsertSoupEntriesWithExternalId(i,k,"Id",function(){E.soupExists("SnapShot_"+i,function(c){c?C.deleteRecordsForExternalId("SnapShot_"+i,l,"Id",function(){E.upsertSoupEntriesWithExternalId("SnapShot_"+i,k,"Id",function(){B.checkForMigrateToInfo(a),e(a.platAuthUrl),f.status=0,f.cs=a.cs,f.cp=a.cp,f.lastRefreshDatetime=a.lastRefreshDatetime,b(f)},d)},d):(B.checkForMigrateToInfo(a),e(a.platAuthUrl),f.status=0,f.lastRefreshDatetime=a.lastRefreshDatetime,f.cs=a.cs,f.cp=a.cp,b(f))},d)},d)},d):(f.status=0,f.mc_add_status=1,f.cs=a.cs,f.cp=a.cp,f.lastRefreshDatetime=a.lastRefreshDatetime,resolves(f))},d)})},d)})}function e(a){console.log("setPlatAuthUrl",a),a||(a=""),A.updateCurrentValueInAppSoup("platAuthUrl",a).catch(function(b){D.error("setPlatAuthUrl",a,b)})}function f(a,b,c,e,g,h,i,k){console.log("Refreshing table",a);var l,m,n,o,p=function(e,g){if(console.debug("respJson",e),console.debug("event",g),g.status){var h,j,l=new RegExp("\n","g");e=e.replace(l,"\\n"),l=new RegExp("\r","g"),e=e.replace(l,""),j=JSON.parse(e),console.log("Parse json done"),d(j).then(function(b){return h=b,console.log("handle refresh res = "+h.status),C.setTableDefnColumnValue(a,"Last Refresh Date/Time",h.lastRefreshDatetime)}).then(function(){var b="P2M RE Records Processed";return"Connection_Session__mc"==a&&(b="P2M Conn_Sess Records Processed"),1==h.mc_add_status&&(b="P2M RE Abandoned"),o.connSessionRec.mobilecaddy1__Mobile_Process_Status__c=b,o.connSessionRec.Id=h.cs,F.postProcessConnectionSession(o.connSessionRec)}).then(function(){return F.handleUpdatedCS(j.csM2P)}).then(function(){console.log("success return from post process"),c&&m<G?F.maybeSyncConnSess(o.connSessionRec,function(){console.log("success return from maybeSyncConnSess"),j["Session Number"]&&j["Session Number"]<j["Total Sessions"]?(console.info("Page "+j["Session Number"]+" of "+j["Total Sessions"]+", going again."),f(a,b,c,j["Session Number"]+1,j["Total Sessions"],j.CsPId,i,k)):j.moreBatches?(console.info("moreBatches"),f(a,b,c,"newBatch",1,null,i,k)):(r.status=H,i(r))},k):j["Session Number"]&&j["Session Number"]<j["Total Sessions"]?(console.info("Page "+j["Session Number"]+" of "+j["Total Sessions"]+", going again."),f(a,b,c,j["Session Number"]+1,j["Total Sessions"],j.CsPId,i,k)):j.moreBatches?(console.info("moreBatches"),f(a,b,c,"newBatch",1,null,i,k)):(console.log("No more pages or batches"),r.status=H,i(r))}).catch(function(a){k(a)})}else"exception"===g.type&&D.error("p2mRefresh",a,g.message,g.where),F.cleanConnectionSessionVFEvent(g,o,function(a){r.status=I,r.mc_add_status=a.mc_add_status,i(r)},k)},q="",r={},t="newBatch"==e;t&&(e=1);try{C.getTableDefnColumnValue(a,"Last Refresh Date/Time").then(function(a){n=a,n&&"null"!=n||(n=0),console.log("Using lastRefreshDatetime = "+n),console.debug("maxTableAge",b);var d=new Date;return n<d-b||e>1||t||!c?A.getCachedCurrentValueFromAppSoup("audId"):(console.log("Not refreshing table. it is too young"),r.status=100402,r.status=100497,Promise.reject(r))}).then(function(a){return l=a,A.getCachedCurrentValueFromAppSoup("syncRefreshVersion")}).then(function(a){return m=a,s(m,"Sync - Refresh","P2M RE Process Called",e,g,h)}).then(function(a){if(o=a,!c){var b=JSON.parse(o.connSessJson);b.initialSync=!0,o.connSessJson=JSON.stringify(b)}if(t){var d=JSON.parse(o.connSessJson);d.firstBatch=!1,o.connSessJson=JSON.stringify(d)}return j(m,c)}).then(function(b){console.log("csUpdates",b),b&&(o.connSessJson=JSON.parse(o.connSessJson),o.connSessJson.csM2P=b,o.connSessJson=JSON.stringify(o.connSessJson)),console.log("connSessObject -> ",o),!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/p2mRefreshTable001",contentType:"application/json",data:{audId:l,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:m,mobileTableName:a,deviceRefreshIds:[],lastRefreshDateTime:n,thirdPartyJson:q,connSessJson:o.connSessJson}},function(a,b){void 0===b&&(b={},b.status="200"),p(a,b)},k):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".p2mRefreshTable",l,m,a,[],n,q,o.connSessJson,p,{buffer:!1,escape:!1,timeout:12e4})}).catch(function(a){100497==a.status?i(a):(D.error(a),k(a))})}catch(a){D.errorAndDispatch(a)}}function g(a,b,c){return new Promise(function(d,e){A.getCachedCurrentValueFromAppSoup("audId").then(function(e){d("PROXY%"+a+"%"+c+"%"+b+"%"+e)}).catch(function(a){e(a)})})}function h(a,b,c,d,e){var f;C.getProxyFieldName(a).then(function(a){return f=a,A.getCachedCurrentValueFromAppSoup("audId")}).then(function(g){$j.each(b,function(b,d){var e="PROXY%"+a+"%"+c+"%"+d._soupEntryId+"%"+g;d.Id=e,d[f]=e}),E.upsertSoupEntries(a,b,function(a){d(a)},e)}).catch(function(a){e(a)})}function i(a,b,c,d){var e;if("Throw Exception"==d)throw D.errorAndDispatch("nullHandler - NULL value found",a,b,c.Id),"NULL value found for field "+b+" in Mobile Table "+a+" with Id = "+c.Id;return"Return NULL"==d?e=null:"Return Empty String"==d&&(e=""),e}function j(a,b){return new Promise(function(c,d){if(console.log("syncRefreshVersion",a,G),a<G||!b)c();else{var e,f=[];C.queryMobileTable("recsToSync","Mobile_Table_Name","Connection_Session__mc").then(function(a){return e=a,console.log("rtsRecs",e),e.length>0?C.querySoupRecsPromise("Connection_Session__mc"):Promise.resolve([])}).then(function(a){console.log("csRecs",a),e.forEach(function(b){for(var c,d=0;d<a.length;++d)if(a[d].Id===b.Id&&a[d].Id.length<20){c=a[d];break}c&&f.push({Id:b.Id,t:l(c.mobilecaddy1__Session_Type__c),s:k(c.mobilecaddy1__Mobile_Process_Status__c)})}),c(f)}).catch(function(a){D.error(a),c(null)})}})}function k(a){switch(a){case"P2M RE Records Processed":return 1;case"P2M Conn_Sess Records Processed":return 2;case"P2M RE Abandoned":return 3;case"P2M RE Exception/Timeout":return 4;case"P2M RE Heartbeat Exception/Timeout":return 5;case"P2M RE Failure":return 6;case"P2M RE Hearbeat Failure":return 7;case"M2P Conn_Sess Records Processed":return 8;case"M2P Records Processed":return 9;case"M2P UP Failed - RTS Cleared":return 10;case"M2P SC - Status Check Processed":return 11;case"M2P SC Failure":return 12;case"M2P SC Exception/Timeout":return 13;case"M2P SC Heartbeat Exception/Timeout":return 14;case"M2P SC Heartbeat Failure":return 15;case"M2P UP Received - Records Processed":return 16;case"P2M InitialSync Faliure":return 17;default:return D.error("Unknown CS status",a),0}}function l(a){switch(a){case"Sync - Refresh":return 1;case"Sync - Update":return 2;case"Status Check":return 3;default:return D.error("Unkown Session_Type__c",a),0}}function m(a,b,c,d,e,f,g,h,i,j,k){var l={MobileTable:a,connSessProxyId:j,records:[]};g.forEach(function(g){for(var j,k=0;k<h.length;++k)if(h[k].Id===g.Id){j=h[k];break}if(j){var m={RTSRowNum:g._soupEntryId,RecordCRUD:n(g.CRUD_Operation),fields:[]};switch(m.RecordCRUD){case"I":case"T":m=o(m,a,b,c,d,e,f,j),l.records.push(m);break;case"D":case"U":case"Q":for(var q,r=0;r<i.length;++r)if(i[r].Id===g.Id){q=i[r];break}q?(m=p(m,a,b,c,d,e,f,j,q),l.records.push(m)):D.errorAndDispatch("createUpdateJson Missing snapShot",a,j.Id);break;default:D.errorAndDispatch("createUpdateJson unknown CRUD",a,g.Id,g.CRUD_Operation)}}else D.errorAndDispatch("createUpdateJson Missing primary",a,g.Id)}),k(JSON.stringify(l))}function n(a){switch(a){case"Insert":return"I";case"InsertDelete":return"T";case"Update":return"U";case"UpdatetDelete":return"Q";case"Delete":return"D";default:return null}}function o(a,b,c,d,e,f,g,h){for(var j in h){var k={name:j};if("mobilecaddy1__Error_Text__c"==j)k.value=JSON.stringify(h[j]),a.fields.push(k);else if("_soupEntryId"!=j&&"_soupLastModifiedDate"!=j){var l,m={};m[d]=j;var n=_.findWhere(c,m);if(null===h[j])fieldNullHandler=n[f],l=i(b,j,h,fieldNullHandler);else if(l=h[j],n){var o=n[g];"M2P UP Unquoted"!=o||"true"!=l&&"false"!=l||(l="true"==l)}k.value=l,a.fields.push(k)}}return a}function p(a,b,c,d,e,f,g,h,j){var k=!1;for(var l in h)if("_soupEntryId"!=l&&"_soupLastModifiedDate"!=l){var m={name:l};if(h[l]!=j[l]||"SystemModstamp"==l){k=!0;var n,o,p=null,q=null,r={};r[d]=l;var s=_.findWhere(c,r);null===h[l]?(p=s[f],n=i(b,l,h,p)):(n=h[l],s&&("M2P UP Unquoted"!=(q=s[g])||"true"!=n&&"false"!=n||(n="true"==n))),null===j[l]&&s?(p||(p=s[f]),o=i(b,l,j,p)):(o=j[l],s&&(q||(q=s[g]),"M2P UP Unquoted"!=q||"true"!=o&&"false"!=o||(o="true"==o))),m.previousValue=o,m.value=n,a.fields.push(m)}}return k?(a.fields.push({name:"Id",previousValue:j.Id,value:j.Id}),a):[]}function q(a,b,c,d){$j.each(a,function(a,c){c.Current_Connection_Session=b}),E.upsertSoupEntriesWithExternalId("recsToSync",a,"Id",c,d)}function r(a,b,c,d,e){var f=[];$j.each(b,function(a,b){var d={};$j.each(c,function(a,c){if(b.Id==c.Id&&"Insert"==b.CRUD_Operation)for(var e in c)"_soupEntryId"!=e&&"_soupLastModifiedDate"!=e&&(d[e]=c[e])}),_.isEmpty(d)||f.push(d)}),0===f.length?d():C.getProxyFieldName(a).then(function(b){E.upsertSoupEntriesWithExternalId("SnapShot_"+a,f,b,d,e)})}function s(b,c,d,e,f,g){return new Promise(function(b,h){var i=a("mobileCaddy/geolocation"),j={};i.getLocation(function(a){var i={mobilecaddy1__Session_Type__c:c,mobilecaddy1__Mobile_Process_Status__c:d,SystemModstamp:(new Date).getTime()},k=a.ErrorNumber;0!==k?i.mobilecaddy1__Session_Created_Location_Error__c=a.Error:(i.Session_Created_Location__Longitude__s=a.Latitude,i.Session_Created_Location__Latitude__s=a.Longitude),v("Connection_Session__mc",i,function(c){var d=new Date,h={"Sync Session Proxy ID":null,"Total Sessions":f,"Session Number":e,"Device Call Date/Time":d.getTime(),"Connection Session Proxy ID":c.proxyId};g&&(h.CsPId=g),0!==k?h.ErrorNumber=k:(h["Location Long"]=a.Longitude,h["Location Lat"]=a.Latitude),j.status=0,j.connSessionRec=c.insertedRecord,j.connSessProxyId=c.proxyId;var i={version:"NULL"};window.device&&(i=window.device),A.getCurrentValueFromAppSoup("containerVersion").then(function(a){h.containerVsn=a,h.OSVsn=i.version,j.connSessJson=JSON.stringify(h),b(j)}).catch(function(a){D.error("buildConnectionSession - Could not get containerVsn",a),h.OSVsn=i.version,j.connSessJson=JSON.stringify(h),b(j)})},function(a){h(a)})},function(a){h(a)})})}function t(a){return new Promise(function(b,c){var d=3e4,e={},f=function(a){b(a)},g=function(a){c(a)},h=E.buildExactQuerySpec("Mobile_Table_Name",a,mobileCaddy.QUERY_BUFFER_SIZE);C.querySoupRecordsWithQuerySpec("recsToSync",h,function(b){if(0!==b.length){console.debug("recsToSyncRecords",JSON.stringify(b));var c=!1;"Connection_Session__mc"!=a&&b.length>d&&(c=!0),console.log("moreToSync: "+c);var h=[];c?(h=_.sortBy(b,"_soupLastModifiedDate"),h=h.slice(0,d)):h=b,console.debug("recsToSyncRecords2",JSON.stringify(h)),C.querySoupRecords(a,function(b){C.querySoupRecords("SnapShot_"+a,function(d){C.getSysDataRowMapColHeadings("Row Mapping TC",["Parent SOUP Name","Table Column Name","M2P Update Converter DEVICE","M2P Update NULL Handler DEVICE","M2P Update Formatter DEVICE"],function(i){var j=i[0],k=i[1],l=i[2],n=i[3],o=i[4];C.queryMobileTableWithAnd("syncLib_system_data","MC_Var_String_001","Platform Table Column",j,a,function(i){function j(a,c){return _.find(b,function(b){return b.Id==a})}var p=[];if(_.each(h,function(a){j(a.Id,b)&&p.push(a)}),_.isEmpty(p))return console.debug("Nothing in checkedRecsToSync."),void C.setTableDefnColumnValue(a,"Last Sync Date/Time",(new Date).getTime()).then(function(){e.status=J,e.mc_add_status=K,f(e)}).catch(function(a){D.error(a)});m(a,i,k,l,n,o,p,b,d,"",function(d){var i;A.getCachedCurrentValueFromAppSoup("audId").then(function(a){return i=a,A.getCachedCurrentValueFromAppSoup("syncRefreshVersion")}).then(function(j){r(a,h,b,function(){console.log("moreToSync: "+c);var b=function(a,b){console.debug("result: "+a),console.debug("event: "+b),e.result=a,e.event=b,f(e)};d=d.replace(/: undefined/g,': "undefined"'),console.debug("jsonString -> "+d),!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/m2pUpdateTable001",contentType:"application/json",data:{audId:i,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:j,mobileTableName:a,jsonRecords:d,connSessJson:"{}"}},function(a,c){void 0===c&&(c={},c.status="200"),b(a,c)},g):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".m2pUpdateTable",i,j,a,d,JSON.stringify({"Session Number":1,"Location Long":10,"Location Lat":10,"Total Sessions":1,"Device Call Date/Time":(new Date).getTime(),"Connection Session Proxy ID":"1",ErrorNumber:2}),b,{buffer:!1,escape:!1,timeout:3e4})},g)}).catch(function(a){g(a)})},g)},g)},g)},g)},g)}else C.setTableDefnColumnValue(a,"Last Sync Date/Time",(new Date).getTime()).then(function(){e.status=J,e.mc_add_status=K,f(e)}).catch(function(a){D.log("No recs to sync")})},g)})}function u(a,b,c,d){var e,f,g={};console.debug("In m2pUpdateMobileTable call",a,b);try{A.getCachedCurrentValueFromAppSoup("syncRefreshVersion").then(function(a){return f=a,s(f,"Sync - Update","M2P Process Called",1,1,null)}).then(function(a){return e=a,console.log("proxy id = "+e.connSessProxyId),j(f,!0)}).then(function(h){console.log("m2p csUpdates",h),h&&(e.connSessJson=JSON.parse(e.connSessJson),e.connSessJson.csM2P=h,e.connSessJson=JSON.stringify(e.connSessJson)),console.log("connSessObject -> ",e);var i=E.buildExactQuerySpec("Mobile_Table_Name",a,mobileCaddy.QUERY_BUFFER_SIZE);C.querySoupRecordsWithQuerySpec("recsToSync",i,function(h){if(0!==h.length){console.debug("recsToSyncRecords",JSON.stringify(h));var i=!1;"Connection_Session__mc"!=a&&h.length>b&&(i=!0),console.log("moreToSync",i);var j=[];i?(j=_.sortBy(h,"_soupLastModifiedDate"),j=j.slice(0,b)):j=h,console.debug("recsToSyncRecords2",JSON.stringify(j)),q(j,e.connSessProxyId,function(b){C.querySoupRecords(a,function(h){C.querySoupRecords("SnapShot_"+a,function(j){C.getSysDataRowMapColHeadings("Row Mapping TC",["Parent SOUP Name","Table Column Name","M2P Update Converter DEVICE","M2P Update NULL Handler DEVICE","M2P Update Formatter DEVICE"],function(k){var l=k[0],n=k[1],o=k[2],p=k[3],q=k[4];C.queryMobileTableWithAnd("syncLib_system_data","MC_Var_String_001","Platform Table Column",l,a,function(k){m(a,k,n,o,p,q,b,h,j,e.connSessProxyId,function(j){var k;A.getCachedCurrentValueFromAppSoup("audId").then(function(l){k=l,r(a,b,h,function(){console.log("moreToSync",i);var b=function(b,h){if(console.debug("result",b),console.debug("event",h),h.status){var k;b=b.replace(/,}/g,"}"),console.log("Parse json processM2PUpdateResponse"),k=JSON.parse(b),console.log("Parse json processM2PUpdateResponse done"),F.processM2PUpdateResponse(k,j,function(b){console.debug("responseObject",JSON.stringify(b)),e.connSessionRec.mobilecaddy1__Mobile_Process_Status__c="Connection_Session__mc"==a?"M2P Conn_Sess Records Processed":"M2P Records Processed",e.connSessionRec.Id=b.csId,F.postProcessConnectionSession(e.connSessionRec).then(function(){return F.handleUpdatedCS(k.csM2P)}).then(function(){console.log("success return from post process"),console.log("success return from post process"),console.log("moreToSync",i),i?(g.status=J,g.mc_add_status="more-to-sync",c(g)):f<G?F.maybeSyncConnSess(e.connSessionRec,function(){console.log("success return from maybeSyncConnSess"),g.status=J,c(g)},d):(g.status=J,c(g))}).catch(function(a){d(a)})},d)}else"exception"===h.type?(g.status=J,g.mc_add_status=M,c(g),D.error("m2pUpdate",a,h.message,h.where)):(g.status=J,g.mc_add_status=N,c(g),D.error("m2pUpdate",a,h.message,h.where))};j=j.replace(/: undefined/g,': "undefined"'),console.debug("jsonString -> "+j),!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/m2pUpdateTable001",contentType:"application/json",data:{audId:k,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:f,mobileTableName:a,jsonRecords:j,connSessJson:e.connSessJson}},function(a,c){void 0===c&&(c={},c.status="200"),b(a,c)},d):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".m2pUpdateTable",k,f,a,j,e.connSessJson,b,{buffer:!1,escape:!1,timeout:3e4})},d)}).catch(function(a){d(a)})},d)},d)},d)},d)},d)},d)}else C.setTableDefnColumnValue(a,"Last Sync Date/Time",(new Date).getTime()).then(function(){g.status=J,g.mc_add_status=K,c(g)}).catch(function(a){d(a)})},d)},d)}catch(a){D.errorAndDispatch(a)}}function v(a,b,c,d){var e={},f=new Date;C.getProxyFieldName(a).then(function(h){E.upsertSoupEntries(a,[b],function(b){var i=b[0];g(a,i._soupEntryId,f.getTime()).then(function(b){i.Id=b,i[h]=b,E.upsertSoupEntries(a,[i],function(a){e.status=0,e.proxyId=b,e.insertedRecord=a[0],c(e)},d)}).catch(function(a){d(a)})},d)}).catch(function(a){d(a)})}function w(a,b){var c={},d=navigator.appVersion.includes("Electron");if(d||navigator&&navigator.connection&&"undefined"!=typeof Connection)if(console.log("Connection details"),d||navigator.connection.type!=Connection.NONE)if("undefined"==typeof Visualforce){D.log("Visualforce not currently defined");var e=window.location.pathname;$j.get(e).done(function(d){D.log("Startpage re-fetched",e);var f='"(\\S+VFRemote.js)"',g=new RegExp(f),h=g.exec(d);if(h[0]){var i=h[1];$j.getScript(i).done(function(){D.log("remote script fetched",i),new Function($j("script")[2].innerHTML)(),D.log("set up Visualforce ref"),x(a,b)}).fail(function(b,d,e){D.errorAndDispatch("vfRemote Load Error",h[0],e),c.status=N,a(c)})}else D.errorAndDispatch("heartBeat Could not find VFRemote src",e),c.status=N,a(c)}).fail(function(b,d,f){D.errorAndDispatch("Startpage Load Error",e,f),c.status=N,a(c)})}else x(a,b);else c.status=O,a(c);else localStorage.connection?c.status=localStorage.connection:c.status=P,a(c)}function x(a,b){var c={};Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".heartBeat",function(b,d){d.status?(c.status=L,a(c)):"exception"===d.type?y(function(b){console.log("refresh token refreshed in heartbeat"),c.status=Q,a(c)},function(b){c.status=M,a(c)}):(console.debug("other"),c.status=N,a(c))},{escape:!1,timeout:3e4})}function y(a,b){C.querySoupRecords("appSoup",function(c){var d={};c.forEach(function(a){d[a.Name]=a.CurrentValue}),z(d,a,b)},function(a){b(a)})}function z(b,c,d){var e=(a("mobileCaddy/mobileLogger"),cordova.require("com.salesforce.plugin.smartstore"),"grant_type=refresh_token&identity_url="+b.identityUrl+"&client_id="+b.clientId+"&refresh_token="+b.refreshToken+"&orgId="+b.orgId+"&audId="+b.audId+"&userId="+b.userId);console.log("data: "+e),$j.ajax({type:"POST",url:"https://mobilecaddy.secure.force.com/apex/ProxyToken",cache:!1,processData:!1,data:e,success:function(a){console.log("Changing vf access token from "+Visualforce.remoting.oauthAccessToken+" to "+a.access_token),Visualforce.remoting.oauthAccessToken=a.access_token,Visualforce.remoting.last.refresh(function(){A.updateCurrentValueInAppSoup("accessToken",a.access_token).then(function(){console.log("Updated accessToken in appSoup"),c(a.access_token)}).catch(function(a){d(a)})},function(a){D.error("in VF last refresh error"),d(a)})},error:function(a){D.error("failed to refresh access token "+JSON.stringify(a)),d(a)},dataType:"json",beforeSend:function(a){}})}var A=a("mobileCaddy/appDataUtils"),B=a("mobileCaddy/vsnUtils"),C=a("mobileCaddy/smartStoreUtils"),D=(a("mobileCaddy/mobileLogger"),a("mobileCaddy/logger")),E=cordova.require("com.salesforce.plugin.smartstore"),F=a("mobileCaddy/connSessUtils"),G="006",H=100500,I=100402,J=100300,K=100310,L=100100,M=100101,N=100102,O=100103,P=100104,Q=100105;c.exports={CSINHEAD_SYNC_VSN:G,refreshToken:function(a,b){y(a,b)},genProxyId:function(a,b,c){return g(a,b,c)},addProxyIds:function(a,b,c,d,e){h(a,b,c,d,e)},P2M_REFRESH_OK:H,p2mRefreshTable:function(a,b,c,d,e,g,h,i){f(a,b,c,d,e,g,h,i)},buildConnectionSession:function(a,b,c,d,e,f){return s(a,b,c,d,e,f)},M2P_UPDATE_OK:J,M2P_NO_RECS_TO_SYNC:K,m2pUpdateMobileTable:function(a,b,c,d){u(a,b,c,d)},m2pRecoveryUpdateMobileTable:function(a){return t(a)},HEARTBEAT_OK:L,HEARTBEAT_EXCEPTION:M,HEARTBEAT_FAILURE:N,HEARTBEAT_NO_CONNECTION:O,HEARTBEAT_NOT_DEVICE:P,HEARTBEAT_REFRESHED_OK:Q,heartBeat:function(a,b){w(a,b)},handleRefreshResponse:function(a){return d(a)},createUpdateJson:m}}),b("mobileCaddy/connSessUtils",function(a,b,c){function d(b,c){a("mobileCaddy/smartStoreUtils").querySoupRecords("recsToSync",function(a){console.debug("recsToSync -> "+JSON.stringify(a));for(var d=null,e=null,f=0;f<a.length;f++)if(console.debug("recsToSync["+f+"] -> "+JSON.stringify(a[f])),null!==a[f].Current_Connection_Session&&void 0!==a[f].Current_Connection_Session){d=a[f].Current_Connection_Session,e=a[f];break}if(null!==d&&void 0!==d){var g=(new Date).getTime(),h=e._soupLastModifiedDate+3e4;if(g>h)console.debug("timeNow > timeoutTs",g,h),console.debug("We have a timedout Conn_Sess",d),b(d);else{console.debug("We have a SYNC_ALREADY_IN_PROGRESS",d);var i={};i.status=100498,c(i)}}else console.debug("getRTSPendingconnSess - All clear"),b(d)},c)}function f(b,c,d){var e=a("mobileCaddy/syncRefresh"),f=a("mobileCaddy/appDataUtils"),j=a("mobileCaddy/connSessUtils"),k=a("mobileCaddy/smartStoreUtils"),l=a("mobileCaddy/logger");console.debug("csStatusCheck -> "+b);try{var m;f.getCachedCurrentValueFromAppSoup("syncRefreshVersion").then(function(a){return m=a,e.buildConnectionSession(m,"Status Check","M2P SC Status Check Requested",1,1,null)}).then(function(a){e.heartBeat(function(n){if(n.status==e.HEARTBEAT_OK||n.status==e.HEARTBEAT_NOT_DEVICE||n.status==e.HEARTBEAT_REFRESHED_OK){var o;f.getCachedCurrentValueFromAppSoup("audId").then(function(e){o=e;var f=function(e,f){if(f.status){var j;j=JSON.parse(e),j.cs_fc_jr&&(j.cs_fc_jr=JSON.parse(j.cs_fc_jr)),console.debug("Parse json status check done"),"Received Processed"==j.cs_fc_sc?g(a,j,c,d):s(b,function(){k.queryMobileTable("Connection_Session__mc","mobilecaddy1__MC_Proxy_ID__c",b,function(b){if(b.length>0){var e=b[0];"Received Not Processed"==j.cs_fc_sc?h(e,a,j,c,d):i(e,a,j,c,d)}else c({status:y})},d)},d)}else l.error("csStatusCheck",f.message),c({status:z})},j=a.connSessJson,n=localStorage.getItem("lastErrorLog");n&&(localStorage.removeItem("lastErrorLog"),j=JSON.parse(j),j.lastErrorLog=n,j=JSON.stringify(j)),!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/m2pCSStatusCheck001",contentType:"application/json",data:{audId:o,syncRefreshDataVersion:m,statusCheckCSProxyId:b,connSessJson:j,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN}},function(a,b){console.info("response -> "+JSON.stringify(a)),void 0===b&&(b={},b.status="200"),f(a,b)},function(a){l.error("err -> "+JSON.stringify(a)),d(a)}):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".m2pCSStatusCheck",o,m,b,j,f,{buffer:!1,escape:!1,timeout:3e4})}).catch(function(a){d(a)})}else j.cleanConnectionSessionHeartBeat(n,a,function(a){c({status:y,mc_add_status:a.mc_add_status})},d)},d)}).catch(function(a){d(a)})}catch(a){l.errorAndDispatch(a)}}function g(b,c,d,e){var f=a("mobileCaddy/connSessUtils"),g=a("mobileCaddy/logger"),h=a("mobileCaddy/smartStoreUtils");try{j(c.cs_fc_jr,function(a){b.connSessionRec.mobilecaddy1__Mobile_Process_Status__c="M2P SC - Status Check Processed",b.connSessionRec.SystemModstamp=(new Date).getTime(),b.connSessionRec.mobilecaddy1__Status__c="Closed",b.connSessionRec.Id=c.cs_sc_sf,h.queryMobileTable("Connection_Session__mc","Id",c.cs_fc_jr.cp).then(function(a){if(a[0]){var d=a[0];return console.log("m2pCsObject",d),d.Id=c.cs_fc_jr.csId,d.SystemModstamp=(new Date).getTime(),d.mobilecaddy1__Mobile_Process_Status__c="M2P Records Processed",f.postProcessConnectionSession([b.connSessionRec,d])}return Promise.resolve()}).then(function(){d({status:y})}).catch(function(a){e(a)})},e)}catch(a){g.errorAndDispatch("processM2PUpdateResponse",a),e("processM2PUpdateResponse-error")}}function h(b,c,d,e,f){var g=a("mobileCaddy/connSessUtils");b.mobilecaddy1__Mobile_Process_Status__c="M2P UP Failed - RTS Cleared",b.mobilecaddy1__Session_Type__c="Sync Update",b.mobilecaddy1__Status__c="Closed",b.SystemModstamp=(new Date).getTime(),b.Id=d.cs_fc_sf,g.postProcessConnectionSession(b).then(function(){c.connSessionRec.mobilecaddy1__Mobile_Process_Status__c="M2P SC - Status Check Processed",c.connSessionRec.SystemModstamp=(new Date).getTime(),c.connSessionRec.mobilecaddy1__Status__c="Closed",c.connSessionRec.Id=d.cs_sc_sf,g.postProcessConnectionSession(c.connSessionRec,function(){e({status:y})},f)}).catch(function(a){f(a)})}function i(b,c,d,f,g){var h=a("mobileCaddy/connSessUtils");a("mobileCaddy/smartStoreUtils").deleteRecordsFromSoup([b],"Connection_Session__mc",function(a){c.connSessionRec.mobilecaddy1__Mobile_Process_Status__c="M2P SC - Status Check Processed",c.connSessionRec.SystemModstamp=(new Date).getTime(),c.connSessionRec.mobilecaddy1__Status__c="Closed",c.connSessionRec.Id=d.cs_sc_sf,c.connSessionRec.mobilecaddy1__Session_Type__c="Status Check",h.postProcessConnectionSession(c.connSessionRec).then(function(){f({status:y})}).catch(function(){g(e)})},g)}function j(b,c,d,e){e||(e=d,d=c,c="{}");var f=a("mobileCaddy/smartStoreUtils"),g=(cordova.require("com.salesforce.plugin.smartstore"),a("mobileCaddy/logger")),h=a("mobileCaddy/vsnUtils"),i=1;console.debug("processM2PUpdateResponse",b,c);var j=b.mt,s=void 0!==b.is?b.is:[],t=void 0!==b.id?b.id:[],u=void 0!==b.us?b.us:[],v=void 0!==b.ifmf?b.ifmf:[],w=void 0!==b.ufmf?b.ufmf:[],x=[],y=[],z=[],A=[],B=[],C=[],D=[],E=[],F=[],G=[],H=[];if(s=s.concat(t),void 0===b.if)G=[];else if(void 0===b.if.if)G=b.if;else{i=2;var I=b.if.if.map(function(a){return{pd:a,fbe:void 0!==b.ifbe?b.ifbe:"K"}}),J=b.if.ifv.map(function(a){return{pd:a,fbe:void 0!==b.ifvbe?b.ifvbe:"K"}}),K=b.if.icv.map(function(a){return{pd:a,fbe:void 0!==b.icvbe?b.icvbe:"K"}});G=I.concat(J.concat(K))}m(c,s,G,v).then(function(a){if(G=a,void 0===b.uf)H=[];else if(void 0===b.uf.uf)H=b.uf;else{i=2;var c=b.uf.uf.map(function(a){return{Id:a,fbe:void 0!==b.ufbe?b.ufbe:"K"}}),d=b.uf.usv.map(function(a){return{Id:a,fbe:void 0!==b.usvbe?b.usvbe:"K"}}),e=b.uf.sdf.map(function(a){return{Id:a,fbe:void 0!==b.sdfbe?b.sdfbe:"K"}}),f=b.uf.hdf.map(function(a){return{Id:a,fbe:void 0!==b.hdfbe?b.hdfbe:"K"}}),g=b.uf.ufv.map(function(a){return{Id:a,fbe:void 0!==b.ufvbe?b.ufvbe:"K"}}),h=b.uf.ucv.map(function(a){return{Id:a,fbe:void 0!==b.ucvbe?b.ucvbe:"K"}});H=c.concat(d.concat(e.concat(f.concat(g.concat(h)))))}return n("SnapShot_"+j)}).then(function(a){return F=a,n(j)}).then(function(a){console.debug("priRecords -> "+JSON.stringify(a)),f.queryMobileTable("recsToSync","Mobile_Table_Name",j,function(c){for(var m in c)if(console.debug("recsToSyncRec[i] = "+JSON.stringify(c[m])),c[m].Current_Connection_Session==b.cp){var n=!1,t={},I={};switch(c[m].CRUD_Operation){case"Insert":case"InsertUpdate":for(var J in s)if(c[m].Id==s[J].pd){if(s[J].crud=c[m].CRUD_Operation,I=k(s[J],a),"Insert"==c[m].CRUD_Operation){switch(b.stbe){case"D":D.push(I),E.push(s[J]);break;default:if("U"==s[J].pc){if(I.Id=s[J].Id,void 0!==s[J].an&&(void 0!==s[J].nf?I[s[J].nf]=s[J].an:I.Name=s[J].an),void 0!==s[J].lu)for(var K in s[J].lu)s[J].lu.hasOwnProperty(K)&&console.debug("prop",K,s[J].lu[K]),I[K]=s[J].lu[K];A.push(I),C.push(I)}}y.push(c[m]._soupEntryId)}else{if(I.Id=s[J].Id,void 0!==s[J].an&&(void 0!==s[J].nf?I[s[J].nf]=s[J].an:I.Name=s[J].an),void 0!==s[J].lu)for(var L in s[J].lu)s[J].lu.hasOwnProperty(L)&&console.debug("iUProp",L,s[J].lu[L]),I[L]=s[J].lu[L];A.push(I);var M=k(s[J],F);M.Id=s[J].Id,C.push(M),t=c[m],t.Current_Connection_Session=null,t.CRUD_Operation="Update",t.Id=s[J].Id,x.push(t)}n=!0;break}if(!n)for(J in G)if(console.info("failure",c[m].Id,G[J].pd),c[m].Id==G[J].pd){if(G[J].crud=c[m].CRUD_Operation,"Insert"==c[m].CRUD_Operation)switch("K",1==i?l(0,G[J].fl,b):G[J].fbe){case"K":t=c[m],t.Current_Connection_Session=null,x.push(t);break;case"R":break;default:I=k(G[J],a),D.push(I),y.push(c[m]._soupEntryId),E.push(G[J])}else"InsertUpdate"==c[m].CRUD_Operation&&(t=c[m],t.Current_Connection_Session=null,t.CRUD_Operation="Insert",x.push(t));n=!0;break}if(!n)for(J in v)if(c[m].Id==v[J].pd){if(v[J].crud=c[m].CRUD_Operation,"Insert"==c[m].CRUD_Operation)switch(v[J].fbe){case"K":t=c[m],t.Current_Connection_Session=null,x.push(t);break;case"R":break;default:I=k(v[J],a),D.push(I),y.push(c[m]._soupEntryId),E.push(v[J])}else"InsertUpdate"==c[m].CRUD_Operation&&(t=c[m],t.Current_Connection_Session=null,t.CRUD_Operation="Insert",x.push(t));n=!0;break}break;case"Update":case"UpdateUpdate":for(J in u)if(c[m].Id==u[J].Id){if(u[J].crud=c[m].CRUD_Operation,"Update"==c[m].CRUD_Operation){switch(I=k(u[J],a),b.stbe){case"D":D.push(I),E.push(u[J]);break;default:if("M"==u[J].pc&&(I.SystemModstamp=new Date(u[J].sm)),void 0!==u[J].lu){console.debug("lu",u[J].lu);for(var N in u[J].lu)u[J].lu.hasOwnProperty(N)&&(I[N]=u[J].lu[N])}z.push(I),B.push(I)}y.push(c[m]._soupEntryId)}else"UpdateUpdate"==c[m].CRUD_Operation&&(t=c[m],t.Current_Connection_Session=null,t.CRUD_Operation="Update",x.push(t));n=!0;break}if(!n)for(J in H)if(c[m].Id==H[J].Id){if("Update"==c[m].CRUD_Operation)switch("K",1==i?l(1,H[J].fl,b):H[J].fbe){case"K":t=c[m],t.Current_Connection_Session=null,x.push(t);break;case"R":break;default:I=k(H[J],a),D.push(I),y.push(c[m]._soupEntryId),E.push(H[J])}else"UpdateUpdate"==c[m].CRUD_Operation&&(t=c[m],t.Current_Connection_Session=null,t.CRUD_Operation="Update",x.push(t));n=!0;break}if(!n)for(J in w)if(c[m].Id==w[J].Id){if(w[J].crud=c[m].CRUD_Operation,"Update"==c[m].CRUD_Operation)switch(w[J].fbe){case"K":t=c[m],t.Current_Connection_Session=null,x.push(t);break;case"R":break;default:I=k(w[J],a),D.push(I),y.push(c[m]._soupEntryId),E.push(w[J])}else"UpdateUpdate"==c[m].CRUD_Operation&&(t=c[m],t.Current_Connection_Session=null,t.CRUD_Operation="Update",x.push(t));n=!0;break}}}console.info("priToInsertRecs",A),console.info("rtsToUpdateRecs",x);var O;f.getProxyFieldName(j).then(function(a){return O=a,o(j,"Id",z)}).then(function(a){return console.debug("m2pRespUpRecs ("+j+") res -> "+JSON.stringify(a)),o(j,O,A)}).then(function(a){return console.debug("m2pRespUpRecs"+j+") (PROXY KEY) res -> "+JSON.stringify(a)),o("SnapShot_"+j,"Id",B)}).then(function(a){return console.debug("m2pRespUpRecs"+j+") (PROXY KEY) res -> "+JSON.stringify(a)),o("SnapShot_"+j,O,C)}).then(function(a){return console.debug("m2pRespUpRecs (SnapShot_"+j+") res -> "+JSON.stringify(a)),r(j,D)}).then(function(a){return console.debug("m2pRespDelRecs res -> "+JSON.stringify(a)),r("SnapShot_"+j,E)}).then(function(a){return console.debug("m2pRespDelRecs (SnapShot_' + mobileTable + ') res -> "+JSON.stringify(a)),q(x)}).then(function(a){return console.debug("m2pRespUpRTSRecs res -> "+JSON.stringify(a)),p(y)}).then(function(a){return console.debug("m2pRespDelRTSRecs res -> "+JSON.stringify(a)),h.checkForMigrateToInfo(b)}).then(function(){var a={};a.status=0,a.csId=b.csId,d(a)}).catch(function(a){g.errorAndDispatch("m2pResp error for "+j,a),e(a)})},e)}).catch(function(a){g.errorAndDispatch("Err reading table",j),e(a)})}function k(a,b){var c={};return"Insert"==a.crud||"InsertUpdate"==a.crud?c.Id=a.pd:c.Id=a.Id,_.findWhere(b,c)}function l(a,b,c){switch(a){case 0:switch(b){case"DF":return c.ifbe;case"CV":return c.icvbe;case"FV":return c.ifvbe}break;case 1:switch(b){case"DF":return c.ufbe;case"SV":return c.usvbe;case"CV":return c.ucvbe;case"FV":return c.ufvbe;case"SD":return c.sdfbe;case"HD":return c.hdfbe}}}function m(b,c,d,e){return new Promise(function(f,g){var h=a("mobileCaddy/smartStoreUtils");b=JSON.parse(b);var i=d.concat(e),j=d;if(b.records&&b.records.length>c.length+i.length){var k=[];h.getProxyFieldName(b.MobileTable).then(function(a){b.records.forEach(function(b){if("I"==b.RecordCRUD){var d=b.fields.find(function(b){return b.name==a}).value;_.findWhere(c,{pd:d})||_.findWhere(i,{pd:d})||k.push({pd:d,fbe:"K"})}}),k.length>0&&(j=d.concat(k)),f(j)})}else f(j)})}function n(b){var c=a("mobileCaddy/smartStoreUtils");return new Promise(function(a,d){c.querySoupRecords(b,function(b){a(b)},function(a){d(a)})})}function o(a,b,c){var d=cordova.require("com.salesforce.plugin.smartstore");return console.debug("m2pRespUpRecs ("+a+") updateRecs -> "+JSON.stringify(c)),new Promise(function(e,f){c.length>0?d.upsertSoupEntriesWithExternalId(a,c,b,function(a){e(a)},function(a){f(a)}):e("OK")})}function p(a){var b=cordova.require("com.salesforce.plugin.smartstore");return console.debug("m2pRespDelRTSRecs recsToDel -> "+JSON.stringify(a)),new Promise(function(c,d){a.length>0?b.removeFromSoup("recsToSync",a,function(a){c(a)},function(a){d(a)}):c("OK")})}function q(a){var b=cordova.require("com.salesforce.plugin.smartstore");return console.debug("m2pRespUpRTSRecs recsToUp -> "+JSON.stringify(a)),new Promise(function(c,d){a.length>0?b.upsertSoupEntries("recsToSync",a,function(a){c(a)},function(a){d(a)}):c("OK")})}function r(b,c){console.debug("m2pRespDelRecs ("+b+") recsToDel -> "+JSON.stringify(c));var d=a("mobileCaddy/smartStoreUtils"),e=a("mobileCaddy/logger");return new Promise(function(a,f){if(c.length>0)if(-1==b.indexOf("SnapShot"))d.deleteRecordsFromSoup(c,b,function(b){a(b)},function(a){f(a)});else{console.debug("Deleting from SnapShot ",b);var g=[];c.forEach(function(a){null!==a&&void 0!==a&&("Insert"==a.crud&&(a.Id=a.pd),g.push(a))}),d.deleteRecordsForExternalId(b,g,"Id",function(b){a(b)},function(a){e.errorAndDispatch(a),f(a)})}else a("OK")})}function s(b,c,d){console.log("clearRTSRecs",b);var e=a("mobileCaddy/smartStoreUtils"),f=cordova.require("com.salesforce.plugin.smartstore");e.queryMobileTable("recsToSync","Current_Connection_Session",b,function(a){if(0!==a.length){for(var b=0;b<a.length;b++)a[b].Current_Connection_Session=null,"InsertUpdate"==a[b].CRUD_Operation?a[b].CRUD_Operation="Insert":"UpdateUpdate"==a[b].CRUD_Operation&&(a[b].CRUD_Operation="Update");f.upsertSoupEntries("recsToSync",a,c,d)}else c()},d)}function t(b,c,d,e){var f=a("mobileCaddy/syncRefresh"),g={bogus:!0};"exception"===b.type?g.status=f.HEARTBEAT_EXCEPTION:g.status=f.HEARTBEAT_FAILURE,u(g,c,d,e)}function u(b,c,d,e){console.log("in clean connection session heart beat");var f=(a("mobileCaddy/smartStoreUtils"),a("mobileCaddy/syncRefresh")),g=cordova.require("com.salesforce.plugin.smartstore"),h=a("mobileCaddy/logger"),i={},j=null;b.status==f.HEARTBEAT_NO_CONNECTION?"Sync - Refresh"==c.connSessionRec.mobilecaddy1__Session_Type__c?j="P2M RE Heartbeat No Connection":"Status Check"==c.connSessionRec.mobilecaddy1__Session_Type__c&&(j="M2P SC Heartbeat No Connection"):b.status==f.HEARTBEAT_EXCEPTION?"Sync - Refresh"==c.connSessionRec.mobilecaddy1__Session_Type__c?j=b.bogus?"P2M RE Exception/Timeout":"P2M RE Heartbeat Exception/Timeout":"Status Check"==c.connSessionRec.mobilecaddy1__Session_Type__c&&(j=b.bogus?"M2P SC Exception/Timeout":"M2P SC Heartbeat Exception/Timeout"):b.status==f.HEARTBEAT_FAILURE&&("Sync - Refresh"==c.connSessionRec.mobilecaddy1__Session_Type__c?j=b.bogus?"P2M RE Failure":"P2M RE Hearbeat Failure":"Status Check"==c.connSessionRec.mobilecaddy1__Session_Type__c&&(j=b.bogus?"M2P SC Failure":"M2P SC Heartbeat Failure")),null!==j?(c.connSessionRec.mobilecaddy1__Mobile_Process_Status__c=j,c.connSessionRec.SystemModstamp=(new Date).getTime(),c.connSessionRec.mobilecaddy1__Status__c="Closed",console.log("Upserting connection session"),g.upsertSoupEntries("Connection_Session__mc",[c.connSessionRec],function(){i.status=A,i.mc_add_status=b.status,d(i)},e)):(h.error("Unknown heartBeatObject.status. ",b.status),e())}function v(b,c,d){var e=mobileCaddy.require("mobileCaddy/devUtils"),f=a("mobileCaddy/smartStoreUtils"),g=a("mobileCaddy/logger"),h={};console.debug("maybeSyncConnSess"),f.querySoupRecsPromise("recsToSync").then(function(a){console.debug("Success from readRecords recsToSync -> "+JSON.stringify(a));var f=_.filter(a,function(a){return void 0!==a.currentConnectionSession});console.debug("connSessRTS -> "+JSON.stringify(f)),f.length>1||"M2P Conn_Sess Records Processed"!=b.mobilecaddy1__Mobile_Process_Status__c?e.syncMobileTable("Connection_Session__mc").then(function(a){console.debug("syncMobileTable -> ",JSON.stringify(a)),h.status=0,c(h)}).catch(function(a){g.warn("syncMobileTable ERROR -> ",a),d(a)}):(console.debug("maybeSyncConnSess - not syncing"),h.status=0,c(h))}).catch(function(a){g.error("querySoupRecsPromise ERROR -> ",a),d(a)})}function w(b){return new Promise(function(c,d){var e=cordova.require("com.salesforce.plugin.smartstore"),f=a("mobileCaddy/logger"),g=function(a){f.error("postProcessConnectionSession error",a),d(a)},h=Array.isArray(b)?b:[b],i={};e.upsertSoupEntries("Connection_Session__mc",h,function(a){var d=Array.isArray(b)?b:[b];d=h.map(function(a){return{Id:a.Id,SystemModstamp:a.SystemModstamp-1,mobilecaddy1__Session_Type__c:null,mobilecaddy1__Mobile_Process_Status__c:null,mobilecaddy1__Session_Created_Location_Error__c:null,mobilecaddy1__MC_Proxy_ID__c:null}}),e.upsertSoupEntries("SnapShot_Connection_Session__mc",d,function(a){var b=a.map(function(a){return{Mobile_Table_Name:"Connection_Session__mc",CRUD_Operation:"Update",SOUP_Record_Id:a._soupEntryId,Id:a.Id,LastModifiedDateTime:a.SystemModstamp}});e.upsertSoupEntries("recsToSync",b,function(){console.log("success from upsert of recs to sync"),i.status=0,c(i)},g)},g)},g)})}function x(b){return new Promise(function(c,d){var e=mobileCaddy.require("mobileCaddy/smartStoreUtils"),f=a("mobileCaddy/logger");console.log("handleUpdatedCS",b);b&&b.us&&0!==b.us.length?e.deleteRecordsForExternalId("Connection_Session__mc",b.us,"Id").then(function(a){return e.deleteRecordsForExternalId("SnapShot_Connection_Session__mc",b.us,"Id")}).then(function(a){return e.deleteRecordsForExternalId("recsToSync",b.us,"Id")}).then(function(a){console.log("handleUpdatedCS -> deleted from CS and RTS OK"),c()}).catch(function(a){f.error("handleUpdatedCS",a),c()}):c(),b&&b.uf&&0!==b.uf.length&&f.error("handleUpdatedCS -> we have uf",b.uf)})}var y=100200,z=100201,A=100600;c.exports={getRTSPendingconnSess:function(a,b){d(a,b)},CLEAN_CS_OK:A,cleanConnectionSessionHeartBeat:function(a,b,c,d){u(a,b,c,d)},cleanConnectionSessionVFEvent:function(a,b,c,d){t(a,b,c,d)},CONN_SESS_OK:y,csStatusCheck:function(a,b,c){f(a,b,c)},maybeSyncConnSess:function(a,b,c){v(a,b,c)},processM2PUpdateResponse:function(a,b,c,d){j(a,b,c,d)},postProcessConnectionSession:function(a){return w(a)},handleUpdatedCS:function(a){return x(a)}}}),b("mobileCaddy/vsnUtils",function(a,b,c){function d(a,b){return new Promise(function(b,c){null===a?m.listMobileTables(m.ALPHA,function(a){var c=q;_.each(a,function(a){c.push(a),c.push("SnapShot_"+a),localStorage.removeItem("meta-tableDEF-"+a),localStorage.removeItem("meta-tableCRUD-"+a)}),console.debug("allTables",c),b(c)},function(a){c(a)}):b([])})}function e(a,b){return new Promise(function(c,e){d(a,b).then(function(a){return Promise.all(a.map(m.deleteSoup))}).then(function(){c()}).catch(function(a){p.error(a),e(a)})})}function f(b){return new Promise(function(c,d){var f={},h=b?"Version Upgrade":"HardReset",j="";a("mobileCaddy/syncRefresh");l.readRecords("appSoup").then(function(a){return a.records.forEach(function(a){f[a.Name]=a.CurrentValue}),console.info("appSoupRecs",JSON.stringify(f)),e(null,["appSoup"])}).then(function(){j=g(f),console.log("resetURL",j);var a="";console.debug("deletedSoups OK");var e,k,l=i();"codeflow"==l&&(e=localStorage.getItem("forceOAuth"),k=localStorage.getItem("appSoup"));var n="lsItemsToPersist";if(b&&localStorage.getItem(n)){var q=JSON.parse(localStorage.getItem(n)).map(function(a){return{key:a,value:localStorage.getItem(a)}});q.push({key:n,value:localStorage.getItem(n)}),console.log(n,q),localStorage.clear(),q.forEach(function(a){localStorage.setItem(a.key,a.value)})}else localStorage.clear();if("codeflow"==l)localStorage.setItem("forceOAuth",e),localStorage.setItem("appSoup",k),a=window.location.protocol+"//"+window.location.host+"/www",c("ok");else if("platform"==l)a=window.location.href.substr(0,window.location.href.indexOf("#"));else{var r="";navigator&&navigator.connection&&(r=navigator.connection.type);var s;if(window.device&&(s=window.device),navigator.appVersion.includes("Electron")){s=ipcRenderer.sendSync("request-device-info",""),r="wifi";var t="landscape"}a=j+"?deviceUuid="+s.uuid+"&deviceName="+s.name+"&deviceCordova="+s.cordova+"&deviceVersion="+s.version+"&deviceModel="+s.model+"&buildName="+f.buildName+"&buildVersion="+f.buildVersion+"&buildOS="+f.buildOS+"&knownAud="+f.audId+"&currentDv="+f.dynVersionNumber+"&orientation="+t+"&viewportWidth="+$j(window).width()+"&viewportHeight="+$j(window).height()+"&sessionType="+h+"&connType="+r+"&loginUrl="+f.loginUrl+"&millsFromEpoch="+(new Date).getTime()}o.updateNewValueInAppSoup("buildStatus","Resetting").then(function(){console.info("AppSoup Updated for reset"),m.deleteSoup("syncLib_system_data").then(function(b){console.log("Redirecting to: "+a);try{window.location.href=a}catch(a){p.errorAndDispatch("error on redirect",a),d(a)}c()}).catch(function(a){p.errorAndDispatch(a)}),c()}).catch(function(a){p.errorAndDispatch(a),d(a)})}).catch(function(a){p.errorAndDispatch(a),d(a)})})}function g(a){var b="/apex/mobilecaddy1__MobileCaddyBootstrap001_mc";switch(a.platAuthUrl){case"i":case"I":resetURL=a.instanceUrl+b;break;case"l":case"L":resetURL=a.loginUrl+b;break;case"":resetURL=void 0;break;default:resetURL=a.platAuthUrl}return resetURL||(a.authURLType||(a.authURLType="login"),resetURL="login"==a.authURLType?a.loginUrl+b:a.instanceUrl+b),resetURL}function h(b){var c=a("mobileCaddy/appDataUtils");return new Promise(function(a,d){null!==b.migrateTo&&void 0!==b.migrateTo?c.updateNewValueInAppSoup("dynVersionNumber",b.migrateTo).then(function(){a()}).catch(function(a){p.error(a),d(a)}):a()})}function i(){return"localhost:3030"==window.location.host?"codeflow":"undefined"!=typeof mockStore?navigator.appVersion.includes("Electron")?"desktop":"platform":"device"}function j(){return new Promise(function(a,b){mobileCaddy.require("mobileCaddy/smartStoreUtils").queryMobileTable("appSoup","Name","dynVersionNumber").then(function(b){a(void 0!==b[0].NewValue&&b[0].NewValue!=b[0].CurrentValue)}).catch(function(a){p.error(a),b(a)})})}function k(a){return new Promise(function(b,c){j().then(function(d){if(d&&a)return f(!0);d?l.dirtyTables().then(function(a){a.length>0?b(!1):n.getRTSPendingconnSess(function(a){if(null===a||void 0===a)return f(!0);b(!1)},function(a){b(!1)})}).catch(function(a){p.error(a),c(a)}):b(!1)}).catch(function(a){p.error(a),c(a)})})}var l=mobileCaddy.require("mobileCaddy/devUtils"),m=(cordova.require("com.salesforce.plugin.smartstore"),mobileCaddy.require("mobileCaddy/smartStoreUtils")),n=a("mobileCaddy/connSessUtils"),o=a("mobileCaddy/appDataUtils"),p=a("mobileCaddy/logger"),q=["recsToSync"];c.exports={checkForMigrateToInfo:function(a){return h(a)},clearSoups:function(a,b){return e(a,b)},getSoupsToClear:function(a,b){return d(a,b)},hardReset:function(){return f()},upgradeAvailable:function(){return j()},upgradeIfAvailable:function(a){return k(a)},_getBootstrapUrl:function(a){return g(a)}}}),b("mobileCaddy/logger",function(a,b,c){function d(){return new Promise(function(a,b){localStorage.hasLogType?a(localStorage.hasLogType):h.listMobileTableColumns("Mobile_Log__mc",h.FULL,function(b){void 0===_.find(b,{path:"mobilecaddy1__Log_Type__c"})?(localStorage.setItem("hasLogType","false"),a("false")):(localStorage.setItem("hasLogType","true"),a("true"))},function(a){b(a)})})}function e(a,b){return new Promise(function(c,e){if(1==b.length&&(b=b[0]),"object"==typeof b&&(b=JSON.stringify(b)),"number"!=typeof b&&"boolean"!=typeof b||(b=b.toString()),"string"==typeof b){a==j&&localStorage.setItem("lastErrorLog",b.substring(0,1024));var f={mobilecaddy1__Error_Text__c:b.substring(0,1024),SystemModstamp:(new Date).getTime()};i.getCachedCurrentValueFromAppSoup("audId").then(function(a){return f.mobilecaddy1__Application_User_Device__c=a,d()}).then(function(b){"true"==b&&(f.mobilecaddy1__Log_Type__c="D"+a.toString()),h.insertRecords("Mobile_Log__mc",[f],function(a){c()},function(a){e(a)})}).catch(function(a){console.error(a),e(a)})}else logger.error("Trying to log unsupported type",typeof b),e("Trying to log unsupported type"+typeof b)})}function f(a,b,c,d){var f=localStorage.getItem("logLevel");if((f=void 0===f?0:f)>=b){var g="";if(b>0){var h=d.stack.split("\n")[4];if(void 0!==h){var i=h.indexOf("at ");g=h.slice(i+2,h.length)}}var m=c[0];switch(b){case j:c[0]&&c[0].stack?m=c[0].message+", STACK:"+c[0].stack:c[1]&&c[1].stack?m+="\n"+c[1].message+", STACK:"+c[1].stack:m=c,e(b,m),console.error.apply(console,c);break;case k:f>=k&&(e(b,c),console.log.apply(console,c),console.log(g));break;default:f>=l&&(e(b,c),console.log.apply(console,c),console.log(g))}a&&(console.info("Dispatching error"),"undefined"!=typeof LOCAL_DEV&&LOCAL_DEV&&alert(m+"\n\nSee dev console for more information"))}}function g(){try{throw Error("")}catch(a){return a}}var h=(cordova.require("com.salesforce.plugin.smartstore"),a("mobileCaddy/smartStoreUtils")),i=a("mobileCaddy/appDataUtils"),j=0,k=1,l=2;c.exports={debug:function(a){return f(!1,4,arguments,g())},error:function(a){return f(!1,j,arguments)},errorAndDispatch:function(a){return f(!0,j,arguments)},info:function(a){return f(!1,3,arguments,g())},log:function(a){return f(!1,l,arguments,g())},warn:function(a){return f(!1,k,arguments,g())},hasLogType:function(){return d()}}}),b("mobileCaddy/devUtils",function(a,b,c){function d(a){var b="Analytics";return new Promise(function(c,d){var g=new Date,h=new Date(g.getFullYear(),g.getMonth(),g.getDate(),0,0,0,0).valueOf();e().then(function(){return f(h)}).then(function(d){var e={};if(0===d.length){e[a]=1;var f={Name:h,Data:JSON.stringify(e)};c(e[a]),N.upsertSoupEntries(b,[f],function(a){},function(a){M.error("Unable to insert analytic recs",a)})}else{var g=d[0];e=JSON.parse(g.Data),e[a]=void 0===e[a]?1:e[a]+1,c(e[a]),g.Data=JSON.stringify(e),N.upsertSoupEntriesWithExternalId(b,[g],"Name",function(a){},function(a){M.error(a)})}}).catch(function(a){M.error("Error in analInc",a),d(a)})})}function e(){return new Promise(function(a,b){N.soupExists("Analytics",function(c){if(c)a();else{var d=[{path:"Name",type:"integer"},{path:"Data",type:"string"}];N.registerSoup("Analytics",d,function(b){a()},function(a){b(a)})}},function(a){M.error(a),b(a)})})}function f(b){return new Promise(function(c,d){var e=a("mobileCaddy/appDataUtils"),f="";e.getCurrentValueFromAppSoup("audId").then(function(a){return f=a,L.querySoupRecsPromise("Analytics")}).then(function(a){var e=[],g=[],h=[];a.forEach(function(a){if(a.Name==b)e.push(a);else{var c={Name:a.Name.toString(),SystemModstamp:a.Name,mobilecaddy1__Error_Text__c:JSON.parse(a.Data),mobilecaddy1__Application_User_Device__c:f};M.hasLogType()&&(c.mobilecaddy1__Log_Type__c="analytic"),g.push(c),h.push(a._soupEntryId)}}),0!==g.length&&L.insertRecords("Mobile_Log__mc",g,function(a){N.removeFromSoup("Analytics",h,function(a){c(e)},function(a){M.error("Unable to insert analytic recs",a),d(a)})},function(a){M.error("Unable to insert analytic recs",a),d(a)}),c(e)}).catch(function(a){M.error("Error housekeeping Analytics",a),d(a)})})}function g(a,b,c){return console.time("MC-TIMING checkTableAccess "+a),new Promise(function(d,e){var f=function(b,f){var g=0;switch(b){case Z:g=1;break;case $:g=4;break;case aa:g=7;break;case ba:g=10;break;default:g=0}if("Y"==f.charAt(g))console.timeEnd("MC-TIMING checkTableAccess "+a),d(c);else{var h={};h.status=b+Q,h.mc_add_status=a,console.timeEnd("MC-TIMING checkTableAccess "+a),e(h)}};-1==da.indexOf(a)?localStorage["meta-tableCRUD-"+a]?f(b,localStorage["meta-tableCRUD-"+a]):L.getTableDefnColumnValue(a,"Application Record CRUD").then(function(c){localStorage["meta-tableCRUD-"+a]=c,f(b,c)}).catch(function(b){console.timeEnd("MC-TIMING checkTableAccess "+a),console.info("Opps -> "+a),e(b)}):(console.timeEnd("MC-TIMING checkTableAccess "+a),d(c))})}function h(){return new Promise(function(a,b){if(!0===USE_FORCETK){var c=force.getUserId();a(void 0!==c?c:c)}else j("userId").then(function(b){a(b)}).catch(function(a){M.error("getCurrentUserId",a),b(a)})})}function i(){var a="";return new Promise(function(b,c){j("userFirstName").then(function(b){return a=b,j("userLastName")}).then(function(c){b(a+" "+c)}).catch(function(a){M.error("getCurrentUserName",a),c(a)})})}function j(b){return new Promise(function(c,d){a("mobileCaddy/appDataUtils").getCachedCurrentValueFromAppSoup(b).then(function(a){c(a)}).catch(function(a){M.error("getCachedAppSoupValue",a),d(a)})})}function k(a){if(0===a.length)return!0;var b=a.indexOf("@"),c=a.lastIndexOf(".");return!(b<1||c<b+2||c+2>=a.length)}function l(a,b,c,d){if("_soupLastModifiedDate"==a)return d;var e=_.findWhere(c,{path:a}),f={};if(void 0===e)return f.status=b+P,f.mc_add_status=a,f;var g=0;switch(b){case Z:g=1;break;case $:g=4;break;case aa:g=7;break;default:g=0}if("Y"!=e.crud.charAt(g))return f.status=b+Q,f;try{return f.value=o(d,e.appColType,e.platColType),f}catch(c){return f.status=b+S,f.mc_add_status=c+"->"+a,f}}function m(a){return console.time("MC-TIMING listMobileTableColumns "+a),new Promise(function(b,c){localStorage["meta-tableDEF-"+a]?(console.timeEnd("MC-TIMING listMobileTableColumns "+a),b(JSON.parse(localStorage["meta-tableDEF-"+a]))):L.listMobileTableColumns(a,L.FULL,function(c){localStorage["meta-tableDEF-"+a]=JSON.stringify(c),console.timeEnd("MC-TIMING listMobileTableColumns "+a),b(c)},function(b){console.timeEnd("MC-TIMING listMobileTableColumns "+a),c(b)})})}function n(a,b,c){switch(c){case"checkbox":case"Deleted":return"true"===String(a);case"CreatedDate":case"date":case"datetime":case"LastActivtyDate":case"LastModifiedDate":case"LastReferencedDate":case"LastViewedDate":case"SystemModstamp":if(null!==a){return new Date(a)}return a;default:return a}}function o(a,b,c){switch(c){case"autonumber":throw"invalid_autonumber";case"checkbox":case"Deleted":if("boolean"==typeof a||"true"===a||"false"===a)return String(a);throw"invalid_boolean";case"date":if(a instanceof Date)return a.setUTCHours(0),a.setUTCMinutes(0),a.setUTCSeconds(0),a.setUTCMilliseconds(0),a.valueOf();if(null===a)return null;throw"invalid_date";case"datetime":if(a instanceof Date)return a.valueOf();if(null===a)return null;throw"invalid_datetime";case"email":if(k(a))return a;throw"invalid_email";default:switch(b){case"jsString":if("string"==typeof a)return a;if("number"==typeof a)return a.toString();throw"invalid_string";case"jsNumber":if("number"==typeof a||null===a)return a;throw"invalid_number";default:return a}}}function p(a,b){return console.time("MC-TIMING tableExists "+a),new Promise(function(c,d){var e={};localStorage["meta-tableCRUD-"+a]?(console.timeEnd("MC-TIMING tableExists "+a),c()):L.listMobileTables(L.ALPHA,function(f){f.concat(da).indexOf(a)>=0?(console.timeEnd("MC-TIMING tableExists "+a),c()):(e.status=b+O,e.mc_add_status=a,console.timeEnd("MC-TIMING tableExists "+a),d(e))},function(c){e.status=b+V,e.mc_add_status="Unkonwn error "+c,console.timeEnd("MC-TIMING tableExists "+a),d(e)})})}function q(a,b,c,d,e){return new Promise(function(f,g){var i={},j={};i.status=c,s().then(function(b){return b[a]&&(j=b[a]),h()}).then(function(a){$j.each(d,function(d,g){if(delete g._soupEntryId,delete g.$$HashKey,g.RecordTypeName){if(g.RecordTypeId=j[g.RecordTypeName],_.isEmpty(j))return i.status=c+P,i.mc_add_status=g.RecordTypeName,f(i);if(!g.RecordTypeId)return i.status=c+U,i.mc_add_status=g.RecordTypeName,f(i);delete g.RecordTypeName}for(var h in g)if(g.hasOwnProperty(h)&&h!=b){if(isValidFieldRes=l(h,c,e,g[h]),isValidFieldRes.status==c+P){i.status=isValidFieldRes.status,i.mc_add_status=h;break}if(isValidFieldRes.status==c+S){i.status=isValidFieldRes.status,i.mc_add_status=h;break}if(isValidFieldRes.status==c+Q){i.status=isValidFieldRes.status,i.mc_add_status=h;break}if(c==Z&&ea.indexOf(h)>=0){i.status=c+T,i.mc_add_status=h;break}g[h]=isValidFieldRes.value}if(i.status!=c+P&&i.status!=c+S&&i.status!=c+T){var k=(new Date).getTime();c==Z&&(g.CreatedById=a,g.CreatedDate=k),g.SystemModstamp=k,g.LastModifiedDate=k,g.LastModifiedById=a,g.IsDeleted="false",$j.each(e,function(a,b){if(c==Z){var d=b.crud.charAt(1);ea.indexOf(b.path)<0&&"false"==b.nillable&&"Y"==d?_.has(g,b.path)||(i.status=c+R,i.mc_add_status=b.path):("IsClosed"==b.path&&(g.IsClosed="false"),"IsWon"==b.path&&(g.IsWon="false"))}""!==b.proxyRefField&&void 0!==g[b.path]&&g[b.path].length>18&&(g[b.proxyRefField]=g[b.path])})}}),i.records=d,f(i)},function(a){M.error("validateRecords",a)})})}function r(a){return new Promise(function(b,c){p(a,ca).then(function(){return s()}).then(function(c){b(c[a])}).catch(function(a){c(a)})})}function s(){return new Promise(function(a,b){localStorage.getItem("lsDotsRecordTypes")?a(JSON.parse(localStorage.getItem("lsDotsRecordTypes"))):L.querySoupRecords("dotsRecordTypes",function(b){console.log("querySoupRecords dotsRecordTypes",b);var c={};b.forEach(function(a){var b={};JSON.parse(a.Data).forEach(function(a){a.recTypeDevName?(b[a.recTypeId]={recTypeName:a.recTypeName,recTypeDevName:a.recTypeDevName},b[a.recTypeName]=a.recTypeId,b[a.recTypeDevName]=a.recTypeId):(b[a.recTypeId]=a.recTypeName,b[a.recTypeName]=a.recTypeId)}),c[a.Table]=b}),localStorage.setItem("lsDotsRecordTypes",JSON.stringify(c)),a(c)},function(a){M.error("Error returned from upsert, message =  "+a),b(a)})})}function t(a,b,c){var d,e={};return new Promise(function(f,h){b.length>0?p(a,ba).then(function(){return m(a)}).then(function(b){return g(a,ba,b)}).then(function(d){return new Promise(function(e,f){var g=l(c,ba,d);g.status!=ba+P?q(a,c,ba,b,d).then(function(a){a.status==ba?e(a.records):(f(a),M.error(a))}):(f(g),M.error(g))})}).then(function(d){return L.queryMobileTable(a,c,b[0][c])}).then(function(b){if(0===b.length)e.status=ba+R,M.warn("deleteRecord no record found",a),e.mc_add_status="no record found",h(e);else{if(!(b[0].Id.length<19))return d=b,L.querySoupRecsPromise("recsToSync");e.status=ba+Q,M.warn("deleteRecord Cannot delete synced records"),e.mc_add_status="Cannot delete synced records",h(e)}}).then(function(b){console.debug("tableName",a),console.debug("recsToDelete",d),console.debug("rts recs",b);var c=b.reduce(function(b,c){return c.Mobile_Table_Name==a&&_.findWhere(d,{_soupEntryId:c.SOUP_Record_Id})&&b.push({_soupEntryId:c._soupEntryId}),b},[]);console.debug("rtsRecSoupIds",c),L.deleteRecordsFromSoup(d,a,function(){L.deleteRecordsFromSoup(c,"recsToSync",function(){e.status=ba,e.records=d,f(e)},function(a){h(a)})},function(a){h(a)})}).catch(function(a){h(a)}):(e.status=ba,M.warn("deleteRecord No records supplied"),e.mc_add_status="No records supplied",e.records=[],f(e))})}function u(){return new Promise(function(a,b){y("recsToSync").then(function(b){var c=[],d=[];b.records.forEach(function(a){"Connection_Session__mc"!=a.Mobile_Table_Name&&void 0===c[a.Mobile_Table_Name]&&(c[a.Mobile_Table_Name]=!0,d.push(a.Mobile_Table_Name))}),a(d)}).catch(function(a){M.error(a),b(a)})})}function v(a,b){return new Promise(function(c,d){a.length>0&&-1==da.indexOf(b)?s().then(function(d){if(d[b]){var e=d[b],f=a.map(function(a){return"object"==typeof e[a.RecordTypeId]?(a.RecordTypeName=e[a.RecordTypeId].recTypeName,a.RecordTypeDevName=e[a.RecordTypeId].recTypeDevName):a.RecordTypeName=e[a.RecordTypeId],a.RecordTypeName||M.warn("enrichWithRecordTypeNames",a.RecordTypeId),a});c(f)}else c(a)}).catch(function(a){d(a)}):c(a)})}function w(a,b){var c=JSON.parse(JSON.stringify(b)),d={};return new Promise(function(b,e){p(a,Z).then(function(){return m(a)}).then(function(b){return g(a,Z,b)}).then(function(b){return new Promise(function(d,e){q(a,null,Z,c,b).then(function(a){a.status==Z?d(a.records):e(a)})})}).then(function(c){L.insertRecords(a,c,function(a){d.status=Z,d.records=a,mobileCaddy.require("mobileCaddy/vsnUtils").upgradeAvailable().then(function(a){d.upgradeAvailable=a,b(d)}).catch(function(a){b(d),M.error(a)})},function(a){e(a),M.error(a)})}).catch(function(a){e(a),M.error(a)})})}function x(){console.log("Logout requested"),localStorage.clear(),navigator.appVersion.includes("Electron")?ipcRenderer.sendSync("logout",""):cordova.require("com.salesforce.plugin.sfaccountmanager").logout()}function y(a,b){var c={},d="MC-TIMING readRecords "+a;return console.time(d),new Promise(function(b,e){p(a,$).then(function(){return g(a,$)}).then(function(){return m(a)}).then(function(f){L.querySoupRecords(a,function(g){if(c.status=$,g.length>0)-1==da.indexOf(a)?L.getTableDefnColumnValue(a,"Last Refresh Date/Time").then(function(b){return z(a,g,f,b,c)}).then(function(a){console.timeEnd(d),b(a)}).catch(function(a){e(a),M.error(a)}):z(a,g,f,null,c).then(function(a){console.timeEnd(d),b(a)});else{c.records=[];mobileCaddy.require("mobileCaddy/vsnUtils").upgradeAvailable().then(function(a){c.upgradeAvailable=a,console.timeEnd(d),b(c)}).catch(function(a){console.timeEnd(d),b(c),M.error(a)})}},function(a){console.timeEnd(d),e(a),M.error(a)})},function(a){console.timeEnd(d),e(a),M.error(a)})})}function z(a,b,c,d,e){return new Promise(function(f,g){$j.each(b,function(a,b){for(var e in b){var f=_.findWhere(c,{path:e});void 0!==f&&(b[e]=n(b[e],f.appColType,f.platColType),"LastModifiedDate"==e&&(b.dirtyFlag=D(b[e],d)))}}),e.records=b.filter(function(a){return"object"==typeof a}),v(e.records,a).then(function(a){return e.records=a,mobileCaddy.require("mobileCaddy/vsnUtils").upgradeAvailable()}).then(function(a){e.upgradeAvailable=a,f(e)}).catch(function(a){f(e),M.error(a)})})}function A(a,b){return new Promise(function(c,d){var e,f,h,i=cordova.require("com.salesforce.plugin.smartstore"),j={},k=/FROM\s+\{(\S*)\}/gi,l=k.exec(a),n=b||1e3;tableName=l[1],C(tableName,a).then(function(a){var b=a[0];return h=a[1],console.debug("smartSql2",b,h),e=i.buildSmartQuerySpec(b,n),console.debug("querySpec",e),f="MC-TIMING smartRead "+tableName,console.time(f),p(tableName,$)}).then(function(){return g(tableName,$)}).then(function(){return m(tableName)}).then(function(a){L.smartQuerySoupRecordsWithQuerySpec(e,function(b){if(j.status=$,b.length>0)-1==da.indexOf(tableName)&&h?L.getTableDefnColumnValue(tableName,"Last Refresh Date/Time").then(function(c){return B(tableName,b,a,c,j)}).then(function(a){console.timeEnd(f),c(a)}):B(tableName,b,a,null,j).then(function(a){console.timeEnd(f),c(a)});else{j.records=[];mobileCaddy.require("mobileCaddy/vsnUtils").upgradeAvailable().then(function(a){j.upgradeAvailable=a,console.timeEnd(f),c(j)}).catch(function(a){console.timeEnd(f),c(j),M.error(a)})}},function(){d()})},function(a){console.timeEnd(f),d(a),M.error(a)})})}function B(a,b,c,d,e){return new Promise(function(f,g){var h=[],i=!0;$j.each(b,function(a,b){var e;if(b[1]&&"object"==typeof b[1]){e=b[1];for(var f in e){var g=_.findWhere(c,{path:f});void 0!==g&&(e[f]=n(e[f],g.appColType,g.platColType),"LastModifiedDate"==f&&(b[1].dirtyFlag=D(b[1][f],d)))}}else e=b,i=!1;h.push(e)}),e.records=h.filter(function(a){return"object"==typeof a});var j=mobileCaddy.require("mobileCaddy/vsnUtils");i?v(e.records,a).then(function(a){return e.records=a,j.upgradeAvailable()}).then(function(a){e.upgradeAvailable=a,f(e)}).catch(function(a){f(e),M.error(a)}):j.upgradeAvailable().then(function(a){e.upgradeAvailable=a,f(e)}).catch(function(a){f(e),M.error(a)})})}function C(a,b){return new Promise(function(c,d){var e=!0;"*"!==b.match(/SELECT\s+(.*)\s+FROM/i)[1]&&(e=!1);var f=b.match(/\s+FROM\s+{(.*)}\s+WHERE (.* = .*)/i);if(console.debug("m",f),null!==f&&null!==f[1]){var g=b,h=f[2].split("AND"),i={},j="";h.forEach(function(a){mWhere=a.match(/{(.*):(.*)}\s+=\s+(.*)/i),whereField=mWhere[2],j=mWhere[3].split("'")[1],i[whereField]=j}),void 0!==i.Id&&i.Id.length>18?L.getProxyFieldName(a).then(function(a){console.log("proxyFieldName",a),g=g.replace("Id} =",a+"} ="),c([g,e])}):c([g,e])}else c([b,e])})}function D(a,b){return b&&"null"!=b||(b=0),a.valueOf()>b}function E(b){return new Promise(function(c,d){var e=a("mobileCaddy/syncRefresh"),f=function(a){console.debug("innerProcessRefreshTablePromise res",a),c(a)},g=function(a){M.error("innerProcessRefreshTablePromise error",a),d(a)},h={table:b};e.p2mRefreshTable(b,0,!1,1,1,null,function(a){console.debug("refreshStatusObject",a),a.status==e.P2M_REFRESH_OK?(h.status=X,f(h)):(h.status=a.status,h.mc_add_status=a.mc_add_status,f(h))},g)})}function F(b){return console.time("initialSync"),new Promise(function(c,d){if(0===b.length)c({status:W+R});else{var e={},f=a("mobileCaddy/syncRefresh");f.heartBeat(function(g){if(console.log("heartbeat call gave "+g.status),g.status==f.HEARTBEAT_OK||g.status==f.HEARTBEAT_NOT_DEVICE||g.status==f.HEARTBEAT_REFRESHED_OK){var h=[];console.debug("tableNames",JSON.stringify(b)),u().then(function(a){return console.debug("dirtyTableNames",a),a.forEach(function(a){dirtyIndex=b.indexOf(a),dirtyIndex>-1&&(h.push({table:a,status:Y,mc_add_status:"Dirty records"}),b.splice(dirtyIndex,1))}),console.debug("tableNames",b),console.debug("resArr",h),G(b)}).then(function(b){console.debug("doInitialSync res",b);var e=h.concat(b).filter(function(a){return a});console.debug("Promise.all resArrFinal",e),console.timeEnd("initialSync"),c(e);var f=a("mobileCaddy/connSessUtils"),g={mobilecaddy1__Mobile_Process_Status__c:""};I().then(function(a){f.maybeSyncConnSess(g,function(){console.log("success return from maybeSyncConnSess")},function(a){d(a),M.error(a)})})}).catch(function(b){if(Array.isArray(b)){var c=h.concat(b).filter(function(a){return a});console.debug("Promise.all resArrFinal",c),console.timeEnd("initialSync"),M.error("InitialSync Failed"),J("Mobile_Log__mc").then(function(b){var e=a("mobileCaddy/connSessUtils"),f={mobilecaddy1__Mobile_Process_Status__c:""};I().then(function(a){e.maybeSyncConnSess(f,function(){console.log("success return from maybeSyncConnSess"),J("Mobile_Log__mc"),d(c)},function(a){d(a),M.error(a)})})}).catch(function(a){M.error("Failed sending Mobile Logs"),d(a)}),d(c)}else d(b),M.error(b)})}else e.status=Y,e.mc_add_status=g.status,c(e),100101==e.mc_add_status||100102==e.mc_add_status?M.error(e):M.log(e)},function(a){M.error(a),e.status=Y,c(e)})}})}function G(a,b,c){return new Promise(function(d,e){b||(b=[]),c||(c=1);var f,g=3;console.log("attemptDoInitialSync",a,b,c),H(a).then(function(h){if(console.debug("doInitialSync res",h),h.forEach(function(a,c){a&&(b.push(a),a.status!=X&&void 0===f&&(f=c))}),console.debug("Promise.all successAccum",b),console.timeEnd("initialSync"),void 0!==f)if(c<g){var i=a.splice(f,a.length-f);G(i,b,c+1).then(function(a){d(a)}).catch(function(a){e(a)})}else e(b);else d(b)})})}function H(a){var b=(Promise.resolve(),[]);return a.reduce(function(a,c){return a.then(function(a){return a&&a[a.length-1].status!=X?Promise.resolve():E(c)}).then(function(a){return a&&b.push(a),b}).catch(function(a){M.errorAndDispatch(a)})},Promise.resolve())}function I(){return new Promise(function(a,b){var c="SELECT * FROM {Connection_Session__mc} WHERE {Connection_Session__mc:mobilecaddy1__Mobile_Process_Status__c} = 'P2M RE Exception/Timeout'";console.log("setinitialSyncFailCSStatus soql",c),querySpec=N.buildSmartQuerySpec(c,100),L.smartQuerySoupRecordsWithQuerySpec(querySpec,function(b){console.log("recs",JSON.stringify(b));var c=b.map(function(a){return a[1].mobilecaddy1__Mobile_Process_Status__c="P2M InitialSync Faliure",a[1]});N.upsertSoupEntries("Connection_Session__mc",c,function(b){console.log("setinitialSyncFailCSStatus update OK",b);var c=b.map(function(a){return{Id:a.Id,SystemModstamp:a.SystemModstamp-1,mobilecaddy1__Session_Type__c:null,mobilecaddy1__Mobile_Process_Status__c:null,mobilecaddy1__Session_Created_Location_Error__c:null,mobilecaddy1__MC_Proxy_ID__c:null}});N.upsertSoupEntries("SnapShot_Connection_Session__mc",c,function(b){console.log("setinitialSyncFailCSStatus update OK",b);var c=b.map(function(a){return{Mobile_Table_Name:"Connection_Session__mc",CRUD_Operation:"Insert",SOUP_Record_Id:a._soupEntryId,Id:a.Id,LastModifiedDateTime:a.SystemModstamp}});N.upsertSoupEntries("recsToSync",c,function(){a()},function(a){M.error(a)})},function(a){M.error(a)})},function(a){M.error(a)}),a()},function(a){M.error(a),b(a)})})}function J(b,c,d,e,f){c=void 0===c||c;var g=a("mobileCaddy/connSessUtils"),h=a("mobileCaddy/syncRefresh"),i=a("mobileCaddy/smartStoreUtils");a("mobileCaddy/mobileLogger");d||(d=0),e||(e=50),f||(f=!1);var j=function(a,b,c){var e={};h.p2mRefreshTable(a,d,!0,1,1,null,function(a){console.debug("refreshStatusObject",a),a.status==h.P2M_REFRESH_OK?(e.status=X,b(e)):(e.status=a.status,e.mc_add_status=a.mc_add_status,b(e))},c)},k=function(a,b,c){var f={};i.queryMobileTable("recsToSync","Mobile_Table_Name",a,function(g){if(g.length>0)try{h.m2pUpdateMobileTable(a,e,function(e){console.log("m2pStatusObject",e),e.status==h.M2P_UPDATE_OK&&void 0===e.mc_add_status?(d=0,f.status=0,b(f)):e.status==h.M2P_UPDATE_OK&&"more-to-sync"===e.mc_add_status?(console.log("moreToSync - Going round again"),k(a,b,c)):(f.status=e.status,f.mc_add_status=e.mc_add_status,b(f))},c)}catch(a){console.error(a)}else f.status=2,f.mc_add_status="no-sync-no-updates",b(f)},c)},l=function(a,b,c,d,e){var g={};console.log("skipP2M",f),"Dynamic (Submit First/Retain)"==b||"Dynamic (Submit First/Clear)"==b?k(a,function(b){console.log("statusObject",b),!f&&(0===b.status||c&&2==b.status)?j(a,d,e):f&&0===b.status||2==b.status?(g.status=X,g.mc_add_status=b.mc_add_status,d(g)):(g.status=Y,g.mc_add_status=b.mc_add_status,d(g))},e):"Submit Only"==b||"Submit & Clear"==b||"Submit & Destroy"==b?k(a,function(a){0===a.status?(g.status=X,d(g)):(g.status=Y,g.mc_add_status=a.mc_add_status,d(g))},e):M.errorAndDispatch("Unknown sync type",b,f)};return new Promise(function(a,d){var e={},f=function(b){localStorage.removeItem("syncInProgressTime"),a(b)},k=function(a){localStorage.removeItem("syncInProgressTime"),d(a)},m="syncTime"+b,n=localStorage.getItem(m),o=(new Date).valueOf(),q=n?parseInt(n)+5e3:0;"Connection_Session__mc"!=b&&o<q?(e.status=X,e.mc_add_status="sync-too-soon",a(e)):(localStorage.setItem(m,o),p(b,W).then(function(){h.heartBeat(function(m){if(console.log("heartbeat call gave "+m.status),m.status==h.HEARTBEAT_OK||m.status==h.HEARTBEAT_NOT_DEVICE||m.status==h.HEARTBEAT_REFRESHED_OK){var n=localStorage.getItem("syncInProgressTime"),o=(new Date).valueOf();console.log("syncInProgressTime",n,o),"Connection_Session__mc"!=b&&n&&n>o-12e4?(console.log("SYNC_ALREADY_IN_PROGRESS"),e.status=100498,k(e)):(localStorage.setItem("syncInProgressTime",o),i.getTableDefnColumnValue(b,"Sync Type").then(function(h){g.getRTSPendingconnSess(function(i){"Mobile_Log__mc"!=b?null!==i&&void 0!==i?g.csStatusCheck(i,function(d){d.status==g.CONN_SESS_OK?"Refresh Only"==h||"Refresh & Clear"==h?j(b,f,k):l(b,h,c,f,k):(e.status=X,e.mc_add_status=d.status,a(e))},function(a){M.errorAndDispatch(a),d(a)}):"Refresh Only"==h||"Refresh & Clear"==h?j(b,f,k):l(b,h,c,f,k):l(b,h,!1,f,k)},k)}).catch(function(a){k(a)}))}else e.status=Y,e.mc_add_status=m.status,a(e),100101==e.mc_add_status||100102==e.mc_add_status?M.error(e):M.log(e)},k)}).catch(k))})}function K(a,b,c){var d=JSON.parse(JSON.stringify(b)),e={};return new Promise(function(b,f){d.length>0?p(a,aa).then(function(){return m(a)}).then(function(b){return g(a,aa,b)}).then(function(b){return new Promise(function(e,f){var g=l(c,aa,b);g.status!=aa+P?q(a,c,aa,d,b).then(function(a){a.status==aa?e(a.records):f(a)}):f(g)})}).then(function(d){L.updateRecordsWithExternalId(a,d,c,function(a){e.status=aa,e.records=a,mobileCaddy.require("mobileCaddy/vsnUtils").upgradeAvailable().then(function(a){e.upgradeAvailable=a,b(e)}).catch(function(a){b(e)})},function(a){f(a),M.error(a)})},function(a){f(a),M.error(a)}):(e.status=aa,e.mc_add_status="No records supplied",e.records=[],b(e),M.warn(e))})}var L=a("mobileCaddy/smartStoreUtils"),M=(a("mobileCaddy/mobileLogger"),a("mobileCaddy/logger")),N=cordova.require("com.salesforce.plugin.smartstore"),O=1,P=2,Q=3,R=4,S=5,T=6,U=8,V=99,W=100400,X=W,Y=100402,Z=100700,$=101e3,aa=101100,ba=101200,ca=101300,da=["syncLib_system_data","appSoup","cacheSoup","recsToSync","SnapShot_Connection_Session__mc"],ea=["autonumber","CreatedById","CreatedDate","IsDeleted","IsClosed","IsWon","LastModifiedById","LastModifiedDate","LastReferencedDate","mobilecaddy1__MC_Proxy_ID","MC_Proxy_ID","OwnerId","SystemModstamp","Id","dirtyFlag"];c.exports={SYNC_OK:X,SYNC_NOK:Y,SYNC_ALREADY_IN_PROGRESS:W+98,SYNC_UNKONWN_TABLE:W+O,SYNC_MANDATORY_MISSING:W+R,DELETE_RECS_OK:ba,DELETE_RECS_UNKONWN_TABLE:ba+O,DELETE_RECS_UNKONWN_FIELD:ba+P,DELETE_RECS_ACCESS_DENIED:ba+Q,DELETE_RECS_MANDATORY_MISSING:ba+R,INSERT_RECS_OK:Z,INSERT_RECS_UNKONWN_TABLE:Z+O,INSERT_RECS_UNKONWN_FIELD:Z+P,INSERT_RECS_ACCESS_DENIED:Z+Q,INSERT_RECS_MANDATORY_MISSING:Z+R,INSERT_RECS_DATATYPE_MISMATCH:Z+S,INSERT_RECS_PROTECTED_FIELD:Z+T,INSERT_RECS_UNKNOWN_RECORD_TYPE:Z+U,READ_RECS_OK:$,READ_RECS_UNKONWN_TABLE:$+O,READ_RECS_ACCESS_DENIED:$+Q,UPDATE_RECS_OK:aa,UPDATE_RECS_OK:aa,UPDATE_RECS_UNKONWN_TABLE:aa+O,UPDATE_RECS_UNKONWN_FIELD:aa+P,UPDATE_RECS_ACCESS_DENIED:aa+Q,UPDATE_RECS_DATATYPE_MISMATCH:aa+S,UPDATE_RECS_UNKNOWN_ID:aa+7,UPDATE_RECS_UNKNOWN_RECORD_TYPE:aa+U,GET_REC_TYPES_UNKONWN_TABLE:ca+O,analInc:function(a){return d(a)},deleteRecord:function(a,b,c){return t(a,[b],c)},dirtyTables:function(){return u()},syncMobileTable:function(a,b,c,d,e){return J(a,b,c,d,e)},initialSync:function(a){return F(a)},getCurrentUserId:function(){return h()},getCurrentUserName:function(){return i()},getUserLocale:function(){return j("userLocale")},getCachedAppSoupValue:function(a){return j(a)},getRecordTypes:function(a){return r(a)},insertRecord:function(a,b){return w(a,[b])},insertRecords:function(a,b){return w(a,b)},logout:function(){return x()},readRecords:function(a,b){return y(a,b)},smartSql:function(a,b){return A(a,b)},updateRecord:function(a,b,c){return K(a,[b],c)},updateRecords:function(a,b,c){return K(a,b,c)},maybeReadTransformType:function(a,b,c){return n(a,b,c)},maybeWriteTransformType:function(a,b,c){return o(a,b,c)}}}),window.mobileCaddy=a("mobileCaddy")}();