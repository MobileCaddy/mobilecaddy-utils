/* mobilecaddy-utils - v2.0.0 - Bundle Time: 2018-05-25 11:48:51 */
/* git info: "2018-05-24 16:05:38 +0100": ea33860aa98ffe3fa054c62a8407c220e0bcdf5e (v2) */
/* Copyright 2018 MobileCaddy Ltd */

"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports._getBootstrapUrl=exports.upgradeIfAvailable=exports.upgradeAvailable=exports.hardReset=exports.getSoupsToClear=exports.clearSoups=void 0;var _appDataUtils=require("./appDataUtils"),appDataUtils=_interopRequireWildcard(_appDataUtils),_smartStoreUtils=require("./smartStoreUtils"),smartStoreUtils=_interopRequireWildcard(_smartStoreUtils),_syncRefresh=require("./syncRefresh"),syncRefresh=_interopRequireWildcard(_syncRefresh),_logger=require("./logger"),logger=_interopRequireWildcard(_logger);function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(r[o]=e[o]);return r.default=e,r}var smartstore=cordova.require("com.salesforce.plugin.smartstore"),SYSTEM_TABLES=["recsToSync"];function getSoupsToClear(e,r){return new Promise(function(r,o){null===e?smartStoreUtils.listMobileTables(smartStoreUtils.ALPHA,function(e){var o=SYSTEM_TABLES;_.each(e,function(e){o.push(e),o.push("SnapShot_"+e),localStorage.removeItem("meta-tableDEF-"+e),localStorage.removeItem("meta-tableCRUD-"+e)}),console.debug("allTables",o),r(o)},function(e){o(e)}):r([])})}function clearSoups(e,r){return new Promise(function(o,t){getSoupsToClear(e,r).then(function(e){return Promise.all(e.map(smartStoreUtils.deleteSoup))}).then(function(){o()}).catch(function(e){logger.error(e),t(e)})})}function hardReset(e){return new Promise(function(r,o){var t={},n=e?"Version Upgrade":"HardReset",a="";testRefreshAccessToken().then(function(){smartStoreUtils.querySoupRecsPromise("appSoup").then(function(e){return e.records.forEach(function(e){t[e.Name]=e.CurrentValue}),console.info("appSoupRecs",JSON.stringify(t)),clearSoups(null,["appSoup"])}).then(function(){a=getBootstrapUrl(t),console.log("resetURL",a);var e="";console.debug("deletedSoups OK");var i,s,l=getAppEnv();if("codeflow"==l&&(i=localStorage.getItem("forceOAuth"),s=localStorage.getItem("appSoup")),localStorage.clear(),"codeflow"==l)localStorage.setItem("forceOAuth",i),localStorage.setItem("appSoup",s),e=window.location.protocol+"//"+window.location.host+"/www",r("ok");else if("platform"==l)e=window.location.href.substr(0,window.location.href.indexOf("#"));else{var c,u="";if(navigator&&navigator.connection&&(u=navigator.connection.type),window.device&&(c=window.device),navigator.appVersion.includes("Electron")){c=ipcRenderer.sendSync("request-device-info",""),u="wifi";var p="landscape"}var d=d||p;e=a+"?deviceUuid="+c.uuid+"&deviceName="+c.name+"&deviceCordova="+c.cordova+"&deviceVersion="+c.version+"&deviceModel="+c.model+"&buildName="+t.buildName+"&buildVersion="+t.buildVersion+"&buildOS="+t.buildOS+"&knownAud="+t.audId+"&currentDv="+t.dynVersionNumber+"&orientation="+d+"&viewportWidth="+window.innerWidth+"&viewportHeight="+window.innerHeight+"&sessionType="+n+"&connType="+u+"&loginUrl="+t.loginUrl+"&millsFromEpoch="+(new Date).getTime()}appDataUtils.updateNewValueInAppSoup("buildStatus","Resetting").then(function(){console.info("AppSoup Updated for reset"),smartStoreUtils.deleteSoup("syncLib_system_data").then(function(t){console.log("Redirecting to: "+e);try{window.location.href=e}catch(e){logger.errorAndDispatch("error on redirect",e),o(e)}r()}).catch(function(e){logger.errorAndDispatch(e)}),r()}).catch(function(e){logger.errorAndDispatch(e),o(e)})}).catch(function(e){logger.errorAndDispatch(e),o(e)})}).catch(function(e){logger.error("Tokens are bad, testRefreshAccessToken rejected with: "+JSON.stringify(e)),window.history.go(-(history.length-1)),navigator.appVersion.includes("Electron")||cordova.require("com.salesforce.plugin.sfaccountmanager").logout(),o(e)})})}function getBootstrapUrl(e){var r="/apex/mobilecaddy1__MobileCaddyBootstrap001_mc";switch(e.platAuthUrl){case"i":case"I":resetURL=e.instanceUrl+r;break;case"l":case"L":resetURL=e.loginUrl+r;break;case"":resetURL=void 0;break;default:resetURL=e.platAuthUrl}return resetURL||(e.authURLType||(e.authURLType="login"),resetURL="login"==e.authURLType?e.loginUrl+r:e.instanceUrl+r),resetURL}function testRefreshAccessToken(){return new Promise(function(e,r){syncRefresh.refreshToken(function(r){console.debug("Successfully refreshed access token. Continue reset."),e("ok")},function(e){console.error("Unable to refresh access token. Abort reset: "+JSON.stringify(e)),r(e)})})}function getAppEnv(){return"localhost:3030"==window.location.host?"codeflow":"undefined"!=typeof mockStore?navigator.appVersion.includes("Electron")?"desktop":"platform":"device"}function upgradeAvailable(){return new Promise(function(e,r){smartStoreUtils.queryMobileTable("appSoup","Name","dynVersionNumber").then(function(r){void 0!==r[0].NewValue&&r[0].NewValue!=r[0].CurrentValue?e(!0):e(!1)}).catch(function(e){logger.error(e),r(e)})})}function upgradeIfAvailable(e){return new Promise(function(r,o){upgradeAvailable().then(function(t){if(t&&e)return hardReset(!0);t?devUtils.dirtyTables().then(function(e){e.length>0?r(!1):syncRefresh.getRTSPendingconnSess(function(e){if(null===e||void 0===e)return hardReset(!0);r(!1)},function(e){r(!1)})}).catch(function(e){logger.error(e),o(e)}):r(!1)}).catch(function(e){logger.error(e),o(e)})})}function _getBootstrapUrl(e){return getBootstrapUrl(e)}exports.clearSoups=clearSoups,exports.getSoupsToClear=getSoupsToClear,exports.hardReset=hardReset,exports.upgradeAvailable=upgradeAvailable,exports.upgradeIfAvailable=upgradeIfAvailable,exports._getBootstrapUrl=_getBootstrapUrl;