/* mobilecaddy-utils - v2.0.0 - Bundle Time: 2018-04-06 13:52:50 */
/* git info: "2018-04-06 13:49:20 +0100": 7877a293eee62da2c63a04332bb68746c8312d48 (v2) */
/* Copyright 2018 MobileCaddy Ltd */

"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.maybeWriteTransformType=exports.maybeReadTransformType=exports.updateRecords=exports.updateRecord=exports.smartSql=exports.readRecords=exports.logout=exports.insertRecords=exports.insertRecord=exports.getRecordTypes=exports.getCachedAppSoupValue=exports.getUserLocale=exports.getCurrentUserName=exports.getCurrentUserId=exports.initialSync=exports.syncMobileTable=exports.dirtyTables=exports.deleteRecord=exports.analInc=exports.GET_REC_TYPES_UNKONWN_TABLE=exports.UPDATE_RECS_UNKNOWN_RECORD_TYPE=exports.UPDATE_RECS_UNKNOWN_ID=exports.UPDATE_RECS_DATATYPE_MISMATCH=exports.UPDATE_RECS_ACCESS_DENIED=exports.UPDATE_RECS_UNKONWN_FIELD=exports.UPDATE_RECS_UNKONWN_TABLE=exports.UPDATE_RECS_OK=exports.READ_RECS_ACCESS_DENIED=exports.READ_RECS_UNKONWN_TABLE=exports.READ_RECS_OK=exports.INSERT_RECS_UNKNOWN_RECORD_TYPE=exports.INSERT_RECS_PROTECTED_FIELD=exports.INSERT_RECS_DATATYPE_MISMATCH=exports.INSERT_RECS_MANDATORY_MISSING=exports.INSERT_RECS_ACCESS_DENIED=exports.INSERT_RECS_UNKONWN_FIELD=exports.INSERT_RECS_UNKONWN_TABLE=exports.INSERT_RECS_OK=exports.DELETE_RECS_MANDATORY_MISSING=exports.DELETE_RECS_ACCESS_DENIED=exports.DELETE_RECS_UNKONWN_FIELD=exports.DELETE_RECS_UNKONWN_TABLE=exports.DELETE_RECS_OK=exports.SYNC_MANDATORY_MISSING=exports.SYNC_UNKONWN_TABLE=exports.SYNC_ALREADY_IN_PROGRESS=exports.SYNC_NOK=exports.SYNC_OK=void 0;var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_smartStoreUtils=require("./smartStoreUtils"),smartStoreUtils=_interopRequireWildcard(_smartStoreUtils),_appDataUtils=require("./appDataUtils"),appDataUtils=_interopRequireWildcard(_appDataUtils),_connSessUtils=require("./connSessUtils"),connSessUtils=_interopRequireWildcard(_connSessUtils),_syncRefresh=require("./syncRefresh"),syncRefresh=_interopRequireWildcard(_syncRefresh),_vsnUtils=require("./vsnUtils"),vsnUtils=_interopRequireWildcard(_vsnUtils),_logger=require("./logger"),logger=_interopRequireWildcard(_logger),_underscore=require("underscore"),_=_interopRequireWildcard(_underscore);function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}var smartstore=cordova.require("com.salesforce.plugin.smartstore"),UNKONWN_TABLE=1,UNKONWN_FIELD=2,ACCESS_DENIED=3,MANDATORY_MISSING=4,DATATYPE_MISMATCH=5,PROTECTED_FIELD=6,UNKNOWN_ID=7,UNKNOWN_RECORD_TYPE=8,SYNC_ALREADY_IN_PROGRESS_INC=98,UNKONWN_ERR=99,SYNC=100400,SYNC_NOK_STATUS=100402,INSERT_RECS=100700,READ_RECS=101e3,UPDATE_RECS=101100,DELETE_RECS=101200,GET_REC_TYPES=101300,SYSTEM_TABLES=["syncLib_system_data","appSoup","cacheSoup","recsToSync","SnapShot_Connection_Session__mc"],PROTECTED_FIELDS=["autonumber","CreatedById","CreatedDate","IsDeleted","IsClosed","IsWon","LastModifiedById","LastModifiedDate","LastReferencedDate","mobilecaddy1__MC_Proxy_ID","MC_Proxy_ID","OwnerId","SystemModstamp","Id","dirtyFlag"];function analInc(e){return new Promise(function(t,r){var s=new Date,n=new Date(s.getFullYear(),s.getMonth(),s.getDate(),0,0,0,0).valueOf();maybeCreateAnalyticTable().then(function(){return getCurAnalyticsAndHousekeep(n)}).then(function(r){var s={};if(0===r.length){s[e]=1;var o={Name:n,Data:JSON.stringify(s)};t(s[e]),smartstore.upsertSoupEntries("Analytics",[o],function(e){},function(e){logger.error("Unable to insert analytic recs",e)})}else{var a=r[0];(s=JSON.parse(a.Data))[e]=void 0===s[e]?1:s[e]+1,t(s[e]),a.Data=JSON.stringify(s),smartstore.upsertSoupEntriesWithExternalId("Analytics",[a],"Name",function(e){},function(e){logger.error(e)})}}).catch(function(e){logger.error("Error in analInc",e),r(e)})})}function maybeCreateAnalyticTable(){return new Promise(function(e,t){smartstore.soupExists("Analytics",function(r){if(r)e();else{smartstore.registerSoup("Analytics",[{path:"Name",type:"integer"},{path:"Data",type:"string"}],function(t){e()},function(e){t(e)})}},function(e){logger.error(e),t(e)})})}function getCurAnalyticsAndHousekeep(e){return new Promise(function(t,r){var s="";appDataUtils.getCurrentValueFromAppSoup("audId").then(function(e){return s=e,smartStoreUtils.querySoupRecsPromise("Analytics")}).then(function(n){var o=[],a=[],c=[];n.forEach(function(t){if(t.Name==e)o.push(t);else{var r={Name:t.Name.toString(),SystemModstamp:t.Name,mobilecaddy1__Error_Text__c:JSON.parse(t.Data),mobilecaddy1__Application_User_Device__c:s};logger.hasLogType()&&(r.mobilecaddy1__Log_Type__c="analytic"),a.push(r),c.push(t._soupEntryId)}}),0!==a.length&&smartStoreUtils.insertRecords("Mobile_Log__mc",a,function(e){smartstore.removeFromSoup("Analytics",c,function(e){t(o)},function(e){logger.error("Unable to insert analytic recs",e),r(e)})},function(e){logger.error("Unable to insert analytic recs",e),r(e)}),t(o)}).catch(function(e){logger.error("Error housekeeping Analytics",e),r(e)})})}function checkTableAccess(e,t,r){return console.time("MC-TIMING checkTableAccess "+e),new Promise(function(s,n){var o=function(t,o){var a=0;switch(t){case INSERT_RECS:a=1;break;case READ_RECS:a=4;break;case UPDATE_RECS:a=7;break;case DELETE_RECS:a=10;break;default:a=0}if("Y"==o.charAt(a))console.timeEnd("MC-TIMING checkTableAccess "+e),s(r);else{var c={};c.status=t+ACCESS_DENIED,c.mc_add_status=e,console.timeEnd("MC-TIMING checkTableAccess "+e),n(c)}};-1==SYSTEM_TABLES.indexOf(e)?localStorage["meta-tableCRUD-"+e]?o(t,localStorage["meta-tableCRUD-"+e]):smartStoreUtils.getTableDefnColumnValue(e,"Application Record CRUD").then(function(r){localStorage["meta-tableCRUD-"+e]=r,o(t,r)}).catch(function(t){console.timeEnd("MC-TIMING checkTableAccess "+e),console.info("Opps -> "+e),n(t)}):(console.timeEnd("MC-TIMING checkTableAccess "+e),s(r))})}function getCurrentUserId(){return new Promise(function(e,t){if(!0===USE_FORCETK){var r=force.getUserId();e(r)}else getCachedAppSoupValue("userId").then(function(t){e(t)}).catch(function(e){logger.error("getCurrentUserId",e),t(e)})})}function getCurrentUserName(){var e="";return new Promise(function(t,r){getCachedAppSoupValue("userFirstName").then(function(t){return e=t,getCachedAppSoupValue("userLastName")}).then(function(r){t(e+" "+r)}).catch(function(e){logger.error("getCurrentUserName",e),r(e)})})}function getUserLocale(){return getCachedAppSoupValue("userLocale")}function getCachedAppSoupValue(e){return new Promise(function(t,r){appDataUtils.getCachedCurrentValueFromAppSoup(e).then(function(e){t(e)}).catch(function(e){logger.error("getCachedAppSoupValue",e),r(e)})})}function isValidEmail(e){if(0===e.length)return!0;var t=e.indexOf("@"),r=e.lastIndexOf(".");return!(t<1||r<t+2||r+2>=e.length)}var BYTES=0,CHARS=1;function isValidStrLength(e,t,r){if(void 0===e)return!0;switch(t){case BYTES:for(var s=e.length,n=e.length-1;n>=0;n--){var o=e.charCodeAt(n);o>127&&o<=2047?s++:o>2047&&o<=65535&&(s+=2),o>=56320&&o<=57343&&n--}return s<=r;default:return!0}}function isValidFieldAndTranslate(e,t,r,s){if("_soupLastModifiedDate"==e)return s;var n=_.findWhere(r,{path:e}),o={};if(void 0===n)return o.status=t+UNKONWN_FIELD,o.mc_add_status=e,o;var a=0;switch(t){case INSERT_RECS:a=1;break;case READ_RECS:a=4;break;case UPDATE_RECS:a=7;break;default:a=0}if("Y"!=n.crud.charAt(a))return o.status=t+ACCESS_DENIED,o;try{return o.value=maybeWriteTransformType(s,n.appColType,n.platColType),o}catch(r){return o.status=t+DATATYPE_MISMATCH,o.mc_add_status=r+"->"+e,o}}function listMobileTableColumns(e){return console.time("MC-TIMING listMobileTableColumns "+e),new Promise(function(t,r){localStorage["meta-tableDEF-"+e]?(console.timeEnd("MC-TIMING listMobileTableColumns "+e),t(JSON.parse(localStorage["meta-tableDEF-"+e]))):smartStoreUtils.listMobileTableColumns(e,smartStoreUtils.FULL,function(r){localStorage["meta-tableDEF-"+e]=JSON.stringify(r),console.timeEnd("MC-TIMING listMobileTableColumns "+e),t(r)},function(t){console.timeEnd("MC-TIMING listMobileTableColumns "+e),r(t)})})}function maybeReadTransformType(e,t,r){switch(r){case"checkbox":case"Deleted":return"true"===String(e);case"CreatedDate":case"date":case"datetime":case"LastActivtyDate":case"LastModifiedDate":case"LastReferencedDate":case"LastViewedDate":case"SystemModstamp":return null!==e?new Date(e):e;default:return e}}function maybeWriteTransformType(e,t,r){switch(r){case"autonumber":throw"invalid_autonumber";case"checkbox":case"Deleted":if("boolean"==typeof e||"true"===e||"false"===e)return String(e);throw"invalid_boolean";case"date":if(e instanceof Date)return e.setUTCHours(0),e.setUTCMinutes(0),e.setUTCSeconds(0),e.setUTCMilliseconds(0),e.valueOf();if(null===e)return null;throw"invalid_date";case"datetime":if(e instanceof Date)return e.valueOf();throw"invalid_datetime";case"email":if(isValidEmail(e))return e;throw"invalid_email";default:switch(t){case"jsString":if("string"==typeof e)return e;if("number"==typeof e)return e.toString();throw"invalid_string";case"jsNumber":if("number"==typeof e||null===e)return e;throw"invalid_number";default:return e}}}function tableExists(e,t){return console.time("MC-TIMING tableExists "+e),new Promise(function(r,s){var n={};localStorage["meta-tableCRUD-"+e]?(console.timeEnd("MC-TIMING tableExists "+e),r()):smartStoreUtils.listMobileTables(smartStoreUtils.ALPHA,function(o){o.concat(SYSTEM_TABLES).indexOf(e)>=0?(console.timeEnd("MC-TIMING tableExists "+e),r()):(n.status=t+UNKONWN_TABLE,n.mc_add_status=e,console.timeEnd("MC-TIMING tableExists "+e),s(n))},function(r){n.status=t+UNKONWN_ERR,n.mc_add_status="Unkonwn error "+r,console.timeEnd("MC-TIMING tableExists "+e),s(n)})})}function validateRecords(e,t,r,s,n){return new Promise(function(o,a){var c={},i={};c.status=r,getRecordTypesMap().then(function(t){return t[e]&&(i=_.invert(t[e])),getCurrentUserId()}).then(function(e){s.forEach(function(s){if(delete s._soupEntryId,delete s.$$HashKey,s.RecordTypeName){if(s.RecordTypeId=i[s.RecordTypeName],_.isEmpty(i))return c.status=r+UNKONWN_FIELD,c.mc_add_status=s.RecordTypeName,o(c);if(!s.RecordTypeId)return c.status=r+UNKNOWN_RECORD_TYPE,c.mc_add_status=s.RecordTypeName,o(c);delete s.RecordTypeName}for(var a in s)if(s.hasOwnProperty(a)&&a!=t){if(isValidFieldRes=isValidFieldAndTranslate(a,r,n,s[a]),isValidFieldRes.status==r+UNKONWN_FIELD){c.status=isValidFieldRes.status,c.mc_add_status=a;break}if(isValidFieldRes.status==r+DATATYPE_MISMATCH){c.status=isValidFieldRes.status,c.mc_add_status=a;break}if(isValidFieldRes.status==r+ACCESS_DENIED){c.status=isValidFieldRes.status,c.mc_add_status=a;break}if(r==INSERT_RECS&&PROTECTED_FIELDS.indexOf(a)>=0){c.status=r+PROTECTED_FIELD,c.mc_add_status=a;break}s[a]=isValidFieldRes.value}if(c.status!=r+UNKONWN_FIELD&&c.status!=r+DATATYPE_MISMATCH&&c.status!=r+PROTECTED_FIELD){var l=(new Date).getTime();r==INSERT_RECS&&(s.CreatedById=e,s.CreatedDate=l),s.SystemModstamp=l,s.LastModifiedDate=l,s.LastModifiedById=e,s.IsDeleted="false",n.forEach(function(e){if(r==INSERT_RECS){var t=e.crud.charAt(1);PROTECTED_FIELDS.indexOf(e.path)<0&&"false"==e.nillable&&"Y"==t?_.has(s,e.path)||(c.status=r+MANDATORY_MISSING,c.mc_add_status=e.path):("IsClosed"==e.path&&(s.IsClosed="false"),"IsWon"==e.path&&(s.IsWon="false"))}""!==e.proxyRefField&&void 0!==s[e.path]&&s[e.path].length>18&&(s[e.proxyRefField]=s[e.path])})}}),c.records=s,o(c)},function(e){logger.error("validateRecords",e)})})}function getRecordTypes(e){return new Promise(function(t,r){tableExists(e,GET_REC_TYPES).then(function(){return getRecordTypesMap()}).then(function(r){t(r[e])}).catch(function(e){r(e)})})}function getRecordTypesMap(){return new Promise(function(e,t){localStorage.getItem("lsDotsRecordTypes")?e(JSON.parse(localStorage.getItem("lsDotsRecordTypes"))):smartStoreUtils.querySoupRecords("dotsRecordTypes",function(t){console.log("querySoupRecords dotsRecordTypes",t);var r={};t.forEach(function(e){var t={};JSON.parse(e.Data).forEach(function(e){t[e.recTypeId]=e.recTypeName}),r[e.Table]=t}),localStorage.setItem("lsDotsRecordTypes",JSON.stringify(r)),e(r)},function(e){logger.error("Error returned from upsert, message =  "+e),t(e)})})}function deleteRecord(e,t,r){return new Promise(function(s,n){return deleteRecords(e,[t],r)})}function deleteRecords(e,t,r){var s,n={};return new Promise(function(o,a){t.length>0?tableExists(e,DELETE_RECS).then(function(){return listMobileTableColumns(e)}).then(function(t){return checkTableAccess(e,DELETE_RECS,t)}).then(function(s){return new Promise(function(n,o){var a=isValidFieldAndTranslate(r,DELETE_RECS,s);a.status!=DELETE_RECS+UNKONWN_FIELD?validateRecords(e,r,DELETE_RECS,t,s).then(function(e){e.status==DELETE_RECS?n(e.records):(o(e),logger.error(e))}):(o(a),logger.error(a))})}).then(function(s){return smartStoreUtils.queryMobileTable(e,r,t[0][r])}).then(function(t){if(0===t.length)n.status=DELETE_RECS+MANDATORY_MISSING,logger.warn("deleteRecord no record found",e),n.mc_add_status="no record found",a(n);else{if(!(t[0].Id.length<19))return s=t,smartStoreUtils.querySoupRecsPromise("recsToSync");n.status=DELETE_RECS+ACCESS_DENIED,logger.warn("deleteRecord Cannot delete synced records"),n.mc_add_status="Cannot delete synced records",a(n)}}).then(function(t){console.debug("tableName",e),console.debug("recsToDelete",s),console.debug("rts recs",t);var r=t.reduce(function(t,r){return r.Mobile_Table_Name==e&&_.findWhere(s,{_soupEntryId:r.SOUP_Record_Id})&&t.push({_soupEntryId:r._soupEntryId}),t},[]);console.debug("rtsRecSoupIds",r),smartStoreUtils.deleteRecordsFromSoup(s,e,function(){smartStoreUtils.deleteRecordsFromSoup(r,"recsToSync",function(){n.status=DELETE_RECS,n.records=s,o(n)},function(e){a(e)})},function(e){a(e)})}).catch(function(e){a(e)}):(n.status=DELETE_RECS,logger.warn("deleteRecord No records supplied"),n.mc_add_status="No records supplied",n.records=[],o(n))})}function dirtyTables(){return new Promise(function(e,t){readRecords("recsToSync").then(function(t){var r=[],s=[];t.records.forEach(function(e){"Connection_Session__mc"!=e.Mobile_Table_Name&&void 0===r[e.Mobile_Table_Name]&&(r[e.Mobile_Table_Name]=!0,s.push(e.Mobile_Table_Name))}),e(s)}).catch(function(e){logger.error(e),t(e)})})}function enrichWithRecordTypeNames(e,t){return new Promise(function(r,s){e.length>0&&-1==SYSTEM_TABLES.indexOf(t)?getRecordTypesMap().then(function(s){if(s[t]){var n=s[t],o=e.map(function(e){return e.RecordTypeName=n[e.RecordTypeId],e.RecordTypeName||logger.warn("enrichWithRecordTypeNames",e.RecordTypeId),e});r(o)}else r(e)}).catch(function(e){s(e)}):r(e)})}function insertRecord(e,t){return insertRecords(e,[t])}function insertRecords(e,t){var r={};return new Promise(function(s,n){tableExists(e,INSERT_RECS).then(function(){return listMobileTableColumns(e)}).then(function(t){return checkTableAccess(e,INSERT_RECS,t)}).then(function(r){return new Promise(function(s,n){validateRecords(e,null,INSERT_RECS,t,r).then(function(e){e.status==INSERT_RECS?s(e.records):n(e)})})}).then(function(t){smartStoreUtils.insertRecords(e,t,function(e){r.status=INSERT_RECS,r.records=e,vsnUtils.upgradeAvailable().then(function(e){r.upgradeAvailable=e,s(r)}).catch(function(e){s(r),logger.error(e)})},function(e){n(e),logger.error(e)})}).catch(function(e){n(e),logger.error(e)})})}function logout(){console.log("Logout requested"),navigator.appVersion.includes("Electron")?ipcRenderer.sendSync("logout",""):cordova.require("com.salesforce.plugin.sfaccountmanager").logout()}function readRecords(e,t){var r={},s="MC-TIMING readRecords "+e;return console.time(s),new Promise(function(t,n){tableExists(e,READ_RECS).then(function(){return checkTableAccess(e,READ_RECS)}).then(function(){return listMobileTableColumns(e)}).then(function(o){smartStoreUtils.querySoupRecords(e,function(a){r.status=READ_RECS,a.length>0?-1==SYSTEM_TABLES.indexOf(e)?smartStoreUtils.getTableDefnColumnValue(e,"Last Refresh Date/Time").then(function(t){return readProcessRecs(e,a,o,t,r)}).then(function(e){console.timeEnd(s),t(e)}).catch(function(e){n(e),logger.error(e)}):readProcessRecs(e,a,o,null,r).then(function(e){console.timeEnd(s),t(e)}):(r.records=[],vsnUtils.upgradeAvailable().then(function(e){r.upgradeAvailable=e,console.timeEnd(s),t(r)}).catch(function(e){console.timeEnd(s),t(r),logger.error(e)}))},function(e){console.timeEnd(s),n(e),logger.error(e)})},function(e){console.timeEnd(s),n(e),logger.error(e)})})}function readProcessRecs(e,t,r,s,n){return new Promise(function(o,a){t.forEach(function(e){for(var t in e){var n=_.findWhere(r,{path:t});void 0!==n&&(e[t]=maybeReadTransformType(e[t],n.appColType,n.platColType),"LastModifiedDate"==t&&(e.dirtyFlag=calcDirtyFlag(e[t],s)))}}),n.records=t.filter(function(e){return"object"==(void 0===e?"undefined":_typeof(e))}),enrichWithRecordTypeNames(n.records,e).then(function(e){return n.records=e,vsnUtils.upgradeAvailable()}).then(function(e){n.upgradeAvailable=e,o(n)}).catch(function(e){o(n),logger.error(e)})})}function smartSql(e){return smartRead(e)}function smartRead(e){return new Promise(function(t,r){var s,n,o={},a=/\{(\S*)\}/g.exec(e);tableName=a[1],parseSmartSql(tableName,e).then(function(e){return console.debug("smartSql2",e),s=smartstore.buildSmartQuerySpec(e),console.debug("querySpec",s),n="MC-TIMING smartRead "+tableName,console.time(n),tableExists(tableName,READ_RECS)}).then(function(){return checkTableAccess(tableName,READ_RECS)}).then(function(){return listMobileTableColumns(tableName)}).then(function(e){smartStoreUtils.smartQuerySoupRecordsWithQuerySpec(s,function(r){o.status=READ_RECS,r.length>0?-1==SYSTEM_TABLES.indexOf(tableName)?smartStoreUtils.getTableDefnColumnValue(tableName,"Last Refresh Date/Time").then(function(t){return smartReadProcessRecs(tableName,r,e,t,o)}).then(function(e){console.timeEnd(n),t(e)}):smartReadProcessRecs(tableName,r,e,null,o).then(function(e){console.timeEnd(n),t(e)}):(o.records=[],vsnUtils.upgradeAvailable().then(function(e){o.upgradeAvailable=e,console.timeEnd(n),t(o)}).catch(function(e){console.timeEnd(n),t(o),logger.error(e)}))},function(){r()})},function(e){console.timeEnd(n),r(e),logger.error(e)})})}function smartReadProcessRecs(e,t,r,s,n){return new Promise(function(o,a){var c=[];t.forEach(function(e){var t=e[1];for(var n in t){var o=_.findWhere(r,{path:n});void 0!==o&&(t[n]=maybeReadTransformType(t[n],o.appColType,o.platColType),"LastModifiedDate"==n&&(e[1].dirtyFlag=calcDirtyFlag(e[1][n],s)))}c.push(t)}),n.records=c.filter(function(e){return"object"==(void 0===e?"undefined":_typeof(e))}),enrichWithRecordTypeNames(n.records,e).then(function(e){return n.records=e,vsnUtils.upgradeAvailable()}).then(function(e){n.upgradeAvailable=e,o(n)}).catch(function(e){o(n),logger.error(e)})})}function parseSmartSql(e,t){return new Promise(function(r,s){if(m=t.match(/.* WHERE (.* = .*)/i),console.debug("m",m),null!==m&&null!==m[1]){var n={},o="";m[1].split("AND").forEach(function(e){mWhere=e.match(/{(.*):(.*)} = (.*)/i),whereField=mWhere[2],o=mWhere[3].split("'")[1],n[whereField]=o}),void 0!==n.Id&&n.Id.length>18?smartStoreUtils.getProxyFieldName(e).then(function(e){console.log("proxyFieldName",e),parsedSmartSql=t.replace("Id} =",e+"} ="),r(parsedSmartSql)}):r(t)}else r(t)})}function calcDirtyFlag(e,t){return t&&"null"!=t||(t=0),e.valueOf()>t}function innerProcessRefreshTablePromise(e){return new Promise(function(t,r){var s=function(e){console.debug("innerProcessRefreshTablePromise res",e),t(e)},n={table:e};syncRefresh.p2mRefreshTable(e,0,!1,1,1,null,function(e){console.debug("refreshStatusObject",e),e.status==syncRefresh.P2M_REFRESH_OK?(n.status=SYNC,s(n)):(n.status=e.status,n.mc_add_status=e.mc_add_status,s(n))},function(e){logger.error("innerProcessRefreshTablePromise error",e),r(e)})})}function initialSync(e){return console.time("initialSync"),new Promise(function(t,r){if(0===e.length)t({status:SYNC+MANDATORY_MISSING});else{var s={};syncRefresh.heartBeat(function(n){if(console.log("heartbeat call gave "+n.status),n.status==syncRefresh.HEARTBEAT_OK||n.status==syncRefresh.HEARTBEAT_NOT_DEVICE||n.status==syncRefresh.HEARTBEAT_REFRESHED_OK){var o=[];console.debug("tableNames",JSON.stringify(e)),dirtyTables().then(function(t){return console.debug("dirtyTableNames",t),t.forEach(function(t){var r=e.indexOf(t);r>-1&&(o.push({table:t,status:SYNC_NOK_STATUS,mc_add_status:"Dirty records"}),e.splice(r,1))}),console.debug("tableNames",e),console.debug("resArr",o),doInitialSync(e)}).then(function(e){console.debug("doInitialSync res",e);var s=o.concat(e);console.debug("Promise.all resArrFinal",s),console.timeEnd("initialSync"),t(s);connSessUtils.maybeSyncConnSess({mobilecaddy1__Mobile_Process_Status__c:""},function(){console.log("success return from maybeSyncConnSess")},function(e){r(e),logger.error(e)})}).catch(function(e){r(e),logger.error(e)})}else s.status=SYNC_NOK_STATUS,s.mc_add_status=n.status,t(s),100101==s.mc_add_status||100102==s.mc_add_status?logger.error(s):logger.log(s)},function(e){logger.error(e),s.status=SYNC_NOK_STATUS,t(s)})}})}function doInitialSync(e){Promise.resolve();var t=[];return e.reduce(function(e,r){return e.then(function(e){return innerProcessRefreshTablePromise(r)}).then(function(e){return t.push(e),t}).catch(function(e){logger.errorAndDispatch(e),reject(e)})},Promise.resolve())}function syncMobileTable(e,t,r,s,n){console.time("syncMobileTable"),t=void 0===t||t;r||(r=0),s||(s=50),n||(n=!1);var o=function(e,t,s){var n={};syncRefresh.p2mRefreshTable(e,r,!0,1,1,null,function(e){console.debug("refreshStatusObject",e),e.status==syncRefresh.P2M_REFRESH_OK?(n.status=SYNC,t(n)):(n.status=e.status,n.mc_add_status=e.mc_add_status,t(n))},s)},a=function e(t,n,o){var a={};smartStoreUtils.queryMobileTable("recsToSync","Mobile_Table_Name",t,function(c){if(c.length>0)try{syncRefresh.m2pUpdateMobileTable(t,s,function(s){console.log("m2pStatusObject",s),s.status==syncRefresh.M2P_UPDATE_OK&&void 0===s.mc_add_status?(r=0,a.status=0,n(a)):s.status==syncRefresh.M2P_UPDATE_OK&&"more-to-sync"===s.mc_add_status?(console.log("moreToSync - Going round again"),e(t,n,o)):(a.status=s.status,a.mc_add_status=s.mc_add_status,n(a))},o)}catch(e){console.error(e)}else a.status=2,a.mc_add_status="no-sync-no-updates",n(a)},o)},c=function(e,t,r,s,c){var i={};console.log("skipP2M",n),"Dynamic (Submit First/Retain)"==t||"Dynamic (Submit First/Clear)"==t?a(e,function(t){console.log("statusObject",t),!n&&(0===t.status||r&&2==t.status)?o(e,s,c):n&&0===t.status||2==t.status?(i.status=SYNC,i.mc_add_status=t.mc_add_status,s(i)):(i.status=SYNC_NOK_STATUS,i.mc_add_status=t.mc_add_status,s(i))},c):"Submit Only"==t||"Submit & Clear"==t||"Submit & Destroy"==t?a(e,function(e){0===e.status?(i.status=SYNC,s(i)):(i.status=SYNC_NOK_STATUS,i.mc_add_status=e.mc_add_status,s(i))},c):logger.errorAndDispatch("Unknown sync type",t,n)};return new Promise(function(r,s){var n={},a=function(e){localStorage.removeItem("syncInProgressTime"),r(e)},i=function(e){localStorage.removeItem("syncInProgressTime"),s(e)},l="syncTime"+e,u=localStorage.getItem(l),E=(new Date).valueOf(),_=u?parseInt(u)+5e3:0;"Connection_Session__mc"!=e&&E<_?(n.status=SYNC,n.mc_add_status="sync-too-soon",console.timeEnd("syncMobileTable"),r(n)):(localStorage.setItem(l,E),tableExists(e,SYNC).then(function(){syncRefresh.heartBeat(function(l){if(console.log("heartbeat call gave "+l.status),l.status==syncRefresh.HEARTBEAT_OK||l.status==syncRefresh.HEARTBEAT_NOT_DEVICE||l.status==syncRefresh.HEARTBEAT_REFRESHED_OK){var u=localStorage.getItem("syncInProgressTime"),E=(new Date).valueOf();console.log("syncInProgressTime",u,E),"Connection_Session__mc"!=e&&u&&u>E-12e4?(console.log("SYNC_ALREADY_IN_PROGRESS"),n.status=SYNC+SYNC_ALREADY_IN_PROGRESS_INC,i(n)):(localStorage.setItem("syncInProgressTime",E),smartStoreUtils.getTableDefnColumnValue(e,"Sync Type").then(function(l){connSessUtils.getRTSPendingconnSess(function(u){"Mobile_Log__mc"!=e?null!==u&&void 0!==u?connSessUtils.csStatusCheck(u,function(s){s.status==connSessUtils.CONN_SESS_OK?"Refresh Only"==l||"Refresh & Clear"==l?o(e,a,i):c(e,l,t,a,i):(n.status=SYNC_OK,n.mc_add_status=s.status,console.timeEnd("syncMobileTable"),r(n))},function(e){logger.errorAndDispatch(e),s(e)}):"Refresh Only"==l||"Refresh & Clear"==l?o(e,a,i):c(e,l,t,a,i):c(e,l,!1,a,i)},i)}).catch(function(e){i(e)}))}else n.status=SYNC_NOK_STATUS,n.mc_add_status=l.status,console.timeEnd("syncMobileTable"),r(n),100101==n.mc_add_status||100102==n.mc_add_status?logger.error(n):logger.log(n)},i)}).catch(i))})}function updateRecord(e,t,r){return updateRecords(e,[t],r)}function updateRecords(e,t,r){var s={};return new Promise(function(n,o){t.length>0?tableExists(e,UPDATE_RECS).then(function(){return listMobileTableColumns(e)}).then(function(t){return checkTableAccess(e,UPDATE_RECS,t)}).then(function(s){return new Promise(function(n,o){var a=isValidFieldAndTranslate(r,UPDATE_RECS,s);a.status!=UPDATE_RECS+UNKONWN_FIELD?validateRecords(e,r,UPDATE_RECS,t,s).then(function(e){e.status==UPDATE_RECS?n(e.records):o(e)}):o(a)})}).then(function(t){smartStoreUtils.updateRecordsWithExternalId(e,t,r,function(e){s.status=UPDATE_RECS,s.records=e,vsnUtils.upgradeAvailable().then(function(e){s.upgradeAvailable=e,n(s)}).catch(function(e){n(s)})},function(e){o(e),logger.error(e)})},function(e){o(e),logger.error(e)}):(s.status=UPDATE_RECS,s.mc_add_status="No records supplied",s.records=[],n(s),logger.warn(s))})}var SYNC_OK=exports.SYNC_OK=SYNC,SYNC_NOK=exports.SYNC_NOK=SYNC_NOK_STATUS,SYNC_ALREADY_IN_PROGRESS=exports.SYNC_ALREADY_IN_PROGRESS=SYNC+SYNC_ALREADY_IN_PROGRESS_INC,SYNC_UNKONWN_TABLE=exports.SYNC_UNKONWN_TABLE=SYNC+UNKONWN_TABLE,SYNC_MANDATORY_MISSING=exports.SYNC_MANDATORY_MISSING=SYNC+MANDATORY_MISSING,DELETE_RECS_OK=exports.DELETE_RECS_OK=DELETE_RECS,DELETE_RECS_UNKONWN_TABLE=exports.DELETE_RECS_UNKONWN_TABLE=DELETE_RECS+UNKONWN_TABLE,DELETE_RECS_UNKONWN_FIELD=exports.DELETE_RECS_UNKONWN_FIELD=DELETE_RECS+UNKONWN_FIELD,DELETE_RECS_ACCESS_DENIED=exports.DELETE_RECS_ACCESS_DENIED=DELETE_RECS+ACCESS_DENIED,DELETE_RECS_MANDATORY_MISSING=exports.DELETE_RECS_MANDATORY_MISSING=DELETE_RECS+MANDATORY_MISSING,INSERT_RECS_OK=exports.INSERT_RECS_OK=INSERT_RECS,INSERT_RECS_UNKONWN_TABLE=exports.INSERT_RECS_UNKONWN_TABLE=INSERT_RECS+UNKONWN_TABLE,INSERT_RECS_UNKONWN_FIELD=exports.INSERT_RECS_UNKONWN_FIELD=INSERT_RECS+UNKONWN_FIELD,INSERT_RECS_ACCESS_DENIED=exports.INSERT_RECS_ACCESS_DENIED=INSERT_RECS+ACCESS_DENIED,INSERT_RECS_MANDATORY_MISSING=exports.INSERT_RECS_MANDATORY_MISSING=INSERT_RECS+MANDATORY_MISSING,INSERT_RECS_DATATYPE_MISMATCH=exports.INSERT_RECS_DATATYPE_MISMATCH=INSERT_RECS+DATATYPE_MISMATCH,INSERT_RECS_PROTECTED_FIELD=exports.INSERT_RECS_PROTECTED_FIELD=INSERT_RECS+PROTECTED_FIELD,INSERT_RECS_UNKNOWN_RECORD_TYPE=exports.INSERT_RECS_UNKNOWN_RECORD_TYPE=INSERT_RECS+UNKNOWN_RECORD_TYPE,READ_RECS_OK=exports.READ_RECS_OK=READ_RECS,READ_RECS_UNKONWN_TABLE=exports.READ_RECS_UNKONWN_TABLE=READ_RECS+UNKONWN_TABLE,READ_RECS_ACCESS_DENIED=exports.READ_RECS_ACCESS_DENIED=READ_RECS+ACCESS_DENIED,UPDATE_RECS_OK=exports.UPDATE_RECS_OK=UPDATE_RECS,UPDATE_RECS_UNKONWN_TABLE=exports.UPDATE_RECS_UNKONWN_TABLE=UPDATE_RECS+UNKONWN_TABLE,UPDATE_RECS_UNKONWN_FIELD=exports.UPDATE_RECS_UNKONWN_FIELD=UPDATE_RECS+UNKONWN_FIELD,UPDATE_RECS_ACCESS_DENIED=exports.UPDATE_RECS_ACCESS_DENIED=UPDATE_RECS+ACCESS_DENIED,UPDATE_RECS_DATATYPE_MISMATCH=exports.UPDATE_RECS_DATATYPE_MISMATCH=UPDATE_RECS+DATATYPE_MISMATCH,UPDATE_RECS_UNKNOWN_ID=exports.UPDATE_RECS_UNKNOWN_ID=UPDATE_RECS+UNKNOWN_ID,UPDATE_RECS_UNKNOWN_RECORD_TYPE=exports.UPDATE_RECS_UNKNOWN_RECORD_TYPE=UPDATE_RECS+UNKNOWN_RECORD_TYPE,GET_REC_TYPES_UNKONWN_TABLE=exports.GET_REC_TYPES_UNKONWN_TABLE=GET_REC_TYPES+UNKONWN_TABLE;exports.analInc=analInc,exports.deleteRecord=deleteRecord,exports.dirtyTables=dirtyTables,exports.syncMobileTable=syncMobileTable,exports.initialSync=initialSync,exports.getCurrentUserId=getCurrentUserId,exports.getCurrentUserName=getCurrentUserName,exports.getUserLocale=getUserLocale,exports.getCachedAppSoupValue=getCachedAppSoupValue,exports.getRecordTypes=getRecordTypes,exports.insertRecord=insertRecord,exports.insertRecords=insertRecords,exports.logout=logout,exports.readRecords=readRecords,exports.smartSql=smartSql,exports.updateRecord=updateRecord,exports.updateRecords=updateRecords,exports.maybeReadTransformType=maybeReadTransformType,exports.maybeWriteTransformType=maybeWriteTransformType;