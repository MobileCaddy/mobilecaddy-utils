/* mobilecaddy-utils - v2.0.0 - Bundle Time: 2018-06-20 10:03:15 */
/* git info: "2018-06-19 16:53:31 +0100": 66bde0d18fcc8ea9fe631c95a4098c71f7ea5302 (v2) */
/* Copyright 2018 MobileCaddy Ltd */

String.prototype.includes||(String.prototype.includes=function(e,n){"use strict";return"number"!=typeof n&&(n=0),!(n+e.length>this.length)&&-1!==this.indexOf(e,n)}),Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(e){if(null==this)throw new TypeError('"this" is null or not defined');var n=Object(this),t=n.length>>>0;if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var o=arguments[1],r=0;r<t;){var a=n[r];if(e.call(o,a,r,n))return a;r++}},configurable:!0,writable:!0});var $j=jQuery.noConflict(),MC_TABLES=["Connection_Session__mc","Mobile_Log__mc","MC_Project__ap","MC_Time_Expense__ap","MC_Project_Location__ap"],_typeof=function(e){return typeof e};!function(){var n,t;!function(){var e={},o=[],r={};n=function(t){if(e[t]){if(t in r)o.slice(r[t]).join("->")}else;if(e[t].factory)try{return r[t]=o.length,o.push(t),a=e[t],i=a.factory,a.exports={},delete a.factory,i(n,a.exports,a),a.exports}finally{delete r[t],o.pop()}var a,i;return e[t].exports},(t=function(n,t){e[n],e[n]={id:n,factory:t}}).remove=function(n){delete e[n]}}(),"object"==typeof module&&"function"==typeof n&&(module.exports.require=n,module.exports.define=t),t("mobileCaddy",function(e,n,o){var r={define:t,require:e,START_PAGE_CONTROLLER:"",QUERY_BUFFER_SIZE:1e3,QUERY_BUFFER_SIZE_SL:1e3,INITIAL_APPCACHE_INFO:[]};o.exports=r}),t("mobileCaddy/mobileLogger",function(e,n,t){function o(){try{throw Error("")}catch(e){return e}}function r(e,n){var t=n.stack.split("\n")[4];if(void 0!==t){var o=t.indexOf("at ");t.slice(o+2,t.length)}}t.exports={logMessageAndThrow:function(e){!function(e,n){throw r(0,n),e}(e,o())},logMessage:function(e){r(0,o())},logObjectDetails:function(e){!function(e,n){for(var t in e)r(e[t],n)}(e,o())}}}),t("mobileCaddy/geoLocation",function(e,n,t){t.exports={getLocation:function(e,n){!function(e,n){var t=[];t.Error="Location information is unavailable.",t.ErrorNumber=2,e(t)}(e)}}}),t("mobileCaddy/startup",function(e,n,t){e("mobileCaddy/mobileLogger");var o=e("mobileCaddy/logger"),r=cordova.require("com.salesforce.plugin.smartstore"),a=e("mobileCaddy/systemData"),i=e("mobileCaddy/smartStoreUtils"),s=(e("mobileCaddy/appDataUtils"),e("mobileCaddy/geoLocation"),!!window.LOCAL_DEV),c=!!window.USE_FORCETK,u=[],d=["Initialising"];window.addEventListener("error",function(e){var n=e.error?e.error.stack:null;e.error&&e.error.toString()});var l=100900,f=100901;function p(e){d.unshift("Checking Cache"),u=[],window.applicationCache.addEventListener("checking",function(e){m(e)},!1),window.applicationCache.addEventListener("downloading",function(e){m(e)},!1),window.applicationCache.addEventListener("progress",function(e){m(e)},!1),u.push({Name:"AppCache: Initial Status",Description:window.applicationCache.status});var n={};switch(n.status=l,window.applicationCache.status){case window.applicationCache.CHECKING:case window.applicationCache.DOWNLOADING:return window.applicationCache.addEventListener("updateready",function(n){m(n,e)},!1),window.applicationCache.addEventListener("cached",function(n){m(n,e)},!1),window.applicationCache.addEventListener("error",function(n){m(n,e)},!1),void window.applicationCache.addEventListener("noupdate",function(n){m(n,e)},!1);case window.applicationCache.UPDATEREADY:default:e(n)}}function m(e,n){"progress"==e.type?u.push({Name:"Event ",Description:e.loaded+" of "+e.total}):u.push({Name:"Event ",Description:e.type});var t={};"udpateready"==e.type||"cached"==e.type?t.status=l:t.status=f,n&&"function"==typeof n&&n(t)}function S(e,n){d.unshift("Preparing platform");var t=g("appSoupJson");if(""!==t){var a=JSON.parse(t);r.registerSoup("appSoup",[{path:"Name",type:"string"},{path:"CurrentValue",type:"string"},{path:"NewValue",type:"string"}],function(){r.upsertSoupEntries("appSoup",a,function(t){r.registerSoup("cacheSoup",[{path:"Name",type:"string"},{path:"Description",type:"string"}],function(){b(e,n)},function(e){})},function(e){})},function(e){})}else void 0!==s&&s?new Promise(function(e,n){new Promise(function(e,n){if(c){var t=window.SF_LOGIN_URL?window.SF_LOGIN_URL:"https://login.salesforce.com";force.init({appId:"3MVG9Rd3qC6oMalWEuQby1hkUef0N2L7kTPExDjRAs1GH35ueKyc3q_D5NY0LLoLHnfwIr_Y8PyeRotaClrtZ",apiVersion:"v30.0",loginUrl:t,tokenStore:localStorage,oauthRedirectURL:"http://localhost:3030/oauthcallback.html",proxyURL:"http://localhost:3000"}),force.isLoggedIn()?e():force.login(function(){e()},function(e){alert("Salesforce login failed"),n(e)})}else e()}).then(function(e){return new Promise(function(e,n){var t=!localStorage.getItem("initialSyncState");if(c&&t){var o=window.DEVICE_APP_NAME?window.DEVICE_APP_NAME:"BIZ001";force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/codeflowUtils001",contentType:"application/json",data:{buildVersion:"001",buildName:o,buildOS:"Android",deviceUuid:"c86d3e94574debug",overrideUserId:"",startPageControllerVersion:"001"}},function(n){e()},function(e){alert("Salesforce codeflowUtils001 failed"),n(e)})}else e()})}).then(function(t){d.unshift("Creating CodeFlow records"),r.soupExists("appSoup",function(t){t?r.soupExists("cacheSoup",function(t){t?e():r.registerSoup("cacheSoup",[{path:"Name",type:"string"},{path:"Description",type:"string"}],function(){e()},function(e){n(e)})},function(e){n(e)}):r.registerSoup("appSoup",[{path:"Name",type:"string"},{path:"teststring",type:"string"},{path:"testinteger",type:"string"},{path:"CurrentValue",type:"string"},{path:"NewValue",type:"string"},{path:"testno",type:"integer"}],function(){localStorage.setItem("appSoup",JSON.stringify([{Name:"applicationName",CurrentValue:"MAP-0012001",NewValue:"MAP-0012001",_soupEntryId:1},{Name:"userId",CurrentValue:"",NewValue:"",_soupEntryId:2},{Name:"buildStatus",CurrentValue:"Initial",NewValue:"Initial",_soupEntryId:3},{Name:"buildVersion",CurrentValue:"001",NewValue:"001",_soupEntryId:4},{Name:"buildName",CurrentValue:"BIZ001",NewValue:"BIZ001",_soupEntryId:5},{Name:"buildOS",CurrentValue:"Android",NewValue:"Android",_soupEntryId:6},{Name:"deviceUuid",CurrentValue:"c86d3e94574debug",NewValue:"c86d3e94574debug",_soupEntryId:7}])),r.registerSoup("cacheSoup",[{path:"Name",type:"string"},{path:"Description",type:"string"}],function(){e()},function(e){n(e)})},function(e){n(e)})})}).catch(function(e){o.error(e),n(e)})}).then(function(t){b(e,n)}).catch(function(e){throw o.error(e),e}):navigator.appVersion.includes("Electron")?r.soupExists("appSoup",function(t){if(t)b(e,n);else{var o=[],a=ipcRenderer.sendSync("request-creds","");g("access_token","?"+a);if(o.push({Name:"accessToken",CurrentValue:g("access_token","?"+a),NewValue:null}),o.push({Name:"refreshToken",CurrentValue:g("refresh_token","?"+a),NewValue:null}),o.push({Name:"clientId",CurrentValue:g("client_id","?"+a),NewValue:null}),o.push({Name:"orgId",CurrentValue:g("org_id","?"+a),NewValue:null}),o.push({Name:"applicationName",CurrentValue:g("buildName","?"+a),NewValue:null}),o.push({Name:"buildName",CurrentValue:g("buildName","?"+a),NewValue:null}),window.location.pathname.startsWith("/apex/"))o.push({Name:"loginUrl",CurrentValue:window.location.protocol+"//"+window.location.host,NewValue:null});else{var i=window.location.pathname.split("/")[1];o.push({Name:"loginUrl",CurrentValue:window.location.protocol+"//"+window.location.host+"/"+i,NewValue:null})}var s=ipcRenderer.sendSync("request-device-info","");o.push({Name:"buildStatus",CurrentValue:"Initial"}),o.push({Name:"buildVersion",CurrentValue:s.buildVersion}),o.push({Name:"buildOS",CurrentValue:s.platform}),o.push({Name:"deviceUuid",CurrentValue:s.uuid});r.registerSoup("appSoup",[{path:"Name",type:"string"},{path:"CurrentValue",type:"string"},{path:"NewValue",type:"string"}],function(){r.upsertSoupEntries("appSoup",o,function(t){r.registerSoup("cacheSoup",[{path:"Name",type:"string"},{path:"Description",type:"string"}],function(){b(e,n)},function(e){})},function(e){})},function(e){})}}):b(e,n)}var h=100800,y=100801;function b(e,n){r.upsertSoupEntries("cacheSoup",u,function(){i.querySoupRecsPromise("appSoup").then(function(t){var o={},s=[];if(t.forEach(function(e){if(void 0!==o[e.Name])throw"Should only be 1 "+e.Name+" entry in the app soup.  Found more";o[e.Name]=e}),o.userOverrideId||(o.userOverrideId=""),"Complete"==o.buildStatus.CurrentValue&&"Complete"==o.buildStatus.NewValue){if(null!==e){var u={};if(u.status=y,u.mc_add_status=n.status,u.curVsn=o.dynVersionNumber.CurrentValue,void 0!==o.dynVersionNumber.NewValue&&(u.newVsn=o.dynVersionNumber.NewValue),navigator.appVersion.includes("Electron")){var l=window.location.protocol+"//"+window.location.host+window.location.pathname;ipcRenderer.send("startPageUrl",l)}e(u)}}else{d.unshift("Preparing database");var f=function(t,c){if(c.status){s=JSON.parse(t);var u=_.find(s,{Name:"audId"}).CurrentValue,l=_.find(s,{Name:"sysDataPlatSupVersion"}).CurrentValue;if(navigator.appVersion.includes("Electron")){var f=window.location.protocol+"//"+window.location.host+window.location.pathname;ipcRenderer.send("startPageUrl",f)}new Promise(function(e,n){r.registerSoup("recsToSync",[{path:"Mobile_Table_Name",type:"string"},{path:"SOUP_Record_Id",type:"string"},{path:"Id",type:"string"},{path:"LastModifiedDateTime",type:"integer"},{path:"CRUD_Operation",type:"string"},{path:"Current_Connection_Session",type:"string"}],function(){e()},function(e){n(e)})}).then(function(){a.createSystemDataSoup(function(){d.unshift("Building tables"),i.buildMobileTables(function(){var t=o.buildStatus;t.CurrentValue="Complete",t.NewValue="Complete",s.map(function(e){return o[e.Name]&&(e._soupEntryId=o[e.Name]._soupEntryId),e}),s.push(t),d.unshift("Finalising build"),r.upsertSoupEntries("appSoup",s,function(){a.getRecordTypeDots(u,l).then(function(){if(null!==e){var t={};t.status=h,t.mc_add_status=n.status,e(t)}}).catch(function(e){})},function(e){})},function(e){})},function(e){},u,l)}).catch(function(e){})}else"exception"===c.type&&alert(c.message)};!0===c?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/getAUDInfo001",contentType:"application/json",data:{buildVersion:o.buildVersion.CurrentValue,buildName:o.buildName.CurrentValue,buildOS:o.buildOS.CurrentValue,deviceUuid:o.deviceUuid.CurrentValue,overrideUserId:force.getUserId(),startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN}},function(e){var n={status:"200"};f(e,n)},function(e){error()}):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".getAudInfo",o.buildVersion.CurrentValue,o.buildName.CurrentValue,o.buildOS.CurrentValue,o.deviceUuid.CurrentValue,o.userOverrideId,f,{escape:!1,timeout:3e4})}}).catch(function(e){})},function(e){})}function g(e,n){n||(n=window.location.search),e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(n);return null===t?"":decodeURIComponent(t[1].replace(/\+/g," "))}t.exports={startup:function(e){!function(e){if(!e)return new Promise(function(e,n){p(function(n){S(function(n){e(n)},n)})});p(function(n){S(e,n)})}(e)}}}),t("mobileCaddy/systemData",function(e,n,t){e("mobileCaddy/mobileLogger");var o=e("mobileCaddy"),r=e("mobileCaddy/logger"),a=cordova.require("com.salesforce.plugin.smartstore"),i=(o.require("mobileCaddy/smartStoreUtils"),e("mobileCaddy/appDataUtils"));function s(e,n,t,i){!function(e,n,t,i){var s=function(s,c){if(c.status){var u=JSON.parse(s);u.forEach(function(e){}),a.registerSoup("syncLib_system_data",u,function(){!function(e,n,t,i){var s=function(e,n){if(n.status){var o=JSON.parse(e);a.upsertSoupEntries("syncLib_system_data",o,t,i)}else"exception"===n.type?(alert(n.message),r.error("Exception return from getSystemDataRowValues = "+n.message)):r.error("Unknown return from getSystemDataRowValues = "+n.message)};!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/getSysDataSoupVariables001",contentType:"application/json",data:{audId:e,startPageControllerVersion:o.START_PAGE_CONTROLLER_VSN,systemDataPlatformSupportVersion:n}},function(e){var n={status:"200"};s(e,n)},i):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+o.START_PAGE_CONTROLLER+".getSysDataSoupVariables",e,n,s,{escape:!1})}(e,n,function(){!function(e,n,t,i){var s=function(e,n){if(n.status){var o=JSON.parse(e);a.upsertSoupEntries("syncLib_system_data",o,function(e){t(e)},function(e){r.error("Error returned from upsert, message =  "+e),i(e)})}else"exception"===n.type?(alert(n.message),r.error("Exception return from getDefsForSObjectMobileTables = "+n.message)):r.error("Unknown return from getDefsForSObjectMobileTables = "+n.message)};!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/getDefsForSObjectMobileTables001",contentType:"application/json",data:{audId:e,startPageControllerVersion:o.START_PAGE_CONTROLLER_VSN,systemDataPlatformSupportVersion:n}},function(e){var n={status:"200"};s(e,n)},i):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+o.START_PAGE_CONTROLLER+".getDefsForSObjectMobileTables",e,n,s,{escape:!1,timeout:12e4})}(e,n,t,i)},i)},i)}else"exception"===c.type?(alert(c.message),r.error("Exception return from getSystemDataSoupDefinition = "+c.message)):r.error("Unknown return from getSystemDataSoupDefinition = "+c.message)};!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/getSystemDataSoupDefinition001",contentType:"application/json",data:{audId:e,startPageControllerVersion:o.START_PAGE_CONTROLLER_VSN,systemDataPlatformSupportVersion:n}},function(e){var n={status:"200"};s(e,n)},i):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+o.START_PAGE_CONTROLLER+".getSystemDataSoupDefinition",e,n,s,{escape:!1})}(t,i,e,n)}t.exports={createSystemDataSoup:function(e,n,t,o){s(e,n,t,o)},getRecordTypeDots:function(e){return new Promise(function(n,t){var s,c=function(e,o){o.status?a.registerSoup("dotsRecordTypes",[{path:"Table",type:"string"},{path:"Data",type:"string"}],function(o){var i=JSON.parse(e).map(function(e){return{Table:e.mobileTableName,Data:JSON.stringify(e.recTypeInfoList)}});a.upsertSoupEntries("dotsRecordTypes",i,function(t){var o={};JSON.parse(e).forEach(function(e){var n={};e.recTypeInfoList.forEach(function(e){e.recTypeDevName?(n[e.recTypeId]={recTypeName:e.recTypeName,recTypeDevName:e.recTypeDevName},n[e.recTypeName]=e.recTypeId,n[e.recTypeDevName]=e.recTypeId):(n[e.recTypeId]=e.recTypeName,n[e.recTypeName]=e.recTypeId)}),o[e.mobileTableName]=n}),localStorage.setItem("lsDotsRecordTypes",JSON.stringify(o)),n()},function(e){r.error("Error returned from upsert, message =  "+e),t(e)})},function(e){t(e)}):"exception"===o.type?(r.error("Exception return from p2mRefreshRecTypeDOTs = "+o.message),t(o.message)):(r.error("Unknown return from p2mRefreshRecTypeDOTs = "+o.message),t(o.message))};i.getCachedCurrentValueFromAppSoup("syncRefreshVersion").then(function(n){s=n,!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/p2mRefreshRecTypeDOTs001",contentType:"application/json",data:{audId:e,startPageControllerVersion:o.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:s,connSessJson:"{}"}},function(e){var n={status:"200"};c(e,n)},function(e){c("[]",{status:"OK"})}):Visualforce.remoting.Manager.getAction("mobilecaddy1."+o.START_PAGE_CONTROLLER+".p2mRefreshRecTypeDOTs")?Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+o.START_PAGE_CONTROLLER+".p2mRefreshRecTypeDOTs",e,s,"{}",c,{escape:!1,timeout:12e4}):c("[]",{status:"OK"})})})}}}),t("mobileCaddy/smartStoreUtils",function(e,n,t){e("mobileCaddy/mobileLogger");var o=cordova.require("com.salesforce.plugin.smartstore");function r(e,n,t){var o=[];function r(e){n(o)}function a(e){if(!t)throw e;t(e)}!function e(n){n.currentPageOrderedEntries.forEach(function(e){o.push(e)}),n.currentPageIndex<n.totalPages-1?cordova.require("com.salesforce.plugin.smartstore").moveCursorToNextPage(n,e):cordova.require("com.salesforce.plugin.smartstore").closeCursor(n,r,a)}(e)}function a(e,n,t){var a=o.buildAllQuerySpec("_soupEntryId",null,mobileCaddy.QUERY_BUFFER_SIZE);o.querySoup(e,a,function(e){r(e,function(e){n(e)},t)})}function i(e,n,t,a){o.querySoup(e,n,function(e){r(e,function(e){t(e)},a)},a)}function s(e,n,t){o.runSmartQuery(e,function(e){r(e,function(e){n(e)},t)},t)}function c(e,n,t,r,a){if(void 0===r&&void 0===a)return new Promise(function(r,a){var s=o.buildExactQuerySpec(n,t,mobileCaddy.QUERY_BUFFER_SIZE_SL);i(e,s,function(e){r(e)},function(e){a(e)})});var s=o.buildExactQuerySpec(n,t,mobileCaddy.QUERY_BUFFER_SIZE_SL);i(e,s,function(e){r(e)},a)}function u(e,n,t,r,a,s,c){i(e,o.buildExactQuerySpec(n,t,mobileCaddy.QUERY_BUFFER_SIZE_SL),function(e){var n=[];e.forEach(function(e){e[r]==a&&n.push(e)}),s(n)},c)}function d(e,n,t){p("Row Mapping PT","Mobile Table Name",function(o){u("syncLib_system_data","MC_Var_String_001","Platform Table Definition",o,e,function(e){e.length,n(e[0])},t)},t)}function l(e,n){return new Promise(function(t,o){d(e,function(e){p("Row Mapping PT",n,function(n){t(e[n])},function(e){o(e)})},function(e){o(e)})})}function f(e,n,t){return new Promise(function(r,a){d(e,function(e){p("Row Mapping PT",n,function(n){e[n]=t,o.upsertSoupEntries("syncLib_system_data",[e],function(){r()},function(e){a(e)})},function(e){a(e)})},function(e){a(e)})})}function p(e,n,t,o){var r=e+"_"+n,a=localStorage.getItem(r);a?t(a):u("syncLib_system_data","MC_Var_String_001",e,"MC_Var_String_003",n,function(e){e.length,localStorage.setItem(r,e[0].MC_Var_String_004),t(e[0].MC_Var_String_004)},o)}function _(e,n,t,r){i("syncLib_system_data",o.buildExactQuerySpec("MC_Var_String_001",e,mobileCaddy.QUERY_BUFFER_SIZE_SL),function(o){var r=[];n.forEach(function(n){var t=!1;if(o.forEach(function(e){if(e.MC_Var_String_003==n)return r.push(e.MC_Var_String_004),void(t=!0)}),!t)throw"No mapping found for type = "+e+" and value = "+n}),t(r)},r)}var m=1,S=2;function h(e,n,t){_("Row Mapping PT",["Mobile Table Name","Build Order"],function(o){var r=o[0],a=o[1];c("syncLib_system_data","MC_Var_String_001","Platform Table Definition",function(t){var o=[];e==S?(t.sort(function(e,n){var t=0,o=parseInt(e[a]),r=parseInt(n[a]);return isNaN(o)||isNaN(r)||(t=o-r),t}),t.forEach(function(e){o.push(e[r])}),null!==n&&n(o)):(t.forEach(function(e){o.push(e[r])}),e==m&&o.sort(),null!==n&&n(o))},t)},t)}var y=0,b=1,g=2;function C(e,n,t,o){_("Row Mapping TC",["Parent SOUP Name","Table Column Name","Mobile Column Type","Application Field CRUD","META isNillable","Platform Column Type","Device Value Type","Proxy Ref Field Name"],function(o){var r=o[0],a=o[1],i=o[2],s=o[3],c=o[4],d=o[5],l=o[6],f=o[7];u("syncLib_system_data","MC_Var_String_001","Platform Table Column",r,e,function(e){var o=[];e.forEach(function(e){n==y?o.push(e[a]):n==g?o.push({path:e[a],type:e[i],crud:e[s],nillable:e[c],platColType:e[d],appColType:e[l],proxyRefField:e[f]}):o.push({path:e[a],type:e[i]})}),t(o)},function(e){})},o)}function v(e,n,t,r){if(0!==e.length){var a=[];e.forEach(function(e){e&&e._soupEntryId&&a.push(e._soupEntryId)}),0!==a.length?o.removeFromSoup(n,a,function(e){t(e)},r):t()}else t()}function E(e){return new Promise(function(n,t){var o=localStorage.getItem("proxyField-"+e);o?n(o):C(e,y,function(t){var o=null;t.forEach(function(n){n.includes("MC_Proxy_ID")&&(o=n,localStorage.setItem("proxyField-"+e,n))}),n(o)},function(e){n(null)})})}t.exports={ALPHA:m,BUILD:S,listSoups:function(){return new Promise(function(e,n){Promise.resolve();var t=["Connection_Session__mc","Mobile_Log__mc"],o=["SnapShot_Connection_Session__mc","SnapShot_Mobile_Log__mc"],r=["Analytics","appSoup","cacheSoup","dotsRecordTypes","recsToSync","syncLib_system_data"];h(m,function(n){n.splice(n.indexOf("Connection_Session__mc"),1),n.splice(n.indexOf("Mobile_Log__mc"),1);var a=t.concat(n).concat(o);n.reduce(function(e,n){return e.then(function(){return l(n,"Snapshot Data Required")}).then(function(e){return"Yes"==e&&-1==t.indexOf(n)&&a.push("SnapShot_"+n),a}).catch(function(e){})},Promise.resolve()).then(function(n){e(n.concat(r))})},function(e){logger.error("Failed to listSoups",e)})})},listMobileTables:h,FULL:g,listMobileTableColumns:C,queryMobileTable:c,buildMobileTables:function(e,n){h(S,function(t){var r=t.length;t.forEach(function(t){C(t,b,function(a){o.registerSoup(t,a,function(){f(t,"SOUP Built Date/Time",(new Date).getTime()).then(function(){return function(e,n){n.forEach(function(n){n.path.includes("MC_Proxy_ID")&&localStorage.setItem("proxyField-"+e,n.path)})}(t,a),l(t,"Snapshot Data Required")}).then(function(i){"Yes"==i?o.registerSoup("SnapShot_"+t,a,function(){f(t,"Snapshot SOUP Built Date/Time",(new Date).getTime()),0==--r&&e()},function(e){n(e)}):0==--r&&e()}).catch(function(e){n(e)})},n)},function(e){n(e)})})},n)},getProxyFieldName:E,getSysDataRowMapColHeading:p,getSysDataRowMapColHeadings:_,getTableDefnColumnValue:function(e,n){return l(e,n)},setTableDefnColumnValue:f,queryMobileTableWithAnd:u,smartQuerySoupRecordsWithQuerySpec:s,insertRecords:function(e,n,t,r){o.upsertSoupEntries(e,n,function(n){var a=(new Date).getTime();!function(e,n,t,r,a){var s;E(e).then(function(e){return s=e,n="audId",t=localStorage.getItem("appSoup-"+n),new Promise(function(e,r){t?e(t):function(e){return new Promise(function(n,t){var r=o.buildExactQuerySpec("Name",e,mobileCaddy.QUERY_BUFFER_SIZE);i("appSoup",r,function(e){e[0]?n(e[0].CurrentValue):n(e[0])},function(e){t(e)})})}(n).then(function(t){localStorage.setItem("appSoup-"+n,t),e(t)})});var n,t}).then(function(i){n.forEach(function(n){var o="PROXY%"+e+"%"+t+"%"+n._soupEntryId+"%"+i;n.Id=o,n[s]=o}),o.upsertSoupEntries(e,n,function(e){r(e)},a)}).catch(function(e){a(e)})}(e,n,a,function(n){var i=[];n.forEach(function(n){var t={Mobile_Table_Name:e,CRUD_Operation:"Insert",SOUP_Record_Id:n._soupEntryId,Id:n.Id,LastModifiedDateTime:a};i.push(t)}),o.upsertSoupEntriesWithExternalId("recsToSync",i,"Id",t,r)},r)},r)},updateRecordsWithExternalId:function(e,n,t,r,a){(function(e,n,t){var o=n.length,r=0;return new Promise(function(a,i){E(e).then(function(s){n.forEach(function(u,d){c(e,t,u[t]).then(function(l){if(l.length>0){var f=l[0];for(var p in u)f[p]=u[p];n[d]=f,++r>=o&&a(n)}else"Id"==t&&u.Id.length>18?c(e,s,u.Id).then(function(e){if(e.length>0){var t=e[0];for(var s in u)"Id"!=s&&(t[s]=u[s]);n[d]=t,++r>=o&&a(n)}else i({status:101107})}):i({status:101107})}).catch(function(e){i(e)})})}).catch(function(e){i(e)})})})(e,n,t).then(function(n){o.upsertSoupEntriesWithExternalId(e,n,t,function(n){c("recsToSync","Mobile_Table_Name",e,function(t){var i=[];n.forEach(function(n){var o,r;if(t.forEach(function(e){e.Id!=n.Id||(o=e)}),void 0!==o)if(o.Current_Connection_Session&&void 0!==o.Current_Connection_Session)switch(o.CRUD_Operation){case"Insert":case"InsertUpdate":r="InsertUpdate";break;default:r="UpdateUpdate"}else r=o.CRUD_Operation;else r="Update";var a={Mobile_Table_Name:e,SOUP_Record_Id:n._soupEntryId,Id:n.Id,CRUD_Operation:r,LastModifiedDateTime:n.SystemModstamp};"InsertUpdate"!=r&&"UpdateUpdate"!=r||(a.Current_Connection_Session=o.Current_Connection_Session),i.push(a)}),o.upsertSoupEntriesWithExternalId("recsToSync",i,"Id",r,a)},a)},a)}).catch(function(e){a(e)})},deleteSoup:function(e){return new Promise(function(n,t){o.removeSoup(e,function(){logger.log("deleteSoup",e),n()},function(e){logger.errorAndDispatch("deleteSoup",e),t(e)})})},querySoupRecords:a,querySoupRecsPromise:function(e){return new Promise(function(n,t){a(e,function(e){n(e.filter(function(e){return"object"==(void 0===e?"undefined":_typeof(e))}))},function(e){t(e)})})},querySoupRecordsWithQuerySpec:i,deleteRecordsForExternalId:function(e,n,t,r,a){if(!r&&!a)return new Promise(function(r,a){if(0===n.length)r();else{var i="";"object"==_typeof(n[0])?n.forEach(function(e,n){i+=0===n?"'"+e[t]+"'":",'"+e[t]+"'"}):n.forEach(function(e,n){i+=0===n?"'"+e+"'":", '"+e+"'"});var c="SELECT {"+e+":_soupEntryId} FROM {"+e+"} WHERE {"+e+":"+t+"} IN ("+i+")";s(o.buildSmartQuerySpec(c,1e4),function(n){var t=n.map(function(e){return e[0]});o.removeFromSoup(e,t,function(e){r(e)},function(e){a(e)})},function(e){a(e)})}});if(0===n.length)r();else{var i=[];n.forEach(function(e){i.push(e[t])});var c="";n.forEach(function(e,n){c+=0===n?"'"+e[t]+"'":",'"+e[t]+"'"});var u="SELECT {"+e+":_soupEntryId} FROM {"+e+"} WHERE {"+e+":"+t+"} IN ("+c+")";s(o.buildSmartQuerySpec(u,1e4),function(n){var t=n.map(function(e){return e[0]});o.removeFromSoup(e,t,function(e){r()},function(e){a(e)})},function(e){a(e)})}},deleteRecordsFromSoup:v}}),t("mobileCaddy/appDataUtils",function(e,n,t){e("mobileCaddy/mobileLogger");var o=cordova.require("com.salesforce.plugin.smartstore"),r=e("mobileCaddy/smartStoreUtils");function a(e){return new Promise(function(n,t){var a=o.buildExactQuerySpec("Name",e,mobileCaddy.QUERY_BUFFER_SIZE);r.querySoupRecordsWithQuerySpec("appSoup",a,function(e){e[0]?n(e[0].CurrentValue):n(e[0])},function(e){t(e)})})}function i(e,n,t){return new Promise(function(a,i){var s=o.buildExactQuerySpec("Name",e,mobileCaddy.QUERY_BUFFER_SIZE);r.querySoupRecordsWithQuerySpec("appSoup",s,function(e){e.length>0?(e[0][t]=n,o.upsertSoupEntries("appSoup",e,function(e){a(e)},function(e){i(e)})):a()},function(e){i(e)})})}t.exports={getCurrentValueFromAppSoup:function(e){return a(e)},getCachedCurrentValueFromAppSoup:function(e){return function(e){var n=localStorage.getItem("appSoup-"+e);return new Promise(function(t,o){n?t(n):a(e).then(function(n){localStorage.setItem("appSoup-"+e,n),t(n)})})}(e)},updateNewValueInAppSoup:function(e,n){return i(e,n,"NewValue")},updateCurrentValueInAppSoup:function(e,n){return i(e,n,"CurrentValue")}}}),t("mobileCaddy/syncRefresh",function(n,t,o){var r=n("mobileCaddy/appDataUtils"),a=n("mobileCaddy/smartStoreUtils"),i=(n("mobileCaddy/mobileLogger"),n("mobileCaddy/logger")),s=cordova.require("com.salesforce.plugin.smartstore"),c=n("mobileCaddy/geoLocation"),u=(window.LOCAL_DEV,!!window.USE_FORCETK),d=98,l=100400,f=100402,p="006";function m(e,n,t,o,r,s){s&&s({status:0,table:e}),n=void 0===n||n;t||(t=0),o||(o=50),r||(r=!1);var c=function(e,n,o){var r={};g(e,t,!0,1,1,null,function(e){e.status==y?(r.status=l,n(r)):(r.status=e.status,r.mc_add_status=e.mc_add_status,n(r))},o)},u=function e(n,r,i){var s={};a.queryMobileTable("recsToSync","Mobile_Table_Name",n,function(a){if(a.length>0)try{D(n,o,function(o){o.status==P&&void 0===o.mc_add_status?(t=0,s.status=0,r(s)):o.status==P&&"more-to-sync"===o.mc_add_status?e(n,r,i):(s.status=o.status,s.mc_add_status=o.mc_add_status,r(s))},i)}catch(e){}else s.status=2,s.mc_add_status="no-sync-no-updates",r(s)},i)},p=function(e,n,t,o,a){var s={};"Dynamic (Submit First/Retain)"==n||"Dynamic (Submit First/Clear)"==n?u(e,function(n){!r&&(0===n.status||t&&2==n.status)?c(e,o,a):r&&0===n.status||2==n.status?(s.status=l,s.mc_add_status=n.mc_add_status,o(s)):(s.status=f,s.mc_add_status=n.mc_add_status,o(s))},a):"Submit Only"==n||"Submit & Clear"==n||"Submit & Destroy"==n?u(e,function(e){0===e.status?(s.status=l,o(s)):(s.status=f,s.mc_add_status=e.mc_add_status,o(s))},a):i.errorAndDispatch("Unknown sync type",n,r)};return new Promise(function(t,o){var r={},u=function(n){localStorage.removeItem("syncInProgressTime"),s&&(n.table=e,s(n)),t(n)},_=function(n){localStorage.removeItem("syncInProgressTime"),s&&s({table:e,status:-1}),o(n)},m="syncTime"+e,S=localStorage.getItem(m),h=(new Date).valueOf(),y=S?parseInt(S)+5e3:0;"Connection_Session__mc"!=e&&h<y?(r.status=l,r.mc_add_status="sync-too-soon",t(r)):(localStorage.setItem(m,h),x(function(s){if(s.status==O||s.status==L||s.status==V){var m=localStorage.getItem("syncInProgressTime"),S=(new Date).valueOf();"Connection_Session__mc"!=e&&m&&m>S-12e4?(r.status=l+d,_(r)):(localStorage.setItem("syncInProgressTime",S),a.getTableDefnColumnValue(e,"Sync Type").then(function(a){q(function(s){"Mobile_Log__mc"!=e?null!==s&&void 0!==s?H(s,function(o){o.status==J?"Refresh Only"==a||"Refresh & Clear"==a?c(e,u,_):p(e,a,n,u,_):(r.status=SYNC_OK,r.mc_add_status=o.status,t(r))},function(e){i.errorAndDispatch(e),o(e)}):"Refresh Only"==a||"Refresh & Clear"==a?c(e,u,_):p(e,a,n,u,_):p(e,a,!1,u,_)},_)}).catch(function(e){_(e)}))}else r.status=f,r.mc_add_status=s.status,t(r),100101==r.mc_add_status||100102==r.mc_add_status?i.error(r):i.log(r)},_))})}function S(e){return new Promise(function(n,t){var o=function(e){t(e)},r={},c={},u={},d=e.mt,l=s.buildExactQuerySpec("Mobile_Table_Name",d,mobileCaddy.QUERY_BUFFER_SIZE);a.querySoupRecordsWithQuerySpec("recsToSync",l,function(t){t.forEach(function(e){if("Insert"==e.CRUD_Operation||"InsertUpdate"==e.CRUD_Operation)c[e.Id]=1;else{if("Update"!=e.CRUD_Operation&&"UpdateUpdate"!=e.CRUD_Operation)return void i.error("RTS contains record with non support CRUD Operation"+e);u[e.Id]=1}}),a.getProxyFieldName(d).then(function(i){var l=[],f=[];(e.records.forEach(function(e){var n=!0;null!==e.recordData.MC_Proxy_ID__c&&c.hasOwnProperty(e.recordData[i])&&(n=!1),n&&u.hasOwnProperty(e.recordData.Id)&&(n=!1),n&&l.push(e.recordData)}),e.ds)&&e.ds.oq.concat(e.ds.sd.concat(e.ds.hd.concat(e.ds.sh))).forEach(function(e){u.hasOwnProperty(e)||f.push({Id:e})});var p=s.buildExactQuerySpec("Mobile_Table_Name",d,mobileCaddy.QUERY_BUFFER_SIZE);a.querySoupRecordsWithQuerySpec("recsToSync",p,function(i){i.length==t.length?a.deleteRecordsForExternalId(d,f,"Id",function(){s.upsertSoupEntriesWithExternalId(d,l,"Id",function(){s.soupExists("SnapShot_"+d,function(t){t?a.deleteRecordsForExternalId("SnapShot_"+d,f,"Id",function(){s.upsertSoupEntriesWithExternalId("SnapShot_"+d,l,"Id",function(){te(e),h(e.platAuthUrl),r.status=0,r.cs=e.cs,r.cp=e.cp,r.lastRefreshDatetime=e.lastRefreshDatetime,n(r)},o)},o):(te(e),h(e.platAuthUrl),r.status=0,r.lastRefreshDatetime=e.lastRefreshDatetime,r.cs=e.cs,r.cp=e.cp,n(r))},o)},o)},o):(r.status=0,r.mc_add_status=1,r.cs=e.cs,r.cp=e.cp,r.lastRefreshDatetime=e.lastRefreshDatetime,resolves(r))},o)})},o)})}function h(e){e||(e=""),r.updateCurrentValueInAppSoup("platAuthUrl",e).catch(function(n){i.error("setPlatAuthUrl",e,n)})}var y=100500,b=100402;function g(e,n,t,o,s,c,d,l){var f,_,m,h,C=function(o,r){if(r.status){var s,c,u=new RegExp("\n","g");o=o.replace(u,"\\n"),u=new RegExp("\r","g"),o=o.replace(u,""),S(c=JSON.parse(o)).then(function(n){return s=n,a.setTableDefnColumnValue(e,"Last Refresh Date/Time",s.lastRefreshDatetime)}).then(function(){var n="P2M RE Records Processed";return"Connection_Session__mc"==e&&(n="P2M Conn_Sess Records Processed"),1==s.mc_add_status&&(n="P2M RE Abandoned"),h.connSessionRec.mobilecaddy1__Mobile_Process_Status__c=n,h.connSessionRec.Id=s.cs,ee(h.connSessionRec)}).then(function(){return ne(c.csM2P)}).then(function(){t&&_<p?z(h.connSessionRec,function(){c["Session Number"]&&c["Session Number"]<c["Total Sessions"]?g(e,n,t,c["Session Number"]+1,c["Total Sessions"],c.CsPId,d,l):c.moreBatches?g(e,n,t,"newBatch",1,null,d,l):(v.status=y,d(v))},l):c["Session Number"]&&c["Session Number"]<c["Total Sessions"]?g(e,n,t,c["Session Number"]+1,c["Total Sessions"],c.CsPId,d,l):c.moreBatches?g(e,n,t,"newBatch",1,null,d,l):(v.status=y,d(v))}).catch(function(e){l(e)})}else"exception"===r.type&&i.error("p2mRefresh",e,r.message,r.where),X(r,h,function(e){v.status=b,v.mc_add_status=e.mc_add_status,d(v)},l)},v={},R="newBatch"==o;R&&(o=1);try{a.getTableDefnColumnValue(e,"Last Refresh Date/Time").then(function(e){(m=e)&&"null"!=m||(m=0);var t=new Date;return m<t-n||o>1||R?r.getCachedCurrentValueFromAppSoup("audId"):(v.status=100402,v.status=100497,d(v),Promise.reject(v))}).then(function(e){return f=e,r.getCachedCurrentValueFromAppSoup("syncRefreshVersion")}).then(function(e){return I(_=e,"Sync - Refresh","P2M RE Process Called",o,s,c)}).then(function(e){if(h=e,!t){var n=JSON.parse(h.connSessJson);n.initialSync=!0,h.connSessJson=JSON.stringify(n)}if(R){var o=JSON.parse(h.connSessJson);o.firstBatch=!1,h.connSessJson=JSON.stringify(o)}return E(_,t)}).then(function(n){n&&(h.connSessJson=JSON.parse(h.connSessJson),h.connSessJson.csM2P=n,h.connSessJson=JSON.stringify(h.connSessJson)),!0===u?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/p2mRefreshTable001",contentType:"application/json",data:{audId:f,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:_,mobileTableName:e,deviceRefreshIds:[],lastRefreshDateTime:m,thirdPartyJson:"",connSessJson:h.connSessJson}},function(e,n){void 0===n&&((n={}).status="200"),C(e,n)},l):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".p2mRefreshTable",f,_,e,[],m,"",h.connSessJson,C,{buffer:!1,escape:!1,timeout:12e4})}).catch(function(e){100497==e.status?d(e):(i.error(e),l(e))})}catch(e){i.errorAndDispatch(e)}}function C(e,n,t){return new Promise(function(o,a){r.getCachedCurrentValueFromAppSoup("audId").then(function(r){o("PROXY%"+e+"%"+t+"%"+n+"%"+r)}).catch(function(e){a(e)})})}function v(e,n,t,o){var r;if("Throw Exception"==o)throw i.errorAndDispatch("nullHandler - NULL value found",e,n,t.Id),"NULL value found for field "+n+" in Mobile Table "+e+" with Id = "+t.Id;return"Return NULL"==o?r=null:"Return Empty String"==o&&(r=""),r}function E(e,n){return new Promise(function(t,o){if(e<p||!n)t();else{var r,s=[];a.queryMobileTable("recsToSync","Mobile_Table_Name","Connection_Session__mc").then(function(e){return(r=e).length>0?a.querySoupRecsPromise("Connection_Session__mc"):Promise.resolve([])}).then(function(e){r.forEach(function(n){for(var t,o=0;o<e.length;++o)if(e[o].Id===n.Id){t=e[o];break}t&&s.push({Id:n.Id,t:function(e){switch(e){case"Sync - Refresh":return 1;case"Sync - Update":return 2;case"Status Check":return 3;default:return i.error("Unkown Session_Type__c",e),0}}(t.mobilecaddy1__Session_Type__c),s:function(e){switch(e){case"P2M RE Records Processed":return 1;case"P2M Conn_Sess Records Processed":return 2;case"P2M RE Abandoned":return 3;case"P2M RE Exception/Timeout":return 4;case"P2M RE Heartbeat Exception/Timeout":return 5;case"P2M RE Failure":return 6;case"P2M RE Hearbeat Failure":return 7;case"M2P Conn_Sess Records Processed":return 8;case"M2P Records Processed":return 9;case"M2P UP Failed - RTS Cleared":return 10;case"M2P SC - Status Check Processed":return 11;case"M2P SC Failure":return 12;case"M2P SC Exception/Timeout":return 13;case"M2P SC Heartbeat Exception/Timeout":return 14;case"M2P SC Heartbeat Failure":return 15;case"M2P UP Received - Records Processed":return 16;default:return i.error("Unkown CS status",e),0}}(t.mobilecaddy1__Mobile_Process_Status__c)})}),t(s)}).catch(function(e){i.error(e),t(null)})}})}function R(e,n,t,o,r,a,s,c,u,d,l){var f={MobileTable:e,connSessProxyId:d,records:[]};s.forEach(function(o){for(var s,d=0;d<c.length;++d)if(c[d].Id===o.Id){s=c[d];break}if(s){var l={RTSRowNum:o._soupEntryId,RecordCRUD:function(e){switch(e){case"Insert":return"I";case"InsertDelete":return"T";case"Update":return"U";case"UpdatetDelete":return"Q";case"Delete":return"D";default:return null}}(o.CRUD_Operation),fields:[]};switch(l.RecordCRUD){case"I":case"T":l=function(e,n,t,o,r,a,i,s){for(var c in s){var u={name:c};if("mobilecaddy1__Error_Text__c"==c)u.value=JSON.stringify(s[c]),e.fields.push(u);else if("_soupEntryId"!=c&&"_soupLastModifiedDate"!=c){var d,l={};l[o]=c;var f=_.findWhere(t,l);if(null===s[c])fieldNullHandler=f[a],d=v(n,c,s,fieldNullHandler);else if(d=s[c],f){var p=f[i];"M2P UP Unquoted"!=p||"true"!=d&&"false"!=d||(d="true"==d)}u.value=d,e.fields.push(u)}}return e}(l,e,n,t,0,r,a,s),f.records.push(l);break;case"D":case"U":case"Q":for(var p,m=0;m<u.length;++m)if(u[m].Id===o.Id){p=u[m];break}p?(l=function(e,n,t,o,r,a,i,s,c){var u=!1;for(var d in s)if("_soupEntryId"!=d&&"_soupLastModifiedDate"!=d){var l={name:d};if(s[d]!=c[d]||"SystemModstamp"==d){var f,p;u=!0;var m=null,S=null,h={};h[o]=d;var y=_.findWhere(t,h);null===s[d]?(m=y[a],f=v(n,d,s,m)):(f=s[d],y&&("M2P UP Unquoted"!=(S=y[i])||"true"!=f&&"false"!=f||(f="true"==f))),null===c[d]&&y?(m||(m=y[a]),p=v(n,d,c,m)):(p=c[d],y&&(S||(S=y[i]),"M2P UP Unquoted"!=S||"true"!=p&&"false"!=p||(p="true"==p))),l.previousValue=p,l.value=f,e.fields.push(l)}}return u?(e.fields.push({name:"Id",previousValue:c.Id,value:c.Id}),e):[]}(l,e,n,t,0,r,a,s,p),f.records.push(l)):i.errorAndDispatch("createUpdateJson Missing snapShot",e,s.Id);break;default:i.errorAndDispatch("createUpdateJson unknown CRUD",e,o.Id,o.CRUD_Operation)}}else i.errorAndDispatch("createUpdateJson Missing primary",e,o.Id)}),l(JSON.stringify(f))}function T(e,n,t,o,r){var i=[];n.forEach(function(e){var n={};t.forEach(function(t){if(e.Id==t.Id&&"Insert"==e.CRUD_Operation)for(var o in t)"_soupEntryId"!=o&&"_soupLastModifiedDate"!=o&&(n[o]=t[o])}),_.isEmpty(n)||i.push(n)}),0===i.length?o():a.getProxyFieldName(e).then(function(n){s.upsertSoupEntriesWithExternalId("SnapShot_"+e,i,n,o,r)})}function I(e,n,t,o,u,d){return new Promise(function(e,l){var f={};c.getLocation(function(c){var p={mobilecaddy1__Session_Type__c:n,mobilecaddy1__Mobile_Process_Status__c:t,SystemModstamp:(new Date).getTime()},_=c.ErrorNumber;0!==_?p.mobilecaddy1__Session_Created_Location_Error__c=c.Error:(p.Session_Created_Location__Longitude__s=c.Latitude,p.Session_Created_Location__Latitude__s=c.Longitude),function(e,n,t,o){var r={},i=new Date;a.getProxyFieldName(e).then(function(a){s.upsertSoupEntries(e,[n],function(n){var c=n[0];C(e,c._soupEntryId,i.getTime()).then(function(n){c.Id=n,c[a]=n,s.upsertSoupEntries(e,[c],function(e){r.status=0,r.proxyId=n,r.insertedRecord=e[0],t(r)},o)}).catch(function(e){o(e)})},o)}).catch(function(e){o(e)})}("Connection_Session__mc",p,function(n){var t=new Date,a={"Sync Session Proxy ID":null,"Total Sessions":u,"Session Number":o,"Device Call Date/Time":t.getTime(),"Connection Session Proxy ID":n.proxyId};d&&(a.CsPId=d),0!==_?a.ErrorNumber=_:(a["Location Long"]=c.Longitude,a["Location Lat"]=c.Latitude),f.status=0,f.connSessionRec=n.insertedRecord,f.connSessProxyId=n.proxyId;var s={version:"NULL"};window.device&&(s=window.device),r.getCurrentValueFromAppSoup("containerVersion").then(function(n){a.containerVsn=n,a.OSVsn=s.version,f.connSessJson=JSON.stringify(a),e(f)}).catch(function(n){i.error("buildConnectionSession - Could not get containerVsn",n),a.OSVsn=s.version,f.connSessJson=JSON.stringify(a),e(f)})},function(e){l(e)})},function(e){l(e)})})}function N(e){return new Promise(function(n,t){var o={},c=function(e){n(e)},d=function(e){t(e)},l=s.buildExactQuerySpec("Mobile_Table_Name",e,mobileCaddy.QUERY_BUFFER_SIZE);a.querySoupRecordsWithQuerySpec("recsToSync",l,function(n){if(0!==n.length){var t=!1;"Connection_Session__mc"!=e&&n.length>3e4&&(t=!0);var s=[];s=t?(s=_.sortBy(n,"_soupLastModifiedDate")).slice(0,3e4):n,a.querySoupRecords(e,function(n){a.querySoupRecords("SnapShot_"+e,function(t){a.getSysDataRowMapColHeadings("Row Mapping TC",["Parent SOUP Name","Table Column Name","M2P Update Converter DEVICE","M2P Update NULL Handler DEVICE","M2P Update Formatter DEVICE"],function(l){var f=l[0],p=l[1],m=(l[2],l[3]),S=l[4];a.queryMobileTableWithAnd("syncLib_system_data","MC_Var_String_001","Platform Table Column",f,e,function(l){var f=[];_.each(s,function(e){var t;t=e.Id,_.find(n,function(e){return e.Id==t})&&f.push(e)}),_.isEmpty(f)?a.setTableDefnColumnValue(e,"Last Sync Date/Time",(new Date).getTime()).then(function(){o.status=P,o.mc_add_status=w,c(o)}).catch(function(e){i.error(e)}):R(e,l,p,0,m,S,f,n,t,"",function(t){var a;r.getCachedCurrentValueFromAppSoup("audId").then(function(e){return a=e,r.getCachedCurrentValueFromAppSoup("syncRefreshVersion")}).then(function(r){T(e,s,n,function(){var n=function(e,n){o.result=e,o.event=n,c(o)};t=t.replace(/: undefined/g,': "undefined"'),!0===u?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/m2pUpdateTable001",contentType:"application/json",data:{audId:a,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:r,mobileTableName:e,jsonRecords:t}},function(e,t){void 0===t&&((t={}).status="200"),n(e,t)},d):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".m2pUpdateTable",a,r,e,t,JSON.stringify({"Session Number":1,"Location Long":10,"Location Lat":10,"Total Sessions":1,"Device Call Date/Time":(new Date).getTime(),"Connection Session Proxy ID":"1",ErrorNumber:2}),n,{buffer:!1,escape:!1,timeout:3e4})},d)}).catch(function(e){d(e)})})},d)},d)},d)},d)}else a.setTableDefnColumnValue(e,"Last Sync Date/Time",(new Date).getTime()).then(function(){o.status=P,o.mc_add_status=w,c(o)}).catch(function(e){i.log("No recs to sync")})},d)})}var P=100300,w=100310;function D(e,n,t,o){var c,d,l={};try{r.getCachedCurrentValueFromAppSoup("syncRefreshVersion").then(function(e){return d=e,I(0,"Sync - Update","M2P Process Called",1,1,null)}).then(function(e){return c=e,E(d,!0)}).then(function(f){f&&(c.connSessJson=JSON.parse(c.connSessJson),c.connSessJson.csM2P=f,c.connSessJson=JSON.stringify(c.connSessJson));var m=s.buildExactQuerySpec("Mobile_Table_Name",e,mobileCaddy.QUERY_BUFFER_SIZE);a.querySoupRecordsWithQuerySpec("recsToSync",m,function(f){if(0!==f.length){var m=!1;"Connection_Session__mc"!=e&&f.length>n&&(m=!0);(function(e,n,t,o){e.forEach(function(e){e.Current_Connection_Session=n}),s.upsertSoupEntriesWithExternalId("recsToSync",e,"Id",t,o)})(m?_.sortBy(f,"_soupLastModifiedDate").slice(0,n):f,c.connSessProxyId,function(n){a.querySoupRecords(e,function(s){a.querySoupRecords("SnapShot_"+e,function(f){a.getSysDataRowMapColHeadings("Row Mapping TC",["Parent SOUP Name","Table Column Name","M2P Update Converter DEVICE","M2P Update NULL Handler DEVICE","M2P Update Formatter DEVICE"],function(_){var S=_[0],h=_[1],y=(_[2],_[3]),b=_[4];a.queryMobileTableWithAnd("syncLib_system_data","MC_Var_String_001","Platform Table Column",S,e,function(a){R(e,a,h,0,y,b,n,s,f,c.connSessProxyId,function(a){var f;r.getCachedCurrentValueFromAppSoup("audId").then(function(r){f=r,T(e,n,s,function(){var n=function(n,r){var s;r.status?(n=n.replace(/,}/g,"}"),B(s=JSON.parse(n),a,function(n){c.connSessionRec.mobilecaddy1__Mobile_Process_Status__c="Connection_Session__mc"==e?"M2P Conn_Sess Records Processed":"M2P Records Processed",c.connSessionRec.Id=n.csId,ee(c.connSessionRec).then(function(){return ne(s.csM2P)}).then(function(){m?(l.status=P,l.mc_add_status="more-to-sync",t(l)):d<p?z(c.connSessionRec,function(){l.status=P,t(l)},o):(l.status=P,t(l))}).catch(function(e){o(e)})},o)):"exception"===r.type?(l.status=P,l.mc_add_status=U,t(l),i.error("m2pUpdate",e,r.message,r.where)):(l.status=P,l.mc_add_status=M,t(l),i.error("m2pUpdate",e,r.message,r.where))};a=a.replace(/: undefined/g,': "undefined"'),!0===u?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/m2pUpdateTable001",contentType:"application/json",data:{audId:f,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:d,mobileTableName:e,jsonRecords:a,connSessJson:c.connSessJson}},function(e,t){void 0===t&&((t={}).status="200"),n(e,t)},o):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".m2pUpdateTable",f,d,e,a,c.connSessJson,n,{buffer:!1,escape:!1,timeout:3e4})},o)}).catch(function(e){o(e)})})},o)},o)},o)},o)},o)}else a.setTableDefnColumnValue(e,"Last Sync Date/Time",(new Date).getTime()).then(function(){l.status=P,l.mc_add_status=w,t(l)}).catch(function(e){o(e)})},o)},o)}catch(e){i.errorAndDispatch(e)}}var O=100100,U=100101,M=100102,A=100103,L=100104,V=100105;function x(e,n){var t={},o=navigator.appVersion.includes("Electron");o||navigator&&navigator.connection&&"undefined"!=typeof Connection?o||navigator.connection.type!=Connection.NONE?"undefined"==typeof Visualforce?(i.log("Visualforce not currently defined"),new Promise(function(e,n){var t=window.location.pathname,o=new XMLHttpRequest;o.open("GET",t,!0),o.send(),o.onreadystatechange=function(){if(o.readyState==XMLHttpRequest.DONE&&200==o.status){i.log("Startpage re-fetched",t);var e=new RegExp('"(\\S+VFRemote.js)"'),r=e.exec(o.response);if(r&&r[0]){var a=r[1];s=a,c=function(){i.log("remote script fetched",a),i.log("set up Visualforce ref")},u=document.createElement("script"),d=document.getElementsByTagName("script")[0],u.async=1,u.onload=u.onreadystatechange=function(e,n){(n||!u.readyState||/loaded|complete/.test(u.readyState))&&(u.onload=u.onreadystatechange=null,u=void 0,n||c&&c())},u.src=s,d.parentNode.insertBefore(u,d)}else n("Could not find VFRemote.js mention in "+t)}else o.readyState==XMLHttpRequest.DONE&&n(o.status);var s,c,u,d}}).then(function(t){F(e,n)}).catch(function(n){i.errorAndDispatch("Startpage Load Error: "+window.location.pathname,n),t.status=M,e(t)})):F(e,n):(t.status=A,e(t)):(localStorage.connection?t.status=localStorage.connection:t.status=L,e(t))}function F(e,n){var t={};Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".heartBeat",function(n,o){o.status?(t.status=O,e(t)):"exception"===o.type?k(function(n){t.status=V,e(t)},function(n){t.status=U,e(t)}):(t.status=M,e(t))},{escape:!1,timeout:3e4})}function k(e,n){a.querySoupRecords("appSoup",function(t){var o={};t.forEach(function(e){o[e.Name]=e.CurrentValue}),function(e,n,t){var o="grant_type=refresh_token&identity_url="+e.identityUrl+"&client_id="+e.clientId+"&refresh_token="+e.refreshToken+"&orgId="+e.orgId+"&audId="+e.audId+"&userId="+e.userId;var a=new XMLHttpRequest;a.open("POST","https://mobilecaddy.secure.force.com/apex/ProxyToken",!0),a.setRequestHeader("Content-type","application/x-www-form-urlencoded"),a.send(o),a.onreadystatechange=function(){if(a.readyState==XMLHttpRequest.DONE&&200==a.status){var e=JSON.parse(a.response);Visualforce.remoting.oauthAccessToken=e.access_token,Visualforce.remoting.last.refresh(function(){r.updateCurrentValueInAppSoup("accessToken",e.access_token).then(function(){n(e.access_token)}).catch(function(e){t(e)})},function(e){i.error("in VF last refresh error"),t(e)})}else a.readyState==XMLHttpRequest.DONE&&i.error("refreshTokenRequest error.",a.status)}}(o,e,n)},function(e){n(e)})}function q(e,n){a.querySoupRecords("recsToSync",function(t){for(var o=null,r=null,a=0;a<t.length;a++)if(null!==t[a].Current_Connection_Session&&void 0!==t[a].Current_Connection_Session){o=t[a].Current_Connection_Session,r=t[a];break}if(null!==o&&void 0!==o){var i=(new Date).getTime(),s=r._soupLastModifiedDate+3e4;if(i>s)e(o);else{var c={status:100498};n(c)}}else e(o)},n)}var J=100200,K=100201;function H(n,t,o){try{var c;r.getCachedCurrentValueFromAppSoup("syncRefreshVersion").then(function(e){return c=e,I(0,"Status Check","M2P SC Status Check Requested",1,1,null)}).then(function(d){x(function(l){var f;l.status==O||l.status==L||l.status==V?r.getCachedCurrentValueFromAppSoup("audId").then(function(r){f=r;var l=function(r,c){var u;c.status?((u=JSON.parse(r)).cs_fc_jr&&(u.cs_fc_jr=JSON.parse(u.cs_fc_jr)),"Received Processed"==u.cs_fc_sc?function(e,n,t,o){try{B(n.cs_fc_jr,function(r){e.connSessionRec.mobilecaddy1__Mobile_Process_Status__c="M2P SC - Status Check Processed",e.connSessionRec.SystemModstamp=(new Date).getTime(),e.connSessionRec.mobilecaddy1__Status__c="Closed",e.connSessionRec.Id=n.cs_sc_sf,a.queryMobileTable("Connection_Session__mc","Id",n.cs_fc_jr.cp).then(function(t){if(t[0]){var o=t[0];return o.Id=n.cs_fc_jr.csId,o.SystemModstamp=(new Date).getTime(),o.mobilecaddy1__Mobile_Process_Status__c="M2P Records Processed",ee([e.connSessionRec,o])}return Promise.resolve()}).then(function(){t({status:J})}).catch(function(e){o(e)})},o)}catch(e){i.errorAndDispatch("processM2PUpdateResponse",e),o("processM2PUpdateResponse-error")}}(d,u,t,o):function(e,n,t){a.queryMobileTable("recsToSync","Current_Connection_Session",e,function(e){if(0!==e.length){for(var o=0;o<e.length;o++)e[o].Current_Connection_Session=null,"InsertUpdate"==e[o].CRUD_Operation?e[o].CRUD_Operation="Insert":"UpdateUpdate"==e[o].CRUD_Operation&&(e[o].CRUD_Operation="Update");s.upsertSoupEntries("recsToSync",e,n,t)}else n()},t)}(n,function(){a.queryMobileTable("Connection_Session__mc","mobilecaddy1__MC_Proxy_ID__c",n,function(n){if(n.length>0){var r=n[0];"Received Not Processed"==u.cs_fc_sc?function(e,n,t,o,r){e.mobilecaddy1__Mobile_Process_Status__c="M2P UP Failed - RTS Cleared",e.mobilecaddy1__Session_Type__c="Sync Update",e.mobilecaddy1__Status__c="Closed",e.SystemModstamp=(new Date).getTime(),e.Id=t.cs_fc_sf,ee(e).then(function(){n.connSessionRec.mobilecaddy1__Mobile_Process_Status__c="M2P SC - Status Check Processed",n.connSessionRec.SystemModstamp=(new Date).getTime(),n.connSessionRec.mobilecaddy1__Status__c="Closed",n.connSessionRec.Id=t.cs_sc_sf,ee(n.connSessionRec)}).catch(function(e){r(e)})}(r,d,u,0,o):function(n,t,o,r,i){a.deleteRecordsFromSoup([n],"Connection_Session__mc",function(n){t.connSessionRec.mobilecaddy1__Mobile_Process_Status__c="M2P SC - Status Check Processed",t.connSessionRec.SystemModstamp=(new Date).getTime(),t.connSessionRec.mobilecaddy1__Status__c="Closed",t.connSessionRec.Id=o.cs_sc_sf,t.connSessionRec.mobilecaddy1__Session_Type__c="Status Check",ee(t.connSessionRec).then(function(){r({status:J})}).catch(function(){i(e)})},i)}(r,d,u,t,o)}else t({status:J})},o)},o)):(i.error("csStatusCheck",c.message),t({status:K}))},p=d.connSessJson,_=localStorage.getItem("lastErrorLog");_&&(localStorage.removeItem("lastErrorLog"),(p=JSON.parse(p)).lastErrorLog=_,p=JSON.stringify(p)),!0===u?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/m2pCSStatusCheck001",contentType:"application/json",data:{audId:f,syncRefreshDataVersion:c,statusCheckCSProxyId:n,connSessJson:p,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN}},function(e,n){void 0===n&&((n={}).status="200"),l(e,n)},function(e){i.error("err -> "+JSON.stringify(e)),o(e)}):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".m2pCSStatusCheck",f,c,n,p,l,{buffer:!1,escape:!1,timeout:3e4})}).catch(function(e){o(e)}):$(l,d,function(e){t({status:J,mc_add_status:e.mc_add_status})},o)},o)}).catch(function(e){o(e)})}catch(e){i.errorAndDispatch(e)}}function B(e,n,t,o){o||(o=t,t=n,n="{}");var r=1,c=e.mt,u=void 0!==e.is?e.is:[],d=void 0!==e.id?e.id:[],l=void 0!==e.us?e.us:[],f=void 0!==e.ifmf?e.ifmf:[],p=void 0!==e.ufmf?e.ufmf:[],m=[],S=[],h=[],y=[],b=[],g=[],C=[],v=[],E=[],R=[],T=[];if(u=u.concat(d),void 0===e.if)R=[];else if(void 0===e.if.if)R=e.if;else{r=2;var I=e.if.if.map(function(n){return{pd:n,fbe:void 0!==e.ifbe?e.ifbe:"K"}}),N=e.if.ifv.map(function(n){return{pd:n,fbe:void 0!==e.ifvbe?e.ifvbe:"K"}}),P=e.if.icv.map(function(n){return{pd:n,fbe:void 0!==e.icvbe?e.icvbe:"K"}});R=I.concat(N.concat(P))}(function(e,n,t,o){return new Promise(function(r,i){e=JSON.parse(e);var s=t.concat(o),c=t;if(e.records&&e.records.length>n.length+s.length){var u=[];a.getProxyFieldName(e.MobileTable).then(function(o){e.records.forEach(function(e){if("I"==e.RecordCRUD){var t=e.fields.find(function(e){return e.name==o}).value;_.findWhere(n,{pd:t})||_.findWhere(s,{pd:t})||u.push({pd:t,fbe:"K"})}}),u.length>0&&(c=t.concat(u)),r(c)})}else r(c)})})(n,u,R,f).then(function(n){if(R=n,void 0===e.uf)T=[];else if(void 0===e.uf.uf)T=e.uf;else{r=2;var t=e.uf.uf.map(function(n){return{Id:n,fbe:void 0!==e.ufbe?e.ufbe:"K"}}),o=e.uf.usv.map(function(n){return{Id:n,fbe:void 0!==e.usvbe?e.usvbe:"K"}}),a=e.uf.sdf.map(function(n){return{Id:n,fbe:void 0!==e.sdfbe?e.sdfbe:"K"}}),i=e.uf.hdf.map(function(n){return{Id:n,fbe:void 0!==e.hdfbe?e.hdfbe:"K"}}),s=e.uf.ufv.map(function(n){return{Id:n,fbe:void 0!==e.ufvbe?e.ufvbe:"K"}}),u=e.uf.ucv.map(function(n){return{Id:n,fbe:void 0!==e.ucvbe?e.ucvbe:"K"}});T=t.concat(o.concat(a.concat(i.concat(s.concat(u)))))}return Y("SnapShot_"+c)}).then(function(e){return E=e,Y(c)}).then(function(n){a.queryMobileTable("recsToSync","Mobile_Table_Name",c,function(d){for(var _ in d)if(d[_].Current_Connection_Session==e.cp){var I=!1,N={},P={};switch(d[_].CRUD_Operation){case"Insert":case"InsertUpdate":for(var w in u)if(d[_].Id==u[w].pd){if(u[w].crud=d[_].CRUD_Operation,P=W(u[w],n),"Insert"==d[_].CRUD_Operation){switch(e.stbe){case"D":C.push(P),v.push(u[w]);break;default:if("U"==u[w].pc){if(P.Id=u[w].Id,void 0!==u[w].an&&(void 0!==u[w].nf?P[u[w].nf]=u[w].an:P.Name=u[w].an),void 0!==u[w].lu)for(var D in u[w].lu)u[w].lu.hasOwnProperty(D),P[D]=u[w].lu[D];y.push(P),g.push(P)}}S.push(d[_]._soupEntryId)}else{if(P.Id=u[w].Id,void 0!==u[w].an&&(void 0!==u[w].nf?P[u[w].nf]=u[w].an:P.Name=u[w].an),void 0!==u[w].lu)for(var O in u[w].lu)u[w].lu.hasOwnProperty(O),P[O]=u[w].lu[O];y.push(P);var U=W(u[w],E);U.Id=u[w].Id,g.push(U),(N=d[_]).Current_Connection_Session=null,N.CRUD_Operation="Update",N.Id=u[w].Id,m.push(N)}I=!0;break}if(!I)for(w in R)if(d[_].Id==R[w].pd){if(R[w].crud=d[_].CRUD_Operation,"Insert"==d[_].CRUD_Operation)switch("K",1==r?Q(0,R[w].fl,e):R[w].fbe){case"K":(N=d[_]).Current_Connection_Session=null,m.push(N);break;case"R":break;default:P=W(R[w],n),C.push(P),S.push(d[_]._soupEntryId),v.push(R[w])}else"InsertUpdate"==d[_].CRUD_Operation&&((N=d[_]).Current_Connection_Session=null,N.CRUD_Operation="Insert",m.push(N));I=!0;break}if(!I)for(w in f)if(d[_].Id==f[w].pd){if(f[w].crud=d[_].CRUD_Operation,"Insert"==d[_].CRUD_Operation)switch(f[w].fbe){case"K":(N=d[_]).Current_Connection_Session=null,m.push(N);break;case"R":break;default:P=W(f[w],n),C.push(P),S.push(d[_]._soupEntryId),v.push(f[w])}else"InsertUpdate"==d[_].CRUD_Operation&&((N=d[_]).Current_Connection_Session=null,N.CRUD_Operation="Insert",m.push(N));I=!0;break}break;case"Update":case"UpdateUpdate":for(w in l)if(d[_].Id==l[w].Id){if(l[w].crud=d[_].CRUD_Operation,"Update"==d[_].CRUD_Operation){switch(P=W(l[w],n),e.stbe){case"D":C.push(P),v.push(l[w]);break;default:if("M"==l[w].pc&&(P.SystemModstamp=new Date(l[w].sm)),void 0!==l[w].lu)for(var M in l[w].lu)l[w].lu.hasOwnProperty(M)&&(P[M]=l[w].lu[M]);h.push(P),b.push(P)}S.push(d[_]._soupEntryId)}else"UpdateUpdate"==d[_].CRUD_Operation&&((N=d[_]).Current_Connection_Session=null,N.CRUD_Operation="Update",m.push(N));I=!0;break}if(!I)for(w in T)if(d[_].Id==T[w].Id){if("Update"==d[_].CRUD_Operation)switch("K",1==r?Q(1,T[w].fl,e):T[w].fbe){case"K":(N=d[_]).Current_Connection_Session=null,m.push(N);break;case"R":break;default:P=W(T[w],n),C.push(P),S.push(d[_]._soupEntryId),v.push(T[w])}else"UpdateUpdate"==d[_].CRUD_Operation&&((N=d[_]).Current_Connection_Session=null,N.CRUD_Operation="Update",m.push(N));I=!0;break}if(!I)for(w in p)if(d[_].Id==p[w].Id){if(p[w].crud=d[_].CRUD_Operation,"Update"==d[_].CRUD_Operation)switch(p[w].fbe){case"K":(N=d[_]).Current_Connection_Session=null,m.push(N);break;case"R":break;default:P=W(p[w],n),C.push(P),S.push(d[_]._soupEntryId),v.push(p[w])}else"UpdateUpdate"==d[_].CRUD_Operation&&((N=d[_]).Current_Connection_Session=null,N.CRUD_Operation="Update",m.push(N));I=!0;break}}}var A;a.getProxyFieldName(c).then(function(e){return A=e,j(c,"Id",h)}).then(function(e){return j(c,A,y)}).then(function(e){return j("SnapShot_"+c,"Id",b)}).then(function(e){return j("SnapShot_"+c,A,g)}).then(function(e){return G(c,C)}).then(function(e){return G("SnapShot_"+c,v)}).then(function(e){return n=m,new Promise(function(e,t){n.length>0?s.upsertSoupEntries("recsToSync",n,function(n){e(n)},function(e){t(e)}):e("OK")});var n}).then(function(e){return n=S,new Promise(function(e,t){n.length>0?s.removeFromSoup("recsToSync",n,function(n){e(n)},function(e){t(e)}):e("OK")});var n}).then(function(n){return te(e)}).then(function(){var n={status:0};n.csId=e.csId,t(n)}).catch(function(e){i.errorAndDispatch("m2pResp error for "+c,e),o(e)})},o)}).catch(function(e){i.errorAndDispatch("Err reading table",c),o(e)})}function W(e,n){var t={};return"Insert"==e.crud||"InsertUpdate"==e.crud?t.Id=e.pd:t.Id=e.Id,_.findWhere(n,t)}function Q(e,n,t){switch(e){case 0:switch(n){case"DF":return t.ifbe;case"CV":return t.icvbe;case"FV":return t.ifvbe}break;case 1:switch(n){case"DF":return t.ufbe;case"SV":return t.usvbe;case"CV":return t.ucvbe;case"FV":return t.ufvbe;case"SD":return t.sdfbe;case"HD":return t.hdfbe}}}function Y(e){return new Promise(function(n,t){a.querySoupRecords(e,function(e){n(e)},function(e){t(e)})})}function j(e,n,t){return new Promise(function(o,r){t.length>0?s.upsertSoupEntriesWithExternalId(e,t,n,function(e){o(e)},function(e){r(e)}):o("OK")})}function G(e,n){return new Promise(function(t,o){if(n.length>0)if(-1==e.indexOf("SnapShot"))a.deleteRecordsFromSoup(n,e,function(e){t(e)},function(e){o(e)});else{var r=n.filter(function(e){return e&&"Insert"==e.crud&&(e.Id=e.pd),null!==e&&void 0!==e});a.deleteRecordsForExternalId(e,r,"Id",function(e){t(e)},function(e){i.errorAndDispatch(e),o(e)})}else t("OK")})}var Z=100600;function X(e,n,t,o){var r={bogus:!0};"exception"===e.type?r.status=U:r.status=M,$(r,n,t,o)}function $(e,n,t,o){var r={},a=null;e.status==A?"Sync - Refresh"==n.connSessionRec.mobilecaddy1__Session_Type__c?a="P2M RE Heartbeat No Connection":"Status Check"==n.connSessionRec.mobilecaddy1__Session_Type__c&&(a="M2P SC Heartbeat No Connection"):e.status==U?"Sync - Refresh"==n.connSessionRec.mobilecaddy1__Session_Type__c?a=e.bogus?"P2M RE Exception/Timeout":"P2M RE Heartbeat Exception/Timeout":"Status Check"==n.connSessionRec.mobilecaddy1__Session_Type__c&&(a=e.bogus?"M2P SC Exception/Timeout":"M2P SC Heartbeat Exception/Timeout"):e.status==M&&("Sync - Refresh"==n.connSessionRec.mobilecaddy1__Session_Type__c?a=e.bogus?"P2M RE Failure":"P2M RE Hearbeat Failure":"Status Check"==n.connSessionRec.mobilecaddy1__Session_Type__c&&(a=e.bogus?"M2P SC Failure":"M2P SC Heartbeat Failure")),null!==a?(n.connSessionRec.mobilecaddy1__Mobile_Process_Status__c=a,n.connSessionRec.SystemModstamp=(new Date).getTime(),n.connSessionRec.mobilecaddy1__Status__c="Closed",s.upsertSoupEntries("Connection_Session__mc",[n.connSessionRec],function(){r.status=Z,r.mc_add_status=e.status,t(r)},o)):(i.error("Unknown heartBeatObject.status. ",e.status),o())}function z(e,n,t){var o={};a.querySoupRecsPromise("recsToSync").then(function(r){var a=_.filter(r,function(e){return void 0!==e.currentConnectionSession});a.length>1||"M2P Conn_Sess Records Processed"!=e.mobilecaddy1__Mobile_Process_Status__c?m("Connection_Session__mc").then(function(e){o.status=0,n(o)}).catch(function(e){i.warn("syncMobileTable ERROR -> ",e),t(e)}):(o.status=0,n(o))}).catch(function(e){i.error("querySoupRecsPromise ERROR -> ",e),t(e)})}function ee(e){return new Promise(function(n,t){var o=function(e){i.error("postProcessConnectionSession error",e),t(e)},r=Array.isArray(e)?e:[e],a={};s.upsertSoupEntries("Connection_Session__mc",r,function(t){var i=Array.isArray(e);i=r.map(function(e){return{Id:e.Id,SystemModstamp:e.SystemModstamp-1,mobilecaddy1__Session_Type__c:null,mobilecaddy1__Mobile_Process_Status__c:null,mobilecaddy1__Session_Created_Location_Error__c:null,mobilecaddy1__MC_Proxy_ID__c:null}}),s.upsertSoupEntries("SnapShot_Connection_Session__mc",i,function(e){var t=e.map(function(e){return{Mobile_Table_Name:"Connection_Session__mc",CRUD_Operation:"Update",SOUP_Record_Id:e._soupEntryId,Id:e.Id,LastModifiedDateTime:e.SystemModstamp}});s.upsertSoupEntries("recsToSync",t,function(){a.status=0,n(a)},o)},o)},o)})}function ne(e){return new Promise(function(n,t){e&&e.us&&0!==e.us.length?a.deleteRecordsForExternalId("Connection_Session__mc",e.us,"Id").then(function(n){return a.deleteRecordsForExternalId("SnapShot_Connection_Session__mc",e.us,"Id")}).then(function(n){return a.deleteRecordsForExternalId("recsToSync",e.us,"Id")}).then(function(e){n()}).catch(function(e){i.error("handleUpdatedCS",e),n()}):n(),e&&e.uf&&0!==e.uf.length&&i.error("handleUpdatedCS -> we have uf",e.uf)})}function te(e){return new Promise(function(n,t){null!==e.migrateTo&&void 0!==e.migrateTo?r.updateNewValueInAppSoup("dynVersionNumber",e.migrateTo).then(function(){n()}).catch(function(e){i.error(e),t(e)}):n()})}o.exports={CSINHEAD_SYNC_VSN:p,refreshToken:function(e,n){k(e,n)},genProxyId:function(e,n,t){return C(e,n,t)},addProxyIds:function(e,n,t,o,i){!function(e,n,t,o,i){var c;a.getProxyFieldName(e).then(function(e){return c=e,r.getCachedCurrentValueFromAppSoup("audId")}).then(function(r){n.forEach(function(n){var o="PROXY%"+e+"%"+t+"%"+n._soupEntryId+"%"+r;n.Id=o,n[c]=o}),s.upsertSoupEntries(e,n,function(e){o(e)},i)}).catch(function(e){i(e)})}(e,n,t,o,i)},P2M_REFRESH_OK:y,p2mRefreshTable:function(e,n,t,o,r,a,i,s){g(e,n,t,o,r,a,i,s)},buildConnectionSession:function(e,n,t,o,r,a){return I(0,n,t,o,r,a)},M2P_UPDATE_OK:P,M2P_NO_RECS_TO_SYNC:w,m2pUpdateMobileTable:function(e,n,t,o){D(e,n,t,o)},m2pRecoveryUpdateMobileTable:function(e){return N(e)},HEARTBEAT_OK:O,HEARTBEAT_EXCEPTION:U,HEARTBEAT_FAILURE:M,HEARTBEAT_NO_CONNECTION:A,HEARTBEAT_NOT_DEVICE:L,HEARTBEAT_REFRESHED_OK:V,heartBeat:function(e,n){x(e,n)},handleRefreshResponse:S,createUpdateJson:R,syncMobileTable:m,getRTSPendingconnSess:q,CLEAN_CS_OK:Z,cleanConnectionSessionHeartBeat:$,cleanConnectionSessionVFEvent:X,CONN_SESS_OK:J,csStatusCheck:H,maybeSyncConnSess:z,processM2PUpdateResponse:B,postProcessConnectionSession:ee,handleUpdatedCS:ne}}),t("mobileCaddy/vsnUtils",function(e,n,t){cordova.require("com.salesforce.plugin.smartstore");var o=mobileCaddy.require("mobileCaddy/smartStoreUtils"),r=e("mobileCaddy/appDataUtils"),a=e("mobileCaddy/logger"),i=e("mobileCaddy/syncRefresh"),s=["recsToSync"];function c(e,n){return new Promise(function(n,t){null===e?o.listMobileTables(o.ALPHA,function(e){var t=s;_.each(e,function(e){t.push(e),t.push("SnapShot_"+e),localStorage.removeItem("meta-tableDEF-"+e),localStorage.removeItem("meta-tableCRUD-"+e)}),n(t)},function(e){t(e)}):n([])})}function u(e,n){return new Promise(function(n,t){c(e).then(function(e){return Promise.all(e.map(o.deleteSoup))}).then(function(){n()}).catch(function(e){a.error(e),t(e)})})}function d(e){return new Promise(function(n,t){var s={},c=e?"Version Upgrade":"HardReset",d="";new Promise(function(e,n){i.refreshToken(function(n){e("ok")},function(e){n(e)})}).then(function(){o.querySoupRecsPromise("appSoup").then(function(e){return e.forEach(function(e){s[e.Name]=e.CurrentValue}),u(null)}).then(function(){d=l(s);var e,i,u="",f="localhost:3030"==window.location.host?"codeflow":"undefined"!=typeof mockStore?navigator.appVersion.includes("Electron")?"desktop":"platform":"device";if("codeflow"==f&&(e=localStorage.getItem("forceOAuth"),i=localStorage.getItem("appSoup")),localStorage.clear(),"codeflow"==f)localStorage.setItem("forceOAuth",e),localStorage.setItem("appSoup",i),u=window.location.protocol+"//"+window.location.host+"/www",n("ok");else if("platform"==f)u=window.location.href.substr(0,window.location.href.indexOf("#"));else{var p,_="";if(navigator&&navigator.connection&&(_=navigator.connection.type),window.device&&(p=window.device),navigator.appVersion.includes("Electron")){p=ipcRenderer.sendSync("request-device-info",""),_="wifi";var m="landscape"}var S=S||m;u=d+"?deviceUuid="+p.uuid+"&deviceName="+p.name+"&deviceCordova="+p.cordova+"&deviceVersion="+p.version+"&deviceModel="+p.model+"&buildName="+s.buildName+"&buildVersion="+s.buildVersion+"&buildOS="+s.buildOS+"&knownAud="+s.audId+"&currentDv="+s.dynVersionNumber+"&orientation="+S+"&viewportWidth="+window.innerWidth+"&viewportHeight="+window.innerHeight+"&sessionType="+c+"&connType="+_+"&loginUrl="+s.loginUrl+"&millsFromEpoch="+(new Date).getTime()}r.updateNewValueInAppSoup("buildStatus","Resetting").then(function(){o.deleteSoup("syncLib_system_data").then(function(e){try{window.location.href=u}catch(e){a.errorAndDispatch("error on redirect",e),t(e)}n()}).catch(function(e){a.errorAndDispatch(e)}),n()}).catch(function(e){a.errorAndDispatch(e),t(e)})}).catch(function(e){a.errorAndDispatch(e),t(e)})}).catch(function(e){a.error("Tokens are bad, testRefreshAccessToken rejected with: "+JSON.stringify(e)),window.history.go(-(history.length-1)),navigator.appVersion.includes("Electron")||cordova.require("com.salesforce.plugin.sfaccountmanager").logout(),t(e)})})}function l(e){var n,t="/apex/mobilecaddy1__MobileCaddyBootstrap001_mc";switch(e.platAuthUrl){case"i":case"I":n=e.instanceUrl+t;break;case"l":case"L":n=e.loginUrl+t;break;case"":n=void 0;break;default:n=e.platAuthUrl}return n||(e.authURLType||(e.authURLType="login"),n="login"==e.authURLType?e.loginUrl+t:e.instanceUrl+t),n}function f(){return new Promise(function(e,n){o.queryMobileTable("appSoup","Name","dynVersionNumber").then(function(n){void 0!==n[0].NewValue&&n[0].NewValue!=n[0].CurrentValue?e(!0):e(!1)}).catch(function(e){a.error(e),n(e)})})}t.exports={checkForMigrateToInfo:function(e){return checkForMigrateToInfo(e)},clearSoups:function(e,n){return u(e)},getSoupsToClear:function(e,n){return c(e)},hardReset:function(){return d()},upgradeAvailable:function(){return f()},upgradeIfAvailable:function(){return new Promise(function(n,t){f().then(function(o){if(o&&e)return d(!0);o?devUtils.dirtyTables().then(function(e){e.length>0?n(!1):i.getRTSPendingconnSess(function(e){if(null===e||void 0===e)return d(!0);n(!1)},function(e){n(!1)})}).catch(function(e){a.error(e),t(e)}):n(!1)}).catch(function(e){a.error(e),t(e)})});var e},_getBootstrapUrl:function(e){return l(e)}}}),t("mobileCaddy/logger",function(e,n,t){cordova.require("com.salesforce.plugin.smartstore");var o=e("mobileCaddy/smartStoreUtils"),r=0,a=1,i=2,s=3,c=4;function u(e,n){return new Promise(function(t,a){if(1==n.length&&(n=n[0]),"object"==(void 0===n?"undefined":_typeof(n))&&(n=JSON.stringify(n)),"number"!=typeof n&&"boolean"!=typeof n||(n=n.toString()),"string"==typeof n){e==r&&localStorage.setItem("lastErrorLog",n.substring(0,1024));var i={mobilecaddy1__Error_Text__c:n.substring(0,1024),SystemModstamp:(new Date).getTime()},s=localStorage.getItem("appSoup-audId");i.mobilecaddy1__Application_User_Device__c=s,i.mobilecaddy1__Log_Type__c="D"+e.toString(),o.insertRecords("Mobile_Log__mc",[i],function(e){t()},function(e){a(e)})}else logger.error("Trying to log unsupported type",void 0===n?"undefined":_typeof(n)),a("Trying to log unsupported type"+(void 0===n?"undefined":_typeof(n)))})}function d(e,n,t,o){var s=localStorage.getItem("logLevel");if((s=void 0===s?0:s)>=n){if(n>0){var c=o.stack.split("\n")[4];if(void 0!==c){var d=c.indexOf("at ");c.slice(d+2,c.length)}}var l=t[0];switch(n){case r:t[0]&&t[0].stack?l=t[0].message+", STACK:"+t[0].stack:t[1]&&t[1].stack?l+="\n"+t[1].message+", STACK:"+t[1].stack:l=t,u(n,l);break;case a:s>=a&&u(n,t);break;default:s>=i&&u(n,t)}e&&"undefined"!=typeof LOCAL_DEV&&LOCAL_DEV&&alert(l+"\n\nSee dev console for more information")}}function l(){try{throw Error("")}catch(e){return e}}t.exports={debug:function(e){return d(!1,c,arguments,l())},error:function(e){return d(!1,r,arguments)},errorAndDispatch:function(e){return d(!0,r,arguments)},info:function(e){return d(!1,s,arguments,l())},log:function(e){return d(!1,i,arguments,l())},warn:function(e){return d(!1,a,arguments,l())}}}),t("mobileCaddy/devUtils",function(e,n,t){var o=e("mobileCaddy/smartStoreUtils"),r=e("mobileCaddy/logger"),a=cordova.require("com.salesforce.plugin.smartstore"),i=e("mobileCaddy/appDataUtils"),s=e("mobileCaddy/vsnUtils"),c=e("mobileCaddy/syncRefresh"),u=!!window.USE_FORCETK,d=1,l=2,f=3,p=4,m=5,S=6,h=8,y=99,b=100400,g=100700,C=101e3,v=101100,E=101200,R=101300,T=["syncLib_system_data","appSoup","cacheSoup","recsToSync","SnapShot_Connection_Session__mc"],I=["autonumber","CreatedById","CreatedDate","IsDeleted","IsClosed","IsWon","LastModifiedById","LastModifiedDate","LastReferencedDate","mobilecaddy1__MC_Proxy_ID","MC_Proxy_ID","OwnerId","SystemModstamp","Id","dirtyFlag"];function N(e){return new Promise(function(n,t){var s=new Date,c=new Date(s.getFullYear(),s.getMonth(),s.getDate(),0,0,0,0).valueOf();new Promise(function(e,n){a.soupExists("Analytics",function(t){t?e():a.registerSoup("Analytics",[{path:"Name",type:"integer"},{path:"Data",type:"string"}],function(n){e()},function(e){n(e)})},function(e){r.error(e),n(e)})}).then(function(){return function(e){return new Promise(function(n,t){var s="";i.getCurrentValueFromAppSoup("audId").then(function(e){return s=e,o.querySoupRecsPromise("Analytics")}).then(function(i){var c=[],u=[],d=[];i.forEach(function(n){if(n.Name==e)c.push(n);else{var t={Name:n.Name.toString(),SystemModstamp:n.Name,mobilecaddy1__Error_Text__c:JSON.parse(n.Data),mobilecaddy1__Application_User_Device__c:s,mobilecaddy1__Log_Type__c:"analytic"};u.push(t),d.push(n._soupEntryId)}}),0!==u.length&&o.insertRecords("Mobile_Log__mc",u,function(e){a.removeFromSoup("Analytics",d,function(e){n(c)},function(e){r.error("Unable to insert analytic recs",e),t(e)})},function(e){r.error("Unable to insert analytic recs",e),t(e)}),n(c)}).catch(function(e){r.error("Error housekeeping Analytics",e),t(e)})})}(c)}).then(function(t){var o={};if(0===t.length){o[e]=1;var i={Name:c,Data:JSON.stringify(o)};n(o[e]),a.upsertSoupEntries("Analytics",[i],function(e){},function(e){r.error("Unable to insert analytic recs",e)})}else{var s=t[0];(o=JSON.parse(s.Data))[e]=void 0===o[e]?1:o[e]+1,n(o[e]),s.Data=JSON.stringify(o),a.upsertSoupEntriesWithExternalId("Analytics",[s],"Name",function(e){},function(e){r.error(e)})}}).catch(function(e){r.error("Error in analInc",e),t(e)})})}function P(e,n,t){return new Promise(function(r,a){var i=function(n,o){var i=0;switch(n){case g:i=1;break;case C:i=4;break;case v:i=7;break;case E:i=10;break;default:i=0}if("Y"==o.charAt(i))r(t);else{var s={};s.status=n+f,s.mc_add_status=e,a(s)}};-1==T.indexOf(e)?localStorage["meta-tableCRUD-"+e]?i(n,localStorage["meta-tableCRUD-"+e]):o.getTableDefnColumnValue(e,"Application Record CRUD").then(function(t){localStorage["meta-tableCRUD-"+e]=t,i(n,t)}).catch(function(e){a(e)}):r(t)})}function w(){return new Promise(function(e,n){if(!0===u){var t=force.getUserId();e(t)}else D("userId").then(function(n){e(n)}).catch(function(e){r.error("getCurrentUserId",e),n(e)})})}function D(e){return new Promise(function(n,t){i.getCachedCurrentValueFromAppSoup(e).then(function(e){n(e)}).catch(function(e){r.error("getCachedAppSoupValue",e),t(e)})})}function O(e,n,t,o){if("_soupLastModifiedDate"==e)return o;var r=_.findWhere(t,{path:e}),a={};if(void 0===r)return a.status=n+l,a.mc_add_status=e,a;var i=0;switch(n){case g:i=1;break;case C:i=4;break;case v:i=7;break;default:i=0}if("Y"!=r.crud.charAt(i))return a.status=n+f,a;try{return a.value=A(o,r.appColType,r.platColType),a}catch(t){return a.status=n+m,a.mc_add_status=t+"->"+e,a}}function U(e){return new Promise(function(n,t){localStorage["meta-tableDEF-"+e]?n(JSON.parse(localStorage["meta-tableDEF-"+e])):o.listMobileTableColumns(e,o.FULL,function(t){localStorage["meta-tableDEF-"+e]=JSON.stringify(t),n(t)},function(e){t(e)})})}function M(e,n,t){switch(t){case"checkbox":case"Deleted":return"true"===String(e);case"CreatedDate":case"date":case"datetime":case"LastActivtyDate":case"LastModifiedDate":case"LastReferencedDate":case"LastViewedDate":case"SystemModstamp":return null!==e?new Date(e):e;default:return e}}function A(e,n,t){switch(t){case"autonumber":throw"invalid_autonumber";case"checkbox":case"Deleted":if("boolean"==typeof e||"true"===e||"false"===e)return String(e);throw"invalid_boolean";case"date":if(e instanceof Date)return e.setUTCHours(0),e.setUTCMinutes(0),e.setUTCSeconds(0),e.setUTCMilliseconds(0),e.valueOf();if(null===e)return null;throw"invalid_date";case"datetime":if(e instanceof Date)return e.valueOf();if(null===e)return null;throw"invalid_datetime";case"email":if(function(e){if(0===e.length)return!0;var n=e.indexOf("@"),t=e.lastIndexOf(".");return!(n<1||t<n+2||t+2>=e.length)}(e))return e;throw"invalid_email";default:switch(n){case"jsString":if("string"==typeof e)return e;if("number"==typeof e)return e.toString();throw"invalid_string";case"jsNumber":if("number"==typeof e||null===e)return e;throw"invalid_number";default:return e}}}function L(e,n){return new Promise(function(t,r){var a={};localStorage["meta-tableCRUD-"+e]?t():o.listMobileTables(o.ALPHA,function(o){o.concat(T).indexOf(e)>=0?t():(a.status=n+d,a.mc_add_status=e,r(a))},function(e){a.status=n+y,a.mc_add_status="Unkonwn error "+e,r(a)})})}function V(e,n,t,o,a){return new Promise(function(i,s){var c={},u={};c.status=t,x().then(function(n){return n[e]&&(u=_.invert(n[e])),w()}).then(function(e){o.forEach(function(o){if(delete o._soupEntryId,delete o.$HashKey,o.RecordTypeName){if(o.RecordTypeId=u[o.RecordTypeName],_.isEmpty(u))return c.status=t+l,c.mc_add_status=o.RecordTypeName,i(c);if(!o.RecordTypeId)return c.status=t+h,c.mc_add_status=o.RecordTypeName,i(c);delete o.RecordTypeName}for(var r in o)if(o.hasOwnProperty(r)&&r!=n){var s=O(r,t,a,o[r]);if(s.status==t+l){c.status=s.status,c.mc_add_status=r;break}if(s.status==t+m){c.status=s.status,c.mc_add_status=r;break}if(s.status==t+f){c.status=s.status,c.mc_add_status=r;break}if(t==g&&I.indexOf(r)>=0){c.status=t+S,c.mc_add_status=r;break}o[r]=s.value}if(c.status!=t+l&&c.status!=t+m&&c.status!=t+S){var d=(new Date).getTime();t==g&&(o.CreatedById=e,o.CreatedDate=d),o.SystemModstamp=d,o.LastModifiedDate=d,o.LastModifiedById=e,o.IsDeleted="false",a.forEach(function(e){if(t==g){var n=e.crud.charAt(1);I.indexOf(e.path)<0&&"false"==e.nillable&&"Y"==n?_.has(o,e.path)||(c.status=t+p,c.mc_add_status=e.path):("IsClosed"==e.path&&(o.IsClosed="false"),"IsWon"==e.path&&(o.IsWon="false"))}""!==e.proxyRefField&&void 0!==o[e.path]&&o[e.path].length>18&&(o[e.proxyRefField]=o[e.path])})}}),c.records=o,i(c)},function(e){r.error("validateRecords",e)})})}function x(){return new Promise(function(e,n){localStorage.getItem("lsDotsRecordTypes")?e(JSON.parse(localStorage.getItem("lsDotsRecordTypes"))):o.querySoupRecords("dotsRecordTypes",function(n){var t={};n.forEach(function(e){var n={};JSON.parse(e.Data).forEach(function(e){n[e.recTypeId]=e.recTypeName}),t[e.Table]=n}),localStorage.setItem("lsDotsRecordTypes",JSON.stringify(t)),e(t)},function(e){r.error("Error returned from upsert, message =  "+e),n(e)})})}function F(e,n,t){var a,i={};return new Promise(function(s,c){n.length>0?L(e,E).then(function(){return U(e)}).then(function(n){return P(e,E,n)}).then(function(o){return new Promise(function(a,i){var s=O(t,E,o);s.status!=E+l?V(e,t,E,n,o).then(function(e){e.status==E?a(e.records):(i(e),r.error(e))}):(i(s),r.error(s))})}).then(function(r){return o.queryMobileTable(e,t,n[0][t])}).then(function(n){if(0===n.length)i.status=E+p,r.warn("deleteRecord no record found",e),i.mc_add_status="no record found",c(i);else{if(!(n[0].Id.length<19))return a=n,o.querySoupRecsPromise("recsToSync");i.status=E+f,r.warn("deleteRecord Cannot delete synced records"),i.mc_add_status="Cannot delete synced records",c(i)}}).then(function(n){var t=n.reduce(function(n,t){return t.Mobile_Table_Name==e&&_.findWhere(a,{_soupEntryId:t.SOUP_Record_Id})&&n.push({_soupEntryId:t._soupEntryId}),n},[]);o.deleteRecordsFromSoup(a,e,function(){o.deleteRecordsFromSoup(t,"recsToSync",function(){i.status=E,i.records=a,s(i)},function(e){c(e)})},function(e){c(e)})}).catch(function(e){c(e)}):(i.status=E,r.warn("deleteRecord No records supplied"),i.mc_add_status="No records supplied",i.records=[],s(i))})}function k(){return new Promise(function(e,n){K("recsToSync").then(function(n){var t=[],o=[];n.records.forEach(function(e){"Connection_Session__mc"!=e.Mobile_Table_Name&&void 0===t[e.Mobile_Table_Name]&&(t[e.Mobile_Table_Name]=!0,o.push(e.Mobile_Table_Name))}),e(o)}).catch(function(e){r.error(e),n(e)})})}function q(e,n){return new Promise(function(t,o){e.length>0&&-1==T.indexOf(n)?x().then(function(o){if(o[n]){var a=o[n],i=e.map(function(e){return e.RecordTypeName=a[e.RecordTypeId],e.RecordTypeName||r.warn("enrichWithRecordTypeNames",e.RecordTypeId),e});t(i)}else t(e)}).catch(function(e){o(e)}):t(e)})}function J(e,n){var t={};return new Promise(function(a,i){L(e,g).then(function(){return U(e)}).then(function(n){return P(e,g,n)}).then(function(t){return new Promise(function(o,r){V(e,null,g,n,t).then(function(e){e.status==g?o(e.records):r(e)})})}).then(function(n){o.insertRecords(e,n,function(e){t.status=g,t.records=e,s.upgradeAvailable().then(function(e){t.upgradeAvailable=e,a(t)}).catch(function(e){a(t),r.error(e)})},function(e){i(e),r.error(e)})}).catch(function(e){i(e),r.error(e)})})}function K(e,n){var t={};return new Promise(function(n,a){L(e,C).then(function(){return P(e,C)}).then(function(){return U(e)}).then(function(i){o.querySoupRecords(e,function(c){t.status=C,c.length>0?-1==T.indexOf(e)?o.getTableDefnColumnValue(e,"Last Refresh Date/Time").then(function(n){return H(e,c,i,n,t)}).then(function(e){n(e)}).catch(function(e){a(e),r.error(e)}):H(e,c,i,null,t).then(function(e){n(e)}):(t.records=[],s.upgradeAvailable().then(function(e){t.upgradeAvailable=e,n(t)}).catch(function(e){n(t),r.error(e)}))},function(e){a(e),r.error(e)})},function(e){a(e),r.error(e)})})}function H(e,n,t,o,a){return new Promise(function(i,c){n.forEach(function(e){for(var n in e){var r=_.findWhere(t,{path:n});void 0!==r&&(e[n]=M(e[n],r.appColType,r.platColType),"LastModifiedDate"==n&&(e.dirtyFlag=Q(e[n],o)))}}),a.records=n.filter(function(e){return"object"==(void 0===e?"undefined":_typeof(e))}),q(a.records,e).then(function(e){return a.records=e,s.upgradeAvailable()}).then(function(e){a.upgradeAvailable=e,i(a)}).catch(function(e){i(a),r.error(e)})})}function B(e,n){return new Promise(function(t,i){var c,u,d={},l=/FROM\s+\{(\S*)\}/gi.exec(e),f=n||1e3,p=l[1];(function(e,n){return new Promise(function(t,r){var a=!0,i=n.match(/SELECT\s+(.*)\s+FROM/i);"*"!==i[1]&&(a=!1);var s=n.match(/\s+FROM\s+{(.*)}\s+WHERE (.* = .*)/i);if(null!==s&&null!==s[1]){var c=n,u=s[2].split("AND"),d={},l="";u.forEach(function(e){var n=e.match(/{(.*):(.*)}\s+=\s+(.*)/i),t=n[2];l=n[3].split("'")[1],d[t]=l}),void 0!==d.Id&&d.Id.length>18?o.getProxyFieldName(e).then(function(e){c=c.replace("Id} =",e+"} ="),t([c,a])}):t([c,a])}else t([n,a])})})(p,e).then(function(e){var n=e[0];return u=e[1],c=a.buildSmartQuerySpec(n,f),"MC-TIMING smartRead "+p,L(p,C)}).then(function(){return P(p,C)}).then(function(){return U(p)}).then(function(e){o.smartQuerySoupRecordsWithQuerySpec(c,function(n){d.status=C,n.length>0?-1==T.indexOf(p)&&u?o.getTableDefnColumnValue(p,"Last Refresh Date/Time").then(function(t){return W(p,n,e,t,d)}).then(function(e){t(e)}):W(p,n,e,null,d).then(function(e){t(e)}):(d.records=[],s.upgradeAvailable().then(function(e){d.upgradeAvailable=e,t(d)}).catch(function(e){t(d),r.error(e)}))},function(){i()})},function(e){i(e),r.error(e)})})}function W(e,n,t,o,a){return new Promise(function(i,c){var u=[],d=!0;n.forEach(function(e){var n;if("object"==_typeof(e[1]))for(var r in n=e[1]){var a=_.findWhere(t,{path:r});void 0!==a&&(n[r]=M(n[r],a.appColType,a.platColType),"LastModifiedDate"==r&&(e[1].dirtyFlag=Q(e[1][r],o)))}else n=e,d=!1;u.push(n)}),a.records=u.filter(function(e){return"object"==(void 0===e?"undefined":_typeof(e))}),d?q(a.records,e).then(function(e){return a.records=e,s.upgradeAvailable()}).then(function(e){a.upgradeAvailable=e,i(a)}).catch(function(e){i(a),r.error(e)}):s.upgradeAvailable().then(function(e){a.upgradeAvailable=e,i(a)}).catch(function(e){i(a),r.error(e)})})}function Q(e,n){return n&&"null"!=n||(n=0),e.valueOf()>n}function Y(e,n){return new Promise(function(t,o){if(0===e.length)t({status:b+p});else{var a={};c.heartBeat(function(i){if(i.status==c.HEARTBEAT_OK||i.status==c.HEARTBEAT_NOT_DEVICE||i.status==c.HEARTBEAT_REFRESHED_OK){var s=[];k().then(function(t){return t.forEach(function(n){dirtyIndex=e.indexOf(n),dirtyIndex>-1&&(s.push({table:n,status:SYNC_NOK,mc_add_status:"Dirty records"}),e.splice(dirtyIndex,1))}),function e(n,t,o,a){return new Promise(function(i,s){o||(o=[]),a||(a=1);var u;(function(e,n){Promise.resolve();var t=[];return e.reduce(function(e,o){return e.then(function(e){return e&&e[e.length-1].status!=SYNC_OK?Promise.resolve():(n&&n({status:0,table:o}),t=o,new Promise(function(e,n){var o=function(n){e(n)},a={table:t};c.p2mRefreshTable(t,0,!1,1,1,null,function(e){e.status==c.P2M_REFRESH_OK?(a.status=b,o(a)):(a.status=e.status,a.mc_add_status=e.mc_add_status,o(a))},function(e){r.error("innerProcessRefreshTablePromise error",e),n(e)})}));var t}).then(function(e){return n&&n(e),t.push(e),t}).catch(function(e){r.errorAndDispatch(e)})},Promise.resolve())})(n,t).then(function(r){if(r.forEach(function(e,n){e&&(o.push(e),e.status!=SYNC_OK&&void 0===u&&(u=n))}),void 0!==u)if(a<3){var c=n.splice(u,n.length-u);e(c,t,o,a+1).then(function(e){i(e)}).catch(function(e){s(e)})}else s(o);else i(o)})})}(e,n)}).then(function(e){var n=s.concat(e).filter(function(e){return e});t(n);var a={mobilecaddy1__Mobile_Process_Status__c:""};j().then(function(e){c.maybeSyncConnSess(a,function(){},function(e){o(e),r.error(e)})})}).catch(function(e){if(Array.isArray(e)){var n=s.concat(e).filter(function(e){return e});r.error("InitialSync Failed"),G("Mobile_Log__mc").then(function(e){var t={mobilecaddy1__Mobile_Process_Status__c:""};j().then(function(e){c.maybeSyncConnSess(t,function(){G("Mobile_Log__mc"),o(n)},function(e){o(e),r.error(e)})})}).catch(function(e){r.error("Failed sending Mobile Logs"),o(e)}),o(n)}else o(e),r.error(e)})}else a.status=SYNC_NOK,a.mc_add_status=i.status,t(a),100101==a.mc_add_status||100102==a.mc_add_status?r.error(a):r.log(a)},function(e){r.error(e),a.status=SYNC_NOK,t(a)})}})}function j(){return new Promise(function(e,n){var t="SELECT * FROM {Connection_Session__mc} WHERE {Connection_Session__mc:mobilecaddy1__Mobile_Process_Status__c} = 'P2M RE Exception/Timeout'",i=a.buildSmartQuerySpec(t,100);o.smartQuerySoupRecordsWithQuerySpec(i,function(n){var t=n.map(function(e){return e[1].mobilecaddy1__Mobile_Process_Status__c="P2M InitialSync Faliure",e[1]});a.upsertSoupEntries("Connection_Session__mc",t,function(n){var t=n.map(function(e){return{Id:e.Id,SystemModstamp:e.SystemModstamp-1,mobilecaddy1__Session_Type__c:null,mobilecaddy1__Mobile_Process_Status__c:null,mobilecaddy1__Session_Created_Location_Error__c:null,mobilecaddy1__MC_Proxy_ID__c:null}});a.upsertSoupEntries("SnapShot_Connection_Session__mc",t,function(n){var t=n.map(function(e){return{Mobile_Table_Name:"Connection_Session__mc",CRUD_Operation:"Insert",SOUP_Record_Id:e._soupEntryId,Id:e.Id,LastModifiedDateTime:e.SystemModstamp}});a.upsertSoupEntries("recsToSync",t,function(){e()},function(e){r.error(e)})},function(e){r.error(e)})},function(e){r.error(e)}),e()},function(e){r.error(e),n(e)})})}function G(e,n,t,o,r,a){return new Promise(function(i,s){L(e,b).then(function(){return c.syncMobileTable(e,n,t,o,r,a)}).then(function(e){i(e)}).catch(function(e){s(e)})})}function Z(e,n,t){var a={};return new Promise(function(i,c){n.length>0?L(e,v).then(function(){return U(e)}).then(function(n){return P(e,v,n)}).then(function(o){return new Promise(function(r,a){var i=O(t,v,o);i.status!=v+l?V(e,t,v,n,o).then(function(e){e.status==v?r(e.records):a(e)}):a(i)})}).then(function(n){o.updateRecordsWithExternalId(e,n,t,function(e){a.status=v,a.records=e,s.upgradeAvailable().then(function(e){a.upgradeAvailable=e,i(a)}).catch(function(e){i(a)})},function(e){c(e),r.error(e)})},function(e){c(e),r.error(e)}):(a.status=v,a.mc_add_status="No records supplied",a.records=[],i(a),r.warn(a))})}t.exports={SYNC_OK:b,SYNC_NOK:100402,SYNC_ALREADY_IN_PROGRESS:b+98,SYNC_UNKONWN_TABLE:b+d,SYNC_MANDATORY_MISSING:b+p,DELETE_RECS_OK:E,DELETE_RECS_UNKONWN_TABLE:E+d,DELETE_RECS_UNKONWN_FIELD:E+l,DELETE_RECS_ACCESS_DENIED:E+f,DELETE_RECS_MANDATORY_MISSING:E+p,INSERT_RECS_OK:g,INSERT_RECS_UNKONWN_TABLE:g+d,INSERT_RECS_UNKONWN_FIELD:g+l,INSERT_RECS_ACCESS_DENIED:g+f,INSERT_RECS_MANDATORY_MISSING:g+p,INSERT_RECS_DATATYPE_MISMATCH:g+m,INSERT_RECS_PROTECTED_FIELD:g+S,INSERT_RECS_UNKNOWN_RECORD_TYPE:g+h,READ_RECS_OK:C,READ_RECS_UNKONWN_TABLE:C+d,READ_RECS_ACCESS_DENIED:C+f,UPDATE_RECS_OK:v,UPDATE_RECS_UNKONWN_TABLE:v+d,UPDATE_RECS_UNKONWN_FIELD:v+l,UPDATE_RECS_ACCESS_DENIED:v+f,UPDATE_RECS_DATATYPE_MISMATCH:v+m,UPDATE_RECS_UNKNOWN_ID:v+7,UPDATE_RECS_UNKNOWN_RECORD_TYPE:v+h,GET_REC_TYPES_UNKONWN_TABLE:R+d,analInc:function(e){return N(e)},deleteRecord:function(e,n,t){return F(e,[n],t)},dirtyTables:function(){return k()},syncMobileTable:function(e,n,t,o,r){return G(e,n,t,o,r)},initialSync:function(e){return Y(e)},getCurrentUserId:function(){return w()},getCurrentUserName:function(){return e="",new Promise(function(n,t){D("userFirstName").then(function(n){return e=n,D("userLastName")}).then(function(t){n(e+" "+t)}).catch(function(e){r.error("getCurrentUserName",e),t(e)})});var e},getUserLocale:function(){return D("userLocale")},getCachedAppSoupValue:function(e){return D(e)},getRecordTypes:function(e){return function(e){return new Promise(function(n,t){L(e,R).then(function(){return x()}).then(function(t){n(t[e])}).catch(function(e){t(e)})})}(e)},insertRecord:function(e,n){return J(e,[n])},insertRecords:function(e,n){return J(e,n)},logout:function(){return localStorage.clear(),void(navigator.appVersion.includes("Electron")?ipcRenderer.sendSync("logout",""):cordova.require("com.salesforce.plugin.sfaccountmanager").logout())},readRecords:function(e,n){return K(e)},smartSql:function(e){return B(e)},updateRecord:function(e,n,t){return Z(e,[n],t)},updateRecords:function(e,n,t){return Z(e,n,t)},maybeReadTransformType:function(e,n,t){return M(e,0,t)},maybeWriteTransformType:function(e,n,t){return A(e,n,t)}}}),window.mobileCaddy=n("mobileCaddy")}();