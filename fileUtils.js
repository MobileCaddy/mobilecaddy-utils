/* mobilecaddy-utils - v2.0.1 - Bundle Time: 2018-11-28 11:16:04 */
/* git info: "2018-11-23 16:02:33 +0000": f458f3fe3659eef32ccde089f82b18d5376b87d6 (msd-628/p2m-fileUtils) */
/* Copyright 2018 MobileCaddy Ltd */

"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.downloadFiles=downloadFiles,exports.storeFilesInfo=storeFilesInfo,exports.getStorageDirectory=getStorageDirectory;var appDataUtils=_interopRequireWildcard(require("./appDataUtils")),smartStoreUtils=_interopRequireWildcard(require("./smartStoreUtils")),logger=_interopRequireWildcard(require("./logger")),_=_interopRequireWildcard(require("underscore"));function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var o in e)if(Object.prototype.hasOwnProperty.call(e,o)){var t=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,o):{};t.get||t.set?Object.defineProperty(r,o,t):r[o]=e[o]}return r.default=e,r}var storageDirectory,smartstore=cordova.require("com.salesforce.plugin.smartstore"),logTag="fileUtils.js",RECORD_FILES_TABLE="File_Library__ap",QUERY_PAGE_SIZE=1e4,CONTENT_VSN_FIELD="SF_Content_Version_Id__c",SYNC_FIELD="Synchronised__c",FILE_TYPE_FIELD="File_Type__c",LOCAL_PATH_FIELD="Local_Path",FILE_PATH_SUFFIX="?asPdf=false&operationContext=CHATTER";function getStorageDirectory(){return(storageDirectory=localStorage.getItem("mcFileStorageDirectory"))||(storageDirectory=cordova.file?cordova.file.externalDataDirectory:"CodeFlow",localStorage.setItem("mcFileStorageDirectory",storageDirectory),storageDirectory)}function storeFilesInfo(e){return new Promise(function(r,o){storageDirectory||getStorageDirectory(),console.log(logTag,"storeFilesInfo",e);var t=e,n="",i=(t.map(function(e,r){return n+=0===r?"'"+e.Id+"'":",'"+e.Id+"'",e.Id}),"SELECT {"+RECORD_FILES_TABLE+":Id} FROM {"+RECORD_FILES_TABLE+"} WHERE {"+RECORD_FILES_TABLE+":Id} IN ("+n+")"),c=smartstore.buildSmartQuerySpec(i,QUERY_PAGE_SIZE);smartStoreUtils.smartQuerySoupRecordsWithQuerySpec(c).then(function(e){var r;return r=0!==e.length?t.filter(function(r){return!e[0].includes(r.Id)}):t,smartStoreUtils.upsertSoupEntries(RECORD_FILES_TABLE,r)}).then(function(e){r(e)}).catch(function(e){o(e)})})}function downloadFiles(){return new Promise(function(e,r){storageDirectory||getStorageDirectory();var o,t;getFilesToDownload().then(function(r){r.length>0?(t=r,appDataUtils.getCurrentValueFromAppSoup("accessToken").then(function(e){return o=e,Promise.all(t.map(function(e){return doDownloadFile("/sfc/servlet.shepherd/version/download/",e,o).then(function(e){return console.log("resp",e),e})})).then(function(e){return console.log("accum",e),e})}).then(function(r){console.log("res1",r),e(r)})):(console.log("No files to download"),e())}).catch(function(e){r(e)})})}function doDownloadFile(e,r,o){var t=e+r[1]+FILE_PATH_SUFFIX;return new Promise(function(e,n){console.log(logTag,"doDownloadFile",r,t);var i="no-cors";if("CodeFlow"==storageDirectory&&(t="https://cataas.com/c?wi=400",i="cors"),r[1]&&r[1].length>0){var c=new Headers;c.append("Authorization","Bearer "+o),c.append("Content-Type","image/jpeg");var a={method:"GET",headers:c,mode:i},s=new Request(t);fetch(s,a).then(function(o){console.log(logTag,o),200==o.status&&saveFile(r,o),e(o)}).catch(function(e){console.error("Something went wrong!",e),n(e)})}else e()})}function getFilesToDownload(){return new Promise(function(e,r){smartstore.soupExists(RECORD_FILES_TABLE,function(o){if(o){var t="SELECT {"+RECORD_FILES_TABLE+":Id},{"+RECORD_FILES_TABLE+":"+CONTENT_VSN_FIELD+"},{"+RECORD_FILES_TABLE+":"+FILE_TYPE_FIELD+"} FROM {"+RECORD_FILES_TABLE+"} WHERE {"+RECORD_FILES_TABLE+":"+SYNC_FIELD+"} = 0",n=smartstore.buildSmartQuerySpec(t,QUERY_PAGE_SIZE);smartStoreUtils.smartQuerySoupRecordsWithQuerySpec(n).then(function(r){console.log("Query res",r),r&&r[0]?e(r):e([])}).catch(function(e){r(e)})}else e([])},function(e){console.error("Failed to check soupExists for "+RECORD_FILES_TABLE),r(e)})})}function saveFile(e,r){"CodeFlow"!=storageDirectory?window.resolveLocalFileSystemURL(storageDirectory,function(o){console.log("file system open: "+o.name),o.getFile(e[1]+"."+e[2],{create:!0,exclusive:!1},function(o){writeFile(o,r).then(function(r){updateFileRec(e)})})}):r.arrayBuffer().then(function(r){var o=btoa(new Uint8Array(r).reduce(function(e,r){return e+String.fromCharCode(r)},""));localStorage.setItem("MCFILE_"+e[1]+"."+e[2],o),updateFileRec(e)})}function writeFile(e,r){return new Promise(function(o,t){e.createWriter(function(e){e.onwriteend=function(){console.log("Successful file write..."),o()},e.onerror=function(e){logger.error("Failed file write: "+e.toString()),t()},r.arrayBuffer().then(function(r){e.write(r)})})})}function updateFileRec(e){var r="SELECT * FROM {"+RECORD_FILES_TABLE+"} WHERE {"+RECORD_FILES_TABLE+":Id} = '"+e[0]+"'";console.log("soql",r);var o=smartstore.buildSmartQuerySpec(r,1);smartStoreUtils.smartQuerySoupRecordsWithQuerySpec(o).then(function(r){var o=r[0][1];console.log("myRec",o),o[SYNC_FIELD]=1,o[LOCAL_PATH_FIELD]=storageDirectory+e[1]+"."+e[2],smartstore.upsertSoupEntriesWithExternalId(RECORD_FILES_TABLE,[o],"Id",function(e){console.log("File DB entry updated",e)})}).catch(function(e){logger.error("Error updating "+RECORD_FILES_TABLE+" following file save",e)})}