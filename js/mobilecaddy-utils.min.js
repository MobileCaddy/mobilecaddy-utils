/*! mobilecaddy-utils - v0.0.8 - 2015-09-16*/
/* Copyright 2015 MobileCaddy Ltd */
var $j=jQuery.noConflict(),MC_TABLES=["Connection_Session__mc","Mobile_Log__mc","MC_Project__ap","MC_Time_Expense__ap","MC_Project_Location__ap"];!function(){var a,b;!function(){function c(b){var c=b.factory;return b.exports={},delete b.factory,c(a,b.exports,b),b.exports}var d={},e=[],f={};a=function(a){if(d[a]){if(a in f){var b=e.slice(f[a]).join("->")+"->"+a;console.error("Cycle in require graph: "+b)}}else console.error("module "+a+" not found");if(d[a].factory)try{return f[a]=e.length,e.push(a),c(d[a])}finally{delete f[a],e.pop()}return d[a].exports},b=function(a,b){d[a]&&console.error("module "+a+" already defined"),d[a]={id:a,factory:b}},b.remove=function(a){delete d[a]}}(),"object"==typeof module&&"function"==typeof a&&(module.exports.require=a,module.exports.define=b),b("mobileCaddy",function(a,c,d){var e={define:b,require:a,START_PAGE_CONTROLLER:"",QUERY_BUFFER_SIZE:50,INITIAL_APPCACHE_INFO:[]};d.exports=e}),b("mobileCaddy/mobileLogger",function(a,b,c){function d(){try{throw Error("")}catch(a){return a}}function e(a,b){var c=b.stack.split("\n")[4],d="";if("undefined"!=typeof c){var e=c.indexOf("at ");d=c.slice(e+2,c.length)}console.log(a,d)}function f(a,b){throw e(a,b),a}function g(a,b){for(var c in a)e("field:"+c+": has value :"+a[c]+":",b)}c.exports={logMessageAndThrow:function(a){f(a,d())},logMessage:function(a){e(a,d())},logObjectDetails:function(a){g(a,d())}}}),b("mobileCaddy/geolocation",function(a,b,c){function d(a){var b=[];b.Error="Location information is unavailable.",b.ErrorNumber=2,a(b)}c.exports={getLocation:function(a,b){d(a,b)}}}),b("mobileCaddy/startup",function(a,b,c){function d(){return new Promise(function(a,b){var c=[{path:"Mobile_Table_Name",type:"string"},{path:"SOUP_Record_Id",type:"string"},{path:"Id",type:"string"},{path:"LastModifiedDateTime",type:"integer"},{path:"CRUD_Operation",type:"string"},{path:"Current_Connection_Session",type:"string"}];l.registerSoup("recsToSync",c,function(){a()},function(a){b(a)})})}function e(a){mobileCaddy.INITIAL_APPCACHE_INFO=[],console.log("checkCache entry"),window.applicationCache.addEventListener("checking",function(a){f(a)},!1),window.applicationCache.addEventListener("downloading",function(a){f(a)},!1),window.applicationCache.addEventListener("progress",function(a){f(a)},!1),mobileCaddy.INITIAL_APPCACHE_INFO.push({Name:"AppCache: Initial Status",Description:window.applicationCache.status});var b={};switch(b.status=o,window.applicationCache.status){case window.applicationCache.CHECKING:case window.applicationCache.DOWNLOADING:throw window.applicationCache.addEventListener("updateready",function(b){f(b,a)},!1),window.applicationCache.addEventListener("cached",function(b){f(b,a)},!1),window.applicationCache.addEventListener("error",function(b){f(b,a)},!1),window.applicationCache.addEventListener("noupdate",function(b){f(b,a)},!1),new Error("MobileCaddy - Cache busy.  Will continue when check/load is complete");case window.applicationCache.UPDATEREADY:window.applicationCache.swapCache(),a(b),console.log("cache in updateready");break;default:console.log("cache in default"),a(b)}}function f(a,b){"progress"==a.type?(console.log("cache in progress"),mobileCaddy.INITIAL_APPCACHE_INFO.push({Name:"Event ",Description:a.loaded+" of "+a.total})):mobileCaddy.INITIAL_APPCACHE_INFO.push({Name:"Event ",Description:a.type});var c={};"udpateready"==a.type||(a.type="cached")?(console.log("cache in update ready or cached"),c.status=o):(console.log("cache in else"),c.status=p),console.log("return object "),k.logObjectDetails(c),b&&"function"==typeof b&&b(c)}function g(a){$j(function(){e(function(b){h(a,b)})})}function h(a,b){console.log("prep platform cache status = "+b);var c=j("appSoupJson");if(""!==c){console.log("app soup json = "+JSON.stringify(c));var d=$j.parseJSON(c),e=[{path:"Name",type:"string"},{path:"CurrentValue",type:"string"},{path:"NewValue",type:"string"}];l.registerSoup("appSoup",e,function(){l.upsertSoupEntries("appSoup",d,function(){var c=[{path:"Name",type:"string"},{path:"Description",type:"string"}];l.registerSoup("cacheSoup",c,function(){i(a,b)},function(a){k.logMessage("Failed to create cache soup with error = "+a)})},function(a){k.logMessage("Failed to update app soup with error = "+a)})},function(a){k.logMessage("Failed to register app soup with error = "+a)})}else console.log("app soup json2 = "+c),LOCAL_DEV?(cacheSoupStructure=[{path:"Name",type:"string"},{path:"Description",type:"string"}],l.registerSoup("cacheSoup",cacheSoupStructure,function(){i(a,b)})):(document.addEventListener("deviceready",function(){i(a,b)},!1),document.addEventListener("backbutton",function(){},!0))}function i(b,c){console.debug("cache status = "+JSON.stringify(c));a("mobileCaddy/logger");l.upsertSoupEntries("cacheSoup",mobileCaddy.INITIAL_APPCACHE_INFO,function(){n.querySoupRecsPromise("appSoup",l.buildAllQuerySpec("_soupEntryId",null,50)).then(function(a){var e={},f=[];if(a.forEach(function(a){if("undefined"!=typeof e[a.Name])throw"Should only be 1 "+a.Name+" entry in the app soup.  Found more";e[a.Name]=a}),e.userOverrideId||(e.userOverrideId=""),"Complete"==e.buildStatus.CurrentValue&&"Complete"==e.buildStatus.NewValue){if(null!==b){k.logMessage("build already complete - calling 3rd party callback function");var g={};g.status=r,g.mc_add_status=c.status,g.curVsn=e.dynVersionNumber.CurrentValue,"undefined"!=typeof e.dynVersionNumber.NewValue&&(g.newVsn=e.dynVersionNumber.NewValue),b(g)}}else{var h=function(a,g){if(g.status){k.logMessage("Parse json aud"+a),f=$j.parseJSON(a);var h=_.find(f,{Name:"audId"}).CurrentValue,i=_.find(f,{Name:"sysDataPlatSupVersion"}).CurrentValue;d().then(function(){m.createSystemDataSoup(function(){n.buildMobileTables(function(){var a=e.buildStatus;a.CurrentValue="Complete",a.NewValue="Complete",f.map(function(a){return e[a.Name]&&(a._soupEntryId=e[a.Name]._soupEntryId),a}),f.push(a),l.upsertSoupEntries("appSoup",f,function(){if(null!==b){var a={};a.status=q,a.mc_add_status=c.status,k.logMessage("Calling 3rd party callback"),k.logObjectDetails(a),b(a)}},function(a){k.logMessage("From upsert soup records "+a)})},function(a){k.logMessage("Error building mobile tables "+a)})},function(a){k.logMessage("create system data soup returned error"+a)},h,i),k.logMessage("Exiting startup")}).catch(function(a){k.logMessage("Error building recs to sync soup "+a)})}else"exception"===g.type&&alert(g.message)};USE_FORCETK===!0?force.request({method:"POST",path:"/services/apexrest/mc_package_002/getAUDInfo001",contentType:"application/json",data:{buildVersion:e.buildVersion.CurrentValue,buildName:e.buildName.CurrentValue,buildOS:e.buildOS.CurrentValue,deviceUuid:e.deviceUuid.CurrentValue,overrideUserId:force.getUserId(),startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN}},function(a){console.info("response -> "+JSON.stringify(a));var b={};b.status="200",h(a,b)},function(a){console.error("err -> "+JSON.stringify(a)),error()}):Visualforce.remoting.Manager.invokeAction("mc_package_002."+mobileCaddy.START_PAGE_CONTROLLER+".getAudInfo",e.buildVersion.CurrentValue,e.buildName.CurrentValue,e.buildOS.CurrentValue,e.deviceUuid.CurrentValue,e.userOverrideId,h,{escape:!1,timeout:3e4})}}).catch(function(a){console.error(a)})},function(a){k.logMessage("Failed to update app soup with initial app cache info = "+a)})}function j(a){console.info("getUrlParamByName -> name = "+a),a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b="[\\?&]"+a+"=([^&#]*)",c=new RegExp(b),d=c.exec(window.location.search);return console.log("getUrlParamByName results -> "+d),null===d?"":decodeURIComponent(d[1].replace(/\+/g," "))}var k=a("mobileCaddy/mobileLogger"),l=(a("mobileCaddy/logger"),cordova.require("com.salesforce.plugin.smartstore")),m=a("mobileCaddy/systemData"),n=a("mobileCaddy/smartStoreUtils"),o=(a("mobileCaddy/appDataUtils"),100900),p=100901,q=100800,r=100801;c.exports={startup:function(a){g(a)}}}),b("mobileCaddy/systemData",function(a,b,c){function d(a,b,c,d){h.logMessage("In populate system data row values");var e=function(a,b){if(b.status){h.logMessage("In remoting callback for getSysDataSoupVariables with record count = "+a.length),h.logMessage("Parse json "+a);var e=$j.parseJSON(a);h.logMessage("Parse json soup field defns done"),j.upsertSoupEntries("syncLib_system_data",e,c,d)}else"exception"===b.type?(alert(b.message),h.logMessage("Exception return from getSystemDataRowValues = "+b.message)):h.logMessage("Unknown return from getSystemDataRowValues = "+b.message)};USE_FORCETK===!0?force.request({method:"POST",path:"/services/apexrest/mc_package_002/getSysDataSoupVariables001",contentType:"application/json",data:{audId:a,startPageControllerVersion:i.START_PAGE_CONTROLLER_VSN,systemDataPlatformSupportVersion:b}},function(a){var b={};b.status="200",e(a,b)},d):Visualforce.remoting.Manager.invokeAction("mc_package_002."+i.START_PAGE_CONTROLLER+".getSysDataSoupVariables",a,b,e,{escape:!1})}function e(a,b,c,d){h.logMessage("In createSystemDataSoup"),"undefined"!=typeof c&&"undefined"!=typeof d?f(c,d,a,b):k.getCurrentValueFromAppSoup("audId",function(c){k.getCurrentValueFromAppSoup("sysDataPlatSupVersion",function(d){h.logMessage("In success callback with aud id = "+c),f(c,d,a,b)},b)},b)}function f(a,b,c,e){h.logMessage("In getSystemDataSoupDefinition with audId = "+a+" and sysDataPlatSupVersion = "+b);var f=function(f,i){if(i.status){h.logMessage("In getSystemDataSoupDefinition callback -> "+f),h.logMessage("Parse json app defns"+f);var k=$j.parseJSON(f);h.logMessage("Parse json app defns done"),$j.each(k,function(a,b){h.logObjectDetails(b)}),j.registerSoup("syncLib_system_data",k,function(){d(a,b,function(){g(a,b,c,e)},e)},e)}else"exception"===i.type?(alert(i.message),h.logMessage("Exception return from getSystemDataSoupDefinition = "+i.message)):h.logMessage("Unknown return from getSystemDataSoupDefinition = "+i.message)};USE_FORCETK===!0?(console.debug("USE_FORCETK == true"),force.request({method:"POST",path:"/services/apexrest/mc_package_002/getSystemDataSoupDefinition001",contentType:"application/json",data:{audId:a,startPageControllerVersion:i.START_PAGE_CONTROLLER_VSN,systemDataPlatformSupportVersion:b}},function(a){var b={};b.status="200",f(a,b)},e)):Visualforce.remoting.Manager.invokeAction("mc_package_002."+i.START_PAGE_CONTROLLER+".getSystemDataSoupDefinition",a,b,f,{escape:!1})}function g(a,b,c,d){h.logMessage(i.START_PAGE_CONTROLLER+".getDefsForSObjectMobileTables");var e=function(a,b){if(b.status){h.logMessage("Parse json "+a);var e=$j.parseJSON(a);h.logMessage("Parse json table defns done"),j.upsertSoupEntries("syncLib_system_data",e,function(a){console.log("successful upsert with rec count = "+a.length),c(a)},function(a){console.log("Error returned from upsert, message =  "+a),d(a)})}else"exception"===b.type?(alert(b.message),h.logMessage("Exception return from getDefsForSObjectMobileTables = "+b.message)):h.logMessage("Unknown return from getDefsForSObjectMobileTables = "+b.message)};USE_FORCETK===!0?force.request({method:"POST",path:"/services/apexrest/mc_package_002/getDefsForSObjectMobileTables001",contentType:"application/json",data:{audId:a,startPageControllerVersion:i.START_PAGE_CONTROLLER_VSN,systemDataPlatformSupportVersion:b}},function(a){var b={};b.status="200",e(a,b)},d):Visualforce.remoting.Manager.invokeAction("mc_package_002."+i.START_PAGE_CONTROLLER+".getDefsForSObjectMobileTables",a,b,e,{escape:!1,timeout:12e4})}var h=a("mobileCaddy/mobileLogger"),i=a("mobileCaddy"),j=(a("mobileCaddy/logger"),cordova.require("com.salesforce.plugin.smartstore")),k=(i.require("mobileCaddy/smartStoreUtils"),a("mobileCaddy/appDataUtils"));c.exports={createSystemDataSoup:function(a,b,c,d){e(a,b,c,d)}}}),b("mobileCaddy/smartStoreUtils",function(a,b,c){function d(a,b,c){B.soupExists(a,function(d){d?B.soupExists("SnapShot_"+a,function(d){d?i("SnapShot_"+a,function(d){w(d,"SnapShot_"+a,function(){i(a,function(d){B.upsertSoupEntries("SnapShot_"+a,d,b,c)},c)},c)},c):A.logMessageAndThrow("SnapShot Table is missing: SnapShot_"+a)},c):A.logMessageAndThrow("Mobile Table is missing"+a)},c)}function e(a,b,c,d,e){if(0===b.length)d();else{var f=[];$j.each(b,function(a,b){f.push(b[c])}),i(a,function(b){var g=[];$j.each(b,function(a,b){-1!=f.indexOf(b[c])&&g.push(b._soupEntryId)}),0===g.length?d():B.removeFromSoup(a,g,d,e)},e)}}function f(a,b){function c(a){$j.each(a.currentPageOrderedEntries,function(a,b){e.push(b)}),a.currentPageIndex<a.totalPages-1?cordova.require("com.salesforce.plugin.smartstore").moveCursorToNextPage(a,c):cordova.require("com.salesforce.plugin.smartstore").closeCursor(a,d)}function d(){b(e)}var e=[];c(a)}function g(a,b,c){var d=B.buildExactQuerySpec("Name",a,mobileCaddy.QUERY_BUFFER_SIZE);k("syncLib_system_data",d,function(a){A.logMessage("soup definition rows success callback with rec count = "+a.length);var c=[];$j.each(a,function(a,b){A.logMessage("processing record = "),b.Type!=mobileCaddy.STANDING_DATA_OBJECT&&b.Type!=mobileCaddy.DYNAMIC_DATA_OBJECT?(A.logMessage("Record Match"),c.push(b)):A.logMessage("Record does not match")}),b(c)},c)}function h(a,b){A.logMessage("in getQueryAndSoupDefinition");var c=[],d="Select ";$j.each(a,function(a,b){A.logMessage("soup column defn = "),c.push({path:b.Column_Name,type:b.Column_Type}),0!==b.Column_Name.indexOf("_")&&(d+=b.Column_Name+",")}),d=d.substring(0,d.length-1),d+=" From "+a[0].Name,b(d,c)}function i(a,b,c){var d=B.buildAllQuerySpec("_soupEntryId",null,mobileCaddy.QUERY_BUFFER_SIZE);B.querySoup(a,d,function(a){f(a,function(a){b(a)},c)})}function j(a){return new Promise(function(b,c){i(a,function(a){b(a.filter(function(a){return"object"==typeof a}))},function(a){c(a)})})}function k(a,b,c,d){B.querySoup(a,b,function(b){f(b,function(b){A.logMessage("Passing records back to callback for soup = "+a+" and rec count = "+b.length),c(b)},d)},d)}function l(a,b,c){console.debug("smartQuerySoupRecordsWithQuerySpec",a),B.runSmartQuery(a,function(a){f(a,function(a){A.logMessage("Passing records back to callback for soup with rec count = "+a.length),b(a)},c)},c)}function m(a,b,c,d,e){if("undefined"==typeof d&&"undefined"==typeof e)return new Promise(function(d,e){var f=B.buildExactQuerySpec(b,c,mobileCaddy.QUERY_BUFFER_SIZE_SL);k(a,f,function(a){d(a)},function(a){e(a)})});var f=B.buildExactQuerySpec(b,c,mobileCaddy.QUERY_BUFFER_SIZE_SL);k(a,f,function(a){d(a)},e)}function n(a,b,c,d,e,f,g){var h=B.buildExactQuerySpec(b,c,mobileCaddy.QUERY_BUFFER_SIZE_SL);k(a,h,function(a){var b=[];$j.each(a,function(a,c){c[d]==e&&b.push(c)}),f(b)},g)}function o(a,b,c){r("Row Mapping PT","Mobile Table Name",function(d){n("syncLib_system_data","MC_Var_String_001","Platform Table Definition",d,a,function(c){1!=c.length&&A.logMessageAndThrow("Should be exactly 1 table defn row for table: "+a+", but we got "+c.length),b(c[0])},c)},c)}function p(a,b,c,d){o(a,function(a){r("Row Mapping PT",b,function(b){c(a[b])},d)},d)}function q(a,b,c,d,e){o(a,function(a){r("Row Mapping PT",b,function(b){a[b]=c,B.upsertSoupEntries("syncLib_system_data",[a],d,e)},e)},e)}function r(a,b,c,d){n("syncLib_system_data","MC_Var_String_001",a,"MC_Var_String_003",b,function(d){1!=d.length&&($j.each(d,function(a,b){A.logObjectDetails(b)}),A.logMessageAndThrow("Must be exactly 1 Row Mapping Record for Sys Data Row Type = "+a+" and Sys Data Row Value = "+b+" found count = "+d.length)),c(d[0].MC_Var_String_004)},d)}function s(a,b,c,d){var e=B.buildExactQuerySpec("MC_Var_String_001",a,mobileCaddy.QUERY_BUFFER_SIZE_SL);k("syncLib_system_data",e,function(d){var e=[];$j.each(b,function(b,c){var f=!1;if($j.each(d,function(a,b){return b.MC_Var_String_003==c?(e.push(b.MC_Var_String_004),void(f=!0)):void 0}),!f)throw"No mapping found for type = "+a+" and value = "+c}),c(e)},d)}function t(a,b,c){s("Row Mapping PT",["Mobile Table Name","Build Order"],function(d){var e=d[0],f=d[1];m("syncLib_system_data","MC_Var_String_001","Platform Table Definition",function(c){var d=[];a==E?(c.sort(function(a,b){var c=0,d=parseInt(a[f]),e=parseInt(b[f]);return isNaN(d)||isNaN(e)||(c=d-e),c}),$j.each(c,function(a,b){d.push(b[e])}),null!==b&&b(d)):($j.each(c,function(a,b){d.push(b[e])}),a==D&&d.sort(),null!==b&&b(d))},c)},c)}function u(a,b,c,d){s("Row Mapping TC",["Parent SOUP Name","Table Column Name","Mobile Column Type","Application Field CRUD","META isNillable","Platform Column Type","Device Value Type","Proxy Ref Field Name"],function(d){var e=d[0],f=d[1],g=d[2],h=d[3],i=d[4],j=d[5],k=d[6],l=d[7];n("syncLib_system_data","MC_Var_String_001","Platform Table Column",e,a,function(a){var d=[];$j.each(a,function(a,c){b==F?d.push(c[f]):b==H?d.push({path:c[f],type:c[g],crud:c[h],nillable:c[i],platColType:c[j],appColType:c[k],proxyRefField:c[l]}):(d.push({path:c[f],type:c[g]}),A.logMessage("path = "+c[f]+" and type = "+c[g]))}),c(d)},function(a){A.logMessage("Error retrieving column names = "+a)})},d)}function v(a,b){console.debug("About to buildMobileTables"),t(E,function(c){var d=c.length;$j.each(c,function(c,e){u(e,G,function(c){console.debug("tableColumnObjectArray -> "+c),B.registerSoup(e,c,function(){console.log("success on register soup "+e),q(e,"SOUP Built Date/Time",(new Date).getTime(),function(){console.log("success on update of soup build date time"),p(e,"Snapshot Data Required",function(f){"Yes"==f?B.registerSoup("SnapShot_"+e,c,function(){console.log("Success from build of SnapShot_"+e),q(e,"Snapshot SOUP Built Date/Time",(new Date).getTime(),function(){d--,0===d&&a()},b)},function(a){console.log("Fail on create of SnapShot_"+e+" "+a),b(a)}):(d--,0===d&&a())},b)},b)},function(a){console.log("Fail on create of table"+e+" "+a),b(a)})},b)})},b)}function w(a,b,c,d){if(A.logMessage("In delete recs from soup with rec count = "+a.length),0!==a.length){var e=[];$j.each(a,function(a,b){e.push(b._soupEntryId)}),B.removeFromSoup(b,e,function(a){A.logMessage("Deleted rec(s) - calling callback"),c(a)},d)}else A.logMessage("no recs to delete - calling callback"),c()}function x(b,c,d,e){var f=a("mobileCaddy/syncRefresh");console.log("in insert records"),console.log("mobile table name = "+b),console.log("records = "+JSON.stringify(c)),console.log("records size = "+c.length),B.upsertSoupEntries(b,c,function(a){console.log("back from upsert soup with records = "+JSON.stringify(a));var c=(new Date).getTime();f.addProxyIds(b,a,c,function(a){console.log("back with proxy ids = "+JSON.stringify(a));var f=[];$j.each(a,function(a,d){var e={Mobile_Table_Name:b,CRUD_Operation:"Insert",SOUP_Record_Id:d._soupEntryId,Id:d.Id,LastModifiedDateTime:c};f.push(e)}),console.log("Calling upsert recs to sync -> "+JSON.stringify(f)),B.upsertSoupEntriesWithExternalId("recsToSync",f,"Id",d,e)},e)},e)}function y(a,b,c){var d=b.length,e=0;return new Promise(function(f,g){$j.each(b,function(h,i){m(a,c,i[c],function(a){if(a.length>0){var c=a[0];for(var j in i)c[j]=i[j];b[h]=c,e++,e>=d&&f(b)}else g({status:101107})},function(a){g(a)})})})}function z(b,c,d,e,f){a("mobileCaddy/syncRefresh");y(b,c,d).then(function(a){B.upsertSoupEntriesWithExternalId(b,a,d,function(a){m("recsToSync","Mobile_Table_Name",b,function(c){var d=[];$j.each(a,function(a,e){var f;$j.each(c,function(a,b){return b.Id==e.Id?void(f=b):void 0});var g;if("undefined"!=typeof f)if("undefined"!=typeof f.Current_Connection_Session)switch(f.CRUD_Operation){case"Insert":case"InsertUpdate":g="InsertUpdate";break;default:g="UpdateUpdate"}else g=f.CRUD_Operation;else g="Update";var h={Mobile_Table_Name:b,SOUP_Record_Id:e._soupEntryId,Id:e.Id,CRUD_Operation:g,LastModifiedDateTime:e.SystemModstamp};d.push(h)}),B.upsertSoupEntriesWithExternalId("recsToSync",d,"Id",e,f)},f)},f)}).catch(function(a){f(a)})}var A=a("mobileCaddy/mobileLogger"),B=cordova.require("com.salesforce.plugin.smartstore"),C=0,D=1,E=2,F=0,G=1,H=2;c.exports={NONE:C,ALPHA:D,BUILD:E,listMobileTables:function(a,b,c){t(a,b,c)},LIST:F,BUILD_OBJECT:G,FULL:H,listMobileTableColumns:function(a,b,c,d){u(a,b,c,d)},queryMobileTable:function(a,b,c,d,e){return m(a,b,c,d,e)},buildMobileTables:function(a,b){v(a,b)},getSysDataRowMapColHeading:function(a,b,c,d){r(a,b,c,d)},getSysDataRowMapColHeadings:function(a,b,c,d){s(a,b,c,d)},getTableDefnColumnValue:function(a,b,c,d){p(a,b,c,d)},setTableDefnColumnValue:function(a,b,c,d,e){q(a,b,c,d,e)},queryMobileTableWithAnd:function(a,b,c,d,e,f,g){n(a,b,c,d,e,f,g)},smartQuerySoupRecordsWithQuerySpec:function(a,b,c){l(a,b,c)},insertRecords:function(a,b,c,d){x(a,b,c,d)},updateRecordsWithExternalId:function(a,b,c,d,e){z(a,b,c,d,e)},markSoupToSync:function(a,b,c){var d=B.buildExactQuerySpec("Type",mobileCaddy.DYNAMIC_DATA_OBJECT,mobileCaddy.QUERY_BUFFER_SIZE_SL);k("syncLib_system_data",d,b,function(d){for(var e=0;e<d.length;e++)if(d[e].Name==a){d[e].Refresh_Indicator="Once",B.upsertSoupEntries("syncLib_system_data",[d[e]],b,c);break}},c)},emptySoup:function(a,b,c){var d=mobileCaddy.require("mobileCaddy/smartStoreUtils");B.removeSoup(a,function(){d.createSoup(a,b,c)},c)},emptySoupPromise:function(b){return new Promise(function(c,d){var e=mobileCaddy.require("mobileCaddy/smartStoreUtils"),f=a("mobileCaddy/logger");B.removeSoup(b,function(){e.createSoup(b,function(){console.debug("emptySoupPromise",b),c()},function(a){f.error("emptySoupPromise",a),d(a)})},function(a){f.error("emptySoupPromise",a),d(a)})})},deleteSoup:function(b){return console.debug("deleteSoup",b),new Promise(function(c,d){var e=(mobileCaddy.require("mobileCaddy/smartStoreUtils"),a("mobileCaddy/logger"));B.removeSoup(b,function(){e.log("deleteSoup",b),c()},function(a){e.error("deleteSoup",a),d(a)})})},createSoup:function(a,b,c){g(a,function(d){h(d,function(d,e){B.registerSoup(a,e,function(){b()},c)},c)},c)},querySoupRecords:function(a,b,c){i(a,b,c)},querySoupRecsPromise:function(a){return j(a)},querySoupRecordsWithQuerySpec:function(a,b,c,d){k(a,b,c,d)},compareVersions:function(a,b){var c=cordova.require("com.salesforce.plugin.smartstore").buildExactQuerySpec("Name",mobileCaddy.VERSION_ID,mobileCaddy.QUERY_BUFFER_SIZE);k("syncLib_system_data",c,function(c){simpleMessageSL("Version in soup = "+c[0].Value),getVersion(function(b){simpleMessageSL("Version in Salesforce = "+b),a()},b)},b)},deleteRecordsForExternalId:function(a,b,c,d,f){e(a,b,c,d,f)},deleteRecordsFromSoup:function(a,b,c,d){w(a,b,c,d)},refreshSnapshot:function(a,b,c){d(a,b,c)}}}),b("mobileCaddy/appDataUtils",function(a,b,c){function d(a,b,c){var d=f.buildExactQuerySpec("Name",a,mobileCaddy.QUERY_BUFFER_SIZE);return"undefined"==typeof b&&"undefined"==typeof c?new Promise(function(a,b){g.querySoupRecordsWithQuerySpec("appSoup",d,function(b){a(b[0].CurrentValue)},function(a){b(a)})}):void g.querySoupRecordsWithQuerySpec("appSoup",d,function(a){"undefined"!=typeof a[0]?b(a[0].CurrentValue):c()},c)}function e(a,b,c){return new Promise(function(d,e){var h=f.buildExactQuerySpec("Name",a,mobileCaddy.QUERY_BUFFER_SIZE);g.querySoupRecordsWithQuerySpec("appSoup",h,function(a){a[0][c]=b,f.upsertSoupEntries("appSoup",a,function(a){d(a)},function(a){e(a)})},function(a){e(a)})})}var f=(a("mobileCaddy/mobileLogger"),cordova.require("com.salesforce.plugin.smartstore")),g=a("mobileCaddy/smartStoreUtils");c.exports={getCurrentValueFromAppSoup:function(a,b,c){d(a,b,c)},updateNewValueInAppSoup:function(a,b){return e(a,b,"NewValue")},updateCurrentValueInAppSoup:function(a,b){return e(a,b,"CurrentValue")}}}),b("mobileCaddy/syncRefresh",function(a,b,c){function d(a,b,c){var d={};u.logMessage("Parse json date time");var e=new RegExp("\n","g");a=a.replace(e,"\\n"),e=new RegExp("\r","g"),a=a.replace(e,"");var f=$j.parseJSON(a);u.logMessage("Parse json date time done"),console.log("json object date time = "+f.lastRefreshDatetime);var g={},h={},i=f.mt;null===i&&u.logMessageAndThrow("Mobile Table (tag 'mt') empty in p2mRefresh response: "+a);var j=w.buildExactQuerySpec("Mobile_Table_Name",i,mobileCaddy.QUERY_BUFFER_SIZE);t.querySoupRecordsWithQuerySpec("recsToSync",j,function(a){$j.each(a,function(a,b){if("Insert"==b.CRUD_Operation||"InsertUpdate"==b.CRUD_Operation)g[b.Id]=1;else{if("Update"!=b.CRUD_Operation&&"UpdateUpdate"!=b.CRUD_Operation)return void u.logMessageAndThrow("RTS contains record with non support CRUD Operation"+b);h[b.Id]=1}});var e=[],j=[];if($j.each(f.records,function(a,b){var c=!0;_.indexOf(MC_TABLES,i)>-1?null!==b.recordData.mc_package_002__MC_Proxy_ID__c&&g.hasOwnProperty(b.recordData.mc_package_002__MC_Proxy_ID__c)&&(c=!1):null!==b.recordData.MC_Proxy_ID__c&&g.hasOwnProperty(b.recordData.MC_Proxy_ID__c)&&(c=!1),c&&h.hasOwnProperty(b.recordData.Id)&&(c=!1),c&&e.push(b.recordData)}),f.ds){var k=f.ds.oq.concat(f.ds.sd.concat(f.ds.hd.concat(f.ds.sh)));k.forEach(function(a){h.hasOwnProperty(a)?console.log("We have a dirty local version, not deleting"):j.push({Id:a})})}var l=w.buildExactQuerySpec("Mobile_Table_Name",i,mobileCaddy.QUERY_BUFFER_SIZE);t.querySoupRecordsWithQuerySpec("recsToSync",l,function(g){g.length==a.length?t.deleteRecordsForExternalId(i,j,"Id",function(){w.upsertSoupEntriesWithExternalId(i,e,"Id",function(){w.soupExists("SnapShot_"+i,function(a){a?t.deleteRecordsForExternalId("SnapShot_"+i,j,"Id",function(){w.upsertSoupEntriesWithExternalId("SnapShot_"+i,e,"Id",function(){s.checkForMigrateToInfo(f),d.status=0,d.cs=f.cs,d.cp=f.cp,d.lastRefreshDatetime=f.lastRefreshDatetime,b(d)},c)},c):(s.checkForMigrateToInfo(f),d.status=0,d.lastRefreshDatetime=f.lastRefreshDatetime,d.cs=f.cs,d.cp=f.cp,b(d))},c)},c)},c):(d.status=0,d.mc_add_status=1,d.cs=f.cs,d.cp=f.cp,d.lastRefreshDatetime=f.lastRefreshDatetime,b(d))},c)},c)}function e(a,b,c,e,f){var g={};u.logMessage("Refreshing table = "+a),l("Sync - Refresh","P2M RE Process Called",function(h){r.getCurrentValueFromAppSoup("audId",function(i){u.logMessage("Using app data aud id = "+i),r.getCurrentValueFromAppSoup("syncRefreshVersion",function(j){u.logMessage("Using app data syncRefreshVersion = "+j),t.getTableDefnColumnValue(a,"Last Refresh Date/Time",function(k){(null===k||""===k)&&(k=0),u.logMessage("Using lastRefreshDatetime = "+k),console.debug("maxTableAge",b);var l=new Date;if(l-b>k){var m="";console.log("last refresh date/time is "+k);var n=function(b,i){console.debug("jsonString",b),console.debug("event",i),i.status?(u.logMessage("In success callback from remoting 'refreshTable' call"),console.debug("returned json = "+b),d(b,function(b){console.log("handle refresh res = "+b.status),console.log(b.mc_add_status),console.log("### b RTS",localStorage.getItem("recsToSync")),console.log("### b CS",localStorage.getItem("Connection_Session__mc")),console.log("### b SCS",localStorage.getItem("SnapShot_Connection_Session__mc")),t.setTableDefnColumnValue(a,"Last Refresh Date/Time",b.lastRefreshDatetime,function(){console.log("Success from update last refresh date time");var d="P2M RE Records Processed";"Connection_Session__mc"==a&&(d="P2M Conn_Sess Records Processed"),1==b.mc_add_status&&(d="P2M RE Abandoned"),h.connSessionRec.mc_package_002__Mobile_Process_Status__c=d,h.connSessionRec.Id=b.cs,x.postProcessConnectionSession(h.connSessionRec,function(){console.log("success return from post process"),c?x.maybeSyncConnSess(h.connSessionRec,function(){console.log("success return from maybeSyncConnSess"),console.log("### e RTS",localStorage.getItem("recsToSync")),console.log("### e CS",localStorage.getItem("Connection_Session__mc")),console.log("### e SCS",localStorage.getItem("SnapShot_Connection_Session__mc")),g.status=y,e(g)},f):(g.status=y,e(g))},f)},f)})):("exception"===i.type&&v.error("p2mRefresh",a,i.message,i.where),x.cleanConnectionSessionVFEvent(i,h,function(a){g.status=z,g.mc_add_status=a.mc_add_status,e(g)},f))};console.log("### a RTS",localStorage.getItem("recsToSync")),console.log("### a CS",localStorage.getItem("Connection_Session__mc")),console.log("### a SCS",localStorage.getItem("SnapShot_Connection_Session__mc")),USE_FORCETK===!0?force.request({method:"POST",path:"/services/apexrest/mc_package_002/p2mRefreshTable001",contentType:"application/json",data:{audId:i,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:j,mobileTableName:a,deviceRefreshIds:[],lastRefreshDateTime:k,thirdPartyJson:m,connSessJson:h.connSessJson}},function(a,b){"undefined"==typeof b&&(b={},b.status="200"),n(a,b)},f):Visualforce.remoting.Manager.invokeAction("mc_package_002."+mobileCaddy.START_PAGE_CONTROLLER+".p2mRefreshTable",i,j,a,[],k,m,h.connSessJson,n,{escape:!1,timeout:3e4})}else console.log("Not refreshing table. it is too young"),g.status=100402,g.status=100497,e(g)},f)},f)},f)},f)}function f(a,b,c,d,e){r.getCurrentValueFromAppSoup("audId",function(e){var f="PROXY%"+a+"%"+c+"%"+b+"%"+e;d(f)},e)}function g(a,b,c,d,e){r.getCurrentValueFromAppSoup("audId",function(f){$j.each(b,function(b,d){var e="PROXY%"+a+"%"+c+"%"+d._soupEntryId+"%"+f;d.Id=e,_.indexOf(MC_TABLES,a)>-1?d.mc_package_002__MC_Proxy_ID__c=e:d.MC_Proxy_ID__c=e}),w.upsertSoupEntries(a,b,function(a){d(a)},e)},e)}function h(a,b,c,d){var e;if("Throw Exception"==d)throw"NULL value found for field "+b+" in Mobile Table "+a+" with Id = "+c.Id;return"Return NULL"==d?e="null":"Return Empty String"==d&&(e=""),e}function i(a,b,c,d,e,f,g,i,j,k,l){console.log("columnRecs",b),console.log("tableColumnColumn",c);var m="",n='{ "MobileTable" : "'+a+'",';n+='"connSessProxyId" : "'+k+'",',n+='"records" : [',$j.each(g,function(g,k){n+='{"RTSRowNum" : "'+k._soupEntryId+'","RecordCRUD" : "',console.log("Processing rec to syn with soup id = "+k.SOUP_Record_Id),$j.each(i,function(g,i){if(k.Id==i.Id){if("Insert"==k.CRUD_Operation||"InsertDelete"==k.CRUD_Operation){n+="Insert"==k.CRUD_Operation?'I", "fields" : [':'T", "fields" : [';for(var l in i)if("_soupEntryId"!=l&&"_soupLastModifiedDate"!=l){console.log("fieldName",l);var o,p,q="M2P UP None";$j.each(b,function(a,b){return l==b[c]?(console.log("Found field name = "+l),console.log("Null handler column name = "+e),o=b[d],q=b[f],void(p=b[e])):void 0});var r;null===i[l]?r=h(a,l,i,p):(r=i[l],"M2P UP None"==o&&(r=i[l])),"M2P UP Quoted"==q&&(m=new RegExp('"',"g"),r=r.replace(m,'\\"'),r='"'+r+'"'),"string"==typeof r&&(m=new RegExp("\\n","g"),r=r.replace(m,"\\n")),n+='{ "name" : "'+l+'","value" : '+r+"},"}n=n.substring(0,n.length-1)}else{if("Update"!=k.CRUD_Operation&&"Delete"!=k.CRUD_Operation&&"UpdateDelete"!=k.CRUD_Operation)throw"Rec to sync with Id = "+k.Id+" has invalid CRUD Operation = "+k.CRUD_Operation;n+="Update"==k.CRUD_Operation?'U", "fields" : [':"Delete"==k.CRUD_Operation?'D", "fields" : [':'Q", "fields" : [',$j.each(j,function(g,j){if(j.Id==i.Id){var k='{ "name" : "Id", "previousValue" : "'+j.Id+'","value" : "'+j.Id+'"},',l=!1;for(var r in i)if("_soupEntryId"!=r&&"_soupLastModifiedDate"!=r&&i[r]!=j[r]){l=!0,$j.each(b,function(a,b){return r==b[c]?(o=b[d],q=b[f],p=b[e],void console.log("fieldConverter = "+o)):void 0});var s,t;null===i[r]?(s=h(a,r,i,p),t=h(a,r,j,p)):"M2P UP None"==o&&(s=i[r],t=j[r]),"M2P UP Quoted"==q&&(m=new RegExp('"',"g"),null!==s&&(s=s.replace(m,'\\"'),s='"'+s+'"'),null!==t&&(t=t.replace(m,'\\"'),t='"'+t+'"')),"string"==typeof s&&(m=new RegExp("\\n","g"),s=s.replace(m,"\\n")),"string"==typeof t&&(m=new RegExp("\\n","g"),t=t.replace(m,"\\n")),k+='{ "name" : "'+r+'", "previousValue" : '+t+',"value" : '+s+"},"}return void(l&&(k=k.substring(0,k.length-1),n+=k))}})}return n+="]",void(n+="},")}})}),n=n.substring(0,n.length-1),n+="]}",l(n)}function j(a,b,c,d){$j.each(a,function(a,c){c.Current_Connection_Session=b}),console.log("### d2 RTS",a),w.upsertSoupEntriesWithExternalId("recsToSync",a,"Id",c,d)}function k(a,b,c,d,e){var f=[];$j.each(b,function(a,b){var d={};$j.each(c,function(a,c){if(b.Id==c.Id&&"Insert"==b.CRUD_Operation)for(var e in c)"_soupEntryId"!=e&&"_soupLastModifiedDate"!=e&&(d[e]=c[e])}),f.push(d)}),0===f.length?d():w.upsertSoupEntries("SnapShot_"+a,f,d,e)}function l(b,c,d,e){var f=a("mobileCaddy/geolocation"),g={};f.getLocation(function(a){var f={mc_package_002__Session_Type__c:b,mc_package_002__Mobile_Process_Status__c:c,SystemModstamp:(new Date).getTime()},h=a.ErrorNumber;0!==h?f.mc_package_002__Session_Created_Location_Error__c=a.Error:(f.Session_Created_Location__Longitude__s=a.Latitude,f.Session_Created_Location__Latitude__s=a.Longitude),n("Connection_Session__mc",f,function(b){var c="{";
c+='"Sync Session Proxy ID" : null,',c+='"Total Sessions" : 1,',c+='"Session Number" : 1,',c+='"Connection Session Proxy ID" : "'+b.proxyId+'",',0!==h?c+='"ErrorNumber" : '+h+",":(c+='"Location Long" : '+a.Longitude+",",c+='"Location Lat" : '+a.Latitude+",");var e=new Date;c+='"Device Call Date/Time" : '+e.getTime(),c+="}",g.status=0,g.connSessionRec=b.insertedRecord,g.connSessProxyId=b.proxyId,g.connSessJson=c,d(g)},e)},e)}function m(a,b,c,d){var e={};console.debug("In m2pUpdateMobileTable call",a,b),l("Sync - Update","M2P Process Called",function(f){console.log("proxy id = "+f.connSessProxyId);var g=w.buildExactQuerySpec("Mobile_Table_Name",a,mobileCaddy.QUERY_BUFFER_SIZE);t.querySoupRecordsWithQuerySpec("recsToSync",g,function(g){if(0!==g.length){console.debug("recsToSyncRecords",JSON.stringify(g));var h=!1;"Connection_Session__mc"!=a&&g.length>b&&(h=!0),console.log("moreToSync",h);var l=[];h?(l=_.sortBy(g,"_soupLastModifiedDate"),l=l.slice(0,b)):l=g,console.debug("recsToSyncRecords2",JSON.stringify(l)),j(l,f.connSessProxyId,function(b){console.log("### d1 RTS",localStorage.getItem("recsToSync")),t.querySoupRecords(a,function(g){t.querySoupRecords("SnapShot_"+a,function(j){t.getSysDataRowMapColHeadings("Row Mapping TC",["Parent SOUP Name","Table Column Name","M2P Update Converter DEVICE","M2P Update NULL Handler DEVICE","M2P Update Formatter DEVICE"],function(l){var m=l[0],n=l[1],o=l[2],p=l[3],q=l[4];t.queryMobileTableWithAnd("syncLib_system_data","MC_Var_String_001","Platform Table Column",m,a,function(l){i(a,l,n,o,p,q,b,g,j,f.connSessProxyId,function(i){r.getCurrentValueFromAppSoup("audId",function(j){r.getCurrentValueFromAppSoup("syncRefreshVersion",function(l){k(a,b,g,function(){console.log("moreToSync",h);var b=function(b,g){console.debug("result",b),console.debug("event",g),g.status?x.processM2PUpdateResponse(b,function(b){console.debug("responseObject",JSON.stringify(b)),f.connSessionRec.mc_package_002__Mobile_Process_Status__c="Connection_Session__mc"==a?"M2P Conn_Sess Records Processed":"M2P Records Processed",f.connSessionRec.Id=b.csId,x.postProcessConnectionSession(f.connSessionRec,function(){console.log("success return from post process"),console.log("moreToSync",h),h?(e.status=A,e.mc_add_status="more-to-sync",c(e)):x.maybeSyncConnSess(f.connSessionRec,function(){console.log("success return from maybeSyncConnSess"),e.status=A,c(e)},d)},d)},d):"exception"===g.type?(e.status=A,e.mc_add_status=D,c(e),v.error("m2pUpdate",a,g.message,g.where)):(e.status=A,e.mc_add_status=E,c(e),v.error("m2pUpdate",a,g.message,g.where))};i=i.replace(/: undefined/g,': "undefined"'),console.debug("jsonString -> "+i),console.log("### d RTS",localStorage.getItem("recsToSync")),console.log("### d CS",localStorage.getItem("Connection_Session__mc")),console.log("### d SCS",localStorage.getItem("SnapShot_Connection_Session__mc")),USE_FORCETK===!0?force.request({method:"POST",path:"/services/apexrest/mc_package_002/m2pUpdateTable001",contentType:"application/json",data:{audId:j,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:l,mobileTableName:a,jsonRecords:i,connSessJson:f.connSessJson}},function(a,c){"undefined"==typeof c&&(c={},c.status="200"),b(a,c)},d):Visualforce.remoting.Manager.invokeAction("mc_package_002."+mobileCaddy.START_PAGE_CONTROLLER+".m2pUpdateTable",j,l,a,i,f.connSessJson,b,{buffer:!1,escape:!1,timeout:3e4})},d)},d)},d)},d)},d)},d)},d)},d)},d)}else t.setTableDefnColumnValue(a,"Last Sync Date/Time",(new Date).getTime(),function(){e.status=A,e.mc_add_status=B,c(e)},d)},d)},d)}function n(a,b,c,d){var e={},g=new Date;w.upsertSoupEntries(a,[b],function(b){var h=b[0];f(a,h._soupEntryId,g.getTime(),function(b){h.Id=b,_.indexOf(MC_TABLES,a)>-1?h.mc_package_002__MC_Proxy_ID__c=b:h.MC_Proxy_ID__c=b,w.upsertSoupEntries(a,[h],function(a){e.status=0,e.proxyId=b,e.insertedRecord=a[0],c(e)},d)},d)},d)}function o(a){var b={};navigator&&navigator.connection&&"undefined"!=typeof Connection?(console.log("Connection details"),u.logObjectDetails(Connection),navigator.connection.type==Connection.NONE?(b.status=F,a(b)):Visualforce.remoting.Manager.invokeAction("mc_package_002."+mobileCaddy.START_PAGE_CONTROLLER+".heartBeat",function(c,d){d.status?(b.status=C,a(b)):"exception"===d.type?p(function(){u.logMessage("refresh token refreshed in heartbeat"),b.status=H,a(b)},function(){b.status=D,a(b)}):(console.debug("other"),b.status=E,a(b))},{escape:!1,timeout:3e4})):(b.status=localStorage.connection?localStorage.connection:G,a(b))}function p(a,b){r.getCurrentValueFromAppSoup("refreshToken",function(c){r.getCurrentValueFromAppSoup("accessToken",function(d){r.getCurrentValueFromAppSoup("clientId",function(e){r.getCurrentValueFromAppSoup("identityUrl",function(f){q(c,e,d,f,a,b)},function(a){b(a)})},function(a){b(a)})},function(a){b(a)})},function(a){b(a)})}function q(b,c,d,e,f,g){var h=a("mobileCaddy/mobileLogger"),i=(cordova.require("com.salesforce.plugin.smartstore"),"https://mobilecaddy.secure.force.com/apex/ProxyToken"),j="grant_type=refresh_token&identity_url="+e+"&client_id="+c+"&refresh_token="+b;h.logMessage("data: "+j),$j.ajax({type:"POST",url:i,cache:!1,processData:!1,data:j,success:function(a){h.logMessage("Changing vf access token from "+Visualforce.remoting.oauthAccessToken+" to "+a.access_token),Visualforce.remoting.oauthAccessToken=a.access_token,Visualforce.remoting.last.refresh(function(){r.updateCurrentValueInAppSoup("accessToken",a.access_token).then(function(){h.logMessage("Updated accessToken in appSoup"),f(a.access_token)}).catch(function(a){g(a)})},function(a){console.log("in VF last refresh error"),g(a)})},error:function(a){h.logMessage("failed to refresh access token "+JSON.stringify(a)),g(a)},dataType:"json",beforeSend:function(){}})}var r=a("mobileCaddy/appDataUtils"),s=a("mobileCaddy/vsnUtils"),t=a("mobileCaddy/smartStoreUtils"),u=a("mobileCaddy/mobileLogger"),v=a("mobileCaddy/logger"),w=cordova.require("com.salesforce.plugin.smartstore"),x=a("mobileCaddy/connSessUtils"),y=100500,z=100402,A=100300,B=100310,C=100100,D=100101,E=100102,F=100103,G=100104,H=100105;c.exports={refreshToken:function(a,b){p(a,b)},genProxyId:function(a,b,c,d,e){f(a,b,c,d,e)},addProxyIds:function(a,b,c,d,e){g(a,b,c,d,e)},P2M_REFRESH_OK:y,p2mRefreshTable:function(a,b,c,d,f){e(a,b,c,d,f)},buildConnectionSession:function(a,b,c,d){l(a,b,c,d)},M2P_UPDATE_OK:A,M2P_NO_RECS_TO_SYNC:B,m2pUpdateMobileTable:function(a,b,c,d){m(a,b,c,d)},HEARTBEAT_OK:C,HEARTBEAT_EXCEPTION:D,HEARTBEAT_FAILURE:E,HEARTBEAT_NO_CONNECTION:F,HEARTBEAT_NOT_DEVICE:G,HEARTBEAT_REFRESHED_OK:H,heartBeat:function(a,b){o(a,b)},handleRefreshResponse:function(a){return new Promise(function(b,c){d(a,function(){b()},function(a){c(a)})})}}}),b("mobileCaddy/connSessUtils",function(a,b,c){function d(b,c){var d=a("mobileCaddy/smartStoreUtils"),e=100498;d.querySoupRecords("recsToSync",function(a){console.debug("recsToSync -> "+JSON.stringify(a));for(var d=null,f=null,g=0;g<a.length;g++)if(console.debug("recsToSync["+g+"] -> "+JSON.stringify(a[g])),null!==a[g].Current_Connection_Session&&"undefined"!=typeof a[g].Current_Connection_Session){d=a[g].Current_Connection_Session,f=a[g];break}if(null!==d&&"undefined"!=typeof d){var h=(new Date).getTime(),i=f._soupLastModifiedDate+3e4;if(h>i)console.debug("timeNow > timeoutTs",h,i),console.debug("We have a timedout Conn_Sess",d),b(d);else{console.debug("We have a SYNC_ALREADY_IN_PROGRESS",d);var j={};j.status=e,c(j)}}else console.debug("getRTSPendingconnSess - All clear"),b(d)},c)}function e(b,c,d){var e=a("mobileCaddy/syncRefresh"),g=a("mobileCaddy/appDataUtils"),h=a("mobileCaddy/connSessUtils"),i=a("mobileCaddy/smartStoreUtils"),j=a("mobileCaddy/logger"),k=(cordova.require("com.salesforce.plugin.smartstore"),{});console.debug("csStatusCheck -> "+b),e.buildConnectionSession("Status Check","M2P SC Status Check Requested",function(a){e.heartBeat(function(l){l.status==e.HEARTBEAT_OK||l.status==e.HEARTBEAT_NOT_DEVICE||l.status==e.HEARTBEAT_REFRESHED_OK?g.getCurrentValueFromAppSoup("audId",function(e){g.getCurrentValueFromAppSoup("syncRefreshVersion",function(g){var l=function(e,g){if(g.status){console.debug("Parse json status check");var l=$j.parseJSON(e);console.debug("Parse json status check done"),i.queryMobileTable("Connection_Session__mc","mc_package_002__MC_Proxy_ID__c",b,function(e){if(1!=e.length)throw e.length+" connection sessions recs found for existing proxy of "+b+".  Should be 1 !";var g=e[0];"Received Not Processed"==l.cs_fc_sc?n(b,function(){g.mc_package_002__Mobile_Process_Status__c="M2P UP Failed - RTS Cleared",g.mc_package_002__Session_Type__c="Sync Update",g.mc_package_002__Status__c="Closed",g.SystemModstamp=(new Date).getTime(),g.Id=l.cs_fc_sf,h.postProcessConnectionSession(g,function(){a.connSessionRec.mc_package_002__Mobile_Process_Status__c="M2P SC - Status Check Processed",a.connSessionRec.SystemModstamp=(new Date).getTime(),a.connSessionRec.mc_package_002__Status__c="Closed",a.connSessionRec.Id=l.cs_sc_sf,h.postProcessConnectionSession(a.connSessionRec,function(){k.status=s,c(k)},d)},d)},d):"Not Received"==l.cs_fc_sc?n(b,function(){i.deleteRecordsFromSoup([g],"Connection_Session__mc",function(){a.connSessionRec.mc_package_002__Mobile_Process_Status__c="M2P SC - Status Check Processed",a.connSessionRec.SystemModstamp=(new Date).getTime(),a.connSessionRec.mc_package_002__Status__c="Closed",a.connSessionRec.Id=l.cs_sc_sf,a.connSessionRec.mc_package_002__Session_Type__c="Status Check",h.postProcessConnectionSession(a.connSessionRec,function(){k.status=s,c(k)},d)},d)},d):"Received Processed"==l.cs_fc_sc&&f(l.cs_fc_jr,function(){a.connSessionRec.mc_package_002__Mobile_Process_Status__c="M2P UP Received - Records Processed",a.connSessionRec.SystemModstamp=(new Date).getTime(),a.connSessionRec.mc_package_002__Status__c="Closed",a.connSessionRec.Id=l.cs_sc_sf,h.postProcessConnectionSession(a.connSessionRec,function(){k.status=s,c(k)},d)},d)},d)}else h.cleanConnectionSessionVFEvent(g,a,function(a){k.status=s,k.mc_add_status=a.mc_add_status,c(k)},d),j.error("csStatusCheck",g.message,g.where)};USE_FORCETK===!0?force.request({method:"POST",path:"/services/apexrest/mc_package_002/m2pCSStatusCheck001",contentType:"application/json",data:{audId:e,syncRefreshDataVersion:g,statusCheckCSProxyId:b,connSessJson:a.connSessJson,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN}},function(a){console.info("response -> "+JSON.stringify(a));var b={};b.status="200",l(a,b)},function(a){j.error("err -> "+JSON.stringify(a)),d()}):Visualforce.remoting.Manager.invokeAction("mc_package_002."+mobileCaddy.START_PAGE_CONTROLLER+".m2pCSStatusCheck",e,g,b,a.connSessJson,l,{buffer:!1,escape:!1,timeout:3e4})},d)},d):h.cleanConnectionSessionHeartBeat(l,a,function(a){k.status=s,returnObjec.mc_add_status=a.mc_add_status,c(k)},d)},d)},d)}function f(b,c,d){var e=a("mobileCaddy/smartStoreUtils"),f=(cordova.require("com.salesforce.plugin.smartstore"),a("mobileCaddy/mobileLogger")),n=a("mobileCaddy/logger"),o=a("mobileCaddy/vsnUtils"),p=1;console.debug("processM2PUpdateResponse : jsonResponse -> "+JSON.stringify(b)),b=b.replace(/,}/g,"}"),f.logMessage("Parse json processM2PUpdateResponse");var q=$j.parseJSON(b);f.logMessage("Parse json processM2PUpdateResponse done");var r=q.mt,s=void 0!==q.is?q.is:[],t=void 0!==q.id?q.id:[],u=void 0!==q.us?q.us:[],v=void 0!==q.ifmf?q.ifmf:[],w=void 0!==q.ufmf?q.ufmf:[],x=[],y=[],z=[],A=[],B=[],C=[],D=[];if(s=s.concat(t),"undefined"==typeof q.if)inFailureRecs=[];else if("undefined"==typeof q.if.if)inFailureRecs=q.if;else{p=2;var E=q.if.if.map(function(a){var b=void 0!==q.ifbe?q.ifbe:"K";return{pd:a,fbe:b}}),F=q.if.ifv.map(function(a){var b=void 0!==q.ifvbe?q.ifvbe:"K";return{pd:a,fbe:b}}),G=q.if.icv.map(function(a){var b=void 0!==q.icvbe?q.icvbe:"K";return{pd:a,fbe:b}});inFailureRecs=E.concat(F.concat(G))}if("undefined"==typeof q.uf)upFailureRecs=[];else if("undefined"==typeof q.uf.uf)upFailureRecs=q.uf;else{p=2;var H=q.uf.uf.map(function(a){var b=void 0!==q.ufbe?q.ufbe:"K";return{Id:a,fbe:b}}),I=q.uf.usv.map(function(a){var b=void 0!==q.usvbe?q.usvbe:"K";return{Id:a,fbe:b}}),J=q.uf.sdf.map(function(a){var b=void 0!==q.sdfbe?q.sdfbe:"K";return{Id:a,fbe:b}}),K=q.uf.hdf.map(function(a){var b=void 0!==q.hdfbe?q.hdfbe:"K";return{Id:a,fbe:b}}),L=q.uf.ufv.map(function(a){var b=void 0!==q.ufvbe?q.ufvbe:"K";return{Id:a,fbe:b}}),M=q.uf.ucv.map(function(a){var b=void 0!==q.ucvbe?q.ucvbe:"K";return{Id:a,fbe:b}});upFailureRecs=H.concat(I.concat(J.concat(K.concat(L.concat(M)))))}i(r).then(function(a){console.debug("priRecords -> "+JSON.stringify(a)),e.queryMobileTable("recsToSync","Mobile_Table_Name",r,function(b){for(var e in b)if(console.debug("recsToSyncRec[i] = "+JSON.stringify(b[e])),b[e].Current_Connection_Session==q.cp){var f=!1,i={},t={},E="";switch(b[e].CRUD_Operation){case"Insert":case"InsertUpdate":for(var F in s)if(b[e].Id==s[F].pd){if(s[F].crud=b[e].CRUD_Operation,"Insert"==b[e].CRUD_Operation){switch(t=g(s[F],a),q.stbe){case"D":D.push(t);break;default:if("U"==s[F].pc){if(t.Id=s[F].Id,"undefined"!=typeof s[F].an&&(t.Name=s[F].an),"undefined"!=typeof s[F].lu)for(var G in s[F].lu)s[F].lu.hasOwnProperty(G)&&console.debug("prop",G,s[F].lu[G]),t[G]=s[F].lu[G];A.push(t),C.push(t)}}y.push(b[e]._soupEntryId)}else"InsertUpdate"==b[e].CRUD_Operation&&(i=b[e],i.Current_Connection_Session=null,i.CRUD_Operation="Update",x.push(i));f=!0;break}if(!f)for(F in inFailureRecs)if(b[e].Id==inFailureRecs[F].pd){if(inFailureRecs[F].crud=b[e].CRUD_Operation,"Insert"==b[e].CRUD_Operation)switch(E="K",E=1==p?h(0,inFailureRecs[F].FL,q):inFailureRecs[F].fbe){case"K":i=b[e],i.Current_Connection_Session=null,x.push(i);break;case"R":break;default:t=g(inFailureRecs[F],a),D.push(t),y.push(b[e]._soupEntryId)}else"InsertUpdate"==b[e].CRUD_Operation&&(i=b[e],i.Current_Connection_Session=null,i.CRUD_Operation="Insert",x.push(i));f=!0;break}if(!f)for(F in v)if(b[e].Id==v[F].pd){if(v[F].crud=b[e].CRUD_Operation,"Insert"==b[e].CRUD_Operation)switch(v[F].fbe){case"K":i=b[e],i.Current_Connection_Session=null,x.push(i);break;case"R":break;default:t=g(v[F],a),D.push(t),y.push(b[e]._soupEntryId)}else"InsertUpdate"==b[e].CRUD_Operation&&(i=b[e],i.Current_Connection_Session=null,i.CRUD_Operation="Insert",x.push(i));f=!0;break}break;case"Update":case"UpdateUpdate":for(F in u)if(b[e].Id==u[F].Id){if(u[F].crud=b[e].CRUD_Operation,"Update"==b[e].CRUD_Operation){switch(t=g(u[F],a),q.stbe){case"D":D.push(t);break;default:if("M"==u[F].pc&&(t.SystemModstamp=new Date(u[F].sm)),"undefined"!=typeof u[F].lu){console.debug("lu",u[F].lu);for(var G in u[F].lu)u[F].lu.hasOwnProperty(G)&&(t[G]=u[F].lu[G])}z.push(t),B.push(t)}y.push(b[e]._soupEntryId)}else"UpdateUpdate"==b[e].CRUD_Operation&&(i=b[e],i.Current_Connection_Session=null,i.CRUD_Operation="Update",x.push(i));f=!0;break}if(!f)for(F in upFailureRecs)if(b[e].Id==upFailureRecs[F].Id){if("Update"==b[e].CRUD_Operation)switch(E="K",E=1==p?h(1,upFailureRecs[F].FL,q):upFailureRecs[F].fbe){case"K":i=b[e],i.Current_Connection_Session=null,x.push(i);break;case"R":break;default:t=g(upFailureRecs[F],a),D.push(t),y.push(b[e]._soupEntryId)}else"UpdateUpdate"==b[e].CRUD_Operation&&(i=b[e],i.Current_Connection_Session=null,i.CRUD_Operation="Update",x.push(i));f=!0;break}if(!f)for(F in w)if(b[e].Id==w[F].pd){if(w[F].crud=b[e].CRUD_Operation,"Update"==b[e].CRUD_Operation)switch(w[F].fbe){case"K":i=b[e],i.Current_Connection_Session=null,x.push(i);break;case"R":break;default:t=g(w[F],a),D.push(t),y.push(b[e]._soupEntryId)}else"UpdateUpdate"==b[e].CRUD_Operation&&(i=b[e],i.Current_Connection_Session=null,i.CRUD_Operation="Update",x.push(i));f=!0;break}}}j(r,"Id",z).then(function(a){return console.debug("m2pRespUpRecs ("+r+") res -> "+JSON.stringify(a)),_.indexOf(MC_TABLES,r)>-1?j(r,"mc_package_002__MC_Proxy_ID__c",A):j(r,"MC_Proxy_ID__c",A)}).then(function(a){return console.debug("m2pRespUpRecs"+r+") (PROXY KEY) res -> "+JSON.stringify(a)),j("SnapShot_"+r,"Id",B)}).then(function(a){return console.debug("m2pRespUpRecs"+r+") (PROXY KEY) res -> "+JSON.stringify(a)),_.indexOf(MC_TABLES,r)>-1?j("SnapShot_"+r,"mc_package_002__MC_Proxy_ID__c",C):j("SnapShot_"+r,"MC_Proxy_ID__c",C)}).then(function(a){return console.debug("m2pRespUpRecs (SnapShot_"+r+") res -> "+JSON.stringify(a)),m(r,D)}).then(function(a){return console.debug("m2pRespDelRecs res -> "+JSON.stringify(a)),m("SnapShot_"+r,D)}).then(function(a){return console.debug("m2pRespDelRecs (SnapShot_' + mobileTable + ') res -> "+JSON.stringify(a)),l(x)}).then(function(a){return console.debug("m2pRespUpRTSRecs res -> "+JSON.stringify(a)),k(y)}).then(function(a){return console.debug("m2pRespDelRTSRecs res -> "+JSON.stringify(a)),o.checkForMigrateToInfo(q)}).then(function(){var a={};a.status=0,a.csId=q.csId,c(a)}).catch(function(a){n.error("m2pResp error for "+r+" -> "+JSON.stringify(a)),d()})},d)}).catch(function(a){n.error("Err reading table",r),d(a)})}function g(a,b){var c={};return c.Id="Insert"==a.crud?a.pd:a.Id,_.findWhere(b,c)}function h(a,b,c){switch(a){case 0:switch(b){case"DF":return c.ifbe;case"CV":return c.icvbe;case"FV":return c.ifvbe}break;case 1:switch(b){case"DF":return c.ufbe;case"SV":return c.usvbe;case"CV":return c.ucvbe;case"FV":return c.ufvbe;case"SD":return c.sdfbe;case"HD":return c.hdfbe}}}function i(b){var c=a("mobileCaddy/smartStoreUtils");return new Promise(function(a,d){c.querySoupRecords(b,function(b){a(b)},function(a){d(a)})})}function j(a,b,c){var d=cordova.require("com.salesforce.plugin.smartstore");return console.debug("m2pRespUpRecs ("+a+") updateRecs -> "+JSON.stringify(c)),new Promise(function(e,f){c.length>0?d.upsertSoupEntriesWithExternalId(a,c,b,function(a){e(a)},function(a){f(a)}):e("OK")})}function k(a){var b=cordova.require("com.salesforce.plugin.smartstore");return console.debug("m2pRespDelRTSRecs recsToDel -> "+JSON.stringify(a)),new Promise(function(c,d){a.length>0?b.removeFromSoup("recsToSync",a,function(a){c(a)},function(a){d(a)}):c("OK")})}function l(a){var b=cordova.require("com.salesforce.plugin.smartstore");return console.debug("m2pRespUpRTSRecs recsToUp -> "+JSON.stringify(a)),new Promise(function(c,d){a.length>0?b.upsertSoupEntries("recsToSync",a,function(a){c(a)},function(a){d(a)}):c("OK")})}function m(b,c){console.debug("m2pRespDelRecs ("+b+") recsToDel -> "+JSON.stringify(c));var d=a("mobileCaddy/smartStoreUtils");return new Promise(function(a,e){c.length>0?-1==b.indexOf("SnapShot")?d.deleteRecordsFromSoup(c,b,function(b){a(b)},function(a){e(a)}):(console.debug("Deleting from SnapShot ",b),d.deleteRecordsForExternalId(b,c,"Id",function(b){a(b)},function(a){logger.error(a),e(a)})):a("OK")})}function n(b,c,d){var e=a("mobileCaddy/smartStoreUtils"),f=cordova.require("com.salesforce.plugin.smartstore");e.queryMobileTable("recsToSync","Current_Connection_Session",b,function(a){if(0!==a.length){for(var b=0;b<a.length;b++)a[b].Current_Connection_Session=null,"InsertUpdate"==a[b].CRUD_Operation?(a[b].CRUD_Operation="Insert",a[b].Current_Connection_Session=null):"UpdateUpdate"==a[b].CRUD_Operation&&(a[b].CRUD_Operation="Update",a[b].Current_Connection_Session=null);f.upsertSoupEntries("recsToSync",a,c,d)}else c()},d)}function o(b,c,d,e){var f=a("mobileCaddy/syncRefresh"),g={bogus:!0};g.status="exception"===b.type?f.HEARTBEAT_EXCEPTION:f.HEARTBEAT_FAILURE,p(g,c,d,e)}function p(b,c,d,e){console.log("in clean connection session heart beat");var f=(a("mobileCaddy/smartStoreUtils"),a("mobileCaddy/syncRefresh")),g=cordova.require("com.salesforce.plugin.smartstore"),h=a("mobileCaddy/mobileLogger"),i={},j=null;b.status==f.HEARTBEAT_NO_CONNECTION?"Sync - Refresh"==c.connSessionRec.mc_package_002__Session_Type__c?j="P2M RE Heartbeat No Connection":"Status Check"==c.connSessionRec.mc_package_002__Session_Type__c&&(j="M2P SC Heartbeat No Connection"):b.status==f.HEARTBEAT_EXCEPTION?"Sync - Refresh"==c.connSessionRec.mc_package_002__Session_Type__c?j=b.bogus?"P2M RE Exception/Timeout":"P2M RE Heartbeat Exception/Timeout":"Status Check"==c.connSessionRec.mc_package_002__Session_Type__c&&(j=b.bogus?"M2P SC Exception/Timeout":"M2P SC Heartbeat Exception/Timeout"):b.status==f.HEARTBEAT_FAILURE&&("Sync - Refresh"==c.connSessionRec.mc_package_002__Session_Type__c?j=b.bogus?"P2M RE Failure":"P2M RE Hearbeat Failure":"Status Check"==c.connSessionRec.mc_package_002__Session_Type__c&&(j=b.bogus?"M2P SC Failure":"M2P SC Heartbeat Failure")),null!==j?(c.connSessionRec.mc_package_002__Mobile_Process_Status__c=j,c.connSessionRec.SystemModstamp=(new Date).getTime(),c.connSessionRec.mc_package_002__Status__c="Closed",console.log("Upserting connection session"),g.upsertSoupEntries("Connection_Session__mc",[c.connSessionRec],function(){i.status=t,i.mc_add_status=b.status,console.log("### f RTS",localStorage.getItem("recsToSync")),console.log("### f CS",localStorage.getItem("Connection_Session__mc")),console.log("### f SCS",localStorage.getItem("SnapShot_Connection_Session__mc")),d(i)},e)):h.logMessageAndThrow("Unknown status, cannot continue. "+b.status)}function q(b,c,d){var e=mobileCaddy.require("mobileCaddy/devUtils"),f=a("mobileCaddy/smartStoreUtils"),g={};console.debug("maybeSyncConnSess"),f.querySoupRecsPromise("recsToSync").then(function(a){console.debug("Success from readRecords recsToSync -> "+JSON.stringify(a));var f=_.filter(a,function(a){return"undefined"!=typeof a.currentConnectionSession});console.debug("connSessRTS -> "+JSON.stringify(f)),f.length>1||"M2P Conn_Sess Records Processed"!=b.mc_package_002__Mobile_Process_Status__c?e.syncMobileTable("Connection_Session__mc").then(function(a){console.debug("syncMobileTable -> ",JSON.stringify(a)),g.status=0,c(g)}).catch(function(a){logger.error("syncMobileTable ERROR -> ",JSON.stringify(a)),d(a)}):(console.debug("maybeSyncConnSess - not syncing"),g.status=0,c(g))}).catch(function(a){logger.error("querySoupRecsPromise ERROR -> ",JSON.stringify(d)),d(a)})}function r(b,c,d){var e=cordova.require("com.salesforce.plugin.smartstore"),f=a("mobileCaddy/mobileLogger");console.debug("postProcessConnectionSession",JSON.stringify(b)),f.logObjectDetails(b);var g={};e.upsertSoupEntries("Connection_Session__mc",[b],function(a){console.log("success from conn sess upsert"),f.logObjectDetails(a[0]);var h={Id:b.Id,SystemModstamp:b.SystemModstamp-1};for(var i in b)"_soupEntryId"!=i&&"_soupLastModifiedDate"!=i&&"Id"!=i&&"SystemModstamp"!=i&&(h[i]=null);e.upsertSoupEntries("SnapShot_Connection_Session__mc",[h],function(a){console.log("success on snapshot upsert");var b={Mobile_Table_Name:"Connection_Session__mc",CRUD_Operation:"Update",SOUP_Record_Id:a[0]._soupEntryId,Id:a[0].Id,LastModifiedDateTime:a[0].SystemModstamp};e.upsertSoupEntries("recsToSync",[b],function(){console.log("success from upsert of recs to sync"),g.status=0,console.log("### c RTS",localStorage.getItem("recsToSync")),console.log("### c CS",localStorage.getItem("Connection_Session__mc")),console.log("### c SCS",localStorage.getItem("SnapShot_Connection_Session__mc")),c(g)},d)},d)},d)}var s=100200,t=100600;c.exports={getRTSPendingconnSess:function(a,b){d(a,b)},CLEAN_CS_OK:t,cleanConnectionSessionHeartBeat:function(a,b,c,d){p(a,b,c,d)},cleanConnectionSessionVFEvent:function(a,b,c,d){o(a,b,c,d)},CONN_SESS_OK:s,csStatusCheck:function(a,b,c){e(a,b,c)},maybeSyncConnSess:function(a,b,c){q(a,b,c)},processM2PUpdateResponse:function(a,b,c){f(a,b,c)},postProcessConnectionSession:function(a,b,c){r(a,b,c)}}}),b("mobileCaddy/vsnUtils",function(a,b,c){function d(a){return new Promise(function(b,c){null===a?l.listMobileTables(l.ALPHA,function(a){var c=p;_.each(a,function(a){c.push(a),c.push("SnapShot_"+a),localStorage.removeItem("meta-tableDEF-"+a),localStorage.removeItem("meta-tableCRUD-"+a)}),console.debug("allTables",c),b(c)},function(a){c(a)}):b([])})}function e(a,b){return new Promise(function(c,e){d(a,b).then(function(a){return Promise.all(a.map(l.deleteSoup))}).then(function(){c()}).catch(function(a){o.error(a),e(a)})})}function f(){return new Promise(function(a,b){var c="/apex/mc_package_002__MobileCaddyBootstrap001_mc",d={};k.readRecords("appSoup").then(function(a){return a.records.forEach(function(a){d[a.Name]=a.CurrentValue}),console.info("appSoupRecs",JSON.stringify(d)),e(null,["appSoup"])}).then(function(){var e="";console.debug("deletedSoups OK");var f=h();if("codeflow"==f)e=window.location.protocol+"//"+window.location.host+"/www",a("ok");else if("platform"==f)e=window.location.href.substr(0,window.location.href.indexOf("#"));else{var g="";navigator&&navigator.connection&&(g=navigator.connection.type),e=d.instanceUrl+c+"?deviceUuid="+device.uuid+"&deviceName="+device.name+"&deviceCordova="+device.cordova+"&deviceVersion="+device.version+"&deviceModel="+device.model+"&buildName="+d.buildName+"&buildVersion="+d.buildVersion+"&buildOS="+d.buildOS+"&knownAud="+d.audId+"&currentDv="+d.dynVersionNumber+"&orientation="+orientation+"&viewportWidth="+$j(window).width()+"&viewportHeight="+$j(window).height()+"&sessionType=HardReset&connType="+g+"&millsFromEpoch="+(new Date).getTime()}n.updateNewValueInAppSoup("buildStatus","Resetting").then(function(){console.info("AppSoup Updated for reset"),l.deleteSoup("syncLib_system_data").then(function(){console.log("Redirecting to: "+e);try{window.location.href=e}catch(c){o.error("error on redirect",c),b(c)}a()}).catch(function(a){o.error(a)}),a()}).catch(function(a){o.error(a),b(a)})}).catch(function(a){o.error(a),b(a)})})}function g(b){var c=a("mobileCaddy/appDataUtils");return new Promise(function(a,d){null!==b.migrateTo&&"undefined"!=typeof b.migrateTo?c.updateNewValueInAppSoup("dynVersionNumber",b.migrateTo).then(function(){a()}).catch(function(a){o.error(a),d(a)}):a()})}function h(){return"localhost:3030"==window.location.host?"codeflow":"undefined"!=typeof mockStore?"platform":"device"}function i(){return new Promise(function(a,b){var c=mobileCaddy.require("mobileCaddy/smartStoreUtils");c.queryMobileTable("appSoup","Name","dynVersionNumber").then(function(b){a("undefined"!=typeof b[0].NewValue&&b[0].NewValue!=b[0].CurrentValue?!0:!1)}).catch(function(a){o.error(a),b(a)})})}function j(){return new Promise(function(a,b){i().then(function(b){b?m.getRTSPendingconnSess(function(b){return null===b||"undefined"==typeof b?f():void a(!1)},function(){a(!1)}):a(!1)}).catch(function(a){o.error(a),b(a)})})}var k=mobileCaddy.require("mobileCaddy/devUtils"),l=(cordova.require("com.salesforce.plugin.smartstore"),mobileCaddy.require("mobileCaddy/smartStoreUtils")),m=a("mobileCaddy/connSessUtils"),n=a("mobileCaddy/appDataUtils"),o=a("mobileCaddy/logger"),p=["recsToSync"];c.exports={checkForMigrateToInfo:function(a){return g(a)},clearSoups:function(a,b){return e(a,b)},getSoupsToClear:function(a,b){return d(a,b)},hardReset:function(){return f()},upgradeAvailable:function(){return i()},upgradeIfAvailable:function(){return j()}}}),b("mobileCaddy/logger",function(a,b,c){function d(){return new Promise(function(a,b){localStorage.hasLogType?a(localStorage.hasLogType):i.listMobileTableColumns("Mobile_Log__mc",i.FULL,function(b){var c=_.find(b,{path:"mc_package_002__Log_Type__c"});"undefined"==typeof c?(localStorage.setItem("hasLogType","false"),a("false")):(localStorage.setItem("hasLogType","true"),a("true"))},function(a){b(a)})})}function e(){return new Promise(function(a,b){j.getCurrentValueFromAppSoup("audId",function(b){a(b)},function(a){b(a)})})}function f(a,b){return new Promise(function(c,f){if(1==b.length&&(b=b[0]),"object"==typeof b&&(b=JSON.stringify(b)),"string"==typeof b){var g={mc_package_002__Error_Text__c:b,SystemModstamp:(new Date).getTime()};e().then(function(a){return g.mc_package_002__Application_User_Device__c=a,d()}).then(function(b){"true"==b&&(g.mc_package_002__Log_Type__c="D"+a.toString()),i.insertRecords("Mobile_Log__mc",[g],function(){c()},function(a){f(a)})}).catch(function(a){console.error(a),f(err)})}else console.error("Trying to log unsupported type",typeof b),f("Trying to log unsupported type"+typeof b)})}function g(a,b,c){var d=localStorage.getItem("logLevel");if(d="undefined"==typeof d?0:d,d>=a){var e="";if(a>0){var g=c.stack.split("\n")[4];if("undefined"!=typeof g){var h=g.indexOf("at ");e=g.slice(h+2,g.length)}}switch(a){case k:f(a,b),console.error.apply(console,b);break;case l:d>=l&&(f(a,b),console.log.apply(console,b),console.log(e));break;default:d>=m&&(f(a,b),console.log.apply(console,b),console.log(e))}}}function h(){try{throw Error("")}catch(a){return a}}var i=(cordova.require("com.salesforce.plugin.smartstore"),a("mobileCaddy/smartStoreUtils")),j=a("mobileCaddy/appDataUtils"),k=0,l=1,m=2,n=3,o=4;c.exports={debug:function(){return g(o,arguments,h())},error:function(){return g(k,arguments)},info:function(){return g(n,arguments,h())},log:function(){return g(m,arguments,h())},warn:function(){return g(l,arguments,h())}}}),b("mobileCaddy/devUtils",function(a,b,c){function d(a,b,c){return console.time("MC-TIMING checkTableAccess "+a),new Promise(function(d,e){var f=function(b,f){var g=0;switch(b){case K:g=1;break;case L:g=4;break;case M:g=7;break;case N:g=10;break;default:g=0}if("Y"==f.charAt(g))console.timeEnd("MC-TIMING checkTableAccess "+a),d(c);else{var h={};h.status=b+A,h.mc_add_status=a,console.timeEnd("MC-TIMING checkTableAccess "+a),e(h)}};-1==O.indexOf(a)?localStorage["meta-tableCRUD-"+a]?f(b,localStorage["meta-tableCRUD-"+a]):w.getTableDefnColumnValue(a,"Application Record CRUD",function(c){localStorage["meta-tableCRUD-"+a]=c,f(b,c)},function(b){console.timeEnd("MC-TIMING checkTableAccess "+a),console.info("Opps -> "+a),e(b)}):(console.timeEnd("MC-TIMING checkTableAccess "+a),d(c))})}function e(){return new Promise(function(b,c){if(USE_FORCETK===!0){var d=force.getUserId();b("undefined"!=typeof d?d:d)}else{console.log("querying from app soup");var e=a("mobileCaddy/appDataUtils");e.getCurrentValueFromAppSoup("userId",function(a){b(a)},function(a){x.error("getCurrentUserId Error obtaining user ID"),c(a)})}})}function f(a){var b=a.indexOf("@"),c=a.lastIndexOf(".");return 1>b||b+2>c||c+2>=a.length?!1:!0}function g(a,b,c){if("undefined"==typeof a)return!0;switch(b){case Q:for(var d=a.length,e=a.length-1;e>=0;e--){var f=a.charCodeAt(e);f>127&&2047>=f?d++:f>2047&&65535>=f&&(d+=2),f>=56320&&57343>=f&&e--}return c>=d?!0:!1;default:return!0}}function h(a,b,c,d){if("_soupLastModifiedDate"==a)return d;var e=_.findWhere(c,{path:a}),f={};if("undefined"==typeof e)return f.status=b+z,f.mc_add_status=a,f;var g=0;switch(b){case K:g=1;break;case L:g=4;break;case M:g=7;break;default:g=0}if("Y"!=e.crud.charAt(g))return f.status=b+A,f;try{return f.value=k(d,e.appColType,e.platColType),f}catch(h){return f.status=b+C,f.mc_add_status=h+"->"+a,f}}function i(a){return console.time("MC-TIMING listMobileTableColumns "+a),new Promise(function(b,c){localStorage["meta-tableDEF-"+a]?(console.timeEnd("MC-TIMING listMobileTableColumns "+a),b(JSON.parse(localStorage["meta-tableDEF-"+a]))):w.listMobileTableColumns(a,w.FULL,function(c){localStorage["meta-tableDEF-"+a]=JSON.stringify(c),console.timeEnd("MC-TIMING listMobileTableColumns "+a),b(c)},function(b){console.timeEnd("MC-TIMING listMobileTableColumns "+a),c(b)})})}function j(a,b,c){switch(c){case"checkbox":case"Deleted":return"true"===String(a);case"CreatedDate":case"date":case"datetime":case"LastActivtyDate":case"LastModifiedDate":case"LastReferencedDate":case"LastViewedDate":case"SystemModstamp":var d=new Date(a);return d;default:return a}}function k(a,b,c){switch(c){case"autonumber":throw"invalid_autonumber";case"checkbox":case"Deleted":if("boolean"==typeof a||"true"===a||"false"===a)return String(a);throw"invalid_boolean";case"date":if(a instanceof Date)return a.setHours(0),a.setMinutes(0),a.setSeconds(0),a.setMilliseconds(0),a.valueOf();throw"invalid_boolean";case"datetime":if(a instanceof Date)return a.valueOf();throw"invalid_boolean";case"email":if(f(a))return a;throw"invalid_email";case"text_area_rich":if(g(a,Q,32e3))return a;throw"invalid_string_too_long";default:switch(b){case"jsString":if("string"==typeof a)return a;if("number"==typeof a)return a.toString();
throw"invalid_string";case"jsNumber":if("number"==typeof a||null===a)return a;throw"invalid_number";default:return a}}}function l(a,b){return console.time("MC-TIMING tableExists "+a),new Promise(function(c,d){var e={};localStorage["meta-tableCRUD-"+a]?(console.timeEnd("MC-TIMING tableExists "+a),c()):w.listMobileTables(w.ALPHA,function(f){var g=f.concat(O);g.indexOf(a)>=0?(console.timeEnd("MC-TIMING tableExists "+a),c()):(e.status=b+y,e.mc_add_status=a,console.timeEnd("MC-TIMING tableExists "+a),d(e))},function(c){e.status=b+G,e.mc_add_status="Unkonwn error "+c,console.timeEnd("MC-TIMING tableExists "+a),d(e)})})}function m(a,b,c,d,f){return new Promise(function(a){var g={};g.status=c,e().then(function(e){$j.each(d,function(a,d){delete d._soupEntryId,delete d.$$HashKey;for(var i in d)if(d.hasOwnProperty(i)&&i!=b){if(isValidFieldRes=h(i,c,f,d[i]),isValidFieldRes.status==c+z){g.status=isValidFieldRes.status,g.mc_add_status=i;break}if(isValidFieldRes.status==c+C){g.status=isValidFieldRes.status,g.mc_add_status=i;break}if(isValidFieldRes.status==c+A){g.status=isValidFieldRes.status,g.mc_add_status=i;break}if(c==K&&P.indexOf(i)>=0){g.status=c+D,g.mc_add_status=i;break}d[i]=isValidFieldRes.value}if(g.status!=c+z&&g.status!=c+C&&g.status!=c+D){var j=(new Date).getTime();c==K&&(d.CreatedById=e,d.CreatedDate=j),d.SystemModstamp=j,d.LastModifiedDate=j,d.LastModifiedById=e,d.IsDeleted="false",$j.each(f,function(a,b){c==K&&P.indexOf(b.path)<0&&"false"==b.nillable&&(_.has(d,b.path)||(g.status=c+B,g.mc_add_status=b.path)),""!==b.proxyRefField&&"undefined"!=typeof d[b.path]&&d[b.path].length>18&&(d[b.proxyRefField]=d[b.path])})}}),g.records=d,a(g)},function(a){x.error("Error getting userID",JSON.stringify(a))})})}function n(a,b,c){var e,f={};return new Promise(function(g,j){b.length>0?l(a,N).then(function(){return i(a)}).then(function(b){return d(a,N,b)}).then(function(d){var e=new Promise(function(e,f){var g=h(c,N,d);g.status!=N+z?m(a,c,N,b,d).then(function(a){a.status==N?e(a.records):(f(a),x.error(a))}):(f(g),x.error(g))});return e}).then(function(){return w.queryMobileTable(a,c,b[0][c])}).then(function(b){if(0===b.length)f.status=N+B,x.warn("deleteRecord no record found",a),f.mc_add_status="no record found",j(f);else{if(!(b[0].Id.length<19))return e=b,w.querySoupRecsPromise("recsToSync");f.status=N+A,x.warn("deleteRecord Cannot delete synced records"),f.mc_add_status="Cannot delete synced records",j(f)}}).then(function(b){console.debug("tableName",a),console.debug("recsToDelete",e),console.debug("rts recs",b);var c=b.reduce(function(b,c){return c.Mobile_Table_Name==a&&_.findWhere(e,{_soupEntryId:c.SOUP_Record_Id})&&b.push({_soupEntryId:c._soupEntryId}),b},[]);console.debug("rtsRecSoupIds",c),w.deleteRecordsFromSoup(e,a,function(){w.deleteRecordsFromSoup(c,"recsToSync",function(){f.status=N,f.records=e,g(f)},function(a){j(a)})},function(a){j(a)})}).catch(function(a){j(a)}):(f.status=N,x.warn("deleteRecord No records supplied"),f.mc_add_status="No records supplied",f.records=[],g(f))})}function o(){return new Promise(function(a,b){q("recsToSync").then(function(b){var c=[],d=[];b.records.forEach(function(a){"Connection_Session__mc"!=a.Mobile_Table_Name&&"undefined"==typeof c[a.Mobile_Table_Name]&&(c[a.Mobile_Table_Name]=!0,d.push(a.Mobile_Table_Name))}),a(d)}).catch(function(a){x.error(a),b(a)})})}function p(a,b){var c={};return new Promise(function(e,f){l(a,K).then(function(){return i(a)}).then(function(b){return d(a,K,b)}).then(function(c){var d=new Promise(function(d,e){m(a,null,K,b,c).then(function(a){a.status==K?d(a.records):e(a)})});return d}).then(function(b){w.insertRecords(a,b,function(a){c.status=K,c.records=a;var b=mobileCaddy.require("mobileCaddy/vsnUtils");b.upgradeAvailable().then(function(a){c.upgradeAvailable=a,e(c)}).catch(function(a){e(c),x.error(a)})},function(a){f(a),x.error(a)})}).catch(function(a){f(a),x.error(a)})})}function q(a){var b={},c="MC-TIMING readRecords "+a;return console.time(c),new Promise(function(e,f){l(a,L).then(function(){return d(a,L)}).then(function(){return i(a)}).then(function(d){w.querySoupRecords(a,function(a){b.status=L,$j.each(a,function(a,b){for(var c in b){var e=_.findWhere(d,{path:c});"undefined"!=typeof e&&(b[c]=j(b[c],e.appColType,e.platColType))}}),b.records=a.filter(function(a){return"object"==typeof a});var f=mobileCaddy.require("mobileCaddy/vsnUtils");f.upgradeAvailable().then(function(a){b.upgradeAvailable=a,console.timeEnd(c),e(b)}).catch(function(a){console.timeEnd(c),e(b),x.error(a)})},function(a){console.timeEnd(c),f(a),x.error(a)})},function(a){console.timeEnd(c),f(a),x.error(a)})})}function r(a){var b=cordova.require("com.salesforce.plugin.smartstore"),c={},e=b.buildSmartQuerySpec(a),f=/\{(\S*)\}/g,g=f.exec(a);tableName=g[1];var h="MC-TIMING smartRead "+tableName;return console.time(h),new Promise(function(a,b){l(tableName,L).then(function(){return d(tableName,L)}).then(function(){return i(tableName)}).then(function(d){w.smartQuerySoupRecordsWithQuerySpec(e,function(b){c.status=L;var e=[];$j.each(b,function(a,b){var c=b[1];for(var f in c){var g=_.findWhere(d,{path:f});"undefined"!=typeof g&&(c[f]=j(c[f],g.appColType,g.platColType))}e.push(c)}),c.records=e.filter(function(a){return"object"==typeof a});var f=mobileCaddy.require("mobileCaddy/vsnUtils");f.upgradeAvailable().then(function(b){c.upgradeAvailable=b,console.timeEnd(h),a(c)}).catch(function(b){console.timeEnd(h),a(c),x.error(b)})},function(){b()})},function(a){console.timeEnd(h),b(a),x.error(a)})})}function s(b){return new Promise(function(c,d){var e=a("mobileCaddy/syncRefresh"),f=function(a){console.debug("innerProcessRefreshTablePromise res",a),c(a)},g=function(a){x.error("innerProcessRefreshTablePromise error",a),d(a)},h={table:b};e.p2mRefreshTable(b,0,!1,function(a){console.debug("refreshStatusObject",a),a.status==e.P2M_REFRESH_OK?(h.status=I,f(h)):(h.status=a.status,h.mc_add_status=a.mc_add_status,f(h))},g)})}function t(b){return new Promise(function(c,d){var e=[];o().then(function(a){return console.debug("dirtyTableNames",a),a.forEach(function(a){dirtyIndex=b.indexOf(a),dirtyIndex>-1&&(e.push({table:a,status:J,mc_add_status:"Dirty records"}),b.splice(dirtyIndex,1))}),console.debug("tableNames",b),console.debug("resArr",e),Promise.all(b.map(s))}).then(function(b){console.debug("Promise.all res",b);var f=e.concat(b);console.debug("Promise.all resArrFinal",f),c(f);var g=a("mobileCaddy/connSessUtils"),h={mc_package_002__Mobile_Process_Status__c:""};g.maybeSyncConnSess(h,function(){console.log("success return from maybeSyncConnSess")},function(a){d(a),x.error(a)})}).catch(function(a){d(a),x.error(a)})})}function u(b,c,d,e){console.time("syncMobileTable"),c="undefined"!=typeof c?c:!0;var f=a("mobileCaddy/connSessUtils"),g=a("mobileCaddy/syncRefresh"),h=a("mobileCaddy/smartStoreUtils"),i=(a("mobileCaddy/mobileLogger"),50);d||(d=0),e||(e=i);var j=function(a,b,c){var e={};g.p2mRefreshTable(a,d,!0,function(a){console.debug("refreshStatusObject",a),a.status==g.P2M_REFRESH_OK?(e.status=I,b(e)):(e.status=a.status,e.mc_add_status=a.mc_add_status,b(e))},c)},k=function(a,b,c){var f={};h.queryMobileTable("recsToSync","Mobile_Table_Name",a,function(h){h.length>0?g.m2pUpdateMobileTable(a,e,function(e){console.log("m2pStatusObject",e),e.status==g.M2P_UPDATE_OK&&"undefined"==typeof e.mc_add_status?(d=0,f.status=0,b(f)):e.status==g.M2P_UPDATE_OK&&"more-to-sync"===e.mc_add_status?(console.log("moreToSync - Going round again"),k(a,b,c)):(f.status=e.status,f.mc_add_status=e.mc_add_status,b(f))},c):(f.status=2,f.mc_add_status="no-sync-no-updates",b(f))},c)},m=function(a,b,c,d,e){var f={};"Dynamic (Submit First/Retain)"==b||"Dynamic (Submit First/Clear)"==b?k(a,function(b){0===b.status||c&&2==b.status?j(a,d,e):2==b.status?(f.status=I,f.mc_add_status=b.mc_add_status,d(f)):(f.status=J,f.mc_add_status=b.mc_add_status,d(f))},e):"Submit Only"==b||"Submit & Clear"==b||"Submit & Destroy"==b?k(a,function(a){0===a.status?(f.status=I,d(f)):(f.status=J,f.mc_add_status=a.mc_add_status,d(f))},e):x.error("Unknown sync type",b)};return new Promise(function(a,d){var e={},i=function(b){a(b)},k=function(a){d(a)},n="syncTime"+b,o=localStorage.getItem(n),p=(new Date).valueOf(),q=o?parseInt(o)+5e3:0;"Connection_Session__mc"!=b&&q>p?(e.status=I,e.mc_add_status="sync-too-soon",console.timeEnd("syncMobileTable"),a(e)):(localStorage.setItem(n,p),l(b,H).then(function(){g.heartBeat(function(l){console.log("heartbeat call gave "+l.status),l.status==g.HEARTBEAT_OK||l.status==g.HEARTBEAT_NOT_DEVICE||l.status==g.HEARTBEAT_REFRESHED_OK?h.getTableDefnColumnValue(b,"Sync Type",function(g){f.getRTSPendingconnSess(function(h){null!==h&&"undefined"!=typeof h?f.csStatusCheck(h,function(d){d.status==f.CONN_SESS_OK?"Refresh Only"==g||"Refresh & Clear"==g?j(b,i,k):m(b,g,c,i,k):(e.status=I,e.mc_add_status=connSessStatus,console.timeEnd("syncMobileTable"),a(e))},function(a){d(a)}):"Refresh Only"==g||"Refresh & Clear"==g?j(b,i,k):m(b,g,c,i,k)},k)},k):(e.status=J,e.mc_add_status=l.status,console.timeEnd("syncMobileTable"),a(e),100101==e.mc_add_status||100102==e.mc_add_status?x.error(e):x.log(e))},k)}).catch(k))})}function v(a,b,c){var e={};return new Promise(function(f,g){b.length>0?l(a,M).then(function(){return i(a)}).then(function(b){return d(a,M,b)}).then(function(d){var e=new Promise(function(e,f){var g=h(c,M,d);g.status!=M+z?m(a,c,M,b,d).then(function(a){a.status==M?e(a.records):f(a)}):f(g)});return e}).then(function(b){w.updateRecordsWithExternalId(a,b,c,function(a){e.status=M,e.records=a;var b=mobileCaddy.require("mobileCaddy/vsnUtils");b.upgradeAvailable().then(function(a){e.upgradeAvailable=a,f(e)}).catch(function(){f(e)})},function(a){g(a),x.error(a)})},function(a){g(a),x.error(a)}):(e.status=M,e.mc_add_status="No records supplied",e.records=[],f(e),x.warn(e))})}var w=a("mobileCaddy/smartStoreUtils"),x=(a("mobileCaddy/mobileLogger"),a("mobileCaddy/logger")),y=1,z=2,A=3,B=4,C=5,D=6,E=7,F=98,G=99,H=100400,I=H,J=100402,K=100700,L=101e3,M=101100,N=101200,O=["syncLib_system_data","appSoup","cacheSoup","recsToSync","SnapShot_Connection_Session__mc"],P=["autonumber","CreatedById","CreatedDate","IsDeleted","LastModifiedById","LastModifiedDate","LastReferencedDate","mc_package_002__MC_Proxy_ID","MC_Proxy_ID","OwnerId","SystemModstamp","Id"],Q=0;c.exports={SYNC_OK:I,SYNC_NOK:J,SYNC_ALREADY_IN_PROGRESS:H+F,SYNC_UNKONWN_TABLE:H+y,DELETE_RECS_OK:N,DELETE_RECS_UNKONWN_TABLE:N+y,DELETE_RECS_UNKONWN_FIELD:N+z,DELETE_RECS_ACCESS_DENIED:N+A,DELETE_RECS_MANDATORY_MISSING:N+B,INSERT_RECS_OK:K,INSERT_RECS_UNKONWN_TABLE:K+y,INSERT_RECS_UNKONWN_FIELD:K+z,INSERT_RECS_ACCESS_DENIED:K+A,INSERT_RECS_MANDATORY_MISSING:K+B,INSERT_RECS_DATATYPE_MISMATCH:K+C,INSERT_RECS_PROTECTED_FIELD:K+D,READ_RECS_OK:L,READ_RECS_UNKONWN_TABLE:L+y,READ_RECS_ACCESS_DENIED:L+A,UPDATE_RECS_OK:M,UPDATE_RECS_UNKONWN_TABLE:M+y,UPDATE_RECS_UNKONWN_FIELD:M+z,UPDATE_RECS_ACCESS_DENIED:M+A,UPDATE_RECS_DATATYPE_MISMATCH:M+C,UPDATE_RECS_UNKNOWN_ID:M+E,deleteRecord:function(a,b,c){return n(a,[b],c)},dirtyTables:function(){return o()},syncMobileTable:function(a,b,c,d){return u(a,b,c,d)},initialSync:function(a){return t(a)},getCurrentUserId:function(){return e()},insertRecord:function(a,b){return p(a,[b])},insertRecords:function(a,b){return p(a,b)},readRecords:function(a,b){return console.debug("readRecords",a),q(a,b)},smartSql:function(a){return console.debug("smartSql",a),r(a)},updateRecord:function(a,b,c){return v(a,[b],c)},updateRecords:function(a,b,c){return v(a,b,c)},maybeReadTransformType:function(a,b,c){return j(a,b,c)},maybeWriteTransformType:function(a,b,c){return k(a,b,c)}}}),window.mobileCaddy=a("mobileCaddy")}();