/*! mobilecaddy-utils - v0.0.1 - 2014-11-20*/
/* Copyright 2014 MobileCaddy Ltd */
var $j=jQuery.noConflict();!function(){var a,b;!function(){function c(b){var c=b.factory;return b.exports={},delete b.factory,c(a,b.exports,b),b.exports}var d={},e=[],f={};a=function(a){if(d[a]){if(a in f){var b=e.slice(f[a]).join("->")+"->"+a;mobileLogger.logMessageAndThrow("Cycle in require graph: "+b)}}else mobileLogger.logMessageAndThrow("module "+a+" not found");if(d[a].factory)try{return f[a]=e.length,e.push(a),c(d[a])}finally{delete f[a],e.pop()}return d[a].exports},b=function(a,b){d[a]&&mobileLogger.logMessageAndThrow("module "+a+" already defined"),d[a]={id:a,factory:b}},b.remove=function(a){delete d[a]}}(),"object"==typeof module&&"function"==typeof a&&(module.exports.require=a,module.exports.define=b),b("mobileCaddy",function(a,c,d){var e={define:b,require:a,START_PAGE_CONTROLLER:"",QUERY_BUFFER_SIZE:50,INITIAL_APPCACHE_INFO:[]};d.exports=e}),b("mobileCaddy/mobileLogger",function(a,b,c){function d(a){}function e(a){throw d(a),a}function f(a){for(var b in a)d("field:"+b+": has value :"+a[b]+":")}c.exports={logMessageAndThrow:function(a){e(a)},logMessage:function(a){d(a)},logObjectDetails:function(a){f(a)}}}),b("mobileCaddy/geolocation",function(a,b,c){function d(a){var b=[];b.Error="Location information is unavailable.",b.ErrorNumber=2,a(b)}c.exports={getLocation:function(a,b){d(a,b)}}}),b("mobileCaddy/startup",function(a,b,c){function d(a,b){var c=[{path:"Mobile_Table_Name",type:"string"},{path:"SOUP_Record_Id",type:"string"},{path:"Id",type:"string"},{path:"LastModifiedDateTime",type:"integer"},{path:"CRUD_Operation",type:"string"},{path:"Current_Connection_Session",type:"string"}];l.registerSoup("recsToSync",c,a,b)}function e(a){mobileCaddy.INITIAL_APPCACHE_INFO=[],window.applicationCache.addEventListener("checking",function(a){f(a)},!1),window.applicationCache.addEventListener("downloading",function(a){f(a)},!1),window.applicationCache.addEventListener("progress",function(a){f(a)},!1),mobileCaddy.INITIAL_APPCACHE_INFO.push({Name:"AppCache: Initial Status",Description:window.applicationCache.status});var b={};switch(b.status=o,window.applicationCache.status){case window.applicationCache.CHECKING:case window.applicationCache.DOWNLOADING:throw window.applicationCache.addEventListener("updateready",function(b){f(b,a)},!1),window.applicationCache.addEventListener("cached",function(b){f(b,a)},!1),window.applicationCache.addEventListener("error",function(b){f(b,a)},!1),window.applicationCache.addEventListener("noupdate",function(b){f(b,a)},!1),new Error("MobileCaddy - Cache busy.  Will continue when check/load is complete");case window.applicationCache.UPDATEREADY:window.applicationCache.swapCache(),a(b);break;default:a(b)}}function f(a,b){mobileCaddy.INITIAL_APPCACHE_INFO.push("progress"==a.type?{Name:"Event ",Description:a.loaded+" of "+a.total}:{Name:"Event ",Description:a.type});var c={};c.status="udpateready"==a.type||(a.type="cached")?o:p,k.logObjectDetails(c),b&&"function"==typeof b&&b(c)}function g(a){$j(function(){e(function(b){h(a,b)})})}function h(a,b){var c=j("appSoupJson");if(""!==c){k.logMessage("app soup json = "+c);var d=$j.parseJSON(c),e=[{path:"Name",type:"string"},{path:"CurrentValue",type:"string"},{path:"NewValue",type:"string"}];l.registerSoup("appSoup",e,function(){l.upsertSoupEntries("appSoup",d,function(){var c=[{path:"Name",type:"string"},{path:"Description",type:"string"}];l.registerSoup("cacheSoup",c,function(){i(a,b)},function(a){k.logMessage("Failed to create cache soup with error = "+a)})},function(a){k.logMessage("Failed to update app soup with error = "+a)})},function(a){k.logMessage("Failed to register app soup with error = "+a)})}else document.addEventListener("deviceready",function(){i(a,b)},!1),document.addEventListener("backbutton",function(){},!0)}function i(a,b){k.logMessage("cache status = "+b),k.logObjectDetails(b),l.soupExists("appSoup",function(c){c&&l.upsertSoupEntries("cacheSoup",mobileCaddy.INITIAL_APPCACHE_INFO,function(){var c=l.buildExactQuerySpec("Name","buildStatus",mobileCaddy.QUERY_BUFFER_SIZE);n.querySoupRecordsWithQuerySpec("appSoup",c,function(c){if(1!=c.length)throw"Should only be 1 buildStatus entry in the app soup.  Found "+c.length;if("Complete"==c[0].CurrentValue){if(null!==a){k.logMessage("build already complete - calling 3rd party callback function");var e={};e.status=r,e.mc_add_status=b.status,k.logMessage("Calling 3rd party callback"),k.logObjectDetails(e),a(e)}}else{var f=l.buildExactQuerySpec("Name","userOverride",mobileCaddy.QUERY_BUFFER_SIZE);n.querySoupRecordsWithQuerySpec("appSoup",f,function(e){k.logMessage("user override rec count = "+e.length);var f="";1==e.length&&(f=e[0].CurrentValue);var g=l.buildExactQuerySpec("Name","buildVersion",mobileCaddy.QUERY_BUFFER_SIZE);n.querySoupRecordsWithQuerySpec("appSoup",g,function(e){if(1!=e.length)throw"Should be exactly 1 build version entry in the app soup.  Found "+e.length;var g=l.buildExactQuerySpec("Name","buildName",mobileCaddy.QUERY_BUFFER_SIZE);n.querySoupRecordsWithQuerySpec("appSoup",g,function(g){if(1!=g.length)throw"Should be exactly 1 build name entry in the app soup.  Found "+g.length;var h=l.buildExactQuerySpec("Name","buildOS",mobileCaddy.QUERY_BUFFER_SIZE);n.querySoupRecordsWithQuerySpec("appSoup",h,function(h){if(1!=h.length)throw"Should be exactly 1 build OS entry in the app soup.  Found "+h.length;var i=l.buildExactQuerySpec("Name","deviceUuid",mobileCaddy.QUERY_BUFFER_SIZE);n.querySoupRecordsWithQuerySpec("appSoup",i,function(i){if(1!=i.length)throw"Should be exactly 1 deviceUuid entry in the app soup.  Found "+i.length;var j=function(e,f){if(f.status){k.logMessage("Parse json aud"+e);var g=$j.parseJSON(e);k.logMessage("Parse json aud success done"),l.upsertSoupEntries("appSoup",g,function(e){k.logMessage("Upserted rec count = "+e.length),d(function(){m.createSystemDataSoup(function(){n.buildMobileTables(function(){c[0].CurrentValue="Complete",c[0].NewValue="Complete",l.upsertSoupEntries("appSoup",c,function(){if(null!==a){var c={};c.status=q,c.mc_add_status=b.status,k.logMessage("Calling 3rd party callback"),k.logObjectDetails(c),a(c)}},function(a){k.logMessage("From upsert soup records "+a)})},function(a){k.logMessage("Error building mobile tables "+a)})},function(a){k.logMessage("create system data soup returned error"+a)}),k.logMessage("Exiting startup")},function(a){k.logMessage("Error building recs to sync soup "+a)})},function(a){k.logMessage("Failed to update app soup with error = "+a)})}else"exception"===f.type&&alert(f.message)};USE_FORCETK===!0?force.request({method:"POST",path:"/services/apexrest/getAUDInfo001",contentType:"application/json",data:{buildVersion:e[0].CurrentValue,buildName:g[0].CurrentValue,buildOS:h[0].CurrentValue,deviceUuid:i[0].CurrentValue,overrideUserId:f,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN}},function(a){var b={};b.status="200",j(a,b)},function(a){error()}):Visualforce.remoting.Manager.invokeAction(mobileCaddy.START_PAGE_CONTROLLER+".getAudInfo",e[0].CurrentValue,g[0].CurrentValue,h[0].CurrentValue,i[0].CurrentValue,f,j,{escape:!1,timeout:3e4})},function(a){k.logMessage("Error querying device uuid from app soup "+a)})},function(a){k.logMessage("Error querying build OS from app soup "+a)})},function(a){k.logMessage("Error querying build name from app soup "+a)})},function(a){k.logMessage("Error querying build version from app soup "+a)})},function(a){k.logMessage("Error querying app soup for user override "+a)})}},function(a){k.logMessage("Error querying app soup for build status"+a)})},function(){k.logMessage("Failed to update app soup with initial app cache info")})},function(a){k.logMessage("Error in app soup exists check "+a)})}function j(a){if(LOCAL_DEV===!0){var b=[];switch(a){case"appSoupJson":b=[{Name:"buildVersion",CurrentValue:mobileCaddy.START_PAGE_CONTROLLER_VSN},{Name:"buildOS",CurrentValue:mobileCaddy.buildOS},{Name:"buildName",CurrentValue:mobileCaddy.buildName},{Name:"buildStatus",CurrentValue:mobileCaddy.buildStatus},{Name:"deviceUuid",CurrentValue:mobileCaddy.deviceUuid}]}return JSON.stringify(b)}a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var c="[\\?&]"+a+"=([^&#]*)",d=new RegExp(c),e=d.exec(window.location.search);return null===e?"":decodeURIComponent(e[1].replace(/\+/g," "))}var k=a("mobileCaddy/mobileLogger"),l=cordova.require("salesforce/plugin/smartstore"),m=a("mobileCaddy/systemData"),n=a("mobileCaddy/smartStoreUtils"),o=(a("mobileCaddy/appDataUtils"),100900),p=100901,q=100800,r=100801;c.exports={startup:function(a){g(a)}}}),b("mobileCaddy/systemData",function(a,b,c){function d(a,b,c,d){h.logMessage("In populate system data row values");var e=function(a,b){if(b.status){h.logMessage("In remoting callback for getSysDataSoupVariables with record count = "+a.length),h.logMessage("Parse json "+a);var e=$j.parseJSON(a);h.logMessage("Parse json soup field defns done"),j.upsertSoupEntries("syncLib_system_data",e,c,d)}else"exception"===b.type?(alert(b.message),h.logMessage("Exception return from getSystemDataRowValues = "+b.message)):h.logMessage("Unknown return from getSystemDataRowValues = "+b.message)};USE_FORCETK===!0?force.request({method:"POST",path:"/services/apexrest/getSysDataSoupVariables001",contentType:"application/json",data:{audId:a,startPageControllerVersion:i.START_PAGE_CONTROLLER_VSN,systemDataPlatformSupportVersion:b}},function(a){var b={};b.status="200",e(a,b)},d):Visualforce.remoting.Manager.invokeAction(i.START_PAGE_CONTROLLER+".getSysDataSoupVariables",a,b,e,{escape:!1})}function e(a,b){h.logMessage("In createSystemDataSoup"),k.getCurrentValueFromAppSoup("audId",function(c){k.getCurrentValueFromAppSoup("sysDataPlatSupVersion",function(d){h.logMessage("In success callback with aud id = "+c),f(c,d,a,b)},b)},b)}function f(a,b,c,e){h.logMessage("In getSystemDataSoupDefinition with audId = "+a+" and sysDataPlatSupVersion = "+b);var f=function(f,i){if(i.status){h.logMessage("In getSystemDataSoupDefinition callback -> "+f),h.logMessage("Parse json app defns"+f);var k=$j.parseJSON(f);h.logMessage("Parse json app defns done"),$j.each(k,function(a,b){h.logObjectDetails(b)}),j.registerSoup("syncLib_system_data",k,function(){d(a,b,function(){g(a,b,c,e)},e)},e)}else"exception"===i.type?(alert(i.message),h.logMessage("Exception return from getSystemDataSoupDefinition = "+i.message)):h.logMessage("Unknown return from getSystemDataSoupDefinition = "+i.message)};USE_FORCETK===!0?force.request({method:"POST",path:"/services/apexrest/getSystemDataSoupDefinition001",contentType:"application/json",data:{audId:a,startPageControllerVersion:i.START_PAGE_CONTROLLER_VSN,systemDataPlatformSupportVersion:b}},function(a){var b={};b.status="200",f(a,b)},e):Visualforce.remoting.Manager.invokeAction(i.START_PAGE_CONTROLLER+".getSystemDataSoupDefinition",a,b,f,{escape:!1})}function g(a,b,c,d){h.logMessage(i.START_PAGE_CONTROLLER+".getDefsForSObjectMobileTables");var e=function(a,b){if(b.status){h.logMessage("Parse json "+a);var e=$j.parseJSON(a);h.logMessage("Parse json table defns done"),j.upsertSoupEntries("syncLib_system_data",e,function(a){c(a)},function(a){d(a)})}else"exception"===b.type?(alert(b.message),h.logMessage("Exception return from getDefsForSObjectMobileTables = "+b.message)):h.logMessage("Unknown return from getDefsForSObjectMobileTables = "+b.message)};USE_FORCETK===!0?force.request({method:"POST",path:"/services/apexrest/getDefsForSObjectMobileTables001",contentType:"application/json",data:{audId:a,startPageControllerVersion:i.START_PAGE_CONTROLLER_VSN,systemDataPlatformSupportVersion:b}},function(a){var b={};b.status="200",e(a,b)},d):Visualforce.remoting.Manager.invokeAction(i.START_PAGE_CONTROLLER+".getDefsForSObjectMobileTables",a,b,e,{escape:!1,timeout:12e4})}var h=a("mobileCaddy/mobileLogger"),i=a("mobileCaddy"),j=cordova.require("salesforce/plugin/smartstore"),k=(i.require("mobileCaddy/smartStoreUtils"),a("mobileCaddy/appDataUtils"));c.exports={createSystemDataSoup:function(a,b){e(a,b)}}}),b("mobileCaddy/smartStoreUtils",function(a,b,c){function d(a,b,c){A.soupExists(a,function(d){d?A.soupExists("SnapShot_"+a,function(d){d?i("SnapShot_"+a,function(d){v(d,"SnapShot_"+a,function(){i(a,function(d){A.upsertSoupEntries("SnapShot_"+a,d,b,c)},c)},c)},c):z.logMessageAndThrow("SnapShot Table is missing: SnapShot_"+a)},c):z.logMessageAndThrow("Mobile Table is missing"+a)},c)}function e(a,b,c,d,e){if(0===b.length)d();else{var f=[];$j.each(b,function(a,b){f.push(b[c])}),smartStoreUtils.querySoupRecords(a,function(b){var g=[];$j.each(b,function(a,b){-1!=f.indexOf(b[c])&&g.push(b._soupEntryId)}),0===g.length?d():A.removeFromSoup(a,g,d,e)},e)}}function f(a,b){function c(a){$j.each(a.currentPageOrderedEntries,function(a,b){e.push(b)}),a.currentPageIndex<a.totalPages-1?cordova.require("salesforce/plugin/smartstore").moveCursorToNextPage(a,c):cordova.require("salesforce/plugin/smartstore").closeCursor(a,d)}function d(){b(e)}var e=[];c(a)}function g(a,b,c){var d=A.buildExactQuerySpec("Name",a,mobileCaddy.QUERY_BUFFER_SIZE);k("syncLib_system_data",d,function(a){z.logMessage("soup definition rows success callback with rec count = "+a.length);var c=[];$j.each(a,function(a,b){z.logMessage("processing record = "),b.Type!=mobileCaddy.STANDING_DATA_OBJECT&&b.Type!=mobileCaddy.DYNAMIC_DATA_OBJECT?(z.logMessage("Record Match"),c.push(b)):z.logMessage("Record does not match")}),b(c)},c)}function h(a,b){z.logMessage("in getQueryAndSoupDefinition");var c=[],d="Select ";$j.each(a,function(a,b){z.logMessage("soup column defn = "),c.push({path:b.Column_Name,type:b.Column_Type}),0!==b.Column_Name.indexOf("_")&&(d+=b.Column_Name+",")}),d=d.substring(0,d.length-1),d+=" From "+a[0].Name,b(d,c)}function i(a,b,c){var d=A.buildAllQuerySpec("_soupEntryId",null,mobileCaddy.QUERY_BUFFER_SIZE);A.querySoup(a,d,function(a){f(a,function(a){b(a)},c)})}function j(b){a("mobileCaddy/smartStoreUtils");return new Promise(function(a,c){i(b,function(b){a(b.filter(function(a){return"object"==typeof a}))},function(a){c(a)})})}function k(a,b,c,d){A.querySoup(a,b,function(b){f(b,function(b){z.logMessage("Passing records back to callback for soup = "+a+" and rec count = "+b.length),c(b)},d)},d)}function l(a,b,c,d,e){var f=A.buildExactQuerySpec(b,c,mobileCaddy.QUERY_BUFFER_SIZE_SL);k(a,f,function(a){d(a)},e)}function m(a,b,c,d,e,f,g){var h=A.buildExactQuerySpec(b,c,mobileCaddy.QUERY_BUFFER_SIZE_SL);k(a,h,function(a){var b=[];$j.each(a,function(a,c){c[d]==e&&b.push(c)}),f(b)},g)}function n(a,b,c){q("Row Mapping PT","Mobile Table Name",function(d){m("syncLib_system_data","MC_Var_String_001","Platform Table Definition",d,a,function(c){1!=c.length&&z.logMessageAndThrow("Should be exactly 1 table defn row for table: "+a+", but we got "+c.length),b(c[0])},c)},c)}function o(a,b,c,d){n(a,function(a){q("Row Mapping PT",b,function(b){c(a[b])},d)},d)}function p(a,b,c,d,e){n(a,function(a){q("Row Mapping PT",b,function(b){a[b]=c,A.upsertSoupEntries("syncLib_system_data",[a],d,e)},e)},e)}function q(a,b,c,d){m("syncLib_system_data","MC_Var_String_001",a,"MC_Var_String_003",b,function(d){1!=d.length&&($j.each(d,function(a,b){z.logObjectDetails(b)}),z.logMessageAndThrow("Must be exactly 1 Row Mapping Record for Sys Data Row Type = "+a+" and Sys Data Row Value = "+b+" found count = "+d.length)),c(d[0].MC_Var_String_004)},d)}function r(a,b,c,d){var e=A.buildExactQuerySpec("MC_Var_String_001",a,mobileCaddy.QUERY_BUFFER_SIZE_SL);k("syncLib_system_data",e,function(d){var e=[];$j.each(b,function(b,c){var f=!1;if($j.each(d,function(a,b){return b.MC_Var_String_003==c?(e.push(b.MC_Var_String_004),void(f=!0)):void 0}),!f)throw"No mapping found for type = "+a+" and value = "+c}),c(e)},d)}function s(a,b,c){r("Row Mapping PT",["Mobile Table Name","Build Order"],function(d){var e=d[0],f=d[1];l("syncLib_system_data","MC_Var_String_001","Platform Table Definition",function(c){var d=[];a==D?(c.sort(function(a,b){var c=0,d=parseInt(a[f]),e=parseInt(b[f]);return isNaN(d)||isNaN(e)||(c=d-e),c}),$j.each(c,function(a,b){d.push(b[e])}),null!==b&&b(d)):($j.each(c,function(a,b){d.push(b[e])}),a==C&&d.sort(),null!==b&&b(d))},c)},c)}function t(a,b,c,d){r("Row Mapping TC",["Parent SOUP Name","Table Column Name","Mobile Column Type","Application Field CRUD","META isNillable","Platform Column Type","Device Value Type"],function(d){var e=d[0],f=d[1],g=d[2],h=d[3],i=d[4],j=d[5],k=d[6];m("syncLib_system_data","MC_Var_String_001","Platform Table Column",e,a,function(a){var d=[];$j.each(a,function(a,c){b==E?d.push(c[f]):b==G?d.push({path:c[f],type:c[g],crud:c[h],nillable:c[i],platColType:c[j],appColType:c[k]}):(d.push({path:c[f],type:c[g]}),z.logMessage("path = "+c[f]+" and type = "+c[g]))}),c(d)},function(a){z.logMessage("Error retrieving column names = "+a)})},d)}function u(a,b){s(D,function(c){var d=c.length;$j.each(c,function(c,e){t(e,F,function(c){A.registerSoup(e,c,function(){p(e,"SOUP Built Date/Time",(new Date).getTime(),function(){o(e,"Snapshot Data Required",function(f){"Yes"==f?A.registerSoup("SnapShot_"+e,c,function(){p(e,"Snapshot SOUP Built Date/Time",(new Date).getTime(),function(){d--,0===d&&a()},b)},function(a){b(a)}):(d--,0===d&&a())},b)},b)},function(a){b(a)})},b)})},b)}function v(a,b,c,d){if(z.logMessage("In delete recs from soup with rec count = "+a.length),0!==a.length){var e=[];$j.each(a,function(a,b){e.push(b._soupEntryId)}),A.removeFromSoup(b,e,function(a){z.logMessage("Deleted rec(s) - calling callback"),c(a)},d)}else z.logMessage("no recs to delete - calling callback"),c()}function w(b,c,d,e){var f=a("mobileCaddy/syncRefresh");A.upsertSoupEntries(b,c,function(a){var c=(new Date).getTime();f.addProxyIds(b,a,c,function(a){var f=[];$j.each(a,function(a,d){var e={Mobile_Table_Name:b,CRUD_Operation:"Insert",SOUP_Record_Id:d._soupEntryId,Id:d.Id,LastModifiedDateTime:c};f.push(e)}),A.upsertSoupEntriesWithExternalId("recsToSync",f,"Id",d,e)},e)},e)}function x(a,b,c){var d=b.length,e=0;return new Promise(function(f,g){$j.each(b,function(h,i){l(a,c,i[c],function(a){var c=a[0];for(var g in i)c[g]=i[g];b[h]=c,e++,e>=d&&f(b)},function(a){g(a)})})})}function y(b,c,d,e,f){a("mobileCaddy/syncRefresh");x(b,c,d).then(function(a){A.upsertSoupEntriesWithExternalId(b,a,d,function(a){l("recsToSync","Mobile_Table_Name",b,function(c){var d=[];$j.each(a,function(a,e){var f;$j.each(c,function(a,b){return b.Id==e.Id?void(f=b):void 0});var g;"undefined"!=typeof f&&null!==f.Current_Connection_Session?null!==f.Current_Connection_Session?"Insert"==f.CRUD_Operation?g="InsertUpdate":"Update"==f.CRUD_Operation?g="UpdateUpdate":"InsertUpdate"==f.CRUD_Operation?g="InsertUpdate":"UpdateUpdate"==f.CRUD_Operation&&(g="UpdateUpdate"):g=f.CRUD_Operation:g="Update";var h={Mobile_Table_Name:b,SOUP_Record_Id:e._soupEntryId,Id:e.Id,CRUD_Operation:g,LastModifiedDateTime:e.SystemModstamp};d.push(h)}),A.upsertSoupEntriesWithExternalId("recsToSync",d,"Id",e,f)},f)},f)}).catch(function(a){f(a)})}var z=a("mobileCaddy/mobileLogger"),A=cordova.require("salesforce/plugin/smartstore"),B=0,C=1,D=2,E=0,F=1,G=2;c.exports={NONE:B,ALPHA:C,BUILD:D,listMobileTables:function(a,b,c){s(a,b,c)},LIST:E,BUILD_OBJECT:F,FULL:G,listMobileTableColumns:function(a,b,c,d){t(a,b,c,d)},queryMobileTable:function(a,b,c,d,e){l(a,b,c,d,e)},buildMobileTables:function(a,b){u(a,b)},getSysDataRowMapColHeading:function(a,b,c,d){q(a,b,c,d)},getSysDataRowMapColHeadings:function(a,b,c,d){r(a,b,c,d)},getTableDefnColumnValue:function(a,b,c,d){o(a,b,c,d)},setTableDefnColumnValue:function(a,b,c,d,e){p(a,b,c,d,e)},queryMobileTableWithAnd:function(a,b,c,d,e,f,g){m(a,b,c,d,e,f,g)},insertRecords:function(a,b,c,d){w(a,b,c,d)},updateRecordsWithExternalId:function(a,b,c,d,e){y(a,b,c,d,e)},markSoupToSync:function(a,b,c){var d=A.buildExactQuerySpec("Type",mobileCaddy.DYNAMIC_DATA_OBJECT,mobileCaddy.QUERY_BUFFER_SIZE_SL);k("syncLib_system_data",d,b,function(d){for(var e=0;e<d.length;e++)if(d[e].Name==a){d[e].Refresh_Indicator="Once",A.upsertSoupEntries("syncLib_system_data",[d[e]],b,c);break}},c)},emptySoup:function(a,b,c){var d=mobileCaddy.require("mobileCaddy/smartStoreUtils");A.removeSoup(a,function(){d.createSoup(a,b,c)},c)},createSoup:function(a,b,c){g(a,function(d){h(d,function(d,e){A.registerSoup(a,e,function(){b()},c)},c)},c)},querySoupRecords:function(a,b,c){i(a,b,c)},querySoupRecsPromise:function(a){return j(a)},querySoupRecordsWithQuerySpec:function(a,b,c,d){k(a,b,c,d)},compareVersions:function(a,b){var c=cordova.require("salesforce/plugin/smartstore").buildExactQuerySpec("Name",mobileCaddy.VERSION_ID,mobileCaddy.QUERY_BUFFER_SIZE);k("syncLib_system_data",c,function(c){simpleMessageSL("Version in soup = "+c[0].Value),getVersion(function(b){simpleMessageSL("Version in Salesforce = "+b),a()},b)},b)},deleteRecordsForExternalId:function(a,b,c,d,f){e(a,b,c,d,f)},deleteRecordsFromSoup:function(a,b,c,d){v(a,b,c,d)},refreshSnapshot:function(a,b,c){d(a,b,c)}}}),b("mobileCaddy/appDataUtils",function(a,b,c){function d(a,b,c){var d=e.buildExactQuerySpec("Name",a,mobileCaddy.QUERY_BUFFER_SIZE);f.querySoupRecordsWithQuerySpec("appSoup",d,function(a){b(a[0].CurrentValue)},c)}var e=(a("mobileCaddy/mobileLogger"),cordova.require("salesforce/plugin/smartstore")),f=a("mobileCaddy/smartStoreUtils");c.exports={getCurrentValueFromAppSoup:function(a,b,c){d(a,b,c)}}}),b("mobileCaddy/syncRefresh",function(a,b,c){function d(a,b,c){var d={};s.logMessage("Parse json date time");var e=$j.parseJSON(a);s.logMessage("Parse json date time done");var f={},g={},h=e.mt;null===h&&s.logMessageAndThrow("Mobile Table (tag 'mt') empty in p2mRefresh response: "+a);var i=t.buildExactQuerySpec("Mobile_Table_Name",h,mobileCaddy.QUERY_BUFFER_SIZE);r.querySoupRecordsWithQuerySpec("recsToSync",i,function(a){$j.each(a,function(a,b){if("Insert"==b.CRUD_Operation||"InsertUpdate"==b.CRUD_Operation)f[b.Id]=1;else{if("Update"!=b.CRUD_Operation&&"UpdateUpdate"!=b.CRUD_Operation)return void s.logMessageAndThrow("RTS contains record with non support CRUD Operation"+b);g[b.Id]=1}});var i=[],j=[];$j.each(e.records,function(a,b){var c=!0;if(null!==b.recordData.MC_Proxy_ID__c&&f.hasOwnProperty(b.recordData.MC_Proxy_ID__c)&&(c=!1),c&&g.hasOwnProperty(b.recordData.Id)&&(c=!1),c)if("U"==b.RecordCRUD)i.push(b.recordData);else{if("D"!=b.RecordCRUD&&"V"!=b.RecordCRUD)return void s.logMessageAndThrow("Unknown CRUD value = "+b.RecordCRUD);j.push(b.recordData)}});var k=t.buildExactQuerySpec("Mobile_Table_Name",h,mobileCaddy.QUERY_BUFFER_SIZE);r.querySoupRecordsWithQuerySpec("recsToSync",k,function(f){f.length==a.length?r.deleteRecordsForExternalId(h,j,"Id",function(){t.upsertSoupEntriesWithExternalId(h,i,"Id",function(){t.soupExists("SnapShot_"+h,function(a){a?r.deleteRecordsForExternalId("SnapShot_"+h,j,"Id",function(){t.upsertSoupEntriesWithExternalId("SnapShot_"+h,i,"Id",function(){d.status=0,d.cs=e.cs,d.cp=e.cp,d.lastRefreshDatetime=e.lastRefreshDatetime,b(d)},c)},c):(d.status=0,d.lastRefreshDatetime=e.lastRefreshDatetime,d.cs=e.cs,d.cp=e.cp,b(d))},c)},c)},c):(d.status=0,d.mc_add_status=1,d.cs=e.cs,d.cp=e.cp,d.lastRefreshDatetime=e.lastRefreshDatetime,b(d))},c)},c)}function e(a,b,c){var e={};s.logMessage("Refreshing table = "+a),l("Sync - Refresh","P2M RE Process Called",function(f){q.getCurrentValueFromAppSoup("audId",function(g){s.logMessage("Using app data aud id = "+g),q.getCurrentValueFromAppSoup("syncRefreshVersion",function(h){s.logMessage("Using app data syncRefreshVersion = "+h),r.getTableDefnColumnValue(a,"Last Refresh Date/Time",function(i){(null===i||""===i)&&(i=0),s.logMessage("Using lastRefreshDatetime = "+i),r.querySoupRecords(a,function(j){o(function(k){if(k.status==y||k.status==C){var l=[];$j.each(j,function(a,b){l.push(b.Id)}),s.logMessage("Existing refresh id list size = "+j.length);var m="",n=function(g,h){h.status?(s.logMessage("In success callback from remoting 'refreshTable' call"),d(g,function(d){r.setTableDefnColumnValue(a,"Last Refresh Date/Time",d.lastRefreshDatetime,function(){var g="P2M RE Records Processed";"Connection_Session__mc"==a&&(g="P2M Conn_Sess Records Processed"),1==d.mc_add_status&&(g="P2M RE Abandoned"),f.connSessionRec.Mobile_Process_Status__c=g,f.connSessionRec.Id=d.cs,u.postProcessConnectionSession(f.connSessionRec,function(){u.maybeSyncConnSess(f.connSessionRec,function(){e.status=v,b(e)},c)},c)},c)},c)):u.cleanConnectionSessionVFEvent(h,f,function(a){e.status=v,e.mc_add_status=a.mc_add_status,b(e)},c)};USE_FORCETK===!0?force.request({method:"POST",path:"/services/apexrest/p2mRefreshTable001",contentType:"application/json",data:{audId:g,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:h,mobileTableName:a,deviceRefreshIds:l,lastRefreshDateTime:i,thirdPartyJson:m,connSessJson:f.connSessJson}},function(a,b){"undefined"==typeof b&&(b={},b.status="200"),n(a,b)},c):Visualforce.remoting.Manager.invokeAction(mobileCaddy.START_PAGE_CONTROLLER+".p2mRefreshTable",g,h,a,l,i,m,f.connSessJson,n,{escape:!1,timeout:3e4})}else u.cleanConnectionSessionHeartBeat(k,f,function(a){e.status=v,e.mc_add_status=a.mc_add_status,b(e)},c)},c)},c)},c)},c)},c)},c)}function f(a,b,c,d,e){q.getCurrentValueFromAppSoup("audId",function(e){var f="PROXY%"+a+"%"+c+"%"+b+"%"+e;d(f)},e)}function g(a,b,c,d,e){q.getCurrentValueFromAppSoup("audId",function(f){$j.each(b,function(b,d){var e="PROXY%"+a+"%"+c+"%"+d._soupEntryId+"%"+f;d.Id=e,d.MC_Proxy_ID__c=e}),t.upsertSoupEntries(a,b,function(a){d(a)},e)},e)}function h(a,b,c,d){var e;if("Throw Exception"==d)throw"NULL value found for field "+b+" in Mobile Table "+a+" with Id = "+c.Id;return"Return NULL"==d?e="null":"Return Empty String"==d&&(e=""),e}function i(a,b,c,d,e,f,g,i,j,k,l){var m='{ "MobileTable" : "'+a+'",';m+='"connSessProxyId" : "'+k+'",',m+='"records" : [',$j.each(g,function(g,k){m+='{"RTSRowNum" : "'+k._soupEntryId+'","RecordCRUD" : "',$j.each(i,function(g,i){if(k.Id==i.Id){if("Insert"==k.CRUD_Operation||"InsertDelete"==k.CRUD_Operation){m+="Insert"==k.CRUD_Operation?'I", "fields" : [':'T", "fields" : [';for(var l in i)if("_soupEntryId"!=l&&"_soupLastModifiedDate"!=l){var n,o,p="M2P UP None";$j.each(b,function(a,b){return l==b[c]?(n=b[d],p=b[f],void(o=b[e])):void 0});var q;if(null===i[l]?q=h(a,l,i,o):(q=i[l],"M2P UP None"==n&&(q=i[l])),"M2P UP Quoted"==p){var r=new RegExp('"',"g");q=q.replace(r,'\\"'),q='"'+q+'"'}m+='{ "name" : "'+l+'","value" : '+q+"},"}m=m.substring(0,m.length-1)}else{if("Update"!=k.CRUD_Operation&&"Delete"!=k.CRUD_Operation&&"UpdateDelete"!=k.CRUD_Operation)throw"Rec to sync with Id = "+k.Id+" has invalid CRUD Operation = "+k.CRUD_Operation;m+="Update"==k.CRUD_Operation?'U", "fields" : [':"Delete"==k.CRUD_Operation?'D", "fields" : [':'Q", "fields" : [',$j.each(j,function(g,j){if(j.Id==i.Id){var k='{ "name" : "Id", "previousValue" : "'+j.Id+'","value" : "'+j.Id+'"},',l=!1;for(var q in i)if("_soupEntryId"!=q&&"_soupLastModifiedDate"!=q&&i[q]!=j[q]){l=!0,$j.each(b,function(a,b){return q==b[c]?(n=b[d],p=b[f],void(o=b[e])):void 0});var r,s;if(null===i[q]?(r=h(a,q,i,o),s=h(a,q,j,o)):"M2P UP None"==n&&(r=i[q],s=j[q]),"M2P UP Quoted"==p){var t=new RegExp('"',"g");null!==r&&(r=r.replace(t,'\\"'),r='"'+r+'"'),null!==s&&(s=s.replace(t,'\\"'),s='"'+s+'"')}k+='{ "name" : "'+q+'", "previousValue" : '+s+',"value" : '+r+"},"}return void(l&&(k=k.substring(0,k.length-1),m+=k))}})}return m+="]",void(m+="},")}})}),m=m.substring(0,m.length-1),m+="]}",l(m)}function j(a,b,c,d){$j.each(a,function(a,c){c.Current_Connection_Session=b}),t.upsertSoupEntries("recsToSync",a,c,d)}function k(a,b,c,d,e){var f=[];$j.each(b,function(a,b){var d={};$j.each(c,function(a,c){if(b.Id==c.Id&&"Insert"==b.CRUD_Operation)for(var e in c)"_soupEntryId"!=e&&"_soupLastModifiedDate"!=e&&(d[e]=c[e])}),f.push(d)}),0===f.length?d():t.upsertSoupEntries("SnapShot_"+a,f,d,e)}function l(b,c,d,e){var f=a("mobileCaddy/geolocation"),g={};f.getLocation(function(a){var f={Session_Type__c:b,Mobile_Process_Status__c:c,SystemModstamp:(new Date).getTime()},h=a.ErrorNumber;0!==h?f.Session_Created_Location_Error__c=a.Error:(f.Session_Created_Location__Longitude__s=a.Latitude,f.Session_Created_Location__Latitude__s=a.Longitude),n("Connection_Session__mc",f,function(b){var c="{";c+='"Sync Session Proxy ID" : null,',c+='"Total Sessions" : 1,',c+='"Session Number" : 1,',c+='"Connection Session Proxy ID" : "'+b.proxyId+'",',0!==h?c+='"ErrorNumber" : '+h+",":(c+='"Location Long" : '+a.Longitude+",",c+='"Location Lat" : '+a.Latitude+",");var e=new Date;c+='"Device Call Date/Time" : '+e.getTime(),c+="}",g.status=0,g.connSessionRec=b.insertedRecord,g.connSessProxyId=b.proxyId,g.connSessJson=c,d(g)},e)},e)}function m(a,b,c){var d={};l("Sync - Update","M2P RE Process Called",function(e){var f=t.buildExactQuerySpec("Mobile_Table_Name",a,mobileCaddy.QUERY_BUFFER_SIZE);r.querySoupRecordsWithQuerySpec("recsToSync",f,function(f){0!==f.length?j(f,e.connSessProxyId,function(f){r.querySoupRecords(a,function(g){r.querySoupRecords("SnapShot_"+a,function(h){r.getSysDataRowMapColHeadings("Row Mapping TC",["Parent SOUP Name","Table Column Name","M2P Update Converter DEVICE","M2P Update NULL Handler DEVICE","M2P Update Formatter DEVICE"],function(j){var l=j[0],m=j[1],n=j[2],p=j[3],s=j[4];r.queryMobileTableWithAnd("syncLib_system_data","MC_Var_String_001","Platform Table Column",l,a,function(j){i(a,j,m,n,p,s,f,g,h,e.connSessProxyId,function(h){q.getCurrentValueFromAppSoup("audId",function(i){q.getCurrentValueFromAppSoup("syncRefreshVersion",function(j){k(a,f,g,function(){o(function(f){if(f.status==y||f.status==C){var g=function(f,g){g.status?u.processM2PUpdateResponse(f,function(f){e.connSessionRec.Mobile_Process_Status__c="Connection_Session__mc"==a?"M2P Conn_Sess Records Processed":"M2P Records Processed",e.connSessionRec.Id=f.csId,u.postProcessConnectionSession(e.connSessionRec,function(){u.maybeSyncConnSess(e.connSessionRec,function(){d.status=v,b(d)},c)},c)},c):"exception"===g.type?(alert(g.message),d.status=w,d.mc_add_status=z,b(d)):(d.status=w,d.mc_add_status=A,b(d))};h=h.replace(/: undefined/g,': "undefined"'),USE_FORCETK===!0?force.request({method:"POST",path:"/services/apexrest/m2pUpdateTable001",contentType:"application/json",data:{audId:i,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:j,mobileTableName:a,jsonRecords:h,connSessJson:e.connSessJson}},function(a,b){"undefined"==typeof b&&(b={},b.status="200"),g(a,b)},c):Visualforce.remoting.Manager.invokeAction(mobileCaddy.START_PAGE_CONTROLLER+".m2pUpdateTable",i,j,a,h,e.connSessJson,g,{buffer:!1,escape:!1,timeout:3e4})}else d.status=w,d.mc_add_status=f.status,b(d)},c)},c)},c)},c)},c)},c)},c)},c)},c)},c):r.setTableDefnColumnValue(a,"Last Sync Date/Time",(new Date).getTime(),function(){d.status=w,d.mc_add_status=x,b(d)},c)},c)},c)}function n(a,b,c,d){var e={},g=new Date;t.upsertSoupEntries(a,[b],function(b){var h=b[0];f(a,h._soupEntryId,g.getTime(),function(b){h.Id=b,h.MC_Proxy_ID__c=b,t.upsertSoupEntries(a,[h],function(a){e.status=0,e.proxyId=b,e.insertedRecord=a[0],c(e)},d)},d)},d)}function o(a,b){var c={};navigator&&navigator.connection?navigator.connection.type==Connection.NONE?(c.status=B,a(c)):p(function(){Visualforce.remoting.Manager.invokeAction(mobileCaddy.START_PAGE_CONTROLLER+".heartBeat",function(b,d){s.logMessage("In heartbeat return with result = "+b),d.status?(s.logMessage("Success from heartbeat"),c.status=y,a(c)):(s.logMessage("Not success from heartbeat"),"exception"===d.type?(alert("exception return: "+d.message),c.status=z,a(c)):(c.status=A,a(c)))},{escape:!1,timeout:3e4})},b):(c.status=C,a(c))}function p(a,b){var c=document.URL;if(c.indexOf(".my.")>-1||c.indexOf("--")>-1)a();else{var d=cordova.require("salesforce/plugin/oauth");d.getAuthCredentials(function(b){a()},b)}}var q=a("mobileCaddy/appDataUtils"),r=a("mobileCaddy/smartStoreUtils"),s=a("mobileCaddy/mobileLogger"),t=cordova.require("salesforce/plugin/smartstore"),u=a("mobileCaddy/connSessUtils"),v=100500,w=100300,x=100310,y=100100,z=100101,A=100102,B=100103,C=100104;c.exports={genProxyId:function(a,b,c,d,e){f(a,b,c,d,e)},addProxyIds:function(a,b,c,d,e){g(a,b,c,d,e)},P2M_REFRESH_OK:v,p2mRefreshTable:function(a,b,c){e(a,b,c)
},buildConnectionSession:function(a,b,c,d){l(a,b,c,d)},M2P_UPDATE_OK:w,M2P_NO_RECS_TO_SYNC:x,m2pUpdateMobileTable:function(a,b,c){m(a,b,c)},HEARTBEAT_OK:y,HEARTBEAT_EXCEPTION:z,HEARTBEAT_FAILURE:A,HEARTBEAT_NO_CONNECTION:B,HEARTBEAT_NOT_DEVICE:C,heartBeat:function(a,b){o(a,b)}}}),b("mobileCaddy/connSessUtils",function(a,b,c){function d(b,c){var d=a("mobileCaddy/smartStoreUtils"),e=100498;d.querySoupRecords("recsToSync",function(a){for(var d=null,f=null,g=0;g<a.length;g++)if(null!==a[g].Current_Connection_Session){d=a[g].Current_Connection_Session,f=a[g];break}if(null!==d&&"undefined"!=typeof d){var h=(new Date).getTime(),i=f.LastModifiedDateTime+3e4;if(h>i)b(d);else{var j={};j.status=e,c(j)}}else b(d)},c)}function e(b,c,d){var e=a("mobileCaddy/syncRefresh"),g=a("mobileCaddy/appDataUtils"),h=a("mobileCaddy/connSessUtils"),i=a("mobileCaddy/smartStoreUtils"),j=cordova.require("salesforce/plugin/smartstore"),k={};e.buildConnectionSession("Status Check","M2P SC Status Check Requested",function(a){e.heartBeat(function(l){l.status==e.HEARTBEAT_OK||l.status==e.HEARTBEAT_NOT_DEVICE?g.getCurrentValueFromAppSoup("audId",function(e){g.getCurrentValueFromAppSoup("syncRefreshVersion",function(g){Visualforce.remoting.Manager.invokeAction(mobileCaddy.START_PAGE_CONTROLLER+".m2pCSStatusCheck",e,g,b,a.connSessJson,function(e,g){if(g.status){var l=$j.parseJSON(e);i.queryMobileTable("Connection_Session__mc","MC_Proxy_ID__c",b,function(e){if(1!=e.length)throw e.length+" connection sessions recs found for existing proxy of "+b+".  Should be 1 !";var g=e[0];"Received Not Processed"==l.cs_fc_sc?n(b,function(){g.Mobile_Process_Status__c="M2P UP Failed - RTS Cleared",g.Session_Type__c="Sync Update",g.Status__c="Closed",g.SystemModstamp=(new Date).getTime(),g.Id=l.cs_fc_sf,h.postProcessConnectionSession(g,function(){a.connSessionRec.Mobile_Process_Status__c="M2P SC - Status Check Processed",a.connSessionRec.SystemModstamp=(new Date).getTime(),a.connSessionRec.Status__c="Closed",a.connSessionRec.Id=l.cs_sc_sf,h.postProcessConnectionSession(a.connSessionRec,function(){k.status=s,c(k)},d)},d)},d):"Not Received"==l.cs_fc_sc?n(b,function(){g.Mobile_Process_Status__c="M2P UP Not Received - RTS Cleared",g.Session_Type__c="Sync Update",g.Status__c="Closed",g.SystemModstamp=(new Date).getTime();var b={Mobile_Table_Name:"Connection_Session__mc",CRUD_Operation:"Insert",SOUP_Record_Id:g._soupEntryId,Id:g.Id,LastModifiedDateTime:g.SystemModstamp};j.upsertSoupEntries("recsToSync",[b],function(){a.connSessionRec.Mobile_Process_Status__c="M2P SC - Status Check Processed",a.connSessionRec.SystemModstamp=(new Date).getTime(),a.connSessionRec.Status__c="Closed",a.connSessionRec.Id=l.cs_sc_sf,a.connSessionRec.Session_Type__c="Status Check",h.postProcessConnectionSession(a.connSessionRec,function(){k.status=s,c(k)},d)},d)},d):"Received Processed"==l.cs_fc_sc&&f(l.cs_fc_jr,function(){a.connSessionRec.Mobile_Process_Status__c="M2P UP Received - Records Processed",a.connSessionRec.SystemModstamp=(new Date).getTime(),a.connSessionRec.Status__c="Closed",a.connSessionRec.Id=l.cs_sc_sf,h.postProcessConnectionSession(a.connSessionRec,function(){k.status=s,c(k)},d)},d)},d)}else h.cleanConnectionSessionVFEvent(g,a,function(a){k.status=s,k.mc_add_status=a.mc_add_status,c(k)},d)},{buffer:!1,escape:!1,timeout:3e4})},d)},d):h.cleanConnectionSessionHeartBeat(l,a,function(a){k.status=s,returnObjec.mc_add_status=a.mc_add_status,c(k)},d)},d)},d)}function f(b,c,d){var e=a("mobileCaddy/smartStoreUtils"),f=(cordova.require("salesforce/plugin/smartstore"),a("mobileCaddy/mobileLogger"));b=b.replace(/,}/g,"}"),f.logMessage("Parse json processM2PUpdateResponse");var n=$j.parseJSON(b);f.logMessage("Parse json processM2PUpdateResponse done");var o=n.mt,p=void 0!==n.is?n.is:[],q=void 0!==n.us?n.us:[],r=void 0!==n.if?n.if:[],s=void 0!==n.uf?n.uf:[],t=[],u=[],v=[],w=[],x=[],y=[],z=[];i(o).then(function(a){e.queryMobileTable("recsToSync","Mobile_Table_Name",o,function(b){for(var e in b)if(b[e].Current_Connection_Session==n.cp){var f=!1,i={},A={};switch(b[e].CRUD_Operation){case"Insert":case"InsertUpdate":for(var B in p)if(b[e].Id==p[B].pd){if(p[B].crud=b[e].CRUD_Operation,"Insert"==b[e].CRUD_Operation){switch(A=g(p[B],a),n.stbe){case"D":z.push(A);break;default:"U"==p[B].pc&&(A.Id=p[B].Id,"undefined"!=typeof p[B].an&&(A.Name=p[B].an),w.push(A),y.push(A))}u.push(b[e]._soupEntryId)}else"InsertUpdate"==b[e].CRUD_Operation&&(i=b[e],i.Current_Connection_Session=null,i.CRUD_Operation="Update",t.push(i));f=!0;break}if(!f)for(B in r)if(b[e].Id==r[B].pd){if(r[B].crud=b[e].CRUD_Operation,"Insert"==b[e].CRUD_Operation)switch(h(0,r[B].FL,n)){case"K":i=b[e],i.Current_Connection_Session=null,t.push(i);break;case"R":break;default:A=g(r[B],a),z.push(A),u.push(b[e]._soupEntryId)}else"InsertUpdate"==b[e].CRUD_Operation&&(i=b[e],i.Current_Connection_Session=null,i.CRUD_Operation="Insert",t.push(i));f=!0;break}break;case"Update":case"UpdateUpdate":for(B in q)if(b[e].Id==q[B].Id){if(q[B].crud=b[e].CRUD_Operation,"Update"==b[e].CRUD_Operation){switch(A=g(q[B],a),n.stbe){case"D":z.push(A);break;default:"M"==q[B].pc&&(A.SystemModstamp=new Date(q[B].sm),v.push(A),x.push(A))}u.push(b[e]._soupEntryId)}else"UpdateUpdate"==b[e].CRUD_Operation&&(i=b[e],i.Current_Connection_Session=null,i.CRUD_Operation="Update",t.push(i));f=!0;break}if(!f)for(B in s)if(b[e].Id==s[B].Id){if("Update"==b[e].CRUD_Operation)switch(h(1,s[B].FL,n)){case"K":i=b[e],i.Current_Connection_Session=null,t.push(i);break;case"R":break;default:A=g(s[B],a),z.push(A),u.push(b[e]._soupEntryId)}else"UpdateUpdate"==b[e].CRUD_Operation&&(i=b[e],i.Current_Connection_Session=null,i.CRUD_Operation="Update",t.push(i));f=!0;break}}}j(o,"Id",v).then(function(a){return j(o,"MC_Proxy_ID__c",w)}).then(function(a){return j("SnapShot_"+o,"Id",x)}).then(function(a){return j("SnapShot_"+o,"MC_Proxy_ID__c",y)}).then(function(a){return m(o,z)}).then(function(a){return m("SnapShot_"+o,z)}).then(function(a){return l(t)}).then(function(a){return k(u)}).then(function(a){var b={};b.status=0,b.csId=n.csId,c(b)}).catch(function(a){d()})},d)}).catch(function(a){d(a)})}function g(a,b){var c={};return c.Id="Insert"==a.crud?a.pd:a.Id,_.findWhere(b,c)}function h(a,b,c){switch(a){case 0:switch(b){case"DF":return c.ifbe;case"CV":return c.icvbe;case"FV":return c.ifvbe}break;case 1:switch(b){case"DF":return c.ufbe;case"SV":return c.usvbe;case"CV":return c.ucvbe;case"FV":return c.ufvbe;case"SD":return c.sdfbe;case"HD":return c.hdfbe}}}function i(b){var c=a("mobileCaddy/smartStoreUtils");return new Promise(function(a,d){c.querySoupRecords(b,function(b){a(b)},function(a){d(a)})})}function j(a,b,c){var d=cordova.require("salesforce/plugin/smartstore");return new Promise(function(e,f){c.length>0?d.upsertSoupEntriesWithExternalId(a,c,b,function(a){e(a)},function(a){f(a)}):e("OK")})}function k(a){var b=cordova.require("salesforce/plugin/smartstore");return new Promise(function(c,d){a.length>0?b.removeFromSoup("recsToSync",a,function(a){c(a)},function(a){d(a)}):c("OK")})}function l(a){var b=cordova.require("salesforce/plugin/smartstore");return new Promise(function(c,d){a.length>0?b.upsertSoupEntries("recsToSync",a,function(a){c(a)},function(a){d(a)}):c("OK")})}function m(b,c){var d=a("mobileCaddy/smartStoreUtils");return new Promise(function(a,e){c.length>0?d.deleteRecordsFromSoup(c,b,function(b){a(b)},function(a){e(a)}):a("OK")})}function n(b,c,d){var e=a("mobileCaddy/smartStoreUtils"),f=cordova.require("salesforce/plugin/smartstore");e.queryMobileTable("recsToSync","Current_Connection_Session",b,function(a){if(0!==a.length){for(var b=0;b<a.length;b++)a[b].Current_Connection_Session=null,"InsertUpdate"==a[b].CRUD_Operation?(a[b].CRUD_Operation="Insert",a[b].Current_Connection_Session=null):"UpdateUpdate"==a[b].CRUD_Operation&&(a[b].CRUD_Operation="Insert",a[b].Current_Connection_Session=null);f.upsertSoupEntries("recsToSync",a,c,d)}else c()},d)}function o(b,c,d,e){var f=a("mobileCaddy/syncRefresh"),g={bogus:!0};g.status="exception"===b.type?f.HEARTBEAT_EXCEPTION:f.HEARTBEAT_FAILURE,p(g,c,d,e)}function p(b,c,d,e){var f=(a("mobileCaddy/smartStoreUtils"),a("mobileCaddy/syncRefresh")),g=cordova.require("salesforce/plugin/smartstore"),h=a("mobileCaddy/mobileLogger"),i={},j=null;b.status==f.HEARTBEAT_NO_CONNECTION?"Sync - Refresh"==c.connSessionRec.Session_Type__c?j="P2M RE Heartbeat No Connection":"Status Check"==c.connSessionRec.Session_Type__c&&(j="M2P SC Heartbeat No Connection"):b.status==f.HEARTBEAT_EXCEPTION?"Sync - Refresh"==c.connSessionRec.Session_Type__c?j=b.bogus?"P2M RE Exception/Timeout":"P2M RE Heartbeat Exception/Timeout":"Status Check"==c.connSessionRec.Session_Type__c&&(j=b.bogus?"M2P SC Exception/Timeout":"M2P SC Heartbeat Exception/Timeout"):b.status==f.HEARTBEAT_FAILURE&&("Sync - Refresh"==c.connSessionRec.Session_Type__c?j=b.bogus?"P2M RE Failure":"P2M RE Hearbeat Failure":"Status Check"==c.connSessionRec.Session_Type__c&&(j=b.bogus?"M2P SC Failure":"M2P SC Heartbeat Failure")),null!==j?(c.connSessionRec.Mobile_Process_Status__c=j,c.connSessionRec.SystemModstamp=(new Date).getTime(),c.connSessionRec.Status__c="Closed",g.upsertSoupEntries("Connection_Session__mc",[c.connSessionRec],function(){i.status=t,i.mc_add_status=b.status,d(i)},e)):h.logMessageAndThrow("Unknown status, cannot continue. "+b.status)}function q(b,c,d){var e=mobileCaddy.require("mobileCaddy/devUtils"),f=a("mobileCaddy/smartStoreUtils"),g={};f.querySoupRecsPromise("recsToSync").then(function(a){a.length>1||"M2P Conn_Sess Records Processed"!=b.Mobile_Process_Status__c?e.syncMobileTable("Connection_Session__mc").then(function(a){g.status=0,c(g)}).catch(function(a){d(a)}):(g.status=0,c(g))}).catch(function(a){d(a)})}function r(b,c,d){var e=cordova.require("salesforce/plugin/smartstore"),f=a("mobileCaddy/mobileLogger");f.logObjectDetails(b);var g={};e.upsertSoupEntries("Connection_Session__mc",[b],function(a){f.logObjectDetails(a[0]);var h={Id:b.Id,SystemModstamp:b.SystemModstamp-1};for(var i in b)"_soupEntryId"!=i&&"_soupLastModifiedDate"!=i&&"Id"!=i&&"SystemModstamp"!=i&&(h[i]=null);e.upsertSoupEntries("SnapShot_Connection_Session__mc",[h],function(a){var b={Mobile_Table_Name:"Connection_Session__mc",CRUD_Operation:"Update",SOUP_Record_Id:a[0]._soupEntryId,Id:a[0].Id,LastModifiedDateTime:a[0].SystemModstamp};e.upsertSoupEntries("recsToSync",[b],function(){g.status=0,c(g)},d)},d)},d)}var s=100200,t=100600;c.exports={getRTSPendingconnSess:function(a,b){d(a,b)},CLEAN_CS_OK:t,cleanConnectionSessionHeartBeat:function(a,b,c,d){p(a,b,c,d)},cleanConnectionSessionVFEvent:function(a,b,c,d){o(a,b,c,d)},CONN_SESS_OK:s,csStatusCheck:function(a,b,c){e(a,b,c)},maybeSyncConnSess:function(a,b,c){q(a,b,c)},processM2PUpdateResponse:function(a,b,c){f(a,b,c)},postProcessConnectionSession:function(a,b,c){r(a,b,c)}}}),b("mobileCaddy/devUtils",function(a,b,c){function d(a,b,c){return new Promise(function(d,e){-1==F.indexOf(a)?r.getTableDefnColumnValue(a,"Application Record CRUD",function(f){var g=0;switch(b){case C:g=1;break;case D:g=4;break;case E:g=7;break;default:g=0}if("Y"==f.charAt(g))d(c);else{var h={};h.status=b+u,h.mc_add_status=a,e(h)}},function(a){e(a)}):d(c)})}function e(){return new Promise(function(b){if(USE_FORCETK===!0){var c=force.getUserId();b("undefined"!=typeof c?c:c)}else{var d=a("mobileCaddy/appDataUtils");d.getCurrentValueFromAppSoup("userId",function(a){b(a)},function(a){b("Dummy",a)})}})}function f(a){var b=a.indexOf("@"),c=a.lastIndexOf(".");return 1>b||b+2>c||c+2>=a.length?!1:!0}function g(a,b,c){if("undefined"==typeof a)return!0;switch(b){case H:for(var d=a.length,e=a.length-1;e>=0;e--){var f=a.charCodeAt(e);f>127&&2047>=f?d++:f>2047&&65535>=f&&(d+=2),f>=56320&&57343>=f&&e--}return c>=d?!0:!1;default:return!0}}function h(a,b,c,d){if("_soupLastModifiedDate"==a)return d;var e=_.findWhere(c,{path:a}),f={};if("undefined"==typeof e)return f.status=b+t,f.mc_add_status=a,f;try{return f.value=k(d,e.appColType,e.platColType),f}catch(g){return f.status=b+w,f.mc_add_status=g+"->"+a,f}}function i(a){return new Promise(function(b,c){r.listMobileTableColumns(a,r.FULL,function(a){b(a)},function(a){c(a)})})}function j(a,b,c){switch(c){case"checkbox":case"Deleted":return"true"===String(a);case"CreatedDate":case"date":case"datetime":case"LastActivtyDate":case"LastModifiedDate":case"LastReferencedDate":case"LastViewedDate":case"SystemModstamp":var d=new Date(a);return d;default:return a}}function k(a,b,c){switch(c){case"autonumber":throw"invalid_autonumber";case"checkbox":case"Deleted":if("boolean"==typeof a||"true"===a||"false"===a)return String(a);throw"invalid_boolean";case"date":if(a instanceof Date)return a.setHours(0),a.setMinutes(0),a.setSeconds(0),a.setMilliseconds(0),a.valueOf();throw"invalid_boolean";case"datetime":if(a instanceof Date)return a.valueOf();throw"invalid_boolean";case"email":if(f(a))return a;throw"invalid_email";case"text_area_rich":if(g(a,H,32e3))return a;throw"invalid_string_too_long";default:switch(b){case"jsString":if("string"==typeof a)return a;throw"invalid_string";case"jsNumber":if("number"==typeof a||null===a)return a;throw"invalid_number";default:return a}}}function l(a,b){return new Promise(function(c,d){var e={};r.listMobileTables(r.ALPHA,function(f){var g=f.concat(F);g.indexOf(a)>=0?c():(e.status=b+s,e.mc_add_status=a,d(e))},function(a){e.status=b+z,e.mc_add_status="Unkonwn error "+a,d(e)})})}function m(a,b,c,d){return new Promise(function(a){var f={};f.status=b,e().then(function(e){$j.each(c,function(a,c){delete c._soupEntryId,delete c.$$HashKey;for(var g in c)if(c.hasOwnProperty(g)){if(isValidFieldRes=h(g,b,d,c[g]),isValidFieldRes.status==b+t){f.status=isValidFieldRes.status,f.mc_add_status=g;break}if(isValidFieldRes.status==b+w){f.status=isValidFieldRes.status,f.mc_add_status=g;break}if(b==C&&G.indexOf(g)>=0){f.status=b+x,f.mc_add_status=g;break}c[g]=isValidFieldRes.value}if(f.status!=b+t&&f.status!=b+w&&f.status!=b+x){var i=(new Date).getTime();b==C&&(c.CreatedById=e),c.SystemModstamp=i,c.CreatedDate=i,c.LastModifiedDate=i,c.LastReferencedDate=i,c.LastModifiedById=e,c.IsDeleted="false",$j.each(d,function(a,d){G.indexOf(d.path)<0&&"false"==d.nillable&&(_.has(c,d.path)||(f.status=b+v,f.mc_add_status=d.path))})}}),f.records=c,a(f)},function(a){})})}function n(a,b){var c={};return new Promise(function(e,f){l(a,C).then(function(){return i(a)}).then(function(b){return d(a,C,b)}).then(function(c){var d=new Promise(function(d,e){m(a,C,b,c).then(function(a){a.status==C?d(a.records):e(a)})});return d}).then(function(b){r.insertRecords(a,b,function(a){c.status=C,c.records=a,e(c)},function(a){f(a)})}).catch(function(a){f(a)})})}function o(a){var b={};return new Promise(function(c,e){l(a,D).then(function(){return d(a,D)}).then(function(){return i(a)}).then(function(d){r.querySoupRecords(a,function(a){b.status=D,$j.each(a,function(a,b){for(var c in b){var e=_.findWhere(d,{path:c});"undefined"!=typeof e&&(b[c]=j(b[c],e.appColType,e.platColType))}}),b.records=a.filter(function(a){return"object"==typeof a}),c(b)},function(a){e(a)})},function(a){e(a)})})}function p(b){var c=a("mobileCaddy/connSessUtils"),d=a("mobileCaddy/syncRefresh"),e=a("mobileCaddy/smartStoreUtils"),f=a("mobileCaddy/mobileLogger"),g=function(a,b,c){var e={};d.p2mRefreshTable(a,function(a){a.status==d.P2M_REFRESH_OK?(e.status=B,b(e)):(e.status=B,e.mc_add_status=a.status,b(e))},c)},h=function(a,b,c){var f={};e.queryMobileTable("recsToSync","Mobile_Table_Name",a,function(e){e.length>0?d.m2pUpdateMobileTable(a,function(a){a.status==d.M2P_UPDATE_OK&&"undefined"==typeof a.mc_add_status?(f.status=0,b(f)):(f.status=1,f.mc_add_status=a.status,b(f))},c):(f.status=0,b(f))},c)},i=function(a,b,c,d){var e={};"Dynamic (Submit First/Retain)"==b||"Dynamic (Submit First/Clear)"==b?h(a,function(b){0===b.status?g(a,c,d):(e.status=B,e.mc_add_status=b.mc_add_status,c(e))},d):"Submit Only"==b||"Submit & Clear"==b||"Submit & Destroy"==b?h(a,function(a){0===a.status?(e.status=B,c(e)):(e.status=B,e.mc_add_status=a.mc_add_status,c(e))},d):f.logMessage("Unknown sync type = "+b)};return new Promise(function(a,f){var h={},j=function(b){a(b)},k=function(a){f(a)};l(b,A).then(function(){e.getTableDefnColumnValue(b,"Sync Type",function(e){"Refresh Only"==e||"Refresh & Clear"==e?g(b,j,k):c.getRTSPendingconnSess(function(g){d.heartBeat(function(l){l.status==d.HEARTBEAT_OK||l.status==d.HEARTBEAT_NOT_DEVICE?null!==g&&"undefined"!=typeof g?c.csStatusCheck(g,function(d){d.status==c.CONN_SESS_OK?i(b,e,j,k):(h.status=B,h.mc_add_status=connSessStatus,a(h))},function(a){f(a)}):i(b,e,j,k):(h.status=B,h.mc_add_status=l.status,a(h))},k)},k)},k)}).catch(k)})}function q(a,b,c){var e={};return new Promise(function(f,g){l(a,E).then(function(){return i(a)}).then(function(b){return d(a,E,b)}).then(function(d){var e=new Promise(function(e,f){var g=h(c,E,d);g.status!=E+t?m(a,E,b,d).then(function(a){a.status==E?e(a.records):f(a)}):f(g)});return e}).then(function(b){r.updateRecordsWithExternalId(a,b,c,function(a){e.status=E,e.records=a,f(e)},function(a){g(a)})},function(a){g(a)})})}var r=a("mobileCaddy/smartStoreUtils"),s=(a("mobileCaddy/mobileLogger"),1),t=2,u=3,v=4,w=5,x=6,y=98,z=99,A=100400,B=A,C=100700,D=101e3,E=101100,F=["syncLib_system_data","appSoup","cacheSoup","recsToSync","SnapShot_Connection_Session__mc"],G=["autonumber","CreatedById","CreatedDate","IsDeleted","LastModifiedById","LastModifiedDate","LastReferencedDate","MC_Proxy_ID","OwnerId","SystemModstamp","Id"],H=0;c.exports={SYNC_OK:B,SYNC_ALREADY_IN_PROCESS:A+y,SYNC_UNKONWN_TABLE:A+s,INSERT_RECS_OK:C,INSERT_RECS_UNKONWN_TABLE:C+s,INSERT_RECS_UNKONWN_FIELD:C+t,INSERT_RECS_ACCESS_DENIED:C+u,INSERT_RECS_MANDATORY_MISSING:C+v,INSERT_RECS_DATATYPE_MISMATCH:C+w,INSERT_RECS_PROTECTED_FIELD:C+x,READ_RECS_OK:D,READ_RECS_UNKONWN_TABLE:D+s,READ_RECS_ACCESS_DENIED:D+u,UPDATE_RECS_OK:E,UPDATE_RECS_UNKONWN_TABLE:E+s,UPDATE_RECS_UNKONWN_FIELD:E+t,UPDATE_RECS_ACCESS_DENIED:E+u,UPDATE_RECS_DATATYPE_MISMATCH:E+w,syncMobileTable:function(a){return p(a)},insertRecord:function(a,b){return n(a,[b])},insertRecords:function(a,b){return n(a,b)},readRecords:function(a,b){return o(a,b)},updateRecord:function(a,b,c){return q(a,[b],c)},updateRecords:function(a,b,c){return q(a,b,c)},maybeReadTransformType:function(a,b,c){return j(a,b,c)},maybeWriteTransformType:function(a,b,c){return k(a,b,c)}}}),window.mobileCaddy=a("mobileCaddy")}();