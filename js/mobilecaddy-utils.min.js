/*! mobilecaddy-utils - v1.9.7 - Bundle Time: 2024-07-22 14:44:58 */
/* git info: "2023-11-24 09:49:15 +0000": 1fbb4310354d957164d0ed4e6a9d01eafb3d52fa (wip-v1-9-6) */
/* Copyright 2024 MobileCaddy Ltd */

String.prototype.includes||(String.prototype.includes=function(e,n){"use strict";return"number"!=typeof n&&(n=0),!(n+e.length>this.length)&&-1!==this.indexOf(e,n)}),Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(e){if(null==this)throw new TypeError('"this" is null or not defined');var n=Object(this),o=n.length>>>0;if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var t=arguments[1],r=0;r<o;){var s=n[r];if(e.call(t,s,r,n))return s;r++}},configurable:!0,writable:!0});var $j=jQuery.noConflict(),MC_TABLES=["Connection_Session__mc","Mobile_Log__mc","MC_Project__ap","MC_Time_Expense__ap","MC_Project_Location__ap"];!function(){var r,s,a,i,c;a={},i=[],c={},r=function(e){if(a[e]){if(e in c){var n=i.slice(c[e]).join("->")+"->"+e;console.error("Cycle in require graph: "+n)}}else console.error("module "+e+" not found");if(a[e].factory)try{return c[e]=i.length,i.push(e),o=a[e],t=o.factory,o.exports={},delete o.factory,t(r,o.exports,o),o.exports}finally{delete c[e],i.pop()}var o,t;return a[e].exports},(s=function(e,n){a[e]&&console.error("module "+e+" already defined"),a[e]={id:e,factory:n}}).remove=function(e){delete a[e]},"object"==typeof module&&"function"==typeof r&&(module.exports.require=r,module.exports.define=s),s("mobileCaddy",function(e,n,o){var t={define:s,require:e,START_PAGE_CONTROLLER:"",QUERY_BUFFER_SIZE:1e3,QUERY_BUFFER_SIZE_SL:1e3,INITIAL_APPCACHE_INFO:[]};o.exports=t}),s("mobileCaddy/mobileLogger",function(e,n,o){function t(){try{throw Error("")}catch(e){return e}}function r(e,n){var o=n.stack.split("\n")[4],t="";if(void 0!==o){var r=o.indexOf("at ");t=o.slice(r+2,o.length)}console.log(e,t)}o.exports={logMessageAndThrow:function(e){!function(e,n){throw r(e,n),e}(e,t())},logMessage:function(e){r(e,t())},logObjectDetails:function(e){!function(e,n){for(var o in e)r("field:"+o+": has value :"+e[o]+":",n)}(e,t())}}}),s("mobileCaddy/geolocation",function(e,n,o){o.exports={getLocation:function(e,n){var o,t;o=e,(t=[]).Error="Location information is unavailable.",t.ErrorNumber=2,o(t)}}}),s("mobileCaddy/startup",function(r,e,n){var u=r("mobileCaddy/mobileLogger"),l=(r("mobileCaddy/logger"),cordova.require("com.salesforce.plugin.smartstore")),d=r("mobileCaddy/systemData"),f=r("mobileCaddy/smartStoreUtils");r("mobileCaddy/appDataUtils");console.log("Startup error listener"),window.addEventListener("error",function(e){var n=e.error?e.error.stack:null,o=e.error.toString();n&&(o+="\n"+n),console.log("Error event listener fired",JSON.stringify(o))});var t=100900,s=100901;function o(e,n){"progress"==e.type?(console.log("cache in progress"),mobileCaddy.INITIAL_APPCACHE_INFO.push({Name:"Event ",Description:e.loaded+" of "+e.total})):mobileCaddy.INITIAL_APPCACHE_INFO.push({Name:"Event ",Description:e.type});var o={};"udpateready"==e.type||(e.type="cached")?(console.log("cache in update ready or cached"),o.status=t):(console.log("cache in else"),o.status=s),console.log("return object "),u.logObjectDetails(o),n&&"function"==typeof n&&n(o)}function a(n){$j(function(){!function(n){var e;if(mobileCaddy.INITIAL_APPCACHE_INFO=[],console.log("checkCache entry"),window.applicationCache)switch(window.applicationCache.addEventListener("checking",function(e){o(e)},!1),window.applicationCache.addEventListener("downloading",function(e){o(e)},!1),window.applicationCache.addEventListener("progress",function(e){o(e)},!1),mobileCaddy.INITIAL_APPCACHE_INFO.push({Name:"AppCache: Initial Status",Description:window.applicationCache.status}),(e={}).status=t,window.applicationCache.status){case window.applicationCache.CHECKING:case window.applicationCache.DOWNLOADING:throw window.applicationCache.addEventListener("updateready",function(e){o(e,n)},!1),window.applicationCache.addEventListener("cached",function(e){o(e,n)},!1),window.applicationCache.addEventListener("error",function(e){o(e,n)},!1),window.applicationCache.addEventListener("noupdate",function(e){o(e,n)},!1),new Error("MobileCaddy - Cache busy.  Will continue when check/load is complete");case window.applicationCache.UPDATEREADY:window.applicationCache.swapCache(),n(e),console.log("cache in updateready");break;default:console.log("cache in default"),n(e)}else(e={}).status=t,n(e)}(function(e){!function(a,i){console.log("prep platform cache status = "+i);var e=S("appSoupJson");if(""!==e){console.log("app soup json = "+JSON.stringify(e));var n=$j.parseJSON(e);l.registerSoup("appSoup",[{path:"Name",type:"string"},{path:"CurrentValue",type:"string"},{path:"NewValue",type:"string"}],function(){l.upsertSoupEntries("appSoup",n,function(e){l.registerSoup("cacheSoup",[{path:"Name",type:"string"},{path:"Description",type:"string"}],function(){c(a,i)},function(e){u.logMessage("Failed to create cache soup with error = "+e)})},function(e){u.logMessage("Failed to update app soup with error = "+e)})},function(e){u.logMessage("Failed to register app soup with error = "+e)})}else console.log("app soup json2 = "+e),LOCAL_DEV?(cacheSoupStructure=[{path:"Name",type:"string"},{path:"Description",type:"string"}],l.registerSoup("cacheSoup",cacheSoupStructure,function(){c(a,i)})):navigator.appVersion.includes("Electron")?l.soupExists("appSoup",function(e){if(e)c(a,i);else{var n=[],o=ipcRenderer.sendSync("request-creds","");console.log("creds",o);S("access_token","?"+o);if(n.push({Name:"accessToken",CurrentValue:S("access_token","?"+o),NewValue:null}),n.push({Name:"refreshToken",CurrentValue:S("refresh_token","?"+o),NewValue:null}),n.push({Name:"clientId",CurrentValue:S("client_id","?"+o),NewValue:null}),n.push({Name:"orgId",CurrentValue:S("org_id","?"+o),NewValue:null}),n.push({Name:"applicationName",CurrentValue:S("buildName","?"+o),NewValue:null}),n.push({Name:"buildName",CurrentValue:S("buildName","?"+o),NewValue:null}),window.location.pathname.startsWith("/apex/"))n.push({Name:"loginUrl",CurrentValue:window.location.protocol+"//"+window.location.host,NewValue:null});else{var t=window.location.pathname.split("/"),r=t[1];n.push({Name:"loginUrl",CurrentValue:window.location.protocol+"//"+window.location.host+"/"+r,NewValue:null})}var s=ipcRenderer.sendSync("request-device-info","");console.log("Device from Electron",JSON.stringify(s)),n.push({Name:"buildStatus",CurrentValue:"Initial"}),n.push({Name:"buildVersion",CurrentValue:s.buildVersion}),n.push({Name:"buildOS",CurrentValue:s.platform}),n.push({Name:"deviceUuid",CurrentValue:s.uuid});l.registerSoup("appSoup",[{path:"Name",type:"string"},{path:"CurrentValue",type:"string"},{path:"NewValue",type:"string"}],function(){l.upsertSoupEntries("appSoup",n,function(e){l.registerSoup("cacheSoup",[{path:"Name",type:"string"},{path:"Description",type:"string"}],function(){c(a,i)},function(e){u.logMessage("Failed to create cache soup with error = "+e)})},function(e){u.logMessage("Failed to update app soup with error = "+e)})},function(e){u.logMessage("Failed to register app soup with error = "+e)})}}):(document.addEventListener("deviceready",function(){c(a,i)},!1),document.addEventListener("backbutton",function(){},!0))}(n,e)})})}var p=100800,m=100801;function c(i,c){console.debug("cache status = "+JSON.stringify(c));r("mobileCaddy/logger");l.upsertSoupEntries("cacheSoup",mobileCaddy.INITIAL_APPCACHE_INFO,function(){f.querySoupRecsPromise("appSoup").then(function(e){var s={},a=[];if(e.forEach(function(e){if(void 0!==s[e.Name])throw"Should only be 1 "+e.Name+" entry in the app soup.  Found more";s[e.Name]=e}),s.userOverrideId||(s.userOverrideId=""),"Complete"==s.buildStatus.CurrentValue&&"Complete"==s.buildStatus.NewValue){if(null!==i){u.logMessage("build already complete - calling 3rd party callback function");var n={};if(n.status=m,n.mc_add_status=c.status,n.curVsn=s.dynVersionNumber.CurrentValue,void 0!==s.dynVersionNumber.NewValue&&(n.newVsn=s.dynVersionNumber.NewValue),navigator.appVersion.includes("Electron")){var o=window.location.protocol+"//"+window.location.host+window.location.pathname;ipcRenderer.send("startPageUrl",o)}i(n)}}else{var t=function(e,n){if(n.status){u.logMessage("Parse json aud"+e),a=$j.parseJSON(e);var o=_.find(a,{Name:"audId"}).CurrentValue,t=_.find(a,{Name:"sysDataPlatSupVersion"}).CurrentValue;if(navigator.appVersion.includes("Electron")){var r=window.location.protocol+"//"+window.location.host+window.location.pathname;ipcRenderer.send("startPageUrl",r)}new Promise(function(e,n){l.registerSoup("recsToSync",[{path:"Mobile_Table_Name",type:"string"},{path:"SOUP_Record_Id",type:"string"},{path:"Id",type:"string"},{path:"LastModifiedDateTime",type:"integer"},{path:"CRUD_Operation",type:"string"},{path:"Current_Connection_Session",type:"string"}],function(){e()},function(e){n(e)})}).then(function(){d.createSystemDataSoup(function(){f.buildMobileTables(function(){var e=s.buildStatus;e.CurrentValue="Complete",e.NewValue="Complete",a.map(function(e){return s[e.Name]&&(e._soupEntryId=s[e.Name]._soupEntryId),e}),a.push(e),l.upsertSoupEntries("appSoup",a,function(){d.getRecordTypeDots(o,t).then(function(){if(null!==i){var e={};e.status=p,e.mc_add_status=c.status,u.logMessage("Calling 3rd party callback"),u.logObjectDetails(e),i(e)}}).catch(function(e){u.logMessage("From getRecordTypeDots "+e)})},function(e){u.logMessage("From upsert soup records "+e)})},function(e){u.logMessage("Error building mobile tables "+e)})},function(e){u.logMessage("create system data soup returned error"+e)},o,t),u.logMessage("Exiting startup")}).catch(function(e){u.logMessage("Error building recs to sync soup "+e)})}else"exception"===n.type&&alert(n.message)};r("mobileCaddy/syncRefresh").heartBeat(function(e){console.log("getAudInfo heartbeat response",e),!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/getAUDInfo001",contentType:"application/json",data:{buildVersion:s.buildVersion.CurrentValue,buildName:s.buildName.CurrentValue,buildOS:s.buildOS.CurrentValue,deviceUuid:s.deviceUuid.CurrentValue,overrideUserId:force.getUserId(),startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN}},function(e){console.info("response -> "+JSON.stringify(e));var n={status:"200"};t(e,n)},function(e){console.error("err -> "+JSON.stringify(e)),error()}):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".getAudInfo",s.buildVersion.CurrentValue,s.buildName.CurrentValue,s.buildOS.CurrentValue,s.deviceUuid.CurrentValue,s.userOverrideId,t,{escape:!1,timeout:3e4})},function(e){console.log("getAudInfo heartbeat error",e),error()})}}).catch(function(e){console.error(e)})},function(e){u.logMessage("Failed to update app soup with initial app cache info = "+e)})}function S(e,n){n||(n=window.location.search),console.info("getUrlParamByName -> name = "+e),e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var o=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(n);return console.log("getUrlParamByName results -> "+o),null===o?"":decodeURIComponent(o[1].replace(/\+/g," "))}n.exports={startup:function(e){a(e)}}}),s("mobileCaddy/systemData",function(e,n,o){var i=e("mobileCaddy/mobileLogger"),c=e("mobileCaddy"),u=e("mobileCaddy/logger"),l=cordova.require("com.salesforce.plugin.smartstore"),d=(c.require("mobileCaddy/smartStoreUtils"),e("mobileCaddy/appDataUtils"));function f(t,r,s,a){console.log("In getSystemDataSoupDefinition with audId = "+t+" and sysDataPlatSupVersion = "+r);var o=function(e,n){if(n.status){console.log("In getSystemDataSoupDefinition callback -> "+e),console.log("Parse json app defns"+e);var o=$j.parseJSON(e);console.log("Parse json app defns done"),$j.each(o,function(e,n){i.logObjectDetails(n)}),l.registerSoup("syncLib_system_data",o,function(){!function(e,n,t,r){console.log("In populate system data row values");var o=function(e,n){if(n.status){console.log("In remoting callback for getSysDataSoupVariables with record count = "+e.length);var o=$j.parseJSON(e);console.log("Parse json soup field defns done"),l.upsertSoupEntries("syncLib_system_data",o,t,r)}else"exception"===n.type?(alert(n.message),u.error("Exception return from getSystemDataRowValues = "+n.message)):u.error("Unknown return from getSystemDataRowValues = "+n.message)};!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/getSysDataSoupVariables001",contentType:"application/json",data:{audId:e,startPageControllerVersion:c.START_PAGE_CONTROLLER_VSN,systemDataPlatformSupportVersion:n}},function(e){var n={status:"200"};o(e,n)},r):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+c.START_PAGE_CONTROLLER+".getSysDataSoupVariables",e,n,o,{escape:!1})}(t,r,function(){!function(e,n,t,r){console.log(c.START_PAGE_CONTROLLER+".getDefsForSObjectMobileTables");var o=function(e,n){if(n.status){var o=$j.parseJSON(e);console.log("Parse json table defns done"),l.upsertSoupEntries("syncLib_system_data",o,function(e){console.log("successful upsert with rec count = "+e.length),t(e)},function(e){u.error("Error returned from upsert, message =  "+e),r(e)})}else"exception"===n.type?(alert(n.message),u.error("Exception return from getDefsForSObjectMobileTables = "+n.message)):u.error("Unknown return from getDefsForSObjectMobileTables = "+n.message)};!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/getDefsForSObjectMobileTables001",contentType:"application/json",data:{audId:e,startPageControllerVersion:c.START_PAGE_CONTROLLER_VSN,systemDataPlatformSupportVersion:n}},function(e){var n={status:"200"};o(e,n)},r):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+c.START_PAGE_CONTROLLER+".getDefsForSObjectMobileTables",e,n,o,{escape:!1,timeout:12e4})}(t,r,s,a)},a)},a)}else"exception"===n.type?(alert(n.message),u.error("Exception return from getSystemDataSoupDefinition = "+n.message)):u.error("Unknown return from getSystemDataSoupDefinition = "+n.message)};!0===USE_FORCETK?(console.debug("USE_FORCETK == true"),force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/getSystemDataSoupDefinition001",contentType:"application/json",data:{audId:t,startPageControllerVersion:c.START_PAGE_CONTROLLER_VSN,systemDataPlatformSupportVersion:r}},function(e){var n={status:"200"};o(e,n)},a)):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+c.START_PAGE_CONTROLLER+".getSystemDataSoupDefinition",t,r,o,{escape:!1})}o.exports={createSystemDataSoup:function(e,n,o,t){var r,s,a,i;r=e,s=n,a=o,i=t,console.log("In createSystemDataSoup"),void 0!==a&&void 0!==i?f(a,i,r,s):d.getCurrentValueFromAppSoup("audId").then(function(e){return a=e,d.getCurrentValueFromAppSoup("sysDataPlatSupVersion")}).then(function(e){console.log("In success callback with aud id = "+a),f(a,e,r,s)}).catch(function(e){s(e)})},getRecordTypeDots:function(s){return new Promise(function(r,o){var n,t=function(t,e){console.log("getRecordTypeDots",n,t),e.status?l.registerSoup("dotsRecordTypes",[{path:"Table",type:"string"},{path:"Data",type:"string"}],function(e){var n=JSON.parse(t).map(function(e){return{Table:e.mobileTableName,Data:JSON.stringify(e.recTypeInfoList)}});console.log("upsertRecs",n),l.upsertSoupEntries("dotsRecordTypes",n,function(e){console.log("successful upsert with rec count = "+e.length);var o={};JSON.parse(t).forEach(function(e){var n={};e.recTypeInfoList.forEach(function(e){e.recTypeDevName?(n[e.recTypeId]={recTypeName:e.recTypeName,recTypeDevName:e.recTypeDevName},n[e.recTypeName]=e.recTypeId,n[e.recTypeDevName]=e.recTypeId):(n[e.recTypeId]=e.recTypeName,n[e.recTypeName]=e.recTypeId)}),o[e.mobileTableName]=n}),localStorage.setItem("lsDotsRecordTypes",JSON.stringify(o)),r()},function(e){u.error("Error returned from upsert, message =  "+e),o(e)})},function(e){o(e)}):("exception"===e.type?u.error("Exception return from p2mRefreshRecTypeDOTs = "+e.message):u.error("Unknown return from p2mRefreshRecTypeDOTs = "+e.message),o(e.message))};d.getCachedCurrentValueFromAppSoup("syncRefreshVersion").then(function(e){n=e,!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/p2mRefreshRecTypeDOTs001",contentType:"application/json",data:{audId:s,startPageControllerVersion:c.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:n,connSessJson:"{}"}},function(e){var n={status:"200"};t(e,n)},function(e){t("[]",{status:"OK"})}):Visualforce.remoting.Manager.getAction("mobilecaddy1."+c.START_PAGE_CONTROLLER+".p2mRefreshRecTypeDOTs")?Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+c.START_PAGE_CONTROLLER+".p2mRefreshRecTypeDOTs",s,n,"{}",t,{escape:!1,timeout:12e4}):t("[]",{status:"OK"})})})}}}),s("mobileCaddy/smartStoreUtils",function(p,e,n){var f=p("mobileCaddy/mobileLogger"),m=cordova.require("com.salesforce.plugin.smartstore");function r(e,n,o){var t=[];function r(e){n(t)}function s(e){if(console.error("onCursorClosedError",e),console.error("onCursorClosedError",e.stack),!o)throw e;o(e)}!function e(n){$j.each(n.currentPageOrderedEntries,function(e,n){t.push(n)}),n.currentPageIndex<n.totalPages-1?cordova.require("com.salesforce.plugin.smartstore").moveCursorToNextPage(n,e):cordova.require("com.salesforce.plugin.smartstore").closeCursor(n,r,s)}(e)}function s(e,n,o){i("syncLib_system_data",m.buildExactQuerySpec("Name",e,mobileCaddy.QUERY_BUFFER_SIZE),function(e){console.log("soup definition rows success callback with rec count = "+e.length);var o=[];$j.each(e,function(e,n){console.log("processing record = "),n.Type!=mobileCaddy.STANDING_DATA_OBJECT&&n.Type!=mobileCaddy.DYNAMIC_DATA_OBJECT?(console.log("Record Match"),o.push(n)):console.log("Record does not match")}),n(o)},o)}function a(e,n,o){var t=m.buildAllQuerySpec("_soupEntryId",null,mobileCaddy.QUERY_BUFFER_SIZE);m.querySoup(e,t,function(e){r(e,function(e){n(e)},o)})}function i(n,e,o,t){m.querySoup(n,e,function(e){r(e,function(e){console.log("Passing records back to callback for soup = "+n+" and rec count = "+e.length),o(e)},t)},t)}function c(e,n,o){console.debug("smartQuerySoupRecordsWithQuerySpec",e),m.runSmartQuery(e,function(e){r(e,function(e){console.log("Passing records back to callback for soup with rec count = "+e.length),n(e)},o)},o)}function S(t,r,s,n,e){if(void 0===n&&void 0===e)return new Promise(function(n,o){var e=m.buildExactQuerySpec(r,s,mobileCaddy.QUERY_BUFFER_SIZE_SL);i(t,e,function(e){n(e)},function(e){o(e)})});var o=m.buildExactQuerySpec(r,s,mobileCaddy.QUERY_BUFFER_SIZE_SL);i(t,o,function(e){n(e)},e)}function _(e,n,o,t,r,s,a){i(e,m.buildExactQuerySpec(n,o,mobileCaddy.QUERY_BUFFER_SIZE_SL),function(e){var o=[];$j.each(e,function(e,n){n[t]==r&&o.push(n)}),s(o)},a)}function u(n,o,t){g("Row Mapping PT","Mobile Table Name",function(e){_("syncLib_system_data","MC_Var_String_001","Platform Table Definition",e,n,function(e){1!=e.length&&f.logMessageAndThrow("Should be exactly 1 table defn row for table: "+n+", but we got "+e.length),o(e[0])},t)},t)}function l(e,r){return new Promise(function(o,t){u(e,function(n){g("Row Mapping PT",r,function(e){o(n[e])},function(e){t(e)})},function(e){t(e)})})}function d(e,r,s){return new Promise(function(o,t){u(e,function(n){g("Row Mapping PT",r,function(e){n[e]=s,m.upsertSoupEntries("syncLib_system_data",[n],function(){o()},function(e){t(e)})},function(e){t(e)})},function(e){t(e)})})}function g(n,o,t,e){var r=n+"_"+o,s=localStorage.getItem(r);s?t(s):_("syncLib_system_data","MC_Var_String_001",n,"MC_Var_String_003",o,function(e){1!=e.length&&($j.each(e,function(e,n){f.logObjectDetails(n)}),f.logMessageAndThrow("Must be exactly 1 Row Mapping Record for Sys Data Row Type = "+n+" and Sys Data Row Value = "+o+" found count = "+e.length)),localStorage.setItem(r,e[0].MC_Var_String_004),t(e[0].MC_Var_String_004)},e)}function y(s,e,o,n){i("syncLib_system_data",m.buildExactQuerySpec("MC_Var_String_001",s,mobileCaddy.QUERY_BUFFER_SIZE_SL),function(n){var r=[];$j.each(e,function(e,o){var t=!1;if($j.each(n,function(e,n){if(n.MC_Var_String_003==o)return r.push(n.MC_Var_String_004),void(t=!0)}),!t)throw"No mapping found for type = "+s+" and value = "+o}),o(r)},n)}var h=1,b=2;function t(n,r,o){y("Row Mapping PT",["Mobile Table Name","Build Order"],function(e){var t=e[0],s=e[1];S("syncLib_system_data","MC_Var_String_001","Platform Table Definition",function(e){var o=[];n==b?(e.sort(function(e,n){var o=0,t=parseInt(e[s]),r=parseInt(n[s]);return isNaN(t)||isNaN(r)||(o=t-r),o}),$j.each(e,function(e,n){o.push(n[t])})):($j.each(e,function(e,n){o.push(n[t])}),n==h&&o.sort()),null!==r&&r(o)},o)},o)}var C=0,R=2;function T(o,l,d,e){y("Row Mapping TC",["Parent SOUP Name","Table Column Name","Mobile Column Type","Application Field CRUD","META isNillable","Platform Column Type","Device Value Type","Proxy Ref Field Name"],function(e){var n=e[0],t=e[1],r=e[2],s=e[3],a=e[4],i=e[5],c=e[6],u=e[7];_("syncLib_system_data","MC_Var_String_001","Platform Table Column",n,o,function(e){var o=[];$j.each(e,function(e,n){l==C?o.push(n[t]):l==R?o.push({path:n[t],type:n[r],crud:n[s],nillable:n[a],platColType:n[i],appColType:n[c],proxyRefField:n[u]}):(o.push({path:n[t],type:n[r]}),console.log("path = "+n[t]+" and type = "+n[r]))}),d(o)},function(e){f.logMessage("Error retrieving column names = "+e)})},e)}function o(r,s){console.debug("About to buildMobileTables"),console.time("buildMobileTables"),t(b,function(e){var n=e.length;$j.each(e,function(e,t){T(t,1,function(o){console.debug("tableColumnObjectArray -> "+o),m.registerSoup(t,o,function(){console.log("success on register soup "+t),d(t,"SOUP Built Date/Time",(new Date).getTime()).then(function(){var n;return console.log("success on update of soup build date time"),n=t,o.forEach(function(e){e.path.includes("MC_Proxy_ID")&&localStorage.setItem("proxyField-"+n,e.path)}),l(t,"Snapshot Data Required")}).then(function(e){"Yes"==e?m.registerSoup("SnapShot_"+t,o,function(){console.log("Success from build of SnapShot_"+t),d(t,"Snapshot SOUP Built Date/Time",(new Date).getTime()),0===--n&&(console.timeEnd("buildMobileTables"),r())},function(e){console.error("Fail on create of SnapShot_"+t+" "+e),s(e)}):0===--n&&(console.timeEnd("buildMobileTables"),r())}).catch(function(e){s(e)})},s)},function(e){console.error("Fail on create of table"+t+" "+e),s(e)})})},s)}function v(e,n,o,t){if(console.log("In delete recs from soup with rec count = "+e.length),0!==e.length){var r=[];$j.each(e,function(e,n){n&&n._soupEntryId&&r.push(n._soupEntryId)}),0!==r.length?m.removeFromSoup(n,r,function(e){console.log("Deleted rec(s) - calling callback"),o(e)},t):o()}else o()}function E(i,e,n,o,t){var c,u,l,d,f;p("mobileCaddy/syncRefresh");(c=i,u=e,l=n,d=u.length,f=0,new Promise(function(a,i){I(c).then(function(s){$j.each(u,function(t,r){S(c,l,r[l]).then(function(e){if(0<e.length){var n=e[0];for(var o in r)n[o]=r[o];u[t]=n,d<=++f&&a(u)}else"Id"==l&&18<r.Id.length?S(c,s,r.Id).then(function(e){if(0<e.length){var n=e[0];for(var o in r)"Id"!=o&&(n[o]=r[o]);u[t]=n,d<=++f&&a(u)}else i({status:101107})}):i({status:101107})}).catch(function(e){i(e)})})}).catch(function(e){i(e)})})).then(function(e){m.upsertSoupEntriesWithExternalId(i,e,n,function(e){S("recsToSync","Mobile_Table_Name",i,function(s){var a=[];$j.each(e,function(e,o){var t,n;if($j.each(s,function(e,n){n.Id!=o.Id||(t=n)}),void 0!==t)if(console.log("existingRecToSync",t),t.Current_Connection_Session&&void 0!==t.Current_Connection_Session)switch(t.CRUD_Operation){case"Insert":case"InsertUpdate":n="InsertUpdate";break;default:n="UpdateUpdate"}else n=t.CRUD_Operation;else n="Update";var r={Mobile_Table_Name:i,SOUP_Record_Id:o._soupEntryId,Id:o.Id,CRUD_Operation:n,LastModifiedDateTime:o.SystemModstamp};"InsertUpdate"!=n&&"UpdateUpdate"!=n||(r.Current_Connection_Session=t.Current_Connection_Session),a.push(r)}),m.upsertSoupEntriesWithExternalId("recsToSync",a,"Id",o,t)},t)},t)}).catch(function(e){t(e)})}function I(t){return new Promise(function(o,e){var n=localStorage.getItem("proxyField-"+t);n?o(n):(console.log("getProxyFieldName",t),T(t,C,function(e){var n=null;e.forEach(function(e){e.includes("MC_Proxy_ID")&&(n=e,localStorage.setItem("proxyField-"+t,e),console.log("GOT IT ",n))}),o(n)},function(e){console.error("listMobileTableColumns",JSON.stringify(e)),o(null)}))})}n.exports={NONE:0,ALPHA:h,BUILD:b,listMobileTables:function(e,n,o){t(e,n,o)},LIST:C,BUILD_OBJECT:1,FULL:R,listMobileTableColumns:function(e,n,o,t){T(e,n,o,t)},queryMobileTable:function(e,n,o,t,r){return S(e,n,o,t,r)},buildMobileTables:function(e,n){o(e,n)},getProxyFieldName:function(e){return I(e)},getSysDataRowMapColHeading:function(e,n,o,t){g(e,n,o,t)},getSysDataRowMapColHeadings:function(e,n,o,t){y(e,n,o,t)},getTableDefnColumnValue:function(e,n){return l(e,n)},setTableDefnColumnValue:function(e,n,o,t,r){return d(e,n,o)},queryMobileTableWithAnd:function(e,n,o,t,r,s,a){_(e,n,o,t,r,s,a)},smartQuerySoupRecordsWithQuerySpec:function(e,n,o){c(e,n,o)},insertRecords:function(e,n,o,t){var s,r,a,i,c;s=e,r=n,a=o,i=t,c=p("mobileCaddy/syncRefresh"),console.log("in insert records"),console.log("mobile table name = "+s),console.log("records = "+JSON.stringify(r)),console.log("records size = "+r.length),m.upsertSoupEntries(s,r,function(e){console.log("back from upsert soup with records = "+JSON.stringify(e));var r=(new Date).getTime();c.addProxyIds(s,e,r,function(e){console.log("back with proxy ids = "+JSON.stringify(e));var t=[];$j.each(e,function(e,n){var o={Mobile_Table_Name:s,CRUD_Operation:"Insert",SOUP_Record_Id:n._soupEntryId,Id:n.Id,LastModifiedDateTime:r};t.push(o)}),m.upsertSoupEntriesWithExternalId("recsToSync",t,"Id",a,i)},i)},i)},updateRecordsWithExternalId:function(e,n,o,t,r){E(e,n,o,t,r)},markSoupToSync:function(o,t,r){i("syncLib_system_data",m.buildExactQuerySpec("Type",mobileCaddy.DYNAMIC_DATA_OBJECT,mobileCaddy.QUERY_BUFFER_SIZE_SL),t,function(e){for(var n=0;n<e.length;n++)if(e[n].Name==o){e[n].Refresh_Indicator="Once",m.upsertSoupEntries("syncLib_system_data",[e[n]],t,r);break}})},emptySoup:function(e,n,o){var t=mobileCaddy.require("mobileCaddy/smartStoreUtils");m.removeSoup(e,function(){t.createSoup(e,n,o)},o)},emptySoupPromise:function(t){return new Promise(function(e,n){var o=mobileCaddy.require("mobileCaddy/smartStoreUtils");m.removeSoup(t,function(){o.createSoup(t,function(){console.debug("emptySoupPromise",t),e()},function(e){n(e)})},function(e){n(e)})})},deleteSoup:function(t){return console.debug("deleteSoup",t),new Promise(function(e,n){mobileCaddy.require("mobileCaddy/smartStoreUtils");var o=p("mobileCaddy/logger");m.removeSoup(t,function(){o.log("deleteSoup",t),e()},function(e){o.errorAndDispatch("deleteSoup",e),n(e)})})},createSoup:function(o,t,r){s(o,function(e){!function(e,n,o){console.log("in getQueryAndSoupDefinition");var t=[],r="Select ";$j.each(e,function(e,n){console.log("soup column defn = "),t.push({path:n.Column_Name,type:n.Column_Type}),0!==n.Column_Name.indexOf("_")&&(r+=n.Column_Name+",")}),r=r.substring(0,r.length-1),n(r+=" From "+e[0].Name,t)}(e,function(e,n){m.registerSoup(o,n,function(e){t()},r)})},r)},querySoupRecords:function(e,n,o){a(e,n,o)},querySoupRecsPromise:function(e){return t=e,new Promise(function(n,o){a(t,function(e){n(e.filter(function(e){return"object"==typeof e}))},function(e){o(e)})});var t},querySoupRecordsWithQuerySpec:function(e,n,o,t){i(e,n,o,t)},compareVersions:function(n,o){i("syncLib_system_data",cordova.require("com.salesforce.plugin.smartstore").buildExactQuerySpec("Name",mobileCaddy.VERSION_ID,mobileCaddy.QUERY_BUFFER_SIZE),function(e){simpleMessageSL("Version in soup = "+e[0].Value),getVersion(function(e){simpleMessageSL("Version in Salesforce = "+e),n()},o)},o)},deleteRecordsForExternalId:function(e,n,o,t,r){return function(s,n,a,o,t){if(!o&&!t)return new Promise(function(o,t){if(0===n.length)o();else{var r="";"object"==typeof n[0]?n.forEach(function(e,n){r+=0===n?"'"+e[a]+"'":",'"+e[a]+"'"}):n.forEach(function(e,n){r+=0===n?"'"+e+"'":", '"+e+"'"});var e="SELECT {"+s+":_soupEntryId} FROM {"+s+"} WHERE {"+s+":"+a+"} IN ("+r+")";console.log("deleteRecordsForExternalId soql",e),querySpec=m.buildSmartQuerySpec(e,1e4),c(querySpec,function(e){console.log("recs",e);var n=e.map(function(e){return e[0]});m.removeFromSoup(s,n,function(e){o(e)},function(e){t(e)})},function(e){t(e)})}});if(0===n.length)o();else{var r=[];$j.each(n,function(e,n){r.push(n[a])});var i="";n.forEach(function(e,n){i+=0===n?"'"+e[a]+"'":",'"+e[a]+"'"});var e="SELECT {"+s+":_soupEntryId} FROM {"+s+"} WHERE {"+s+":"+a+"} IN ("+i+")";console.log("deleteRecordsForExternalId soql",e),querySpec=m.buildSmartQuerySpec(e,1e4),c(querySpec,function(e){console.log("recs",e);var n=e.map(function(e){return e[0]});m.removeFromSoup(s,n,function(e){o()},function(e){t(e)})},function(e){t(e)})}}(e,n,o,t,r)},deleteRecordsFromSoup:function(e,n,o,t){v(e,n,o,t)},refreshSnapshot:function(e,n,o){var t,r,s;t=e,r=n,s=o,m.soupExists(t,function(e){e?m.soupExists("SnapShot_"+t,function(e){e?a("SnapShot_"+t,function(e){v(e,"SnapShot_"+t,function(){a(t,function(e){m.upsertSoupEntries("SnapShot_"+t,e,r,s)},s)},s)},s):f.logMessageAndThrow("SnapShot Table is missing: SnapShot_"+t)},s):f.logMessageAndThrow("Mobile Table is missing"+t)},s)}}}),s("mobileCaddy/appDataUtils",function(e,n,o){e("mobileCaddy/mobileLogger");var a=cordova.require("com.salesforce.plugin.smartstore"),i=e("mobileCaddy/smartStoreUtils");function r(t){return new Promise(function(n,o){var e=a.buildExactQuerySpec("Name",t,mobileCaddy.QUERY_BUFFER_SIZE);i.querySoupRecordsWithQuerySpec("appSoup",e,function(e){e[0]?n(e[0].CurrentValue):n(e[0])},function(e){o(e)})})}function t(t,r,s){return new Promise(function(n,o){var e=a.buildExactQuerySpec("Name",t,mobileCaddy.QUERY_BUFFER_SIZE);i.querySoupRecordsWithQuerySpec("appSoup",e,function(e){0<e.length?(e[0][s]=r,a.upsertSoupEntries("appSoup",e,function(e){n(e)},function(e){o(e)})):n()},function(e){o(e)})})}o.exports={getCurrentValueFromAppSoup:function(e){return r(e)},getCachedCurrentValueFromAppSoup:function(e){return o=e,t=localStorage.getItem("appSoup-"+o),new Promise(function(n,e){t?n(t):r(o).then(function(e){localStorage.setItem("appSoup-"+o,e),n(e)})});var o,t},updateNewValueInAppSoup:function(e,n){return t(e,n,"NewValue")},updateCurrentValueInAppSoup:function(e,n){return t(e,n,"CurrentValue")}}}),s("mobileCaddy/syncRefresh",function(r,e,n){var y=r("mobileCaddy/appDataUtils"),f=r("mobileCaddy/vsnUtils"),h=r("mobileCaddy/smartStoreUtils"),b=(r("mobileCaddy/mobileLogger"),r("mobileCaddy/logger")),C=cordova.require("com.salesforce.plugin.smartstore"),R=r("mobileCaddy/connSessUtils"),T="006";function g(d){return new Promise(function(s,n){var a=function(e){n(e)},i={};console.log("json object date time = "+d.lastRefreshDatetime);var c={},u={},l=d.mt;null===l&&console.error("Mobile Table (tag 'mt') empty in p2mRefresh response: ",d);var e=C.buildExactQuerySpec("Mobile_Table_Name",l,mobileCaddy.QUERY_BUFFER_SIZE);h.querySoupRecordsWithQuerySpec("recsToSync",e,function(o){$j.each(o,function(e,n){if("Insert"==n.CRUD_Operation||"InsertUpdate"==n.CRUD_Operation)c[n.Id]=1;else{if("Update"!=n.CRUD_Operation&&"UpdateUpdate"!=n.CRUD_Operation)return void b.error("RTS contains record with non support CRUD Operation"+n);u[n.Id]=1}}),h.getProxyFieldName(l).then(function(t){var r=[],n=[];($j.each(d.records,function(e,n){var o=!0;null!==n.recordData.MC_Proxy_ID__c&&c.hasOwnProperty(n.recordData[t])&&(o=!1),o&&u.hasOwnProperty(n.recordData.Id)&&(o=!1),o&&r.push(n.recordData)}),d.ds)&&d.ds.oq.concat(d.ds.sd.concat(d.ds.hd.concat(d.ds.sh))).forEach(function(e){u.hasOwnProperty(e)?console.log("We have a dirty local version, not deleting"):n.push({Id:e})});var e=C.buildExactQuerySpec("Mobile_Table_Name",l,mobileCaddy.QUERY_BUFFER_SIZE);h.querySoupRecordsWithQuerySpec("recsToSync",e,function(e){e.length==o.length?h.deleteRecordsForExternalId(l,n,"Id",function(){C.upsertSoupEntriesWithExternalId(l,r,"Id",function(){C.soupExists("SnapShot_"+l,function(e){e?h.deleteRecordsForExternalId("SnapShot_"+l,n,"Id",function(){C.upsertSoupEntriesWithExternalId("SnapShot_"+l,r,"Id",function(){f.checkForMigrateToInfo(d),p(d.platAuthUrl),i.status=0,i.cs=d.cs,i.cp=d.cp,i.lastRefreshDatetime=d.lastRefreshDatetime,s(i)},a)},a):(f.checkForMigrateToInfo(d),p(d.platAuthUrl),i.status=0,i.lastRefreshDatetime=d.lastRefreshDatetime,i.cs=d.cs,i.cp=d.cp,s(i))},a)},a)},a):(i.status=0,i.mc_add_status=1,i.cs=d.cs,i.cp=d.cp,i.lastRefreshDatetime=d.lastRefreshDatetime,resolves(i))},a)})},a)})}function p(n){console.log("setPlatAuthUrl",n),n||(n=""),y.updateCurrentValueInAppSoup("platAuthUrl",n).catch(function(e){b.error("setPlatAuthUrl",n,e)})}var v=100500,E=100402;function I(t,r,s){return new Promise(function(n,o){y.getCachedCurrentValueFromAppSoup("audId").then(function(e){n("PROXY%"+t+"%"+s+"%"+r+"%"+e)}).catch(function(e){o(e)})})}function N(e,n,o,t){var r;if("Throw Exception"==t)throw b.errorAndDispatch("nullHandler - NULL value found",e,n,o.Id),"NULL value found for field "+n+" in Mobile Table "+e+" with Id = "+o.Id;return"Return NULL"==t?r=null:"Return Empty String"==t&&(r=""),r}function P(t,s){return new Promise(function(n,e){if(console.log("syncRefreshVersion",t,T),t<T||!s)n();else{var o,r=[];h.queryMobileTable("recsToSync","Mobile_Table_Name","Connection_Session__mc").then(function(e){return o=e,console.log("rtsRecs",o),0<o.length?h.querySoupRecsPromise("Connection_Session__mc"):Promise.resolve([])}).then(function(t){console.log("csRecs",t),o.forEach(function(e){for(var n,o=0;o<t.length;++o)if(t[o].Id===e.Id&&t[o].Id.length<20){n=t[o];break}n&&r.push({Id:e.Id,t:function(e){switch(e){case"Sync - Refresh":return 1;case"Sync - Update":return 2;case"Status Check":return 3;default:return b.error("Unkown Session_Type__c",e),0}}(n.mobilecaddy1__Session_Type__c),s:function(e){switch(e){case"P2M RE Records Processed":return 1;case"P2M Conn_Sess Records Processed":return 2;case"P2M RE Abandoned":return 3;case"P2M RE Exception/Timeout":return 4;case"P2M RE Heartbeat Exception/Timeout":return 5;case"P2M RE Failure":return 6;case"P2M RE Hearbeat Failure":return 7;case"M2P Conn_Sess Records Processed":return 8;case"M2P Records Processed":return 9;case"M2P UP Failed - RTS Cleared":return 10;case"M2P SC - Status Check Processed":return 11;case"M2P SC Failure":return 12;case"M2P SC Exception/Timeout":return 13;case"M2P SC Heartbeat Exception/Timeout":return 14;case"M2P SC Heartbeat Failure":return 15;case"M2P UP Received - Records Processed":return 16;case"P2M InitialSync Faliure":return 17;default:return b.error("Unknown CS status",e),0}}(n.mobilecaddy1__Mobile_Process_Status__c)})}),n(r)}).catch(function(e){b.error(e),n(null)})}})}function D(a,i,c,e,u,l,n,d,f,o,t){var p={MobileTable:a,connSessProxyId:o,records:[]};n.forEach(function(e){for(var n,o=0;o<d.length;++o)if(d[o].Id===e.Id){n=d[o];break}if(n){var t={RTSRowNum:e._soupEntryId,RecordCRUD:function(e){switch(e){case"Insert":return"I";case"InsertDelete":return"T";case"Update":return"U";case"UpdatetDelete":return"Q";case"Delete":return"D";default:return null}}(e.CRUD_Operation),fields:[]};switch(t.RecordCRUD){case"I":case"T":t=function(e,n,o,t,r,s,a,i){for(var c in i){var u={name:c};if("mobilecaddy1__Error_Text__c"==c)u.value=JSON.stringify(i[c]),e.fields.push(u);else if("_soupEntryId"!=c&&"_soupLastModifiedDate"!=c){var l,d={};d[t]=c;var f=_.findWhere(o,d);if(null===i[c])fieldNullHandler=f[s],l=N(n,c,i,fieldNullHandler);else if(l=i[c],f){var p=f[a];"M2P UP Unquoted"!=p||"true"!=l&&"false"!=l||(l="true"==l)}u.value=l,e.fields.push(u)}}return e}(t,a,i,c,0,u,l,n),p.records.push(t);break;case"D":case"U":case"Q":for(var r,s=0;s<f.length;++s)if(f[s].Id===e.Id){r=f[s];break}r?(t=function(e,n,o,t,r,s,a,i,c){var u=!1;for(var l in i)if("_soupEntryId"!=l&&"_soupLastModifiedDate"!=l){var d={name:l};if(i[l]!=c[l]||"SystemModstamp"==l){var f,p;u=!0;var m=null,S=null,g={};g[t]=l;var y=_.findWhere(o,g);null===i[l]?(m=y[s],f=N(n,l,i,m)):(f=i[l],y&&("M2P UP Unquoted"!=(S=y[a])||"true"!=f&&"false"!=f||(f="true"==f))),null===c[l]&&y?(m||(m=y[s]),p=N(n,l,c,m)):(p=c[l],y&&(S||(S=y[a]),"M2P UP Unquoted"!=S||"true"!=p&&"false"!=p||(p="true"==p))),d.previousValue=p,d.value=f,e.fields.push(d)}}return u?(e.fields.push({name:"Id",previousValue:c.Id,value:c.Id}),e):[]}(t,a,i,c,0,u,l,n,r),p.records.push(t)):b.errorAndDispatch("createUpdateJson Missing snapShot",a,n.Id);break;default:b.errorAndDispatch("createUpdateJson unknown CRUD",a,e.Id,e.CRUD_Operation)}}else b.errorAndDispatch("createUpdateJson Missing primary",a,e.Id)}),t(JSON.stringify(p))}function O(n,e,o,t,r){var s=[];$j.each(e,function(e,t){var r={};$j.each(o,function(e,n){if(t.Id==n.Id&&"Insert"==t.CRUD_Operation)for(var o in n)"_soupEntryId"!=o&&"_soupLastModifiedDate"!=o&&(r[o]=n[o])}),_.isEmpty(r)||s.push(r)}),0===s.length?t():h.getProxyFieldName(n).then(function(e){C.upsertSoupEntriesWithExternalId("SnapShot_"+n,s,e,t,r)})}function U(e,f,p,m,S,_){return new Promise(function(l,t){var e=r("mobileCaddy/geolocation"),d={};e.getLocation(function(r){var s,e,a,i,c,n,o={mobilecaddy1__Session_Type__c:f,mobilecaddy1__Mobile_Process_Status__c:p,SystemModstamp:(new Date).getTime()},u=r.ErrorNumber;0!==u?o.mobilecaddy1__Session_Created_Location_Error__c=r.Error:(o.Session_Created_Location__Longitude__s=r.Latitude,o.Session_Created_Location__Latitude__s=r.Longitude),s="Connection_Session__mc",e=o,a=function(e){var n=new Date,o={"Sync Session Proxy ID":null,"Total Sessions":S,"Session Number":m,"Device Call Date/Time":n.getTime(),"Connection Session Proxy ID":e.proxyId};_&&(o.CsPId=_),0!==u?o.ErrorNumber=u:(o["Location Long"]=r.Longitude,o["Location Lat"]=r.Latitude),d.status=0,d.connSessionRec=e.insertedRecord,d.connSessProxyId=e.proxyId;var t={version:"NULL"};window.device&&(t=window.device),y.getCurrentValueFromAppSoup("containerVersion").then(function(e){o.containerVsn=e,o.OSVsn=t.version,d.connSessJson=JSON.stringify(o),l(d)}).catch(function(e){b.error("buildConnectionSession - Could not get containerVsn",e),o.OSVsn=t.version,d.connSessJson=JSON.stringify(o),l(d)})},i=function(e){t(e)},c={},n=new Date,h.getProxyFieldName(s).then(function(t){C.upsertSoupEntries(s,[e],function(e){var o=e[0];I(s,o._soupEntryId,n.getTime()).then(function(n){o.Id=n,o[t]=n,C.upsertSoupEntries(s,[o],function(e){c.status=0,c.proxyId=n,c.insertedRecord=e[0],a(c)},i)}).catch(function(e){i(e)})},i)}).catch(function(e){i(e)})},function(e){t(e)})})}function o(p){return new Promise(function(n,o){var l={},d=function(e){n(e)},f=function(e){o(e)},e=C.buildExactQuerySpec("Mobile_Table_Name",p,mobileCaddy.QUERY_BUFFER_SIZE);h.querySoupRecordsWithQuerySpec("recsToSync",e,function(e){if(0!==e.length){console.debug("recsToSyncRecords",JSON.stringify(e));var c=!1;"Connection_Session__mc"!=p&&3e4<e.length&&(c=!0),console.log("moreToSync: "+c);var u=[];u=c?(u=_.sortBy(e,"_soupLastModifiedDate")).slice(0,3e4):e,console.debug("recsToSyncRecords2",JSON.stringify(u)),h.querySoupRecords(p,function(i){h.querySoupRecords("SnapShot_"+p,function(a){h.getSysDataRowMapColHeadings("Row Mapping TC",["Parent SOUP Name","Table Column Name","M2P Update Converter DEVICE","M2P Update NULL Handler DEVICE","M2P Update Formatter DEVICE"],function(e){var n=e[0],t=e[1],r=(e[2],e[3]),s=e[4];h.queryMobileTableWithAnd("syncLib_system_data","MC_Var_String_001","Platform Table Column",n,p,function(e){var o=[];if(_.each(u,function(e){var n;n=e.Id,_.find(i,function(e){return e.Id==n})&&o.push(e)}),_.isEmpty(o))return console.debug("Nothing in checkedRecsToSync."),void h.setTableDefnColumnValue(p,"Last Sync Date/Time",(new Date).getTime()).then(function(){l.status=M,l.mc_add_status=w,d(l)}).catch(function(e){b.error(e)});D(p,e,t,0,r,s,o,i,a,"",function(n){var t;y.getCachedCurrentValueFromAppSoup("audId").then(function(e){return t=e,y.getCachedCurrentValueFromAppSoup("syncRefreshVersion")}).then(function(e){O(p,u,i,function(){console.log("moreToSync: "+c);var o=function(e,n){console.debug("result: "+e),console.debug("event: "+n),l.result=e,l.event=n,d(l)};n=n.replace(/: undefined/g,': "undefined"'),console.debug("jsonString -> "+n),!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/m2pUpdateTable001",contentType:"application/json",data:{audId:t,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:e,mobileTableName:p,jsonRecords:n,connSessJson:"{}"}},function(e,n){void 0===n&&(n={status:"200"}),o(e,n)},f):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".m2pUpdateTable",t,e,p,n,JSON.stringify({"Session Number":1,"Location Long":10,"Location Lat":10,"Total Sessions":1,"Device Call Date/Time":(new Date).getTime(),"Connection Session Proxy ID":"1",ErrorNumber:2}),o,{buffer:!1,escape:!1,timeout:3e4})},f)}).catch(function(e){f(e)})})},f)},f)},f)},f)}else h.setTableDefnColumnValue(p,"Last Sync Date/Time",(new Date).getTime()).then(function(){l.status=M,l.mc_add_status=w,d(l)}).catch(function(e){b.log("No recs to sync")})},f)})}var M=100300,w=100310;function s(l,d,f,p){var m,S,g={};console.debug("In m2pUpdateMobileTable call",l,d);try{y.getCachedCurrentValueFromAppSoup("syncRefreshVersion").then(function(e){S=e;var n=localStorage.getItem("mcM2pMoreToSync")?2:1;return U(0,"Sync - Update","M2P Process Called",n,n,null)}).then(function(e){return m=e,console.log("proxy id = "+m.connSessProxyId),P(S,!0)}).then(function(e){console.log("m2p csUpdates",e),e&&(m.connSessJson=JSON.parse(m.connSessJson),m.connSessJson.csM2P=e,m.connSessJson=JSON.stringify(m.connSessJson)),console.log("connSessObject -> ",m);var n=C.buildExactQuerySpec("Mobile_Table_Name",l,mobileCaddy.QUERY_BUFFER_SIZE);h.querySoupRecordsWithQuerySpec("recsToSync",n,function(e){var n,o,t,r,s,a,i=(n=e,(o=JSON.parse(localStorage.getItem("tmpFailedRecordsAccum")))?n.filter(function(e){return!o[e.Id]}):n);if(0!==i.length){console.debug("filteredRTS",JSON.stringify(i));var c=!1;"Connection_Session__mc"!=l&&i.length>d?(c=!0,localStorage.setItem("mcM2pMoreToSync","true")):localStorage.removeItem("mcM2pMoreToSync"),console.log("moreToSync",c);var u=[];u=c?(u=_.sortBy(i,"_soupLastModifiedDate")).slice(0,d):i,console.log("recsToSyncRecords2",JSON.stringify(u)),t=u,r=m.connSessProxyId,s=function(i){h.querySoupRecords(l,function(a){h.querySoupRecords("SnapShot_"+l,function(s){h.getSysDataRowMapColHeadings("Row Mapping TC",["Parent SOUP Name","Table Column Name","M2P Update Converter DEVICE","M2P Update NULL Handler DEVICE","M2P Update Formatter DEVICE"],function(e){var n=e[0],o=e[1],t=(e[2],e[3]),r=e[4];h.queryMobileTableWithAnd("syncLib_system_data","MC_Var_String_001","Platform Table Column",n,l,function(e){D(l,e,o,0,t,r,i,a,s,m.connSessProxyId,function(t){var n;y.getCachedCurrentValueFromAppSoup("audId").then(function(e){n=e,O(l,i,a,function(){console.log("moreToSync",c);var o=function(e,n){var o;(console.debug("result",e),console.debug("event",n),n.status)?(e=e.replace(/,}/g,"}"),console.log("Parse json processM2PUpdateResponse"),o=JSON.parse(e),console.log("Parse json processM2PUpdateResponse done"),R.processM2PUpdateResponse(o,t,function(e){console.debug("responseObject",JSON.stringify(e)),m.connSessionRec.mobilecaddy1__Mobile_Process_Status__c="Connection_Session__mc"==l?"M2P Conn_Sess Records Processed":"M2P Records Processed",m.connSessionRec.Id=e.csId,R.postProcessConnectionSession(m.connSessionRec).then(function(){return R.handleUpdatedCS(o.csM2P)}).then(function(){console.log("success return from post process"),console.log("success return from post process"),console.log("moreToSync",c),c?(g.status=M,g.mc_add_status="more-to-sync",f(g)):S<T?R.maybeSyncConnSess(m.connSessionRec,function(){console.log("success return from maybeSyncConnSess"),g.status=M,f(g)},p):(g.status=M,f(g))}).catch(function(e){p(e)})},p)):("exception"===n.type?(g.status=M,g.mc_add_status=A):(g.status=M,g.mc_add_status=L),f(g),b.error("m2pUpdate",l,n.message,n.where))};t=t.replace(/: undefined/g,': "undefined"'),console.debug("jsonString -> "+t),!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/m2pUpdateTable001",contentType:"application/json",data:{audId:n,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:S,mobileTableName:l,jsonRecords:t,connSessJson:m.connSessJson}},function(e,n){void 0===n&&(n={status:"200"}),o(e,n)},p):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".m2pUpdateTable",n,S,l,t,m.connSessJson,o,{buffer:!1,escape:!1,timeout:3e4})},p)}).catch(function(e){p(e)})})},p)},p)},p)},p)},a=p,$j.each(t,function(e,n){n.Current_Connection_Session=r}),C.upsertSoupEntriesWithExternalId("recsToSync",t,"Id",s,a)}else h.setTableDefnColumnValue(l,"Last Sync Date/Time",(new Date).getTime()).then(function(){g.status=M,g.mc_add_status=w,f(g)}).catch(function(e){p(e)})},p)},p)}catch(e){b.errorAndDispatch(e)}}var a=100100,A=100101,L=100102,i=100105;function c(o,e){var t={};Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".heartBeat",function(e,n){n.status?(t.status=a,o(t)):"exception"===n.type?u(function(e){console.log("refresh token refreshed in heartbeat"),t.status=i,o(t)},function(e){t.status=A,o(t)}):(console.debug("other"),t.status=L,o(t))},{escape:!1,timeout:3e4})}function u(o,t){h.querySoupRecords("appSoup",function(e){var n={};e.forEach(function(e){n[e.Name]=e.CurrentValue}),function(e,n,o){r("mobileCaddy/mobileLogger"),cordova.require("com.salesforce.plugin.smartstore");var t="grant_type=refresh_token&identity_url="+e.identityUrl+"&client_id="+e.clientId+"&refresh_token="+e.refreshToken+"&orgId="+e.orgId+"&audId="+e.audId+"&userId="+e.userId;console.log("data: "+t),$j.ajax({type:"POST",url:"https://mobilecaddy.my.salesforce-sites.com/apex/ProxyToken",cache:!1,processData:!1,data:t,success:function(e){console.log("Changing vf access token from "+Visualforce.remoting.oauthAccessToken+" to "+e.access_token),Visualforce.remoting.oauthAccessToken=e.access_token,Visualforce.remoting.last.refresh(function(){y.updateCurrentValueInAppSoup("accessToken",e.access_token).then(function(){console.log("Updated accessToken in appSoup"),n(e.access_token)}).catch(function(e){o(e)})},function(e){b.error("in VF last refresh error"),o(e)})},error:function(e){b.error("failed to refresh access token "+JSON.stringify(e)),o(e)},dataType:"json",beforeSend:function(e){}})}(n,o,t)},function(e){t(e)})}n.exports={CSINHEAD_SYNC_VSN:T,refreshToken:function(e,n){u(e,n)},genProxyId:function(e,n,o){return I(e,n,o)},addProxyIds:function(e,n,o,t,r){var s,a,i,c,u,l;s=e,a=n,i=o,c=t,u=r,h.getProxyFieldName(s).then(function(e){return l=e,y.getCachedCurrentValueFromAppSoup("audId")}).then(function(t){$j.each(a,function(e,n){var o="PROXY%"+s+"%"+i+"%"+n._soupEntryId+"%"+t;n.Id=o,n[l]=o}),C.upsertSoupEntries(s,a,function(e){c(e)},u)}).catch(function(e){u(e)})},P2M_REFRESH_OK:v,p2mRefreshTable:function(e,n,o,t,r,s,a,i){!function s(a,i,c,o,n,t,u,l){console.log("Refreshing table",a);var r,d,f,p,m=function(e,n){if(console.debug("respJson",e),console.debug("event",n),n.status){var o,t,r=new RegExp("\n","g");e=e.replace(r,"\\n"),r=new RegExp("\r","g"),e=e.replace(r,""),t=JSON.parse(e),console.log("Parse json done"),g(t).then(function(e){return o=e,console.log("handle refresh res = "+o.status),h.setTableDefnColumnValue(a,"Last Refresh Date/Time",o.lastRefreshDatetime)}).then(function(){var e="P2M RE Records Processed";return"Connection_Session__mc"==a&&(e="P2M Conn_Sess Records Processed"),1==o.mc_add_status&&(e="P2M RE Abandoned"),p.connSessionRec.mobilecaddy1__Mobile_Process_Status__c=e,p.connSessionRec.Id=o.cs,R.postProcessConnectionSession(p.connSessionRec)}).then(function(){return R.handleUpdatedCS(t.csM2P)}).then(function(){console.log("success return from post process"),c&&d<T?R.maybeSyncConnSess(p.connSessionRec,function(){console.log("success return from maybeSyncConnSess"),t["Session Number"]&&t["Session Number"]<t["Total Sessions"]?(console.info("Page "+t["Session Number"]+" of "+t["Total Sessions"]+", going again."),s(a,i,c,t["Session Number"]+1,t["Total Sessions"],t.CsPId,u,l)):t.moreBatches?(console.info("moreBatches"),s(a,i,c,"newBatch",1,null,u,l)):(S.status=v,u(S))},l):t["Session Number"]&&t["Session Number"]<t["Total Sessions"]?(console.info("Page "+t["Session Number"]+" of "+t["Total Sessions"]+", going again."),s(a,i,c,t["Session Number"]+1,t["Total Sessions"],t.CsPId,u,l)):t.moreBatches?(console.info("moreBatches"),s(a,i,c,"newBatch",1,null,u,l)):(console.log("No more pages or batches"),S.status=v,u(S))}).catch(function(e){l(e)})}else"exception"===n.type&&b.error("p2mRefresh",a,n.message,n.where),R.cleanConnectionSessionVFEvent(n,p,function(e){S.status=E,S.mc_add_status=e.mc_add_status,u(S)},l)},S={},_="newBatch"==o;_&&(o=1);try{h.getTableDefnColumnValue(a,"Last Refresh Date/Time").then(function(e){(f=e)&&"null"!=f||(f=0),console.log("Using lastRefreshDatetime = "+f),console.debug("maxTableAge",i);var n=new Date;return f<n-i||1<o||_||!c?y.getCachedCurrentValueFromAppSoup("audId"):(console.log("Not refreshing table. it is too young"),S.status=100402,S.status=100497,Promise.reject(S))}).then(function(e){return r=e,y.getCachedCurrentValueFromAppSoup("syncRefreshVersion")}).then(function(e){return U(d=e,"Sync - Refresh","P2M RE Process Called",o,n,t)}).then(function(e){if(p=e,!c){var n=JSON.parse(p.connSessJson);n.initialSync=!0,p.connSessJson=JSON.stringify(n)}if(_){var o=JSON.parse(p.connSessJson);o.firstBatch=!1,p.connSessJson=JSON.stringify(o)}return P(d,c)}).then(function(e){console.log("csUpdates",e),e&&(p.connSessJson=JSON.parse(p.connSessJson),p.connSessJson.csM2P=e,p.connSessJson=JSON.stringify(p.connSessJson)),console.log("connSessObject -> ",p),!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/p2mRefreshTable001",contentType:"application/json",data:{audId:r,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN,syncRefreshDataVersion:d,mobileTableName:a,deviceRefreshIds:[],lastRefreshDateTime:f,thirdPartyJson:"",connSessJson:p.connSessJson}},function(e,n){void 0===n&&(n={status:"200"}),m(e,n)},l):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".p2mRefreshTable",r,d,a,[],f,"",p.connSessJson,m,{buffer:!1,escape:!1,timeout:12e4})}).catch(function(e){100497==e.status?u(e):(b.error(e),l(e))})}catch(e){b.errorAndDispatch(e)}}(e,n,o,t,r,s,a,i)},buildConnectionSession:function(e,n,o,t,r,s){return U(0,n,o,t,r,s)},M2P_UPDATE_OK:M,M2P_NO_RECS_TO_SYNC:w,m2pUpdateMobileTable:function(e,n,o,t){s(e,n,o,t)},m2pRecoveryUpdateMobileTable:function(e){return o(e)},HEARTBEAT_OK:a,HEARTBEAT_EXCEPTION:A,HEARTBEAT_FAILURE:L,HEARTBEAT_NO_CONNECTION:100103,HEARTBEAT_NOT_DEVICE:100104,HEARTBEAT_REFRESHED_OK:i,heartBeat:function(e,n){!function(r,e){var s={},n=navigator.appVersion.includes("Electron");if(n||navigator&&navigator.connection&&"undefined"!=typeof Connection)if(console.log("Connection details"),n||navigator.connection.type!=Connection.NONE)if("undefined"==typeof Visualforce){b.log("Visualforce not currently defined");var a=window.location.pathname;$j.get(a).done(function(e){b.log("Startpage re-fetched",a);var t=new RegExp('"(\\S+VFRemote.js)"').exec(e);if(t[0]){var n=t[1];$j.getScript(n).done(function(){b.log("remote script fetched",n),new Function($j("script")[2].innerHTML)(),b.log("set up Visualforce ref"),c(r)}).fail(function(e,n,o){b.errorAndDispatch("vfRemote Load Error",t[0],o),s.status=L,r(s)})}else b.errorAndDispatch("heartBeat Could not find VFRemote src",a),s.status=L,r(s)}).fail(function(e,n,o){b.errorAndDispatch("Startpage Load Error",a,o),s.status=L,r(s)})}else c(r);else s.status=100103,r(s);else localStorage.connection?s.status=localStorage.connection:s.status=100104,r(s)}(e)},handleRefreshResponse:function(e){return g(e)},createUpdateJson:D}}),s("mobileCaddy/connSessUtils",function(V,n,o){var a="mc_failure_tab_";var h=100200;function t(a,g,y){var o=V("mobileCaddy/syncRefresh"),t=V("mobileCaddy/appDataUtils"),r=V("mobileCaddy/connSessUtils"),i=V("mobileCaddy/smartStoreUtils"),c=V("mobileCaddy/logger");console.debug("csStatusCheck -> "+a);try{var u;t.getCachedCurrentValueFromAppSoup("syncRefreshVersion").then(function(e){return u=e,o.buildConnectionSession(u,"Status Check","M2P SC Status Check Requested",1,1,null)}).then(function(_){o.heartBeat(function(n){var s;n.status==o.HEARTBEAT_OK||n.status==o.HEARTBEAT_NOT_DEVICE||n.status==o.HEARTBEAT_REFRESHED_OK?t.getCachedCurrentValueFromAppSoup("audId").then(function(n){s=n;var o=function(n,o){var S;o.status?((S=JSON.parse(n)).cs_fc_jr&&(S.cs_fc_jr=JSON.parse(S.cs_fc_jr)),console.debug("Parse json status check done"),"Received Processed"==S.cs_fc_sc?function(o,t,n,r){var s=V("mobileCaddy/connSessUtils"),a=V("mobileCaddy/logger"),i=V("mobileCaddy/smartStoreUtils");try{l(t.cs_fc_jr,function(e){o.connSessionRec.mobilecaddy1__Mobile_Process_Status__c="M2P SC - Status Check Processed",o.connSessionRec.SystemModstamp=(new Date).getTime(),o.connSessionRec.mobilecaddy1__Status__c="Closed",o.connSessionRec.Id=t.cs_sc_sf,i.queryMobileTable("Connection_Session__mc","Id",t.cs_fc_jr.cp).then(function(e){if(e[0]){var n=e[0];return console.log("m2pCsObject",n),n.Id=t.cs_fc_jr.csId,n.SystemModstamp=(new Date).getTime(),n.mobilecaddy1__Mobile_Process_Status__c="M2P Records Processed",s.postProcessConnectionSession([o.connSessionRec,n])}return Promise.resolve()}).then(function(){n({status:h})}).catch(function(e){r(e)})},r)}catch(e){a.errorAndDispatch("processM2PUpdateResponse",e),r("processM2PUpdateResponse-error")}}(_,S,g,y):function(e,o,t){console.log("clearRTSRecs",e);var n=V("mobileCaddy/smartStoreUtils"),r=cordova.require("com.salesforce.plugin.smartstore");n.queryMobileTable("recsToSync","Current_Connection_Session",e,function(e){if(0!==e.length){for(var n=0;n<e.length;n++)e[n].Current_Connection_Session=null,"InsertUpdate"==e[n].CRUD_Operation?e[n].CRUD_Operation="Insert":"UpdateUpdate"==e[n].CRUD_Operation&&(e[n].CRUD_Operation="Update");r.upsertSoupEntries("recsToSync",e,o,t)}else o()},t)}(a,function(){i.queryMobileTable("Connection_Session__mc","mobilecaddy1__MC_Proxy_ID__c",a,function(n){if(0<n.length){var o=n[0];"Received Not Processed"==S.cs_fc_sc?(u=o,l=_,d=S,f=g,p=y,m=V("mobileCaddy/connSessUtils"),u.mobilecaddy1__Mobile_Process_Status__c="M2P UP Failed - RTS Cleared",u.mobilecaddy1__Session_Type__c="Sync Update",u.mobilecaddy1__Status__c="Closed",u.SystemModstamp=(new Date).getTime(),u.Id=d.cs_fc_sf,m.postProcessConnectionSession(u).then(function(){l.connSessionRec.mobilecaddy1__Mobile_Process_Status__c="M2P SC - Status Check Processed",l.connSessionRec.SystemModstamp=(new Date).getTime(),l.connSessionRec.mobilecaddy1__Status__c="Closed",l.connSessionRec.Id=d.cs_sc_sf,m.postProcessConnectionSession(l.connSessionRec,function(){f({status:h})},p)}).catch(function(e){p(e)})):(t=o,r=_,s=S,a=g,i=y,c=V("mobileCaddy/connSessUtils"),V("mobileCaddy/smartStoreUtils").deleteRecordsFromSoup([t],"Connection_Session__mc",function(n){r.connSessionRec.mobilecaddy1__Mobile_Process_Status__c="M2P SC - Status Check Processed",r.connSessionRec.SystemModstamp=(new Date).getTime(),r.connSessionRec.mobilecaddy1__Status__c="Closed",r.connSessionRec.Id=s.cs_sc_sf,r.connSessionRec.mobilecaddy1__Session_Type__c="Status Check",c.postProcessConnectionSession(r.connSessionRec).then(function(){a({status:h})}).catch(function(){i(e)})},i))}else g({status:h});var t,r,s,a,i,c,u,l,d,f,p,m},y)},y)):(c.error("csStatusCheck",o.message),g({status:100201}))},t=_.connSessJson,r=localStorage.getItem("lastErrorLog");r&&(localStorage.removeItem("lastErrorLog"),(t=JSON.parse(t)).lastErrorLog=r,t=JSON.stringify(t)),!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/mobilecaddy1/m2pCSStatusCheck001",contentType:"application/json",data:{audId:s,syncRefreshDataVersion:u,statusCheckCSProxyId:a,connSessJson:t,startPageControllerVersion:mobileCaddy.START_PAGE_CONTROLLER_VSN}},function(e,n){console.info("response -> "+JSON.stringify(e)),void 0===n&&(n={status:"200"}),o(e,n)},function(e){c.error("err -> "+JSON.stringify(e)),y(e)}):Visualforce.remoting.Manager.invokeAction("mobilecaddy1."+mobileCaddy.START_PAGE_CONTROLLER+".m2pCSStatusCheck",s,u,a,t,o,{buffer:!1,escape:!1,timeout:3e4})}).catch(function(e){y(e)}):r.cleanConnectionSessionHeartBeat(n,_,function(e){g({status:h,mc_add_status:e.mc_add_status})},y)},y)}).catch(function(e){y(e)})}catch(e){c.errorAndDispatch(e)}}function l(f,e,p,m){m||(m=p,p=e,e="{}");var S=V("mobileCaddy/smartStoreUtils"),g=(cordova.require("com.salesforce.plugin.smartstore"),V("mobileCaddy/logger")),y=V("mobileCaddy/vsnUtils"),h=1;console.debug("processM2PUpdateResponse",f,e);var a,i,c,u,b=f.mt,C=void 0!==f.is?f.is:[],n=void 0!==f.id?f.id:[],R=void 0!==f.us?f.us:[],T=void 0!==f.ifmf?f.ifmf:[],v=void 0!==f.ufmf?f.ufmf:[],E=[],I=[],N=[],P=[],D=[],O=[],U=[],M=[],w=[],A=[],L=[];if(C=C.concat(n),j(b,f.af,C,R),void 0===f.if)A=[];else if(void 0===f.if.if)A=f.if;else{h=2;var o=f.if.if.map(function(e){return{pd:e,fbe:void 0!==f.ifbe?f.ifbe:"K"}}),t=f.if.ifv.map(function(e){return{pd:e,fbe:void 0!==f.ifvbe?f.ifvbe:"K"}}),r=f.if.icv.map(function(e){return{pd:e,fbe:void 0!==f.icvbe?f.icvbe:"K"}});A=o.concat(t.concat(r))}(a=e,i=C,c=A,u=T,new Promise(function(e,n){var o=V("mobileCaddy/smartStoreUtils");a=JSON.parse(a);var t=c.concat(u),r=c;if(a.records&&a.records.length>i.length+t.length){var s=[];o.getProxyFieldName(a.MobileTable).then(function(o){a.records.forEach(function(e){if("I"==e.RecordCRUD){var n=e.fields.find(function(e){return e.name==o}).value;_.findWhere(i,{pd:n})||_.findWhere(t,{pd:n})||s.push({pd:n,fbe:"K"})}}),0<s.length&&(r=c.concat(s)),e(r)})}else e(r)})).then(function(e){if(A=e,void 0===f.uf)L=[];else if(void 0===f.uf.uf)L=f.uf;else{h=2;var n=f.uf.uf.map(function(e){return{Id:e,fbe:void 0!==f.ufbe?f.ufbe:"K"}}),o=f.uf.usv.map(function(e){return{Id:e,fbe:void 0!==f.usvbe?f.usvbe:"K"}}),t=f.uf.sdf.map(function(e){return{Id:e,fbe:void 0!==f.sdfbe?f.sdfbe:"K"}}),r=f.uf.hdf.map(function(e){return{Id:e,fbe:void 0!==f.hdfbe?f.hdfbe:"K"}}),s=f.uf.ufv.map(function(e){return{Id:e,fbe:void 0!==f.ufvbe?f.ufvbe:"K"}}),a=f.uf.ucv.map(function(e){return{Id:e,fbe:void 0!==f.ucvbe?f.ucvbe:"K"}});L=n.concat(o.concat(t.concat(r.concat(s.concat(a)))))}return d("SnapShot_"+b)}).then(function(e){return w=e,d(b)}).then(function(d){console.debug("priRecords -> "+JSON.stringify(d)),S.queryMobileTable("recsToSync","Mobile_Table_Name",b,function(e){for(var n in e)if(console.debug("recsToSyncRec[i] = "+JSON.stringify(e[n])),e[n].Current_Connection_Session==f.cp){var o=!1,t={},r={};switch(e[n].CRUD_Operation){case"Insert":case"InsertUpdate":for(var s in C)if(e[n].Id==C[s].pd){if(C[s].crud=e[n].CRUD_Operation,r=F(C[s],d),"Insert"==e[n].CRUD_Operation){switch(f.stbe){case"D":U.push(r),M.push(C[s]);break;default:if("U"==C[s].pc){if(r.Id=C[s].Id,void 0!==C[s].an&&(void 0!==C[s].nf?r[C[s].nf]=C[s].an:r.Name=C[s].an),void 0!==C[s].lu)for(var a in C[s].lu)C[s].lu.hasOwnProperty(a)&&console.debug("prop",a,C[s].lu[a]),r[a]=C[s].lu[a];P.push(r),O.push(r)}}I.push(e[n]._soupEntryId)}else{if(r.Id=C[s].Id,void 0!==C[s].an&&(void 0!==C[s].nf?r[C[s].nf]=C[s].an:r.Name=C[s].an),void 0!==C[s].lu)for(var i in C[s].lu)C[s].lu.hasOwnProperty(i)&&console.debug("iUProp",i,C[s].lu[i]),r[i]=C[s].lu[i];P.push(r);var c=F(C[s],w);c.Id=C[s].Id,O.push(c),(t=e[n]).Current_Connection_Session=null,t.CRUD_Operation="Update",t.Id=C[s].Id,E.push(t)}o=!0;break}if(!o)for(s in A)if(console.info("failure",e[n].Id,A[s].pd),e[n].Id==A[s].pd){if(A[s].crud=e[n].CRUD_Operation,"Insert"==e[n].CRUD_Operation)switch("K",1==h?x(0,A[s].fl,f):A[s].fbe){case"K":(t=e[n]).Current_Connection_Session=null,E.push(t);break;case"R":break;default:r=F(A[s],d),U.push(r),I.push(e[n]._soupEntryId),M.push(A[s])}else"InsertUpdate"==e[n].CRUD_Operation&&((t=e[n]).Current_Connection_Session=null,t.CRUD_Operation="Insert",E.push(t));o=!0;break}if(!o)for(s in T)if(e[n].Id==T[s].pd){if(T[s].crud=e[n].CRUD_Operation,"Insert"==e[n].CRUD_Operation)switch(T[s].fbe){case"K":(t=e[n]).Current_Connection_Session=null,E.push(t);break;case"R":break;default:r=F(T[s],d),U.push(r),I.push(e[n]._soupEntryId),M.push(T[s])}else"InsertUpdate"==e[n].CRUD_Operation&&((t=e[n]).Current_Connection_Session=null,t.CRUD_Operation="Insert",E.push(t));o=!0;break}break;case"Update":case"UpdateUpdate":for(s in R)if(e[n].Id==R[s].Id){if(R[s].crud=e[n].CRUD_Operation,"Update"==e[n].CRUD_Operation){switch(r=F(R[s],d),f.stbe){case"D":U.push(r),M.push(R[s]);break;default:if("M"==R[s].pc&&(r.SystemModstamp=new Date(R[s].sm)),void 0!==R[s].lu)for(var u in console.debug("lu",R[s].lu),R[s].lu)R[s].lu.hasOwnProperty(u)&&(r[u]=R[s].lu[u]);N.push(r),D.push(r)}I.push(e[n]._soupEntryId)}else"UpdateUpdate"==e[n].CRUD_Operation&&((t=e[n]).Current_Connection_Session=null,t.CRUD_Operation="Update",E.push(t));o=!0;break}if(!o)for(s in L)if(e[n].Id==L[s].Id){if("Update"==e[n].CRUD_Operation)switch("K",1==h?x(1,L[s].fl,f):L[s].fbe){case"K":(t=e[n]).Current_Connection_Session=null,E.push(t);break;case"R":break;default:r=F(L[s],d),U.push(r),I.push(e[n]._soupEntryId),M.push(L[s])}else"UpdateUpdate"==e[n].CRUD_Operation&&((t=e[n]).Current_Connection_Session=null,t.CRUD_Operation="Update",E.push(t));o=!0;break}if(!o)for(s in v)if(e[n].Id==v[s].Id){if(v[s].crud=e[n].CRUD_Operation,"Update"==e[n].CRUD_Operation)switch(v[s].fbe){case"K":(t=e[n]).Current_Connection_Session=null,E.push(t);break;case"R":break;default:r=F(v[s],d),U.push(r),I.push(e[n]._soupEntryId),M.push(v[s])}else"UpdateUpdate"==e[n].CRUD_Operation&&((t=e[n]).Current_Connection_Session=null,t.CRUD_Operation="Update",E.push(t));o=!0;break}}}var l;console.info("priToInsertRecs",P),console.info("rtsToUpdateRecs",E),S.getProxyFieldName(b).then(function(e){return l=e,k(b,"Id",N)}).then(function(e){return console.debug("m2pRespUpRecs ("+b+") res -> "+JSON.stringify(e)),k(b,l,P)}).then(function(e){return console.debug("m2pRespUpRecs"+b+") (PROXY KEY) res -> "+JSON.stringify(e)),k("SnapShot_"+b,"Id",D)}).then(function(e){return console.debug("m2pRespUpRecs"+b+") (PROXY KEY) res -> "+JSON.stringify(e)),k("SnapShot_"+b,l,O)}).then(function(e){return console.debug("m2pRespUpRecs (SnapShot_"+b+") res -> "+JSON.stringify(e)),J(b,U)}).then(function(e){return console.debug("m2pRespDelRecs res -> "+JSON.stringify(e)),J("SnapShot_"+b,M)}).then(function(e){return console.debug("m2pRespDelRecs (SnapShot_' + mobileTable + ') res -> "+JSON.stringify(e)),t=E,r=cordova.require("com.salesforce.plugin.smartstore"),console.debug("m2pRespUpRTSRecs recsToUp -> "+JSON.stringify(t)),new Promise(function(n,o){0<t.length?r.upsertSoupEntries("recsToSync",t,function(e){n(e)},function(e){o(e)}):n("OK")});var t,r}).then(function(e){return console.debug("m2pRespUpRTSRecs res -> "+JSON.stringify(e)),t=I,r=cordova.require("com.salesforce.plugin.smartstore"),console.debug("m2pRespDelRTSRecs recsToDel -> "+JSON.stringify(t)),new Promise(function(n,o){0<t.length?r.removeFromSoup("recsToSync",t,function(e){n(e)},function(e){o(e)}):n("OK")});var t,r}).then(function(e){return console.debug("m2pRespDelRTSRecs res -> "+JSON.stringify(e)),y.checkForMigrateToInfo(f)}).then(function(){var e={status:0};e.csId=f.csId,p(e)}).catch(function(e){g.errorAndDispatch("m2pResp error for "+b,e),m(e)})},m)}).catch(function(e){g.errorAndDispatch("Err reading table",b),m(e)})}function F(e,n){var o={};return"Insert"==e.crud||"InsertUpdate"==e.crud?o.Id=e.pd:o.Id=e.Id,_.findWhere(n,o)}function x(e,n,o){switch(e){case 0:switch(n){case"DF":return o.ifbe;case"CV":return o.icvbe;case"FV":return o.ifvbe}break;case 1:switch(n){case"DF":return o.ufbe;case"SV":return o.usvbe;case"CV":return o.ucvbe;case"FV":return o.ufvbe;case"SD":return o.sdfbe;case"HD":return o.hdfbe}}}function d(e){var t=V("mobileCaddy/smartStoreUtils");return new Promise(function(n,o){t.querySoupRecords(e,function(e){n(e)},function(e){o(e)})})}function k(e,t,r){var s=cordova.require("com.salesforce.plugin.smartstore");return console.debug("m2pRespUpRecs ("+e+") updateRecs -> "+JSON.stringify(r)),new Promise(function(n,o){0<r.length?s.upsertSoupEntriesWithExternalId(e,r,t,function(e){n(e)},function(e){o(e)}):n("OK")})}function J(e,r){console.debug("m2pRespDelRecs ("+e+") recsToDel -> "+JSON.stringify(r));var s=V("mobileCaddy/smartStoreUtils"),a=V("mobileCaddy/logger");return new Promise(function(n,o){if(0<r.length)if(-1==e.indexOf("SnapShot"))s.deleteRecordsFromSoup(r,e,function(e){n(e)},function(e){o(e)});else{console.debug("Deleting from SnapShot ",e);var t=[];r.forEach(function(e){null!=e&&("Insert"==e.crud&&(e.Id=e.pd),t.push(e))}),s.deleteRecordsForExternalId(e,t,"Id",function(e){n(e)},function(e){a.errorAndDispatch(e),o(e)})}else n("OK")})}var u=100600;function f(e,n,o,t){console.log("in clean connection session heart beat");V("mobileCaddy/smartStoreUtils");var r=V("mobileCaddy/syncRefresh"),s=cordova.require("com.salesforce.plugin.smartstore"),a=V("mobileCaddy/logger"),i={},c=null;e.status==r.HEARTBEAT_NO_CONNECTION?"Sync - Refresh"==n.connSessionRec.mobilecaddy1__Session_Type__c?c="P2M RE Heartbeat No Connection":"Status Check"==n.connSessionRec.mobilecaddy1__Session_Type__c&&(c="M2P SC Heartbeat No Connection"):e.status==r.HEARTBEAT_EXCEPTION?"Sync - Refresh"==n.connSessionRec.mobilecaddy1__Session_Type__c?c=e.bogus?"P2M RE Exception/Timeout":"P2M RE Heartbeat Exception/Timeout":"Status Check"==n.connSessionRec.mobilecaddy1__Session_Type__c&&(c=e.bogus?"M2P SC Exception/Timeout":"M2P SC Heartbeat Exception/Timeout"):e.status==r.HEARTBEAT_FAILURE&&("Sync - Refresh"==n.connSessionRec.mobilecaddy1__Session_Type__c?c=e.bogus?"P2M RE Failure":"P2M RE Hearbeat Failure":"Status Check"==n.connSessionRec.mobilecaddy1__Session_Type__c&&(c=e.bogus?"M2P SC Failure":"M2P SC Heartbeat Failure")),null!==c?(n.connSessionRec.mobilecaddy1__Mobile_Process_Status__c=c,n.connSessionRec.SystemModstamp=(new Date).getTime(),n.connSessionRec.mobilecaddy1__Status__c="Closed",console.log("Upserting connection session"),s.upsertSoupEntries("Connection_Session__mc",[n.connSessionRec],function(){i.status=u,i.mc_add_status=e.status,o(i)},t)):(a.error("Unknown heartBeatObject.status. ",e.status),t())}function r(e){return e?localStorage.getItem(a+e)?JSON.parse(localStorage.getItem(a+e)):{}:(n=s(),o=[],n.forEach(function(e){var n=r(e.replace(a,""));_.isEmpty(n)||o.push({table:e.replace(a,""),failures:n})}),o);var n,o}function s(){for(var e=[],n=0,o=localStorage.length;n<o;++n)localStorage.key(n).startsWith(a)&&e.push(localStorage.key(n));return e}function j(e,n,o,t){var r={};if(localStorage.getItem("mcM2pMoreToSync")){if(localStorage.getItem(a+e)){localStorage.getItem(a+e);r=JSON.parse(localStorage.getItem(a+e)),o.forEach(function(e){delete r[e.pd]}),t.forEach(function(e){delete r[e.Id]})}}else localStorage.removeItem(a+e),r={};if(n){var s={};n.forEach(function(e){s[e.Id]=e,r[e.Id]=e}),console.log("oldFail",r),console.log("tmpFail",s),localStorage.setItem("tmpFailedRecordsAccum",JSON.stringify(s))}0<Object.keys(r).length?localStorage.setItem(a+e,JSON.stringify(r)):localStorage.removeItem(a+e)}o.exports={getRTSPendingconnSess:function(e,n){var i,c;i=e,c=n,V("mobileCaddy/smartStoreUtils").querySoupRecords("recsToSync",function(e){console.debug("recsToSync -> "+JSON.stringify(e));for(var n=null,o=null,t=0;t<e.length;t++)if(console.debug("recsToSync["+t+"] -> "+JSON.stringify(e[t])),null!==e[t].Current_Connection_Session&&void 0!==e[t].Current_Connection_Session){n=e[t].Current_Connection_Session,o=e[t];break}if(null!=n){var r=(new Date).getTime(),s=o._soupLastModifiedDate+3e4;if(s<r)console.debug("timeNow > timeoutTs",r,s),console.debug("We have a timedout Conn_Sess",n),i(n);else{console.debug("We have a SYNC_ALREADY_IN_PROGRESS",n);var a={status:100498};c(a)}}else console.debug("getRTSPendingconnSess - All clear"),i(n)},c)},CLEAN_CS_OK:u,cleanConnectionSessionHeartBeat:function(e,n,o,t){f(e,n,o,t)},cleanConnectionSessionVFEvent:function(e,n,o,t){var r,s,a,i,c,u;r=e,s=n,a=o,i=t,c=V("mobileCaddy/syncRefresh"),u={bogus:!0},"exception"===r.type?u.status=c.HEARTBEAT_EXCEPTION:u.status=c.HEARTBEAT_FAILURE,f(u,s,a,i)},CONN_SESS_OK:h,csStatusCheck:function(e,n,o){t(e,n,o)},maybeSyncConnSess:function(e,n,o){var t,r,s,a,i,c,u;t=e,r=n,s=o,a=mobileCaddy.require("mobileCaddy/devUtils"),i=V("mobileCaddy/smartStoreUtils"),c=V("mobileCaddy/logger"),u={},console.debug("maybeSyncConnSess"),i.querySoupRecsPromise("recsToSync").then(function(e){console.debug("Success from readRecords recsToSync -> "+JSON.stringify(e));var n=_.filter(e,function(e){return void 0!==e.currentConnectionSession});console.debug("connSessRTS -> "+JSON.stringify(n)),1<n.length||"M2P Conn_Sess Records Processed"!=t.mobilecaddy1__Mobile_Process_Status__c?a.syncMobileTable("Connection_Session__mc").then(function(e){console.debug("syncMobileTable -> ",JSON.stringify(e)),u.status=0,r(u)}).catch(function(e){c.warn("syncMobileTable ERROR -> ",e),s(e)}):(console.debug("maybeSyncConnSess - not syncing"),u.status=0,r(u))}).catch(function(e){c.error("querySoupRecsPromise ERROR -> ",e),s(e)})},processM2PUpdateResponse:function(e,n,o,t){l(e,n,o,t)},postProcessConnectionSession:function(e){return c=e,new Promise(function(o,n){var t=cordova.require("com.salesforce.plugin.smartstore"),r=V("mobileCaddy/logger"),s=function(e){r.error("postProcessConnectionSession error",e),n(e)},a=Array.isArray(c)?c:[c],i={};t.upsertSoupEntries("Connection_Session__mc",a,function(e){var n=Array.isArray(c);n=a.map(function(e){return{Id:e.Id,SystemModstamp:e.SystemModstamp-1,mobilecaddy1__Session_Type__c:null,mobilecaddy1__Mobile_Process_Status__c:null,mobilecaddy1__Session_Created_Location_Error__c:null,mobilecaddy1__MC_Proxy_ID__c:null}}),t.upsertSoupEntries("SnapShot_Connection_Session__mc",n,function(e){var n=e.map(function(e){return{Mobile_Table_Name:"Connection_Session__mc",CRUD_Operation:"Update",SOUP_Record_Id:e._soupEntryId,Id:e.Id,LastModifiedDateTime:e.SystemModstamp}});t.upsertSoupEntries("recsToSync",n,function(){console.log("success from upsert of recs to sync"),i.status=0,o(i)},s)},s)},s)});var c},handleUpdatedCS:function(e){return r=e,new Promise(function(n,e){var o=mobileCaddy.require("mobileCaddy/smartStoreUtils"),t=V("mobileCaddy/logger");console.log("handleUpdatedCS",r),r&&r.us&&0!==r.us.length?o.deleteRecordsForExternalId("Connection_Session__mc",r.us,"Id").then(function(e){return o.deleteRecordsForExternalId("SnapShot_Connection_Session__mc",r.us,"Id")}).then(function(e){return o.deleteRecordsForExternalId("recsToSync",r.us,"Id")}).then(function(e){console.log("handleUpdatedCS -> deleted from CS and RTS OK"),n()}).catch(function(e){t.error("handleUpdatedCS",e),n()}):n(),r&&r.uf&&0!==r.uf.length&&t.error("handleUpdatedCS -> we have uf",r.uf)});var r},getSyncRecFailures:function(e){return r(e)},_getSyncFailureTableKeys:function(){return s()},_storeSyncFailures:function(e,n,o,t){return j(e,n,o,t)}}}),s("mobileCaddy/vsnUtils",function(n,e,o){var s=mobileCaddy.require("mobileCaddy/devUtils"),S=(cordova.require("com.salesforce.plugin.smartstore"),mobileCaddy.require("mobileCaddy/smartStoreUtils")),a=n("mobileCaddy/connSessUtils"),g=n("mobileCaddy/appDataUtils"),y=n("mobileCaddy/logger"),t=["recsToSync"];function r(e,n){return new Promise(function(o,n){null===e?S.listMobileTables(S.ALPHA,function(e){var n=t;_.each(e,function(e){n.push(e),n.push("SnapShot_"+e),localStorage.removeItem("meta-tableDEF-"+e),localStorage.removeItem("meta-tableCRUD-"+e)}),console.debug("allTables",n),o(n)},function(e){n(e)}):o([])})}function i(o,e){return new Promise(function(e,n){r(o).then(function(e){return Promise.all(e.map(S.deleteSoup))}).then(function(){e()}).catch(function(e){y.error(e),n(e)})})}function c(m){return new Promise(function(u,l){var d={},f=m?"Version Upgrade":"HardReset",p="";n("mobileCaddy/syncRefresh");s.readRecords("appSoup").then(function(e){return e.records.forEach(function(e){d[e.Name]=e.CurrentValue}),console.info("appSoupRecs",JSON.stringify(d)),i(null)}).then(function(){p=h(d),console.log("resetURL",p);var n="";console.debug("deletedSoups OK");var e,o,t="localhost:3030"==window.location.host?"codeflow":"undefined"!=typeof mockStore?navigator.appVersion.includes("Electron")?"desktop":"platform":"device";"codeflow"==t&&(e=localStorage.getItem("forceOAuth"),o=localStorage.getItem("appSoup"));var r="lsItemsToPersist";if(m&&localStorage.getItem(r)){var s=JSON.parse(localStorage.getItem(r)).map(function(e){return{key:e,value:localStorage.getItem(e)}});s.push({key:r,value:localStorage.getItem(r)}),console.log(r,s),localStorage.clear(),s.forEach(function(e){localStorage.setItem(e.key,e.value)})}else localStorage.clear();if("codeflow"==t)localStorage.setItem("forceOAuth",e),localStorage.setItem("appSoup",o),n=window.location.protocol+"//"+window.location.host+"/www",u("ok");else if("platform"==t)n=window.location.href.substr(0,window.location.href.indexOf("#"));else{var a,i="";if(navigator&&navigator.connection&&(i=navigator.connection.type),window.device&&(a=window.device),navigator.appVersion.includes("Electron")){a=ipcRenderer.sendSync("request-device-info",""),i="wifi";var c="landscape"}n=p+"?deviceUuid="+a.uuid+"&deviceName="+a.name+"&deviceCordova="+a.cordova+"&deviceVersion="+a.version+"&deviceModel="+a.model+"&buildName="+d.buildName+"&buildVersion="+d.buildVersion+"&buildOS="+d.buildOS+"&knownAud="+d.audId+"&currentDv="+d.dynVersionNumber+"&orientation="+c+"&viewportWidth="+$j(window).width()+"&viewportHeight="+$j(window).height()+"&sessionType="+f+"&connType="+i+"&loginUrl="+d.loginUrl+"&millsFromEpoch="+(new Date).getTime()}g.updateNewValueInAppSoup("buildStatus","Resetting").then(function(){console.info("AppSoup Updated for reset"),S.deleteSoup("syncLib_system_data").then(function(e){console.log("Redirecting to: "+n);try{window.location.href=n}catch(e){y.errorAndDispatch("error on redirect",e),l(e)}u()}).catch(function(e){y.errorAndDispatch(e)}),u()}).catch(function(e){y.errorAndDispatch(e),l(e)})}).catch(function(e){y.errorAndDispatch(e),l(e)})})}function h(e){var n="/apex/mobilecaddy1__MobileCaddyBootstrap001_mc";switch(e.platAuthUrl){case"i":case"I":resetURL=e.instanceUrl+n;break;case"l":case"L":resetURL=e.loginUrl+n;break;case"":resetURL=void 0;break;default:resetURL=e.platAuthUrl}return resetURL||(e.authURLType||(e.authURLType="login"),resetURL="login"==e.authURLType?e.loginUrl+n:e.instanceUrl+n),resetURL}function u(){return new Promise(function(n,o){mobileCaddy.require("mobileCaddy/smartStoreUtils").queryMobileTable("appSoup","Name","dynVersionNumber").then(function(e){void 0!==e[0].NewValue&&e[0].NewValue!=e[0].CurrentValue?n(!0):n(!1)}).catch(function(e){y.error(e),o(e)})})}o.exports={checkForMigrateToInfo:function(e){return o=e,t=n("mobileCaddy/appDataUtils"),new Promise(function(e,n){null!==o.migrateTo&&void 0!==o.migrateTo?t.updateNewValueInAppSoup("dynVersionNumber",o.migrateTo).then(function(){e()}).catch(function(e){y.error(e),n(e)}):e()});var o,t},clearSoups:function(e,n){return i(e)},getSoupsToClear:function(e,n){return r(e)},hardReset:function(){return c()},upgradeAvailable:function(){return u()},upgradeIfAvailable:function(e){return r=e,new Promise(function(o,t){u().then(function(e){if(e&&"force"==r)return c(!0);if(e){var n="skip-failures"==r?a.getSyncRecFailures():null;s.dirtyTables(n).then(function(e){0<e.length?o(!1):a.getRTSPendingconnSess(function(e){if(null==e)return c(!0);o(!1)},function(e){o(!1)})}).catch(function(e){y.error(e),t(e)})}else o(!1)}).catch(function(e){y.error(e),t(e)})});var r},_getBootstrapUrl:function(e){return h(e)}}}),s("mobileCaddy/logger",function(e,n,o){cordova.require("com.salesforce.plugin.smartstore");var s=e("mobileCaddy/smartStoreUtils"),a=e("mobileCaddy/appDataUtils"),u=0;function i(){return new Promise(function(n,o){localStorage.hasLogType?n(localStorage.hasLogType):s.listMobileTableColumns("Mobile_Log__mc",s.FULL,function(e){void 0===_.find(e,{path:"mobilecaddy1__Log_Type__c"})?(localStorage.setItem("hasLogType","false"),n("false")):(localStorage.setItem("hasLogType","true"),n("true"))},function(e){o(e)})})}function l(r,e){return new Promise(function(n,o){if(1==e.length&&(e=e[0]),"object"==typeof e&&(e=JSON.stringify(e)),"number"!=typeof e&&"boolean"!=typeof e||(e=e.toString()),"string"==typeof e){r==u&&localStorage.setItem("lastErrorLog",e.substring(0,1024));var t={mobilecaddy1__Error_Text__c:e.substring(0,1024),SystemModstamp:(new Date).getTime()};a.getCachedCurrentValueFromAppSoup("audId").then(function(e){return t.mobilecaddy1__Application_User_Device__c=e,i()}).then(function(e){"true"==e&&(t.mobilecaddy1__Log_Type__c="D"+r.toString()),s.insertRecords("Mobile_Log__mc",[t],function(e){n()},function(e){o(e)})}).catch(function(e){console.error(e),o(e)})}else logger.error("Trying to log unsupported type",typeof e),o("Trying to log unsupported type"+typeof e)})}function t(e,n,o,t){var r=localStorage.getItem("logLevel");if(n<=(r=void 0===r?0:r)){var s="";if(0<n){var a=t.stack.split("\n")[4];if(void 0!==a){var i=a.indexOf("at ");s=a.slice(i+2,a.length)}}var c=o[0];switch(n){case u:o[0]&&o[0].stack?c=o[0].message+", STACK:"+o[0].stack:o[1]&&o[1].stack?c+="\n"+o[1].message+", STACK:"+o[1].stack:c=o,l(n,c),console.error.apply(console,o);break;case 1:1<=r&&(l(n,o),console.log.apply(console,o),console.log(s));break;default:2<=r&&(l(n,o),console.log.apply(console,o),console.log(s))}e&&(console.info("Dispatching error"),"undefined"!=typeof LOCAL_DEV&&LOCAL_DEV&&alert(c+"\n\nSee dev console for more information"))}}function r(){try{throw Error("")}catch(e){return e}}o.exports={debug:function(e){return t(!1,4,arguments,r())},error:function(e){return t(!1,u,arguments)},errorAndDispatch:function(e){return t(!0,u,arguments)},info:function(e){return t(!1,3,arguments,r())},log:function(e){return t(!1,2,arguments,r())},warn:function(e){return t(!1,1,arguments,r())},hasLogType:function(){return i()}}}),s("mobileCaddy/devUtils",function(g,e,n){var p=g("mobileCaddy/smartStoreUtils"),y=(g("mobileCaddy/mobileLogger"),g("mobileCaddy/logger")),c=cordova.require("com.salesforce.plugin.smartstore"),a=1,d=2,f=3,m=4,S=5,h=6,b=8,i=99,C=100400,R=C,T=100402,v=100700,E=101e3,u=101100,l=101200,I=["syncLib_system_data","appSoup","cacheSoup","recsToSync","SnapShot_Connection_Session__mc"],N=["autonumber","CreatedById","CreatedDate","IsDeleted","IsClosed","IsWon","LastModifiedById","LastModifiedDate","LastReferencedDate","mobilecaddy1__MC_Proxy_ID","MC_Proxy_ID","OwnerId","SystemModstamp","Id","dirtyFlag"];function o(a){var i="Analytics";return new Promise(function(r,n){var e=new Date,s=new Date(e.getFullYear(),e.getMonth(),e.getDate(),0,0,0,0).valueOf();new Promise(function(n,o){c.soupExists("Analytics",function(e){e?n():c.registerSoup("Analytics",[{path:"Name",type:"integer"},{path:"Data",type:"string"}],function(e){n()},function(e){o(e)})},function(e){y.error(e),o(e)})}).then(function(){return i=s,new Promise(function(n,s){var e=g("mobileCaddy/appDataUtils"),a="";e.getCurrentValueFromAppSoup("audId").then(function(e){return a=e,p.querySoupRecsPromise("Analytics")}).then(function(e){var o=[],t=[],r=[];e.forEach(function(e){if(e.Name==i)o.push(e);else{var n={Name:e.Name.toString(),SystemModstamp:e.Name,mobilecaddy1__Error_Text__c:JSON.parse(e.Data),mobilecaddy1__Application_User_Device__c:a};y.hasLogType()&&(n.mobilecaddy1__Log_Type__c="analytic"),t.push(n),r.push(e._soupEntryId)}}),0!==t.length&&p.insertRecords("Mobile_Log__mc",t,function(e){c.removeFromSoup("Analytics",r,function(e){n(o)},function(e){y.error("Unable to insert analytic recs",e),s(e)})},function(e){y.error("Unable to insert analytic recs",e),s(e)}),n(o)}).catch(function(e){y.error("Error housekeeping Analytics",e),s(e)})});var i}).then(function(e){var n={};if(0===e.length){n[a]=1;var o={Name:s,Data:JSON.stringify(n)};r(n[a]),c.upsertSoupEntries(i,[o],function(e){},function(e){y.error("Unable to insert analytic recs",e)})}else{var t=e[0];(n=JSON.parse(t.Data))[a]=void 0===n[a]?1:n[a]+1,r(n[a]),t.Data=JSON.stringify(n),c.upsertSoupEntriesWithExternalId(i,[t],"Name",function(e){},function(e){y.error(e)})}}).catch(function(e){y.error("Error in analInc",e),n(e)})})}function P(a,o,i){return console.time("MC-TIMING checkTableAccess "+a),new Promise(function(r,s){var n=function(e,n){var o=0;switch(e){case v:o=1;break;case E:o=4;break;case u:o=7;break;case l:o=10;break;default:o=0}if("Y"==n.charAt(o))console.timeEnd("MC-TIMING checkTableAccess "+a),r(i);else{var t={};t.status=e+f,t.mc_add_status=a,console.timeEnd("MC-TIMING checkTableAccess "+a),s(t)}};-1==I.indexOf(a)?localStorage["meta-tableCRUD-"+a]?n(o,localStorage["meta-tableCRUD-"+a]):p.getTableDefnColumnValue(a,"Application Record CRUD").then(function(e){localStorage["meta-tableCRUD-"+a]=e,n(o,e)}).catch(function(e){console.timeEnd("MC-TIMING checkTableAccess "+a),console.info("Opps -> "+a),s(e)}):(console.timeEnd("MC-TIMING checkTableAccess "+a),r(i))})}function t(){return new Promise(function(n,o){if(!0===USE_FORCETK){var e=force.getUserId();n(e)}else r("userId").then(function(e){n(e)}).catch(function(e){y.error("getCurrentUserId",e),o(e)})})}function r(e){return new Promise(function(n,o){g("mobileCaddy/appDataUtils").getCachedCurrentValueFromAppSoup(e).then(function(e){n(e)}).catch(function(e){y.error("getCachedAppSoupValue",e),o(e)})})}function D(n,o,e,t){if("_soupLastModifiedDate"==n)return t;var r=_.findWhere(e,{path:n}),s={};if(void 0===r)return s.status=o+d,s.mc_add_status=n,s;var a=0;switch(o){case v:a=1;break;case E:a=4;break;case u:a=7;break;default:a=0}if("Y"!=r.crud.charAt(a))return s.status=o+f,s;try{return s.value=M(t,r.appColType,r.platColType),s}catch(e){return s.status=o+S,s.mc_add_status=e+"->"+n,s}}function O(t){return console.time("MC-TIMING listMobileTableColumns "+t),new Promise(function(n,o){localStorage["meta-tableDEF-"+t]?(console.timeEnd("MC-TIMING listMobileTableColumns "+t),n(JSON.parse(localStorage["meta-tableDEF-"+t]))):p.listMobileTableColumns(t,p.FULL,function(e){localStorage["meta-tableDEF-"+t]=JSON.stringify(e),console.timeEnd("MC-TIMING listMobileTableColumns "+t),n(e)},function(e){console.timeEnd("MC-TIMING listMobileTableColumns "+t),o(e)})})}function U(e,n,o){switch(o){case"checkbox":case"Deleted":return"true"===String(e);case"CreatedDate":case"date":case"datetime":case"LastActivtyDate":case"LastModifiedDate":case"LastReferencedDate":case"LastViewedDate":case"SystemModstamp":return null===e?e:new Date(e);default:return e}}function M(e,n,o){var t=/^([\+-]?\d{4}(?!\d{2}\b))((-?)((0[1-9]|1[0-2])(\3([12]\d|0[1-9]|3[01]))?|W([0-4]\d|5[0-2])(-?[1-7])?|(00[1-9]|0[1-9]\d|[12]\d{2}|3([0-5]\d|6[1-6])))([T\s]((([01]\d|2[0-3])((:?)[0-5]\d)?|24\:?00)([\.,]\d+(?!:))?)?(\17[0-5]\d([\.,]\d+)?)?([zZ]|([\+-])([01]\d|2[0-3]):?([0-5]\d)?)?)?)?$/;switch(o){case"autonumber":throw"invalid_autonumber";case"checkbox":case"Deleted":if("boolean"==typeof e||"true"===e||"false"===e)return String(e);throw"invalid_boolean";case"date":if("string"==typeof e){if(!t.test(e))throw"invalid_date";e=new Date(e)}if(e instanceof Date)return e.setUTCHours(0),e.setUTCMinutes(0),e.setUTCSeconds(0),e.setUTCMilliseconds(0),e.valueOf();if(null===e)return null;throw"invalid_date";case"datetime":if("string"==typeof e){if(!t.test(e))throw"invalid_datetime";e=new Date(e)}if(e instanceof Date)return e.valueOf();if(null===e)return null;throw"invalid_datetime";case"email":if(function(e){if(0===e.length)return!0;var n=e.indexOf("@"),o=e.lastIndexOf(".");return!(n<1||o<n+2||o+2>=e.length)}(e))return e;throw"invalid_email";default:switch(n){case"jsString":if("string"==typeof e)return e;if("number"==typeof e)return e.toString();throw"invalid_string";case"jsNumber":if("number"==typeof e||null===e)return e;throw"invalid_number";default:return e}}}function w(r,s){return console.time("MC-TIMING tableExists "+r),new Promise(function(n,o){var t={};localStorage["meta-tableCRUD-"+r]?(console.timeEnd("MC-TIMING tableExists "+r),n()):p.listMobileTables(p.ALPHA,function(e){0<=e.concat(I).indexOf(r)?(console.timeEnd("MC-TIMING tableExists "+r),n()):(t.status=s+a,t.mc_add_status=r,console.timeEnd("MC-TIMING tableExists "+r),o(t))},function(e){t.status=s+i,t.mc_add_status="Unkonwn error "+e,console.timeEnd("MC-TIMING tableExists "+r),o(t)})})}function A(n,c,u,o,l){return new Promise(function(s,e){var a={},i={};a.status=u,L().then(function(e){return e[n]&&(i=e[n]),t()}).then(function(r){$j.each(o,function(e,t){if(delete t._soupEntryId,delete t.$$HashKey,t.RecordTypeName){if(t.RecordTypeId=i[t.RecordTypeName],_.isEmpty(i))return a.status=u+d,a.mc_add_status=t.RecordTypeName,s(a);if(!t.RecordTypeId)return a.status=u+b,a.mc_add_status=t.RecordTypeName,s(a);delete t.RecordTypeName}for(var n in t)if(t.hasOwnProperty(n)&&n!=c){if(isValidFieldRes=D(n,u,l,t[n]),isValidFieldRes.status==u+d){a.status=isValidFieldRes.status,a.mc_add_status=n;break}if(isValidFieldRes.status==u+S){a.status=isValidFieldRes.status,a.mc_add_status=n;break}if(isValidFieldRes.status==u+f){a.status=isValidFieldRes.status,a.mc_add_status=n;break}if(u==v&&0<=N.indexOf(n)){a.status=u+h,a.mc_add_status=n;break}t[n]=isValidFieldRes.value}if(a.status!=u+d&&a.status!=u+S&&a.status!=u+h){var o=(new Date).getTime();u==v&&(t.CreatedById=r,t.CreatedDate=o),t.SystemModstamp=o,t.LastModifiedDate=o,t.LastModifiedById=r,t.IsDeleted="false",$j.each(l,function(e,n){if(u==v){var o=n.crud.charAt(1);N.indexOf(n.path)<0&&"false"==n.nillable&&"Y"==o?_.has(t,n.path)||(a.status=u+m,a.mc_add_status=n.path):("IsClosed"==n.path&&(t.IsClosed="false"),"IsWon"==n.path&&(t.IsWon="false"))}""!==n.proxyRefField&&void 0!==t[n.path]&&18<t[n.path].length&&(t[n.proxyRefField]=t[n.path])})}}),a.records=o,s(a)},function(e){y.error("validateRecords",e)})})}function L(){return new Promise(function(n,o){localStorage.getItem("lsDotsRecordTypes")?n(JSON.parse(localStorage.getItem("lsDotsRecordTypes"))):p.querySoupRecords("dotsRecordTypes",function(e){console.log("querySoupRecords dotsRecordTypes",e);var o={};e.forEach(function(e){var n={};JSON.parse(e.Data).forEach(function(e){e.recTypeDevName?(n[e.recTypeId]={recTypeName:e.recTypeName,recTypeDevName:e.recTypeDevName},n[e.recTypeName]=e.recTypeId,n[e.recTypeDevName]=e.recTypeId):(n[e.recTypeId]=e.recTypeName,n[e.recTypeName]=e.recTypeId)}),o[e.Table]=n}),localStorage.setItem("lsDotsRecordTypes",JSON.stringify(o)),n(o)},function(e){y.error("Error returned from upsert, message =  "+e),o(e)})})}function V(s){return new Promise(function(r,n){x("recsToSync").then(function(e){var n=[],o=[],t={};s&&s.forEach(function(e){t[e.table]=e.failures}),e.records.forEach(function(e){"Connection_Session__mc"==e.Mobile_Table_Name||void 0!==n[e.Mobile_Table_Name]||s&&t[e.Mobile_Table_Name]&&(!t[e.Mobile_Table_Name]||t[e.Mobile_Table_Name][e.Id])||(n[e.Mobile_Table_Name]=!0,o.push(e.Mobile_Table_Name))}),r(o)}).catch(function(e){y.error(e),n(e)})})}function F(r,s){return new Promise(function(t,n){0<r.length&&-1==I.indexOf(s)?L().then(function(e){if(e[s]){var n=e[s],o=r.map(function(e){return"object"==typeof n[e.RecordTypeId]?(e.RecordTypeName=n[e.RecordTypeId].recTypeName,e.RecordTypeDevName=n[e.RecordTypeId].recTypeDevName):e.RecordTypeName=n[e.RecordTypeId],e.RecordTypeName||y.warn("enrichWithRecordTypeNames",e.RecordTypeId),e});t(o)}else t(r)}).catch(function(e){n(e)}):t(r)})}function s(t,e){var r=JSON.parse(JSON.stringify(e)),s={};return new Promise(function(n,o){w(t,v).then(function(){return O(t)}).then(function(e){return P(t,v,e)}).then(function(e){return new Promise(function(n,o){A(t,null,v,r,e).then(function(e){e.status==v?n(e.records):o(e)})})}).then(function(e){p.insertRecords(t,e,function(e){s.status=v,s.records=e,mobileCaddy.require("mobileCaddy/vsnUtils").upgradeAvailable().then(function(e){s.upgradeAvailable=e,n(s)}).catch(function(e){n(s),y.error(e)})},function(e){o(e),y.error(e)})}).catch(function(e){o(e),y.error(e)})})}function x(s,e){var a={},i="MC-TIMING readRecords "+s;return console.time(i),new Promise(function(t,r){w(s,E).then(function(){return P(s,E)}).then(function(){return O(s)}).then(function(o){p.querySoupRecords(s,function(n){(a.status=E,0<n.length)?-1==I.indexOf(s)?p.getTableDefnColumnValue(s,"Last Refresh Date/Time").then(function(e){return k(s,n,o,e,a)}).then(function(e){console.timeEnd(i),t(e)}).catch(function(e){r(e),y.error(e)}):k(s,n,o,null,a).then(function(e){console.timeEnd(i),t(e)}):(a.records=[],mobileCaddy.require("mobileCaddy/vsnUtils").upgradeAvailable().then(function(e){a.upgradeAvailable=e,console.timeEnd(i),t(a)}).catch(function(e){console.timeEnd(i),t(a),y.error(e)}))},function(e){console.timeEnd(i),r(e),y.error(e)})},function(e){console.timeEnd(i),r(e),y.error(e)})})}function k(o,t,r,s,a){return new Promise(function(n,e){$j.each(t,function(e,n){for(var o in n){var t=_.findWhere(r,{path:o});void 0!==t&&(n[o]=U(n[o],t.appColType,t.platColType),"LastModifiedDate"==o&&(n.dirtyFlag=q(n[o],s)))}}),a.records=t.filter(function(e){return"object"==typeof e}),F(a.records,o).then(function(e){return a.records=e,mobileCaddy.require("mobileCaddy/vsnUtils").upgradeAvailable()}).then(function(e){a.upgradeAvailable=e,n(a)}).catch(function(e){n(a),y.error(e)})})}function J(d,f){return new Promise(function(t,n){var r,s,a,u,l,o=cordova.require("com.salesforce.plugin.smartstore"),i={},e=/FROM\s+\{(\S*)\}/gi.exec(d),c=f||1e3;tableName=e[1],(u=tableName,l=d,new Promise(function(n,e){var o=!0,t=l.match(/SELECT\s+(.*)\s+FROM/i);"*"!==t[1]&&(o=!1);var r=l.match(/\s+FROM\s+{(.*)}\s+WHERE (.* = .*)/i);if(console.debug("m",r),null!==r&&null!==r[1]){var s=l,a=r[2].split("AND"),i={},c="";a.forEach(function(e){mWhere=e.match(/{(.*):(.*)}\s+=\s+(.*)/i),whereField=mWhere[2],c=mWhere[3].split("'")[1],i[whereField]=c}),void 0!==i.Id&&18<i.Id.length?p.getProxyFieldName(u).then(function(e){console.log("proxyFieldName",e),s=s.replace("Id} =",e+"} ="),n([s,o])}):n([s,o])}else n([l,o])})).then(function(e){var n=e[0];return a=e[1],console.debug("smartSql2",n,a),r=o.buildSmartQuerySpec(n,c),console.debug("querySpec",r),s="MC-TIMING smartRead "+tableName,console.time(s),w(tableName,E)}).then(function(){return P(tableName,E)}).then(function(){return O(tableName)}).then(function(o){p.smartQuerySoupRecordsWithQuerySpec(r,function(n){(i.status=E,0<n.length)?-1==I.indexOf(tableName)&&a?p.getTableDefnColumnValue(tableName,"Last Refresh Date/Time").then(function(e){return j(tableName,n,o,e,i)}).then(function(e){console.timeEnd(s),t(e)}):j(tableName,n,o,null,i).then(function(e){console.timeEnd(s),t(e)}):(i.records=[],mobileCaddy.require("mobileCaddy/vsnUtils").upgradeAvailable().then(function(e){i.upgradeAvailable=e,console.timeEnd(s),t(i)}).catch(function(e){console.timeEnd(s),t(i),y.error(e)}))},function(){n()})},function(e){console.timeEnd(s),n(e),y.error(e)})})}function j(t,r,i,c,u){return new Promise(function(n,e){var s=[],a=!0;$j.each(r,function(e,n){var o;if(n[1]&&"object"==typeof n[1])for(var t in o=n[1]){var r=_.findWhere(i,{path:t});void 0!==r&&(o[t]=U(o[t],r.appColType,r.platColType),"LastModifiedDate"==t&&(n[1].dirtyFlag=q(n[1][t],c)))}else o=n,a=!1;s.push(o)}),u.records=s.filter(function(e){return"object"==typeof e});var o=mobileCaddy.require("mobileCaddy/vsnUtils");a?F(u.records,t).then(function(e){return u.records=e,o.upgradeAvailable()}).then(function(e){u.upgradeAvailable=e,n(u)}).catch(function(e){n(u),y.error(e)}):o.upgradeAvailable().then(function(e){u.upgradeAvailable=e,n(u)}).catch(function(e){n(u),y.error(e)})})}function q(e,n){return n&&"null"!=n||(n=0),e.valueOf()>n}function B(t){return console.time("initialSync"),new Promise(function(s,a){if(0===t.length)s({status:C+m});else{var n={},o=g("mobileCaddy/syncRefresh");o.heartBeat(function(e){if(console.log("heartbeat call gave "+e.status),e.status==o.HEARTBEAT_OK||e.status==o.HEARTBEAT_NOT_DEVICE||e.status==o.HEARTBEAT_REFRESHED_OK){var r=[];console.debug("tableNames",JSON.stringify(t)),V().then(function(e){return console.debug("dirtyTableNames",e),e.forEach(function(e){dirtyIndex=t.indexOf(e),-1<dirtyIndex&&(r.push({table:e,status:T,mc_add_status:"Dirty records"}),t.splice(dirtyIndex,1))}),console.debug("tableNames",t),console.debug("resArr",r),function a(i,c,u){return new Promise(function(o,t){c||(c=[]),u||(u=1);var r,e,s;console.log("attemptDoInitialSync",i,c,u),(e=i,Promise.resolve(),s=[],e.reduce(function(e,n){return e.then(function(e){return e&&e[e.length-1].status!=R?Promise.resolve():(a=n,new Promise(function(n,o){var t=g("mobileCaddy/syncRefresh"),r=function(e){console.debug("innerProcessRefreshTablePromise res",e),n(e)},s={table:a};t.p2mRefreshTable(a,0,!1,1,1,null,function(e){console.debug("refreshStatusObject",e),e.status==t.P2M_REFRESH_OK?s.status=R:(s.status=e.status,s.mc_add_status=e.mc_add_status),r(s)},function(e){y.error("innerProcessRefreshTablePromise error",e),o(e)})}));var a}).then(function(e){return e&&s.push(e),s}).catch(function(e){y.errorAndDispatch(e)})},Promise.resolve())).then(function(e){if(console.debug("doInitialSync res",e),e.forEach(function(e,n){e&&(c.push(e),e.status!=R&&void 0===r&&(r=n))}),console.debug("Promise.all successAccum",c),console.timeEnd("initialSync"),void 0!==r)if(u<3){var n=i.splice(r,i.length-r);a(n,c,u+1).then(function(e){o(e)}).catch(function(e){t(e)})}else t(c);else o(c)})})}(t)}).then(function(e){console.debug("doInitialSync res",e);var n=r.concat(e).filter(function(e){return e});console.debug("Promise.all resArrFinal",n),console.timeEnd("initialSync"),s(n);var o=g("mobileCaddy/connSessUtils"),t={mobilecaddy1__Mobile_Process_Status__c:""};K().then(function(e){o.maybeSyncConnSess(t,function(){console.log("success return from maybeSyncConnSess")},function(e){a(e),y.error(e)})})}).catch(function(e){if(Array.isArray(e)){var t=r.concat(e).filter(function(e){return e});console.debug("Promise.all resArrFinal",t),console.timeEnd("initialSync"),y.error("InitialSync Failed"),H("Mobile_Log__mc").then(function(e){var n=g("mobileCaddy/connSessUtils"),o={mobilecaddy1__Mobile_Process_Status__c:""};K().then(function(e){n.maybeSyncConnSess(o,function(){console.log("success return from maybeSyncConnSess"),H("Mobile_Log__mc"),a(t)},function(e){a(e),y.error(e)})})}).catch(function(e){y.error("Failed sending Mobile Logs"),a(e)}),a(t)}else a(e),y.error(e)})}else n.status=T,n.mc_add_status=e.status,s(n),100101==n.mc_add_status||100102==n.mc_add_status?y.error(n):y.log(n)},function(e){y.error(e),n.status=T,s(n)})}})}function K(){return new Promise(function(o,n){var e="SELECT * FROM {Connection_Session__mc} WHERE {Connection_Session__mc:mobilecaddy1__Mobile_Process_Status__c} = 'P2M RE Exception/Timeout'";console.log("setinitialSyncFailCSStatus soql",e),querySpec=c.buildSmartQuerySpec(e,100),p.smartQuerySoupRecordsWithQuerySpec(querySpec,function(e){console.log("recs",JSON.stringify(e));var n=e.map(function(e){return e[1].mobilecaddy1__Mobile_Process_Status__c="P2M InitialSync Faliure",e[1]});c.upsertSoupEntries("Connection_Session__mc",n,function(e){console.log("setinitialSyncFailCSStatus update OK",e);var n=e.map(function(e){return{Id:e.Id,SystemModstamp:e.SystemModstamp-1,mobilecaddy1__Session_Type__c:null,mobilecaddy1__Mobile_Process_Status__c:null,mobilecaddy1__Session_Created_Location_Error__c:null,mobilecaddy1__MC_Proxy_ID__c:null}});c.upsertSoupEntries("SnapShot_Connection_Session__mc",n,function(e){console.log("setinitialSyncFailCSStatus update OK",e);var n=e.map(function(e){return{Mobile_Table_Name:"Connection_Session__mc",CRUD_Operation:"Insert",SOUP_Record_Id:e._soupEntryId,Id:e.Id,LastModifiedDateTime:e.SystemModstamp}});c.upsertSoupEntries("recsToSync",n,function(){o()},function(e){y.error(e)})},function(e){y.error(e)})},function(e){y.error(e)}),o()},function(e){y.error(e),n(e)})})}function H(u,l,s,a,i){l=void 0===l||l;var d=g("mobileCaddy/connSessUtils"),f=g("mobileCaddy/syncRefresh"),p=g("mobileCaddy/smartStoreUtils");g("mobileCaddy/mobileLogger");s||(s=0),a||(a=50),i||(i=!1);var m=function(e,n,o){var t={};f.p2mRefreshTable(e,s,!0,1,1,null,function(e){console.debug("refreshStatusObject",e),e.status==f.P2M_REFRESH_OK?t.status=R:(t.status=e.status,t.mc_add_status=e.mc_add_status),n(t)},o)},c=function(n,o,t){var r={};p.queryMobileTable("recsToSync","Mobile_Table_Name",n,function(e){if(0<e.length)try{f.m2pUpdateMobileTable(n,a,function(e){console.log("m2pStatusObject",e),e.status==f.M2P_UPDATE_OK&&void 0===e.mc_add_status?(s=0,r.status=0,o(r)):e.status==f.M2P_UPDATE_OK&&"more-to-sync"===e.mc_add_status?(console.log("moreToSync - Going round again"),c(n,o,t)):(r.status=e.status,r.mc_add_status=e.mc_add_status,o(r))},t)}catch(e){console.error(e)}else r.status=2,r.mc_add_status="no-sync-no-updates",o(r)},t)},S=function(n,e,o,t,r){var s={};console.log("skipP2M",i),localStorage.removeItem("mcM2pMoreToSync"),"Dynamic (Submit First/Retain)"==e||"Dynamic (Submit First/Clear)"==e?c(n,function(e){console.log("statusObject",e),!i&&(0===e.status||o&&2==e.status)?m(n,t,r):(i&&0===e.status||2==e.status?s.status=R:s.status=T,s.mc_add_status=e.mc_add_status,t(s))},r):"Submit Only"==e||"Submit & Clear"==e||"Submit & Destroy"==e?c(n,function(e){0===e.status?s.status=R:(s.status=T,s.mc_add_status=e.mc_add_status),t(s)},r):y.errorAndDispatch("Unknown sync type",e,i)};return new Promise(function(t,r){var s={},a=function(e){localStorage.removeItem("syncInProgressTime"),t(e)},i=function(e){localStorage.removeItem("syncInProgressTime"),r(e)},e="syncTime"+u,n=localStorage.getItem(e),o=(new Date).valueOf(),c=n?parseInt(n)+5e3:0;"Connection_Session__mc"!=u&&o<c?(s.status=R,s.mc_add_status="sync-too-soon",t(s)):(localStorage.setItem(e,o),localStorage.removeItem("tmpFailedRecordsAccum"),w(u,C).then(function(){f.heartBeat(function(e){if(console.log("heartbeat call gave "+e.status),e.status==f.HEARTBEAT_OK||e.status==f.HEARTBEAT_NOT_DEVICE||e.status==f.HEARTBEAT_REFRESHED_OK){var n=localStorage.getItem("syncInProgressTime"),o=(new Date).valueOf();console.log("syncInProgressTime",n,o),"Connection_Session__mc"!=u&&n&&o-12e4<n?(console.log("SYNC_ALREADY_IN_PROGRESS"),s.status=100498,i(s)):(localStorage.setItem("syncInProgressTime",o),p.getTableDefnColumnValue(u,"Sync Type").then(function(n){d.getRTSPendingconnSess(function(e){"Mobile_Log__mc"!=u?null!=e?d.csStatusCheck(e,function(e){e.status==d.CONN_SESS_OK?"Refresh Only"==n||"Refresh & Clear"==n?m(u,a,i):S(u,n,l,a,i):(s.status=R,s.mc_add_status=e.status,t(s))},function(e){y.errorAndDispatch(e),r(e)}):"Refresh Only"==n||"Refresh & Clear"==n?m(u,a,i):S(u,n,l,a,i):S(u,n,!1,a,i)},i)}).catch(function(e){i(e)}))}else s.status=T,s.mc_add_status=e.status,t(s),100101==s.mc_add_status||100102==s.mc_add_status?y.error(s):y.log(s)},i)}).catch(i))})}function W(r,e,s){var a=JSON.parse(JSON.stringify(e)),t={};return new Promise(function(n,o){0<a.length?w(r,u).then(function(){return O(r)}).then(function(e){return P(r,u,e)}).then(function(t){return new Promise(function(n,o){var e=D(s,u,t);e.status!=u+d?A(r,s,u,a,t).then(function(e){e.status==u?n(e.records):o(e)}):o(e)})}).then(function(e){p.updateRecordsWithExternalId(r,e,s,function(e){t.status=u,t.records=e,mobileCaddy.require("mobileCaddy/vsnUtils").upgradeAvailable().then(function(e){t.upgradeAvailable=e,n(t)}).catch(function(e){n(t)})},function(e){o(e),y.error(e)})},function(e){o(e),y.error(e)}):(t.status=u,t.mc_add_status="No records supplied",t.records=[],n(t),y.warn(t))})}n.exports={SYNC_OK:R,SYNC_NOK:T,SYNC_ALREADY_IN_PROGRESS:C+98,SYNC_UNKONWN_TABLE:C+a,SYNC_MANDATORY_MISSING:C+m,DELETE_RECS_OK:l,DELETE_RECS_UNKONWN_TABLE:l+a,DELETE_RECS_UNKONWN_FIELD:l+d,DELETE_RECS_ACCESS_DENIED:l+f,DELETE_RECS_MANDATORY_MISSING:l+m,INSERT_RECS_OK:v,INSERT_RECS_UNKONWN_TABLE:v+a,INSERT_RECS_UNKONWN_FIELD:v+d,INSERT_RECS_ACCESS_DENIED:v+f,INSERT_RECS_MANDATORY_MISSING:v+m,INSERT_RECS_DATATYPE_MISMATCH:v+S,INSERT_RECS_PROTECTED_FIELD:v+h,INSERT_RECS_UNKNOWN_RECORD_TYPE:v+b,READ_RECS_OK:E,READ_RECS_UNKONWN_TABLE:E+a,READ_RECS_ACCESS_DENIED:E+f,UPDATE_RECS_OK:u,UPDATE_RECS_UNKONWN_TABLE:u+a,UPDATE_RECS_UNKONWN_FIELD:u+d,UPDATE_RECS_ACCESS_DENIED:u+f,UPDATE_RECS_DATATYPE_MISMATCH:u+S,UPDATE_RECS_UNKNOWN_ID:u+7,UPDATE_RECS_UNKNOWN_RECORD_TYPE:u+b,GET_REC_TYPES_UNKONWN_TABLE:101300+a,analInc:function(e){return o(e)},deleteRecord:function(e,n,o){return r=e,s=[n],a=o,c={},new Promise(function(o,t){0<s.length?w(r,l).then(function(){return O(r)}).then(function(e){return P(r,l,e)}).then(function(t){return new Promise(function(n,o){var e=D(a,l,t);e.status!=l+d?A(r,a,l,s,t).then(function(e){e.status==l?n(e.records):(o(e),y.error(e))}):(o(e),y.error(e))})}).then(function(e){return p.queryMobileTable(r,a,s[0][a])}).then(function(e){if(0===e.length)c.status=l+m,y.warn("deleteRecord no record found",r),c.mc_add_status="no record found",t(c);else{if(!(e[0].Id.length<19))return i=e,p.querySoupRecsPromise("recsToSync");c.status=l+f,y.warn("deleteRecord Cannot delete synced records"),c.mc_add_status="Cannot delete synced records",t(c)}}).then(function(e){console.debug("tableName",r),console.debug("recsToDelete",i),console.debug("rts recs",e);var n=e.reduce(function(e,n){return n.Mobile_Table_Name==r&&_.findWhere(i,{_soupEntryId:n.SOUP_Record_Id})&&e.push({_soupEntryId:n._soupEntryId}),e},[]);console.debug("rtsRecSoupIds",n),p.deleteRecordsFromSoup(i,r,function(){p.deleteRecordsFromSoup(n,"recsToSync",function(){c.status=l,c.records=i,o(c)},function(e){t(e)})},function(e){t(e)})}).catch(function(e){t(e)}):(c.status=l,y.warn("deleteRecord No records supplied"),c.mc_add_status="No records supplied",c.records=[],o(c))});var r,s,a,i,c},dirtyTables:function(e){return V(e)},syncMobileTable:function(e,n,o,t,r){return H(e,n,o,t,r)},initialSync:function(e){return B(e)},getCurrentUserId:function(){return t()},getCurrentUserName:function(){return t="",new Promise(function(n,o){r("userFirstName").then(function(e){return t=e,r("userLastName")}).then(function(e){n(t+" "+e)}).catch(function(e){y.error("getCurrentUserName",e),o(e)})});var t},getUserLocale:function(){return r("userLocale")},getCachedAppSoupValue:function(e){return r(e)},getRecordTypes:function(e){return t=e,new Promise(function(n,o){w(t,101300).then(function(){return L()}).then(function(e){n(e[t])}).catch(function(e){o(e)})});var t},insertRecord:function(e,n){return s(e,[n])},insertRecords:function(e,n){return s(e,n)},logout:function(){return console.log("Logout requested"),localStorage.clear(),void(navigator.appVersion.includes("Electron")?ipcRenderer.sendSync("logout",""):cordova.require("com.salesforce.plugin.sfaccountmanager").logout())},readRecords:function(e,n){return x(e)},smartSql:function(e,n){return J(e,n)},updateRecord:function(e,n,o){return W(e,[n],o)},updateRecords:function(e,n,o){return W(e,n,o)},maybeReadTransformType:function(e,n,o){return U(e,0,o)},maybeWriteTransformType:function(e,n,o){return M(e,n,o)}}}),window.mobileCaddy=r("mobileCaddy")}();