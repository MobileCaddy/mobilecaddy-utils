/* mobilecaddy-utils - v2.0.0 - Bundle Time: 2018-06-07 16:10:32 */
/* git info: "2018-06-07 16:10:18 +0100": d15ade09940faa46c0f7e2cd96cdd4e5bc098409 (v2) */
/* Copyright 2018 MobileCaddy Ltd */

"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.maybeWriteTransformType=exports.maybeReadTransformType=exports.updateRecords=exports.updateRecord=exports.smartSql=exports.readRecords=exports.logout=exports.insertRecords=exports.insertRecord=exports.getRecordTypes=exports.getCachedAppSoupValue=exports.getUserLocale=exports.getCurrentUserName=exports.getCurrentUserId=exports.initialSync=exports.syncMobileTable=exports.dirtyTables=exports.deleteRecord=exports.analInc=exports.GET_REC_TYPES_UNKONWN_TABLE=exports.UPDATE_RECS_UNKNOWN_RECORD_TYPE=exports.UPDATE_RECS_UNKNOWN_ID=exports.UPDATE_RECS_DATATYPE_MISMATCH=exports.UPDATE_RECS_ACCESS_DENIED=exports.UPDATE_RECS_UNKONWN_FIELD=exports.UPDATE_RECS_UNKONWN_TABLE=exports.UPDATE_RECS_OK=exports.READ_RECS_ACCESS_DENIED=exports.READ_RECS_UNKONWN_TABLE=exports.READ_RECS_OK=exports.INSERT_RECS_UNKNOWN_RECORD_TYPE=exports.INSERT_RECS_PROTECTED_FIELD=exports.INSERT_RECS_DATATYPE_MISMATCH=exports.INSERT_RECS_MANDATORY_MISSING=exports.INSERT_RECS_ACCESS_DENIED=exports.INSERT_RECS_UNKONWN_FIELD=exports.INSERT_RECS_UNKONWN_TABLE=exports.INSERT_RECS_OK=exports.DELETE_RECS_MANDATORY_MISSING=exports.DELETE_RECS_ACCESS_DENIED=exports.DELETE_RECS_UNKONWN_FIELD=exports.DELETE_RECS_UNKONWN_TABLE=exports.DELETE_RECS_OK=exports.SYNC_MANDATORY_MISSING=exports.SYNC_UNKONWN_TABLE=exports.SYNC_ALREADY_IN_PROGRESS=exports.SYNC_NOK=exports.SYNC_OK=void 0;var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_smartStoreUtils=require("./smartStoreUtils"),smartStoreUtils=_interopRequireWildcard(_smartStoreUtils),_appDataUtils=require("./appDataUtils"),appDataUtils=_interopRequireWildcard(_appDataUtils),_syncRefresh=require("./syncRefresh"),syncRefresh=_interopRequireWildcard(_syncRefresh),_vsnUtils=require("./vsnUtils"),vsnUtils=_interopRequireWildcard(_vsnUtils),_logger=require("./logger"),logger=_interopRequireWildcard(_logger),_underscore=require("underscore"),_=_interopRequireWildcard(_underscore);function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}var smartstore=cordova.require("com.salesforce.plugin.smartstore"),USE_FORCETK=!!window.USE_FORCETK,UNKONWN_TABLE=1,UNKONWN_FIELD=2,ACCESS_DENIED=3,MANDATORY_MISSING=4,DATATYPE_MISMATCH=5,PROTECTED_FIELD=6,UNKNOWN_ID=7,UNKNOWN_RECORD_TYPE=8,SYNC_ALREADY_IN_PROGRESS_INC=98,UNKONWN_ERR=99,SYNC=100400,SYNC_NOK_STATUS=100402,INSERT_RECS=100700,READ_RECS=101e3,UPDATE_RECS=101100,DELETE_RECS=101200,GET_REC_TYPES=101300,SYSTEM_TABLES=["syncLib_system_data","appSoup","cacheSoup","recsToSync","SnapShot_Connection_Session__mc"],PROTECTED_FIELDS=["autonumber","CreatedById","CreatedDate","IsDeleted","IsClosed","IsWon","LastModifiedById","LastModifiedDate","LastReferencedDate","mobilecaddy1__MC_Proxy_ID","MC_Proxy_ID","OwnerId","SystemModstamp","Id","dirtyFlag"];function analInc(e){return new Promise(function(t,r){var n=new Date,o=new Date(n.getFullYear(),n.getMonth(),n.getDate(),0,0,0,0).valueOf();maybeCreateAnalyticTable().then(function(){return getCurAnalyticsAndHousekeep(o)}).then(function(r){var n={};if(0===r.length){n[e]=1;var s={Name:o,Data:JSON.stringify(n)};t(n[e]),smartstore.upsertSoupEntries("Analytics",[s],function(e){},function(e){logger.error("Unable to insert analytic recs",e)})}else{var a=r[0];(n=JSON.parse(a.Data))[e]=void 0===n[e]?1:n[e]+1,t(n[e]),a.Data=JSON.stringify(n),smartstore.upsertSoupEntriesWithExternalId("Analytics",[a],"Name",function(e){},function(e){logger.error(e)})}}).catch(function(e){logger.error("Error in analInc",e),r(e)})})}function maybeCreateAnalyticTable(){return new Promise(function(e,t){smartstore.soupExists("Analytics",function(r){if(r)e();else{smartstore.registerSoup("Analytics",[{path:"Name",type:"integer"},{path:"Data",type:"string"}],function(t){e()},function(e){t(e)})}},function(e){logger.error(e),t(e)})})}function getCurAnalyticsAndHousekeep(e){return new Promise(function(t,r){var n="";appDataUtils.getCurrentValueFromAppSoup("audId").then(function(e){return n=e,smartStoreUtils.querySoupRecsPromise("Analytics")}).then(function(o){var s=[],a=[],c=[];o.forEach(function(t){if(t.Name==e)s.push(t);else{var r={Name:t.Name.toString(),SystemModstamp:t.Name,mobilecaddy1__Error_Text__c:JSON.parse(t.Data),mobilecaddy1__Application_User_Device__c:n,mobilecaddy1__Log_Type__c:"analytic"};a.push(r),c.push(t._soupEntryId)}}),0!==a.length&&smartStoreUtils.insertRecords("Mobile_Log__mc",a,function(e){smartstore.removeFromSoup("Analytics",c,function(e){t(s)},function(e){logger.error("Unable to insert analytic recs",e),r(e)})},function(e){logger.error("Unable to insert analytic recs",e),r(e)}),t(s)}).catch(function(e){logger.error("Error housekeeping Analytics",e),r(e)})})}function checkTableAccess(e,t,r){return console.time("MC-TIMING checkTableAccess "+e),new Promise(function(n,o){var s=function(t,s){var a=0;switch(t){case INSERT_RECS:a=1;break;case READ_RECS:a=4;break;case UPDATE_RECS:a=7;break;case DELETE_RECS:a=10;break;default:a=0}if("Y"==s.charAt(a))console.timeEnd("MC-TIMING checkTableAccess "+e),n(r);else{var c={};c.status=t+ACCESS_DENIED,c.mc_add_status=e,console.timeEnd("MC-TIMING checkTableAccess "+e),o(c)}};-1==SYSTEM_TABLES.indexOf(e)?localStorage["meta-tableCRUD-"+e]?s(t,localStorage["meta-tableCRUD-"+e]):smartStoreUtils.getTableDefnColumnValue(e,"Application Record CRUD").then(function(r){localStorage["meta-tableCRUD-"+e]=r,s(t,r)}).catch(function(t){console.timeEnd("MC-TIMING checkTableAccess "+e),console.info("Opps -> "+e),o(t)}):(console.timeEnd("MC-TIMING checkTableAccess "+e),n(r))})}function getCurrentUserId(){return new Promise(function(e,t){if(!0===USE_FORCETK){var r=force.getUserId();e(r)}else getCachedAppSoupValue("userId").then(function(t){e(t)}).catch(function(e){logger.error("getCurrentUserId",e),t(e)})})}function getCurrentUserName(){var e="";return new Promise(function(t,r){getCachedAppSoupValue("userFirstName").then(function(t){return e=t,getCachedAppSoupValue("userLastName")}).then(function(r){t(e+" "+r)}).catch(function(e){logger.error("getCurrentUserName",e),r(e)})})}function getUserLocale(){return getCachedAppSoupValue("userLocale")}function getCachedAppSoupValue(e){return new Promise(function(t,r){appDataUtils.getCachedCurrentValueFromAppSoup(e).then(function(e){t(e)}).catch(function(e){logger.error("getCachedAppSoupValue",e),r(e)})})}function isValidEmail(e){if(0===e.length)return!0;var t=e.indexOf("@"),r=e.lastIndexOf(".");return!(t<1||r<t+2||r+2>=e.length)}var BYTES=0,CHARS=1;function isValidStrLength(e,t,r){if(void 0===e)return!0;switch(t){case BYTES:for(var n=e.length,o=e.length-1;o>=0;o--){var s=e.charCodeAt(o);s>127&&s<=2047?n++:s>2047&&s<=65535&&(n+=2),s>=56320&&s<=57343&&o--}return n<=r;default:return!0}}function isValidFieldAndTranslate(e,t,r,n){if("_soupLastModifiedDate"==e)return n;var o=_.findWhere(r,{path:e}),s={};if(void 0===o)return s.status=t+UNKONWN_FIELD,s.mc_add_status=e,s;var a=0;switch(t){case INSERT_RECS:a=1;break;case READ_RECS:a=4;break;case UPDATE_RECS:a=7;break;default:a=0}if("Y"!=o.crud.charAt(a))return s.status=t+ACCESS_DENIED,s;try{return s.value=maybeWriteTransformType(n,o.appColType,o.platColType),s}catch(r){return s.status=t+DATATYPE_MISMATCH,s.mc_add_status=r+"->"+e,s}}function listMobileTableColumns(e){return console.time("MC-TIMING listMobileTableColumns "+e),new Promise(function(t,r){localStorage["meta-tableDEF-"+e]?(console.timeEnd("MC-TIMING listMobileTableColumns "+e),t(JSON.parse(localStorage["meta-tableDEF-"+e]))):smartStoreUtils.listMobileTableColumns(e,smartStoreUtils.FULL,function(r){localStorage["meta-tableDEF-"+e]=JSON.stringify(r),console.timeEnd("MC-TIMING listMobileTableColumns "+e),t(r)},function(t){console.timeEnd("MC-TIMING listMobileTableColumns "+e),r(t)})})}function maybeReadTransformType(e,t,r){switch(r){case"checkbox":case"Deleted":return"true"===String(e);case"CreatedDate":case"date":case"datetime":case"LastActivtyDate":case"LastModifiedDate":case"LastReferencedDate":case"LastViewedDate":case"SystemModstamp":return null!==e?new Date(e):e;default:return e}}function maybeWriteTransformType(e,t,r){switch(r){case"autonumber":throw"invalid_autonumber";case"checkbox":case"Deleted":if("boolean"==typeof e||"true"===e||"false"===e)return String(e);throw"invalid_boolean";case"date":if(e instanceof Date)return e.setUTCHours(0),e.setUTCMinutes(0),e.setUTCSeconds(0),e.setUTCMilliseconds(0),e.valueOf();if(null===e)return null;throw"invalid_date";case"datetime":if(e instanceof Date)return e.valueOf();if(null===e)return null;throw"invalid_datetime";case"email":if(isValidEmail(e))return e;throw"invalid_email";default:switch(t){case"jsString":if("string"==typeof e)return e;if("number"==typeof e)return e.toString();throw"invalid_string";case"jsNumber":if("number"==typeof e||null===e)return e;throw"invalid_number";default:return e}}}function tableExists(e,t){return console.time("MC-TIMING tableExists "+e),new Promise(function(r,n){var o={};localStorage["meta-tableCRUD-"+e]?(console.timeEnd("MC-TIMING tableExists "+e),r()):smartStoreUtils.listMobileTables(smartStoreUtils.ALPHA,function(s){s.concat(SYSTEM_TABLES).indexOf(e)>=0?(console.timeEnd("MC-TIMING tableExists "+e),r()):(o.status=t+UNKONWN_TABLE,o.mc_add_status=e,console.timeEnd("MC-TIMING tableExists "+e),n(o))},function(r){o.status=t+UNKONWN_ERR,o.mc_add_status="Unkonwn error "+r,console.timeEnd("MC-TIMING tableExists "+e),n(o)})})}function validateRecords(e,t,r,n,o){return new Promise(function(s,a){var c={},i={};c.status=r,getRecordTypesMap().then(function(t){return t[e]&&(i=_.invert(t[e])),getCurrentUserId()}).then(function(e){n.forEach(function(n){if(delete n._soupEntryId,delete n.$$HashKey,n.RecordTypeName){if(n.RecordTypeId=i[n.RecordTypeName],_.isEmpty(i))return c.status=r+UNKONWN_FIELD,c.mc_add_status=n.RecordTypeName,s(c);if(!n.RecordTypeId)return c.status=r+UNKNOWN_RECORD_TYPE,c.mc_add_status=n.RecordTypeName,s(c);delete n.RecordTypeName}for(var a in n)if(n.hasOwnProperty(a)&&a!=t){var E=isValidFieldAndTranslate(a,r,o,n[a]);if(E.status==r+UNKONWN_FIELD){c.status=E.status,c.mc_add_status=a;break}if(E.status==r+DATATYPE_MISMATCH){c.status=E.status,c.mc_add_status=a;break}if(E.status==r+ACCESS_DENIED){c.status=E.status,c.mc_add_status=a;break}if(r==INSERT_RECS&&PROTECTED_FIELDS.indexOf(a)>=0){c.status=r+PROTECTED_FIELD,c.mc_add_status=a;break}n[a]=E.value}if(c.status!=r+UNKONWN_FIELD&&c.status!=r+DATATYPE_MISMATCH&&c.status!=r+PROTECTED_FIELD){var u=(new Date).getTime();r==INSERT_RECS&&(n.CreatedById=e,n.CreatedDate=u),n.SystemModstamp=u,n.LastModifiedDate=u,n.LastModifiedById=e,n.IsDeleted="false",o.forEach(function(e){if(r==INSERT_RECS){var t=e.crud.charAt(1);PROTECTED_FIELDS.indexOf(e.path)<0&&"false"==e.nillable&&"Y"==t?_.has(n,e.path)||(c.status=r+MANDATORY_MISSING,c.mc_add_status=e.path):("IsClosed"==e.path&&(n.IsClosed="false"),"IsWon"==e.path&&(n.IsWon="false"))}""!==e.proxyRefField&&void 0!==n[e.path]&&n[e.path].length>18&&(n[e.proxyRefField]=n[e.path])})}}),c.records=n,s(c)},function(e){logger.error("validateRecords",e)})})}function getRecordTypes(e){return new Promise(function(t,r){tableExists(e,GET_REC_TYPES).then(function(){return getRecordTypesMap()}).then(function(r){t(r[e])}).catch(function(e){r(e)})})}function getRecordTypesMap(){return new Promise(function(e,t){localStorage.getItem("lsDotsRecordTypes")?e(JSON.parse(localStorage.getItem("lsDotsRecordTypes"))):smartStoreUtils.querySoupRecords("dotsRecordTypes",function(t){console.log("querySoupRecords dotsRecordTypes",t);var r={};t.forEach(function(e){var t={};JSON.parse(e.Data).forEach(function(e){t[e.recTypeId]=e.recTypeName}),r[e.Table]=t}),localStorage.setItem("lsDotsRecordTypes",JSON.stringify(r)),e(r)},function(e){logger.error("Error returned from upsert, message =  "+e),t(e)})})}function deleteRecord(e,t,r){return new Promise(function(n,o){return deleteRecords(e,[t],r)})}function deleteRecords(e,t,r){var n,o={};return new Promise(function(s,a){t.length>0?tableExists(e,DELETE_RECS).then(function(){return listMobileTableColumns(e)}).then(function(t){return checkTableAccess(e,DELETE_RECS,t)}).then(function(n){return new Promise(function(o,s){var a=isValidFieldAndTranslate(r,DELETE_RECS,n);a.status!=DELETE_RECS+UNKONWN_FIELD?validateRecords(e,r,DELETE_RECS,t,n).then(function(e){e.status==DELETE_RECS?o(e.records):(s(e),logger.error(e))}):(s(a),logger.error(a))})}).then(function(n){return smartStoreUtils.queryMobileTable(e,r,t[0][r])}).then(function(t){if(0===t.length)o.status=DELETE_RECS+MANDATORY_MISSING,logger.warn("deleteRecord no record found",e),o.mc_add_status="no record found",a(o);else{if(!(t[0].Id.length<19))return n=t,smartStoreUtils.querySoupRecsPromise("recsToSync");o.status=DELETE_RECS+ACCESS_DENIED,logger.warn("deleteRecord Cannot delete synced records"),o.mc_add_status="Cannot delete synced records",a(o)}}).then(function(t){console.debug("tableName",e),console.debug("recsToDelete",n),console.debug("rts recs",t);var r=t.reduce(function(t,r){return r.Mobile_Table_Name==e&&_.findWhere(n,{_soupEntryId:r.SOUP_Record_Id})&&t.push({_soupEntryId:r._soupEntryId}),t},[]);console.debug("rtsRecSoupIds",r),smartStoreUtils.deleteRecordsFromSoup(n,e,function(){smartStoreUtils.deleteRecordsFromSoup(r,"recsToSync",function(){o.status=DELETE_RECS,o.records=n,s(o)},function(e){a(e)})},function(e){a(e)})}).catch(function(e){a(e)}):(o.status=DELETE_RECS,logger.warn("deleteRecord No records supplied"),o.mc_add_status="No records supplied",o.records=[],s(o))})}function dirtyTables(){return new Promise(function(e,t){readRecords("recsToSync").then(function(t){var r=[],n=[];t.records.forEach(function(e){"Connection_Session__mc"!=e.Mobile_Table_Name&&void 0===r[e.Mobile_Table_Name]&&(r[e.Mobile_Table_Name]=!0,n.push(e.Mobile_Table_Name))}),e(n)}).catch(function(e){logger.error(e),t(e)})})}function enrichWithRecordTypeNames(e,t){return new Promise(function(r,n){e.length>0&&-1==SYSTEM_TABLES.indexOf(t)?getRecordTypesMap().then(function(n){if(n[t]){var o=n[t],s=e.map(function(e){return e.RecordTypeName=o[e.RecordTypeId],e.RecordTypeName||logger.warn("enrichWithRecordTypeNames",e.RecordTypeId),e});r(s)}else r(e)}).catch(function(e){n(e)}):r(e)})}function insertRecord(e,t){return insertRecords(e,[t])}function insertRecords(e,t){var r={};return new Promise(function(n,o){tableExists(e,INSERT_RECS).then(function(){return listMobileTableColumns(e)}).then(function(t){return checkTableAccess(e,INSERT_RECS,t)}).then(function(r){return new Promise(function(n,o){validateRecords(e,null,INSERT_RECS,t,r).then(function(e){e.status==INSERT_RECS?n(e.records):o(e)})})}).then(function(t){smartStoreUtils.insertRecords(e,t,function(e){r.status=INSERT_RECS,r.records=e,vsnUtils.upgradeAvailable().then(function(e){r.upgradeAvailable=e,n(r)}).catch(function(e){n(r),logger.error(e)})},function(e){o(e),logger.error(e)})}).catch(function(e){o(e),logger.error(e)})})}function logout(){console.log("Logout requested"),localStorage.clear(),navigator.appVersion.includes("Electron")?ipcRenderer.sendSync("logout",""):cordova.require("com.salesforce.plugin.sfaccountmanager").logout()}function readRecords(e,t){var r={},n="MC-TIMING readRecords "+e;return console.time(n),new Promise(function(t,o){tableExists(e,READ_RECS).then(function(){return checkTableAccess(e,READ_RECS)}).then(function(){return listMobileTableColumns(e)}).then(function(s){smartStoreUtils.querySoupRecords(e,function(a){r.status=READ_RECS,a.length>0?-1==SYSTEM_TABLES.indexOf(e)?smartStoreUtils.getTableDefnColumnValue(e,"Last Refresh Date/Time").then(function(t){return readProcessRecs(e,a,s,t,r)}).then(function(e){console.timeEnd(n),t(e)}).catch(function(e){o(e),logger.error(e)}):readProcessRecs(e,a,s,null,r).then(function(e){console.timeEnd(n),t(e)}):(r.records=[],vsnUtils.upgradeAvailable().then(function(e){r.upgradeAvailable=e,console.timeEnd(n),t(r)}).catch(function(e){console.timeEnd(n),t(r),logger.error(e)}))},function(e){console.timeEnd(n),o(e),logger.error(e)})},function(e){console.timeEnd(n),o(e),logger.error(e)})})}function readProcessRecs(e,t,r,n,o){return new Promise(function(s,a){t.forEach(function(e){for(var t in e){var o=_.findWhere(r,{path:t});void 0!==o&&(e[t]=maybeReadTransformType(e[t],o.appColType,o.platColType),"LastModifiedDate"==t&&(e.dirtyFlag=calcDirtyFlag(e[t],n)))}}),o.records=t.filter(function(e){return"object"==(void 0===e?"undefined":_typeof(e))}),enrichWithRecordTypeNames(o.records,e).then(function(e){return o.records=e,vsnUtils.upgradeAvailable()}).then(function(e){o.upgradeAvailable=e,s(o)}).catch(function(e){s(o),logger.error(e)})})}function smartSql(e,t){return smartRead(e,t)}function smartRead(e,t){return new Promise(function(r,n){var o,s,a,c={},i=/FROM\s+\{(\S*)\}/gi.exec(e),E=t||1e3,u=i[1];parseSmartSql(u,e).then(function(e){var t=e[0];return a=e[1],console.debug("smartSql2",t,a),o=smartstore.buildSmartQuerySpec(t,E),console.debug("querySpec",o),s="MC-TIMING smartRead "+u,console.time(s),tableExists(u,READ_RECS)}).then(function(){return checkTableAccess(u,READ_RECS)}).then(function(){return listMobileTableColumns(u)}).then(function(e){smartStoreUtils.smartQuerySoupRecordsWithQuerySpec(o,function(t){c.status=READ_RECS,t.length>0?-1==SYSTEM_TABLES.indexOf(u)&&a?smartStoreUtils.getTableDefnColumnValue(u,"Last Refresh Date/Time").then(function(r){return smartReadProcessRecs(u,t,e,r,c)}).then(function(e){console.timeEnd(s),r(e)}):smartReadProcessRecs(u,t,e,null,c).then(function(e){console.timeEnd(s),r(e)}):(c.records=[],vsnUtils.upgradeAvailable().then(function(e){c.upgradeAvailable=e,console.timeEnd(s),r(c)}).catch(function(e){console.timeEnd(s),r(c),logger.error(e)}))},function(){n()})},function(e){console.timeEnd(s),n(e),logger.error(e)})})}function smartReadProcessRecs(e,t,r,n,o){return new Promise(function(s,a){var c=[],i=!0;t.forEach(function(e){var t;if("object"==_typeof(e[1]))for(var o in t=e[1]){var s=_.findWhere(r,{path:o});void 0!==s&&(t[o]=maybeReadTransformType(t[o],s.appColType,s.platColType),"LastModifiedDate"==o&&(e[1].dirtyFlag=calcDirtyFlag(e[1][o],n)))}else t=e,i=!1;c.push(t)}),o.records=c.filter(function(e){return"object"==(void 0===e?"undefined":_typeof(e))}),i?enrichWithRecordTypeNames(o.records,e).then(function(e){return o.records=e,vsnUtils.upgradeAvailable()}).then(function(e){o.upgradeAvailable=e,s(o)}).catch(function(e){s(o),logger.error(e)}):vsnUtils.upgradeAvailable().then(function(e){o.upgradeAvailable=e,s(o)}).catch(function(e){s(o),logger.error(e)})})}function parseSmartSql(e,t){return new Promise(function(r,n){var o=!0;"*"!==t.match(/SELECT\s+(.*)\s+FROM/i)[1]&&(o=!1);var s=t.match(/\s+FROM\s+{(.*)}\s+WHERE (.* = .*)/i);if(console.debug("m",s),null!==s&&null!==s[1]){var a=t,c={},i="";s[2].split("AND").forEach(function(e){var t=e.match(/{(.*):(.*)}\s+=\s+(.*)/i),r=t[2];i=t[3].split("'")[1],c[r]=i}),void 0!==c.Id&&c.Id.length>18?smartStoreUtils.getProxyFieldName(e).then(function(e){console.log("proxyFieldName",e),a=a.replace("Id} =",e+"} ="),r([a,o])}):r([a,o])}else r([t,o])})}function calcDirtyFlag(e,t){return t&&"null"!=t||(t=0),e.valueOf()>t}function innerProcessRefreshTablePromise(e){return new Promise(function(t,r){var n=function(e){console.debug("innerProcessRefreshTablePromise res",e),t(e)},o={table:e};syncRefresh.p2mRefreshTable(e,0,!1,1,1,null,function(e){console.debug("refreshStatusObject",e),e.status==syncRefresh.P2M_REFRESH_OK?(o.status=SYNC,n(o)):(o.status=e.status,o.mc_add_status=e.mc_add_status,n(o))},function(e){logger.error("innerProcessRefreshTablePromise error",e),r(e)})})}function initialSync(e){return console.time("initialSync"),new Promise(function(t,r){if(0===e.length)t({status:SYNC+MANDATORY_MISSING});else{var n={};syncRefresh.heartBeat(function(o){if(console.log("heartbeat call gave "+o.status),o.status==syncRefresh.HEARTBEAT_OK||o.status==syncRefresh.HEARTBEAT_NOT_DEVICE||o.status==syncRefresh.HEARTBEAT_REFRESHED_OK){var s=[];console.debug("tableNames",JSON.stringify(e)),dirtyTables().then(function(t){return console.debug("dirtyTableNames",t),t.forEach(function(t){var r=e.indexOf(t);r>-1&&(s.push({table:t,status:SYNC_NOK_STATUS,mc_add_status:"Dirty records"}),e.splice(r,1))}),console.debug("tableNames",e),console.debug("resArr",s),doInitialSync(e)}).then(function(e){console.debug("doInitialSync res",e);var n=s.concat(e);console.debug("Promise.all resArrFinal",n),console.timeEnd("initialSync"),t(n);syncRefresh.maybeSyncConnSess({mobilecaddy1__Mobile_Process_Status__c:""},function(){console.log("success return from maybeSyncConnSess")},function(e){r(e),logger.error(e)})}).catch(function(e){r(e),logger.error(e)})}else n.status=SYNC_NOK_STATUS,n.mc_add_status=o.status,t(n),100101==n.mc_add_status||100102==n.mc_add_status?logger.error(n):logger.log(n)},function(e){logger.error(e),n.status=SYNC_NOK_STATUS,t(n)})}})}function doInitialSync(e){Promise.resolve();var t=[];return e.reduce(function(e,r){return e.then(function(e){return innerProcessRefreshTablePromise(r)}).then(function(e){return t.push(e),t}).catch(function(e){logger.errorAndDispatch(e),reject(e)})},Promise.resolve())}function syncMobileTable(e,t,r,n,o){return new Promise(function(s,a){console.time("devUtils.syncMobileTable"),tableExists(e,SYNC).then(function(){return syncRefresh.syncMobileTable(e,t,r,n,o)}).then(function(e){console.timeEnd("devUtils.syncMobileTable"),s(e)}).catch(function(e){console.timeEnd("devUtils.syncMobileTable"),a(e)})})}function updateRecord(e,t,r){return updateRecords(e,[t],r)}function updateRecords(e,t,r){var n={};return new Promise(function(o,s){t.length>0?tableExists(e,UPDATE_RECS).then(function(){return listMobileTableColumns(e)}).then(function(t){return checkTableAccess(e,UPDATE_RECS,t)}).then(function(n){return new Promise(function(o,s){var a=isValidFieldAndTranslate(r,UPDATE_RECS,n);a.status!=UPDATE_RECS+UNKONWN_FIELD?validateRecords(e,r,UPDATE_RECS,t,n).then(function(e){e.status==UPDATE_RECS?o(e.records):s(e)}):s(a)})}).then(function(t){smartStoreUtils.updateRecordsWithExternalId(e,t,r,function(e){n.status=UPDATE_RECS,n.records=e,vsnUtils.upgradeAvailable().then(function(e){n.upgradeAvailable=e,o(n)}).catch(function(e){o(n)})},function(e){s(e),logger.error(e)})},function(e){s(e),logger.error(e)}):(n.status=UPDATE_RECS,n.mc_add_status="No records supplied",n.records=[],o(n),logger.warn(n))})}var SYNC_OK=exports.SYNC_OK=syncRefresh.SYNC,SYNC_NOK=exports.SYNC_NOK=syncRefresh.SYNC_NOK_STATUS,SYNC_ALREADY_IN_PROGRESS=exports.SYNC_ALREADY_IN_PROGRESS=syncRefresh.SYNC+syncRefresh.SYNC_ALREADY_IN_PROGRESS_INC,SYNC_UNKONWN_TABLE=exports.SYNC_UNKONWN_TABLE=syncRefresh.SYNC+UNKONWN_TABLE,SYNC_MANDATORY_MISSING=exports.SYNC_MANDATORY_MISSING=syncRefresh.SYNC+MANDATORY_MISSING,DELETE_RECS_OK=exports.DELETE_RECS_OK=DELETE_RECS,DELETE_RECS_UNKONWN_TABLE=exports.DELETE_RECS_UNKONWN_TABLE=DELETE_RECS+UNKONWN_TABLE,DELETE_RECS_UNKONWN_FIELD=exports.DELETE_RECS_UNKONWN_FIELD=DELETE_RECS+UNKONWN_FIELD,DELETE_RECS_ACCESS_DENIED=exports.DELETE_RECS_ACCESS_DENIED=DELETE_RECS+ACCESS_DENIED,DELETE_RECS_MANDATORY_MISSING=exports.DELETE_RECS_MANDATORY_MISSING=DELETE_RECS+MANDATORY_MISSING,INSERT_RECS_OK=exports.INSERT_RECS_OK=INSERT_RECS,INSERT_RECS_UNKONWN_TABLE=exports.INSERT_RECS_UNKONWN_TABLE=INSERT_RECS+UNKONWN_TABLE,INSERT_RECS_UNKONWN_FIELD=exports.INSERT_RECS_UNKONWN_FIELD=INSERT_RECS+UNKONWN_FIELD,INSERT_RECS_ACCESS_DENIED=exports.INSERT_RECS_ACCESS_DENIED=INSERT_RECS+ACCESS_DENIED,INSERT_RECS_MANDATORY_MISSING=exports.INSERT_RECS_MANDATORY_MISSING=INSERT_RECS+MANDATORY_MISSING,INSERT_RECS_DATATYPE_MISMATCH=exports.INSERT_RECS_DATATYPE_MISMATCH=INSERT_RECS+DATATYPE_MISMATCH,INSERT_RECS_PROTECTED_FIELD=exports.INSERT_RECS_PROTECTED_FIELD=INSERT_RECS+PROTECTED_FIELD,INSERT_RECS_UNKNOWN_RECORD_TYPE=exports.INSERT_RECS_UNKNOWN_RECORD_TYPE=INSERT_RECS+UNKNOWN_RECORD_TYPE,READ_RECS_OK=exports.READ_RECS_OK=READ_RECS,READ_RECS_UNKONWN_TABLE=exports.READ_RECS_UNKONWN_TABLE=READ_RECS+UNKONWN_TABLE,READ_RECS_ACCESS_DENIED=exports.READ_RECS_ACCESS_DENIED=READ_RECS+ACCESS_DENIED,UPDATE_RECS_OK=exports.UPDATE_RECS_OK=UPDATE_RECS,UPDATE_RECS_UNKONWN_TABLE=exports.UPDATE_RECS_UNKONWN_TABLE=UPDATE_RECS+UNKONWN_TABLE,UPDATE_RECS_UNKONWN_FIELD=exports.UPDATE_RECS_UNKONWN_FIELD=UPDATE_RECS+UNKONWN_FIELD,UPDATE_RECS_ACCESS_DENIED=exports.UPDATE_RECS_ACCESS_DENIED=UPDATE_RECS+ACCESS_DENIED,UPDATE_RECS_DATATYPE_MISMATCH=exports.UPDATE_RECS_DATATYPE_MISMATCH=UPDATE_RECS+DATATYPE_MISMATCH,UPDATE_RECS_UNKNOWN_ID=exports.UPDATE_RECS_UNKNOWN_ID=UPDATE_RECS+UNKNOWN_ID,UPDATE_RECS_UNKNOWN_RECORD_TYPE=exports.UPDATE_RECS_UNKNOWN_RECORD_TYPE=UPDATE_RECS+UNKNOWN_RECORD_TYPE,GET_REC_TYPES_UNKONWN_TABLE=exports.GET_REC_TYPES_UNKONWN_TABLE=GET_REC_TYPES+UNKONWN_TABLE;exports.analInc=analInc,exports.deleteRecord=deleteRecord,exports.dirtyTables=dirtyTables,exports.syncMobileTable=syncMobileTable,exports.initialSync=initialSync,exports.getCurrentUserId=getCurrentUserId,exports.getCurrentUserName=getCurrentUserName,exports.getUserLocale=getUserLocale,exports.getCachedAppSoupValue=getCachedAppSoupValue,exports.getRecordTypes=getRecordTypes,exports.insertRecord=insertRecord,exports.insertRecords=insertRecords,exports.logout=logout,exports.readRecords=readRecords,exports.smartSql=smartSql,exports.updateRecord=updateRecord,exports.updateRecords=updateRecords,exports.maybeReadTransformType=maybeReadTransformType,exports.maybeWriteTransformType=maybeWriteTransformType;