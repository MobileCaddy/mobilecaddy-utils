/* mobilecaddy-utils - v2.0.1 - Bundle Time: 2019-04-29 13:24:12 */
/* git info: "2019-04-29 13:24:02 +0100": b1f59c7a23c5fc1bd753e154fd2b9713b9128ae8 (v2) */
/* Copyright 2019 MobileCaddy Ltd */

"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getCurrentValueFromAppSoup=getCurrentValueFromAppSoup,exports.getCachedCurrentValueFromAppSoup=getCachedCurrentValueFromAppSoup,exports.getPlatformAppConfig=getPlatformAppConfig,exports.updateNewValueInAppSoup=updateNewValueInAppSoup,exports.upsertNewValueInAppSoup=upsertNewValueInAppSoup,exports.updateCurrentValueInAppSoup=updateCurrentValueInAppSoup,exports.upsertCurrentValueInAppSoup=upsertCurrentValueInAppSoup;var smartStoreUtils=_interopRequireWildcard(require("./smartStoreUtils")),mobileCaddy=_interopRequireWildcard(require("./constants")),_devUtils=require("./devUtils");function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)if(Object.prototype.hasOwnProperty.call(e,t)){var o=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,t):{};o.get||o.set?Object.defineProperty(r,t,o):r[t]=e[t]}return r.default=e,r}var smartstore=cordova.require("com.salesforce.plugin.smartstore"),LOCAL_DEV=!!window.LOCAL_DEV,USE_FORCETK=!!window.USE_FORCETK;function getCachedCurrentValueFromAppSoup(e){var r=localStorage.getItem("appSoup-"+e);return new Promise(function(t,o){r?t(r):getCurrentValueFromAppSoup(e).then(function(r){localStorage.setItem("appSoup-"+e,r),t(r)})})}function getCurrentValueFromAppSoup(e){return new Promise(function(r,t){var o=smartstore.buildExactQuerySpec("Name",e,mobileCaddy.QUERY_BUFFER_SIZE);smartStoreUtils.querySoupRecordsWithQuerySpec("appSoup",o,function(e){e[0]?r(e[0].CurrentValue):r(e[0])},function(e){t(e)})})}function updateValueInAppSoup(e,r,t,o){return new Promise(function(u,n){var p=smartstore.buildExactQuerySpec("Name",e,mobileCaddy.QUERY_BUFFER_SIZE);smartStoreUtils.querySoupRecordsWithQuerySpec("appSoup",p,function(p){if(p.length>0)p[0][t]=r,smartstore.upsertSoupEntries("appSoup",p,function(e){u(e)},function(e){n(e)});else if(o){var a={Name:e};a[t]=r,smartstore.upsertSoupEntries("appSoup",[a],function(e){u(e)},function(e){n(e)})}else u()},function(e){n(e)})})}function updateNewValueInAppSoup(e,r){return updateValueInAppSoup(e,r,"NewValue",!1)}function upsertNewValueInAppSoup(e,r){return updateValueInAppSoup(e,r,"NewValue",!0)}function updateCurrentValueInAppSoup(e,r){return updateValueInAppSoup(e,r,"CurrentValue",!1)}function upsertCurrentValueInAppSoup(e,r){return console.log("upsertCurrentValueInAppSoup",e,r),updateValueInAppSoup(e,r,"CurrentValue",!0)}function getPlatformAppConfig(e){return new Promise(function(r,t){getAppSoup(e).then(function(e){console.log("getPlatformAppConfig",e);var t=function(e,t){if(console.log("getAppConfigSuccCB",e,t),t.status){var o=[],u="string"==typeof e?JSON.parse(e):e;for(var n in console.log("resOb",u),u)if(console.log("resObj[prop]",u[n]),null!==u[n])if("translations"==n){var p=JSON.parse(u[n].replace(/(\r\n|\n|\r|\t)/gm,""));for(var a in p)null!==p[a]&&o.push({Name:"translations-"+a,CurrentValue:p[a]})}else o.push({Name:n,CurrentValue:u[n].replace(/(\r\n|\n|\r|\t)/gm,"")});o.reduce(function(e,r){return console.log(),e.then(function(e){return upsertCurrentValueInAppSoup(r.Name,r.CurrentValue)})},Promise.resolve()).then(function(e){console.log("getPlatformAppConfig promise chain result",e),r()}).catch(function(e){console.error("getPlatformAppConfig error",e)})}else"exception"===t.type&&(console.error("getAppConfigSuccCB",t.message),r())};!0===USE_FORCETK?force.request({method:"POST",path:"/services/apexrest/getAppConfig001",contentType:"application/json",data:{buildVersion:e.buildVersion.CurrentValue,buildName:e.buildName.CurrentValue,dynamicVersion:e.dynVersionNumber.CurrentValue}},function(e){console.info("response -> "+JSON.stringify(e));var r={status:"200"};t(e,r)},function(e){console.error("forcejs getAppConfig001",e),r()}):Visualforce.remoting.Manager.invokeAction("GetAppConfiguration001.getAppConfig",e.buildVersion.CurrentValue,e.buildName.CurrentValue,e.dynVersionNumber.CurrentValue,t,{escape:!1,timeout:3e4})})})}function getAppSoup(e){return new Promise(function(r,t){if(e)r(e);else{var o={};smartStoreUtils.querySoupRecsPromise("appSoup").then(function(e){e.forEach(function(e){void 0===o[e.Name]&&(o[e.Name]=e)}),r(o)})}})}